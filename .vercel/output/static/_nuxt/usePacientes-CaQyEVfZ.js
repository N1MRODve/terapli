import{r as d,I as L,z as g}from"#entry";class S{enabled=!0;minLevel="debug";sessionId;buffer=[];maxBufferSize=100;constructor(){this.sessionId=this.generateSessionId(),this.minLevel="warn"}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}shouldLog(e){if(!this.enabled)return!1;const a=["debug","info","warn","error"],t=a.indexOf(this.minLevel);return a.indexOf(e)>=t}formatMessage(e){const a=new Date(e.timestamp).toLocaleTimeString("es-ES"),t=`[AGENDA ${e.event.toUpperCase()}]`;return`${a} ${t} ${e.message}`}log(e,a,t,r){if(!this.shouldLog(e))return;const o={timestamp:new Date().toISOString(),level:e,event:a,message:t,data:r,sessionId:this.sessionId};this.buffer.push(o),this.buffer.length>this.maxBufferSize&&this.buffer.shift();const u=this.formatMessage(o);switch(e){case"debug":console.log(`üîç ${u}`,r||"");break;case"info":console.info(`‚ÑπÔ∏è ${u}`,r||"");break;case"warn":console.warn(`‚ö†Ô∏è ${u}`,r||"");break;case"error":console.error(`‚ùå ${u}`,r||""),o.stack&&console.error("Stack trace:",o.stack);break}}debug(e,a,t){this.log("debug",e,a,t)}info(e,a,t){this.log("info",e,a,t)}warn(e,a,t){this.log("warn",e,a,t)}error(e,a,t){const r=t instanceof Error?{name:t.name,message:t.message,stack:t.stack}:t,o={timestamp:new Date().toISOString(),level:"error",event:e,message:a,data:r,sessionId:this.sessionId,stack:t instanceof Error?t.stack:void 0};this.buffer.push(o),this.buffer.length>this.maxBufferSize&&this.buffer.shift(),console.error(`‚ùå ${this.formatMessage(o)}`,r||""),o.stack&&console.error("Stack trace:",o.stack)}loadRange(e,a,t){this.info("load_range",`Cargadas ${t} citas`,{from:e,to:a,count:t})}create(e,a,t){this.info("create",`Cita creada: ${e}`,{appointmentId:e,date:a,time:t})}update(e,a){this.info("update",`Cita actualizada: ${e}`,{appointmentId:e,changes:a})}move(e,a,t){this.info("move",`Cita movida: ${e}`,{appointmentId:e,from:a,to:t})}statusChange(e,a,t){this.info("status_change",`Estado cambiado: ${a} ‚Üí ${t}`,{appointmentId:e,from:a,to:t})}conflict(e,a,t,r){this.warn("conflict","Conflicto de horario detectado",{appointmentId:e,conflictWith:a,date:t,time:r})}apiError(e,a){this.error("api_error",`Error en API: ${e}`,a instanceof Error?a:{message:a})}realtimeEvent(e,a){this.debug("realtime_event",`Evento en tiempo real: ${e}`,a)}optimisticUpdate(e,a){this.debug("optimistic_update",`Actualizaci√≥n optimista: ${a}`,{appointmentId:e,action:a})}rollback(e,a){this.warn("rollback",`Rollback de cambio: ${a}`,{appointmentId:e,reason:a})}dragStart(e,a){this.debug("drag_start",`Inicio de drag: ${e}`,{appointmentId:e,from:a})}dragEnd(e,a,t){t?this.debug("drag_end","Drag completado exitosamente",{appointmentId:e,to:a}):this.warn("drag_end","Drag cancelado o fallido",{appointmentId:e,to:a})}clickCreate(e,a){this.debug("click_create","Click para crear cita",{date:e,time:a})}filterChange(e){this.debug("filter_change","Filtros actualizados",{filters:e})}getBuffer(){return[...this.buffer]}clearBuffer(){this.buffer=[]}downloadLogs(){const e=this.buffer.map(o=>JSON.stringify(o)).join(`
`),a=new Blob([e],{type:"application/json"}),t=URL.createObjectURL(a),r=document.createElement("a");r.href=t,r.download=`agenda-logs-${this.sessionId}.json`,r.click(),URL.revokeObjectURL(t)}setEnabled(e){this.enabled=e}setMinLevel(e){this.minLevel=e}getSessionId(){return this.sessionId}}const l=new S;function C(){const c=d([]),e=d(!1),a=d(null),t=d(""),r=d(null),o=d(new Map),u=300*1e3;async function f(n){try{e.value=!0,a.value=null;const s=n.trim().toLowerCase(),i=o.value.get(s);if(i){c.value=i,l.debug("search",`Resultados desde cache: ${i.length}`),e.value=!1;return}l.debug("search",`Buscando pacientes via API: "${s}"`);const b=await $fetch("/api/patients/search",{method:"GET",query:{q:s}});if(!b.success)throw new Error("Error al buscar pacientes");const h=b.data;c.value=h,o.value.set(s,h),setTimeout(()=>{o.value.delete(s)},u),l.info("search",`Pacientes encontrados: ${h.length}`)}catch(s){const i=s.data?.message||s.message||"Error al buscar pacientes";a.value=i,l.error("api_error",i,s),c.value=[]}finally{e.value=!1}}function m(n,s=300){if(r.value&&clearTimeout(r.value),n.trim().length===0){f(n);return}r.value=setTimeout(()=>{f(n)},s)}async function v(n){try{if(e.value=!0,a.value=null,l.debug("create","Creando paciente r√°pido via API",n),!n.nombre_completo||n.nombre_completo.trim().length<2)return{success:!1,error:"El nombre debe tener al menos 2 caracteres"};if(!n.email||!n.email.includes("@"))return{success:!1,error:"Email inv√°lido"};const s=await $fetch("/api/patients/create",{method:"POST",body:{nombre_completo:n.nombre_completo.trim(),email:n.email.trim().toLowerCase(),telefono:n.telefono?.trim()||null,fecha_nacimiento:n.fecha_nacimiento||null,observaciones:n.observaciones?.trim()||null}});if(!s.success)throw new Error(s.message||"Error al crear paciente");const i={id:s.data.id,nombre_completo:s.data.nombre_completo,email:s.data.email,telefono:s.data.telefono,fecha_nacimiento:s.data.fecha_nacimiento,bonos_activos:0,sesiones_restantes_total:0,proximo_vencimiento:null,bono_activo:null,bonos:[]};return c.value.unshift(i),o.value.clear(),l.info("create",`Paciente creado: ${i.id}`),{success:!0,data:i}}catch(s){const i=s.data?.message||s.message||"Error al crear paciente";return a.value=i,l.error("api_error",i,s),{success:!1,error:i}}finally{e.value=!1}}async function p(){await f("")}function w(){t.value="",c.value=[],a.value=null}function _(){o.value.clear(),l.debug("cache","Cache invalidado")}L(t,n=>{m(n)});const $=g(()=>c.value.length>0),E=g(()=>e.value),k=g(()=>a.value!==null);return{pacientes:c,loading:E,error:k,searchQuery:t,hasPacientes:$,searchPacientes:f,debouncedSearch:m,createPaciente:v,loadAllPacientes:p,clearSearch:w,invalidateCache:_,clearError:()=>{a.value=null}}}export{l as a,C as u};
