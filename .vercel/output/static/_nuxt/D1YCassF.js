import{_ as Y}from"./C1ViKm1R.js";import{M as Z}from"./CQLvYprV.js";import{u as ee}from"./BbZO5sJf.js";import{e as te,J as ae,K as oe,r as d,f as se,B as ne,c as r,a as t,b as x,t as m,k as s,w,F as q,s as M,g as re,o as i,d as $,x as ie}from"#entry";import{_ as ce}from"./DlAUqK2U.js";import"./mZ3toP8Y.js";import"./DWNj0d99.js";import"./G1mM6o1b.js";import"./CQZt9cKZ.js";import"./DRclOuRO.js";import"./BaRJRhc1.js";import"./Bi0YyG7H.js";import"./Dyh9f5zH.js";const le={class:"p-6 space-y-8"},de={class:"flex items-center justify-between"},me={class:"text-cafe/70 mt-1"},ue={class:"grid grid-cols-1 lg:grid-cols-3 gap-6"},pe={class:"card lg:col-span-2"},fe={class:"flex justify-between items-center mb-4"},_e={key:0,class:"text-cafe/60 text-sm py-8 text-center"},ge={key:1,class:"text-cafe/50 text-center py-10"},xe={key:2,class:"space-y-4"},he={class:"text-lg font-semibold text-cafe"},be={class:"text-sm text-cafe/70"},ve=["onClick"],ye={class:"card"},we={class:"flex justify-between items-center mb-4"},De={key:0,class:"text-cafe/60 text-sm py-8 text-center"},Se={key:1,class:"text-cafe/50 text-center py-10"},ke={key:2,class:"space-y-3"},Ce={class:"flex-1"},Ee={class:"font-semibold text-cafe"},Pe={class:"text-sm text-cafe/60"},qe={class:"w-full bg-base-bg h-1 mt-2 rounded-full"},Me={class:"grid grid-cols-1 lg:grid-cols-3 gap-6"},$e={class:"card lg:col-span-2"},Ne={class:"grid grid-cols-2 md:grid-cols-4 gap-4 text-center"},Ae={class:"p-4 bg-terracota/5 rounded-xl"},Te={class:"text-2xl font-bold text-cafe"},je={class:"p-4 bg-terracota/5 rounded-xl"},Ie={class:"text-2xl font-bold text-cafe"},Ve={class:"p-4 bg-terracota/5 rounded-xl"},Le={class:"text-2xl font-bold text-cafe"},Be={class:"flex items-center justify-center gap-2 mb-1"},Oe={class:"text-2xl font-bold text-green-700"},ze={class:"text-xs text-green-700 font-medium mt-1"},Re={class:"card"},Ke={class:"flex justify-between items-center mb-4"},Fe={key:0,class:"text-cafe/60 text-sm py-8 text-center"},He={key:1,class:"space-y-3 text-sm text-cafe/80"},Ue={class:"flex-1"},Je={key:2,class:"text-cafe/60 text-sm py-8 text-center"},Ge=te({__name:"dashboard",setup(Qe){const c=ee(),N=ae(),A=oe(),D=d(null),S=d(!0),k=d(!0),h=d([]),b=d([]),T=d(0),j=d(0),I=d(0),C=d(!1),E=d(null),g=d(0),f=d(0),v=d([]),y=d(!0),z=()=>{N.push("/agenda")},R=()=>{N.push("/terapeuta/pacientes")},K=a=>{E.value=a,C.value=!0},F=()=>{C.value=!1,E.value=null};async function H(){try{const{data:a}=await c.auth.getUser();if(a.user){const{data:e}=await c.from("profiles").select("*").eq("id",a.user.id).single();D.value={nombre:e?.metadata?.nombre||"Karem",email:a.user.email}}}catch(a){console.error("Error al cargar perfil:",a),D.value={nombre:"Karem"}}}async function V(){S.value=!0;try{const a=new Date;a.setHours(0,0,0,0);const e=new Date(a);e.setDate(e.getDate()+7);const{data:n,error:u}=await c.from("citas").select(`
        id,
        paciente_id,
        fecha_cita,
        hora_inicio,
        modalidad,
        estado,
        observaciones,
        pacientes (
          id,
          nombre_completo,
          email
        )
      `).in("estado",["pendiente","confirmada"]).gte("fecha_cita",a.toISOString().split("T")[0]).lte("fecha_cita",e.toISOString().split("T")[0]).order("fecha_cita",{ascending:!0}).order("hora_inicio",{ascending:!0}).limit(5);if(u)throw u;h.value=(n||[]).map(o=>({id:o.id,hora_inicio:o.hora_inicio?o.hora_inicio.substring(0,5):"--:--",paciente_nombre:o.pacientes?.nombre_completo||o.pacientes?.email||"Paciente",modalidad:o.modalidad||"presencial",observaciones:o.observaciones}))}catch(a){console.error("Error al cargar sesiones:",a),h.value=[]}finally{S.value=!1}}async function U(){k.value=!0;try{const{data:a,error:e}=await c.from("pacientes").select("id, nombre_completo, area_de_acompanamiento, updated_at, metadata").eq("activo",!0).order("updated_at",{ascending:!1}).limit(5);if(e)throw e;b.value=(a||[]).map(n=>({id:n.id,nombre_completo:n.nombre_completo||"Sin nombre",ultima_sesion:n.updated_at?new Date(n.updated_at).toLocaleDateString("es-ES",{day:"numeric",month:"short"}):"Sin registro",progreso_bono:Math.floor(Math.random()*100)}))}catch(a){console.error("Error al cargar pacientes:",a),b.value=[]}finally{k.value=!1}}async function J(){try{const{count:a}=await c.from("pacientes").select("*",{count:"exact",head:!0}).eq("activo",!0);T.value=a||0;const e=new Date;e.setDate(1),e.setHours(0,0,0,0);const{count:n}=await c.from("citas").select("*",{count:"exact",head:!0}).gte("fecha_cita",e.toISOString().split("T")[0]);j.value=n||0,I.value=Math.floor(Math.random()*20)+80}catch(a){console.error("Error al cargar mÃ©tricas:",a)}}async function L(){y.value=!0;const a=[];try{const e=new Date;e.setHours(0,0,0,0);const n=new Date(e);n.setDate(e.getDate()+1);const u=n.toISOString().split("T")[0],{data:o}=await c.from("citas").select(`
        id,
        fecha_cita,
        hora_inicio,
        pacientes (
          nombre_completo
        )
      `).eq("estado","pendiente").eq("fecha_cita",u);o?.forEach(l=>{a.push(`Confirma la cita de ${l.pacientes?.nombre_completo||"paciente"} para maÃ±ana a las ${l.hora_inicio||"--:--"}`)});const{data:_}=await c.from("citas").select(`
        id,
        fecha_cita,
        pacientes (
          nombre_completo
        )
      `).lt("fecha_cita",e.toISOString().split("T")[0]).neq("estado","completada").neq("estado","cancelada").limit(3);_?.forEach(l=>{const p=new Date(l.fecha_cita).toLocaleDateString("es-ES",{day:"numeric",month:"short"});a.push(`Revisa la sesiÃ³n pendiente de ${l.pacientes?.nombre_completo||"paciente"} del ${p}`)});const{data:P}=await c.from("bonos").select(`
        id,
        sesiones_restantes,
        pacientes (
          nombre_completo
        )
      `).eq("estado","activo").lte("sesiones_restantes",2).limit(3);P?.forEach(l=>{a.push(`El bono de ${l.pacientes?.nombre_completo||"paciente"} estÃ¡ por agotarse (quedan ${l.sesiones_restantes} sesiones)`)});try{const{data:l}=await c.from("pagos").select(`
          paciente_id,
          monto,
          estado_pago,
          pacientes (
            nombre_completo
          )
        `).eq("estado_pago","pendiente").limit(3);l?.forEach(p=>{a.push(`Pago pendiente de ${p.pacientes?.nombre_completo||"paciente"} por ${p.monto} â‚¬`)})}catch{console.log("Tabla pagos no disponible")}const O=new Date;O.setDate(e.getDate()-14);const{data:W}=await c.from("pacientes").select("nombre_completo, updated_at").eq("activo",!0);W?.forEach(l=>{const p=new Date(l.updated_at);if(p<O){const X=Math.floor((e.getTime()-p.getTime())/864e5);a.push(`${l.nombre_completo} no ha tenido sesiÃ³n en ${X} dÃ­as`)}}),v.value=a.slice(0,5)}catch(e){console.error("Error al generar recordatorios:",e),v.value=[]}finally{y.value=!1}}async function G(){try{if(!A.value?.email)return;const{data:a}=await c.from("terapeutas").select("id").eq("email",A.value.email).single();if(!a)return;const{data:e}=await c.from("pacientes").select("id").eq("terapeuta_id",a.id);if(!e||e.length===0){g.value=0,f.value=0;return}const n=e.map(o=>o.id),{data:u}=await c.from("bonos").select("id, monto_total").eq("pagado",!0).in("paciente_id",n);if(u&&u.length>0){f.value=u.length;const o=u.reduce((_,P)=>_+(P.monto_total||0),0);g.value=o*.7}else g.value=0,f.value=0}catch(a){console.error("Error al cargar pagos confirmados:",a),g.value=0,f.value=0}}const Q=a=>a.toFixed(2);se(async()=>{await H(),await V(),await U(),await J(),await G(),await L(),window.addEventListener("citas:actualizadas",B)}),ne(()=>{window.removeEventListener("citas:actualizadas",B)});function B(a){console.log("ðŸ“¡ [Dashboard] Evento recibido:",a.detail),V()}return(a,e)=>{const n=Y,u=Z;return i(),r("div",le,[t("div",de,[t("div",null,[e[0]||(e[0]=t("h1",{class:"text-3xl font-serif font-bold text-cafe"},"Dashboard",-1)),t("p",me,"Bienvenida de nuevo, "+m(s(D)?.nombre||"Karem")+" ðŸ‘‹",1)]),t("div",{class:"flex gap-2"},[t("button",{onClick:z,class:"btn-primary"},"+ Nueva Cita"),t("button",{onClick:R,class:"btn-outline"},"+ Nuevo Paciente")])]),t("div",ue,[t("section",pe,[t("header",fe,[e[2]||(e[2]=t("h2",{class:"text-xl font-semibold text-cafe"},"ï¿½ï¸ PrÃ³ximas Sesiones",-1)),x(n,{to:"/agenda",class:"text-terracota text-sm hover:underline"},{default:w(()=>[...e[1]||(e[1]=[$(" Ver agenda â†’ ",-1)])]),_:1})]),s(S)?(i(),r("div",_e,"Cargando sesiones...")):s(h).length===0?(i(),r("div",ge,"No hay sesiones prÃ³ximas.")):(i(),r("div",xe,[(i(!0),r(q,null,M(s(h),o=>(i(),r("div",{key:o.id,class:"flex items-center justify-between bg-terracota/5 rounded-xl p-4 hover:bg-terracota/10 transition"},[t("div",null,[t("p",he,m(o.hora_inicio)+" â€” "+m(o.paciente_nombre),1),t("p",be,m(o.modalidad==="online"?"Online ðŸ’»":"Presencial ðŸ¥"),1)]),t("button",{onClick:_=>K(o.id),class:"px-3 py-1 text-sm border border-terracota/30 rounded-lg text-terracota hover:bg-terracota hover:text-white transition"}," Ver detalles ",8,ve)]))),128))]))]),t("section",ye,[t("header",we,[e[4]||(e[4]=t("h2",{class:"text-xl font-semibold text-cafe"},"ðŸ§ Pacientes Activos",-1)),x(n,{to:"/terapeuta/pacientes",class:"text-terracota text-sm hover:underline"},{default:w(()=>[...e[3]||(e[3]=[$(" Ver todos â†’ ",-1)])]),_:1})]),s(k)?(i(),r("div",De,"Cargando pacientes...")):s(b).length===0?(i(),r("div",Se,"No hay pacientes activos.")):(i(),r("div",ke,[(i(!0),r(q,null,M(s(b),o=>(i(),r("div",{key:o.id,class:"flex items-center justify-between bg-white border border-cafe/5 rounded-xl p-4 hover:shadow-sm transition"},[t("div",Ce,[t("p",Ee,m(o.nombre_completo),1),t("p",Pe,"Ãšltima sesiÃ³n: "+m(o.ultima_sesion||"Sin registro"),1),t("div",qe,[t("div",{class:"h-1 rounded-full bg-green-500 transition-all",style:ie({width:`${o.progreso_bono||0}%`})},null,4)])]),x(n,{to:`/terapeuta/pacientes/${o.id}`,class:"px-3 py-1 text-sm border border-cafe/10 text-cafe rounded-lg hover:bg-cafe/5 ml-3"},{default:w(()=>[...e[5]||(e[5]=[$(" Ver perfil ",-1)])]),_:1},8,["to"])]))),128))]))])]),t("div",Me,[t("section",$e,[e[11]||(e[11]=t("header",{class:"flex justify-between items-center mb-4"},[t("h2",{class:"text-xl font-semibold text-cafe"},"ðŸ“Š AnalÃ­tica del Profesional")],-1)),t("div",Ne,[t("div",Ae,[t("p",Te,m(s(T)),1),e[6]||(e[6]=t("p",{class:"text-sm text-cafe/60"},"Pacientes activos",-1))]),t("div",je,[t("p",Ie,m(s(j)),1),e[7]||(e[7]=t("p",{class:"text-sm text-cafe/60"},"Sesiones este mes",-1))]),t("div",Ve,[t("p",Le,m(s(I))+"%",1),e[8]||(e[8]=t("p",{class:"text-sm text-cafe/60"},"Asistencia promedio",-1))]),x(n,{to:"/terapeuta/sesiones",class:"p-4 bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl border-2 border-green-200 hover:border-green-300 transition-all hover:shadow-md group"},{default:w(()=>[t("div",Be,[e[9]||(e[9]=t("span",{class:"text-2xl group-hover:scale-110 transition-transform"},"ðŸ’¶",-1)),t("p",Oe,m(Q(s(g)))+"â‚¬",1)]),e[10]||(e[10]=t("p",{class:"text-sm text-cafe/60"},"Pagos confirmados",-1)),t("p",ze,m(s(f))+" "+m(s(f)===1?"bono":"bonos"),1)]),_:1})])]),t("section",Re,[t("header",Ke,[e[12]||(e[12]=t("h2",{class:"text-xl font-semibold text-cafe"},"ðŸ’¬ Recordatorios",-1)),s(y)?re("",!0):(i(),r("button",{key:0,onClick:L,class:"text-xs text-terracota hover:text-cafe transition",title:"Actualizar recordatorios"}," ðŸ”„ "))]),s(y)?(i(),r("div",Fe," Cargando recordatorios... ")):s(v).length?(i(),r("ul",He,[(i(!0),r(q,null,M(s(v),(o,_)=>(i(),r("li",{key:_,class:"flex items-start gap-2 bg-terracota/5 rounded-lg px-3 py-2 hover:bg-terracota/10 transition"},[e[13]||(e[13]=t("span",{class:"flex-shrink-0 mt-0.5"},"ðŸ””",-1)),t("span",Ue,m(o),1)]))),128))])):(i(),r("div",Je," No hay recordatorios pendientes ðŸŽ‰ "))])]),x(u,{"is-open":s(C),"cita-id":s(E),onClose:F},null,8,["is-open","cita-id"])])}}}),lt=ce(Ge,[["__scopeId","data-v-d953f9ea"]]);export{lt as default};
