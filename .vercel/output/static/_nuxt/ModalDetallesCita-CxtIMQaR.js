import{c as i,o as s,a as e,g as we,q as sa,r as k,z as v,e as ie,n as B,k as r,j as b,t as u,d as j,F as H,s as ke,D as na,J as U,T as Ce,l as ee,b as S,L as ra,I as K,w as J,M as W,N as ne,i as ia,m as G,v as X,K as ge,y as la}from"#entry";import{_ as da}from"./PaymentMethodSelector-BdCeWAUw.js";import{u as Se}from"./useToast-Cq0GyJHs.js";import{_ as ca}from"./ModalNuevoBono-DZsr-zos.js";import{r as ve}from"./XMarkIcon-DWNj0d99.js";import{r as Y}from"./CheckCircleIcon-Bi0YyG7H.js";import{r as be}from"./PencilIcon-QJyqa3i7.js";import{r as ua}from"./PhoneIcon-B4J2dtua.js";import{r as ma}from"./CalendarDaysIcon-C0vq0F4x.js";import{r as fa}from"./ClockIcon-CQZt9cKZ.js";import{r as pa}from"./TicketIcon-DRclOuRO.js";import{r as ye}from"./ChevronDownIcon-BwiNUDLV.js";import{r as re}from"./ExclamationTriangleIcon-BreoAuwB.js";import{r as _e}from"./PlusIcon-UqRq4KLf.js";import{_ as ga}from"./_plugin-vue_export-helper-DlAUqK2U.js";function va(y,O){return s(),i("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M13.5 6H5.25A2.25 2.25 0 0 0 3 8.25v10.5A2.25 2.25 0 0 0 5.25 21h10.5A2.25 2.25 0 0 0 18 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25"})])}function xe(y,O){return s(),i("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m4.5 15.75 7.5-7.5 7.5 7.5"})])}function ba(y,O){return s(),i("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"}),e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z"})])}function ya(y,O){return s(),i("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m15.75 10.5 4.72-4.72a.75.75 0 0 1 1.28.53v11.38a.75.75 0 0 1-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25h-9A2.25 2.25 0 0 0 2.25 7.5v9a2.25 2.25 0 0 0 2.25 2.25Z"})])}function le(){const y=we(),{userProfile:O}=sa(),n=k([]),f=k(!1),P=k(null),V=v(()=>{const m=new Date().toISOString().split("T")[0],c=n.value.filter(a=>a.estado_pago==="pagado"),_=n.value.filter(a=>a.estado_pago==="pendiente"||!a.estado_pago),p={efectivo:{total:0,cantidad:0},transferencia:{total:0,cantidad:0},bizum:{total:0,cantidad:0},tarjeta:{total:0,cantidad:0},stripe:{total:0,cantidad:0}};return c.forEach(a=>{a.metodo_pago&&p[a.metodo_pago]&&(p[a.metodo_pago].total+=a.precio_sesion||0,p[a.metodo_pago].cantidad+=1)}),{fecha:m,total:c.reduce((a,g)=>a+(g.precio_sesion||0),0),cantidadPagos:c.length,porMetodo:p,pagos:c,pendientes:_}});async function C(m){const c=O.value?.terapeuta_id||O.value?.id;if(!c)return console.warn("[usePayments] No hay terapeuta_id disponible"),[];const _=m||new Date().toISOString().split("T")[0];f.value=!0,P.value=null;try{const{data:p,error:a}=await y.from("citas").select(`
          id,
          fecha_cita,
          hora_inicio,
          hora_fin,
          precio_sesion,
          estado_pago,
          metodo_pago,
          fecha_pago,
          bono_id,
          estado,
          paciente:pacientes(id, nombre_completo)
        `).eq("terapeuta_id",c).eq("fecha_cita",_).in("estado",["confirmada","realizada"]).order("hora_inicio",{ascending:!0});if(a)throw new Error(a.message);const g=(p||[]).map(d=>({id:d.id,paciente_id:d.paciente?.id||"",paciente_nombre:d.paciente?.nombre_completo||"Sin nombre",fecha_cita:d.fecha_cita,hora_inicio:d.hora_inicio,hora_fin:d.hora_fin,precio_sesion:d.precio_sesion,estado_pago:d.estado_pago,metodo_pago:d.metodo_pago,fecha_pago:d.fecha_pago,bono_id:d.bono_id,estado:d.estado}));return n.value=g,g}catch(p){return P.value=p.message,console.error("[usePayments] Error obteniendo pagos:",p),[]}finally{f.value=!1}}async function M(m,c,_,p){f.value=!0,P.value=null;try{const{data:a,error:g}=await y.rpc("fn_registrar_pago_sesion",{p_cita_id:m,p_metodo_pago:c,p_monto:_||null,p_notas:p||null});if(!g)return await $(),{success:!0,data:a};console.warn("[usePayments] RPC fallÃ³, usando fallback:",g.message);const d={estado_pago:"pagado",metodo_pago:c,fecha_pago:new Date().toISOString(),updated_at:new Date().toISOString()};_!==void 0&&(d.precio_sesion=_),p&&(d.notas_pago=p);const{error:z}=await y.from("citas").update(d).eq("id",m);if(z)throw new Error(z.message);return await $(),{success:!0}}catch(a){return P.value=a.message,console.error("[usePayments] Error registrando pago:",a),{success:!1,error:a.message}}finally{f.value=!1}}async function E(m,c){f.value=!0,P.value=null;try{const{error:_}=await y.from("citas").update({metodo_pago:c,updated_at:new Date().toISOString()}).eq("id",m);if(_)throw new Error(_.message);return await $(),{success:!0}}catch(_){return P.value=_.message,console.error("[usePayments] Error actualizando mÃ©todo:",_),{success:!1,error:_.message}}finally{f.value=!1}}async function D(m){f.value=!0,P.value=null;try{const{error:c}=await y.from("citas").update({estado_pago:"pendiente",metodo_pago:null,fecha_pago:null,notas_pago:null,updated_at:new Date().toISOString()}).eq("id",m);if(c)throw new Error(c.message);return await $(),{success:!0}}catch(c){return P.value=c.message,console.error("[usePayments] Error deshaciendo pago:",c),{success:!1,error:c.message}}finally{f.value=!1}}function q(m){const c={efectivo:{total:0,cantidad:0},transferencia:{total:0,cantidad:0},bizum:{total:0,cantidad:0},tarjeta:{total:0,cantidad:0},stripe:{total:0,cantidad:0}},_=m.filter(p=>p.estado_pago==="pagado");return _.forEach(p=>{p.metodo_pago&&c[p.metodo_pago]&&(c[p.metodo_pago].total+=p.precio_sesion||0,c[p.metodo_pago].cantidad+=1)}),{total:_.reduce((p,a)=>p+(a.precio_sesion||0),0),porMetodo:c}}async function $(){await C()}function T(m){return m?{efectivo:"ðŸ’µ Efectivo",transferencia:"ðŸ¦ Transferencia",bizum:"ðŸ“± Bizum",tarjeta:"ðŸ’³ Tarjeta",stripe:"âš¡ Stripe"}[m]:"No especificado"}function A(m){if(!m)return"";const c=new Date(m),_=new Date,p=new Date(_);p.setDate(p.getDate()-1);const a=c.toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit"}),g=c.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"});return c.toDateString()===_.toDateString()?`Hoy a las ${g}`:c.toDateString()===p.toDateString()?`Ayer a las ${g}`:`${a} a las ${g}`}return{pagosDia:n,loading:f,error:P,resumenDia:V,getPaymentsOfDay:C,createPayment:M,updatePaymentMethod:E,undoPayment:D,refreshPaymentsForToday:$,getPaymentSummary:q,formatPaymentMethod:T,formatPaymentDate:A}}const _a={class:"flex items-start justify-between gap-3"},xa={class:"flex items-center gap-2"},ha={key:0,class:"text-xs text-gray-500 mt-0.5"},wa={key:0},ka={key:1,class:"ml-1"},Ca={key:1,class:"text-xs text-blue-600 mt-0.5"},Sa={key:0,class:"text-right"},Pa={key:2,class:"text-xs text-blue-600 italic"},Ea=ie({__name:"PaymentStatusBadge",props:{estadoPago:{},metodoPago:{default:null},fechaPago:{default:null},cantidad:{default:null},showActions:{type:Boolean,default:!0},compact:{type:Boolean,default:!1}},emits:["registrar","cambiar","deshacer"],setup(y,{emit:O}){const n=y,f=O,{formatPaymentMethod:P,formatPaymentDate:V}=le(),C=v(()=>{switch(n.estadoPago){case"pagado":return{label:"Pagado",icon:"âœ“",bgColor:"bg-green-50",textColor:"text-green-700",borderColor:"border-green-200",iconBg:"bg-green-500"};case"bonificado":return{label:"Bonificado",icon:"ðŸŽ",bgColor:"bg-blue-50",textColor:"text-blue-700",borderColor:"border-blue-200",iconBg:"bg-blue-500"};case"cancelado":return{label:"Cancelado",icon:"âœ•",bgColor:"bg-gray-50",textColor:"text-gray-500",borderColor:"border-gray-200",iconBg:"bg-gray-400"};default:return{label:"Pendiente",icon:"â³",bgColor:"bg-amber-50",textColor:"text-amber-700",borderColor:"border-amber-200",iconBg:"bg-amber-500"}}}),M=v(()=>n.estadoPago==="pagado"),E=v(()=>!n.estadoPago||n.estadoPago==="pendiente"),D=v(()=>n.estadoPago==="bonificado"),q=v(()=>n.metodoPago?P(n.metodoPago):null),$=v(()=>n.fechaPago?V(n.fechaPago):null),T=v(()=>n.cantidad===null||n.cantidad===void 0?null:`${n.cantidad.toFixed(2)}â‚¬`);return(A,m)=>(s(),i("div",{class:B(["rounded-lg border transition-colors",r(C).bgColor,r(C).borderColor,y.compact?"p-2":"p-3"])},[e("div",_a,[e("div",xa,[e("span",{class:B(["flex items-center justify-center rounded-full text-white",r(C).iconBg,y.compact?"w-5 h-5 text-xs":"w-6 h-6 text-sm"]),"aria-hidden":"true"},u(r(C).icon),3),e("div",null,[e("span",{class:B(["font-medium",r(C).textColor,y.compact?"text-sm":"text-base"])},u(r(C).label),3),r(M)&&!y.compact?(s(),i("p",ha,[r(q)?(s(),i("span",wa,u(r(q)),1)):b("",!0),r($)?(s(),i("span",ka,"Â· "+u(r($)),1)):b("",!0)])):b("",!0),r(D)&&!y.compact?(s(),i("p",Ca," SesiÃ³n cubierta por bono ")):b("",!0)])]),r(T)&&!y.compact?(s(),i("div",Sa,[e("span",{class:B(["font-semibold",r(C).textColor])},u(r(T)),3)])):b("",!0)]),y.showActions&&!y.compact?(s(),i("div",{key:0,class:B(["mt-3 pt-3 border-t flex flex-wrap gap-2",r(C).borderColor])},[r(E)?(s(),i("button",{key:0,type:"button",class:"flex-1 inline-flex items-center justify-center gap-1.5 px-3 py-2 text-sm font-medium text-white bg-teal-600 rounded-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-colors",onClick:m[0]||(m[0]=c=>f("registrar"))},[...m[3]||(m[3]=[e("span",{"aria-hidden":"true"},"ðŸ’³",-1),j(" Registrar pago ",-1)])])):b("",!0),r(M)?(s(),i(H,{key:1},[e("button",{type:"button",class:"inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-colors",onClick:m[1]||(m[1]=c=>f("cambiar"))},[...m[4]||(m[4]=[e("span",{"aria-hidden":"true"},"ðŸ”„",-1),j(" Cambiar mÃ©todo ",-1)])]),e("button",{type:"button",class:"inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-red-600 bg-white border border-red-200 rounded-lg hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors",onClick:m[2]||(m[2]=c=>f("deshacer"))},[...m[5]||(m[5]=[e("span",{"aria-hidden":"true"},"â†©ï¸",-1),j(" Deshacer ",-1)])])],64)):b("",!0),r(D)?(s(),i("p",Pa," Esta sesiÃ³n estÃ¡ vinculada a un bono activo ")):b("",!0)],2)):b("",!0)],2))}}),Ia=Object.assign(Ea,{__name:"PaymentStatusBadge"}),Da={class:"px-5 py-4 bg-gray-50 border-b border-gray-200"},$a={id:"payment-modal-title",class:"text-lg font-semibold text-gray-900"},Ma={class:"p-5 space-y-5"},za={class:"text-center pb-4 border-b border-gray-100"},Ba={class:"text-3xl font-bold text-gray-900"},ja={class:"mt-1 text-base text-gray-700"},Ta={class:"text-sm text-gray-500"},Aa={key:0,class:"ml-1"},Oa={class:"px-5 py-4 bg-gray-50 border-t border-gray-200 flex gap-3"},qa=["disabled"],Na=["disabled"],Va={key:0,class:"inline-flex items-center gap-2"},Ra={key:1},Fa=ie({__name:"PaymentQuickModal",props:{citaId:{},pacienteNombre:{},cantidad:{},tipoTransaccion:{default:"sesion_unica"},bonoInfo:{default:null},horaInicio:{default:""},metodoPagoActual:{default:null},modoEdicion:{type:Boolean,default:!1}},emits:["confirm","cancel"],setup(y,{emit:O}){const n=y,f=O,{createPayment:P,updatePaymentMethod:V}=le(),{success:C,error:M}=Se(),E=k(n.metodoPagoActual),D=k(!1),q=v(()=>n.bonoInfo?`SesiÃ³n ${n.bonoInfo.numeroSesion||n.bonoInfo.sesionesTotales-n.bonoInfo.sesionesRestantes+1}/${n.bonoInfo.sesionesTotales} "${n.bonoInfo.nombre}"`:"SesiÃ³n individual"),$=v(()=>n.modoEdicion?"Cambiar mÃ©todo de pago":"Registrar pago"),T=v(()=>`${n.cantidad.toFixed(2)}â‚¬`);function A(a){E.value=a}async function m(){if(!E.value){M("Selecciona un mÃ©todo de pago");return}D.value=!0;try{let a;n.modoEdicion?a=await V(n.citaId,E.value):a=await P(n.citaId,E.value,n.cantidad),a.success?(C(n.modoEdicion?"MÃ©todo actualizado":"Pago registrado"),f("confirm",E.value)):M(a.error||"Error al procesar el pago")}catch(a){console.error("[PaymentQuickModal] Error:",a),M("Error inesperado")}finally{D.value=!1}}function c(){f("cancel")}function _(a){a.target===a.currentTarget&&c()}function p(a){a.key==="Escape"&&c()}return ke(()=>{document.addEventListener("keydown",p)}),na(()=>{document.removeEventListener("keydown",p)}),(a,g)=>{const d=da;return s(),U(Ce,{to:"body"},[e("div",{class:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",role:"dialog","aria-modal":"true","aria-labelledby":"payment-modal-title",onClick:_},[e("div",{class:"w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden",onClick:g[0]||(g[0]=ee(()=>{},["stop"]))},[e("div",Da,[e("h2",$a,u(r($)),1)]),e("div",Ma,[e("div",za,[e("p",Ba,u(r(T)),1),e("p",ja,u(y.pacienteNombre),1),e("p",Ta,[j(u(r(q))+" ",1),y.horaInicio?(s(),i("span",Aa,"Â· "+u(y.horaInicio),1)):b("",!0)])]),e("div",null,[g[1]||(g[1]=e("label",{class:"block text-sm font-medium text-gray-700 mb-3"}," MÃ©todo de pago ",-1)),S(d,{"selected-method":r(E),disabled:r(D),size:"md",onSelect:A},null,8,["selected-method","disabled"])])]),e("div",Oa,[e("button",{type:"button",class:"flex-1 px-4 py-2.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors",disabled:r(D),onClick:c}," Cancelar ",8,qa),e("button",{type:"button",class:"flex-1 px-4 py-2.5 text-sm font-medium text-white bg-teal-600 rounded-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",disabled:!r(E)||r(D),onClick:m},[r(D)?(s(),i("span",Va,[...g[2]||(g[2]=[e("svg",{class:"animate-spin h-4 w-4",fill:"none",viewBox:"0 0 24 24"},[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})],-1),j(" Procesando... ",-1)])])):(s(),i("span",Ra,u(y.modoEdicion?"Actualizar":"Confirmar pago"),1))],8,Na)])])])])}}}),Ua=Object.assign(Fa,{__name:"PaymentQuickModal"}),La={class:"px-5 py-4 border-b border-gray-100 flex items-center justify-between bg-white"},Qa={class:"flex items-center gap-3"},Ga={class:"w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-sm font-semibold text-gray-600"},Ha={id:"modal-title",class:"text-base font-semibold text-gray-900"},Za={key:0,class:"flex-1 flex items-center justify-center p-12"},Ka={key:1,class:"flex-1 overflow-y-auto"},Ja={class:"px-5 py-3 border-b border-gray-100 flex items-center gap-2 flex-wrap"},Wa=["disabled"],Xa={class:"px-5 py-4 border-b border-gray-100"},Ya={class:"flex items-center justify-between text-sm"},et={class:"flex items-center gap-4"},at={class:"flex items-center gap-1.5 text-gray-600"},tt={class:"flex items-center gap-1.5 text-gray-600"},ot={class:"flex items-center gap-1.5 text-gray-600"},st={class:"text-gray-500"},nt={class:"mx-5 my-4"},rt={key:0,class:"mt-2 text-xs text-amber-600 text-center"},it={key:1,class:"mt-3 p-3 bg-red-50 border border-red-200 rounded-lg"},lt={class:"flex gap-2"},dt=["disabled"],ct=["disabled"],ut={class:"mx-5 mb-3"},mt={class:"flex items-center gap-2"},ft={class:"flex items-center gap-2"},pt={key:0,class:"text-xs text-gray-500"},gt={key:0,class:"mt-2 overflow-hidden"},vt={key:0,class:"p-4 bg-white border border-gray-100 rounded-lg space-y-3"},bt={class:"flex items-center justify-between"},yt={class:"flex items-center gap-2"},_t={class:"text-sm font-semibold text-purple-700"},xt={key:0,class:"px-2 py-0.5 text-xs bg-green-100 text-green-700 rounded-full font-medium"},ht={key:1,class:"px-2 py-0.5 text-xs bg-amber-100 text-amber-700 rounded-full font-medium"},wt={class:"grid grid-cols-2 gap-3 p-3 bg-purple-50/50 rounded-lg"},kt={class:"text-sm font-semibold text-gray-900"},Ct={class:"text-sm font-semibold text-gray-900"},St={class:"flex items-center justify-between text-xs text-gray-600 mb-1.5"},Pt={class:"font-semibold text-purple-700"},Et={class:"flex gap-1"},It=["title"],Dt={class:"text-xs text-gray-500 mt-1.5"},$t={class:"flex items-start gap-2"},Mt={key:0,class:"text-xs text-amber-700 mt-0.5"},zt={key:1,class:"flex items-center gap-2 p-2 bg-orange-50 border border-orange-200 rounded-lg"},Bt={key:2,class:"flex items-center gap-2 p-2 bg-red-50 border border-red-200 rounded-lg"},jt={class:"flex items-center gap-2 pt-2 border-t border-gray-100"},Tt=["disabled"],At=["disabled"],Ot={key:1,class:"p-4 bg-gray-50 border border-gray-100 rounded-lg text-center"},qt={key:1,class:"mx-5 mb-4"},Nt={key:0,class:"mt-2 px-4 py-3 bg-gray-50 rounded-lg overflow-hidden"},Vt={class:"text-sm text-gray-700 whitespace-pre-wrap"},Rt={class:"px-5 py-3 border-t border-gray-100 flex items-center justify-between text-xs text-gray-400"},Ft={key:2,class:"px-5 pb-4"},Ut=["disabled"],Lt={key:0,class:"w-5 h-5 animate-spin",fill:"none",viewBox:"0 0 24 24"},Qt={class:"grid grid-cols-2 gap-3"},Gt={class:"grid grid-cols-2 gap-3"},Ht={class:"flex gap-3 pt-2"},Zt=["disabled"],Kt={key:2,class:"flex-1 flex items-center justify-center p-12 text-center"},Jt={class:"w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3"},Wt={class:"text-gray-400 text-sm mt-1"},he=70,Xt=ie({__name:"ModalDetallesCita",props:{citaId:{}},emits:["close","cita-actualizada","cita-eliminada","actualizado","eliminado"],setup(y,{emit:O}){const n=y,f=O,P=k(!1),V=k(!1),C=k(!1),M=k(!1),E=k(!1),D=k(null),q=k(!0),$=k(!1),T=k(!1),A=k(!1),m=k(!1),c=k(!1),_=k(!1),p=k(!1),a=k(null),g=k(null),d=k(null),z=k(null);ra();const{undoPayment:Pe}=le(),{success:L,error:F}=Se(),h=k({fecha_cita:"",hora_inicio:"",hora_fin:"",modalidad:"",observaciones:"",estado:""}),N=we();ke(()=>{const t=localStorage.getItem("modal-seccion-observaciones");$.value=t==="true"}),K(q,t=>{localStorage.setItem("modal-seccion-bono",String(t))}),K($,t=>{localStorage.setItem("modal-seccion-observaciones",String(t))});const Z=async()=>{if(n.citaId)try{A.value=!0;const{data:t,error:o}=await N.from("citas").select(`
        *,
        paciente:pacientes(
          id,
          nombre_completo,
          email,
          telefono,
          frecuencia
        )
      `).eq("id",n.citaId).single();if(o)throw o;if(a.value=t,g.value=t.paciente,t.bono_id){const{data:w,error:R}=await N.from("bonos").select(`
          id,
          tipo,
          sesiones_totales,
          sesiones_restantes,
          monto_total,
          precio_por_sesion,
          fecha_inicio,
          fecha_fin,
          estado,
          pagado,
          created_at,
          updated_at
        `).eq("id",t.bono_id).single();if(!R){d.value=w;const{data:Q}=await N.from("citas").select("id, fecha_cita, hora_inicio").eq("bono_id",t.bono_id).eq("sesion_descontada",!0).order("fecha_cita",{ascending:!0}).order("hora_inicio",{ascending:!0});if(Q){const x=Q.findIndex(oa=>oa.id===n.citaId);x!==-1&&(d.value.numero_sesion=x+1)}}}else d.value=null;if(!t.bono_id&&t.paciente?.id){const{data:w}=await N.from("bonos").select(`
          id,
          tipo,
          sesiones_totales,
          sesiones_restantes,
          monto_total,
          precio_por_sesion,
          fecha_inicio,
          fecha_fin,
          estado,
          pagado,
          created_at,
          updated_at
        `).eq("paciente_id",t.paciente.id).in("estado",["activo","pendiente"]).gt("sesiones_restantes",0).order("created_at",{ascending:!1}).limit(1).maybeSingle();z.value=w}else z.value=null;h.value={fecha_cita:t.fecha_cita,hora_inicio:t.hora_inicio?.substring(0,5)||"",hora_fin:t.hora_fin?.substring(0,5)||"",modalidad:t.modalidad,observaciones:t.observaciones||"",estado:t.estado},C.value=!1,M.value=!1}catch(t){console.error("Error al cargar cita:",t)}finally{A.value=!1}};K(()=>n.citaId,t=>{t?Z():(a.value=null,g.value=null,d.value=null,z.value=null)},{immediate:!0});const Ee=v(()=>{if(!a.value?.fecha_cita)return"";const t=new Date(a.value.fecha_cita+"T00:00:00"),o=new Date,w=new Date(o);return w.setDate(w.getDate()+1),t.toDateString()===o.toDateString()?"Hoy":t.toDateString()===w.toDateString()?"MaÃ±ana":t.toLocaleDateString("es-ES",{weekday:"short",day:"numeric",month:"short"})}),Ie=v(()=>{if(!a.value)return"";const t=a.value.hora_inicio?.substring(0,5)||"",o=a.value.hora_fin?.substring(0,5)||"";return`${t} - ${o}`}),De=v(()=>{if(!a.value?.hora_inicio||!a.value?.hora_fin)return 60;const[t,o]=a.value.hora_inicio.split(":").map(Number),[w,R]=a.value.hora_fin.split(":").map(Number);return w*60+R-(t*60+o)}),$e=v(()=>({presencial:"Presencial",virtual:"Online",telefonica:"TelefÃ³nica"})[a.value?.modalidad]||a.value?.modalidad||"-"),ae=v(()=>a.value?.estado||"pendiente"),Me=v(()=>({pendiente:"bg-amber-100 text-amber-700",confirmada:"bg-emerald-100 text-emerald-700",realizada:"bg-blue-100 text-blue-700",cancelada:"bg-gray-100 text-gray-500"})[ae.value]||"bg-gray-100 text-gray-600"),ze=v(()=>({pendiente:"Pendiente",confirmada:"Confirmada",realizada:"Realizada",cancelada:"Cancelada"})[ae.value]||ae.value),te=v(()=>a.value?.estado_pago||"pendiente"),de=v(()=>a.value?.estado==="pendiente"),ce=v(()=>{if(!a.value)return!1;const t=a.value.estado,o=a.value.estado_pago;return(t==="confirmada"||t==="realizada")&&(o==="pendiente"||!o)}),ue=v(()=>{if(!a.value)return!1;const t=a.value.estado;return t==="confirmada"||t==="pendiente"}),Be=v(()=>!d.value||a.value?.sesion_descontada||d.value.sesiones_restantes<=0?!1:a.value?.estado==="realizada"||a.value?.estado==="confirmada"),je=v(()=>d.value||!z.value?!1:z.value.sesiones_restantes>0),l=v(()=>d.value||z.value),me=v(()=>l.value?l.value.sesiones_totales-l.value.sesiones_restantes:0);v(()=>l.value?me.value/l.value.sesiones_totales*100:0);const fe=v(()=>l.value?.fecha_fin?new Date(l.value.fecha_fin).toLocaleDateString("es-ES",{day:"numeric",month:"short"}):null),Te=v(()=>{if(!l.value?.fecha_fin)return!1;const t=new Date(l.value.fecha_fin),o=new Date,w=Math.floor((t.getTime()-o.getTime())/(1e3*60*60*24));return w<=7&&w>=0}),oe=v(()=>l.value?.fecha_fin?new Date(l.value.fecha_fin)<new Date:!1),Ae=v(()=>l.value?.tipo?{semanal:"Semanal",quincenal:"Quincenal",mensual:"Mensual",otro:"Personalizado"}[l.value.tipo]||l.value.tipo:"Bono"),pe=v(()=>a.value?.precio_sesion?a.value.precio_sesion:l.value?.precio_por_sesion?l.value.precio_por_sesion:l.value&&l.value.monto_total&&l.value.sesiones_totales?Math.round(l.value.monto_total/l.value.sesiones_totales*100)/100:50),I=v(()=>{if(!l.value)return null;const t=l.value.sesiones_totales-l.value.sesiones_restantes,o=t+1;return{tipo:l.value.tipo||"Bono",sesionesRestantes:l.value.sesiones_restantes,sesionesTotales:l.value.sesiones_totales,sesionesUsadas:t,numeroSesionActual:a.value?.sesion_descontada?t:o,montoTotal:l.value.monto_total,precioPorSesion:l.value.precio_por_sesion||l.value.monto_total/l.value.sesiones_totales,pagado:l.value.pagado,estado:l.value.estado,fechaInicio:l.value.fecha_inicio,fechaFin:l.value.fecha_fin,esAsignado:!!d.value,sesionDescontada:a.value?.sesion_descontada}}),Oe=v(()=>{if(!g.value?.nombre_completo)return"?";const t=g.value.nombre_completo.split(" ");return t.length>=2?(t[0][0]+t[1][0]).toUpperCase():t[0].substring(0,2).toUpperCase()}),qe=v(()=>d.value?{id:d.value.id,nombre:d.value.tipo||"Bono",sesionesRestantes:d.value.sesiones_restantes,sesionesTotales:d.value.sesiones_totales,numeroSesion:d.value.numero_sesion}:null),se=()=>{T.value=!1,C.value=!1,M.value=!1,m.value=!1,f("close")},Ne=()=>{g.value?.telefono&&window.open(`tel:${g.value.telefono}`,"_self")},Ve=()=>{T.value=!0},Re=async()=>{if(!(!n.citaId||P.value||!de.value)){P.value=!0;try{const{error:t}=await N.from("citas").update({estado:"confirmada",updated_at:new Date().toISOString()}).eq("id",n.citaId);if(t)throw t;a.value&&(a.value.estado="confirmada"),f("cita-actualizada"),f("actualizado")}catch(t){console.error("Error al confirmar cita:",t),F(`Error al confirmar: ${t.message}`)}finally{P.value=!1}}},Fe=async()=>{if(!(!n.citaId||V.value||!ue.value)){V.value=!0;try{const t={estado:"realizada",updated_at:new Date().toISOString()};(!a.value?.estado_pago||a.value.estado_pago==="pendiente")&&(t.estado_pago="pendiente");const{error:o}=await N.from("citas").update(t).eq("id",n.citaId);if(o)throw o;a.value&&(a.value.estado="realizada",t.estado_pago&&(a.value.estado_pago=t.estado_pago)),L("SesiÃ³n marcada como realizada"),f("cita-actualizada"),f("actualizado")}catch(t){console.error("Error al marcar como realizada:",t),F(`Error: ${t.message}`)}finally{V.value=!1}}},Ue=async()=>{if(!(!n.citaId||!d.value||_.value)){_.value=!0;try{const{error:t}=await N.from("citas").update({sesion_descontada:!0,descontar_de_bono:!0,updated_at:new Date().toISOString()}).eq("id",n.citaId);if(t)throw t;const o=d.value.sesiones_restantes-1,w=o<=0?"agotado":d.value.estado,{error:R}=await N.from("bonos").update({sesiones_restantes:o,estado:w,updated_at:new Date().toISOString()}).eq("id",d.value.id);if(R)throw R;a.value.sesion_descontada=!0,d.value.sesiones_restantes=o,d.value.estado=w,L("SesiÃ³n consumida del bono"),f("cita-actualizada"),f("actualizado")}catch(t){console.error("Error al consumir sesiÃ³n:",t),F(`Error: ${t.message}`)}finally{_.value=!1}}},Le=async()=>{if(!(!n.citaId||!z.value||p.value)){p.value=!0;try{const{error:t}=await N.from("citas").update({bono_id:z.value.id,descontar_de_bono:!0,updated_at:new Date().toISOString()}).eq("id",n.citaId);if(t)throw t;a.value.bono_id=z.value.id,d.value=z.value,z.value=null,L("Bono asignado a la cita"),f("cita-actualizada"),f("actualizado")}catch(t){console.error("Error al asignar bono:",t),F(`Error: ${t.message}`)}finally{p.value=!1}}},Qe=()=>{g.value?.id&&(D.value=null,E.value=!0)},Ge=()=>{l.value&&(D.value=l.value,E.value=!0)},He=async t=>{E.value=!1;try{const o=t.monto_total&&t.sesiones_totales?Number(t.monto_total)/Number(t.sesiones_totales):he;if(n.citaId&&a.value){const{error:w}=await N.from("citas").update({bono_id:t.id,descontar_de_bono:!0,precio_sesion:o,updated_at:new Date().toISOString()}).eq("id",n.citaId);w?(console.error("Error al asignar bono a cita:",w),F("Bono creado pero no se pudo asignar a la cita")):(a.value.bono_id=t.id,a.value.precio_sesion=o,d.value=t,L(`Bono creado y asignado (${o.toFixed(0)}â‚¬/sesiÃ³n)`))}else L("Bono creado correctamente");n.citaId&&await Z(n.citaId),f("cita-actualizada"),f("actualizado")}catch(o){console.error("Error en handleBonoCreado:",o),F("Error al procesar el bono")}},Ze=async t=>{if(E.value=!1,D.value=null,L("Bono actualizado correctamente"),n.citaId&&a.value&&t){const o=t.monto_total&&t.sesiones_totales?Number(t.monto_total)/Number(t.sesiones_totales):he;await N.from("citas").update({precio_sesion:o,updated_at:new Date().toISOString()}).eq("id",n.citaId),a.value.precio_sesion=o}n.citaId&&await Z(n.citaId),f("cita-actualizada"),f("actualizado")},Ke=()=>{g.value?.id?(console.log("[ModalDetallesCita] Navegando a bonos del paciente:",g.value.id),se(),la(`/terapeuta/pacientes/${g.value.id}/bonos`)):console.error("[ModalDetallesCita] ERROR: No se encontrÃ³ ID del paciente")},Je=()=>{M.value=!1,C.value=!0},We=()=>{M.value=!0,C.value=!0},Xe=t=>{a.value&&(a.value.estado_pago="pagado",a.value.metodo_pago=t,a.value.fecha_pago=new Date().toISOString()),C.value=!1,M.value=!1,f("cita-actualizada"),f("actualizado")},Ye=()=>{C.value=!1,M.value=!1},ea=async()=>{if(!(!n.citaId||c.value)){c.value=!0;try{const t=await Pe(n.citaId);t.success?(a.value&&(a.value.estado_pago="pendiente",a.value.metodo_pago=null,a.value.fecha_pago=null),L("Pago deshecho"),m.value=!1,f("cita-actualizada"),f("actualizado")):F(t.error||"Error al deshacer pago")}catch(t){console.error("Error al deshacer pago:",t),F("Error inesperado")}finally{c.value=!1}}},aa=()=>{T.value=!1,a.value&&(h.value={fecha_cita:a.value.fecha_cita,hora_inicio:a.value.hora_inicio?.substring(0,5)||"",hora_fin:a.value.hora_fin?.substring(0,5)||"",modalidad:a.value.modalidad,observaciones:a.value.observaciones||"",estado:a.value.estado})},ta=async()=>{if(n.citaId)try{A.value=!0;const t=parseInt(h.value.hora_inicio.split(":")[0])*60+parseInt(h.value.hora_inicio.split(":")[1]);if(parseInt(h.value.hora_fin.split(":")[0])*60+parseInt(h.value.hora_fin.split(":")[1])<=t){F("La hora de fin debe ser posterior a la hora de inicio"),A.value=!1;return}const{error:w}=await N.from("citas").update({fecha_cita:h.value.fecha_cita,hora_inicio:h.value.hora_inicio+":00",hora_fin:h.value.hora_fin+":00",modalidad:h.value.modalidad,observaciones:h.value.observaciones,estado:h.value.estado,updated_at:new Date().toISOString()}).eq("id",n.citaId);if(w)throw w;T.value=!1,await Z(),L("Cambios guardados"),f("cita-actualizada"),f("actualizado")}catch(t){console.error("Error al actualizar cita:",t),F(`Error al actualizar: ${t.message}`)}finally{A.value=!1}};return K(()=>h.value.hora_inicio,t=>{if(T.value&&t){const[o,w]=t.split(":").map(Number),R=o*60+w+60,Q=Math.floor(R/60),x=R%60;h.value.hora_fin=`${String(Q).padStart(2,"0")}:${String(x).padStart(2,"0")}`}}),(t,o)=>{const w=Ia,R=Ua,Q=ca;return s(),U(Ce,{to:"body"},[S(W,{"enter-active-class":"transition-opacity duration-200","enter-from-class":"opacity-0","enter-to-class":"opacity-100","leave-active-class":"transition-opacity duration-150","leave-from-class":"opacity-100","leave-to-class":"opacity-0"},{default:J(()=>[y.citaId?(s(),i("div",{key:0,class:"fixed inset-0 bg-black/40 flex items-center justify-center z-50 p-4",onClick:ee(se,["self"]),role:"dialog","aria-modal":"true","aria-labelledby":"modal-title"},[S(W,{"enter-active-class":"transition-all duration-200","enter-from-class":"opacity-0 scale-95","enter-to-class":"opacity-100 scale-100","leave-active-class":"transition-all duration-150","leave-from-class":"opacity-100 scale-100","leave-to-class":"opacity-0 scale-95"},{default:J(()=>[e("div",{class:"bg-white rounded-xl shadow-xl w-full max-w-[600px] max-h-[90vh] overflow-hidden flex flex-col",onClick:o[10]||(o[10]=ee(()=>{},["stop"]))},[e("div",La,[e("div",Qa,[e("div",Ga,u(Oe.value),1),e("div",null,[e("h2",Ha," SesiÃ³n - "+u(g.value?.nombre_completo||"Cargando..."),1),e("span",{class:B(["text-xs font-medium px-2 py-0.5 rounded-full",Me.value])},u(ze.value),3)])]),e("button",{onClick:se,class:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors","aria-label":"Cerrar modal"},[S(r(ve),{class:"w-5 h-5"})])]),A.value?(s(),i("div",Za,[...o[12]||(o[12]=[e("div",{class:"w-8 h-8 border-2 border-gray-200 border-t-gray-600 rounded-full animate-spin"},null,-1)])])):a.value?(s(),i("div",Ka,[T.value?(s(),i("form",{key:1,onSubmit:ee(ta,["prevent"]),class:"p-5 space-y-4"},[e("div",null,[o[28]||(o[28]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Fecha",-1)),G(e("input",{"onUpdate:modelValue":o[4]||(o[4]=x=>h.value.fecha_cita=x),type:"date",required:"",class:"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-gray-400 focus:border-gray-400"},null,512),[[X,h.value.fecha_cita]])]),e("div",Qt,[e("div",null,[o[29]||(o[29]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Inicio",-1)),G(e("input",{"onUpdate:modelValue":o[5]||(o[5]=x=>h.value.hora_inicio=x),type:"time",required:"",class:"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-gray-400 focus:border-gray-400"},null,512),[[X,h.value.hora_inicio]])]),e("div",null,[o[30]||(o[30]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Fin",-1)),G(e("input",{"onUpdate:modelValue":o[6]||(o[6]=x=>h.value.hora_fin=x),type:"time",required:"",class:"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-gray-400 focus:border-gray-400"},null,512),[[X,h.value.hora_fin]])])]),e("div",Gt,[e("div",null,[o[32]||(o[32]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Modalidad",-1)),G(e("select",{"onUpdate:modelValue":o[7]||(o[7]=x=>h.value.modalidad=x),required:"",class:"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-gray-400 focus:border-gray-400"},[...o[31]||(o[31]=[e("option",{value:"presencial"},"Presencial",-1),e("option",{value:"virtual"},"Virtual",-1),e("option",{value:"telefonica"},"TelefÃ³nica",-1)])],512),[[ge,h.value.modalidad]])]),e("div",null,[o[34]||(o[34]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Estado",-1)),G(e("select",{"onUpdate:modelValue":o[8]||(o[8]=x=>h.value.estado=x),required:"",class:"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-gray-400 focus:border-gray-400"},[...o[33]||(o[33]=[e("option",{value:"pendiente"},"Pendiente",-1),e("option",{value:"confirmada"},"Confirmada",-1),e("option",{value:"realizada"},"Realizada",-1),e("option",{value:"cancelada"},"Cancelada",-1)])],512),[[ge,h.value.estado]])])]),e("div",null,[o[35]||(o[35]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Observaciones",-1)),G(e("textarea",{"onUpdate:modelValue":o[9]||(o[9]=x=>h.value.observaciones=x),rows:"3",class:"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-gray-400 focus:border-gray-400 resize-none",placeholder:"Notas adicionales..."},null,512),[[X,h.value.observaciones]])]),e("div",Ht,[e("button",{type:"button",onClick:aa,class:"flex-1 py-2.5 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200 transition-colors"}," Cancelar "),e("button",{type:"submit",disabled:A.value,class:"flex-1 py-2.5 bg-gray-900 text-white font-medium rounded-lg hover:bg-gray-800 transition-colors disabled:opacity-50"},u(A.value?"Guardando...":"Guardar"),9,Zt)])],32)):(s(),i(H,{key:0},[e("div",Ja,[ue.value?(s(),i("button",{key:0,onClick:Fe,disabled:V.value,class:"flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-blue-700 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors disabled:opacity-50"},[S(r(Y),{class:"w-4 h-4"}),j(" "+u(V.value?"Marcando...":"Marcar realizada"),1)],8,Wa)):b("",!0),e("button",{onClick:Ve,class:"flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"},[S(r(be),{class:"w-4 h-4"}),o[13]||(o[13]=j(" Editar ",-1))]),g.value?.telefono?(s(),i("button",{key:1,onClick:Ne,class:"flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"},[S(r(ua),{class:"w-4 h-4"}),o[14]||(o[14]=j(" Llamar ",-1))])):b("",!0)]),e("div",Xa,[e("div",Ya,[e("div",et,[e("div",at,[S(r(ma),{class:"w-4 h-4 text-gray-400"}),e("span",null,u(Ee.value),1)]),e("div",tt,[S(r(fa),{class:"w-4 h-4 text-gray-400"}),e("span",null,u(Ie.value),1)]),e("div",ot,[(s(),U(ne(a.value.modalidad==="virtual"?r(ya):r(ba)),{class:"w-4 h-4 text-gray-400"})),e("span",null,u($e.value),1)])]),e("span",st,u(De.value)+" min",1)])]),e("div",nt,[S(w,{"estado-pago":te.value,"metodo-pago":a.value.metodo_pago,"fecha-pago":a.value.fecha_pago,cantidad:pe.value,"show-actions":ce.value||te.value==="pagado",onRegistrar:Je,onCambiar:We,onDeshacer:o[0]||(o[0]=x=>m.value=!0)},null,8,["estado-pago","metodo-pago","fecha-pago","cantidad","show-actions"]),te.value==="pendiente"&&!ce.value&&a.value.estado==="pendiente"?(s(),i("p",rt," Confirma la cita primero para poder registrar el pago ")):b("",!0),m.value?(s(),i("div",it,[o[15]||(o[15]=e("p",{class:"text-sm text-red-800 mb-3"}," Â¿EstÃ¡s seguro de deshacer este pago? ",-1)),e("div",lt,[e("button",{type:"button",class:"flex-1 px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50",disabled:c.value,onClick:o[1]||(o[1]=x=>m.value=!1)}," Cancelar ",8,dt),e("button",{type:"button",class:"flex-1 px-3 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 disabled:opacity-50",disabled:c.value,onClick:ea},u(c.value?"Deshaciendo...":"SÃ­, deshacer"),9,ct)])])):b("",!0)]),C.value?(s(),U(R,{key:0,"cita-id":a.value.id,"paciente-nombre":g.value?.nombre_completo||"Paciente",cantidad:pe.value,"tipo-transaccion":d.value?"sesion_bono":"sesion_unica","bono-info":qe.value,"hora-inicio":a.value.hora_inicio?.substring(0,5),"metodo-pago-actual":a.value.metodo_pago,"modo-edicion":M.value,onConfirm:Xe,onCancel:Ye},null,8,["cita-id","paciente-nombre","cantidad","tipo-transaccion","bono-info","hora-inicio","metodo-pago-actual","modo-edicion"])):b("",!0),e("div",ut,[e("button",{onClick:o[2]||(o[2]=x=>q.value=!q.value),class:B(["w-full flex items-center justify-between px-4 py-3 rounded-lg transition-colors",l.value?"bg-purple-50 hover:bg-purple-100":"bg-gray-50 hover:bg-gray-100"])},[e("div",mt,[S(r(pa),{class:B(["w-4 h-4",l.value?"text-purple-500":"text-gray-400"])},null,8,["class"]),e("span",{class:B(["text-sm font-medium",l.value?"text-purple-700":"text-gray-700"])},u(l.value?"Bono del paciente":"Sin bono asignado"),3),l.value?(s(),i("span",{key:0,class:B(["text-xs px-1.5 py-0.5 rounded",d.value?"bg-purple-100 text-purple-600":"bg-gray-100 text-gray-500"])},u(d.value?"Asignado":"Disponible"),3)):b("",!0)]),e("div",ft,[l.value?(s(),i("span",pt,u(me.value)+"/"+u(l.value.sesiones_totales),1)):b("",!0),(s(),U(ne(q.value?r(xe):r(ye)),{class:"w-4 h-4 text-gray-400"}))])],2),S(W,{"enter-active-class":"transition-all duration-200","enter-from-class":"opacity-0 max-h-0","enter-to-class":"opacity-100 max-h-96","leave-active-class":"transition-all duration-150","leave-from-class":"opacity-100 max-h-96","leave-to-class":"opacity-0 max-h-0"},{default:J(()=>[q.value?(s(),i("div",gt,[l.value&&I.value?(s(),i("div",vt,[e("div",bt,[e("div",yt,[e("span",_t,u(Ae.value),1),I.value.pagado?(s(),i("span",xt,"Pagado")):(s(),i("span",ht,"Pago pendiente"))]),fe.value?(s(),i("div",{key:0,class:B(["text-xs font-medium",oe.value?"text-red-600":Te.value?"text-amber-600":"text-gray-500"])},u(oe.value?"Vencido":`Vence ${fe.value}`),3)):b("",!0)]),e("div",wt,[e("div",null,[o[16]||(o[16]=e("p",{class:"text-xs text-gray-500"},"Valor del bono",-1)),e("p",kt,u(I.value.montoTotal?.toFixed(2)||"0.00")+"â‚¬",1)]),e("div",null,[o[17]||(o[17]=e("p",{class:"text-xs text-gray-500"},"Precio por sesiÃ³n",-1)),e("p",Ct,u(I.value.precioPorSesion?.toFixed(2)||"0.00")+"â‚¬",1)])]),e("div",null,[e("div",St,[o[18]||(o[18]=e("span",{class:"font-medium"},"Sesiones del bono",-1)),e("span",Pt,u(I.value.sesionesUsadas)+" de "+u(I.value.sesionesTotales)+" usadas",1)]),e("div",Et,[(s(!0),i(H,null,ia(I.value.sesionesTotales,x=>(s(),i("div",{key:x,class:B(["flex-1 h-3 rounded transition-all",[x<=I.value.sesionesUsadas?"bg-purple-600":"bg-purple-100",x===I.value.numeroSesionActual&&!I.value.sesionDescontada?"ring-2 ring-purple-400 ring-offset-1":""]]),title:`SesiÃ³n ${x}${x<=I.value.sesionesUsadas?" (usada)":x===I.value.numeroSesionActual?" (esta cita)":" (disponible)"}`},null,10,It))),128))]),e("p",Dt,u(I.value.sesionesRestantes)+" sesiones restantes ",1)]),I.value.esAsignado?(s(),i("div",{key:0,class:B(["p-2.5 rounded-lg",a.value.sesion_descontada?"bg-green-50 border border-green-200":"bg-amber-50 border border-amber-200"])},[e("div",$t,[a.value.sesion_descontada?(s(),U(r(Y),{key:0,class:"w-4 h-4 text-green-600 flex-shrink-0 mt-0.5"})):(s(),U(r(re),{key:1,class:"w-4 h-4 text-amber-600 flex-shrink-0 mt-0.5"})),e("div",null,[e("p",{class:B(["text-xs font-medium",a.value.sesion_descontada?"text-green-800":"text-amber-800"])},[a.value.sesion_descontada?(s(),i(H,{key:0},[j(" SesiÃ³n "+u(I.value.sesionesUsadas)+"/"+u(I.value.sesionesTotales)+" del bono (ya descontada) ",1)],64)):(s(),i(H,{key:1},[j(" Esta serÃ¡ la sesiÃ³n "+u(I.value.numeroSesionActual)+"/"+u(I.value.sesionesTotales)+" del bono ",1)],64))],2),a.value.sesion_descontada?b("",!0):(s(),i("p",Mt," Se descontarÃ¡ cuando confirmes o marques como realizada "))])])],2)):b("",!0),l.value.sesiones_restantes===1&&!a.value.sesion_descontada?(s(),i("div",zt,[S(r(re),{class:"w-4 h-4 text-orange-500 flex-shrink-0"}),o[19]||(o[19]=e("span",{class:"text-xs text-orange-700 font-medium"},"Â¡Ãšltima sesiÃ³n disponible del bono!",-1))])):b("",!0),oe.value?(s(),i("div",Bt,[S(r(re),{class:"w-4 h-4 text-red-500 flex-shrink-0"}),o[20]||(o[20]=e("span",{class:"text-xs text-red-700 font-medium"},"Este bono ha vencido",-1))])):b("",!0),e("div",jt,[je.value?(s(),i("button",{key:0,onClick:Le,disabled:p.value,class:"flex-1 flex items-center justify-center gap-1.5 px-3 py-2 text-sm font-medium text-purple-700 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors disabled:opacity-50"},[S(r(_e),{class:"w-4 h-4"}),j(" "+u(p.value?"Asignando...":"Asignar a esta cita"),1)],8,Tt)):b("",!0),Be.value?(s(),i("button",{key:1,onClick:Ue,disabled:_.value,class:"flex-1 flex items-center justify-center gap-1.5 px-3 py-2 text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors disabled:opacity-50"},[S(r(Y),{class:"w-4 h-4"}),j(" "+u(_.value?"Consumiendo...":"Consumir sesiÃ³n"),1)],8,At)):b("",!0),e("button",{onClick:Ge,class:"flex items-center gap-1.5 px-3 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors"},[S(r(be),{class:"w-4 h-4"}),o[21]||(o[21]=e("span",{class:"hidden sm:inline"},"Editar",-1))]),e("button",{onClick:Ke,class:"flex items-center gap-1.5 px-3 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors"},[S(r(va),{class:"w-4 h-4"}),o[22]||(o[22]=e("span",{class:"hidden sm:inline"},"Ver mÃ¡s",-1))])])])):(s(),i("div",Ot,[o[24]||(o[24]=e("p",{class:"text-sm text-gray-500 mb-3"},"Este paciente no tiene bono activo",-1)),e("button",{onClick:Qe,class:"inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium text-purple-600 hover:text-purple-700 hover:bg-purple-50 rounded-lg transition-colors"},[S(r(_e),{class:"w-4 h-4"}),o[23]||(o[23]=j(" Crear bono ",-1))])]))])):b("",!0)]),_:1})]),a.value.observaciones?(s(),i("div",qt,[e("button",{onClick:o[3]||(o[3]=x=>$.value=!$.value),class:"w-full flex items-center justify-between px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors"},[o[25]||(o[25]=e("span",{class:"text-sm font-medium text-gray-700"},"Observaciones",-1)),(s(),U(ne($.value?r(xe):r(ye)),{class:"w-4 h-4 text-gray-400"}))]),S(W,{"enter-active-class":"transition-all duration-200","enter-from-class":"opacity-0 max-h-0","enter-to-class":"opacity-100 max-h-60","leave-active-class":"transition-all duration-150","leave-from-class":"opacity-100 max-h-60","leave-to-class":"opacity-0 max-h-0"},{default:J(()=>[$.value?(s(),i("div",Nt,[e("p",Vt,u(a.value.observaciones),1)])):b("",!0)]),_:1})])):b("",!0),e("div",Rt,[e("span",null,"ID: "+u(a.value.id.substring(0,8))+"...",1),o[26]||(o[26]=e("div",{class:"flex items-center gap-3"},[e("button",{class:"hover:text-gray-600 transition-colors"},"Ver historial"),e("span",null,"|"),e("button",{class:"hover:text-red-500 transition-colors"},"Cancelar cita")],-1))]),de.value?(s(),i("div",Ft,[e("button",{onClick:Re,disabled:P.value,class:"w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-medium rounded-lg transition-colors disabled:opacity-50 flex items-center justify-center gap-2"},[P.value?(s(),i("svg",Lt,[...o[27]||(o[27]=[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"},null,-1)])])):(s(),U(r(Y),{key:1,class:"w-5 h-5"})),j(" "+u(P.value?"Confirmando...":"Confirmar cita"),1)],8,Ut)])):b("",!0)],64))])):(s(),i("div",Kt,[e("div",null,[e("div",Jt,[S(r(ve),{class:"w-6 h-6 text-gray-400"})]),o[36]||(o[36]=e("p",{class:"text-gray-600 font-medium"},"No se encontraron datos",-1)),e("p",Wt,"ID: "+u(y.citaId?.substring(0,8))+"...",1)])]))])]),_:1})])):b("",!0)]),_:1}),g.value?(s(),U(Q,{key:0,mostrar:E.value,"paciente-id":g.value.id,"paciente-nombre":g.value.nombre_completo||"Paciente","bono-existente":D.value,onClose:o[11]||(o[11]=x=>{E.value=!1,D.value=null}),onCreated:He,onUpdated:Ze},null,8,["mostrar","paciente-id","paciente-nombre","bono-existente"])):b("",!0)])}}}),go=Object.assign(ga(Xt,[["__scopeId","data-v-447e13a3"]]),{__name:"ModalDetallesCita"});export{go as M,le as u};
