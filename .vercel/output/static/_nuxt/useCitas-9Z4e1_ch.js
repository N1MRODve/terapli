import{p as J}from"#entry";const X=()=>{const n=J(),S=async()=>{try{const{data:a,error:e}=await n.from("terapeutas").select("*").eq("activo",!0).order("nombre_completo",{ascending:!0});return e?(console.error("‚ùå Error al obtener terapeutas:",e),[]):a||[]}catch(a){return console.error("‚ùå Error al obtener terapeutas:",a),[]}},q=async a=>{try{const{data:e,error:r}=await n.from("terapeutas").select("*").eq("id",a).single();return r?(console.error("‚ùå Error al obtener terapeuta:",r),null):e}catch(e){return console.error("‚ùå Error al obtener terapeuta:",e),null}},d=async()=>{try{const{data:{user:a}}=await n.auth.getUser();if(!a)return null;const{data:e,error:r}=await n.from("terapeutas").select("*").eq("email",a.email).eq("activo",!0).single();return r?(console.log("‚ÑπÔ∏è Usuario no es terapeuta o no encontrado"),null):e}catch(a){return console.error("‚ùå Error al obtener terapeuta actual:",a),null}},P=async a=>{try{let e=a;if(!e){const o=await d();if(!o)return console.warn("‚ö†Ô∏è No se pudo identificar el terapeuta actual"),[];e=o.id}const{data:r,error:t}=await n.from("vista_agenda_terapeutas").select("*").eq("terapeuta_id",e).order("fecha_cita",{ascending:!0}).order("hora_inicio",{ascending:!0});return t?(console.error("‚ùå Error al obtener citas desde vista:",t),[]):r||[]}catch(e){return console.error("‚ùå Error al obtener citas:",e),[]}},R=async(a,e)=>{try{let r=e;if(!r){const c=await d();if(!c)return[];r=c.id}const{data:t,error:o}=await n.from("vista_agenda_terapeutas").select("*").eq("terapeuta_id",r).eq("fecha_cita",a).order("hora_inicio",{ascending:!0});return o?(console.error("‚ùå Error al obtener citas por d√≠a:",o),[]):t||[]}catch(r){return console.error("‚ùå Error al obtener citas por d√≠a:",r),[]}},m=async(a,e,r)=>{try{let t=r;if(!t){const s=await d();if(!s)return[];t=s.id}const{data:o,error:c}=await n.from("vista_agenda_terapeutas").select("*").eq("terapeuta_id",t).gte("fecha_cita",a).lte("fecha_cita",e).order("fecha_cita",{ascending:!0}).order("hora_inicio",{ascending:!0});return c?(console.error("‚ùå Error al obtener citas por rango:",c),[]):(o||[]).map(s=>({...s,fecha:s.fecha_cita}))}catch(t){return console.error("‚ùå Error al obtener citas por rango:",t),[]}},x=async a=>{try{const{data:e,error:r}=await n.from("citas").select(`
          *,
          terapeutas!inner (
            id,
            nombre_completo
          ),
          bonos (
            id,
            sesiones_restantes
          )
        `).eq("paciente_id",a).order("fecha_cita",{ascending:!1});return r?(console.error("‚ùå Error al obtener citas del paciente:",r),[]):e||[]}catch(e){return console.error("‚ùå Error al obtener citas del paciente:",e),[]}},N=async a=>{try{let e=a.terapeuta_id;if(!e){const s=await d();if(!s)return{success:!1,error:"No se pudo identificar el terapeuta. Por favor, vuelve a iniciar sesi√≥n."};e=s.id}let r=a.bono_id,t=a.descontar_de_bono||!1;if(!r&&t){const s=await E(a.paciente_id);s?(r=s,console.log("‚úÖ Bono activo encontrado autom√°ticamente:",s)):(console.log("‚ö†Ô∏è No se encontr√≥ bono activo, creando cita sin bono"),t=!1)}a.bono_id&&(r=a.bono_id,t=!0),console.log("üìã [Crear Cita] Par√°metros:",{paciente_id:a.paciente_id,paciente_nombre:a.paciente_nombre,terapeuta_id:e,fecha_cita:a.fecha,modalidad:a.modalidad,estado:a.estado,bono_id:r,descontar_de_bono:t});const o={paciente_id:a.paciente_id,terapeuta_id:e,fecha_cita:a.fecha,hora_inicio:a.hora_inicio,hora_fin:a.hora_fin,modalidad:a.modalidad||"online",estado:a.estado||"pendiente",observaciones:a.notas||null,descontar_de_bono:t,bono_id:r||null,sesion_descontada:!1,recordatorio_enviado:!1,ubicacion:a.ubicacion||null,enlace_videollamada:a.enlace_videollamada||null},{data:c,error:i}=await n.from("citas").insert(o).select().single();if(i)return console.error("‚ùå Error al crear cita:",i),console.error("‚ùå Error code:",i.code),console.error("‚ùå Error details:",i.details),console.error("‚ùå Error hint:",i.hint),i.message.includes("disponibilidad")?{success:!1,error:"El terapeuta ya tiene una cita en ese horario. Por favor, selecciona otro."}:i.message.includes("bono")?{success:!1,error:"El bono no tiene sesiones disponibles o no est√° activo."}:i.message.includes("users")||i.code==="42501"?{success:!1,error:"Error de permisos. Por favor, contacta al administrador."}:i.code==="23503"?{success:!1,error:"Paciente o terapeuta no encontrado. Verifica los datos."}:{success:!1,error:i.message||"Error al crear la cita"};if(console.log("‚úÖ Cita creada exitosamente:",c.id),typeof window<"u"){const s=new CustomEvent("citas:actualizadas",{detail:{tipo:"INSERT",cita:c,paciente_nombre:a.paciente_nombre}});window.dispatchEvent(s),console.log('üì° Evento "citas:actualizadas" emitido')}return{success:!0,data:c,message:r?"Cita creada exitosamente y vinculada al bono activo":"Cita creada exitosamente"}}catch(e){return console.error("‚ùå Error al crear cita:",e),{success:!1,error:e.message||"Error desconocido al crear la cita"}}},B=async(a,e)=>{try{const{data:r,error:t}=await n.from("citas").update({estado:e}).eq("id",a).select().single();return t?(console.error("‚ùå Error al actualizar estado de cita:",t),{success:!1,error:t.message}):(console.log(`‚úÖ Estado de cita actualizado a: ${e}`),e==="realizada"?{success:!0,data:r,message:"Cita completada. Sesi√≥n descontada del bono autom√°ticamente (si aplicaba)."}:{success:!0,data:r})}catch(r){return console.error("‚ùå Error al actualizar estado:",r),{success:!1,error:r.message}}},z=async(a,e)=>{try{const{data:r,error:t}=await n.from("citas").update(e).eq("id",a).select().single();return t?(console.error("‚ùå Error al actualizar cita:",t),t.message.includes("disponibilidad")?{success:!1,error:"Conflicto de horario con otra cita"}:{success:!1,error:t.message}):(console.log("‚úÖ Cita actualizada exitosamente"),{success:!0,data:r})}catch(r){return console.error("‚ùå Error al actualizar cita:",r),{success:!1,error:r.message}}},h=async(a,e)=>{try{const r={estado:"cancelada"};e&&(r.observaciones=e);const{data:t,error:o}=await n.from("citas").update(r).eq("id",a).select().single();return o?(console.error("‚ùå Error al cancelar cita:",o),{success:!1,error:o.message}):(console.log("‚úÖ Cita cancelada exitosamente"),{success:!0,data:t,message:"Cita cancelada"})}catch(r){return console.error("‚ùå Error al cancelar cita:",r),{success:!1,error:r.message}}},A=async(a,e,r=!1)=>{try{if(!e)return await h(a);const{data:t,error:o}=await n.rpc("fn_reintegrar_sesion_bono",{p_cita_id:a,p_bono_id:e,p_reintegrar:r});return o?(console.error("‚ùå Error al cancelar cita con reintegro:",o),{success:!1,error:o.message}):!t||!t.success?{success:!1,error:t?.error||"Error al cancelar cita"}:(console.log("‚úÖ Cita cancelada:",t),{success:!0,data:t,message:t.message})}catch(t){return console.error("‚ùå Error al cancelar cita con reintegro:",t),{success:!1,error:t.message}}},U=async a=>{try{const{error:e}=await n.from("citas").delete().eq("id",a);return e?(console.error("‚ùå Error al eliminar cita:",e),{success:!1,error:e.message}):(console.log("‚úÖ Cita eliminada exitosamente"),{success:!0,message:"Cita eliminada permanentemente"})}catch(e){return console.error("‚ùå Error al eliminar cita:",e),{success:!1,error:e.message}}},E=async a=>{try{const{data:e,error:r}=await n.from("bonos").select("id").eq("paciente_id",a).eq("estado","activo").gt("sesiones_restantes",0).order("created_at",{ascending:!1}).limit(1).maybeSingle();return r?(console.log("‚ÑπÔ∏è No hay bono activo para el paciente"),null):e?.id||null}catch(e){return console.error("‚ùå Error al obtener bono activo:",e),null}},w=async a=>{try{const{data:e,error:r}=await n.from("bonos").select("*").eq("paciente_id",a).eq("estado","activo").gt("sesiones_restantes",0).order("created_at",{ascending:!1}).limit(1).maybeSingle();return r?(console.log("‚ÑπÔ∏è No hay bono activo para el paciente"),null):e}catch(e){return console.error("‚ùå Error al obtener bono activo:",e),null}},H=async a=>{const e=await w(a);if(!e)return{tiene_bono:!1,sesiones_restantes:0,sesiones_totales:0,tipo_bono:"",bono_id:void 0};try{const{data:r}=await n.from("pacientes").select("metadata, area_de_acompanamiento, frecuencia").eq("id",a).single(),t=e.tipo_bono||r?.frecuencia||r?.metadata?.frecuencia||"mensual";return{tiene_bono:!0,sesiones_restantes:e.sesiones_restantes||0,sesiones_totales:e.sesiones_totales||0,tipo_bono:t,bono_id:e.id}}catch(r){return console.error("‚ùå Error al verificar bono:",r),{tiene_bono:!1,sesiones_restantes:0,sesiones_totales:0,tipo_bono:"",bono_id:void 0}}},L=async a=>{try{const{data:e,error:r}=await n.rpc("obtener_estadisticas_bono",{p_bono_id:a}).single();return r?(console.error("‚ùå Error al obtener estad√≠sticas del bono:",r),null):e}catch(e){return console.error("‚ùå Error al obtener estad√≠sticas del bono:",e),null}},F=async a=>{try{const{data:e,error:r}=await n.from("bonos").select("*").eq("paciente_id",a).order("created_at",{ascending:!1});return r?(console.error("‚ùå Error al obtener bonos del paciente:",r),[]):e||[]}catch(e){return console.error("‚ùå Error al obtener bonos:",e),[]}},I=async(a,e,r,t)=>{try{const{data:o,error:c}=await n.rpc("verificar_disponibilidad_terapeuta",{p_terapeuta_id:a,p_fecha:e,p_hora_inicio:r,p_hora_fin:t});return c?(console.error("‚ùå Error al verificar disponibilidad:",c),!1):o===!0}catch(o){return console.error("‚ùå Error al verificar disponibilidad:",o),!1}},y=async(a,e=14,r=60)=>{try{const t=[],o=new Date,c=["09:00","10:00","11:00","12:00","14:00","15:00","16:00","17:00","18:00"],i=b(o),s=new Date(o);s.setDate(s.getDate()+e);const D=await m(i,b(s),a);for(let f=0;f<e;f++){const u=new Date(o);u.setDate(u.getDate()+f);const l=b(u),T=u.getDay();if(!(T===0||T===6))for(const g of c){const V=C(g,r);D.some(_=>_.fecha_cita===l&&O(g,V,_.hora_inicio,_.hora_fin)&&_.estado!=="cancelada")||t.push({fecha:l,hora:g,disponible:!0,terapeuta_id:a})}}return t.slice(0,30)}catch(t){return console.error("‚ùå Error al buscar disponibilidad:",t),[]}},M=async(a,e,r)=>{try{let t=r;if(!t){const l=await d();if(!l)return null;t=l.id}const o=await v(a,e);if(!o)return null;let i=(await p(a))?.hora_inicio||"10:00";if(!t)return null;const s=await y(t,30,60);if(s.find(l=>l.fecha===o&&l.hora===i))return{fecha:o,hora:i};const f=s.find(l=>l.fecha===o);if(f)return{fecha:o,hora:f.hora};const u=s[0];return u?{fecha:u.fecha,hora:u.hora}:null}catch(t){return console.error("‚ùå Error al sugerir pr√≥ximo horario:",t),null}},$=async(a,e=10)=>{try{const{data:r,error:t}=await n.rpc("obtener_proximas_citas_paciente",{p_paciente_id:a,p_limite:e});return t?(console.error("‚ùå Error al obtener pr√≥ximas citas:",t),[]):r||[]}catch(r){return console.error("‚ùå Error al obtener pr√≥ximas citas:",r),[]}},p=async a=>{try{const{data:e,error:r}=await n.from("citas").select("*").eq("paciente_id",a).in("estado",["realizada","confirmada"]).order("fecha_cita",{ascending:!1}).order("hora_inicio",{ascending:!1}).limit(1).maybeSingle();return r?(console.error("‚ùå Error al obtener √∫ltima cita:",r),null):e}catch(e){return console.error("‚ùå Error al obtener √∫ltima cita:",e),null}},v=async(a,e)=>{try{const r=await p(a);let t=7;switch(e?.toLowerCase()){case"semanal":t=7;break;case"quincenal":t=14;break;case"mensual":t=30;break;default:t=7}let o;for(r&&r.fecha_cita?(o=new Date(r.fecha_cita+"T00:00:00"),o.setDate(o.getDate()+t)):(o=new Date,o.setDate(o.getDate()+1));o.getDay()===0||o.getDay()===6;)o.setDate(o.getDate()+1);return b(o)}catch(r){return console.error("‚ùå Error al calcular pr√≥xima fecha:",r),null}};function b(a){return a.toISOString().split("T")[0]||""}function C(a,e){const[r=0,t=0]=a.split(":").map(Number),o=new Date;o.setHours(r,t,0,0),o.setMinutes(o.getMinutes()+e);const c=String(o.getHours()).padStart(2,"0"),i=String(o.getMinutes()).padStart(2,"0");return`${c}:${i}`}function O(a,e,r,t){return a<t&&r<e}function G(a){const e=["Domingo","Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado"],r=new Date(a+"T00:00:00");return e[r.getDay()]||"Desconocido"}return{getTerapeutas:S,getTerapeuta:q,getTerapeutaActual:d,getCitas:P,getCitasPorDia:R,getCitasRango:m,getCitasPaciente:x,getProximasCitasPaciente:$,getUltimaCitaPaciente:p,crearCita:N,actualizarEstadoCita:B,actualizarCita:z,cancelarCita:h,cancelarCitaConReintegro:A,eliminarCita:U,obtenerBonoActivoId:E,obtenerBonoActivo:w,verificarBonoActivo:H,obtenerEstadisticasBono:L,getBonosPaciente:F,verificarDisponibilidadTerapeuta:I,buscarDisponibilidad:y,calcularProximaFechaSugerida:v,sugerirProximoHorario:M,listenRealtimeCitas:(a,e)=>n.channel(`citas:terapeuta:${a}`).on("postgres_changes",{event:"*",schema:"public",table:"citas",filter:`terapeuta_id=eq.${a}`},t=>{console.log("üì° Cambio en citas detectado:",t.eventType,t.new||t.old),t.eventType==="INSERT"?e("INSERT",t.new):t.eventType==="UPDATE"?e("UPDATE",t.new):t.eventType==="DELETE"&&e("DELETE",t.old)}).subscribe(t=>{t==="SUBSCRIBED"?console.log("‚úÖ Suscrito a cambios de citas en tiempo real"):t==="CHANNEL_ERROR"&&console.error("‚ùå Error al suscribirse a cambios de citas")}),listenRealtimeCitasGlobal:a=>n.channel("citas:global").on("postgres_changes",{event:"*",schema:"public",table:"citas"},r=>{console.log("üì° Cambio global en citas detectado:",r.eventType),r.eventType==="INSERT"?a("INSERT",r.new):r.eventType==="UPDATE"?a("UPDATE",r.new):r.eventType==="DELETE"&&a("DELETE",r.old)}).subscribe(r=>{r==="SUBSCRIBED"?console.log("‚úÖ Suscrito a cambios globales de citas en tiempo real"):r==="CHANNEL_ERROR"&&console.error("‚ùå Error al suscribirse a cambios globales de citas")}),formatearFecha:b,calcularHoraFin:C,obtenerNombreDia:G}};export{X as u};
