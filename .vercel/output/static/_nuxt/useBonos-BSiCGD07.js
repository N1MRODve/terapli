import{q as P,z as p,ag as z,y as T,g as U}from"#entry";const j=()=>{const{userProfile:a,getUserRole:d}=P(),m=c=>a.value?.rol===c,f=c=>c.some(l=>a.value?.rol===l),b=p(()=>a.value?.rol==="psicologa"),E=p(()=>a.value?.rol==="paciente"),_=p(()=>a.value?.rol==="coordinadora"),v=c=>c?{admin:"Administrador",psicologa:"Psicóloga",paciente:"Paciente",coordinadora:"Coordinadora"}[c]:"Desconocido",w=c=>{const l=c||a.value?.rol,h={admin:"/admin/dashboard",psicologa:"/terapeuta/dashboard",coordinadora:"/coordinadora/dashboard",paciente:"/paciente/dashboard"};return l&&l in h?h[l]:"/login"},y=async()=>{const c=w();await T(c)};return{userProfile:z(a),isPsicologa:b,isPaciente:E,isCoordinadora:_,hasRole:m,hasAnyRole:f,getUserRole:d,getRoleName:v,getDashboardPath:w,goToDashboard:y}},O=()=>{const a=U(),{userProfile:d}=P(),{isCoordinadora:m}=j(),f=async r=>{try{const{data:o,error:e}=await a.from("bonos").select("*").eq("paciente_id",r).order("created_at",{ascending:!1});return e?(console.warn("[Bonos] Error en consulta getBonosPorPaciente:",e.message),[]):o||[]}catch(o){return console.warn("[Bonos] Error inesperado en getBonosPorPaciente:",o),[]}},b=async r=>{try{const{data:o,error:e}=await a.from("bonos").select("*").eq("id",r).single();if(e)return console.warn("[Bonos] Error al obtener bono:",e.message),null;const{data:n,error:s}=await a.from("pagos_bonos").select("*").eq("bono_id",r).order("fecha_pago",{ascending:!1});return s&&console.warn("[Bonos] Error al obtener pagos:",s.message),{bono:o,pagos:n||[]}}catch(o){return console.warn("[Bonos] Error inesperado en getBonoConPagos:",o),null}},E=async r=>{try{const{data:o,error:e}=await a.from("bonos").select("*").eq("paciente_id",r).eq("estado","activo").order("created_at",{ascending:!1});return e?(console.warn("[Bonos] Error en getBonosActivos:",e.message),[]):o||[]}catch(o){return console.warn("[Bonos] Error inesperado en getBonosActivos:",o),[]}},_=async r=>{try{const{data:o,error:e}=await a.from("bonos").insert(r).select().single();if(e)throw console.error("[Bonos] Error al crear bono:",e.message),new Error(`Error al crear bono: ${e.message}`);return o}catch(o){throw console.error("[Bonos] Error inesperado al crear bono:",o),new Error(o.message||"Error al crear el bono")}},v=async(r,o)=>{try{const{data:e,error:n}=await a.from("bonos").update({...o,updated_at:new Date().toISOString()}).eq("id",r).select().single();if(n)throw console.error("[Bonos] Error al actualizar bono:",n.message),new Error(`Error al actualizar bono: ${n.message}`);return e}catch(e){throw console.error("[Bonos] Error inesperado al actualizar bono:",e),new Error(e.message||"Error al actualizar el bono")}},w=async(r,o,e,n=!1)=>{try{const s={bono_id:r,monto:o,metodo_pago:e,confirmado:n,fecha_pago:new Date().toISOString().split("T")[0],...n&&{confirmado_por:d.value?.id,fecha_confirmacion:new Date().toISOString()}},{data:g,error:i}=await a.from("pagos_bonos").insert(s).select().single();if(i)throw console.error("[Bonos] Error al registrar pago:",i.message),new Error(`Error al registrar pago: ${i.message}`);return g}catch(s){throw console.error("[Bonos] Error inesperado al registrar pago:",s),new Error(s.message||"Error al registrar el pago")}},y=async r=>{try{const{data:o,error:e}=await a.rpc("fn_confirmar_pago_bono",{p_pago_id:r});if(e)throw console.error("[Bonos] Error al confirmar pago:",e.message),new Error(`Error al confirmar pago: ${e.message}`);const n=o;if(!n.success)throw new Error(n.mensaje||"Error al confirmar el pago");return n}catch(o){throw console.error("[Bonos] Error inesperado al confirmar pago:",o),new Error(o.message||"Error al confirmar el pago")}},c=async(r,o,e,n)=>{try{const s=d.value?.id;if(!s)throw new Error("Usuario no autenticado");const{data:g,error:i}=await a.rpc("fn_renovar_bono_manual",{p_bono_id:r,p_usuario_id:s,p_motivo:o||null,p_modificar_sesiones:e||null,p_modificar_monto:n||null});if(i)throw console.error("[Bonos] Error al renovar bono:",i.message),new Error(`Error al renovar bono: ${i.message}`);const u=g;if(!u.success)throw new Error(u.mensaje||"Error al renovar el bono");return u}catch(s){throw console.error("[Bonos] Error inesperado al renovar bono:",s),new Error(s.message||"Error al renovar el bono")}},l=async r=>{try{const{data:o,error:e}=await a.from("renovaciones_bonos").select("*").or(`bono_original_id.eq.${r},nuevo_bono_id.eq.${r}`).order("fecha_renovacion",{ascending:!1});return e?(console.warn("[Bonos] Error al obtener renovaciones:",e.message),[]):o||[]}catch(o){return console.warn("[Bonos] Error inesperado al obtener renovaciones:",o),[]}},h=async r=>{try{const{data:o,error:e}=await a.from("pagos_bonos").select("*").eq("bono_id",r).order("fecha_pago",{ascending:!1});return e?(console.warn("[Bonos] Error al obtener pagos:",e.message),[]):o||[]}catch(o){return console.warn("[Bonos] Error inesperado al obtener pagos:",o),[]}},x=async r=>{try{const o=await f(r),e=o.filter(t=>t.estado==="activo").length,n=o.filter(t=>t.estado==="completado").length,s=o.filter(t=>t.estado==="vencido").length,g=o.filter(t=>t.estado==="pendiente").length,i=new Date,u=o.filter(t=>{if(t.estado!=="activo"||!t.fecha_fin)return!1;const $=new Date(t.fecha_fin),B=Math.ceil(($.getTime()-i.getTime())/(1e3*60*60*24));return B>=0&&B<=7}).length,R=o.filter(t=>t.estado==="activo"&&t.sesiones_restantes!==null&&t.sesiones_restantes<=2).length;return{total:o.length,activos:e,completados:n,vencidos:s,pendientes:g,proximosAVencer:u,pocasSesiones:R}}catch(o){return console.warn("[Bonos] Error al calcular métricas:",o),{total:0,activos:0,completados:0,vencidos:0,pendientes:0,proximosAVencer:0,pocasSesiones:0}}},q=r=>{if(!r.sesiones_totales||r.sesiones_totales===0)return 0;const o=r.sesiones_totales-(r.sesiones_restantes||0);return Math.round(o/r.sesiones_totales*100)},C=r=>({pendiente:"bg-yellow-100 text-yellow-700 border-yellow-300",activo:"bg-green-100 text-green-700 border-green-300",completado:"bg-gray-100 text-gray-600 border-gray-300",vencido:"bg-red-100 text-red-600 border-red-300",cancelado:"bg-gray-200 text-gray-500 border-gray-400 line-through"})[r]||"bg-gray-100 text-gray-600",S=r=>({pendiente:"Pendiente de activación",activo:"Activo",completado:"Completado",vencido:"Vencido",cancelado:"Cancelado"})[r]||r,D=p(()=>m.value||d.value?.rol==="psicologa"),A=p(()=>m.value);return{getBonosPorPaciente:f,getBonoConPagos:b,getBonosActivos:E,getPagosPorBono:h,getRenovaciones:l,calcularMetricas:x,crearBono:_,actualizarBono:v,registrarPago:w,confirmarPago:y,renovarBono:c,calcularPorcentajeUso:q,getEstadoColor:C,getEstadoTexto:S,puedeGestionarBonos:D,puedeConfirmarPagos:A}};export{j as a,O as u};
