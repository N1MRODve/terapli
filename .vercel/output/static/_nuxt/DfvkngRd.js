import{u as A}from"./BbZO5sJf.js";import{K as T,aa as g,C as z,q as _,ab as m}from"#entry";let u=!1;const D=()=>{const l=A(),t=T(),i=g("supabase-session",()=>null),r=g("user-profile",()=>null),f=async()=>{{const{data:e}=await l.auth.getSession();i.value=e.session,e.session?.user&&await c()}},S=()=>{l.auth.onAuthStateChange(async(e,a)=>{if(console.log("ðŸ” [Auth State Change]",e,{hasSession:!!a,userId:a?.user?.id,email:a?.user?.email}),i.value=a,e==="SIGNED_OUT"){console.warn("âš ï¸ [Auth] SesiÃ³n cerrada, limpiando perfil"),r.value=null,u=!1;return}a?.user&&!r.value?(console.log("âœ… [Auth] Usuario autenticado sin perfil, cargando..."),await c()):a?.user&&r.value&&console.log("âœ… [Auth] Usuario autenticado, perfil ya cargado")})},c=async()=>{if(r.value)return r.value;if(u){let e=0;for(;u&&e<50;)await new Promise(a=>setTimeout(a,100)),e++;if(r.value)return r.value}u=!0;try{let e=0;for(;!t.value&&e<10;)await new Promise(n=>setTimeout(n,100)),e++;const a=t.value?.id||t.value?.sub;if(!a)return console.warn("[useSupabase] No hay usuario autenticado o ID invÃ¡lido despuÃ©s de esperar"),console.warn("[useSupabase] user.value:",t.value),r.value=null,null;console.log("[useSupabase] Cargando perfil para usuario:",a);const{data:o,error:s}=await l.from("profiles").select("*").eq("id",a).single();return s?(console.error("[useSupabase] Error al cargar perfil:",s),console.error("[useSupabase] Error code:",s.code),console.error("[useSupabase] Error message:",s.message),console.error("[useSupabase] Error details:",s.details),console.error("[useSupabase] User ID:",a),r.value=null,null):o?(r.value=o,console.log("[useSupabase] âœ… Perfil cargado correctamente:",o.email,"Rol:",o.rol),o.rol==="psicologa"&&await w(o),o):(console.warn("[useSupabase] No se encontrÃ³ perfil para el usuario:",a),console.warn("[useSupabase] El usuario existe en auth pero no tiene perfil en la tabla profiles"),r.value=null,null)}catch(e){return console.error("[useSupabase] Error en loadUserProfile:",e),r.value=null,null}finally{u=!1}},w=async e=>{try{if(console.log("[Sync] Verificando sincronizaciÃ³n con tabla terapeutas..."),!e.email){console.warn("[Sync] No se puede sincronizar: email faltante");return}const a=l,{data:o,error:s}=await a.from("terapeutas").select("*").eq("email",e.email).maybeSingle();if(s&&s.code!=="PGRST116"){console.warn("[Sync] Error al buscar terapeuta:",s);return}const n={id:e.id,nombre_completo:e.nombre||e.email.split("@")[0]||"PsicÃ³loga",email:e.email,telefono:null,especialidad:null,num_colegiada:null,disponibilidad:null,activo:!0,metadata:{sincronizado_desde_profile:!0,ultima_sincronizacion:new Date().toISOString()}};if(o)if(o.nombre_completo!==n.nombre_completo||o.email!==n.email||!o.activo){console.log("[Sync] Actualizando registro existente en tabla terapeutas...");const{error:d}=await a.from("terapeutas").update({nombre_completo:n.nombre_completo,email:n.email,activo:!0,metadata:n.metadata}).eq("id",e.id);d?console.warn("[Sync] No se pudo actualizar el terapeuta:",d):console.log("[Sync] âœ… Terapeuta actualizado correctamente")}else console.log("[Sync] âœ… Terapeuta ya estÃ¡ sincronizado correctamente");else{console.log("[Sync] Creando nuevo registro en tabla terapeutas...");const{error:p}=await a.from("terapeutas").insert(n);if(p)if(p.code==="23505"){console.log("[Sync] El terapeuta ya existe por ID, actualizando...");const{error:d}=await a.from("terapeutas").update({nombre_completo:n.nombre_completo,email:n.email,activo:!0,metadata:n.metadata}).eq("id",e.id);d?console.warn("[Sync] No se pudo actualizar el terapeuta:",d):console.log("[Sync] âœ… Terapeuta actualizado correctamente")}else console.warn("[Sync] No se pudo insertar el terapeuta:",p);else console.log("[Sync] âœ… Terapeuta creado correctamente en la tabla terapeutas")}}catch(a){console.warn("[Sync] Error al sincronizar terapeuta:",a)}},b=async()=>t.value?.id||t.value?.sub?r.value?r.value.rol:(await c())?.rol||null:(console.warn("[useSupabase] getUserRole: No hay usuario autenticado"),null),h=async(e,a)=>{console.log("ðŸ§¹ [Auth] Limpiando estado antes del login..."),r.value=null,i.value=null,u=!1;const{data:o,error:s}=await l.auth.signInWithPassword({email:e,password:a});return!s&&o.session&&(console.log("âœ… [Auth] Login exitoso, estableciendo nueva sesiÃ³n"),i.value=o.session),{data:o,error:s}},v=async(e,a,o)=>{const{data:s,error:n}=await l.auth.signUp({email:e,password:a,options:{data:o}});return{data:s,error:n}},y=async()=>{console.log("ðŸšª [Auth] Iniciando cierre de sesiÃ³n...");const{error:e}=await l.auth.signOut();if(e)console.error("âŒ [Auth] Error al cerrar sesiÃ³n:",e);else{console.log("âœ… [Auth] SesiÃ³n cerrada en Supabase, limpiando estado local..."),i.value=null,r.value=null,u=!1;try{await $fetch("/api/clear-state",{method:"POST"}).catch(()=>{}),localStorage.clear(),sessionStorage.clear(),setTimeout(()=>{window.location.href="/login"},100)}catch(a){console.warn("[Auth] Error limpiando storage:",a)}console.log("ðŸ§¹ [Auth] Estado completamente limpiado")}return{error:e}},E=async e=>{const{data:a,error:o}=await l.auth.resetPasswordForEmail(e,{redirectTo:`${window.location.origin}/reset-password`});return{data:a,error:o}},I=async e=>{const{data:a,error:o}=await l.auth.updateUser({password:e});return{data:a,error:o}},P=async(e=20)=>{let a=0;for(;!t.value&&a<e;)await new Promise(o=>setTimeout(o,100)),a++;return t.value},U=()=>t.value?.id||t.value?.sub||null;return f(),S(),z(r,(e,a)=>{a&&!e?(console.warn("âš ï¸ [useSupabase] PERFIL SE PERDIÃ“ - Intentando recargar..."),t.value&&c()):e&&!a&&console.log("âœ… [useSupabase] Perfil cargado:",e.email,"Rol:",e.rol)}),{supabase:l,user:m(t),session:m(i),userProfile:m(r),signInWithEmail:h,signUpWithEmail:v,signOut:y,resetPassword:E,updatePassword:I,loadUserProfile:c,getUserRole:b,waitForUser:P,getUserId:U,isAuthenticated:_(()=>!!t.value)}};export{D as u};
