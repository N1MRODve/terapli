import{q as m,c as f,o as v,a as e,g as P,i as X,x as he,k as n,t as c,y as Y,b as M,K as Pe,r as q,C as re,j as S,d as h,v as H,z as de,h as me,F as ye,s as we,V as ce,J as Te,f as Ve,l as ze}from"#entry";import{_ as be}from"./DlAUqK2U.js";import{r as Ce}from"./mZ3toP8Y.js";import{r as je}from"./CQZt9cKZ.js";import{r as Ue}from"./Bi0YyG7H.js";import{r as Le}from"./DRclOuRO.js";import{r as Ne}from"./Dge-tWFD.js";import{r as Oe}from"./Cii-u9ml.js";import{r as Re}from"./BreoAuwB.js";import{r as Se}from"./Dyh9f5zH.js";import{r as He}from"./D9Txc_Yy.js";import{_ as Qe}from"./azqyQWQn.js";import{u as fe}from"./DfvkngRd.js";import{u as Fe}from"./BgL7wf3O.js";import{u as Ge}from"./C9Vbupfc.js";import{_ as Je}from"./DKtLWc1O.js";import{u as Ke}from"./BbZO5sJf.js";import{r as Xe}from"./B5My0XuL.js";import{r as Ye}from"./Byc3y-S3.js";import{r as Ee}from"./C0vq0F4x.js";import"./G1mM6o1b.js";import"./BaRJRhc1.js";const We={class:"bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-lg hover:border-gray-200 transition-all duration-300 group relative cursor-pointer"},Ze={class:"absolute top-4 right-4 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-all duration-200 z-10"},eo={class:"flex items-start justify-between mb-5"},oo={class:"flex items-center gap-3"},to={class:"font-serif text-lg font-semibold text-cafe group-hover:text-terracota transition-colors leading-tight"},ao={class:"flex items-center gap-2 mt-1"},no=["title"],so={class:"text-xs text-gray-500"},ro={key:0,class:"mb-4 flex items-center gap-2"},io={class:"text-sm text-gray-700 font-medium"},lo={class:"space-y-3 mb-5"},co={class:"flex items-center gap-2 text-sm text-gray-600"},uo={class:"font-medium"},po={class:"flex items-center gap-2 text-sm text-gray-600"},mo=["title"],bo={key:1,class:"text-gray-400 font-medium"},fo={class:"flex items-center gap-2 text-sm text-gray-600"},vo={key:1,class:"mb-5 p-4 bg-gradient-to-br from-terracota/8 to-rosa/12 rounded-xl border border-terracota/15"},go={class:"space-y-3"},xo={class:"flex items-center justify-between"},_o={class:"flex items-center gap-2"},ho={class:"grid grid-cols-1 gap-2"},yo={class:"flex items-center gap-2 text-sm"},wo={class:"flex items-center gap-2 text-sm"},Ao={class:"pt-1"},Do={class:"flex items-center justify-between text-xs text-gray-500 mb-2"},$o={class:"font-semibold text-gray-700"},ko={class:"w-full bg-gray-200 rounded-full h-2 overflow-hidden"},Co={class:"pt-5 border-t border-gray-100"},So={class:"flex items-center justify-between text-xs text-gray-500 mb-2"},Eo={class:"font-semibold text-gray-700"},Po={class:"w-full bg-gray-200 rounded-full h-2"},Fo={class:"mt-5 space-y-2"},Mo={key:0,class:"flex items-start gap-3 p-3 bg-red-50 border border-red-200 rounded-lg animate-pulse-subtle"},Bo={class:"flex-1"},qo={class:"text-xs text-red-700"},Io={key:1,class:"flex items-start gap-3 p-3 bg-amber-50 border border-amber-200 rounded-lg"},To={class:"flex-1"},Vo={class:"text-xs text-amber-700"},zo={key:2,class:"flex items-start gap-3 p-3 bg-red-50 border border-red-200 rounded-lg animate-pulse-subtle"},jo={class:"flex-1"},Uo={class:"text-xs text-red-700"},Lo={key:3,class:"flex items-start gap-3 p-3 bg-orange-50 border border-orange-200 rounded-lg"},No={__name:"PacienteCard",props:{paciente:{type:Object,required:!0}},emits:["editar","eliminar","ver-citas","gestionar-bonos","editar-cita"],setup(U){const y=U,x=m(()=>{const r=y.paciente.nombre||"Sin nombre";if(r==="Sin nombre")return"Sin nombre";const s=r.trim().split(" ");if(s.length>2){const _=s[0],L=s[1],j=s[s.length-1].charAt(0);return`${_} ${L} ${j}.`}return r}),F=m(()=>{const r=y.paciente.nombre||"";if(!r)return"??";const s=r.trim().split(" "),_=s[0]?.charAt(0).toUpperCase()||"?",L=s[1]?.charAt(0).toUpperCase()||"";return`${_}${L}`}),V=m(()=>{const r=["#D8AFA0","#C89B8A","#B7C6B0","#A8C5B5","#D4A5A5","#C4B5A0"],s=y.paciente.id.charCodeAt(0)%r.length;return r[s]}),E=m(()=>{const r=y.paciente.estado_emocional_promedio||3;return r>=4?"ÔøΩ":r>=3?"üòê":"ÔøΩ"}),i=m(()=>{const r=y.paciente.estado_emocional_promedio||3;return r>=4?"Estado positivo":r>=3?"Estado neutro":"Requiere atenci√≥n"}),z=m(()=>y.paciente.activo?y.paciente.en_pausa?"En pausa":"Activo":"Finalizado"),G=m(()=>y.paciente.activo?y.paciente.en_pausa?"bg-yellow-100 text-yellow-700":"bg-green-100 text-green-700":"bg-gray-100 text-gray-600"),J=m(()=>y.paciente.area_de_acompanamiento||null),a=m(()=>{if(!y.paciente.ultima_sesion)return"Sin registro";const r=new Date(y.paciente.ultima_sesion),_=Math.floor((new Date-r)/(1e3*60*60*24));return _===0?"Hoy":_===1?"Ayer":_<7?`Hace ${_} d√≠as`:_<30?`Hace ${Math.floor(_/7)} semanas`:r.toLocaleDateString("es-ES",{day:"numeric",month:"short"})}),w=m(()=>{if(!y.paciente.proxima_sesion)return null;try{let r=y.paciente.proxima_sesion;r.includes("T")||(r+="T00:00:00");const s=new Date(r);return isNaN(s.getTime())?(console.warn("Fecha inv√°lida en pr√≥xima sesi√≥n:",y.paciente.proxima_sesion),null):s.toLocaleDateString("es-ES",{weekday:"short",day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"})}catch(r){return console.error("Error al formatear pr√≥xima sesi√≥n:",r,y.paciente.proxima_sesion),null}}),A=m(()=>y.paciente.total_sesiones||0),N=m(()=>y.paciente.evolucion_porcentaje||50),T=m(()=>{const r=N.value;return r>=70?"bg-green-500":r>=50?"bg-yellow-500":"bg-orange-500"}),g=m(()=>{if(!y.paciente.ultima_sesion)return 0;const r=new Date(y.paciente.ultima_sesion);return Math.floor((new Date-r)/(1e3*60*60*24))}),t=m(()=>!y.paciente.activo||y.paciente.en_pausa?!1:g.value>30),b=m(()=>y.paciente.requiere_atencion||!1),u=m(()=>y.paciente.bono_activo||null),O=m(()=>u.value?.tipo?{otro:"A demanda",quincenal:"Quincenal",semanal:"Semanal",mensual:"Mensual",personalizado:"Personalizado"}[u.value.tipo]||u.value.tipo:"Sin tipo"),I=m(()=>u.value?.tipo&&{otro:"bg-blue-100 text-blue-700",quincenal:"bg-purple-100 text-purple-700",semanal:"bg-indigo-100 text-indigo-700",mensual:"bg-teal-100 text-teal-700",personalizado:"bg-pink-100 text-pink-700"}[u.value.tipo]||"bg-gray-100 text-gray-600"),Q=m(()=>u.value?.estado?{activo:"Activo",pendiente:"Pendiente",vencido:"Vencido",completado:"Completado"}[u.value.estado]||u.value.estado:"Sin estado"),W=m(()=>u.value?.estado&&{activo:"bg-green-100 text-green-700",pendiente:"bg-yellow-100 text-yellow-700",vencido:"bg-red-100 text-red-700",completado:"bg-gray-100 text-gray-600"}[u.value.estado]||"bg-gray-100 text-gray-600"),Z=m(()=>{if(!u.value?.fecha_fin)return"Sin fecha";try{return new Date(u.value.fecha_fin).toLocaleDateString("es-ES",{day:"numeric",month:"short",year:"numeric"})}catch{return"Fecha inv√°lida"}});m(()=>{if(!u.value?.fecha_fin)return"text-cafe/60";const r=new Date(u.value.fecha_fin),_=Math.floor((r-new Date)/(1e3*60*60*24));return _<0?"text-red-600 font-semibold":_<=7?"text-orange-600 font-semibold":_<=14?"text-amber-600":"text-cafe/80"});const ie=m(()=>u.value?u.value.sesiones_totales-u.value.sesiones_restantes:0),p=m(()=>u.value?.sesiones_totales||0),o=m(()=>{if(!u.value)return"text-terracota";const r=u.value.sesiones_restantes;return r===0?"text-red-600 font-bold":r===1?"text-red-600 font-semibold":r===2?"text-orange-600 font-semibold":"text-terracota font-semibold"}),l=m(()=>{if(!u.value)return 0;const r=u.value.sesiones_totales,s=u.value.sesiones_restantes;if(r===0)return 0;const _=r-s;return Math.round(_/r*100)}),K=m(()=>l.value.toString()),R=m(()=>{if(!u.value)return"bg-gray-400";const r=u.value.estado;return{activo:"bg-green-500",pendiente:"bg-yellow-500",vencido:"bg-red-500",completado:"bg-gray-400"}[r]||"bg-gray-400"}),oe=m(()=>u.value?u.value.sesiones_restantes===1:!1),C=m(()=>u.value?u.value.sesiones_restantes===2:!1);return(r,s)=>(v(),f("div",We,[e("div",Ze,[e("button",{onClick:s[0]||(s[0]=X(_=>r.$emit("gestionar-bonos",U.paciente),["stop"])),class:"p-1.5 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors shadow-md hover:shadow-lg",title:"Gestionar bonos"},[...s[5]||(s[5]=[e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"})],-1)])]),e("button",{onClick:s[1]||(s[1]=X(_=>r.$emit("editar",U.paciente),["stop"])),class:"p-1.5 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors shadow-md hover:shadow-lg",title:"Editar paciente"},[...s[6]||(s[6]=[e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})],-1)])]),e("button",{onClick:s[2]||(s[2]=X(_=>r.$emit("eliminar",U.paciente),["stop"])),class:"p-1.5 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors shadow-md hover:shadow-lg",title:"Eliminar paciente"},[...s[7]||(s[7]=[e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})],-1)])])]),e("div",eo,[e("div",oo,[e("div",{class:"w-12 h-12 rounded-full flex items-center justify-center text-white font-semibold text-lg flex-shrink-0 shadow-sm",style:he({backgroundColor:n(V)})},c(n(F)),5),e("div",null,[e("h3",to,c(n(x)),1),e("div",ao,[e("span",{class:"text-lg",title:n(i)},c(n(E)),9,no),e("span",so,c(n(i)),1)])])]),e("span",{class:Y(["px-2.5 py-1 text-xs font-medium rounded-full whitespace-nowrap",n(G)])},c(n(z)),3)]),n(J)?(v(),f("div",ro,[s[8]||(s[8]=e("span",{class:"text-xs text-gray-400 uppercase tracking-wide"},"√Årea:",-1)),e("span",io,c(n(J)),1)])):P("",!0),e("div",lo,[e("div",co,[M(n(Ce),{class:"w-4 h-4 text-terracota flex-shrink-0"}),s[9]||(s[9]=e("span",null,"√öltima sesi√≥n: ",-1)),e("span",uo,c(n(a)),1)]),e("div",po,[M(n(je),{class:"w-4 h-4 text-terracota flex-shrink-0"}),s[10]||(s[10]=e("span",null,"Pr√≥xima: ",-1)),n(w)?(v(),f("button",{key:0,onClick:s[3]||(s[3]=X(_=>r.$emit("editar-cita",U.paciente.proxima_cita_id),["stop"])),class:"text-terracota hover:text-cafe font-medium hover:underline transition-colors flex-shrink-0",title:`Editar cita del ${n(w)}`},c(n(w)),9,mo)):(v(),f("span",bo,"No programada")),e("button",{onClick:s[4]||(s[4]=X(_=>r.$emit("ver-citas",U.paciente),["stop"])),class:"ml-auto text-xs text-terracota hover:text-cafe hover:underline transition-colors flex-shrink-0",title:"Ver todas las citas"}," Ver citas ‚Üí ")]),e("div",fo,[M(n(Ue),{class:"w-4 h-4 text-terracota flex-shrink-0"}),e("span",null,c(n(A))+" sesiones completadas",1)])]),n(u)?(v(),f("div",vo,[e("div",go,[e("div",xo,[e("div",_o,[M(n(Le),{class:"w-4 h-4 text-terracota flex-shrink-0"}),s[11]||(s[11]=e("span",{class:"text-sm font-medium text-gray-700"},"Bono:",-1)),e("span",{class:Y(["px-2.5 py-1 rounded-lg text-xs font-semibold",n(I)])},c(n(O)),3)]),e("span",{class:Y(["px-2.5 py-1 rounded-full text-xs font-semibold flex items-center gap-1.5",n(W)])},[M(n(Ne),{class:"w-3 h-3"}),e("span",null,c(n(Q)),1)],2)]),e("div",ho,[e("div",yo,[M(n(Ce),{class:"w-4 h-4 text-terracota flex-shrink-0"}),s[12]||(s[12]=e("span",{class:"text-gray-600"},"Vigencia:",-1)),e("span",{class:Y([r.fechaFinClases,"font-medium"])},c(n(Z)),3)]),e("div",wo,[M(n(Oe),{class:"w-4 h-4 text-terracota flex-shrink-0"}),s[13]||(s[13]=e("span",{class:"text-gray-600"},"Sesiones:",-1)),e("span",{class:Y([n(o),"font-semibold"])},c(n(ie))+"/"+c(n(p)),3)])]),e("div",Ao,[e("div",Do,[s[14]||(s[14]=e("span",null,"Progreso del bono",-1)),e("span",$o,c(n(K))+"%",1)]),e("div",ko,[e("div",{class:Y(["h-2 rounded-full transition-all duration-500",n(R)]),style:he({width:`${n(l)}%`})},null,6)])])])])):P("",!0),e("div",Co,[e("div",So,[s[15]||(s[15]=e("span",null,"Evoluci√≥n general",-1)),e("span",Eo,c(n(N))+"%",1)]),e("div",Po,[e("div",{class:Y(["h-2 rounded-full transition-all duration-500",n(T)]),style:he({width:`${n(N)}%`})},null,6)])]),e("div",Fo,[n(oe)?(v(),f("div",Mo,[M(n(Re),{class:"w-4 h-4 text-red-600 flex-shrink-0 mt-0.5"}),e("div",Bo,[s[16]||(s[16]=e("p",{class:"text-xs font-semibold text-red-800 mb-1"}," Bono casi agotado ",-1)),e("p",qo," Solo queda "+c(n(u).sesiones_restantes)+" sesi√≥n. Informar para renovaci√≥n. ",1)])])):n(C)?(v(),f("div",Io,[M(n(Se),{class:"w-4 h-4 text-amber-600 flex-shrink-0 mt-0.5"}),e("div",To,[s[17]||(s[17]=e("p",{class:"text-xs font-semibold text-amber-800 mb-1"}," Bono pr√≥ximo a agotar ",-1)),e("p",Vo," Quedan "+c(n(u).sesiones_restantes)+" sesiones. Considerar renovaci√≥n. ",1)])])):P("",!0),n(t)?(v(),f("div",zo,[M(n(He),{class:"w-4 h-4 text-red-600 flex-shrink-0 mt-0.5"}),e("div",jo,[s[18]||(s[18]=e("p",{class:"text-xs font-semibold text-red-800 mb-1"}," Riesgo de abandono ",-1)),e("p",Uo,c(n(g))+" d√≠as sin sesi√≥n. Considera contactar pronto. ",1)])])):P("",!0),n(b)?(v(),f("div",Lo,[M(n(Se),{class:"w-4 h-4 text-orange-500 flex-shrink-0 mt-0.5"}),s[19]||(s[19]=e("div",{class:"flex-1"},[e("p",{class:"text-xs font-semibold text-orange-800"}," Requiere seguimiento especial por estado emocional ")],-1))])):P("",!0)])]))}},Oo=be(No,[["__scopeId","data-v-e4c2174f"]]),Ro={class:"bg-white/95 backdrop-blur-lg rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto border border-white/30"},Ho={class:"space-y-4"},Qo={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},Go={class:"relative"},Jo={class:"space-y-4 pt-4 border-t border-neutral-200"},Ko={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},Xo={class:"md:col-span-2"},Yo={class:"relative"},Wo={class:"flex gap-2 flex-wrap mt-2"},Zo=["onClick"],et={class:"space-y-4 pt-4 border-t border-[#D8AFA0]/30"},ot={class:"border-t pt-6"},tt={key:0,class:"bg-amber-50 border-2 border-amber-200 rounded-lg p-4 mb-3"},at={key:1,class:"text-sm text-cafe/70 mb-3"},nt=["disabled"],st={key:0,class:"border-2 border-purple-400/40 rounded-lg p-5 space-y-4 bg-gradient-to-br from-purple-50 to-purple-100/50"},rt={class:"bg-white border-2 border-purple-300 rounded-lg p-4 shadow-sm"},it={class:"flex items-start gap-3"},lt={class:"flex-1"},dt={class:"font-semibold text-purple-900 mb-1"},ct={class:"grid grid-cols-2 gap-3 text-sm"},ut={class:"flex items-center gap-2"},pt={class:"text-purple-800"},mt={key:0,class:"flex items-center gap-2"},bt={class:"text-purple-800"},ft={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},vt={class:"relative"},gt=["required"],xt={class:"px-4 py-2 bg-purple-100 rounded-lg border border-purple-300"},_t={class:"text-lg font-bold text-purple-700"},ht={class:"md:col-span-2"},yt={class:"flex items-start gap-3 p-4 bg-white border-2 border-purple-200 rounded-lg cursor-pointer hover:bg-purple-50 hover:border-purple-300 transition-all"},wt={key:0,class:"p-3 bg-white rounded-lg border border-purple-300"},At={class:"grid grid-cols-3 gap-2 text-xs"},Dt={class:"font-medium text-[#5D4A44] ml-1"},$t={class:"font-medium text-[#5D4A44] ml-1"},kt={class:"font-medium text-[#5D4A44] ml-1"},Ct={class:"space-y-4 pt-4 border-t border-[#D8AFA0]/30"},St={key:0,class:"bg-red-50 border border-red-200 rounded-lg p-4"},Et={class:"text-sm text-red-600"},Pt={class:"sticky bottom-0 bg-gradient-to-r from-white/95 via-white/90 to-white/95 backdrop-blur-md pt-4 pb-2 border-t border-neutral-200 -mx-6 px-6 mt-6 shadow-sm"},Ft={class:"flex justify-between items-center gap-3"},Mt={class:"flex gap-3"},Bt=["disabled"],qt=["disabled"],It={key:0,class:"inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"},Tt={key:1},Vt={__name:"ModalNuevoPaciente",props:{mostrar:{type:Boolean,default:!1}},emits:["cerrar","paciente-creado"],setup(U,{emit:y}){const x=U,F=y,{supabase:V,waitForUser:E,getUserId:i}=fe(),{crearBono:z}=Fe(),{crearCita:G}=Ge(),J=Pe(),a=q({nombre:"",apellido:"",email:"",telefono:"",fecha_nacimiento:"",area_acompanamiento:"",tipo_bono:"",primera_sesion:"",activo:!0,notas_iniciales:"",crear_bono:!1,bono_monto:0,bono_renovacion_automatica:!1}),w=q(!1),A=q(""),N={otro:60,quincenal:100,semanal:160,mensual:180},T=m(()=>{const p=a.value.tipo_bono;return p&&{otro:1,quincenal:2,semanal:4,mensual:4}[p]||0}),g=m(()=>{const p=a.value.tipo_bono;return{otro:"A Demanda",quincenal:"Quincenal",semanal:"Semanal",mensual:"Mensual"}[p]||"No seleccionado"}),t=m(()=>{const p=T.value,o=a.value.bono_monto;return!p||!o||p<=0?"0.00":(o/p).toFixed(2)}),b=m(()=>{const p=a.value.tipo_bono;return p&&N[p]||0}),u=m(()=>a.value.tipo_bono==="otro"),O=m(()=>{const p=new Date,o=[],l=(r,s)=>{const _=r.getFullYear(),L=String(r.getMonth()+1).padStart(2,"0"),j=String(r.getDate()).padStart(2,"0");return`${_}-${L}-${j}T${s}`},K=new Date(p);K.setDate(K.getDate()+1),o.push({label:"üåÖ Ma√±ana 10:00",datetime:l(K,"10:00")});const R=new Date(p),oe=(8-R.getDay())%7;R.setDate(R.getDate()+(oe||7)),o.push({label:"üìÖ Pr√≥ximo Lun 09:00",datetime:l(R,"09:00")});const C=new Date(p);return C.setDate(C.getDate()+7),o.push({label:"üóìÔ∏è En 7 d√≠as 16:00",datetime:l(C,"16:00")}),o}),I=m(()=>{const p=a.value.nombre&&a.value.apellido&&a.value.email&&a.value.area_acompanamiento&&a.value.tipo_bono&&a.value.primera_sesion;return a.value.crear_bono?p&&a.value.bono_monto>0:p});re(()=>a.value.tipo_bono,p=>{p==="otro"?(a.value.crear_bono=!1,a.value.bono_monto=0):a.value.crear_bono&&a.value.bono_monto===0&&(a.value.bono_monto=N[p]||0)}),re(()=>a.value.crear_bono,p=>{p&&a.value.tipo_bono&&a.value.bono_monto===0&&(a.value.bono_monto=N[a.value.tipo_bono]||0)}),re(()=>x.mostrar,p=>{p&&W()});const Q=(p,o)=>{if(p.target&&p.target.showPicker)try{p.target.showPicker()}catch{console.log("showPicker no disponible")}else if(o){const l=document.getElementById(o);l&&(l.focus(),l.click())}},W=()=>{a.value={nombre:"",apellido:"",email:"",telefono:"",fecha_nacimiento:"",area_acompanamiento:"",tipo_bono:"",primera_sesion:"",activo:!0,notas_iniciales:"",crear_bono:!1,bono_monto:0,bono_renovacion_automatica:!1},A.value=""},Z=()=>{w.value||F("cerrar")},ie=async()=>{try{w.value=!0,A.value="",await E();const p=i();if(!p)throw new Error("Usuario no autenticado. Por favor, vuelve a iniciar sesi√≥n.");console.log("üÜï Creando nuevo paciente...");const o=`${a.value.nombre.trim()} ${a.value.apellido.trim()}`;console.log("üìù Llamando a crear_paciente_simple...");const{data:l,error:K}=await V.rpc("crear_paciente_simple",{p_email:a.value.email,p_nombre_completo:o,p_telefono:a.value.telefono||null,p_area_acompanamiento:a.value.area_acompanamiento||null,p_tipo_bono:a.value.tipo_bono||null,p_terapeuta_id:p,p_metadata:{nombre:a.value.nombre,apellido:a.value.apellido,fecha_nacimiento:a.value.fecha_nacimiento,notas_iniciales:a.value.notas_iniciales,fecha_registro:new Date().toISOString(),primera_sesion:a.value.primera_sesion,estado_registro:"activo"}});if(K)throw console.error("‚ùå Error en RPC crear_paciente_simple:",K),new Error(`Error al crear paciente: ${K.message}`);if(!l||!l.id){const C="Error desconocido al crear paciente";throw console.error("‚ùå RPC devolvi√≥ resultado inv√°lido:",l),new Error(C)}console.log("‚úÖ Paciente creado exitosamente:",l);const R=l.id,oe=null;if(a.value.crear_bono&&a.value.tipo_bono&&a.value.bono_monto)try{console.log("üí≥ Creando bono inicial ANTES de la cita...");const C=new Date().toISOString().split("T")[0];let r=null;const s=a.value.tipo_bono;if(s==="otro"){const D=new Date;D.setMonth(D.getMonth()+1),r=D.toISOString().split("T")[0]}else if(s==="quincenal"){const D=new Date;D.setDate(D.getDate()+15),r=D.toISOString().split("T")[0]}else if(s==="semanal"){const D=new Date;D.setMonth(D.getMonth()+1),r=D.toISOString().split("T")[0]}else if(s==="mensual"){const D=new Date;D.setMonth(D.getMonth()+1),r=D.toISOString().split("T")[0]}const _=T.value,L={paciente_id:R,terapeuta_id:p,tipo:s,sesiones_totales:_,sesiones_restantes:_,fecha_inicio:C,fecha_fin:r,estado:"pendiente",monto_total:a.value.bono_monto,precio_por_sesion:a.value.bono_monto/_,pagado:!1,renovacion_automatica:a.value.bono_renovacion_automatica,notas:`Bono creado al registrar paciente. ${o}`,metadata:{creado_con_paciente:!0,fecha_creacion:new Date().toISOString()}};console.log("üì¶ Datos del bono a crear:",L);const j=await z(L);j&&console.log("‚úÖ Bono creado exitosamente:",j)}catch(C){console.error("‚ö†Ô∏è Error al crear bono:",C),A.value=`Paciente creado, pero hubo un error al crear el bono: ${C.message}`}if(a.value.primera_sesion)try{console.log("üìÖ Creando cita para primera sesi√≥n..."),console.log("üìã Datos del paciente:",{pacienteId:R,nombreCompleto:o,userId:p}),console.log("üìã Primera sesi√≥n:",a.value.primera_sesion);const[C,r]=a.value.primera_sesion.split("T");console.log("üìã Fecha parseada:",C,"Hora parseada:",r);const[s,_]=r.split(":").map(Number),L=`${String(s+1).padStart(2,"0")}:${String(_).padStart(2,"0")}`;console.log("üìã Hora inicio:",r,"Hora fin:",L);const j=await G({paciente_id:R,paciente_nombre:o,terapeuta_id:p,fecha:C,hora_inicio:r,hora_fin:L,modalidad:"online",estado:"pendiente",notas:`Primera sesi√≥n programada al registrar paciente: ${o}`,descontar_de_bono:!1});console.log("üìã Resultado completo de crearCita:",j),j.success?console.log("‚úÖ Cita de primera sesi√≥n creada exitosamente:",j.data):(console.error("‚ùå ERROR al crear la cita de primera sesi√≥n:",j.error),A.value=`Paciente creado, pero hubo un error al crear la cita: ${j.error}`)}catch(C){console.error("‚ùå EXCEPCI√ìN al crear cita de primera sesi√≥n:",C),A.value=`Paciente creado, pero hubo un error al crear la cita: ${C.message}`}if(a.value.notas_iniciales&&await V.from("notas_terapeuticas").insert({paciente_id:R,terapeuta_id:J.value.id,contenido:a.value.notas_iniciales,tipo:"evaluacion_inicial"}),a.value.crear_bono&&a.value.tipo_bono&&a.value.bono_monto)try{console.log("üí≥ Creando bono inicial...");const C=new Date().toISOString().split("T")[0];let r=null;const s=a.value.tipo_bono;if(s==="otro"){const D=new Date;D.setMonth(D.getMonth()+1),r=D.toISOString().split("T")[0]}else if(s==="quincenal"){const D=new Date;D.setDate(D.getDate()+15),r=D.toISOString().split("T")[0]}else if(s==="semanal"){const D=new Date;D.setMonth(D.getMonth()+1),r=D.toISOString().split("T")[0]}else if(s==="mensual"){const D=new Date;D.setMonth(D.getMonth()+1),r=D.toISOString().split("T")[0]}const _=T.value,L={paciente_id:R,terapeuta_id:p,tipo:s,sesiones_totales:_,sesiones_restantes:_,fecha_inicio:C,fecha_fin:r,estado:"pendiente",monto_total:a.value.bono_monto,precio_por_sesion:a.value.bono_monto/_,pagado:!1,renovacion_automatica:a.value.bono_renovacion_automatica,notas:`Bono creado al registrar paciente. ${o}`,metadata:{creado_con_paciente:!0,fecha_creacion:new Date().toISOString()}};console.log("üì¶ Datos del bono a crear:",L);const j=await z(L);j&&console.log("‚úÖ Bono creado exitosamente:",j)}catch(C){console.error("‚ö†Ô∏è Error al crear bono:",C),A.value=`Paciente creado, pero hubo un error al crear el bono: ${C.message}`}F("paciente-creado",l),F("cerrar"),W()}catch(p){console.error("Error al crear paciente:",p),A.value=p.message||"Error al crear el paciente. Por favor, intenta nuevamente."}finally{w.value=!1}};return(p,o)=>U.mostrar?(v(),f("div",{key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",onClick:X(Z,["self"])},[e("div",Ro,[e("div",{class:"sticky top-0 bg-gradient-to-r from-[#5550F2]/5 via-[#027368]/5 to-[#04BF9D]/5 backdrop-blur-md border-b border-neutral-200 px-6 py-4 flex justify-between items-center shadow-sm"},[o[17]||(o[17]=e("h2",{class:"text-2xl font-['Elms_Sans'] text-neutral-800 font-semibold"}," Nuevo Paciente ",-1)),e("button",{onClick:Z,class:"text-neutral-600 hover:text-[#027368] transition-colors p-2 hover:bg-white/50 rounded-lg","aria-label":"Cerrar modal"},[...o[16]||(o[16]=[e("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),e("form",{onSubmit:X(ie,["prevent"]),class:"px-6 py-6 space-y-6 bg-gradient-to-b from-white/50 to-transparent"},[e("div",Ho,[o[25]||(o[25]=e("h3",{class:"text-lg font-['Elms_Sans'] text-neutral-800 font-semibold"}," Informaci√≥n Personal ",-1)),e("div",Qo,[e("div",null,[o[18]||(o[18]=e("label",{for:"nombre",class:"block text-sm font-medium text-neutral-700 mb-1"},[h(" Nombre "),e("span",{class:"text-red-500"},"*")],-1)),S(e("input",{id:"nombre","onUpdate:modelValue":o[0]||(o[0]=l=>a.value.nombre=l),type:"text",required:"",class:"w-full px-4 py-2 border border-neutral-300 rounded-xl focus:ring-2 focus:ring-[#027368]/20 focus:border-[#027368] bg-white/90 backdrop-blur-sm transition-all shadow-sm",placeholder:"Nombre del paciente"},null,512),[[H,a.value.nombre]])]),e("div",null,[o[19]||(o[19]=e("label",{for:"apellido",class:"block text-sm font-medium text-neutral-700 mb-1"},[h(" Apellido "),e("span",{class:"text-red-500"},"*")],-1)),S(e("input",{id:"apellido","onUpdate:modelValue":o[1]||(o[1]=l=>a.value.apellido=l),type:"text",required:"",class:"w-full px-4 py-2 border border-neutral-300 rounded-xl focus:ring-2 focus:ring-[#027368]/20 focus:border-[#027368] bg-white/90 backdrop-blur-sm transition-all shadow-sm",placeholder:"Apellido(s) del paciente"},null,512),[[H,a.value.apellido]])]),e("div",null,[o[20]||(o[20]=e("label",{for:"email",class:"block text-sm font-medium text-neutral-700 mb-1"},[h(" Email "),e("span",{class:"text-red-500"},"*")],-1)),S(e("input",{id:"email","onUpdate:modelValue":o[2]||(o[2]=l=>a.value.email=l),type:"email",required:"",class:"w-full px-4 py-2 border border-neutral-300 rounded-xl focus:ring-2 focus:ring-[#027368]/20 focus:border-[#027368] bg-white/90 backdrop-blur-sm transition-all shadow-sm",placeholder:"correo@ejemplo.com"},null,512),[[H,a.value.email]])]),e("div",null,[o[21]||(o[21]=e("label",{for:"telefono",class:"block text-sm font-medium text-neutral-700 mb-1"}," Tel√©fono ",-1)),S(e("input",{id:"telefono","onUpdate:modelValue":o[3]||(o[3]=l=>a.value.telefono=l),type:"tel",class:"w-full px-4 py-2 border border-neutral-300 rounded-xl focus:ring-2 focus:ring-[#027368]/20 focus:border-[#027368] bg-white/90 backdrop-blur-sm transition-all shadow-sm",placeholder:"+52 123 456 7890"},null,512),[[H,a.value.telefono]])]),e("div",null,[o[23]||(o[23]=e("label",{for:"fecha_nacimiento",class:"block text-sm font-medium text-[#5D4A44] mb-1"}," Fecha de Nacimiento ",-1)),e("div",Go,[S(e("input",{id:"fecha_nacimiento","onUpdate:modelValue":o[4]||(o[4]=l=>a.value.fecha_nacimiento=l),type:"date",class:"w-full px-4 py-2 pr-12 border border-[#D8AFA0]/30 rounded-lg focus:ring-2 focus:ring-[#D8AFA0] focus:border-transparent bg-white cursor-pointer",onFocus:o[5]||(o[5]=l=>Q(l))},null,544),[[H,a.value.fecha_nacimiento]]),e("button",{type:"button",onClick:o[6]||(o[6]=l=>Q(l,"fecha_nacimiento")),class:"absolute right-2 top-1/2 -translate-y-1/2 p-2 text-[#D8AFA0] hover:text-[#5D4A44] transition-colors",title:"Abrir calendario"},[...o[22]||(o[22]=[e("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"})],-1)])])]),o[24]||(o[24]=e("p",{class:"text-xs text-cafe/60 mt-1"}," üí° Puedes escribir la fecha o usar el calendario ",-1))])])]),e("div",Jo,[o[34]||(o[34]=e("h3",{class:"text-lg font-['Elms_Sans'] text-neutral-800 font-semibold"}," Informaci√≥n Terap√©utica ",-1)),e("div",Ko,[e("div",Xo,[o[27]||(o[27]=e("label",{for:"area_acompanamiento",class:"block text-sm font-medium text-[#5D4A44] mb-1"},[h(" √Årea de Acompa√±amiento "),e("span",{class:"text-red-500"},"*")],-1)),S(e("select",{id:"area_acompanamiento","onUpdate:modelValue":o[7]||(o[7]=l=>a.value.area_acompanamiento=l),required:"",class:"w-full px-4 py-2 border border-[#D8AFA0]/30 rounded-lg focus:ring-2 focus:ring-[#D8AFA0] focus:border-transparent bg-white"},[...o[26]||(o[26]=[me('<option value="">Selecciona un √°rea</option><option value="Ansiedad">Ansiedad</option><option value="Depresi√≥n">Depresi√≥n</option><option value="Autoestima">Autoestima</option><option value="Relaciones">Relaciones</option><option value="Duelo">Duelo</option><option value="Estr√©s Laboral">Estr√©s Laboral</option><option value="Crecimiento Personal">Crecimiento Personal</option><option value="Otro">Otro</option>',9)])],512),[[de,a.value.area_acompanamiento]])]),e("div",null,[o[29]||(o[29]=e("label",{for:"tipo_bono",class:"block text-sm font-medium text-[#5D4A44] mb-1"},[h(" Tipo de Bono "),e("span",{class:"text-red-500"},"*")],-1)),S(e("select",{id:"tipo_bono","onUpdate:modelValue":o[8]||(o[8]=l=>a.value.tipo_bono=l),required:"",class:"w-full px-4 py-2 border border-[#D8AFA0]/30 rounded-lg focus:ring-2 focus:ring-[#D8AFA0] focus:border-transparent bg-white"},[...o[28]||(o[28]=[me('<option value="">Selecciona tipo de bono</option><option value="otro">A Demanda (1 sesi√≥n - 60‚Ç¨ - sin compromiso)</option><option value="quincenal">Quincenal (2 sesiones/mes - 100‚Ç¨)</option><option value="semanal">Semanal (4 sesiones/mes - 160‚Ç¨)</option><option value="mensual">Mensual</option>',5)])],512),[[de,a.value.tipo_bono]]),o[30]||(o[30]=e("p",{class:"text-xs text-cafe/60 mt-1"}," üé´ Define el tipo de bono del paciente ",-1))]),e("div",null,[o[32]||(o[32]=e("label",{for:"primera_sesion",class:"block text-sm font-medium text-[#5D4A44] mb-1"},[h(" Primera Sesi√≥n "),e("span",{class:"text-red-500"},"*")],-1)),e("div",Yo,[S(e("input",{id:"primera_sesion","onUpdate:modelValue":o[9]||(o[9]=l=>a.value.primera_sesion=l),type:"datetime-local",required:"",step:"1800",class:"w-full px-4 py-2 pr-12 border border-[#D8AFA0]/30 rounded-lg focus:ring-2 focus:ring-[#D8AFA0] focus:border-transparent bg-white cursor-pointer",onFocus:o[10]||(o[10]=l=>Q(l))},null,544),[[H,a.value.primera_sesion]]),e("button",{type:"button",onClick:o[11]||(o[11]=l=>Q(l,"primera_sesion")),class:"absolute right-2 top-1/2 -translate-y-1/2 p-2 text-[#D8AFA0] hover:text-[#5D4A44] transition-colors",title:"Abrir selector de fecha y hora"},[...o[31]||(o[31]=[e("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)])])]),e("div",Wo,[(v(!0),f(ye,null,we(n(O),(l,K)=>(v(),f("button",{key:K,type:"button",onClick:R=>a.value.primera_sesion=l.datetime,class:Y(["text-xs px-3 py-1.5 rounded-lg border transition-all",a.value.primera_sesion===l.datetime?"bg-[#D8AFA0] text-white border-[#D8AFA0] font-semibold":"bg-white text-[#5D4A44] border-[#D8AFA0]/30 hover:border-[#D8AFA0] hover:bg-[#D8AFA0]/10"])},c(l.label),11,Zo))),128))]),o[33]||(o[33]=e("p",{class:"text-xs text-cafe/60 mt-1"}," üí° Puedes escribir la fecha/hora o usar el selector ",-1))])])]),e("div",et,[e("div",ot,[o[36]||(o[36]=e("h3",{class:"text-lg font-['Lora'] text-[#5D4A44] font-semibold mb-2"}," üí≥ Bono Inicial (Opcional) ",-1)),n(u)?(v(),f("div",tt,[...o[35]||(o[35]=[e("div",{class:"flex items-start gap-3"},[e("span",{class:"text-2xl"},"‚ÑπÔ∏è"),e("div",null,[e("p",{class:"text-sm font-semibold text-amber-900 mb-1"},' Sesi√≥n "A Demanda" seleccionada '),e("p",{class:"text-sm text-amber-800"},[h(" Las sesiones a demanda son "),e("strong",null,"sin compromiso"),h(" y se pagan individualmente (60‚Ç¨ por sesi√≥n). No es necesario crear un bono prepagado. ")])])],-1)])])):(v(),f("p",at," Crea un bono prepagado para que el paciente empiece su tratamiento. Podr√°s confirmar el pago despu√©s. ")),e("label",{class:Y(["flex items-center gap-3 p-3 rounded-lg transition-colors",n(u)?"bg-gray-100 border-2 border-gray-200 cursor-not-allowed opacity-60":"bg-purple-50 border-2 border-purple-200 cursor-pointer hover:bg-purple-100"])},[S(e("input",{"onUpdate:modelValue":o[12]||(o[12]=l=>a.value.crear_bono=l),type:"checkbox",disabled:n(u),class:"w-5 h-5 text-purple-600 border-gray-300 rounded focus:ring-purple-500 disabled:opacity-50 disabled:cursor-not-allowed"},null,8,nt),[[ce,a.value.crear_bono]]),e("span",{class:Y(["text-sm font-semibold",n(u)?"text-gray-500":"text-purple-700"])}," ‚úÖ S√≠, crear bono prepagado para este paciente ",2)],2)]),a.value.crear_bono?(v(),f("div",st,[e("div",rt,[e("div",it,[o[41]||(o[41]=e("div",{class:"w-10 h-10 bg-purple-500 rounded-full flex items-center justify-center flex-shrink-0"},[e("span",{class:"text-white text-xl"},"üéüÔ∏è")],-1)),e("div",lt,[e("h4",dt," Tipo de Bono: "+c(n(g)||"Selecciona un tipo arriba"),1),e("div",ct,[e("div",ut,[o[37]||(o[37]=e("span",{class:"text-purple-600"},"üìä",-1)),e("span",pt,[e("strong",null,c(n(T)),1),h(" "+c(n(T)===1?"sesi√≥n":"sesiones"),1)])]),n(b)>0?(v(),f("div",mt,[o[39]||(o[39]=e("span",{class:"text-purple-600"},"üí∞",-1)),e("span",bt,[o[38]||(o[38]=h(" Precio sugerido: ",-1)),e("strong",null,"‚Ç¨"+c(n(b)),1)])])):P("",!0)]),o[40]||(o[40]=e("p",{class:"text-xs text-purple-600 mt-2 bg-purple-50 p-2 rounded"},[h(" üí° "),e("strong",null,"Tip:"),h(" Los precios se calcular√°n autom√°ticamente seg√∫n el tipo de bono ")],-1))])])]),e("div",ft,[e("div",null,[o[43]||(o[43]=e("label",{for:"bono_monto",class:"block text-sm font-medium text-[#5D4A44] mb-1"},[h(" Monto Total "),e("span",{class:"text-red-500"},"*")],-1)),e("div",vt,[o[42]||(o[42]=e("span",{class:"absolute left-3 top-1/2 -translate-y-1/2 text-[#5D4A44]/60"},"‚Ç¨",-1)),S(e("input",{id:"bono_monto","onUpdate:modelValue":o[13]||(o[13]=l=>a.value.bono_monto=l),type:"number",min:"0",step:"0.01",required:a.value.crear_bono,placeholder:"0.00",class:"w-full pl-8 pr-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white"},null,8,gt),[[H,a.value.bono_monto,void 0,{number:!0}]])])]),e("div",null,[o[44]||(o[44]=e("label",{class:"block text-sm font-medium text-[#5D4A44] mb-1"}," Precio por Sesi√≥n ",-1)),e("div",xt,[e("span",_t,"‚Ç¨"+c(n(t)),1)])]),e("div",ht,[e("label",yt,[S(e("input",{"onUpdate:modelValue":o[14]||(o[14]=l=>a.value.bono_renovacion_automatica=l),type:"checkbox",class:"mt-1 w-5 h-5 text-purple-600 border-gray-300 rounded focus:ring-purple-500"},null,512),[[ce,a.value.bono_renovacion_automatica]]),o[45]||(o[45]=me('<div class="flex-1"><div class="flex items-center gap-2 mb-1"><span class="text-lg">üîÑ</span><span class="text-sm font-semibold text-purple-900"> Renovaci√≥n Autom√°tica </span><span class="ml-auto px-2 py-0.5 bg-purple-100 text-purple-700 text-xs font-medium rounded"> Recomendado </span></div><div class="text-xs text-[#5D4A44]/70 space-y-1"><p>‚úì El bono se renovar√° autom√°ticamente cuando se agoten las sesiones o expire</p><p>‚úì Mantiene la continuidad del tratamiento sin interrupciones</p><p>‚úì Puedes desactivar la renovaci√≥n en cualquier momento</p></div></div>',1))])])]),n(T)>0&&a.value.bono_monto>0?(v(),f("div",wt,[o[49]||(o[49]=e("div",{class:"text-xs font-medium text-purple-800 mb-2"},"üìã Resumen del Bono",-1)),e("div",At,[e("div",null,[o[46]||(o[46]=e("span",{class:"text-[#5D4A44]/60"},"Tipo:",-1)),e("span",Dt,c(n(g)),1)]),e("div",null,[o[47]||(o[47]=e("span",{class:"text-[#5D4A44]/60"},"Sesiones:",-1)),e("span",$t,c(n(T)),1)]),e("div",null,[o[48]||(o[48]=e("span",{class:"text-[#5D4A44]/60"},"Total:",-1)),e("span",kt,"‚Ç¨"+c(a.value.bono_monto),1)])])])):P("",!0)])):P("",!0)]),e("div",Ct,[o[51]||(o[51]=e("h3",{class:"text-lg font-['Lora'] text-[#5D4A44] font-semibold"}," Notas Iniciales ",-1)),e("div",null,[o[50]||(o[50]=e("label",{for:"notas_iniciales",class:"block text-sm font-medium text-[#5D4A44] mb-1"}," Observaciones (Opcional) ",-1)),S(e("textarea",{id:"notas_iniciales","onUpdate:modelValue":o[15]||(o[15]=l=>a.value.notas_iniciales=l),rows:"3",class:"w-full px-4 py-2 border border-[#D8AFA0]/30 rounded-lg focus:ring-2 focus:ring-[#D8AFA0] focus:border-transparent bg-white resize-none",placeholder:"Observaciones iniciales, motivo de consulta, etc."},null,512),[[H,a.value.notas_iniciales]])])]),A.value?(v(),f("div",St,[e("p",Et,c(A.value),1)])):P("",!0),e("div",Pt,[e("div",Ft,[o[52]||(o[52]=e("div",{class:"text-xs text-neutral-600"},[e("span",{class:"inline-block w-2 h-2 bg-red-500 rounded-full mr-1"}),h(" Los campos con * son obligatorios ")],-1)),e("div",Mt,[e("button",{type:"button",onClick:Z,disabled:w.value,class:"px-6 py-2.5 border-2 border-neutral-300 text-neutral-700 font-medium rounded-xl hover:bg-neutral-50 hover:border-[#027368] transition-all disabled:opacity-50 disabled:cursor-not-allowed"}," Cancelar ",8,Bt),e("button",{type:"submit",disabled:w.value||!n(I),class:"px-8 py-2.5 bg-gradient-to-r from-[#04BF9D] to-[#027368] text-white font-semibold rounded-xl hover:from-[#027368] hover:to-[#04BF9D] transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 shadow-sm hover:shadow-md"},[w.value?(v(),f("span",It)):(v(),f("span",Tt,"‚úì")),h(" "+c(w.value?"Creando paciente...":"Crear Paciente"),1)],8,qt)])])])],32)])])):P("",!0)}},zt={class:"bg-[#F9F7F3] rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"},jt={class:"space-y-4"},Ut={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},Lt={class:"space-y-4 pt-4 border-t border-[#D8AFA0]/30"},Nt={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},Ot={class:"md:col-span-2"},Rt={class:"md:col-span-2"},Ht={class:"flex items-center gap-2 cursor-pointer"},Qt={class:"space-y-4 pt-4 border-t border-[#D8AFA0]/30"},Gt={class:"flex items-center justify-between"},Jt={class:"flex items-center gap-2 cursor-pointer"},Kt={key:0,class:"border-2 border-purple-400/40 rounded-lg p-4 space-y-4 bg-purple-50/30"},Xt={class:"bg-purple-100 border border-purple-300 rounded-lg p-3 flex items-start gap-2"},Yt={class:"text-sm text-purple-800"},Wt={class:"font-medium"},Zt={class:"text-xs text-purple-700 mt-1"},ea={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},oa={class:"relative"},ta=["required"],aa={class:"px-4 py-2 bg-purple-100 border-2 border-purple-300 rounded-lg text-purple-900 font-bold"},na={class:"md:col-span-2"},sa={class:"flex items-center gap-2 cursor-pointer"},ra={key:0,class:"bg-white border border-purple-300 rounded-lg p-4"},ia={class:"text-sm text-cafe/80 space-y-1"},la={key:0,class:"text-purple-700"},da={key:0,class:"bg-red-50 border border-red-200 rounded-lg p-4"},ca={class:"text-sm text-red-600"},ua={class:"flex justify-end gap-3 pt-4 border-t border-[#D8AFA0]/30"},pa=["disabled"],ma=["disabled"],ba={key:0,class:"inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"},fa={__name:"ModalEditarPaciente",props:{mostrar:{type:Boolean,default:!1},paciente:{type:Object,default:null}},emits:["cerrar","paciente-actualizado"],setup(U,{emit:y}){const x=U,F=y,{supabase:V}=fe(),{crearBono:E}=Fe(),i=q({nombre:"",apellido:"",email:"",telefono:"",fecha_nacimiento:"",area_acompanamiento:"",tipo_bono:"",activo:!0,en_pausa:!1,crear_bono:!1,bono_monto:null,bono_renovacion_automatica:!1}),z=m(()=>{const g=i.value.tipo_bono;return g?{a_demanda:1,quincenal:2,semanal:4}[g]||0:"Selecciona tipo"}),G=m(()=>{const g=i.value.tipo_bono;return{a_demanda:"A Demanda",quincenal:"Quincenal",semanal:"Semanal"}[g]||""}),J=m(()=>{const g=z.value,t=i.value.bono_monto;return g==="Selecciona tipo"||!t||g<=0?"0.00":(t/g).toFixed(2)}),a=q(!1),w=q("");re(()=>x.mostrar,g=>{g&&x.paciente&&A()});const A=()=>{const g=x.paciente,t=g.metadata||{},u=(g.nombre_completo||g.nombre||"").split(" "),O=u[0]||t.nombre||"",I=u.slice(1).join(" ")||t.apellido||t.apellido_paterno||"";i.value={nombre:O,apellido:I,email:g.email||"",telefono:g.telefono||"",fecha_nacimiento:t.fecha_nacimiento||"",area_acompanamiento:g.area_de_acompanamiento||g.area_acompanamiento||"",tipo_bono:g.tipo_bono||"",activo:g.activo??!0,en_pausa:g.en_pausa||t.en_pausa||!1,crear_bono:!1,bono_monto:null,bono_renovacion_automatica:!1},w.value=""},N=()=>{a.value||F("cerrar")},T=async()=>{try{a.value=!0,w.value="",console.log("Actualizando paciente:",x.paciente.id);const g=`${i.value.nombre.trim()} ${i.value.apellido.trim()}`,t=x.paciente.metadata||{},{data:b,error:u}=await V.from("pacientes").update({email:i.value.email,nombre_completo:g,telefono:i.value.telefono,area_de_acompanamiento:i.value.area_acompanamiento,tipo_bono:i.value.tipo_bono,activo:i.value.activo,metadata:{...t,nombre:i.value.nombre,apellido:i.value.apellido,fecha_nacimiento:i.value.fecha_nacimiento,en_pausa:i.value.en_pausa,fecha_actualizacion:new Date().toISOString()}}).eq("id",x.paciente.id).select().single();if(u)throw console.error("Error al actualizar paciente:",u),u;if(console.log("Paciente actualizado:",b),i.value.crear_bono&&i.value.tipo_bono&&i.value.bono_monto){console.log("Creando bono para el paciente...");const O=new Date,I=new Date,Q=i.value.tipo_bono;Q==="a_demanda"?I.setMonth(I.getMonth()+1):Q==="quincenal"?I.setDate(I.getDate()+15):Q==="semanal"&&I.setMonth(I.getMonth()+1);const W=z.value;await E({paciente_id:x.paciente.id,tipo:Q,sesiones_totales:W,sesiones_disponibles:W,monto_total:i.value.bono_monto,fecha_inicio:O.toISOString().split("T")[0],fecha_fin:I.toISOString().split("T")[0],estado:"pendiente",renovacion_automatica:i.value.bono_renovacion_automatica}),console.log("Bono creado exitosamente")}F("paciente-actualizado",b),F("cerrar")}catch(g){console.error("Error al actualizar paciente:",g),w.value=g.message||"Error al actualizar el paciente. Por favor, intenta nuevamente."}finally{a.value=!1}};return(g,t)=>U.mostrar?(v(),f("div",{key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",onClick:X(N,["self"])},[e("div",zt,[e("div",{class:"sticky top-0 bg-[#F9F7F3] border-b border-[#D8AFA0]/30 px-6 py-4 flex justify-between items-center"},[t[13]||(t[13]=e("h2",{class:"text-2xl font-['Lora'] text-[#5D4A44] font-semibold"}," Editar Paciente ",-1)),e("button",{onClick:N,class:"text-[#5D4A44] hover:text-[#D8AFA0] transition-colors","aria-label":"Cerrar modal"},[...t[12]||(t[12]=[e("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),e("form",{onSubmit:X(T,["prevent"]),class:"px-6 py-6 space-y-6"},[e("div",jt,[t[19]||(t[19]=e("h3",{class:"text-lg font-['Lora'] text-[#5D4A44] font-semibold"}," Informaci√≥n Personal ",-1)),e("div",Ut,[e("div",null,[t[14]||(t[14]=e("label",{for:"nombre",class:"block text-sm font-medium text-[#5D4A44] mb-1"},[h(" Nombre "),e("span",{class:"text-red-500"},"*")],-1)),S(e("input",{id:"nombre","onUpdate:modelValue":t[0]||(t[0]=b=>i.value.nombre=b),type:"text",required:"",class:"w-full px-4 py-2 border border-[#D8AFA0]/30 rounded-lg focus:ring-2 focus:ring-[#D8AFA0] focus:border-transparent bg-white",placeholder:"Nombre del paciente"},null,512),[[H,i.value.nombre]])]),e("div",null,[t[15]||(t[15]=e("label",{for:"apellido",class:"block text-sm font-medium text-[#5D4A44] mb-1"},[h(" Apellido "),e("span",{class:"text-red-500"},"*")],-1)),S(e("input",{id:"apellido","onUpdate:modelValue":t[1]||(t[1]=b=>i.value.apellido=b),type:"text",required:"",class:"w-full px-4 py-2 border border-[#D8AFA0]/30 rounded-lg focus:ring-2 focus:ring-[#D8AFA0] focus:border-transparent bg-white",placeholder:"Apellido(s) del paciente"},null,512),[[H,i.value.apellido]])]),e("div",null,[t[16]||(t[16]=e("label",{for:"email",class:"block text-sm font-medium text-[#5D4A44] mb-1"},[h(" Email "),e("span",{class:"text-red-500"},"*")],-1)),S(e("input",{id:"email","onUpdate:modelValue":t[2]||(t[2]=b=>i.value.email=b),type:"email",required:"",class:"w-full px-4 py-2 border border-[#D8AFA0]/30 rounded-lg focus:ring-2 focus:ring-[#D8AFA0] focus:border-transparent bg-white",placeholder:"correo@ejemplo.com"},null,512),[[H,i.value.email]])]),e("div",null,[t[17]||(t[17]=e("label",{for:"telefono",class:"block text-sm font-medium text-[#5D4A44] mb-1"}," Tel√©fono ",-1)),S(e("input",{id:"telefono","onUpdate:modelValue":t[3]||(t[3]=b=>i.value.telefono=b),type:"tel",class:"w-full px-4 py-2 border border-[#D8AFA0]/30 rounded-lg focus:ring-2 focus:ring-[#D8AFA0] focus:border-transparent bg-white",placeholder:"+52 123 456 7890"},null,512),[[H,i.value.telefono]])]),e("div",null,[t[18]||(t[18]=e("label",{for:"fecha_nacimiento",class:"block text-sm font-medium text-[#5D4A44] mb-1"}," Fecha de Nacimiento ",-1)),S(e("input",{id:"fecha_nacimiento","onUpdate:modelValue":t[4]||(t[4]=b=>i.value.fecha_nacimiento=b),type:"date",class:"w-full px-4 py-2 border border-[#D8AFA0]/30 rounded-lg focus:ring-2 focus:ring-[#D8AFA0] focus:border-transparent bg-white"},null,512),[[H,i.value.fecha_nacimiento]])])])]),e("div",Lt,[t[28]||(t[28]=e("h3",{class:"text-lg font-['Lora'] text-[#5D4A44] font-semibold"}," Informaci√≥n Terap√©utica ",-1)),e("div",Nt,[e("div",Ot,[t[21]||(t[21]=e("label",{for:"area_acompanamiento",class:"block text-sm font-medium text-[#5D4A44] mb-1"},[h(" √Årea de Acompa√±amiento "),e("span",{class:"text-red-500"},"*")],-1)),S(e("select",{id:"area_acompanamiento","onUpdate:modelValue":t[5]||(t[5]=b=>i.value.area_acompanamiento=b),required:"",class:"w-full px-4 py-2 border border-[#D8AFA0]/30 rounded-lg focus:ring-2 focus:ring-[#D8AFA0] focus:border-transparent bg-white"},[...t[20]||(t[20]=[me('<option value="" data-v-931716c5>Selecciona un √°rea</option><option value="Ansiedad" data-v-931716c5>Ansiedad</option><option value="Depresi√≥n" data-v-931716c5>Depresi√≥n</option><option value="Autoestima" data-v-931716c5>Autoestima</option><option value="Relaciones" data-v-931716c5>Relaciones</option><option value="Duelo" data-v-931716c5>Duelo</option><option value="Estr√©s Laboral" data-v-931716c5>Estr√©s Laboral</option><option value="Crecimiento Personal" data-v-931716c5>Crecimiento Personal</option><option value="Otro" data-v-931716c5>Otro</option>',9)])],512),[[de,i.value.area_acompanamiento]])]),e("div",null,[t[23]||(t[23]=e("label",{for:"tipo_bono",class:"block text-sm font-medium text-[#5D4A44] mb-1"},[h(" Tipo de Bono "),e("span",{class:"text-red-500"},"*")],-1)),S(e("select",{id:"tipo_bono","onUpdate:modelValue":t[6]||(t[6]=b=>i.value.tipo_bono=b),required:"",class:"w-full px-4 py-2 border border-[#D8AFA0]/30 rounded-lg focus:ring-2 focus:ring-[#D8AFA0] focus:border-transparent bg-white"},[...t[22]||(t[22]=[e("option",{value:""},"Selecciona tipo de bono",-1),e("option",{value:"a_demanda"},"A Demanda (1 sesi√≥n)",-1),e("option",{value:"quincenal"},"Quincenal (2 sesiones/mes)",-1),e("option",{value:"semanal"},"Semanal (4 sesiones/mes)",-1)])],512),[[de,i.value.tipo_bono]])]),e("div",null,[t[25]||(t[25]=e("label",{for:"activo",class:"block text-sm font-medium text-[#5D4A44] mb-1"}," Estado ",-1)),S(e("select",{id:"activo","onUpdate:modelValue":t[7]||(t[7]=b=>i.value.activo=b),class:"w-full px-4 py-2 border border-[#D8AFA0]/30 rounded-lg focus:ring-2 focus:ring-[#D8AFA0] focus:border-transparent bg-white"},[...t[24]||(t[24]=[e("option",{value:!0},"Activo",-1),e("option",{value:!1},"Inactivo",-1)])],512),[[de,i.value.activo]])]),e("div",Rt,[e("label",Ht,[S(e("input",{"onUpdate:modelValue":t[8]||(t[8]=b=>i.value.en_pausa=b),type:"checkbox",class:"w-4 h-4 text-[#D8AFA0] border-gray-300 rounded focus:ring-[#D8AFA0]"},null,512),[[ce,i.value.en_pausa]]),t[26]||(t[26]=e("span",{class:"text-sm font-medium text-[#5D4A44]"}," Proceso en pausa temporal ",-1))]),t[27]||(t[27]=e("p",{class:"text-xs text-cafe/60 mt-1 ml-6"}," ‚è∏Ô∏è Marca esta opci√≥n si el seguimiento est√° pausado temporalmente ",-1))])])]),e("div",Qt,[e("div",Gt,[t[30]||(t[30]=e("h3",{class:"text-lg font-['Lora'] text-[#5D4A44] font-semibold"}," Gesti√≥n de Bonos ",-1)),e("label",Jt,[S(e("input",{"onUpdate:modelValue":t[9]||(t[9]=b=>i.value.crear_bono=b),type:"checkbox",class:"w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500"},null,512),[[ce,i.value.crear_bono]]),t[29]||(t[29]=e("span",{class:"text-sm font-medium text-[#5D4A44]"}," üé´ Crear nuevo bono para este paciente ",-1))])]),i.value.crear_bono?(v(),f("div",Kt,[e("div",Xt,[t[32]||(t[32]=e("svg",{class:"w-5 h-5 text-purple-600 flex-shrink-0 mt-0.5",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{"fill-rule":"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z","clip-rule":"evenodd"})],-1)),e("div",Yt,[e("p",Wt,[t[31]||(t[31]=h("El bono usar√° el tipo seleccionado arriba: ",-1)),e("strong",null,c(G.value||"Selecciona un tipo primero"),1)]),e("p",Zt," Sesiones incluidas: "+c(z.value==="Selecciona tipo"?"N/A":z.value),1)])]),e("div",ea,[e("div",null,[t[34]||(t[34]=e("label",{for:"bono_monto",class:"block text-sm font-medium text-[#5D4A44] mb-1"},[h(" Monto Total "),e("span",{class:"text-red-500"},"*")],-1)),e("div",oa,[t[33]||(t[33]=e("span",{class:"absolute left-3 top-2.5 text-[#5D4A44] font-medium"},"‚Ç¨",-1)),S(e("input",{id:"bono_monto","onUpdate:modelValue":t[10]||(t[10]=b=>i.value.bono_monto=b),type:"number",min:"0",step:"0.01",required:i.value.crear_bono,class:"w-full pl-8 pr-4 py-2 border border-[#D8AFA0]/30 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white",placeholder:"0.00"},null,8,ta),[[H,i.value.bono_monto,void 0,{number:!0}]])])]),e("div",null,[t[35]||(t[35]=e("label",{class:"block text-sm font-medium text-[#5D4A44] mb-1"}," Precio por Sesi√≥n ",-1)),e("div",aa," ‚Ç¨"+c(J.value),1)]),e("div",na,[e("label",sa,[S(e("input",{"onUpdate:modelValue":t[11]||(t[11]=b=>i.value.bono_renovacion_automatica=b),type:"checkbox",class:"w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500"},null,512),[[ce,i.value.bono_renovacion_automatica]]),t[36]||(t[36]=e("span",{class:"text-sm font-medium text-[#5D4A44]"}," üîÑ Renovaci√≥n autom√°tica al vencer ",-1))]),t[37]||(t[37]=e("p",{class:"text-xs text-cafe/60 mt-1 ml-6"}," El sistema crear√° un nuevo bono id√©ntico cuando este expire ",-1))])]),z.value&&i.value.bono_monto?(v(),f("div",ra,[t[46]||(t[46]=e("p",{class:"text-sm font-medium text-[#5D4A44] mb-2"},"üìã Resumen del Bono:",-1)),e("div",ia,[e("p",null,[t[38]||(t[38]=h("‚Ä¢ ",-1)),t[39]||(t[39]=e("strong",null,"Tipo:",-1)),h(" "+c(G.value),1)]),e("p",null,[t[40]||(t[40]=h("‚Ä¢ ",-1)),t[41]||(t[41]=e("strong",null,"Sesiones:",-1)),h(" "+c(z.value),1)]),e("p",null,[t[42]||(t[42]=h("‚Ä¢ ",-1)),t[43]||(t[43]=e("strong",null,"Total:",-1)),h(" ‚Ç¨"+c(i.value.bono_monto.toFixed(2)),1)]),e("p",null,[t[44]||(t[44]=h("‚Ä¢ ",-1)),t[45]||(t[45]=e("strong",null,"Por sesi√≥n:",-1)),h(" ‚Ç¨"+c(J.value),1)]),i.value.bono_renovacion_automatica?(v(),f("p",la,"‚Ä¢ ‚úÖ Con renovaci√≥n autom√°tica")):P("",!0)])])):P("",!0)])):P("",!0)]),w.value?(v(),f("div",da,[e("p",ca,c(w.value),1)])):P("",!0),e("div",ua,[e("button",{type:"button",onClick:N,disabled:a.value,class:"px-6 py-2 border border-[#D8AFA0] text-[#5D4A44] rounded-lg hover:bg-[#D8AFA0]/10 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"}," Cancelar ",8,pa),e("button",{type:"submit",disabled:a.value,class:"px-6 py-2 bg-[#D8AFA0] text-white rounded-lg hover:bg-[#C69F91] transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"},[a.value?(v(),f("span",ba)):P("",!0),h(" "+c(a.value?"Actualizando...":"Guardar Cambios"),1)],8,ma)])],32)])])):P("",!0)}},va=be(fa,[["__scopeId","data-v-931716c5"]]),ga={class:"bg-[#F9F7F3] rounded-lg shadow-xl max-w-md w-full"},xa={class:"px-6 py-6 space-y-4"},_a={class:"text-[#5D4A44]"},ha={class:"font-semibold"},ya={class:"bg-blue-50 border border-blue-200 rounded-lg p-4"},wa=["disabled"],Aa={key:0,class:"bg-red-50 border border-red-200 rounded-lg p-3"},Da={class:"text-sm text-red-600"},$a={class:"px-6 py-4 border-t border-[#D8AFA0]/30 flex justify-end gap-3"},ka=["disabled"],Ca=["disabled"],Sa={key:0,class:"inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"},Ea={__name:"ModalEliminarPaciente",props:{mostrar:{type:Boolean,default:!1},paciente:{type:Object,default:null}},emits:["cerrar","paciente-eliminado","paciente-desactivado"],setup(U,{emit:y}){const x=U,F=y,{supabase:V}=fe(),E=q(!1),i=q(""),z=m(()=>x.paciente?x.paciente.nombre_completo||x.paciente.nombre||x.paciente.email||"este paciente":""),G=()=>{E.value||(i.value="",F("cerrar"))},J=async()=>{try{E.value=!0,i.value="",console.log("Desactivando paciente:",x.paciente.id);const{error:w}=await V.from("pacientes").update({activo:!1,metadata:{...x.paciente.metadata,fecha_desactivacion:new Date().toISOString()}}).eq("id",x.paciente.id);if(w)throw w;console.log("Paciente desactivado exitosamente"),F("paciente-desactivado",x.paciente.id),F("cerrar")}catch(w){console.error("Error al desactivar paciente:",w),i.value=w.message||"Error al desactivar el paciente."}finally{E.value=!1}},a=async()=>{try{E.value=!0,i.value="",console.log("Eliminando paciente:",x.paciente.id),await V.from("metricas_bienestar").delete().eq("paciente_id",x.paciente.id),await V.from("notas_terapeuticas").delete().eq("paciente_id",x.paciente.id),await V.from("recursos_compartidos").delete().eq("paciente_id",x.paciente.id),await V.from("mensajes").delete().or(`remitente_id.eq.${x.paciente.id},destinatario_id.eq.${x.paciente.id}`),await V.from("bonos").delete().eq("paciente_id",x.paciente.id),await V.from("sesiones").delete().eq("paciente_id",x.paciente.id);const{error:w}=await V.from("pacientes").delete().eq("id",x.paciente.id);if(w)throw w;console.log("Paciente eliminado exitosamente"),F("paciente-eliminado",x.paciente.id),F("cerrar")}catch(w){console.error("Error al eliminar paciente:",w),i.value=w.message||"Error al eliminar el paciente. Por favor, intenta nuevamente."}finally{E.value=!1}};return(w,A)=>U.mostrar?(v(),f("div",{key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",onClick:X(G,["self"])},[e("div",ga,[A[5]||(A[5]=e("div",{class:"px-6 py-4 border-b border-[#D8AFA0]/30"},[e("div",{class:"flex items-center gap-3"},[e("span",{class:"text-3xl"},"‚ö†Ô∏è"),e("h2",{class:"text-2xl font-['Lora'] text-[#5D4A44] font-semibold"}," Eliminar Paciente ")])],-1)),e("div",xa,[e("p",_a,[A[0]||(A[0]=h(" ¬øEst√°s seguro de que deseas eliminar a ",-1)),e("strong",ha,c(z.value),1),A[1]||(A[1]=h("? ",-1))]),A[4]||(A[4]=e("div",{class:"bg-red-50 border border-red-200 rounded-lg p-4 space-y-2"},[e("p",{class:"text-sm text-red-800 font-medium"}," Esta acci√≥n no se puede deshacer y eliminar√°: "),e("ul",{class:"text-sm text-red-700 space-y-1 ml-4 list-disc"},[e("li",null,"Todos los datos personales del paciente"),e("li",null,"El historial de sesiones"),e("li",null,"Las notas terap√©uticas"),e("li",null,"Las m√©tricas de bienestar"),e("li",null,"Los bonos asociados")])],-1)),e("div",ya,[A[2]||(A[2]=e("p",{class:"text-sm text-blue-800 font-medium mb-2"}," üí° Recomendaci√≥n: ",-1)),A[3]||(A[3]=e("p",{class:"text-sm text-blue-700 mb-3"},[h(" En lugar de eliminar, considera "),e("strong",null,"desactivar"),h(" al paciente. Esto preservar√° el historial para consultas futuras. ")],-1)),e("button",{type:"button",onClick:J,disabled:E.value,class:"w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm"}," Desactivar en lugar de eliminar ",8,wa)]),i.value?(v(),f("div",Aa,[e("p",Da,c(i.value),1)])):P("",!0)]),e("div",$a,[e("button",{type:"button",onClick:G,disabled:E.value,class:"px-6 py-2 border border-[#D8AFA0] text-[#5D4A44] rounded-lg hover:bg-[#D8AFA0]/10 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"}," Cancelar ",8,ka),e("button",{type:"button",onClick:a,disabled:E.value,class:"px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"},[E.value?(v(),f("span",Sa)):P("",!0),h(" "+c(E.value?"Eliminando...":"Eliminar Definitivamente"),1)],8,Ca)])])])):P("",!0)}},Pa=be(Ea,[["__scopeId","data-v-650451a2"]]),Fa={class:"mb-8"},Ma={class:"bg-white rounded-xl shadow-sm border border-gray-100 p-6"},Ba={class:"flex flex-col lg:flex-row gap-4"},qa={class:"flex-1"},Ia={class:"relative"},Ta={class:"flex flex-wrap gap-2"},Va=["onClick"],za={key:0,class:"flex flex-col items-center justify-center py-16"},ja={key:1,class:"bg-white rounded-xl shadow-sm border border-gray-100 p-8 text-center"},Ua={class:"text-xl font-serif font-semibold text-cafe mb-3"},La={class:"text-gray-500 mb-6 max-w-md mx-auto"},Na={key:2,class:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"},Oa=["onClick"],Ra=["onClick"],Ha=["onClick"],Qa={key:3,class:"mt-8 pt-6 border-t border-gray-100 flex items-center justify-between"},Ga={class:"text-sm text-gray-500"},Ja={key:0,class:"flex gap-2"},Ka={__name:"pacientes",setup(U){const y=Te(),x=Ke(),{getUserId:F,waitForUser:V}=fe(),E=Pe();console.log("[Pacientes] Estado inicial del usuario:",{existe:!!E.value,id:F(),email:E.value?.email}),re(E,(d,$)=>{console.log("[Pacientes] Usuario cambi√≥:",{antes:$?.email||"null",ahora:d?.email||"null",id:F()})});const i=q(!1),z=q(!1),G=q(!1),J=q(!1),a=q(!1),w=q(null),A=q(null),N=q(null),T=q([]),g=q(!0),t=q(""),b=q("todos"),u=[{valor:"todos",label:"Todos"},{valor:"activo",label:"Activos"},{valor:"pausa",label:"En pausa"},{valor:"finalizado",label:"Finalizados"}],O=async()=>{g.value=!0;try{const d=F();if(console.log("[Pacientes] Iniciando carga de pacientes..."),console.log("[Pacientes] Usuario actual:",{existe:!!E.value,id:d,email:E.value?.email}),!d){console.error("[Pacientes] Usuario no autenticado"),g.value=!1;return}console.log("‚úÖ [Pacientes] Usuario verificado, consultando database...");const{data:$,error:ee}=await x.from("pacientes").select(`
        id,
        created_at,
        activo,
        email,
        nombre_completo,
        telefono,
        area_de_acompanamiento,
        frecuencia,
        metadata
      `).eq("terapeuta_id",d).order("created_at",{ascending:!1});if(ee)throw ee;const ue=await Promise.all($.map(async B=>{const{data:ve}=await x.from("citas").select("fecha_cita").eq("paciente_id",B.id).eq("estado","realizada").order("fecha_cita",{ascending:!1}).limit(1).maybeSingle(),{data:te}=await x.from("citas").select("id, fecha_cita, hora_inicio").eq("paciente_id",B.id).in("estado",["pendiente","confirmada"]).gte("fecha_cita",new Date().toISOString().split("T")[0]).order("fecha_cita",{ascending:!0}).order("hora_inicio",{ascending:!0}).limit(1).maybeSingle(),{count:ge}=await x.from("citas").select("*",{count:"exact",head:!0}).eq("paciente_id",B.id).eq("estado","realizada");let k=null;try{const{data:ne}=await x.from("bonos").select("id, tipo, estado, sesiones_totales, sesiones_restantes, fecha_fin, created_at").eq("paciente_id",B.id).order("created_at",{ascending:!1});console.log(`[Bonos] Paciente ${B.nombre_completo}:`,ne);const{data:pe,error:se}=await x.from("bonos").select("id, tipo, estado, sesiones_totales, sesiones_restantes, fecha_fin, created_at").eq("paciente_id",B.id).in("estado",["activo","pendiente"]).order("created_at",{ascending:!1}).limit(1).maybeSingle();se?console.warn("[Bonos] Error en consulta:",se.message):(k=pe,console.log("‚úÖ [Bonos] Bono activo encontrado:",k))}catch(ne){console.warn("[Bonos] Error inesperado:",ne)}let ae=0,xe=0;k&&(xe=k.sesiones_totales,ae=xe-k.sesiones_restantes);const _e=new Date;_e.setDate(_e.getDate()-7);const{data:le}=await x.from("metricas_bienestar").select("estado_animo, nivel_energia, nivel_estres").eq("paciente_id",B.id).gte("fecha",_e.toISOString());let De=3,$e=!1,ke=50;if(le&&le.length>0){const ne=le.reduce((se,Ie)=>se+Ie.estado_animo,0)/le.length;De=ne,ke=Math.round(ne/10*100);const pe=le.slice(-3);pe.length>=3&&($e=pe.every(se=>se.estado_animo<=4))}const qe=B.nombre_completo||B.metadata?.nombre_completo||B.email;return{id:B.id,nombre:qe,apellidos:"",email:B.email,telefono:B.telefono,activo:B.activo,en_pausa:B.metadata?.en_pausa||!1,area_de_acompanamiento:B.area_de_acompanamiento,frecuencia:B.frecuencia,ultima_sesion:ve?.fecha_cita||null,proxima_sesion:te?`${te.fecha_cita}T${te.hora_inicio}`:null,proxima_cita_id:te?.id||null,total_sesiones:ge||0,estado_emocional_promedio:De,evolucion_porcentaje:ke,requiere_atencion:$e,created_at:B.created_at,bono_activo:k?{tipo:k.tipo,estado:k.estado,fecha_fin:k.fecha_fin,sesiones_completadas:ae,sesiones_totales:xe,sesiones_restantes:k.sesiones_restantes}:null}}));T.value=ue}catch(d){console.error("Error al cargar pacientes:",d),alert("Hubo un error al cargar los pacientes. Por favor, recarga la p√°gina.")}finally{g.value=!1}},I=m(()=>{let d=T.value;if(t.value){const $=t.value.toLowerCase();d=d.filter(ee=>(ee.nombre||"").toLowerCase().includes($)||(ee.email||"").toLowerCase().includes($))}return b.value!=="todos"&&(d=d.filter($=>b.value==="activo"?$.activo&&!$.en_pausa:b.value==="pausa"?$.activo&&$.en_pausa:b.value==="finalizado"?!$.activo:!0)),d}),Q=m(()=>T.value.length),W=d=>{y.push(`/terapeuta/pacientes/${d}`)},Z=()=>{i.value=!0},ie=()=>{i.value=!1},p=d=>{console.log("Abriendo modal de edici√≥n para:",d),A.value=d,z.value=!0},o=()=>{z.value=!1,A.value=null},l=d=>{console.log("Abriendo modal de eliminaci√≥n para:",d),A.value=d,G.value=!0},K=()=>{G.value=!1,A.value=null},R=async d=>{console.log("Nuevo paciente creado:",d),await O()},oe=async d=>{console.log("Paciente actualizado:",d),await O()},C=async d=>{console.log("Paciente eliminado:",d),T.value=T.value.filter($=>$.id!==d)},r=async d=>{console.log("Paciente desactivado:",d),await O()},s=d=>{console.log("Abriendo modal de asignaci√≥n de cita para:",d),N.value=d,J.value=!0},_=()=>{J.value=!1,N.value=null},L=async d=>{console.log("Nueva cita creada:",d),await O(),_()},j=d=>{y.push(`/agenda?paciente=${d.id}`)},D=d=>{y.push(`/terapeuta/pacientes/${d.id}/bonos`)},Me=d=>{console.log("Abriendo modal de edici√≥n de cita:",d),w.value=d,a.value=!0},Ae=()=>{a.value=!1,w.value=null},Be=async()=>{console.log("Cita actualizada, recargando pacientes..."),await O(),Ae()};return Ve(async()=>{console.log("[Pacientes] Componente montado");try{console.log("[Pacientes] Esperando a que el usuario est√© disponible..."),await V();const d=F();console.log("[Pacientes] Usuario despu√©s de waitForUser:",{existe:!!E.value,id:d,email:E.value?.email}),d?(console.log("‚úÖ [Pacientes] Usuario disponible, cargando pacientes..."),await O()):(console.error("‚ùå [Pacientes] No se pudo obtener el usuario autenticado"),g.value=!1)}catch(d){console.error("‚ùå [Pacientes] Error en onMounted:",d),g.value=!1}}),re(()=>F(),(d,$)=>{console.log("[Pacientes] ID de usuario cambi√≥:",{antes:$,ahora:d}),d&&T.value.length===0&&(console.log("[Pacientes] Recargando pacientes por cambio de usuario..."),O())}),(d,$)=>{const ee=Oo,ue=Qe,B=Vt,ve=va,te=Pa,ge=Je;return v(),f("div",null,[$[6]||($[6]=e("header",{class:"mb-8"},[e("h1",{class:"text-3xl font-serif font-bold text-cafe mb-2"}," Pacientes "),e("p",{class:"text-cafe/60"}," Gesti√≥n de pacientes activos ")],-1)),e("section",Fa,[e("div",Ma,[e("div",Ba,[e("div",qa,[e("div",Ia,[S(e("input",{"onUpdate:modelValue":$[0]||($[0]=k=>ze(t)?t.value=k:null),type:"text",placeholder:"Buscar paciente por nombre o email...",class:"w-full px-4 py-3 pl-11 bg-gray-50 border border-gray-200 rounded-lg focus:border-terracota focus:ring-2 focus:ring-terracota/20 focus:bg-white transition-all text-cafe placeholder-gray-400"},null,512),[[H,n(t)]]),M(n(Xe),{class:"w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"})])]),e("div",Ta,[(v(),f(ye,null,we(u,k=>e("button",{key:k.valor,onClick:ae=>b.value=k.valor,class:Y(["px-4 py-2.5 rounded-lg text-sm font-medium transition-all whitespace-nowrap",n(b)===k.valor?"bg-terracota text-white shadow-sm":"bg-gray-50 text-gray-600 hover:bg-gray-100 border border-gray-200"])},c(k.label),11,Va)),64))]),e("button",{onClick:Z,class:"px-6 py-2.5 bg-terracota text-white rounded-lg hover:bg-terracota/90 transition-all flex items-center gap-2 whitespace-nowrap font-medium shadow-sm hover:shadow-md"},[...$[1]||($[1]=[e("span",{class:"text-lg leading-none"},"+",-1),e("span",null,"Nuevo Paciente",-1)])])])])]),e("section",null,[n(g)?(v(),f("div",za,[...$[2]||($[2]=[e("div",{class:"animate-spin w-12 h-12 border-4 border-terracota border-t-transparent rounded-full mb-6"},null,-1),e("p",{class:"text-gray-500 font-medium"},"Cargando pacientes...",-1)])])):n(I).length===0?(v(),f("div",ja,[M(n(Ye),{class:"w-20 h-20 mx-auto mb-6 text-gray-300"}),e("h3",Ua,c(n(t)||n(b)!=="todos"?"No se encontraron pacientes":"A√∫n no tienes pacientes registrados"),1),e("p",La,c(n(t)||n(b)!=="todos"?"Intenta ajustar los filtros de b√∫squeda para encontrar lo que buscas":"Comienza a√±adiendo tu primer paciente para gestionar su proceso terap√©utico"),1),!n(t)&&n(b)==="todos"?(v(),f("button",{key:0,onClick:Z,class:"px-6 py-3 bg-terracota text-white rounded-lg hover:bg-terracota/90 transition-all font-medium shadow-sm hover:shadow-md"}," + A√±adir Primer Paciente ")):P("",!0)])):(v(),f("div",Na,[(v(!0),f(ye,null,we(n(I),k=>(v(),f("div",{key:k.id,class:"relative group cursor-pointer",onClick:ae=>W(k.id)},[M(ee,{paciente:k,onEditar:p,onEliminar:l,onVerCitas:j,onGestionarBonos:D,onEditarCita:Me},null,8,["paciente"]),k.activo&&!k.en_pausa?(v(),f("button",{key:0,onClick:X(ae=>s(k),["stop"]),class:"hidden md:flex absolute bottom-4 right-4 px-3 py-2 bg-gradient-to-r from-terracota to-rosa text-white text-sm font-medium rounded-lg shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-200 items-center gap-2 z-10 opacity-0 group-hover:opacity-100 pointer-events-none group-hover:pointer-events-auto",title:"Asignar nueva cita"},[M(n(Ee),{class:"w-4 h-4"}),$[3]||($[3]=e("span",null,"Asignar Cita",-1))],8,Ra)):P("",!0),k.activo&&!k.en_pausa?(v(),f("button",{key:1,onClick:X(ae=>s(k),["stop"]),class:"md:hidden absolute bottom-4 right-4 px-3 py-2 bg-gradient-to-r from-terracota to-rosa text-white text-sm font-medium rounded-lg shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-200 flex items-center gap-2 z-10",title:"Asignar nueva cita"},[M(n(Ee),{class:"w-4 h-4"}),$[4]||($[4]=e("span",null,"Asignar Cita",-1))],8,Ha)):P("",!0)],8,Oa))),128))])),n(I).length>0?(v(),f("footer",Qa,[e("p",Ga," Mostrando "+c(n(I).length)+" de "+c(n(Q))+" pacientes ",1),n(Q)>n(I).length?(v(),f("div",Ja,[...$[5]||($[5]=[e("button",{class:"px-4 py-2 bg-white border border-gray-200 text-gray-600 rounded-lg hover:bg-gray-50 transition-colors text-sm font-medium"}," Ver m√°s ",-1)])])):P("",!0)])):P("",!0)]),M(ue,{mostrar:n(J),"paciente-preseleccionado":n(N),onCerrar:_,onCitaCreada:L},null,8,["mostrar","paciente-preseleccionado"]),M(B,{mostrar:n(i),onCerrar:ie,onPacienteCreado:R},null,8,["mostrar"]),M(ve,{mostrar:n(z),paciente:n(A),onCerrar:o,onPacienteActualizado:oe},null,8,["mostrar","paciente"]),M(te,{mostrar:n(G),paciente:n(A),onCerrar:K,onPacienteEliminado:C,onPacienteDesactivado:r},null,8,["mostrar","paciente"]),M(ge,{isOpen:n(a),citaId:n(w),onClose:Ae,onActualizado:Be},null,8,["isOpen","citaId"])])}}},_n=be(Ka,[["__scopeId","data-v-da126003"]]);export{_n as default};
