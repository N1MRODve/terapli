import{m as ge,M as Se,r as w,s as R,N as Ee,D as Ae,e as me,c as d,o as c,a,h as S,z as _,t as u,k as x,d as ie,H as de,F as L,x as F,i as ue,b as $e,J as Te}from"#entry";import{_ as fe}from"./DlAUqK2U.js";import{r as je}from"./BqC9m6KG.js";function ze(){const i=ge(),k=Se(),m=w([]),j=w(!1),M=w(null),z=w(null),b=w({});w(new Map);const q=R(()=>{const t=new Date().toISOString().split("T")[0];return m.value.filter(e=>e.fecha_cita===t)}),A=R(()=>m.value.filter(t=>t.estado==="pendiente"||t.estado==="confirmada")),y=R(()=>m.value.filter(t=>t.estado==="completada"||t.estado==="realizada")),G=R(()=>m.value.filter(t=>t.bono&&t.bono.sesiones_restantes<=2&&t.bono.sesiones_restantes>0&&(t.estado==="pendiente"||t.estado==="confirmada"))),O=async t=>{try{if(j.value=!0,M.value=null,!k.value?.id)throw new Error("Usuario no autenticado");let e=i.from("citas").select(`
          id,
          fecha_cita,
          hora_inicio,
          hora_fin,
          estado,
          modalidad,
          observaciones,
          paciente_id,
          terapeuta_id,
          bono_id,
          sesion_descontada,
          consumo_registrado,
          paciente:pacientes (
            id,
            nombre_completo,
            telefono,
            email
          ),
          bono:bonos (
            id,
            sesiones_restantes,
            sesiones_totales,
            estado
          )
        `).eq("terapeuta_id",k.value.id);t?.fechaInicio&&(e=e.gte("fecha_cita",t.fechaInicio)),t?.fechaFin&&(e=e.lte("fecha_cita",t.fechaFin)),t?.incluirCompletadas||(e=e.in("estado",["pendiente","confirmada"])),e=e.order("fecha_cita",{ascending:!0}).order("hora_inicio",{ascending:!0});const{data:r,error:s}=await e;if(s)throw s;return m.value=r||[],console.log(`‚úÖ [Agenda] Cargadas ${m.value.length} citas`),m.value}catch(e){throw console.error("‚ùå [Agenda] Error al cargar citas:",e),M.value=e.message||"Error al cargar citas",e}finally{j.value=!1}},ae=async t=>{try{console.log(`üîÑ [Agenda] Completando cita: ${t}`);const{data:e,error:r}=await i.rpc("completar_cita",{p_cita_id:t});if(r)throw console.error("‚ùå [Agenda] Error en RPC:",r),r;const s=e;if(s.success){console.log("‚úÖ [Agenda] Cita completada exitosamente");const g=m.value.findIndex(f=>f.id===t);if(g!==-1){const f=m.value[g];f&&(f.estado="completada",f.sesion_descontada=!0,f.consumo_registrado=!0,f.bono&&s.sesiones_despues!==void 0&&(f.bono.sesiones_restantes=s.sesiones_despues,s.bono_completado&&(f.bono.estado="completado")))}return s.alerta?H(s):h("success",s.message),await O(),s}else return s.warning?(console.warn("‚ö†Ô∏è [Agenda] Advertencia:",s.message),h("warning",s.message)):(console.error("‚ùå [Agenda] Error:",s.message),h("error",s.message||"No se pudo completar la cita")),s}catch(e){console.error("‚ùå [Agenda] Error al completar cita:",e);const r=e.message||"Error desconocido al completar cita";return h("error",r),{success:!1,message:r,error:e.code||"unknown_error"}}},P=async t=>{try{const{data:e,error:r}=await i.rpc("obtener_historial_bono",{p_bono_id:t});if(r)throw r;return console.log(`‚úÖ [Agenda] Historial de bono obtenido: ${e?.length||0} movimientos`),e||[]}catch(e){throw console.error("‚ùå [Agenda] Error al obtener historial:",e),e}},N=async t=>{try{const{data:e,error:r}=await i.rpc("verificar_bono_citas",{p_bono_id:t});if(r)throw r;return console.log("‚úÖ [Agenda] Verificaci√≥n de bono:",e),e?.alerta&&console.warn("‚ö†Ô∏è [Agenda] Alerta en bono:",e.mensaje_alerta),e}catch(e){throw console.error("‚ùå [Agenda] Error al verificar bono:",e),e}},E=w([]),I=async()=>{try{console.log("üîç [Agenda] Detectando inconsistencias...");const{data:t,error:e}=await i.from("citas").select(`
          id,
          fecha_cita,
          hora_inicio,
          hora_fin,
          estado,
          modalidad,
          observaciones,
          paciente_id,
          terapeuta_id,
          bono_id,
          sesion_descontada,
          consumo_registrado,
          paciente:pacientes (
            id,
            nombre_completo,
            telefono,
            email
          ),
          bono:bonos (
            id,
            sesiones_restantes,
            sesiones_totales,
            estado
          )
        `).in("estado",["completada","realizada"]).not("bono_id","is",null).or("sesion_descontada.eq.false,consumo_registrado.eq.false").eq("terapeuta_id",k.value?.id||"");if(e)throw e;return E.value=t||[],E.value.length>0?console.warn(`‚ö†Ô∏è [Agenda] ${E.value.length} cita(s) con inconsistencias detectadas`):console.log("‚úÖ [Agenda] No se detectaron inconsistencias"),E.value}catch(t){return console.error("‚ùå [Agenda] Error al detectar inconsistencias:",t),E.value=[],[]}},J=async t=>{try{console.log(`üîÑ [Agenda] Re-sincronizando bono para cita: ${t}`);const{data:e,error:r}=await i.rpc("actualizar_bono_por_cita",{p_cita_id:t});if(r)throw r;const s=e;return s.success?(console.log("‚úÖ [Agenda] Bono re-sincronizado exitosamente"),s.warning==="ya_descontada"?h("info","Esta sesi√≥n ya estaba descontada"):(h("success","Bono re-sincronizado correctamente"),s.alerta&&s.mensaje_alerta&&setTimeout(()=>{h("warning",s.mensaje_alerta)},500)),await Promise.all([O(),I()]),s):(console.warn("‚ö†Ô∏è [Agenda] No se pudo re-sincronizar:",s.message),h("warning",s.message||"No se pudo re-sincronizar"),s)}catch(e){throw console.error("‚ùå [Agenda] Error al re-sincronizar bono:",e),h("error","Error al re-sincronizar el bono"),e}},V=async()=>{if(E.value.length===0){h("info","No hay citas pendientes de sincronizaci√≥n");return}try{console.log(`üîÑ [Agenda] Re-sincronizando ${E.value.length} citas...`);let t=0,e=0,r=0;for(const f of E.value)try{const p=await J(f.id);p.success?p.warning==="ya_descontada"?r++:t++:e++,await new Promise(D=>setTimeout(D,300))}catch{e++}const s=[];t>0&&s.push(`${t} sincronizada(s)`),r>0&&s.push(`${r} ya estaba(n) descontada(s)`),e>0&&s.push(`${e} fallida(s)`);const g=`‚úÖ Re-sincronizaci√≥n completa: ${s.join(", ")}`;h(e===0?"success":"warning",g),console.log("‚úÖ [Agenda] Re-sincronizaci√≥n masiva completada:",{exitosos:t,yaDescontados:r,fallidos:e})}catch(t){console.error("‚ùå [Agenda] Error en re-sincronizaci√≥n masiva:",t),h("error","Error al re-sincronizar todas las citas")}},$=()=>{if(!k.value?.id){console.warn("‚ö†Ô∏è [Agenda] No se puede suscribir sin usuario autenticado");return}z.value&&i.removeChannel(z.value),console.log("üì° [Agenda] Iniciando suscripci√≥n Realtime..."),z.value=i.channel(`citas_terapeuta_${k.value.id}`).on("postgres_changes",{event:"*",schema:"public",table:"citas",filter:`terapeuta_id=eq.${k.value.id}`},async t=>{console.log("üì° [Realtime] Cambio detectado en citas:",t.eventType),await O(),t.eventType==="INSERT"?h("info","Nueva cita agregada a tu agenda"):t.eventType==="UPDATE"?h("info","Una cita ha sido actualizada"):t.eventType==="DELETE"&&h("warning","Una cita ha sido eliminada")}).subscribe(t=>{t==="SUBSCRIBED"?console.log("‚úÖ [Realtime] Suscripci√≥n activa"):t==="CHANNEL_ERROR"?console.error("‚ùå [Realtime] Error en suscripci√≥n"):t==="TIMED_OUT"&&console.warn("‚ö†Ô∏è [Realtime] Tiempo de espera agotado")})},U=()=>{z.value&&(console.log("üì° [Realtime] Cerrando suscripci√≥n..."),i.removeChannel(z.value),z.value=null)},h=(t,e)=>{typeof window<"u"&&window.$toast?window.$toast[t](e):console.log(`${{success:"‚úÖ",error:"‚ùå",warning:"‚ö†Ô∏è",info:"‚ÑπÔ∏è"}[t]} [Agenda] ${e}`)},H=t=>{if(!t.alerta||!t.mensaje_alerta)return;const e=t.tipo_alerta==="bono_agotado"?"success":(t.tipo_alerta==="ultima_sesion","warning");h(e,t.mensaje_alerta)};Ee(()=>{k.value?.id&&(O(),$())}),Ae(()=>{U()});const oe=R(()=>{let t=m.value;if(b.value.paciente&&(t=t.filter(e=>e.paciente?.nombre_completo.toLowerCase().includes(b.value.paciente.toLowerCase()))),b.value.busqueda){const e=b.value.busqueda.toLowerCase();t=t.filter(r=>r.paciente?.nombre_completo.toLowerCase().includes(e)||r.observaciones?.toLowerCase().includes(e)||r.fecha_cita.includes(e))}return b.value.estado&&b.value.estado.length>0&&(t=t.filter(e=>b.value.estado.includes(e.estado))),b.value.area_terapeutica&&(t=t.filter(e=>e.area_terapeutica===b.value.area_terapeutica)),b.value.tipo_sesion&&b.value.tipo_sesion.length>0&&(t=t.filter(e=>e.tipo_sesion&&b.value.tipo_sesion.includes(e.tipo_sesion))),b.value.fecha_desde&&(t=t.filter(e=>e.fecha_cita>=b.value.fecha_desde)),b.value.fecha_hasta&&(t=t.filter(e=>e.fecha_cita<=b.value.fecha_hasta)),t}),Q=t=>{b.value={...t}},X=()=>{b.value={}},Z=async(t,e,r,s)=>{try{j.value=!0;const{data:g,error:f}=await i.from("citas").update({fecha_cita:e,hora_inicio:r,hora_fin:s||r,updated_at:new Date().toISOString()}).eq("id",t).select().single();if(f)throw f;const p=m.value.findIndex(D=>D.id===t);return p!==-1&&g&&(m.value[p]={...m.value[p],...g}),{success:!0,cita:g}}catch(g){return console.error("Error al reprogramar cita:",g),{success:!1,error:g.message}}finally{j.value=!1}},Y=async(t,e,r)=>{try{const{data:s,error:g}=await i.from("citas").update({notas_rapidas:e,enlace_videollamada:r,updated_at:new Date().toISOString()}).eq("id",t).select().single();if(g)throw g;const f=m.value.findIndex(p=>p.id===t);return f!==-1&&s&&(m.value[f]={...m.value[f],...s}),{success:!0}}catch(s){return console.error("Error al actualizar notas:",s),{success:!1,error:s.message}}},ee=async t=>{try{const e=t||k.value?.id;if(!e)throw new Error("ID de terapeuta requerido");const{data:r,error:s}=await i.from("terapeutas").select("disponibilidad").eq("id",e).single();if(s)throw s;return r?.disponibilidad||[]}catch(e){return console.error("Error al obtener disponibilidad:",e),[]}},se=(t,e)=>{const r=new Date(t+"T00:00:00").getDay(),s=m.value.filter(p=>p.fecha_cita===t),g=e.filter(p=>p.dia_semana===r&&p.disponible);if(g.length===0)return[];const f=[];return g.forEach(p=>{const D=p.hora_inicio,W=p.hora_fin;s.some(o=>o.hora_inicio>=D&&o.hora_inicio<W||o.hora_fin>D&&o.hora_fin<=W||o.hora_inicio<=D&&o.hora_fin>=W)||f.push({hora_inicio:D,hora_fin:W})}),f},re=async t=>{try{const e=m.value.find(p=>p.id===t);if(!e||!e.paciente)return{success:!1,error:"Cita no encontrada"};const r=new Date(e.fecha_cita+"T"+e.hora_inicio),s=new Date;return new Date(r.getTime()-1440*60*1e3)>s&&!e.recordatorio_24h_enviado&&(await i.from("notificaciones").insert({usuario_id:e.paciente_id,tipo:"cita",titulo:"üìÖ Recordatorio: Cita ma√±ana",mensaje:`Tu cita est√° programada para ma√±ana ${e.fecha_cita} a las ${e.hora_inicio}`,metadata:{cita_id:t,tipo_recordatorio:"24h",fecha_cita:e.fecha_cita,hora:e.hora_inicio}}),await i.from("citas").update({recordatorio_24h_enviado:!0}).eq("id",t)),new Date(r.getTime()-14400*1e3)>s&&!e.recordatorio_4h_enviado&&(await i.from("notificaciones").insert({usuario_id:e.paciente_id,tipo:"cita",titulo:"‚è∞ Recordatorio: Cita en 4 horas",mensaje:`Tu cita est√° programada para hoy ${e.fecha_cita} a las ${e.hora_inicio}`,metadata:{cita_id:t,tipo_recordatorio:"4h",fecha_cita:e.fecha_cita,hora:e.hora_inicio,enlace_videollamada:e.enlace_videollamada}}),await i.from("citas").update({recordatorio_4h_enviado:!0}).eq("id",t)),{success:!0}}catch(e){return console.error("Error al programar recordatorios:",e),{success:!1,error:e.message}}},K=(t,e)=>{const r=m.value.filter(s=>{const g=s.fecha_cita===t,f=e?s.terapeuta_id===e:!0,p=["pendiente","confirmada"].includes(s.estado);return g&&f&&p});return{total:r.length,confirmadas:r.filter(s=>s.estado==="confirmada").length,pendientes:r.filter(s=>s.estado==="pendiente").length}};return{citas:m,loading:j,error:M,filtros:b,citasDelDia:q,citasPendientes:A,citasCompletadas:y,citasConBonoProximoAgotar:G,citasFiltradas:oe,getCitasDelTerapeuta:O,completarCita:ae,obtenerHistorialBono:P,verificarBonoCitas:N,citasPendientesSync:E,detectarInconsistencias:I,resincronizarBono:J,resincronizarTodos:V,aplicarFiltros:Q,limpiarFiltros:X,reprogramarCita:Z,actualizarNotasRapidas:Y,obtenerDisponibilidad:ee,calcularHuecosLibres:se,programarRecordatorios:re,calcularCargaDiaria:K,obtenerResumenSemanal:t=>{const e=new Date(t+"T00:00:00"),r=[];for(let s=0;s<7;s++){const g=new Date(e);g.setDate(e.getDate()+s);const f=g.toISOString().split("T")[0]||"";if(!f)continue;const p=K(f);r.push({fecha:f,dia:g.toLocaleDateString("es-ES",{weekday:"short"}),citas:p.total,confirmadas:p.confirmadas,pendientes:p.pendientes})}return r},obtenerResumenMensual:(t,e)=>{const r=new Date(t,e+1,0),s=new Map;for(let g=1;g<=r.getDate();g++){const p=new Date(t,e,g).toISOString().split("T")[0]||"";if(!p)continue;const D=K(p);s.set(p,{dia:g,citas:D.total,confirmadas:D.confirmadas,pendientes:D.pendientes})}return s},suscribirCitasRealtime:$,desuscribirCitasRealtime:U}}const Be={class:"flex items-start justify-between gap-4"},Re={class:"flex-1 min-w-0"},Me={class:"flex items-center gap-3 mb-2 flex-wrap"},He={class:"flex items-center gap-2"},Ne={class:"truncate"},Oe={key:0,class:"text-gray-400"},Le={key:1,class:"capitalize truncate"},Fe={key:0,class:"flex items-center gap-2"},qe={class:"truncate"},Pe={class:"flex items-center justify-between gap-2"},Ie={class:"flex-1 min-w-0"},Ve={class:"text-xs font-medium text-gray-700 mb-1"},Ue={class:"flex items-center gap-2 flex-wrap"},We={class:"text-xs text-gray-500 capitalize"},Ge={key:1,class:"mt-3 p-3 bg-gray-50 border border-gray-200 rounded-lg"},Je={key:2,class:"mt-3 p-2 bg-gray-50 rounded text-xs text-gray-700"},Ye={class:"flex flex-col gap-2"},Ke=me({__name:"TarjetaCita",props:{cita:{},compact:{type:Boolean}},emits:["completar","verHistorial"],setup(i,{emit:k}){const m=i,j=k,M=A=>A.substring(0,5),z=R(()=>{const A=m.cita.estado;return{pendiente:"bg-yellow-100 text-yellow-800 border-yellow-300",confirmada:"bg-blue-100 text-blue-800 border-blue-300",completada:"bg-green-100 text-green-800 border-green-300",realizada:"bg-green-100 text-green-800 border-green-300",cancelada:"bg-red-100 text-red-800 border-red-300"}[A]||"bg-gray-100 text-gray-800 border-gray-300"}),b=R(()=>{if(!m.cita.bono)return null;const A=m.cita.bono.sesiones_restantes,y=m.cita.bono.estado;return y==="completado"||A===0?{color:"text-red-600",icono:"üö´",alerta:!0,mensajeAlerta:"Bono agotado",clase:"bg-red-50 border-red-200"}:A===1?{color:"text-orange-600",icono:"‚ö†Ô∏è",alerta:!0,mensajeAlerta:"√öltima sesi√≥n del bono",clase:"bg-orange-50 border-orange-200"}:A<=2?{color:"text-yellow-600",icono:"‚ö†Ô∏è",alerta:!0,mensajeAlerta:"Pocas sesiones restantes",clase:"bg-yellow-50 border-yellow-200"}:y==="activo"?{color:"text-green-600",icono:"‚úì",alerta:!1,mensajeAlerta:null,clase:"bg-green-50 border-green-200"}:{color:"text-gray-600",icono:"‚ÑπÔ∏è",alerta:!1,mensajeAlerta:null,clase:"bg-gray-50 border-gray-200"}}),q=R(()=>m.cita.estado==="pendiente"||m.cita.estado==="confirmada");return(A,y)=>(c(),d("div",{class:_(["border rounded-xl shadow-sm hover:shadow-md transition-all duration-200 bg-white overflow-hidden",i.compact?"p-3":"p-5"])},[a("div",Be,[a("div",Re,[a("div",Me,[a("h3",{class:_([i.compact?"text-base":"text-lg","font-semibold text-gray-900 truncate"])},u(i.cita.paciente?.nombre_completo||"Paciente"),3),a("span",{class:_(["px-3 py-1 text-xs font-medium rounded-full border",x(z)])},u(i.cita.estado.toUpperCase()),3)]),a("div",{class:_(["space-y-1",i.compact?"text-xs":"text-sm","text-gray-600"])},[a("div",He,[y[2]||(y[2]=a("svg",{class:"h-4 w-4 flex-shrink-0",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)),a("span",Ne,u(M(i.cita.hora_inicio))+" - "+u(M(i.cita.hora_fin)),1),i.cita.modalidad?(c(),d("span",Oe,"‚Ä¢")):S("",!0),i.cita.modalidad?(c(),d("span",Le,u(i.cita.modalidad),1)):S("",!0)]),i.cita.paciente?.telefono&&!i.compact?(c(),d("div",Fe,[y[3]||(y[3]=a("svg",{class:"h-4 w-4 flex-shrink-0",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"})],-1)),a("span",qe,u(i.cita.paciente.telefono),1)])):S("",!0)],2),i.cita.bono?(c(),d("div",{key:0,class:_(["mt-3 p-3 rounded-lg border",x(b)?.clase||"bg-gray-50 border-gray-200"])},[a("div",Pe,[a("div",Ie,[a("p",Ve,u(x(b)?.icono)+" Bono de Sesiones ",1),a("div",Ue,[a("p",{class:_(["text-sm font-semibold",x(b)?.color||"text-gray-900"])},u(i.cita.bono.sesiones_restantes)+" / "+u(i.cita.bono.sesiones_totales)+" sesiones ",3),a("span",We," ("+u(i.cita.bono.estado)+") ",1)]),x(b)?.alerta?(c(),d("p",{key:0,class:_(["mt-2 text-xs font-medium",x(b).color])},u(x(b).mensajeAlerta),3)):S("",!0)]),i.compact?S("",!0):(c(),d("button",{key:0,onClick:y[0]||(y[0]=G=>j("verHistorial",i.cita.bono.id)),class:"text-xs text-blue-600 hover:text-blue-800 font-medium whitespace-nowrap px-2 py-1 hover:bg-blue-50 rounded transition-colors",type:"button"}," üìä Historial "))])],2)):(c(),d("div",Ge,[...y[4]||(y[4]=[a("p",{class:"text-xs text-gray-500 italic flex items-center gap-2"},[a("svg",{class:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})]),ie(" Sin bono activo - Consulta individual ")],-1)])])),i.cita.observaciones&&!i.compact?(c(),d("div",Je,[y[5]||(y[5]=a("p",{class:"font-medium text-gray-500 mb-1"},"Observaciones:",-1)),ie(" "+u(i.cita.observaciones),1)])):S("",!0)]),a("div",Ye,[x(q)?(c(),d("button",{key:0,onClick:y[1]||(y[1]=G=>j("completar",i.cita.id)),class:_(["px-4 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition-colors",i.compact?"text-xs":"text-sm"]),type:"button"}," ‚úÖ Completar ",2)):i.cita.estado==="completada"||i.cita.estado==="realizada"?(c(),d("span",{key:1,class:_(["px-4 py-2 bg-green-100 text-green-800 font-medium rounded-lg text-center",i.compact?"text-xs":"text-sm"])}," ‚úì Completada ",2)):S("",!0)])])],2))}}),Qe=Object.assign(fe(Ke,[["__scopeId","data-v-3085384e"]]),{__name:"TarjetaCita"}),Xe={class:"agenda-terapeuta p-6 max-w-7xl mx-auto"},Ze={class:"flex items-center justify-between mb-6"},et={class:"flex items-center gap-2"},tt={class:"flex bg-gray-100 rounded-lg p-0.5"},at={key:0,class:"flex items-center gap-1 ml-2"},ot=["disabled"],st={key:0},rt={key:1},nt={key:0,class:"bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6"},it={class:"flex"},lt={class:"ml-3"},ct={class:"text-sm text-yellow-700"},dt={key:1,class:"bg-white rounded-lg shadow-sm border border-gray-100 overflow-hidden flex flex-col",style:{height:"calc(100vh - 280px)"}},ut={class:"min-w-[800px] overflow-x-auto flex-1 flex flex-col"},gt={class:"sticky top-0 z-10 bg-white border-b border-gray-200 shadow-sm"},mt={class:"grid grid-cols-8"},ft={class:"flex items-center justify-center gap-1"},pt={class:"text-xs font-medium text-gray-600 uppercase"},bt={class:"text-xs text-gray-500"},ht={class:"flex-1 overflow-y-auto"},vt={class:"divide-y divide-gray-100"},yt=["data-hora"],xt={class:"p-3 text-sm font-medium text-gray-600 border-r border-gray-100 bg-gray-50 sticky left-0"},_t=["onDragover","onDrop"],wt={key:0,class:"absolute inset-0 flex items-center justify-center opacity-0 group-hover/cell:opacity-100 transition-opacity pointer-events-none"},kt=["onDragstart"],Dt={class:"opacity-0 group-hover:opacity-100 transition-opacity absolute top-1 left-1"},Ct={class:"pl-5"},St={class:"font-semibold truncate text-sm"},Et={class:"text-xs text-gray-600 mt-0.5"},At={class:"flex items-center gap-1 mt-1"},$t={class:"text-xs px-1.5 py-0.5 rounded-full bg-white/60"},Tt={key:0,class:"text-xs text-green-700"},jt={key:2},zt={class:"flex flex-wrap gap-2 mb-6"},Bt=["onClick"],Rt={key:0,class:"bg-red-50 border-l-4 border-red-400 p-4 mb-6"},Mt={class:"text-red-700"},Ht={key:1,class:"text-center py-12"},Nt={key:2,class:"text-center py-12 bg-gray-50 rounded-lg"},Ot={class:"mt-1 text-sm text-gray-500"},Lt={key:3,class:"space-y-4"},Ft={class:"bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-hidden"},qt={class:"px-6 py-4 overflow-y-auto max-h-[calc(90vh-140px)]"},Pt={key:0,class:"text-center py-8"},It={key:1},Vt={key:0,class:"mb-6 p-4 bg-blue-50 rounded-lg"},Ut={class:"grid grid-cols-3 gap-4 text-center"},Wt={class:"text-2xl font-bold text-blue-600"},Gt={class:"text-2xl font-bold text-green-600"},Jt={key:0,class:"mt-3 p-2 bg-yellow-100 border border-yellow-300 rounded text-sm text-yellow-800"},Yt={key:0,class:"text-center py-8 text-gray-500"},Kt={key:1,class:"space-y-3"},Qt={class:"flex items-start justify-between"},Xt={class:"flex-1"},Zt={class:"flex items-center gap-2 mb-1"},ea={class:"text-xs text-gray-500"},ta={class:"text-sm text-gray-700"},aa={class:"text-right ml-4"},oa={class:"text-sm font-semibold text-gray-900"},sa=me({__name:"AgendaTerapeuta",setup(i){const{citas:k,loading:m,error:j,citasDelDia:M,citasPendientes:z,citasCompletadas:b,citasConBonoProximoAgotar:q,completarCita:A,getCitasDelTerapeuta:y,obtenerHistorialBono:G,verificarBonoCitas:O}=ze(),ae=ge(),P=w("hoy"),N=w("calendario"),E=w(new Date),I=w(!1),J=w(null),V=w([]),$=w(null),U=w(!1),h=w(null),H=w(null),oe=["11:00","12:00","13:00","17:00","18:00","19:00","20:00","21:00","22:00"],Q=R(()=>{const l=new Date(E.value),o=l.getDay(),T=o===0?-6:1-o;l.setDate(l.getDate()+T);const n=[];for(let C=0;C<7;C++){const v=new Date(l);v.setDate(l.getDate()+C),n.push({fecha:v.toISOString().split("T")[0],nombreDia:v.toLocaleDateString("es-ES",{weekday:"short"}),numeroDia:v.getDate(),mes:v.toLocaleDateString("es-ES",{month:"short"})})}return n}),X=R(()=>{switch(P.value){case"hoy":return M.value;case"pendientes":return z.value;case"completadas":return b.value;default:return k.value}}),Z=l=>l.substring(0,5),Y=l=>{const o=new Date().toISOString().split("T")[0];return l===o},ee=l=>{const o=new Date(E.value);o.setDate(o.getDate()+l*7),E.value=o},se=()=>{E.value=new Date},re=l=>({pendiente:"bg-yellow-100 border-l-4 border-yellow-500",confirmada:"bg-green-100 border-l-4 border-green-500",completada:"bg-blue-100 border-l-4 border-blue-500",realizada:"bg-blue-100 border-l-4 border-blue-500",cancelada:"bg-red-100 border-l-4 border-red-500"})[l]||"bg-gray-100 border-l-4 border-gray-500",K=l=>l===0?"text-red-600 font-bold":l===1?"text-orange-600 font-semibold":l<=2?"text-yellow-600 font-medium":"text-green-600",ne=(l,o)=>k.value.filter(T=>T.fecha_cita===l&&T.hora_inicio?.startsWith(o)),le=(l,o)=>{h.value=o,l.dataTransfer&&(l.dataTransfer.effectAllowed="move",l.dataTransfer.setData("text/html",l.target.innerHTML)),l.target.style.opacity="0.5"},t=l=>{l.target.style.opacity="1",h.value=null,H.value=null},e=(l,o,T)=>{l.preventDefault(),l.dataTransfer&&(l.dataTransfer.dropEffect="move"),H.value={fecha:o,hora:T}},r=l=>{H.value=null},s=(l,o)=>H.value?.fecha===l&&H.value?.hora===o,g=async(l,o,T)=>{if(l.preventDefault(),!h.value)return;const n=h.value,C=o,v=T;if(k.value.find(B=>B.fecha_cita===C&&B.hora_inicio?.startsWith(v)&&B.id!==n.id)){alert("Ya existe una cita en ese horario"),h.value=null,H.value=null;return}const pe=((B,be)=>{const[he,ve]=B.split(":").map(Number),[ye,xe]=be.split(":").map(Number),[_e,we]=n.hora_inicio.split(":").map(Number),ke=(ye||0)*60+(xe||0)-((_e||0)*60+(we||0)),ce=(he||0)*60+(ve||0)+ke,De=Math.floor(ce/60),Ce=ce%60;return`${String(De).padStart(2,"0")}:${String(Ce).padStart(2,"0")}:00`})(v,n.hora_fin);try{const{error:B}=await ae.from("citas").update({fecha_cita:C,hora_inicio:v+":00",hora_fin:pe,updated_at:new Date().toISOString()}).eq("id",n.id);if(B){console.error("Error al mover cita:",B),alert("Error al mover la cita");return}await y()}catch(B){console.error("Error al mover cita:",B),alert("Error al mover la cita")}finally{h.value=null,H.value=null}},f=async l=>{if(confirm("¬øEst√°s seguro de marcar esta cita como completada?"))try{(await A(l)).success&&console.log("Cita completada")}catch(o){console.error("Error al completar cita:",o)}},p=async l=>{try{U.value=!0,J.value=l,I.value=!0;const[o,T]=await Promise.all([G(l),O(l)]);V.value=o,$.value=T}catch(o){console.error("Error al cargar historial:",o)}finally{U.value=!1}},D=()=>{I.value=!1,J.value=null,V.value=[],$.value=null},W=async()=>{try{await y()}catch(l){console.error("Error al recargar citas:",l)}};return(l,o)=>{const T=Qe;return c(),d("div",Xe,[a("div",Ze,[o[7]||(o[7]=a("div",null,[a("h1",{class:"text-3xl font-bold text-gray-900 mb-2"},"Mi Agenda"),a("p",{class:"text-gray-600"},"Gestiona tus citas y sesiones")],-1)),a("div",et,[a("div",tt,[a("button",{onClick:o[0]||(o[0]=n=>N.value="calendario"),class:_(["px-3 py-1.5 rounded text-sm font-medium transition-colors",N.value==="calendario"?"bg-white text-gray-900 shadow-sm":"text-gray-600 hover:text-gray-900"])}," Calendario ",2),a("button",{onClick:o[1]||(o[1]=n=>N.value="lista"),class:_(["px-3 py-1.5 rounded text-sm font-medium transition-colors",N.value==="lista"?"bg-white text-gray-900 shadow-sm":"text-gray-600 hover:text-gray-900"])}," Lista ",2)]),N.value==="calendario"?(c(),d("div",at,[a("button",{onClick:o[2]||(o[2]=n=>ee(-1)),class:"p-2 rounded hover:bg-gray-100 text-gray-900",title:"Semana anterior"}," ‚Üê "),a("button",{onClick:se,class:"px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded text-sm font-medium text-gray-900 transition-colors"}," Hoy "),a("button",{onClick:o[3]||(o[3]=n=>ee(1)),class:"p-2 rounded hover:bg-gray-100 text-gray-900",title:"Semana siguiente"}," ‚Üí ")])):S("",!0),a("button",{onClick:W,class:"px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors",disabled:x(m)},[x(m)?(c(),d("span",st,"Cargando...")):(c(),d("span",rt,"Actualizar"))],8,ot)])]),x(q).length>0?(c(),d("div",nt,[a("div",it,[o[9]||(o[9]=a("div",{class:"flex-shrink-0"},[a("svg",{class:"h-5 w-5 text-yellow-400",fill:"currentColor",viewBox:"0 0 20 20"},[a("path",{"fill-rule":"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"})])],-1)),a("div",lt,[a("p",ct,[o[8]||(o[8]=a("strong",null,"Atenci√≥n:",-1)),ie(" "+u(x(q).length)+" paciente(s) con pocas sesiones restantes ",1)])])])])):S("",!0),N.value==="calendario"?(c(),d("div",dt,[a("div",ut,[a("div",gt,[a("div",mt,[o[10]||(o[10]=a("div",{class:"p-2 border-r border-gray-200 bg-gray-50"},null,-1)),(c(!0),d(L,null,F(Q.value,n=>(c(),d("div",{key:n.fecha,class:_(["p-2 text-center border-r border-gray-200 last:border-r-0",Y(n.fecha)?"bg-blue-50":"bg-white"])},[a("div",ft,[a("span",pt,u(n.nombreDia),1),a("span",{class:_(["text-lg font-bold text-gray-900",Y(n.fecha)?"text-blue-600":""])},u(n.numeroDia),3)]),a("div",bt,u(n.mes),1)],2))),128))])]),a("div",ht,[a("div",vt,[(c(),d(L,null,F(oe,n=>a("div",{key:n,"data-hora":n,class:"grid grid-cols-8"},[a("div",xt,u(n),1),(c(!0),d(L,null,F(Q.value,C=>(c(),d("div",{key:`${C.fecha}-${n}`,class:_(["p-2 border-r border-gray-100 last:border-r-0 hover:bg-blue-50/30 transition-colors min-h-[70px] cursor-pointer relative group/cell",[Y(C.fecha)?"bg-blue-50/20":"",s(C.fecha,n)?"bg-blue-100 ring-2 ring-blue-500 ring-inset":""]]),onDragover:v=>e(v,C.fecha,n),onDragleave:o[6]||(o[6]=v=>r()),onDrop:v=>g(v,C.fecha,n)},[ne(C.fecha,n).length===0?(c(),d("div",wt,[...o[11]||(o[11]=[a("span",{class:"text-xs text-blue-600 font-medium bg-white px-2 py-1 rounded-full shadow-sm"}," Libre ",-1)])])):S("",!0),(c(!0),d(L,null,F(ne(C.fecha,n),v=>(c(),d("div",{key:v.id,draggable:"true",onDragstart:te=>le(te,v),onDragend:o[4]||(o[4]=te=>t(te)),class:_(["text-xs p-2 rounded-lg mb-1.5 hover:shadow-lg hover:ring-2 hover:ring-blue-400 transition-all group relative cursor-move",re(v.estado)]),onClick:o[5]||(o[5]=ue(()=>{},["stop"])),title:"Arrastra para mover"},[a("div",Dt,[$e(x(je),{class:"w-3 h-3 text-gray-500"})]),a("div",Ct,[a("p",St,u(v.paciente?.nombre_completo||"Sin nombre"),1),a("p",Et,u(Z(v.hora_inicio))+" - "+u(Z(v.hora_fin)),1),a("div",At,[a("span",$t,u(v.modalidad),1),v.bono?(c(),d("span",Tt," Bono ")):S("",!0)])])],42,kt))),128))],42,_t))),128))],8,yt)),64))])])])])):(c(),d("div",jt,[a("div",zt,[(c(!0),d(L,null,F([{key:"hoy",label:"Hoy",count:x(M).length},{key:"pendientes",label:"Pendientes",count:x(z).length},{key:"completadas",label:"Completadas",count:x(b).length},{key:"todas",label:"Todas",count:x(k).length}],n=>(c(),d("button",{key:n.key,onClick:C=>P.value=n.key,class:_(["px-4 py-2 rounded-lg font-medium transition-colors",P.value===n.key?"bg-blue-600 text-white":"bg-white text-gray-700 hover:bg-gray-50 border border-gray-300"])},u(n.label)+" ("+u(n.count)+") ",11,Bt))),128))]),x(j)?(c(),d("div",Rt,[a("p",Mt,u(x(j)),1)])):S("",!0),x(m)&&x(k).length===0?(c(),d("div",Ht,[...o[12]||(o[12]=[a("div",{class:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"},null,-1),a("p",{class:"text-gray-600"},"Cargando citas...",-1)])])):X.value.length===0?(c(),d("div",Nt,[o[13]||(o[13]=a("svg",{class:"mx-auto h-12 w-12 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"})],-1)),o[14]||(o[14]=a("h3",{class:"mt-2 text-sm font-medium text-gray-900"},"No hay citas",-1)),a("p",Ot,u(P.value==="hoy"?"No tienes citas programadas para hoy.":"No hay citas en esta categor√≠a."),1)])):(c(),d("div",Lt,[(c(!0),d(L,null,F(X.value,n=>(c(),de(T,{key:n.id,cita:n,onCompletar:f,onVerHistorial:p},null,8,["cita"]))),128))]))])),(c(),de(Te,{to:"body"},[I.value?(c(),d("div",{key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",onClick:ue(D,["self"])},[a("div",Ft,[a("div",{class:"px-6 py-4 border-b border-gray-200 flex items-center justify-between"},[o[16]||(o[16]=a("h2",{class:"text-xl font-bold text-gray-900"},"Historial del Bono",-1)),a("button",{onClick:D,class:"text-gray-400 hover:text-gray-600 transition-colors"},[...o[15]||(o[15]=[a("svg",{class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),a("div",qt,[U.value?(c(),d("div",Pt,[...o[17]||(o[17]=[a("div",{class:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"},null,-1)])])):(c(),d("div",It,[$.value?(c(),d("div",Vt,[o[21]||(o[21]=a("h3",{class:"font-semibold text-gray-900 mb-3"},"Resumen",-1)),a("div",Ut,[a("div",null,[a("p",Wt,u($.value.bono.sesiones_totales),1),o[18]||(o[18]=a("p",{class:"text-xs text-gray-600"},"Sesiones Totales",-1))]),a("div",null,[a("p",Gt,u($.value.bono.sesiones_usadas),1),o[19]||(o[19]=a("p",{class:"text-xs text-gray-600"},"Sesiones Usadas",-1))]),a("div",null,[a("p",{class:_(["text-2xl font-bold",K($.value.bono.sesiones_restantes)])},u($.value.bono.sesiones_restantes),3),o[20]||(o[20]=a("p",{class:"text-xs text-gray-600"},"Sesiones Restantes",-1))])]),$.value.alerta?(c(),d("div",Jt,u($.value.mensaje_alerta),1)):S("",!0)])):S("",!0),a("div",null,[o[22]||(o[22]=a("h3",{class:"font-semibold text-gray-900 mb-3"},"Movimientos",-1)),V.value.length===0?(c(),d("div",Yt," No hay movimientos registrados ")):(c(),d("div",Kt,[(c(!0),d(L,null,F(V.value,n=>(c(),d("div",{key:n.id,class:"border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors"},[a("div",Qt,[a("div",Xt,[a("div",Zt,[a("span",{class:_(["px-2 py-1 text-xs font-medium rounded",n.tipo_movimiento==="descuento"?"bg-red-100 text-red-700":n.tipo_movimiento==="reembolso"?"bg-green-100 text-green-700":"bg-gray-100 text-gray-700"])},u(n.tipo_movimiento),3),a("span",ea,u(new Date(n.fecha).toLocaleString("es-ES")),1)]),a("p",ta,u(n.motivo),1)]),a("div",aa,[a("p",oa,u(n.sesiones_antes)+" ‚Üí "+u(n.sesiones_despues),1),a("p",{class:_(["text-xs font-medium",n.sesiones_modificadas>0?"text-red-600":"text-green-600"])},u(n.sesiones_modificadas>0?"-":"+")+u(Math.abs(n.sesiones_modificadas)),3)])])]))),128))]))])]))]),a("div",{class:"px-6 py-4 border-t border-gray-200 flex justify-end"},[a("button",{onClick:D,class:"px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors"}," Cerrar ")])])])):S("",!0)]))])}}}),ca=Object.assign(fe(sa,[["__scopeId","data-v-37d8b05d"]]),{__name:"AgendaTerapeuta"});export{ca as _,Qe as a,ze as u};
