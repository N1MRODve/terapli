import{e as S,c as u,o as i,a as e,t as w,g as M,y as D,r as y,q as z,j as R,v as K,A as O,i as P,D as B,J as H,B as N,f as Y,C as J,k as h,F as L,s as T,h as G,E as V}from"#entry";import{_ as U}from"./DlAUqK2U.js";import{u as Q}from"./Cy0_MzJF.js";import{u as W}from"./C9M7zbam.js";const X={class:"text-[#5D4A44] font-['Lato'] text-sm leading-relaxed whitespace-pre-wrap break-words"},Z={class:"text-[10px] text-[#5D4A44]/50 font-['Lato']"},ee={key:0,class:"inline-block w-2 h-2 bg-[#D8AFA0] rounded-full",title:"Enviado"},te=S({__name:"MensajeCard",props:{texto:{},fecha:{},remitente:{type:Boolean},visto:{type:Boolean,default:!1}},setup(d){const t=v=>{const g=typeof v=="string"?new Date(v):v,p=new Date,s=p.getTime()-g.getTime(),l=Math.floor(s/6e4),x=Math.floor(s/36e5),j=Math.floor(s/864e5);return l<1?"Ahora":l<60?`Hace ${l}m`:x<24?`Hace ${x}h`:j<7?`Hace ${j}d`:g.toLocaleDateString("es-ES",{day:"2-digit",month:"short",year:g.getFullYear()!==p.getFullYear()?"numeric":void 0})};return(v,g)=>(i(),u("div",{class:D(["p-4 rounded-lg max-w-[80%] transition-all duration-200",d.remitente?"bg-[#EAD5D3]/50 self-end text-right ml-auto":"bg-white border border-[#EAD5D3]/40 self-start shadow-sm"])},[e("p",X,w(d.texto),1),e("div",{class:D(["flex items-center gap-2 mt-2",d.remitente?"justify-end":"justify-start"])},[e("p",Z,w(t(d.fecha)),1),d.remitente&&!d.visto?(i(),u("span",ee)):M("",!0)],2)],2))}}),se=Object.assign(U(te,[["__scopeId","data-v-0713e701"]]),{__name:"MensajeCard"}),oe={class:"flex items-end gap-3 border-t border-[#EAD5D3]/30 pt-4 bg-[#F9F7F3]"},ae={class:"flex-1 relative"},re=["placeholder","onKeydown","disabled"],ne={key:0,class:"absolute bottom-2 right-2 text-[10px] text-[#5D4A44]/40 font-['Lato']"},ie=["disabled"],le={key:0,class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},ue={key:1},de={key:2},ce=S({__name:"MensajeInput",props:{destinatarioId:{},placeholder:{default:"Escribe tu mensaje aquí..."}},emits:["mensajeEnviado"],setup(d,{emit:t}){const v=d,g=t,{enviarMensaje:p}=useMensajeria(),s=y(""),l=y(!1),x=y(null),j=z(()=>{const c=s.value.trim();return c.length>0&&c.length<=2e3&&!l.value}),k=()=>{B(()=>{x.value&&(x.value.style.height="auto",x.value.style.height=`${Math.min(x.value.scrollHeight,120)}px`)})},E=async()=>{if(!j.value)return;l.value=!0;const c=s.value.trim();try{if(!await p(v.destinatarioId,c))throw new Error("No se pudo enviar el mensaje");s.value="",x.value&&(x.value.style.height="auto"),g("mensajeEnviado")}catch(b){console.error("Error al enviar mensaje:",b)}finally{l.value=!1}};return(c,b)=>(i(),u("div",oe,[e("div",ae,[R(e("textarea",{ref_key:"textareaRef",ref:x,"onUpdate:modelValue":b[0]||(b[0]=C=>s.value=C),placeholder:d.placeholder,onKeydown:O(P(E,["exact","prevent"]),["enter"]),onInput:k,class:D(["w-full border border-[#EAD5D3]/40 rounded-lg p-3 bg-white resize-none text-sm text-[#5D4A44] font-['Lato'] focus:outline-none focus:ring-2 focus:ring-[#D8AFA0]/50 focus:border-[#D8AFA0] transition-all",{"opacity-50 cursor-not-allowed":l.value}]),disabled:l.value,rows:"1",style:{"min-height":"44px","max-height":"120px"}},null,42,re),[[K,s.value]]),s.value.length>0?(i(),u("div",ne,w(s.value.length)+"/2000 ",1)):M("",!0)]),e("button",{onClick:E,disabled:!j.value||l.value,class:D(["bg-[#D8AFA0] hover:bg-[#C89B8A] text-white px-5 py-3 rounded-lg transition-all duration-200 font-['Lato'] text-sm font-medium disabled:opacity-40 disabled:cursor-not-allowed flex items-center gap-2 shadow-sm hover:shadow-md",{"animate-pulse":l.value}])},[l.value?M("",!0):(i(),u("svg",le,[...b[1]||(b[1]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"},null,-1)])])),l.value?(i(),u("span",de,"Enviando...")):(i(),u("span",ue,"Enviar"))],10,ie)]))}}),me=Object.assign(U(ce,[["__scopeId","data-v-624391a0"]]),{__name:"MensajeInput"}),fe=()=>{const d=Q(),t=H(),v=y([]),g=y([]),p=y(!1),s=y(null),l=y(null),x=async o=>{if(!t.value)return s.value="Usuario no autenticado",[];p.value=!0,s.value=null;try{const{data:a,error:m}=await d.from("mensajes").select(`
          *,
          remitente:profiles!mensajes_remitente_id_fkey(id, nombre, avatar_url, rol),
          destinatario:profiles!mensajes_destinatario_id_fkey(id, nombre, avatar_url, rol)
        `).or(`and(remitente_id.eq.${t.value.id},destinatario_id.eq.${o}),and(remitente_id.eq.${o},destinatario_id.eq.${t.value.id})`).order("created_at",{ascending:!0});if(m)throw m;return v.value=a||[],a||[]}catch(a){return s.value=a.message||"Error al cargar conversación",console.error("Error en listarConversacion:",a),[]}finally{p.value=!1}},j=async(o,a,m)=>{if(!t.value)return s.value="Usuario no autenticado",null;if(!a.trim())return s.value="El mensaje no puede estar vacío",null;p.value=!0,s.value=null;try{const{data:_,error:f}=await d.from("mensajes").insert({remitente_id:t.value.id,destinatario_id:o,mensaje:a.trim(),sesion_id:m||null,visto:!1}).select(`
          *,
          remitente:profiles!mensajes_remitente_id_fkey(id, nombre, avatar_url, rol),
          destinatario:profiles!mensajes_destinatario_id_fkey(id, nombre, avatar_url, rol)
        `).single();if(f)throw f;return _&&v.value.push(_),_}catch(_){return s.value=_.message||"Error al enviar mensaje",console.error("Error en enviar:",_),null}finally{p.value=!1}},k=async o=>{if(t.value)try{const{error:a}=await d.from("mensajes").update({visto:!0}).eq("destinatario_id",t.value.id).eq("remitente_id",o).eq("visto",!1);if(a)throw a;v.value=v.value.map(m=>m.remitente_id===o&&m.destinatario_id===t.value.id?{...m,visto:!0}:m)}catch(a){console.error("Error al marcar mensajes como vistos:",a)}},E=async()=>{if(!t.value)return s.value="Usuario no autenticado",[];p.value=!0,s.value=null;try{const{data:o,error:a}=await d.rpc("obtener_ultimas_conversaciones",{usuario_id:t.value.id});if(a)throw a;return g.value=o||[],o||[]}catch(o){return console.warn("Usando método alternativo para conversaciones:",o),await c()}finally{p.value=!1}},c=async()=>{if(!t.value)return[];try{const{data:o,error:a}=await d.from("mensajes").select(`
          *,
          remitente:profiles!mensajes_remitente_id_fkey(id, nombre, avatar_url),
          destinatario:profiles!mensajes_destinatario_id_fkey(id, nombre, avatar_url)
        `).or(`remitente_id.eq.${t.value.id},destinatario_id.eq.${t.value.id}`).order("created_at",{ascending:!1});if(a)throw a;const m=new Map;return o?.forEach(_=>{const f=_.remitente_id===t.value.id,r=f?_.destinatario_id:_.remitente_id,F=f?_.destinatario:_.remitente;if(m.has(r)||m.set(r,{otro_usuario_id:r,otro_usuario_nombre:F?.nombre||"Usuario",otro_usuario_avatar:F?.avatar_url,ultimo_mensaje:_.mensaje,ultimo_mensaje_fecha:_.created_at,mensajes_no_vistos:0}),!f&&!_.visto){const A=m.get(r);A.mensajes_no_vistos++}}),g.value=Array.from(m.values()),g.value}catch(o){return s.value=o.message||"Error al cargar conversaciones",console.error("Error en listarConversacionesAlternativo:",o),[]}},b=async()=>{if(!t.value)return 0;try{const{count:o,error:a}=await d.from("mensajes").select("*",{count:"exact",head:!0}).eq("destinatario_id",t.value.id).eq("visto",!1);if(a)throw a;return o||0}catch(o){return console.error("Error al contar mensajes no vistos:",o),0}},C=o=>{!t.value||l.value||(l.value=d.channel(`mensajes:${t.value.id}:${o}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"mensajes",filter:`destinatario_id=eq.${t.value.id}`},async a=>{const{data:m}=await d.from("mensajes").select(`
              *,
              remitente:profiles!mensajes_remitente_id_fkey(id, nombre, avatar_url, rol),
              destinatario:profiles!mensajes_destinatario_id_fkey(id, nombre, avatar_url, rol)
            `).eq("id",a.new.id).single();m&&v.value.push(m)}).subscribe())},$=async()=>{l.value&&(await d.removeChannel(l.value),l.value=null)};return N(()=>{$()}),{mensajes:v,conversaciones:g,loading:p,error:s,listarConversacion:x,enviar:j,marcarVistos:k,listarConversaciones:E,contarNoVistos:b,suscribirseAConversacion:C,desuscribirse:$}},ve={class:"flex h-[calc(100vh-8rem)] max-w-7xl mx-auto px-4 py-8 gap-6"},_e={class:"px-4 py-5 border-b border-[#EAD5D3]/30 bg-[#F9F7F3]"},he={class:"text-xs text-[#5D4A44]/60 font-lato mt-1"},pe={class:"overflow-y-auto h-[calc(100%-5rem)]"},xe={key:0,class:"p-8 text-center"},be={key:1,class:"p-8 text-center text-[#5D4A44]/60 font-lato text-sm"},ge=["onClick"],we={class:"flex items-start gap-3"},ye={class:"flex-shrink-0"},je={key:0,class:"w-12 h-12 rounded-full overflow-hidden"},De=["src","alt"],Ae={key:1,class:"w-12 h-12 rounded-full bg-[#D8AFA0]/30 flex items-center justify-center"},ke={class:"text-[#5D4A44] font-lora text-lg font-medium"},Ee={class:"flex-1 min-w-0"},Me={class:"flex items-start justify-between gap-2"},Ce={class:"text-xs text-[#5D4A44]/50 font-lato flex-shrink-0"},Fe={key:0,class:"inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-[#D8AFA0] rounded-full mt-2"},$e={class:"flex-1 flex flex-col bg-white rounded-xl shadow-sm border border-[#EAD5D3]/30 overflow-hidden"},qe={key:0,class:"flex-1 flex flex-col items-center justify-center p-8 text-center"},Be={key:1,class:"flex-1 flex flex-col"},Se={class:"px-6 py-4 border-b border-[#EAD5D3]/30 bg-[#F9F7F3] flex items-center gap-4"},Ue={class:"flex items-center gap-3 flex-1"},Ie={key:0,class:"w-10 h-10 rounded-full overflow-hidden"},Le=["src","alt"],Te={key:1,class:"w-10 h-10 rounded-full bg-[#D8AFA0]/30 flex items-center justify-center"},Ve={class:"text-[#5D4A44] font-lora text-sm font-medium"},He={class:"text-base font-lato font-semibold text-[#5D4A44]"},Ne={key:0,class:"flex items-center justify-center h-full"},ze={class:"px-6 py-4 border-t border-[#EAD5D3]/30 bg-white"},Re=S({__name:"mensajes",setup(d){const{conversaciones:t,mensajes:v,loadingConversaciones:g,loadingMensajes:p,listarConversaciones:s,listarConversacion:l,marcarVistos:x,suscribirseAConversacion:j,desuscribirse:k}=fe();H();const{getUserId:E}=W(),c=y(null),b=y(null);Y(async()=>{await s()}),N(()=>{k()});const C=async f=>{c.value=f,await l(f.otro_usuario_id),await x(f.otro_usuario_id),k(),j(f.otro_usuario_id),B(()=>{o()})},$=f=>f.remitente_id===E(),o=()=>{b.value&&(b.value.scrollTop=b.value.scrollHeight)},a=()=>{B(()=>{o()})},m=f=>f.split(" ").map(r=>r[0]).slice(0,2).join("").toUpperCase(),_=f=>{const r=new Date(f),A=new Date().getTime()-r.getTime(),n=Math.floor(A/6e4),q=Math.floor(A/36e5),I=Math.floor(A/864e5);return n<1?"Ahora":n<60?`${n}m`:q<24?`${q}h`:I<7?`${I}d`:r.toLocaleDateString("es-ES",{day:"2-digit",month:"short"})};return J(v,()=>{v.value.length>0&&s()},{deep:!0}),(f,r)=>{const F=se,A=me;return i(),u("div",ve,[e("aside",{class:D(["w-80 bg-white rounded-xl shadow-sm border border-[#EAD5D3]/30 overflow-hidden flex-shrink-0",{"hidden lg:block":h(c)}])},[e("div",_e,[r[1]||(r[1]=e("h2",{class:"text-lg font-lora font-semibold text-[#5D4A44]"}," Conversaciones ",-1)),e("p",he,w(h(t).length)+" pacientes ",1)]),e("div",pe,[h(g)?(i(),u("div",xe,[...r[2]||(r[2]=[e("div",{class:"inline-block w-8 h-8 border-4 border-[#EAD5D3] border-t-[#D8AFA0] rounded-full animate-spin"},null,-1)])])):h(t).length===0?(i(),u("div",be,[...r[3]||(r[3]=[e("svg",{class:"w-12 h-12 mx-auto mb-3 text-[#EAD5D3]",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z"})],-1),e("p",null,"No tienes conversaciones activas",-1)])])):M("",!0),(i(!0),u(L,null,T(h(t),n=>(i(),u("button",{key:n.otro_usuario_id,onClick:q=>C(n),class:D(["w-full px-4 py-4 hover:bg-[#F9F7F3] transition-colors border-b border-[#EAD5D3]/20 text-left group",{"bg-[#EAD5D3]/20 hover:bg-[#EAD5D3]/30":h(c)?.otro_usuario_id===n.otro_usuario_id}])},[e("div",we,[e("div",ye,[n.otro_usuario_avatar?(i(),u("div",je,[e("img",{src:n.otro_usuario_avatar,alt:n.otro_usuario_nombre,class:"w-full h-full object-cover"},null,8,De)])):(i(),u("div",Ae,[e("span",ke,w(m(n.otro_usuario_nombre)),1)]))]),e("div",Ee,[e("div",Me,[e("h3",{class:D(["text-sm font-medium text-[#5D4A44] font-lato truncate",{"font-semibold":n.mensajes_no_vistos>0}])},w(n.otro_usuario_nombre),3),e("span",Ce,w(_(n.ultimo_mensaje_fecha)),1)]),e("p",{class:D(["text-xs text-[#5D4A44]/70 font-lato mt-1 truncate",{"font-medium":n.mensajes_no_vistos>0}])},w(n.ultimo_mensaje),3),n.mensajes_no_vistos>0?(i(),u("div",Fe,w(n.mensajes_no_vistos),1)):M("",!0)])])],10,ge))),128))])],2),e("main",$e,[h(c)?(i(),u("div",Be,[e("header",Se,[e("button",{onClick:r[0]||(r[0]=n=>c.value=null),class:"lg:hidden p-2 -ml-2 rounded-lg hover:bg-white/50 transition-colors"},[...r[5]||(r[5]=[e("svg",{class:"w-5 h-5 text-[#5D4A44]",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 19l-7-7 7-7"})],-1)])]),e("div",Ue,[h(c).otro_usuario_avatar?(i(),u("div",Ie,[e("img",{src:h(c).otro_usuario_avatar,alt:h(c).otro_usuario_nombre,class:"w-full h-full object-cover"},null,8,Le)])):(i(),u("div",Te,[e("span",Ve,w(m(h(c).otro_usuario_nombre)),1)])),e("div",null,[e("h2",He,w(h(c).otro_usuario_nombre),1),r[6]||(r[6]=e("p",{class:"text-xs text-[#5D4A44]/60 font-lato"}," Paciente ",-1))])])]),e("div",{ref_key:"mensajesContainer",ref:b,class:"flex-1 overflow-y-auto p-6 space-y-3 bg-[#F9F7F3]/30"},[h(p)?(i(),u("div",Ne,[...r[7]||(r[7]=[e("div",{class:"inline-block w-8 h-8 border-4 border-[#EAD5D3] border-t-[#D8AFA0] rounded-full animate-spin"},null,-1)])])):(i(!0),u(L,{key:1},T(h(v),n=>(i(),V(F,{key:n.id,texto:n.mensaje,fecha:n.created_at,remitente:$(n),visto:n.visto},null,8,["texto","fecha","remitente","visto"]))),128))],512),e("div",ze,[h(c)?(i(),V(A,{key:0,"destinatario-id":h(c).otro_usuario_id,placeholder:"Escribe tu respuesta con calma...",onMensajeEnviado:a},null,8,["destinatario-id"])):M("",!0)])])):(i(),u("div",qe,[...r[4]||(r[4]=[G('<div class="w-24 h-24 rounded-full bg-[#EAD5D3]/30 flex items-center justify-center mb-6" data-v-130b4f21><svg class="w-12 h-12 text-[#D8AFA0]" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-130b4f21><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" data-v-130b4f21></path></svg></div><h3 class="text-xl font-lora font-medium text-[#5D4A44] mb-2" data-v-130b4f21> Selecciona una conversación </h3><p class="text-sm text-[#5D4A44]/60 font-lato max-w-md" data-v-130b4f21> Elige un paciente de la lista para ver su conversación y responder sus mensajes. </p>',3)])]))])])}}}),Je=U(Re,[["__scopeId","data-v-130b4f21"]]);export{Je as default};
