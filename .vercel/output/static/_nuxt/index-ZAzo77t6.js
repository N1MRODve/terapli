import{e as ee,L as te,p as ae,B as oe,r as _,x as f,g as se,c as l,a as e,b as u,d as F,t as n,l as s,k as B,h as U,v as ne,F as N,y as j,K as re,i as ie,A as D,w as le,M as de,o as d,aj as ce}from"#entry";import{M as pe}from"./ModalDetallesCita-D0zYq1YQ.js";import{r as me}from"./PlusIcon-UqRq4KLf.js";import{r as ue}from"./MagnifyingGlassIcon-B5My0XuL.js";import{r as ge}from"./ExclamationTriangleIcon-BreoAuwB.js";import{r as _e}from"./CalendarDaysIcon-C0vq0F4x.js";import{r as xe}from"./ChevronRightIcon-Ck2OajRo.js";import{r as fe}from"./CheckCircleIcon-Bi0YyG7H.js";import{r as he}from"./ChevronDownIcon-BwiNUDLV.js";import"./PaymentMethodSelector-DGmnaSg8.js";import"./useToast-Cq0GyJHs.js";import"./XMarkIcon-DWNj0d99.js";import"./PencilIcon-QJyqa3i7.js";import"./PhoneIcon-B4J2dtua.js";import"./ClockIcon-CQZt9cKZ.js";import"./TicketIcon-DRclOuRO.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const be={class:"mb-6"},ye={class:"flex items-center justify-between mb-4"},ve={class:"text-2xl font-semibold text-gray-900"},we={class:"text-gray-400 font-normal"},ke={class:"bg-white border border-gray-100 rounded-lg p-4 mb-4"},Ce={class:"flex flex-wrap items-center gap-x-6 gap-y-2 text-sm"},De={class:"flex items-center gap-2"},Se={class:"font-semibold text-gray-900"},Pe={class:"text-gray-400"},Te={class:"flex items-center gap-2"},Ee={class:"font-semibold text-gray-900"},Me={class:"text-gray-400"},qe={class:"flex items-center gap-2"},Fe={class:"font-semibold text-gray-900"},Be={class:"text-gray-400"},Ne={class:"flex items-center gap-2"},je={class:"font-semibold text-gray-900"},ze={class:"ml-auto flex items-center gap-2 pl-4 border-l border-gray-200"},Ae={class:"font-bold text-green-600 text-base"},Le={class:"space-y-3"},$e={class:"flex flex-wrap items-center gap-3"},Ue={class:"relative flex-1 min-w-[200px] max-w-md"},Ve={class:"flex items-center bg-gray-100 rounded-lg p-1"},Re=["onClick"],Ie={key:0,class:"flex items-center justify-center py-20"},He={key:1,class:"bg-red-50 border border-red-100 rounded-lg p-4 flex items-start gap-3"},Oe={class:"text-sm text-red-600"},Ye={key:2},Ke={key:0,class:"flex flex-col items-center justify-center py-20 text-center"},Ge={class:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4"},Je={class:"text-lg font-medium text-gray-900 mb-1"},Qe={class:"text-sm text-gray-500 mb-4 max-w-sm"},We={key:1,class:"bg-white border border-gray-100 rounded-lg overflow-hidden"},Xe={class:"overflow-x-auto"},Ze={class:"w-full"},et={class:"divide-y divide-gray-50"},tt=["onClick"],at={class:"px-4 py-3"},ot={class:"text-sm font-medium text-gray-900"},st={class:"text-xs text-gray-500"},nt={class:"px-4 py-3"},rt={class:"flex items-center gap-2"},it={class:"w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-xs font-semibold flex-shrink-0"},lt={class:"min-w-0"},dt={class:"text-sm font-medium text-gray-900 truncate"},ct={class:"px-4 py-3"},pt={class:"text-sm text-gray-600"},mt={class:"px-4 py-3"},ut={class:"px-4 py-3"},gt={key:0,class:"text-sm"},_t={class:"text-gray-700"},xt={key:0,class:"ml-1.5 text-xs text-green-600 font-medium"},ft={key:1,class:"ml-1.5 text-xs text-amber-600 font-medium"},ht={key:1,class:"text-sm text-gray-400"},bt={class:"px-4 py-3 text-right"},yt={class:"text-sm font-medium text-gray-900"},vt={class:"text-xs text-gray-500"},wt={class:"px-4 py-3 text-right"},kt={key:2,class:"mt-6"},Ct={class:"flex items-center gap-3"},Dt={class:"w-8 h-8 bg-green-600 rounded-lg flex items-center justify-center"},St={class:"text-sm text-green-600 ml-2"},Pt={class:"mt-2 bg-white border border-gray-100 rounded-lg overflow-hidden"},Tt={class:"divide-y divide-gray-50"},Et={class:"w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-xs font-semibold"},Mt={class:"flex-1 min-w-0"},qt={class:"text-sm font-medium text-gray-900 truncate"},Ft={class:"text-xs text-gray-500"},Bt={class:"text-right"},Nt={class:"text-sm font-semibold text-green-600"},jt={class:"text-xs text-gray-500"},S=50,ea=ee({__name:"index",setup(zt){const V=te(),h=ae(),b=oe(),P=_(!0),y=_(null),z=_([]),T=_([]),v=_(!1),E=_(!1),M=_(null),c=_({busqueda:"",estado:"",periodo:"todos"}),R=[{valor:"hoy",label:"Hoy"},{valor:"semana",label:"Semana"},{valor:"mes",label:"Mes"},{valor:"todos",label:"Todos"}],w=f(()=>c.value.busqueda!==""||c.value.estado!==""||c.value.periodo!=="todos"),k=f(()=>{let a=[...z.value];if(c.value.busqueda){const i=c.value.busqueda.toLowerCase();a=a.filter(p=>p.paciente?.nombre_completo?.toLowerCase().includes(i))}c.value.estado&&(a=a.filter(i=>i.estado===c.value.estado));const t=new Date,o=new Date(t.getFullYear(),t.getMonth(),t.getDate());if(c.value.periodo==="hoy")a=a.filter(i=>new Date(i.fecha_cita).toDateString()===o.toDateString());else if(c.value.periodo==="semana"){const i=new Date(o);i.setDate(o.getDate()-o.getDay()+1);const p=new Date(i);p.setDate(i.getDate()+6),a=a.filter(r=>{const x=new Date(r.fecha_cita);return x>=i&&x<=p})}else if(c.value.periodo==="mes"){const i=new Date(t.getFullYear(),t.getMonth(),1),p=new Date(t.getFullYear(),t.getMonth()+1,0);a=a.filter(r=>{const x=new Date(r.fecha_cita);return x>=i&&x<=p})}return a.sort((i,p)=>{const r=new Date(i.fecha_cita+"T"+i.hora_inicio);return new Date(p.fecha_cita+"T"+p.hora_inicio).getTime()-r.getTime()}),a}),m=f(()=>{const a={pendientes:0,confirmadas:0,completadas:0,canceladas:0,montoPendiente:0,montoConfirmado:0,montoCompletado:0,montoCancelado:0};return k.value.forEach(t=>{const o=t.monto_terapeuta||(t.precio_estimado||S)*.7;switch(t.estado){case"pendiente":a.pendientes++,t.esta_pagado||t.bono?.pagado?a.montoConfirmado+=o:a.montoPendiente+=o;break;case"confirmada":a.confirmadas++,t.esta_pagado||t.bono?.pagado?a.montoConfirmado+=o:a.montoPendiente+=o;break;case"realizada":case"completada":a.completadas++,t.esta_pagado||t.bono?.pagado?a.montoConfirmado+=o:a.montoCompletado+=o;break;case"cancelada":a.canceladas++,a.montoCancelado+=o;break}}),a}),I=f(()=>m.value.montoCompletado+m.value.montoPendiente),C=f(()=>T.value.map(a=>{const t=(a.sesiones_totales||0)-(a.sesiones_restantes||0),o=a.monto_total*.7;return{bono_id:a.id,paciente_nombre:a.paciente_nombre,bono_sesiones_totales:a.sesiones_totales,bono_monto_total:a.monto_total,bono_fecha_pago:a.fecha_pago,tipo_bono:a.tipo_bono||"Estándar",sesiones_usadas:t,monto_total_terapeuta:o}}).sort((a,t)=>{const o=new Date(a.bono_fecha_pago||0);return new Date(t.bono_fecha_pago||0).getTime()-o.getTime()})),H=f(()=>C.value.reduce((a,t)=>a+(t.monto_total_terapeuta||0),0)),A=()=>{c.value={busqueda:"",estado:"",periodo:"todos"}},L=()=>{V.push("/terapeuta/agenda")},q=async()=>{try{P.value=!0,y.value=null;let a=0;for(;!b.value&&a<50;)await new Promise(r=>setTimeout(r,100)),a++;if(!b.value)throw new Error("Usuario no autenticado");const{data:t,error:o}=await h.from("terapeutas").select("id").eq("email",b.value.email).single();if(o)throw o;if(!t)throw new Error("No se encontró el terapeuta");const{data:i,error:p}=await h.from("vista_agenda_terapeutas").select("*").eq("terapeuta_id",t.id).order("fecha_cita",{ascending:!1});if(p)throw p;z.value=(i||[]).map(r=>({id:r.cita_id,fecha_cita:r.fecha_cita,hora_inicio:r.hora_inicio,hora_fin:r.hora_fin,duracion_minutos:r.duracion_minutos,modalidad:r.modalidad,estado:r.estado,observaciones:r.observaciones,notas_terapeuta:r.notas_terapeuta,precio_estimado:r.cita_metadata?.precio_sesion||S,esta_pagado:r.cita_metadata?.metodo_pago==="bono"||r.bono_estado==="activo",paciente:{id:r.paciente_id,nombre_completo:r.paciente_nombre,email:r.paciente_email},bono:r.bono_id?{id:r.bono_id,sesiones_totales:r.bono_sesiones_totales,sesiones_restantes:r.bono_sesiones_restantes,pagado:r.bono_estado==="activo"||r.bono_estado==="pagado"}:null}))}catch(a){y.value=a.message||"Error desconocido"}finally{P.value=!1}},O=async()=>{try{if(!b.value)return;const{data:a}=await h.from("terapeutas").select("id").eq("email",b.value.email).single();if(!a)return;const{data:t}=await h.from("pacientes").select("id").eq("terapeuta_id",a.id);if(!t||t.length===0){T.value=[];return}const{data:o}=await h.from("bonos").select(`
        id,
        paciente_id,
        sesiones_totales,
        sesiones_restantes,
        monto_total,
        tipo_bono,
        fecha_pago,
        pagado,
        paciente:pacientes!bonos_paciente_id_fkey (
          nombre_completo
        )
      `).eq("pagado",!0).in("paciente_id",t.map(i=>i.id)).order("fecha_pago",{ascending:!1});T.value=(o||[]).map(i=>({...i,paciente_nombre:i.paciente?.nombre_completo}))}catch(a){console.error("Error cargando bonos:",a)}},Y=a=>{M.value=a.id,E.value=!0},K=()=>{E.value=!1,M.value=null},g=a=>a?.toFixed(2)||"0.00",G=a=>a?new Date(a).toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit",year:"numeric"}):"-",J=a=>{if(!a)return"-";const t=new Date(a+"T00:00:00"),o=new Date,i=new Date(o);return i.setDate(o.getDate()-1),t.toDateString()===o.toDateString()?"Hoy":t.toDateString()===i.toDateString()?"Ayer":t.toLocaleDateString("es-ES",{day:"numeric",month:"short"})},Q=a=>a?.substring(0,5)||"-",$=a=>a?.split(" ").map(t=>t[0]).join("").toUpperCase().substring(0,2)||"??",W=a=>({pendiente:"Pendiente",confirmada:"Confirmada",realizada:"Realizada",completada:"Realizada",cancelada:"Cancelada"})[a]||a,X=a=>({pendiente:"text-gray-600",confirmada:"text-green-600",realizada:"text-green-700",completada:"text-green-700",cancelada:"text-red-600"})[a]||"text-gray-600",Z=a=>({pendiente:"bg-gray-400",confirmada:"bg-green-500",realizada:"bg-green-600",completada:"bg-green-600",cancelada:"bg-red-500"})[a]||"bg-gray-400";return se(()=>{q(),O()}),(a,t)=>(d(),l("div",null,[e("header",be,[e("div",ye,[e("h1",ve,[t[3]||(t[3]=F(" Sesiones ",-1)),e("span",we,"("+n(s(k).length)+")",1)]),e("button",{onClick:L,class:"h-10 px-4 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-2 shadow-sm"},[u(s(me),{class:"w-4 h-4"}),t[4]||(t[4]=F(" Nueva Sesión ",-1))])]),e("div",ke,[e("div",Ce,[e("div",De,[t[5]||(t[5]=e("span",{class:"w-2 h-2 rounded-full bg-gray-400"},null,-1)),t[6]||(t[6]=e("span",{class:"text-gray-600"},"Pendientes:",-1)),e("span",Se,n(s(m).pendientes),1),e("span",Pe,"("+n(g(s(m).montoPendiente))+"€)",1)]),t[14]||(t[14]=e("span",{class:"hidden sm:block text-gray-200"},"|",-1)),e("div",Te,[t[7]||(t[7]=e("span",{class:"w-2 h-2 rounded-full bg-green-500"},null,-1)),t[8]||(t[8]=e("span",{class:"text-gray-600"},"Confirmadas:",-1)),e("span",Ee,n(s(m).confirmadas),1),e("span",Me,"("+n(g(s(m).montoConfirmado))+"€)",1)]),t[15]||(t[15]=e("span",{class:"hidden sm:block text-gray-200"},"|",-1)),e("div",qe,[t[9]||(t[9]=e("span",{class:"w-2 h-2 rounded-full bg-green-600"},null,-1)),t[10]||(t[10]=e("span",{class:"text-gray-600"},"Realizadas:",-1)),e("span",Fe,n(s(m).completadas),1),e("span",Be,"("+n(g(s(m).montoCompletado))+"€)",1)]),t[16]||(t[16]=e("span",{class:"hidden sm:block text-gray-200"},"|",-1)),e("div",Ne,[t[11]||(t[11]=e("span",{class:"w-2 h-2 rounded-full bg-red-500"},null,-1)),t[12]||(t[12]=e("span",{class:"text-gray-600"},"Canceladas:",-1)),e("span",je,n(s(m).canceladas),1)]),e("div",ze,[t[13]||(t[13]=e("span",{class:"text-gray-600"},"Por cobrar:",-1)),e("span",Ae,n(g(s(I)))+"€",1)])])]),e("div",Le,[e("div",$e,[e("div",Ue,[B(e("input",{"onUpdate:modelValue":t[0]||(t[0]=o=>s(c).busqueda=o),type:"text",placeholder:"Buscar sesión...",class:"w-full h-10 px-4 pl-9 bg-white border border-gray-200 rounded-lg text-sm focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all"},null,512),[[ne,s(c).busqueda]]),u(s(ue),{class:"w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"})]),e("div",Ve,[(d(),l(N,null,j(R,o=>e("button",{key:o.valor,onClick:i=>s(c).periodo=o.valor,class:D(["px-3 py-1.5 text-sm font-medium rounded-md transition-all",s(c).periodo===o.valor?"bg-white text-gray-900 shadow-sm":"text-gray-600 hover:text-gray-900"])},n(o.label),11,Re)),64))]),B(e("select",{"onUpdate:modelValue":t[1]||(t[1]=o=>s(c).estado=o),class:"h-10 px-3 bg-white border border-gray-200 rounded-lg text-sm text-gray-700 focus:border-purple-500 focus:ring-1 focus:ring-purple-500/20"},[...t[17]||(t[17]=[ie('<option value="">Todos los estados</option><option value="pendiente">Pendientes</option><option value="confirmada">Confirmadas</option><option value="realizada">Realizadas</option><option value="cancelada">Canceladas</option>',5)])],512),[[re,s(c).estado]]),s(w)?(d(),l("button",{key:0,onClick:A,class:"h-10 px-3 text-sm text-gray-500 hover:text-gray-700 transition-colors"}," Limpiar ")):U("",!0)])])]),s(P)?(d(),l("div",Ie,[...t[18]||(t[18]=[e("div",{class:"w-8 h-8 border-2 border-purple-600 border-t-transparent rounded-full animate-spin"},null,-1)])])):s(y)?(d(),l("div",He,[u(s(ge),{class:"w-5 h-5 text-red-500 flex-shrink-0 mt-0.5"}),e("div",null,[t[19]||(t[19]=e("p",{class:"font-medium text-red-800"},"Error al cargar sesiones",-1)),e("p",Oe,n(s(y)),1)])])):(d(),l("div",Ye,[s(k).length===0?(d(),l("div",Ke,[e("div",Ge,[u(s(_e),{class:"w-8 h-8 text-gray-400"})]),e("h3",Je,n(s(w)?"Sin resultados":"Sin sesiones"),1),e("p",Qe,n(s(w)?"Prueba ajustando los filtros de búsqueda":"Programa tu primera sesión desde la agenda"),1),s(w)?(d(),l("button",{key:1,onClick:A,class:"px-4 py-2 text-gray-600 text-sm font-medium hover:text-gray-900 transition-colors"}," Limpiar filtros ")):(d(),l("button",{key:0,onClick:L,class:"px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 transition-colors"}," Ir a la agenda "))])):(d(),l("div",We,[e("div",Xe,[e("table",Ze,[t[20]||(t[20]=e("thead",null,[e("tr",{class:"border-b border-gray-100 bg-gray-50/50"},[e("th",{class:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Fecha"),e("th",{class:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Paciente"),e("th",{class:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Tipo"),e("th",{class:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Estado"),e("th",{class:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Bono"),e("th",{class:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"},"Monto"),e("th",{class:"px-4 py-3 w-10"})])],-1)),e("tbody",et,[(d(!0),l(N,null,j(s(k),o=>(d(),l("tr",{key:o.id,class:"hover:bg-gray-50/50 transition-colors cursor-pointer",onClick:i=>Y(o)},[e("td",at,[e("div",ot,n(J(o.fecha_cita)),1),e("div",st,n(Q(o.hora_inicio)),1)]),e("td",nt,[e("div",rt,[e("div",it,n($(o.paciente?.nombre_completo||"NN")),1),e("div",lt,[e("div",dt,n(o.paciente?.nombre_completo||"Sin nombre"),1)])])]),e("td",ct,[e("span",pt,n(o.modalidad==="online"?"Online":"Presencial"),1)]),e("td",mt,[e("span",{class:D(["inline-flex items-center gap-1.5 text-sm",X(o.estado)])},[e("span",{class:D(["w-1.5 h-1.5 rounded-full",Z(o.estado)])},null,2),F(" "+n(W(o.estado)),1)],2)]),e("td",ut,[o.bono?(d(),l("div",gt,[e("span",_t,n(o.bono.sesiones_restantes)+"/"+n(o.bono.sesiones_totales),1),o.bono.pagado?(d(),l("span",xt,"Pagado")):(d(),l("span",ft,"Pend."))])):(d(),l("span",ht,"—"))]),e("td",bt,[e("div",yt,n(g(o.precio_estimado||S))+"€ ",1),e("div",vt,n(g((o.precio_estimado||S)*.7))+"€ tu parte ",1)]),e("td",wt,[u(s(xe),{class:"w-4 h-4 text-gray-400"})])],8,tt))),128))])])])])),s(C).length>0?(d(),l("div",kt,[e("button",{onClick:t[2]||(t[2]=o=>v.value=!s(v)),class:"w-full flex items-center justify-between px-4 py-3 bg-green-50 border border-green-100 rounded-lg text-left hover:bg-green-100/50 transition-colors"},[e("div",Ct,[e("div",Dt,[u(s(fe),{class:"w-4 h-4 text-white"})]),e("div",null,[t[21]||(t[21]=e("span",{class:"font-medium text-green-800"},"Pagos confirmados",-1)),e("span",St,n(s(C).length)+" bonos · "+n(g(s(H)))+"€",1)])]),u(s(he),{class:D(["w-5 h-5 text-green-600 transition-transform",{"rotate-180":s(v)}])},null,8,["class"])]),u(de,{"enter-active-class":"transition-all duration-200 ease-out","enter-from-class":"opacity-0 max-h-0","enter-to-class":"opacity-100 max-h-[1000px]","leave-active-class":"transition-all duration-150 ease-in","leave-from-class":"opacity-100 max-h-[1000px]","leave-to-class":"opacity-0 max-h-0"},{default:le(()=>[B(e("div",Pt,[e("div",Tt,[(d(!0),l(N,null,j(s(C),o=>(d(),l("div",{key:o.bono_id,class:"px-4 py-3 flex items-center gap-4 hover:bg-gray-50/50"},[e("div",Et,n($(o.paciente_nombre||"NN")),1),e("div",Mt,[e("div",qt,n(o.paciente_nombre),1),e("div",Ft,n(o.tipo_bono||"Bono")+" · "+n(o.sesiones_usadas)+"/"+n(o.bono_sesiones_totales)+" sesiones",1)]),e("div",Bt,[e("div",Nt,n(g(o.monto_total_terapeuta))+"€",1),e("div",jt,n(G(o.bono_fecha_pago)),1)])]))),128))])],512),[[ce,s(v)]])]),_:1})])):U("",!0)])),u(pe,{"is-open":s(E),"cita-id":s(M),onClose:K,onActualizado:q,onEliminado:q},null,8,["is-open","cita-id"])]))}});export{ea as default};
