import{p as D,L as I,f as L,r as d,x as m,E as R}from"#entry";const A=()=>{const s=D(),t=I(),{getUserId:y}=L(),r=d([]),l=d(!1),c=d(null),u=d(null),n=d(0),p=m(()=>r.value.filter(e=>!e.leido)),w=m(()=>p.value.filter(e=>e.tipo==="bono"&&(e.metadata?.urgencia==="alta"||e.metadata?.sesiones_restantes===0))),N=m(()=>w.value.length>0),x=async(e=20)=>{const a=y();if(!a)return console.warn("Usuario no autenticado o ID no disponible"),c.value="Usuario no autenticado",[];l.value=!0,c.value=null;try{const{data:i,error:o}=await s.from("notificaciones").select("*").eq("usuario_id",a).order("created_at",{ascending:!1}).limit(e);if(o){if(o.code==="PGRST116"||o.message.includes("does not exist"))return console.warn("丘멆잺 Tabla notificaciones no existe a칰n. Retornando vac칤o."),r.value=[],n.value=0,[];throw o}return r.value=i||[],n.value=(i||[]).filter(f=>!f.visto&&!f.leido).length,i||[]}catch(i){return i.message?.includes("does not exist")||(c.value=i.message||"Error al cargar notificaciones",console.error("Error en listar notificaciones:",i)),[]}finally{l.value=!1}},S=async(e,a,i,o="mensaje",f)=>{if(!t.value)return c.value="Usuario no autenticado",null;l.value=!0,c.value=null;try{const{data:v,error:b}=await s.from("notificaciones").insert({usuario_id:e,titulo:a,mensaje:i,tipo:o,referencia_id:f||null,visto:!1}).select().single();if(b)throw b;return v}catch(v){return c.value=v.message||"Error al crear notificaci칩n",console.error("Error en crear notificaci칩n:",v),null}finally{l.value=!1}},h=async e=>{if(t.value)try{const{data:a,error:i}=await s.rpc("marcar_notificacion_leida",{p_notificacion_id:e});if(i)throw i;r.value=r.value.map(o=>o.id===e?{...o,leido:!0,leido_at:new Date().toISOString()}:o),n.value=Math.max(0,n.value-1)}catch(a){console.error("Error al marcar notificaci칩n como le칤da:",a)}},q=h,g=async()=>{if(t.value)try{const{data:e,error:a}=await s.rpc("marcar_todas_notificaciones_leidas");if(a)throw a;return r.value=r.value.map(i=>({...i,leido:!0,leido_at:i.leido_at||new Date().toISOString()})),n.value=0,{success:!0,marcadas:e?.marcadas||0}}catch(e){return console.error("Error al marcar todas las notificaciones como le칤das:",e),{success:!1,error:e.message}}},U=g,_=async()=>{if(!t.value)return 0;try{const{data:e,error:a}=await s.rpc("contar_notificaciones_no_leidas");if(a)throw a;return n.value=e||0,e||0}catch(e){return console.error("Error al contar notificaciones no le칤das:",e),0}},T=_,C=async e=>{if(t.value)try{const{error:a}=await s.from("notificaciones").delete().eq("id",e).eq("usuario_id",t.value.id);if(a)throw a;const i=r.value.find(o=>o.id===e);i&&!i.leido&&!i.visto&&(n.value=Math.max(0,n.value-1)),r.value=r.value.filter(o=>o.id!==e)}catch(a){console.error("Error al eliminar notificaci칩n:",a)}},P=async()=>{if(t.value)try{const{error:e}=await s.from("notificaciones").delete().eq("usuario_id",t.value.id).eq("leido",!0);if(e)throw e;r.value=r.value.filter(a=>!a.leido)}catch(e){console.error("Error al eliminar notificaciones vistas:",e)}},V=()=>{!t.value||u.value||(u.value=s.channel(`notificaciones:${t.value.id}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"notificaciones",filter:`usuario_id=eq.${t.value.id}`},e=>{const a=e.new;r.value.unshift(a),n.value++,"Notification"in window&&Notification.permission==="granted"&&new Notification(a.titulo,{body:a.mensaje,icon:"/icon-notification.png",badge:a.tipo==="bono"&&a.metadata?.urgencia==="alta"?"游댮":"游댒"})}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"notificaciones",filter:`usuario_id=eq.${t.value.id}`},e=>{const a=e.new,i=r.value.findIndex(o=>o.id===a.id);i!==-1&&(r.value[i]=a)}).subscribe())},E=async()=>{u.value&&(await s.removeChannel(u.value),u.value=null)};return R(()=>{E()}),{notificaciones:r,totalNoVistas:n,loading:l,error:c,noLeidas:p,urgentes:w,tieneUrgentes:N,listar:x,crear:S,marcarVista:h,marcarComoLeida:q,marcarTodasVistas:g,marcarTodasComoLeidas:U,contarNoVistas:_,obtenerContador:T,eliminar:C,eliminarVistas:P,suscribirse:V,desuscribirse:E,solicitarPermisosNotificaciones:async()=>{"Notification"in window&&Notification.permission==="default"&&await Notification.requestPermission()}}};export{A as u};
