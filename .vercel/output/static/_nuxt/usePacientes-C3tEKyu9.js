import{p as T,L as z,r as h,G as A,x as S}from"#entry";class j{enabled=!0;minLevel="debug";sessionId;buffer=[];maxBufferSize=100;constructor(){this.sessionId=this.generateSessionId(),this.minLevel="warn"}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}shouldLog(e){if(!this.enabled)return!1;const t=["debug","info","warn","error"],a=t.indexOf(this.minLevel);return t.indexOf(e)>=a}formatMessage(e){const t=new Date(e.timestamp).toLocaleTimeString("es-ES"),a=`[AGENDA ${e.event.toUpperCase()}]`;return`${t} ${a} ${e.message}`}log(e,t,a,o){if(!this.shouldLog(e))return;const i={timestamp:new Date().toISOString(),level:e,event:t,message:a,data:o,sessionId:this.sessionId};this.buffer.push(i),this.buffer.length>this.maxBufferSize&&this.buffer.shift();const l=this.formatMessage(i);switch(e){case"debug":console.log(`üîç ${l}`,o||"");break;case"info":console.info(`‚ÑπÔ∏è ${l}`,o||"");break;case"warn":console.warn(`‚ö†Ô∏è ${l}`,o||"");break;case"error":console.error(`‚ùå ${l}`,o||""),i.stack&&console.error("Stack trace:",i.stack);break}}debug(e,t,a){this.log("debug",e,t,a)}info(e,t,a){this.log("info",e,t,a)}warn(e,t,a){this.log("warn",e,t,a)}error(e,t,a){const o=a instanceof Error?{name:a.name,message:a.message,stack:a.stack}:a,i={timestamp:new Date().toISOString(),level:"error",event:e,message:t,data:o,sessionId:this.sessionId,stack:a instanceof Error?a.stack:void 0};this.buffer.push(i),this.buffer.length>this.maxBufferSize&&this.buffer.shift(),console.error(`‚ùå ${this.formatMessage(i)}`,o||""),i.stack&&console.error("Stack trace:",i.stack)}loadRange(e,t,a){this.info("load_range",`Cargadas ${a} citas`,{from:e,to:t,count:a})}create(e,t,a){this.info("create",`Cita creada: ${e}`,{appointmentId:e,date:t,time:a})}update(e,t){this.info("update",`Cita actualizada: ${e}`,{appointmentId:e,changes:t})}move(e,t,a){this.info("move",`Cita movida: ${e}`,{appointmentId:e,from:t,to:a})}statusChange(e,t,a){this.info("status_change",`Estado cambiado: ${t} ‚Üí ${a}`,{appointmentId:e,from:t,to:a})}conflict(e,t,a,o){this.warn("conflict","Conflicto de horario detectado",{appointmentId:e,conflictWith:t,date:a,time:o})}apiError(e,t){this.error("api_error",`Error en API: ${e}`,t instanceof Error?t:{message:t})}realtimeEvent(e,t){this.debug("realtime_event",`Evento en tiempo real: ${e}`,t)}optimisticUpdate(e,t){this.debug("optimistic_update",`Actualizaci√≥n optimista: ${t}`,{appointmentId:e,action:t})}rollback(e,t){this.warn("rollback",`Rollback de cambio: ${t}`,{appointmentId:e,reason:t})}dragStart(e,t){this.debug("drag_start",`Inicio de drag: ${e}`,{appointmentId:e,from:t})}dragEnd(e,t,a){a?this.debug("drag_end","Drag completado exitosamente",{appointmentId:e,to:t}):this.warn("drag_end","Drag cancelado o fallido",{appointmentId:e,to:t})}clickCreate(e,t){this.debug("click_create","Click para crear cita",{date:e,time:t})}filterChange(e){this.debug("filter_change","Filtros actualizados",{filters:e})}getBuffer(){return[...this.buffer]}clearBuffer(){this.buffer=[]}downloadLogs(){const e=this.buffer.map(i=>JSON.stringify(i)).join(`
`),t=new Blob([e],{type:"application/json"}),a=URL.createObjectURL(t),o=document.createElement("a");o.href=a,o.download=`agenda-logs-${this.sessionId}.json`,o.click(),URL.revokeObjectURL(a)}setEnabled(e){this.enabled=e}setMinLevel(e){this.minLevel=e}getSessionId(){return this.sessionId}}const d=new j;function N(){const f=T(),e=z(),t=h([]),a=h(!1),o=h(null),i=h(""),l=h(null),g=h(new Map),C=300*1e3;async function _(r){try{a.value=!0,o.value=null;const s=r.trim().toLowerCase(),n=g.value.get(s);if(n){t.value=n,d.debug("search",`Resultados desde cache: ${n.length}`);return}if(d.debug("search",`Buscando pacientes: "${s}"`),!e.value?.id)throw new Error("Usuario no autenticado");const{data:b,error:w}=await f.from("perfiles").select("terapeuta_id").eq("id",e.value.id).single();if(w||!b?.terapeuta_id)throw new Error("No se pudo obtener el perfil del terapeuta");const v=b.terapeuta_id;let c=f.from("pacientes").select(`
          id,
          nombre_completo,
          email,
          telefono,
          fecha_nacimiento,
          bonos:bonos_sesiones(
            id,
            sesiones_restantes,
            fecha_vencimiento,
            estado
          )
        `).eq("terapeuta_id",v);s.length>0&&(c=c.or(`nombre_completo.ilike.%${s}%,email.ilike.%${s}%,telefono.ilike.%${s}%`));const{data:$,error:p}=await c.order("nombre_completo",{ascending:!0}).limit(50);if(p)throw p;const E=($||[]).map(m=>{const k=(m.bonos||[]).filter(u=>u.estado==="activo"&&u.sesiones_restantes>0),U=k.reduce((u,O)=>u+(O.sesiones_restantes||0),0),x=k.filter(u=>u.fecha_vencimiento).map(u=>new Date(u.fecha_vencimiento).getTime()).sort()[0]||null;return{id:m.id,nombre_completo:m.nombre_completo,email:m.email,telefono:m.telefono,fecha_nacimiento:m.fecha_nacimiento,bonos_activos:k.length,sesiones_restantes_total:U,proximo_vencimiento:x?new Date(x).toISOString():null}});t.value=E,g.value.set(s,E),setTimeout(()=>{g.value.delete(s)},C),d.info("search",`Pacientes encontrados: ${E.length}`)}catch(s){const n=s.message||"Error al buscar pacientes";o.value=n,d.error("api_error",n,s),t.value=[]}finally{a.value=!1}}function L(r,s=300){if(l.value&&clearTimeout(l.value),r.trim().length===0){_(r);return}l.value=setTimeout(()=>{_(r)},s)}async function I(r){try{if(a.value=!0,o.value=null,d.debug("create","Creando paciente r√°pido",r),!e.value?.id)throw new Error("Usuario no autenticado");if(!r.nombre_completo||r.nombre_completo.trim().length<2)return{success:!1,error:"El nombre debe tener al menos 2 caracteres"};if(!r.email||!r.email.includes("@"))return{success:!1,error:"Email inv√°lido"};const{data:s,error:n}=await f.from("perfiles").select("terapeuta_id").eq("id",e.value.id).single();if(n||!s?.terapeuta_id)throw new Error("No se pudo obtener el perfil del terapeuta");const b=s.terapeuta_id,{data:w,error:v}=await f.from("pacientes").select("id, nombre_completo").eq("terapeuta_id",b).eq("email",r.email.trim().toLowerCase()).maybeSingle();if(v&&v.code!=="PGRST116")throw v;if(w)return{success:!1,error:`Ya existe un paciente con el email ${r.email}: ${w.nombre_completo}`};const{data:c,error:$}=await f.from("pacientes").insert({terapeuta_id:b,nombre_completo:r.nombre_completo.trim(),email:r.email.trim().toLowerCase(),telefono:r.telefono?.trim()||null,fecha_nacimiento:r.fecha_nacimiento||null,observaciones:r.observaciones?.trim()||null}).select().single();if($)throw $;const p={id:c.id,nombre_completo:c.nombre_completo,email:c.email,telefono:c.telefono,fecha_nacimiento:c.fecha_nacimiento,bonos_activos:0,sesiones_restantes_total:0,proximo_vencimiento:null};return t.value.unshift(p),g.value.clear(),d.info("create",`Paciente creado: ${c.id}`),{success:!0,data:p}}catch(s){const n=s.message||"Error al crear paciente";return o.value=n,d.error("api_error",n,s),{success:!1,error:n}}finally{a.value=!1}}async function y(){await _("")}function B(){i.value="",t.value=[],o.value=null}function P(){g.value.clear(),d.debug("cache","Cache invalidado")}A(i,r=>{L(r)});const R=S(()=>t.value.length>0),D=S(()=>a.value),M=S(()=>o.value!==null);return{pacientes:t,loading:D,error:M,searchQuery:i,hasPacientes:R,searchPacientes:_,debouncedSearch:L,createPaciente:I,loadAllPacientes:y,clearSearch:B,invalidateCache:P,clearError:()=>{o.value=null}}}export{d as a,N as u};
