import{c as l,o as i,a as t,e as pt,L as gt,p as mt,f as xt,r as v,x as L,g as ft,h as u,J as q,A as p,l as r,d as g,t as n,b as c,F as V,y as D,k as P,v as M,m as te,K as se,i as je,w as oe,M as re,T as vt,j as h,N as Ee,z as me}from"#entry";import{u as bt}from"./useBonos-DDT1LxKM.js";import{r as Te}from"./PlusIcon-UqRq4KLf.js";import{r as xe}from"./CurrencyEuroIcon-ctfYYmfn.js";import{r as I}from"./ChevronRightIcon-Ck2OajRo.js";import{r as Q}from"./CheckCircleIcon-Bi0YyG7H.js";import{r as fe}from"./ExclamationTriangleIcon-BreoAuwB.js";import{r as ve,a as yt}from"./EllipsisVerticalIcon-CApbtKsG.js";import{r as ae}from"./ExclamationCircleIcon-Dyh9f5zH.js";import{r as _t}from"./UserGroupIcon-Byc3y-S3.js";import{r as be}from"./ClockIcon-CQZt9cKZ.js";import{r as ye}from"./ChevronDownIcon-BwiNUDLV.js";import{r as Z}from"./TicketIcon-DRclOuRO.js";import{r as ht}from"./ClipboardDocumentListIcon-CSBwmCjC.js";import{r as wt}from"./CalendarIcon-mZ3toP8Y.js";import{r as Be}from"./PencilIcon-QJyqa3i7.js";import{r as Se}from"./TrashIcon-c8JhvyFk.js";import{r as kt}from"./MagnifyingGlassIcon-B5My0XuL.js";import{r as qe}from"./XMarkIcon-DWNj0d99.js";function _e(J,E){return i(),l("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m20.25 7.5-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z"})])}function Ct(J,E){return i(),l("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M15.75 5.25v13.5m-7.5-13.5v13.5"})])}function Pt(J,E){return i(),l("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z"})])}function $t(J,E){return i(),l("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"})])}const At={class:"mb-6"},jt={class:"flex items-center justify-between mb-4"},Et={class:"flex items-center gap-6"},Tt={class:"flex items-center gap-1 bg-gray-100 rounded-lg p-1"},Bt={key:0,class:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 mb-4"},St={class:"flex items-center gap-2 mb-1"},qt={class:"w-8 h-8 bg-amber-100 rounded-lg flex items-center justify-center"},Mt={class:"text-2xl font-bold text-amber-900"},Ut={class:"flex items-center justify-between mt-1"},Vt={class:"text-xs text-amber-600"},Dt={class:"text-xs text-amber-500 group-hover:text-amber-700 flex items-center gap-1"},Ht={class:"bg-white border border-gray-100 rounded-xl p-4"},Nt={class:"flex items-center gap-2 mb-1"},Ft={class:"w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center"},zt={class:"text-2xl font-bold text-gray-900"},Lt={class:"flex items-center gap-2 mb-1"},Ot={class:"w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center"},Rt={class:"text-2xl font-bold text-red-900"},Gt={class:"flex items-center justify-between mt-1"},It={class:"text-xs text-red-500 group-hover:text-red-700 flex items-center gap-1"},Qt={key:1,class:"bg-white border border-gray-100 rounded-xl p-4"},Zt={class:"flex items-center gap-2 mb-1"},Jt={class:"w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center"},Kt={class:"text-2xl font-bold text-gray-900"},Wt={class:"flex items-center gap-2 mb-1"},Xt={class:"w-8 h-8 bg-red-200 rounded-lg flex items-center justify-center"},Yt={class:"text-2xl font-bold text-red-900"},es={class:"flex items-center justify-between mt-1"},ts={class:"text-xs text-red-600 group-hover:text-red-800 flex items-center gap-1"},ss={key:3,class:"bg-white border border-gray-100 rounded-xl p-4"},os={class:"flex items-center gap-2 mb-1"},rs={class:"w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center"},as={class:"text-2xl font-bold text-gray-900"},ns={key:0,class:"space-y-4"},is={key:0,class:"flex items-center justify-center py-20"},ls={key:1,class:"bg-white border border-gray-100 rounded-lg py-12 text-center"},ds={key:2,class:"space-y-3"},cs=["onClick"],us={class:"flex items-center gap-3"},ps={class:"w-10 h-10 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-sm font-semibold"},gs={class:"font-medium text-gray-900"},ms={class:"flex items-center gap-2 text-xs text-gray-500"},xs={class:"flex items-center gap-4"},fs={class:"text-right min-w-[80px]"},vs={class:"text-sm font-semibold text-gray-900"},bs={key:0,class:"border-t border-gray-100 overflow-hidden"},ys={class:"divide-y divide-gray-50"},_s={class:"flex items-center justify-between"},hs=["onClick"],ws={class:"flex items-center gap-2"},ks={class:"text-sm font-medium text-gray-900"},Cs={class:"text-xs text-gray-500"},Ps={key:0,class:"ml-2"},$s={class:"flex items-center gap-3"},As=["onClick"],js=["onClick"],Es={class:"w-16 h-1.5 bg-gray-200 rounded-full overflow-hidden hidden md:block"},Ts={class:"text-right min-w-[60px]"},Bs={class:"text-sm font-medium text-gray-900"},Ss={class:"relative"},qs=["onClick"],Ms={key:0,class:"absolute right-0 top-full mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-100 py-1 z-50"},Us=["onClick"],Vs=["onClick"],Ds=["onClick"],Hs=["onClick"],Ns=["onClick"],Fs=["onClick"],zs=["onClick"],Ls=["onClick"],Os={key:1,class:"space-y-6"},Rs={key:0,class:"flex items-center justify-center py-20"},Gs={key:1,class:"bg-white border border-gray-100 rounded-lg py-12 text-center"},Is={key:2,class:"grid gap-4"},Qs={class:"px-5 py-4 border-b border-gray-100 bg-gray-50/50"},Zs={class:"flex items-center justify-between"},Js={class:"flex items-center gap-3"},Ks={class:"font-semibold text-gray-900"},Ws={class:"text-sm text-gray-500"},Xs={class:"flex items-center gap-4 text-sm"},Ys={class:"text-right"},eo={class:"font-semibold text-green-600"},to={class:"text-right"},so={class:"font-semibold text-gray-600"},oo={class:"text-right"},ro={class:"font-semibold text-gray-900"},ao={class:"divide-y divide-gray-50"},no={key:0,class:"px-5 py-3 hover:bg-gray-50/50 transition-colors flex items-center justify-between"},io=["onClick"],lo={class:"w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-xs font-semibold"},co={class:"flex items-center gap-2"},uo={class:"text-sm font-medium text-gray-900"},po={class:"inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-medium bg-green-100 text-green-700"},go={class:"text-xs text-gray-500"},mo={key:0,class:"text-gray-400 ml-1"},xo={class:"flex items-center gap-4"},fo={class:"flex items-center gap-2"},vo={class:"w-20 h-2 bg-gray-200 rounded-full overflow-hidden"},bo={class:"text-xs text-gray-500 min-w-[40px]"},yo={class:"text-right min-w-[70px]"},_o={class:"text-sm font-medium text-gray-900"},ho=["onClick","title"],wo={key:1,class:"px-5 py-3 hover:bg-gray-50/50 transition-colors flex items-center justify-between"},ko={class:"flex items-center gap-3 flex-1"},Co={class:"w-8 h-8 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center text-xs font-semibold"},Po={class:"flex items-center gap-2"},$o={class:"text-sm font-medium text-gray-600"},Ao={class:"inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600"},jo={class:"text-xs text-gray-400"},Eo=["onClick"],To={key:0,class:"bg-gray-50/50 border-t border-gray-100 overflow-hidden"},Bo={class:"divide-y divide-gray-100"},So=["onClick"],qo={class:"flex items-center gap-3"},Mo={class:"w-6 h-6 rounded bg-gray-200 flex items-center justify-center"},Uo={class:"flex items-center gap-2"},Vo={class:"text-gray-600"},Do={class:"text-xs text-gray-400"},Ho={class:"text-right"},No={class:"text-gray-600"},Fo={key:0,class:"px-5 py-2 bg-amber-50/50 border-t border-amber-100 flex items-center justify-between text-sm"},zo={class:"font-semibold text-amber-700"},Lo={key:2,class:"space-y-4"},Oo={class:"bg-white border border-gray-100 rounded-lg p-4"},Ro={class:"flex flex-wrap items-center gap-4"},Go={class:"flex items-center gap-2"},Io={class:"relative"},Qo={class:"flex items-center gap-2"},Zo={class:"relative"},Jo={class:"flex items-center gap-2"},Ko={class:"relative"},Wo=["disabled"],Xo={key:1,class:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"},Yo={class:"bg-white border border-gray-100 rounded-lg overflow-hidden"},er={key:0,class:"py-12 text-center"},tr={key:1,class:"w-full"},sr={class:"divide-y divide-gray-50"},or={class:"px-4 py-3"},rr={class:"text-sm font-medium text-gray-900"},ar={key:0,class:"text-xs text-gray-500"},nr={class:"px-4 py-3"},ir={class:"px-4 py-3 text-center text-sm text-gray-600"},lr={class:"px-4 py-3 text-right text-sm font-medium text-gray-900"},dr={class:"px-4 py-3"},cr={class:"flex items-center justify-end gap-1"},ur=["onClick"],pr=["onClick"],gr={key:3,class:"space-y-4"},mr={class:"flex flex-wrap items-center gap-3"},xr={class:"relative flex-1 min-w-[200px] max-w-md"},fr={class:"text-xs opacity-75"},vr={key:0,class:"flex items-center justify-center py-20"},br={key:1,class:"bg-white border border-gray-100 rounded-lg overflow-hidden"},yr={key:0,class:"py-12 text-center"},_r={class:"text-gray-600 font-medium mb-1"},hr={class:"text-sm text-gray-400"},wr={key:1,class:"w-full"},kr={class:"divide-y divide-gray-50"},Cr=["onClick"],Pr={class:"px-4 py-3"},$r={class:"flex items-center gap-2"},Ar={class:"w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-xs font-semibold flex-shrink-0"},jr={class:"text-sm font-medium text-gray-900 truncate"},Er={class:"px-4 py-3"},Tr={class:"text-sm text-gray-600"},Br={class:"px-4 py-3"},Sr={class:"flex items-center gap-2 justify-center"},qr={class:"w-16 h-1.5 bg-gray-200 rounded-full overflow-hidden"},Mr={class:"text-xs text-gray-500"},Ur={class:"px-4 py-3"},Vr={class:"px-4 py-3 text-right"},Dr={class:"text-sm font-medium text-gray-900"},Hr={class:"px-4 py-3 text-right"},Nr={class:"bg-white rounded-xl shadow-2xl w-full max-w-md"},Fr={class:"px-5 py-4 border-b border-gray-100 flex items-center justify-between"},zr={class:"font-semibold text-gray-900"},Lr={class:"p-5 space-y-4"},Or={class:"grid grid-cols-2 gap-3"},Rr={class:"px-5 py-4 border-t border-gray-100 flex items-center justify-end gap-3"},Gr=["disabled"],ua=pt({__name:"bonos",setup(J){const E=gt(),T=mt(),{user:ne}=xt(),{calcularPorcentajeUso:he}=bt(),x=v("pacientes"),O=v([]),w=v(null);v(!1),v(!1),v(null);const B=v([]),K=v(!1),U=v(null),y=v({nombre:"",descripcion:"",sesiones:4,precio:160,frecuencia:"mensual"}),A=v({semanal:40,quincenal:50,unica:60}),ie=v({semanal:40,quincenal:50,unica:60}),H=v(!1),N=v(!1),Me=L(()=>JSON.stringify(A.value)!==JSON.stringify(ie.value)),b=v([]),R=v(!1),k=v(""),C=v(""),S=v(""),$=v("reciente"),_=v(null),F=v([]),we=(s,e)=>{const o=`${e}-${s}`,a=F.value.indexOf(o);a>=0?F.value.splice(a,1):F.value.push(o)},le=L(()=>{const s=new Map;for(const e of b.value){const o=e.tipo||"otro";s.has(o)||s.set(o,{tipo:o,pacientes:[],activos:0,completados:0,montoTotal:0,montoPendiente:0,precioPromedio:0,sesionesPromedio:0});const a=s.get(o);let d=a.pacientes.find(f=>f.paciente_id===e.paciente_id);d||(d={paciente_id:e.paciente_id,nombre:e.paciente_nombre||"Desconocido",bonoActivo:null,bonosHistoricos:[],totalBonos:0,montoTotal:0,montoPendiente:0},a.pacientes.push(d));const m={bono_id:e.id,paciente_id:e.paciente_id,nombre:e.paciente_nombre||"Desconocido",sesiones_usadas:e.sesiones_totales-e.sesiones_restantes,sesiones_totales:e.sesiones_totales,estado:e.estado,monto:e.monto_total||0,pagado:e.pagado,created_at:e.created_at},z=e.estado==="activo"||e.estado==="pendiente"&&e.sesiones_restantes>0;e.estado==="completado"||e.estado==="agotado"||e.sesiones_restantes,z&&!d.bonoActivo?d.bonoActivo=m:z&&d.bonoActivo&&new Date(e.created_at)>new Date(d.bonoActivo.created_at)?(d.bonosHistoricos.push(d.bonoActivo),d.bonoActivo=m):d.bonosHistoricos.push(m),d.totalBonos++,d.montoTotal+=e.monto_total||0,e.pagado||(d.montoPendiente+=e.monto_total||0),a.montoTotal+=e.monto_total||0,e.pagado||(a.montoPendiente+=e.monto_total||0),e.estado==="activo"&&a.activos++,(e.estado==="completado"||e.sesiones_restantes===0)&&a.completados++}for(const e of s.values()){for(const o of e.pacientes)o.bonosHistoricos.sort((a,d)=>new Date(d.created_at).getTime()-new Date(a.created_at).getTime());if(e.pacientes.length>0){const o=e.pacientes.reduce((d,m)=>d+m.totalBonos,0);e.precioPromedio=e.montoTotal/o;const a=e.pacientes.reduce((d,m)=>{const z=m.bonoActivo?.sesiones_totales||0,f=m.bonosHistoricos.reduce((ge,ut)=>ge+ut.sesiones_totales,0);return d+z+f},0);e.sesionesPromedio=Math.round(a/o)}}return Array.from(s.values()).sort((e,o)=>o.pacientes.length-e.pacientes.length)}),de=L(()=>{const s=new Map;for(const e of b.value){const o=e.paciente_id;if(!o)continue;s.has(o)||s.set(o,{id:o,nombre:e.paciente_nombre||"Desconocido",bonos:[],sesionesUsadas:0,sesionesTotales:0,montoTotal:0,montoPendiente:0,requiereAccion:!1,prioridad:"normal"});const a=s.get(o);a.bonos.push(e),a.sesionesUsadas+=e.sesiones_totales-e.sesiones_restantes,a.sesionesTotales+=e.sesiones_totales,a.montoTotal+=e.monto_total||0,e.pagado||(a.montoPendiente+=e.monto_total||0);const d=e.sesiones_restantes===0,m=!e.pagado;d&&m?(a.requiereAccion=!0,a.prioridad="urgente"):(e.sesiones_restantes<=2&&e.estado==="activo"||m)&&(a.requiereAccion=!0,a.prioridad!=="urgente"&&(a.prioridad="atencion"))}return Array.from(s.values()).sort((e,o)=>{const a={urgente:0,atencion:1,normal:2},d=a[e.prioridad],m=a[o.prioridad];return d!==m?d-m:o.montoPendiente-e.montoPendiente})});L(()=>b.value.filter(s=>s.estado==="activo").length);const j=L(()=>{const s=b.value.filter(f=>f.estado==="activo").length,e=b.value.filter(f=>f.estado==="pendiente").length,o=b.value.filter(f=>f.estado==="completado"||f.estado==="agotado"||f.sesiones_restantes===0).length,a=b.value.filter(f=>!f.pagado),d=a.reduce((f,ge)=>f+(ge.monto_total||0),0),m=b.value.filter(f=>f.estado==="activo"&&f.sesiones_restantes<=2&&f.sesiones_restantes>0).length,z=b.value.filter(f=>f.sesiones_restantes===0&&!f.pagado).length;return{activos:s,pendientes:e,completados:o,montoPendiente:d,bonosSinPagar:a.length,proximosAgotar:m,urgentes:z}}),ce=L(()=>{let s=[...b.value];if(_.value&&(_.value==="pendientes_cobro"?s=s.filter(e=>!e.pagado):_.value==="proximos_agotar"?s=s.filter(e=>e.estado==="activo"&&e.sesiones_restantes<=2&&e.sesiones_restantes>0):_.value==="urgentes"&&(s=s.filter(e=>e.sesiones_restantes===0&&!e.pagado))),k.value){const e=k.value.toLowerCase();s=s.filter(o=>o.paciente_nombre?.toLowerCase().includes(e))}return C.value&&(s=s.filter(e=>e.estado===C.value)),S.value&&(S.value==="pagado"?s=s.filter(e=>e.pagado):S.value==="pendiente"&&(s=s.filter(e=>!e.pagado))),$.value==="reciente"?s.sort((e,o)=>new Date(o.created_at).getTime()-new Date(e.created_at).getTime()):$.value==="antiguo"?s.sort((e,o)=>new Date(e.created_at).getTime()-new Date(o.created_at).getTime()):$.value==="nombre"?s.sort((e,o)=>(e.paciente_nombre||"").localeCompare(o.paciente_nombre||"")):$.value==="monto_desc"?s.sort((e,o)=>(o.monto_total||0)-(e.monto_total||0)):$.value==="monto_asc"?s.sort((e,o)=>(e.monto_total||0)-(o.monto_total||0)):$.value==="progreso"&&s.sort((e,o)=>{const a=e.sesiones_totales>0?(e.sesiones_totales-e.sesiones_restantes)/e.sesiones_totales:0;return(o.sesiones_totales>0?(o.sesiones_totales-o.sesiones_restantes)/o.sesiones_totales:0)-a}),s}),ke=()=>{y.value={nombre:"",descripcion:"",sesiones:4,precio:160,frecuencia:"mensual"},U.value=null,K.value=!0},Ue=s=>{const e=B.value[s];y.value={...e},U.value=s,K.value=!0},Ve=s=>{confirm("¿Eliminar esta plantilla?")&&(B.value.splice(s,1),Ce())},W=()=>{K.value=!1,U.value=null},De=async()=>{U.value!==null?B.value[U.value]={...y.value}:B.value.push({...y.value}),await Ce(),W()},Ce=async()=>{try{const{error:s}=await T.from("terapeutas").update({plantillas_bonos:B.value}).eq("email",ne.value?.email);if(s)throw s}catch(s){console.error("Error al guardar plantillas:",s)}},He=async()=>{H.value=!0,N.value=!1;try{const{error:s}=await T.from("terapeutas").update({precios_frecuencia:A.value}).eq("email",ne.value?.email);if(s)throw s;ie.value={...A.value},N.value=!0,setTimeout(()=>{N.value=!1},2e3)}catch(s){console.error("Error al guardar precios:",s)}finally{H.value=!1}},X=s=>{E.push(`/terapeuta/pacientes/${s.paciente_id}/bonos`)},G=s=>s?.toFixed(2)||"0.00",ue=s=>({semanal:"Semanal",quincenal:"Quincenal",mensual:"Mensual",cualquiera:"Cualquiera",otro:"Otro"})[s]||s||"Otro",Ne=s=>({semanal:"bg-blue-100 text-blue-700",quincenal:"bg-purple-100 text-purple-700",mensual:"bg-amber-100 text-amber-700",cualquiera:"bg-gray-100 text-gray-700"})[s]||"bg-gray-100 text-gray-700",Y=s=>s?s.split(" ").map(e=>e[0]).join("").substring(0,2).toUpperCase():"?",Fe=s=>({activo:"Activo",pendiente:"Pendiente",completado:"Completado",vencido:"Vencido",agotado:"Agotado"})[s]||s,ze=s=>({activo:"text-green-600",pendiente:"text-amber-600",completado:"text-gray-600",vencido:"text-red-600",agotado:"text-gray-500"})[s]||"text-gray-600",Le=s=>({activo:"bg-green-500",pendiente:"bg-amber-500",completado:"bg-gray-400",vencido:"bg-red-500",agotado:"bg-gray-400"})[s]||"bg-gray-400",Oe=s=>s.estado==="activo"?"bg-purple-500":s.estado==="completado"||s.estado==="agotado"?"bg-green-500":"bg-gray-400",Re=s=>{const e=s.sesiones_totales-s.sesiones_usadas,o=e/s.sesiones_totales*100;return e===0||o<25?"bg-red-500":o<=50?"bg-amber-500":"bg-green-500"},ee=s=>{const e=s.sesiones_totales-s.sesiones_usadas;return e===0&&!s.pagado?{texto:"Cobrar",clase:"bg-red-100 text-red-700",icono:ae}:e<=2&&e>0&&s.pagado?{texto:"Casi agotado",clase:"bg-orange-100 text-orange-700",icono:fe}:!s.pagado&&e>0?{texto:"Sin pagar",clase:"bg-amber-100 text-amber-700",icono:be}:null},Ge=s=>({semanal:"Bono Semanal",quincenal:"Bono Quincenal",mensual:"Bono Mensual","5_sesiones":"Bono 5 Sesiones","10_sesiones":"Bono 10 Sesiones",personalizado:"Bono Personalizado",otro:"Otros Bonos"})[s]||`Bono ${s.charAt(0).toUpperCase()+s.slice(1)}`,Pe=s=>({semanal:"bg-blue-100 text-blue-600",quincenal:"bg-purple-100 text-purple-600",mensual:"bg-amber-100 text-amber-600","5_sesiones":"bg-emerald-100 text-emerald-600","10_sesiones":"bg-teal-100 text-teal-600",personalizado:"bg-pink-100 text-pink-600",otro:"bg-gray-100 text-gray-600"})[s]||"bg-gray-100 text-gray-600",Ie=s=>{const e=O.value.indexOf(s);e>=0?O.value.splice(e,1):O.value.push(s)},Qe=s=>s.prioridad==="urgente"?"bg-red-100 text-red-700 border border-red-200":s.prioridad==="atencion"?"bg-amber-100 text-amber-700 border border-amber-200":"bg-gray-100 text-gray-600",Ze=s=>s.prioridad==="urgente"?"Cobro urgente":s.prioridad==="atencion"?"Requiere atención":"",Je=s=>s.sesiones_restantes===0&&!s.pagado?"Cobrar":s.sesiones_restantes===0?"Finalizado":s.sesiones_restantes<=2&&s.estado==="activo"?"Por agotar":s.estado==="activo"?"Activo":s.estado==="pendiente"?"Sin iniciar":"Finalizado",Ke=s=>s.sesiones_restantes===0&&!s.pagado?"bg-red-100 text-red-700":s.sesiones_restantes===0&&s.pagado?"bg-green-100 text-green-700":s.sesiones_restantes<=2&&s.estado==="activo"?"bg-orange-100 text-orange-700":s.estado==="activo"?"bg-blue-100 text-blue-700":s.estado==="pendiente"?"bg-amber-100 text-amber-700":"bg-gray-100 text-gray-600",We=s=>s.sesiones_restantes===0&&!s.pagado?ae:s.sesiones_restantes===0?Q:s.sesiones_restantes<=2&&s.estado==="activo"?fe:s.estado==="activo"?Q:s.estado==="pendiente"?be:ve,Xe=s=>s.sesiones_restantes===0&&!s.pagado?"bg-red-500":s.sesiones_restantes===0?"bg-green-500":s.sesiones_restantes<=2?"bg-orange-500":"bg-purple-500",pe=s=>s?new Date(s).toLocaleDateString("es-ES",{day:"numeric",month:"short"}):"",Ye=()=>{x.value="bonos",C.value="",k.value="",_.value="pendientes_cobro"},et=()=>{x.value="bonos",C.value="",k.value="",_.value="proximos_agotar"},tt=()=>{x.value="bonos",C.value="",k.value="",_.value="urgentes"},st=()=>{k.value="",C.value="",S.value="",$.value="reciente",_.value=null},ot=s=>{w.value===s?w.value=null:w.value=s},$e=async s=>{if(w.value=null,confirm(`¿Registrar el pago de ${s.monto_total}€ para este bono?`))try{const{error:e}=await T.from("bonos").update({pagado:!0}).eq("id",s.id);if(e)throw e;const o=b.value.findIndex(a=>a.id===s.id);o>=0&&(b.value[o].pagado=!0)}catch(e){console.error("Error al registrar pago:",e),alert("Error al registrar el pago")}},rt=s=>{w.value=null,E.push(`/terapeuta/pacientes/${s.paciente_id}/bonos?bono=${s.id}`)},at=s=>{w.value=null,E.push(`/terapeuta/agenda?paciente=${s.paciente_id}&bono=${s.id}`)},nt=s=>{w.value=null,E.push(`/terapeuta/pacientes/${s.paciente_id}/bonos?editar=${s.id}`)},it=async s=>{if(w.value=null,confirm("¿Pausar este bono? El paciente no podrá usar las sesiones restantes mientras esté pausado."))try{const{error:e}=await T.from("bonos").update({estado:"pausado"}).eq("id",s.id);if(e)throw e;const o=b.value.findIndex(a=>a.id===s.id);o>=0&&(b.value[o].estado="pausado")}catch(e){console.error("Error al pausar bono:",e),alert("Error al pausar el bono")}},lt=async s=>{w.value=null;try{const{error:e}=await T.from("bonos").update({estado:"activo"}).eq("id",s.id);if(e)throw e;const o=b.value.findIndex(a=>a.id===s.id);o>=0&&(b.value[o].estado="activo")}catch(e){console.error("Error al reactivar bono:",e),alert("Error al reactivar el bono")}},Ae=s=>{w.value=null,E.push(`/terapeuta/pacientes/${s.paciente_id}/bonos?nuevo=1&tipo=${s.tipo}`)},dt=async s=>{w.value=null;const e=s.sesiones_totales-s.sesiones_restantes;if(e>0){if(!confirm(`Este bono tiene ${e} sesiones utilizadas. ¿Estás seguro de eliminarlo? Esta acción no se puede deshacer.`))return}else if(!confirm("¿Eliminar este bono? Esta acción no se puede deshacer."))return;try{const{error:o}=await T.from("bonos").delete().eq("id",s.id);if(o)throw o;b.value=b.value.filter(a=>a.id!==s.id)}catch(o){console.error("Error al eliminar bono:",o),alert("Error al eliminar el bono")}},ct=async()=>{try{const{data:s}=await T.from("terapeutas").select("id, plantillas_bonos, precios_frecuencia").eq("email",ne.value?.email).single();if(s){B.value=s.plantillas_bonos||[],s.precios_frecuencia&&(A.value=s.precios_frecuencia,ie.value={...s.precios_frecuencia}),R.value=!0;const{data:e}=await T.from("pacientes").select("id, nombre_completo").eq("terapeuta_id",s.id);if(e&&e.length>0){const o=e.map(m=>m.id),a=new Map(e.map(m=>[m.id,m.nombre_completo])),{data:d}=await T.from("bonos").select("*").in("paciente_id",o).order("created_at",{ascending:!1});d&&(b.value=d.map(m=>({...m,paciente_nombre:a.get(m.paciente_id)||"Desconocido"})))}}}catch(s){console.error("Error al cargar datos:",s)}finally{R.value=!1}};return ft(()=>{ct()}),(s,e)=>(i(),l("div",null,[t("header",At,[t("div",jt,[t("div",Et,[e[20]||(e[20]=t("h1",{class:"text-2xl font-semibold text-gray-900"},"Bonos",-1)),t("nav",Tt,[t("button",{onClick:e[0]||(e[0]=o=>x.value="pacientes"),class:p(["px-3 py-1.5 text-sm font-medium rounded-md transition-all",r(x)==="pacientes"?"bg-white text-gray-900 shadow-sm":"text-gray-600 hover:text-gray-900"])},[e[16]||(e[16]=g(" Por Paciente ",-1)),t("span",{class:p(["ml-1 text-xs",r(x)==="pacientes"?"text-gray-500":"text-gray-400"])},n(r(de).length),3)],2),t("button",{onClick:e[1]||(e[1]=o=>x.value="resumen"),class:p(["px-3 py-1.5 text-sm font-medium rounded-md transition-all",r(x)==="resumen"?"bg-white text-gray-900 shadow-sm":"text-gray-600 hover:text-gray-900"])},[e[17]||(e[17]=g(" Por Tipo ",-1)),t("span",{class:p(["ml-1 text-xs",r(x)==="resumen"?"text-gray-500":"text-gray-400"])},n(r(le).length),3)],2),t("button",{onClick:e[2]||(e[2]=o=>x.value="bonos"),class:p(["px-3 py-1.5 text-sm font-medium rounded-md transition-all",r(x)==="bonos"?"bg-white text-gray-900 shadow-sm":"text-gray-600 hover:text-gray-900"])},[e[18]||(e[18]=g(" Todos ",-1)),t("span",{class:p(["ml-1 text-xs",r(x)==="bonos"?"text-gray-500":"text-gray-400"])},n(r(b).length),3)],2),t("button",{onClick:e[3]||(e[3]=o=>x.value="plantillas"),class:p(["px-3 py-1.5 text-sm font-medium rounded-md transition-all",r(x)==="plantillas"?"bg-white text-gray-900 shadow-sm":"text-gray-600 hover:text-gray-900"])},[e[19]||(e[19]=g(" Plantillas ",-1)),t("span",{class:p(["ml-1 text-xs",r(x)==="plantillas"?"text-gray-500":"text-gray-400"])},n(r(B).length),3)],2)])]),r(x)==="plantillas"?(i(),l("button",{key:0,onClick:ke,class:"h-10 px-4 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-2 shadow-sm"},[c(r(Te),{class:"w-4 h-4"}),e[21]||(e[21]=g(" Nueva Plantilla ",-1))])):u("",!0)]),r(x)==="bonos"||r(x)==="resumen"||r(x)==="pacientes"?(i(),l("div",Bt,[t("div",{onClick:Ye,class:"col-span-2 md:col-span-1 bg-gradient-to-br from-amber-50 to-orange-50 border border-amber-200 rounded-xl p-4 cursor-pointer hover:shadow-md transition-all group"},[t("div",St,[t("div",qt,[c(r(xe),{class:"w-4 h-4 text-amber-600"})]),e[22]||(e[22]=t("span",{class:"text-xs font-medium text-amber-600 uppercase"},"Por Cobrar",-1))]),t("p",Mt,n(G(r(j).montoPendiente))+"€",1),t("div",Ut,[t("p",Vt,n(r(j).bonosSinPagar)+" bonos",1),t("span",Dt,[e[23]||(e[23]=g(" Ver ",-1)),c(r(I),{class:"w-3 h-3"})])])]),t("div",Ht,[t("div",Nt,[t("div",Ft,[c(r(Q),{class:"w-4 h-4 text-green-600"})]),e[24]||(e[24]=t("span",{class:"text-xs font-medium text-green-600 uppercase"},"Activos",-1))]),t("p",zt,n(r(j).activos),1),e[25]||(e[25]=t("p",{class:"text-xs text-gray-500 mt-1"},"En uso actualmente",-1))]),r(j).proximosAgotar>0?(i(),l("div",{key:0,onClick:et,class:"bg-gradient-to-br from-red-50 to-rose-50 border border-red-200 rounded-xl p-4 cursor-pointer hover:shadow-md transition-all group"},[t("div",Lt,[t("div",Ot,[c(r(fe),{class:"w-4 h-4 text-red-600"})]),e[26]||(e[26]=t("span",{class:"text-xs font-medium text-red-600 uppercase"},"Por Agotar",-1))]),t("p",Rt,n(r(j).proximosAgotar),1),t("div",Gt,[e[28]||(e[28]=t("p",{class:"text-xs text-red-600"},"≤2 sesiones",-1)),t("span",It,[e[27]||(e[27]=g(" Ver ",-1)),c(r(I),{class:"w-3 h-3"})])])])):(i(),l("div",Qt,[t("div",Zt,[t("div",Jt,[c(r(ve),{class:"w-4 h-4 text-gray-600"})]),e[29]||(e[29]=t("span",{class:"text-xs font-medium text-gray-600 uppercase"},"Finalizados",-1))]),t("p",Kt,n(r(j).completados),1),e[30]||(e[30]=t("p",{class:"text-xs text-gray-500 mt-1"},"Este mes",-1))])),r(j).urgentes>0?(i(),l("div",{key:2,onClick:tt,class:"bg-gradient-to-br from-red-100 to-rose-100 border-2 border-red-300 rounded-xl p-4 cursor-pointer hover:shadow-md transition-all group animate-pulse-subtle"},[t("div",Wt,[t("div",Xt,[c(r(ae),{class:"w-4 h-4 text-red-700"})]),e[31]||(e[31]=t("span",{class:"text-xs font-medium text-red-700 uppercase"},"Urgente",-1))]),t("p",Yt,n(r(j).urgentes),1),t("div",es,[e[33]||(e[33]=t("p",{class:"text-xs text-red-700"},"Agotados sin pagar",-1)),t("span",ts,[e[32]||(e[32]=g(" Ver ",-1)),c(r(I),{class:"w-3 h-3"})])])])):u("",!0),r(j).proximosAgotar>0?(i(),l("div",ss,[t("div",os,[t("div",rs,[c(r(_e),{class:"w-4 h-4 text-gray-600"})]),e[34]||(e[34]=t("span",{class:"text-xs font-medium text-gray-600 uppercase"},"Finalizados",-1))]),t("p",as,n(r(j).completados),1),e[35]||(e[35]=t("p",{class:"text-xs text-gray-500 mt-1"},"Sesiones agotadas",-1))])):u("",!0)])):u("",!0)]),r(x)==="pacientes"?(i(),l("div",ns,[r(R)?(i(),l("div",is,[...e[36]||(e[36]=[t("div",{class:"w-8 h-8 border-2 border-purple-600 border-t-transparent rounded-full animate-spin"},null,-1)])])):r(de).length===0?(i(),l("div",ls,[c(r(_t),{class:"w-12 h-12 text-gray-300 mx-auto mb-3"}),e[37]||(e[37]=t("p",{class:"text-gray-600 font-medium mb-1"},"Sin bonos asignados",-1)),e[38]||(e[38]=t("p",{class:"text-sm text-gray-400"},"Los bonos de tus pacientes aparecerán aquí",-1))])):(i(),l("div",ds,[(i(!0),l(V,null,D(r(de),o=>(i(),l("div",{key:o.id,class:"bg-white border border-gray-100 rounded-lg overflow-hidden"},[t("div",{onClick:a=>Ie(o.id),class:"px-4 py-3 flex items-center justify-between cursor-pointer hover:bg-gray-50/50 transition-colors"},[t("div",us,[t("div",ps,n(Y(o.nombre)),1),t("div",null,[t("p",gs,n(o.nombre),1),t("div",ms,[t("span",null,n(o.bonos.length)+" "+n(o.bonos.length===1?"bono":"bonos"),1),e[39]||(e[39]=t("span",{class:"text-gray-300"},"|",-1)),t("span",null,n(o.sesionesUsadas)+"/"+n(o.sesionesTotales)+" sesiones",1)])])]),t("div",xs,[o.requiereAccion?(i(),l("span",{key:0,class:p(["inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium",Qe(o)])},[o.prioridad==="urgente"?(i(),q(r(ae),{key:0,class:"w-3.5 h-3.5"})):o.prioridad==="atencion"?(i(),q(r(be),{key:1,class:"w-3.5 h-3.5"})):u("",!0),g(" "+n(Ze(o)),1)],2)):u("",!0),t("div",fs,[t("p",vs,n(G(o.montoTotal))+"€",1),t("p",{class:p(["text-xs",o.montoPendiente>0?"text-amber-600":"text-green-600"])},n(o.montoPendiente>0?`${G(o.montoPendiente)}€ pend.`:"Todo pagado"),3)]),c(r(ye),{class:p(["w-5 h-5 text-gray-400 transition-transform",{"rotate-180":r(O).includes(o.id)}])},null,8,["class"])])],8,cs),c(re,{"enter-active-class":"transition-all duration-200 ease-out","enter-from-class":"opacity-0 max-h-0","enter-to-class":"opacity-100 max-h-[500px]","leave-active-class":"transition-all duration-150 ease-in","leave-from-class":"opacity-100 max-h-[500px]","leave-to-class":"opacity-0 max-h-0"},{default:oe(()=>[r(O).includes(o.id)?(i(),l("div",bs,[t("div",ys,[(i(!0),l(V,null,D(o.bonos,a=>(i(),l("div",{key:a.id,class:"px-4 py-3 pl-16 hover:bg-gray-50/50 transition-colors group"},[t("div",_s,[t("div",{onClick:h(d=>X(a),["stop"]),class:"flex items-center gap-3 cursor-pointer flex-1"},[t("div",{class:p(["w-8 h-8 rounded-lg flex items-center justify-center",Pe(a.tipo)])},[c(r(Z),{class:"w-4 h-4"})],2),t("div",null,[t("div",ws,[t("span",ks,n(ue(a.tipo)),1),t("span",{class:p(["inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium",Ke(a)])},[(i(),q(Ee(We(a)),{class:"w-3 h-3"})),g(" "+n(Je(a)),1)],2)]),t("p",Cs,[g(n(a.sesiones_totales-a.sesiones_restantes)+"/"+n(a.sesiones_totales)+" sesiones ",1),a.fecha_fin?(i(),l("span",Ps,"• Vence "+n(pe(a.fecha_fin)),1)):u("",!0)])])],8,hs),t("div",$s,[a.pagado?a.sesiones_restantes===0?(i(),l("button",{key:1,onClick:h(d=>Ae(a),["stop"]),class:"hidden sm:flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium bg-purple-100 text-purple-700 hover:bg-purple-200 rounded-lg transition-all"},[c(r(Te),{class:"w-3.5 h-3.5"}),e[40]||(e[40]=g(" Nuevo bono ",-1))],8,js)):u("",!0):(i(),l("button",{key:0,onClick:h(d=>$e(a),["stop"]),class:p(["hidden sm:flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-lg transition-all",a.sesiones_restantes===0?"bg-red-100 text-red-700 hover:bg-red-200":"bg-amber-100 text-amber-700 hover:bg-amber-200"])},[c(r(xe),{class:"w-3.5 h-3.5"}),g(" "+n(a.sesiones_restantes===0?"Cobrar ahora":"Registrar pago"),1)],10,As)),t("div",Es,[t("div",{class:p(["h-full rounded-full transition-all",Xe(a)]),style:me({width:`${r(he)(a)}%`})},null,6)]),t("div",Ts,[t("p",Bs,n(a.monto_total)+"€",1),t("p",{class:p(["text-xs",a.pagado?"text-green-600":"text-amber-600"])},n(a.pagado?"Pagado":"Pendiente"),3)]),t("div",Ss,[t("button",{onClick:h(d=>ot(a.id),["stop"]),class:"p-1.5 rounded-lg text-gray-400 hover:text-gray-600 hover:bg-gray-100 transition-colors"},[c(r(yt),{class:"w-5 h-5"})],8,qs),c(re,{"enter-active-class":"transition-all duration-150 ease-out","enter-from-class":"opacity-0 scale-95","enter-to-class":"opacity-100 scale-100","leave-active-class":"transition-all duration-100 ease-in","leave-from-class":"opacity-100 scale-100","leave-to-class":"opacity-0 scale-95"},{default:oe(()=>[r(w)===a.id?(i(),l("div",Ms,[t("button",{onClick:h(d=>rt(a),["stop"]),class:"w-full px-3 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2"},[c(r(ht),{class:"w-4 h-4 text-gray-400"}),e[41]||(e[41]=g(" Ver historial ",-1))],8,Us),a.pagado?u("",!0):(i(),l("button",{key:0,onClick:h(d=>$e(a),["stop"]),class:"w-full px-3 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2"},[c(r(xe),{class:"w-4 h-4 text-gray-400"}),e[42]||(e[42]=g(" Registrar pago ",-1))],8,Vs)),a.estado==="activo"&&a.sesiones_restantes>0?(i(),l("button",{key:1,onClick:h(d=>at(a),["stop"]),class:"w-full px-3 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2"},[c(r(wt),{class:"w-4 h-4 text-gray-400"}),e[43]||(e[43]=g(" Añadir sesión ",-1))],8,Ds)):u("",!0),t("button",{onClick:h(d=>nt(a),["stop"]),class:"w-full px-3 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2"},[c(r(Be),{class:"w-4 h-4 text-gray-400"}),e[44]||(e[44]=g(" Editar bono ",-1))],8,Hs),e[49]||(e[49]=t("div",{class:"border-t border-gray-100 my-1"},null,-1)),a.estado==="activo"?(i(),l("button",{key:2,onClick:h(d=>it(a),["stop"]),class:"w-full px-3 py-2 text-left text-sm text-amber-600 hover:bg-amber-50 flex items-center gap-2"},[c(r(Ct),{class:"w-4 h-4"}),e[45]||(e[45]=g(" Pausar bono ",-1))],8,Ns)):a.estado==="pausado"?(i(),l("button",{key:3,onClick:h(d=>lt(a),["stop"]),class:"w-full px-3 py-2 text-left text-sm text-green-600 hover:bg-green-50 flex items-center gap-2"},[c(r(Pt),{class:"w-4 h-4"}),e[46]||(e[46]=g(" Reactivar bono ",-1))],8,Fs)):u("",!0),a.sesiones_restantes===0?(i(),l("button",{key:4,onClick:h(d=>Ae(a),["stop"]),class:"w-full px-3 py-2 text-left text-sm text-purple-600 hover:bg-purple-50 flex items-center gap-2"},[c(r($t),{class:"w-4 h-4"}),e[47]||(e[47]=g(" Crear nuevo bono ",-1))],8,zs)):u("",!0),t("button",{onClick:h(d=>dt(a),["stop"]),class:"w-full px-3 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2"},[c(r(Se),{class:"w-4 h-4"}),e[48]||(e[48]=g(" Eliminar bono ",-1))],8,Ls)])):u("",!0)]),_:2},1024)])])])]))),128))])])):u("",!0)]),_:2},1024)]))),128))]))])):u("",!0),r(x)==="resumen"?(i(),l("div",Os,[r(R)?(i(),l("div",Rs,[...e[50]||(e[50]=[t("div",{class:"w-8 h-8 border-2 border-purple-600 border-t-transparent rounded-full animate-spin"},null,-1)])])):r(le).length===0?(i(),l("div",Gs,[c(r(Z),{class:"w-12 h-12 text-gray-300 mx-auto mb-3"}),e[51]||(e[51]=t("p",{class:"text-gray-600 font-medium mb-1"},"Sin bonos asignados",-1)),e[52]||(e[52]=t("p",{class:"text-sm text-gray-400"},"Los bonos de tus pacientes apareceran aqui agrupados por tipo",-1))])):(i(),l("div",Is,[(i(!0),l(V,null,D(r(le),o=>(i(),l("div",{key:o.tipo,class:"bg-white border border-gray-100 rounded-lg overflow-hidden"},[t("div",Qs,[t("div",Zs,[t("div",Js,[t("div",{class:p(["w-10 h-10 rounded-lg flex items-center justify-center",Pe(o.tipo)])},[c(r(Z),{class:"w-5 h-5"})],2),t("div",null,[t("h3",Ks,n(Ge(o.tipo)),1),t("p",Ws,n(o.pacientes.length)+" "+n(o.pacientes.length===1?"paciente":"pacientes"),1)])]),t("div",Xs,[t("div",Ys,[e[53]||(e[53]=t("p",{class:"text-gray-500"},"Activos",-1)),t("p",eo,n(o.activos),1)]),t("div",to,[e[54]||(e[54]=t("p",{class:"text-gray-500"},"Completados",-1)),t("p",so,n(o.completados),1)]),t("div",oo,[e[55]||(e[55]=t("p",{class:"text-gray-500"},"Total facturado",-1)),t("p",ro,n(G(o.montoTotal))+"€",1)])])])]),t("div",ao,[(i(!0),l(V,null,D(o.pacientes,a=>(i(),l("div",{key:a.paciente_id,class:"overflow-hidden"},[a.bonoActivo?(i(),l("div",no,[t("div",{class:"flex items-center gap-3 cursor-pointer flex-1",onClick:d=>X({paciente_id:a.paciente_id})},[t("div",lo,n(Y(a.nombre)),1),t("div",null,[t("div",co,[t("p",uo,n(a.nombre),1),t("span",po,[c(r(Q),{class:"w-3 h-3"}),e[56]||(e[56]=g(" Activo ",-1))]),ee(a.bonoActivo)?(i(),l("span",{key:0,class:p(["inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-medium",ee(a.bonoActivo).clase])},[(i(),q(Ee(ee(a.bonoActivo).icono),{class:"w-3 h-3"})),g(" "+n(ee(a.bonoActivo).texto),1)],2)):u("",!0)]),t("p",go,[g(" Creado: "+n(pe(a.bonoActivo.created_at))+" ",1),a.totalBonos>1?(i(),l("span",mo," • "+n(a.totalBonos)+" bonos en total ",1)):u("",!0)])])],8,io),t("div",xo,[t("div",fo,[t("div",vo,[t("div",{class:p(["h-full rounded-full transition-all",Re(a.bonoActivo)]),style:me({width:`${a.bonoActivo.sesiones_usadas/a.bonoActivo.sesiones_totales*100}%`})},null,6)]),t("span",bo,n(a.bonoActivo.sesiones_totales-a.bonoActivo.sesiones_usadas)+"/"+n(a.bonoActivo.sesiones_totales),1)]),t("div",yo,[t("p",_o,n(a.bonoActivo.monto)+"€",1),t("p",{class:p(["text-xs",a.bonoActivo.pagado?"text-green-600":"text-amber-600"])},n(a.bonoActivo.pagado?"Pagado":"Pendiente"),3)]),a.bonosHistoricos.length>0?(i(),l("button",{key:0,onClick:h(d=>we(a.paciente_id,o.tipo),["stop"]),class:"p-1.5 rounded-lg text-gray-400 hover:text-gray-600 hover:bg-gray-100 transition-colors",title:`Ver ${a.bonosHistoricos.length} bono(s) anterior(es)`},[c(r(ye),{class:p(["w-4 h-4 transition-transform",{"rotate-180":r(F).includes(`${o.tipo}-${a.paciente_id}`)}])},null,8,["class"])],8,ho)):(i(),q(r(I),{key:1,class:"w-4 h-4 text-gray-400"}))])])):a.bonosHistoricos.length>0?(i(),l("div",wo,[t("div",ko,[t("div",Co,n(Y(a.nombre)),1),t("div",null,[t("div",Po,[t("p",$o,n(a.nombre),1),t("span",Ao,[c(r(_e),{class:"w-3 h-3"}),e[57]||(e[57]=g(" Solo histórico ",-1))])]),t("p",jo,n(a.bonosHistoricos.length)+" bono(s) completado(s) ",1)])]),t("button",{onClick:h(d=>we(a.paciente_id,o.tipo),["stop"]),class:"p-1.5 rounded-lg text-gray-400 hover:text-gray-600 hover:bg-gray-100 transition-colors flex items-center gap-1"},[e[58]||(e[58]=t("span",{class:"text-xs"},"Ver historial",-1)),c(r(ye),{class:p(["w-4 h-4 transition-transform",{"rotate-180":r(F).includes(`${o.tipo}-${a.paciente_id}`)}])},null,8,["class"])],8,Eo)])):u("",!0),c(re,{"enter-active-class":"transition-all duration-200 ease-out","enter-from-class":"opacity-0 max-h-0","enter-to-class":"opacity-100 max-h-[400px]","leave-active-class":"transition-all duration-150 ease-in","leave-from-class":"opacity-100 max-h-[400px]","leave-to-class":"opacity-0 max-h-0"},{default:oe(()=>[r(F).includes(`${o.tipo}-${a.paciente_id}`)&&a.bonosHistoricos.length>0?(i(),l("div",To,[e[59]||(e[59]=t("div",{class:"px-5 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-100"}," Historial de bonos ",-1)),t("div",Bo,[(i(!0),l(V,null,D(a.bonosHistoricos,d=>(i(),l("div",{key:d.bono_id,class:"px-5 py-2 pl-16 flex items-center justify-between text-sm hover:bg-gray-100/50 cursor-pointer",onClick:m=>X({paciente_id:d.paciente_id})},[t("div",qo,[t("div",Mo,[c(r(_e),{class:"w-3.5 h-3.5 text-gray-500"})]),t("div",null,[t("div",Uo,[t("span",Vo,n(d.sesiones_usadas)+"/"+n(d.sesiones_totales)+" sesiones",1),t("span",{class:p(["inline-flex items-center px-1.5 py-0.5 rounded text-xs",d.pagado?"bg-green-100 text-green-700":"bg-amber-100 text-amber-700"])},n(d.pagado?"Pagado":"Pendiente"),3)]),t("p",Do," Creado: "+n(pe(d.created_at)),1)])]),t("div",Ho,[t("p",No,n(d.monto)+"€",1)])],8,So))),128))])])):u("",!0)]),_:2},1024)]))),128))]),o.montoPendiente>0?(i(),l("div",Fo,[e[60]||(e[60]=t("span",{class:"text-amber-700 font-medium"},"Por cobrar en este tipo:",-1)),t("span",zo,n(G(o.montoPendiente))+"€",1)])):u("",!0)]))),128))]))])):u("",!0),r(x)==="plantillas"?(i(),l("div",Lo,[t("div",Oo,[t("div",Ro,[e[67]||(e[67]=t("span",{class:"text-sm font-medium text-gray-700"},"Precios base:",-1)),t("div",Go,[e[62]||(e[62]=t("label",{class:"text-sm text-gray-500"},"Semanal",-1)),t("div",Io,[P(t("input",{"onUpdate:modelValue":e[4]||(e[4]=o=>r(A).semanal=o),type:"number",step:"0.01",min:"0",class:"w-20 h-9 px-2 pr-6 text-sm bg-gray-50 border border-gray-200 rounded-lg focus:ring-1 focus:ring-purple-500 focus:border-purple-500"},null,512),[[M,r(A).semanal,void 0,{number:!0}]]),e[61]||(e[61]=t("span",{class:"absolute right-2 top-1/2 -translate-y-1/2 text-xs text-gray-400"},"€",-1))])]),e[68]||(e[68]=t("span",{class:"text-gray-300"},"|",-1)),t("div",Qo,[e[64]||(e[64]=t("label",{class:"text-sm text-gray-500"},"Quincenal",-1)),t("div",Zo,[P(t("input",{"onUpdate:modelValue":e[5]||(e[5]=o=>r(A).quincenal=o),type:"number",step:"0.01",min:"0",class:"w-20 h-9 px-2 pr-6 text-sm bg-gray-50 border border-gray-200 rounded-lg focus:ring-1 focus:ring-purple-500 focus:border-purple-500"},null,512),[[M,r(A).quincenal,void 0,{number:!0}]]),e[63]||(e[63]=t("span",{class:"absolute right-2 top-1/2 -translate-y-1/2 text-xs text-gray-400"},"€",-1))])]),e[69]||(e[69]=t("span",{class:"text-gray-300"},"|",-1)),t("div",Jo,[e[66]||(e[66]=t("label",{class:"text-sm text-gray-500"},"Única",-1)),t("div",Ko,[P(t("input",{"onUpdate:modelValue":e[6]||(e[6]=o=>r(A).unica=o),type:"number",step:"0.01",min:"0",class:"w-20 h-9 px-2 pr-6 text-sm bg-gray-50 border border-gray-200 rounded-lg focus:ring-1 focus:ring-purple-500 focus:border-purple-500"},null,512),[[M,r(A).unica,void 0,{number:!0}]]),e[65]||(e[65]=t("span",{class:"absolute right-2 top-1/2 -translate-y-1/2 text-xs text-gray-400"},"€",-1))])]),t("button",{onClick:He,disabled:r(H),class:p(["ml-auto h-9 px-4 text-sm font-medium rounded-lg transition-colors flex items-center gap-2",r(Me)?"bg-purple-600 text-white hover:bg-purple-700":"bg-gray-100 text-gray-500"])},[!r(H)&&!r(N)?(i(),q(r(ve),{key:0,class:"w-4 h-4"})):u("",!0),r(H)?(i(),l("span",Xo)):u("",!0),r(N)?(i(),q(r(Q),{key:2,class:"w-4 h-4 text-green-500"})):u("",!0),g(" "+n(r(N)?"Guardado":r(H)?"Guardando...":"Guardar"),1)],10,Wo)])]),t("div",Yo,[r(B).length===0?(i(),l("div",er,[c(r(Z),{class:"w-12 h-12 text-gray-300 mx-auto mb-3"}),e[70]||(e[70]=t("p",{class:"text-gray-600 font-medium mb-1"},"Sin plantillas",-1)),e[71]||(e[71]=t("p",{class:"text-sm text-gray-400 mb-4"},"Crea plantillas para asignar bonos rápidamente",-1)),t("button",{onClick:ke,class:"text-sm text-purple-600 font-medium hover:text-purple-700"}," + Crear primera plantilla ")])):(i(),l("table",tr,[e[72]||(e[72]=t("thead",null,[t("tr",{class:"border-b border-gray-100 bg-gray-50/50"},[t("th",{class:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Nombre"),t("th",{class:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Frecuencia"),t("th",{class:"px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider"},"Sesiones"),t("th",{class:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"},"Precio"),t("th",{class:"px-4 py-3 w-20"})])],-1)),t("tbody",sr,[(i(!0),l(V,null,D(r(B),(o,a)=>(i(),l("tr",{key:a,class:"hover:bg-gray-50/50 transition-colors"},[t("td",or,[t("div",rr,n(o.nombre),1),o.descripcion?(i(),l("div",ar,n(o.descripcion),1)):u("",!0)]),t("td",nr,[t("span",{class:p(["inline-flex items-center px-2 py-0.5 rounded text-xs font-medium",Ne(o.frecuencia)])},n(ue(o.frecuencia)),3)]),t("td",ir,n(o.sesiones),1),t("td",lr,n(o.precio)+"€",1),t("td",dr,[t("div",cr,[t("button",{onClick:d=>Ue(a),class:"p-1.5 text-gray-400 hover:text-purple-600 hover:bg-purple-50 rounded transition-colors"},[c(r(Be),{class:"w-4 h-4"})],8,ur),t("button",{onClick:d=>Ve(a),class:"p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors"},[c(r(Se),{class:"w-4 h-4"})],8,pr)])])]))),128))])]))])])):u("",!0),r(x)==="bonos"?(i(),l("div",gr,[t("div",mr,[t("div",xr,[P(t("input",{"onUpdate:modelValue":e[7]||(e[7]=o=>te(k)?k.value=o:null),type:"text",placeholder:"Buscar por paciente...",class:"w-full h-10 px-4 pl-9 bg-white border border-gray-200 rounded-lg text-sm focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20"},null,512),[[M,r(k)]]),c(r(kt),{class:"w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"})]),P(t("select",{"onUpdate:modelValue":e[8]||(e[8]=o=>te(C)?C.value=o:null),class:"h-10 px-3 bg-white border border-gray-200 rounded-lg text-sm text-gray-700 focus:border-purple-500 focus:ring-1 focus:ring-purple-500/20"},[...e[73]||(e[73]=[je('<option value="">Estado: Todos</option><option value="activo">Activos</option><option value="pendiente">Pendientes</option><option value="completado">Completados</option><option value="vencido">Vencidos</option>',5)])],512),[[se,r(C)]]),P(t("select",{"onUpdate:modelValue":e[9]||(e[9]=o=>te(S)?S.value=o:null),class:"h-10 px-3 bg-white border border-gray-200 rounded-lg text-sm text-gray-700 focus:border-purple-500 focus:ring-1 focus:ring-purple-500/20"},[...e[74]||(e[74]=[t("option",{value:""},"Pago: Todos",-1),t("option",{value:"pagado"},"Pagados",-1),t("option",{value:"pendiente"},"Pendientes cobro",-1)])],512),[[se,r(S)]]),P(t("select",{"onUpdate:modelValue":e[10]||(e[10]=o=>te($)?$.value=o:null),class:"h-10 px-3 bg-white border border-gray-200 rounded-lg text-sm text-gray-700 focus:border-purple-500 focus:ring-1 focus:ring-purple-500/20"},[...e[75]||(e[75]=[je('<option value="reciente">Más recientes</option><option value="antiguo">Más antiguos</option><option value="nombre">Nombre A-Z</option><option value="monto_desc">Mayor monto</option><option value="monto_asc">Menor monto</option><option value="progreso">Por progreso</option>',6)])],512),[[se,r($)]]),r(_)?(i(),l("div",{key:0,class:p(["flex items-center gap-2 h-10 px-3 rounded-lg text-sm font-medium",{"bg-amber-100 text-amber-700":r(_)==="pendientes_cobro","bg-orange-100 text-orange-700":r(_)==="proximos_agotar","bg-red-100 text-red-700":r(_)==="urgentes"}])},[t("span",null,n(r(_)==="pendientes_cobro"?"Pendientes de cobro":r(_)==="proximos_agotar"?"Por agotar (≤2 sesiones)":"Urgentes (agotados sin pagar)"),1),t("span",fr,"("+n(r(ce).length)+")",1)],2)):u("",!0),r(k)||r(C)||r(_)||r(S)||r($)!=="reciente"?(i(),l("button",{key:1,onClick:st,class:"h-10 px-3 text-sm text-gray-500 hover:text-gray-700 flex items-center gap-1"},[c(r(qe),{class:"w-4 h-4"}),e[76]||(e[76]=g(" Limpiar ",-1))])):u("",!0)]),r(R)?(i(),l("div",vr,[...e[77]||(e[77]=[t("div",{class:"w-8 h-8 border-2 border-purple-600 border-t-transparent rounded-full animate-spin"},null,-1)])])):(i(),l("div",br,[r(ce).length===0?(i(),l("div",yr,[c(r(Z),{class:"w-12 h-12 text-gray-300 mx-auto mb-3"}),t("p",_r,n(r(k)||r(C)?"Sin resultados":"Sin bonos"),1),t("p",hr,n(r(k)||r(C)?"Prueba ajustando los filtros":"Los bonos de tus pacientes aparecerán aquí"),1)])):(i(),l("table",wr,[e[78]||(e[78]=t("thead",null,[t("tr",{class:"border-b border-gray-100 bg-gray-50/50"},[t("th",{class:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Paciente"),t("th",{class:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Tipo"),t("th",{class:"px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider"},"Progreso"),t("th",{class:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Estado"),t("th",{class:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"},"Monto"),t("th",{class:"px-4 py-3 w-10"})])],-1)),t("tbody",kr,[(i(!0),l(V,null,D(r(ce),o=>(i(),l("tr",{key:o.id,class:"hover:bg-gray-50/50 transition-colors cursor-pointer",onClick:a=>X(o)},[t("td",Pr,[t("div",$r,[t("div",Ar,n(Y(o.paciente_nombre)),1),t("span",jr,n(o.paciente_nombre),1)])]),t("td",Er,[t("span",Tr,n(ue(o.tipo)),1)]),t("td",Br,[t("div",Sr,[t("div",qr,[t("div",{class:p(["h-full rounded-full transition-all",Oe(o)]),style:me({width:`${r(he)(o)}%`})},null,6)]),t("span",Mr,n(o.sesiones_totales-o.sesiones_restantes)+"/"+n(o.sesiones_totales),1)])]),t("td",Ur,[t("span",{class:p(["inline-flex items-center gap-1.5 text-sm",ze(o.estado)])},[t("span",{class:p(["w-1.5 h-1.5 rounded-full",Le(o.estado)])},null,2),g(" "+n(Fe(o.estado)),1)],2)]),t("td",Vr,[t("div",Dr,n(o.monto_total)+"€",1),t("div",{class:p(["text-xs",o.pagado?"text-green-600":"text-amber-600"])},n(o.pagado?"Pagado":"Pendiente"),3)]),t("td",Hr,[c(r(I),{class:"w-4 h-4 text-gray-400"})])],8,Cr))),128))])]))]))])):u("",!0),(i(),q(vt,{to:"body"},[c(re,{"enter-active-class":"transition-all duration-200","enter-from-class":"opacity-0","enter-to-class":"opacity-100","leave-active-class":"transition-all duration-150","leave-from-class":"opacity-100","leave-to-class":"opacity-0"},{default:oe(()=>[r(K)?(i(),l("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",onClick:h(W,["self"])},[t("div",Nr,[t("div",Fr,[t("h3",zr,n(r(U)!==null?"Editar Plantilla":"Nueva Plantilla"),1),t("button",{onClick:W,class:"p-1 text-gray-400 hover:text-gray-600 rounded"},[c(r(qe),{class:"w-5 h-5"})])]),t("div",Lr,[t("div",null,[e[79]||(e[79]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Nombre",-1)),P(t("input",{"onUpdate:modelValue":e[11]||(e[11]=o=>r(y).nombre=o),type:"text",placeholder:"Ej: Bono Mensual",class:"w-full h-10 px-3 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-1 focus:ring-purple-500 focus:border-purple-500"},null,512),[[M,r(y).nombre]])]),t("div",null,[e[80]||(e[80]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Descripción (opcional)",-1)),P(t("input",{"onUpdate:modelValue":e[12]||(e[12]=o=>r(y).descripcion=o),type:"text",placeholder:"Descripción breve...",class:"w-full h-10 px-3 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-1 focus:ring-purple-500 focus:border-purple-500"},null,512),[[M,r(y).descripcion]])]),t("div",Or,[t("div",null,[e[81]||(e[81]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Sesiones",-1)),P(t("input",{"onUpdate:modelValue":e[13]||(e[13]=o=>r(y).sesiones=o),type:"number",min:"1",class:"w-full h-10 px-3 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-1 focus:ring-purple-500 focus:border-purple-500"},null,512),[[M,r(y).sesiones,void 0,{number:!0}]])]),t("div",null,[e[82]||(e[82]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Precio (€)",-1)),P(t("input",{"onUpdate:modelValue":e[14]||(e[14]=o=>r(y).precio=o),type:"number",step:"0.01",min:"0",class:"w-full h-10 px-3 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-1 focus:ring-purple-500 focus:border-purple-500"},null,512),[[M,r(y).precio,void 0,{number:!0}]])])]),t("div",null,[e[84]||(e[84]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Frecuencia",-1)),P(t("select",{"onUpdate:modelValue":e[15]||(e[15]=o=>r(y).frecuencia=o),class:"w-full h-10 px-3 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-1 focus:ring-purple-500 focus:border-purple-500"},[...e[83]||(e[83]=[t("option",{value:"semanal"},"Semanal",-1),t("option",{value:"quincenal"},"Quincenal",-1),t("option",{value:"mensual"},"Mensual",-1),t("option",{value:"cualquiera"},"Cualquiera",-1)])],512),[[se,r(y).frecuencia]])])]),t("div",Rr,[t("button",{onClick:W,class:"h-10 px-4 text-sm text-gray-700 hover:bg-gray-100 rounded-lg transition-colors"}," Cancelar "),t("button",{onClick:De,disabled:!r(y).nombre||!r(y).sesiones||!r(y).precio,class:"h-10 px-4 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50"},n(r(U)!==null?"Guardar":"Crear"),9,Gr)])])])):u("",!0)]),_:1})]))]))}});export{ua as default};
