import{e as U,p as $,r as p,x as m,g as G,c as r,a as e,F as w,b as d,l as c,t as a,k,v as I,K as T,y as S,h as R,o as n,A as z}from"#entry";import{r as E}from"./UserGroupIcon-Byc3y-S3.js";import{r as V}from"./TicketIcon-DRclOuRO.js";import{r as H}from"./CurrencyEuroIcon-ctfYYmfn.js";import{r as K}from"./ChartBarIcon-Cii-u9ml.js";const O={key:0,class:"flex items-center justify-center py-20"},Q={class:"grid grid-cols-1 md:grid-cols-4 gap-6 mb-8"},J={class:"bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 border border-blue-200"},W={class:"flex items-center justify-between mb-2"},X={class:"text-3xl font-bold text-blue-900"},Y={class:"bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 border border-green-200"},Z={class:"flex items-center justify-between mb-2"},ee={class:"text-3xl font-bold text-green-900"},te={class:"bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6 border border-purple-200"},oe={class:"flex items-center justify-between mb-2"},se={class:"text-3xl font-bold text-purple-900"},ae={class:"bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-6 border border-orange-200"},re={class:"flex items-center justify-between mb-2"},ne={class:"text-3xl font-bold text-orange-900"},ie={class:"bg-white rounded-xl shadow-md border border-gray-200 p-6 mb-6"},le={class:"grid grid-cols-1 md:grid-cols-3 gap-4"},de=["value"],ce={class:"bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden"},ue={class:"overflow-x-auto"},pe={class:"min-w-full divide-y divide-gray-200"},me={class:"bg-white divide-y divide-gray-200"},xe={class:"px-6 py-4 whitespace-nowrap"},be={class:"flex items-center"},ge={class:"flex-shrink-0 h-10 w-10 bg-gradient-to-br from-blue-400 to-indigo-500 rounded-full flex items-center justify-center"},_e={class:"text-white font-semibold text-sm"},ve={class:"ml-4"},fe={class:"text-sm font-medium text-gray-900"},ye={class:"text-sm text-gray-500"},he={class:"px-6 py-4 whitespace-nowrap"},we={class:"text-sm text-gray-900"},ke={class:"px-6 py-4 whitespace-nowrap"},Ce={key:0},Te={class:"flex items-center"},Se={class:"text-sm font-medium text-gray-900"},Ee={class:"text-xs text-gray-500 mt-1"},Ve={key:1,class:"text-sm text-gray-400 italic"},Be={class:"px-6 py-4 whitespace-nowrap"},Le={key:0,class:"text-sm"},Pe={class:"font-semibold text-gray-900"},je={class:"text-gray-500"},Ae={key:1,class:"text-sm text-gray-400"},Fe={class:"px-6 py-4 whitespace-nowrap"},qe={class:"text-sm font-semibold text-indigo-600"},De={class:"px-6 py-4 whitespace-nowrap"},Me={key:0,class:"text-center py-12"},Ne={class:"mt-6 text-sm text-gray-500 text-right"},He=U({__name:"pacientes",setup(Ue){const _=$(),v=p(!0),i=p([]),x=p(""),b=p(""),g=p(""),B=async()=>{try{v.value=!0;const{data:o,error:t}=await _.from("pacientes").select(`
        id,
        nombre_completo,
        email,
        telefono,
        activo,
        created_at,
        terapeuta:terapeuta_id (
          id,
          nombre_completo
        )
      `).order("created_at",{ascending:!1});if(t)throw t;const s=await Promise.all((o||[]).map(async l=>{const{data:u,error:h}=await _.from("bonos").select("id, tipo_bono, estado, sesiones_totales, sesiones_restantes, monto_total").eq("paciente_id",l.id).in("estado",["activo","pendiente"]).gt("sesiones_restantes",0).order("created_at",{ascending:!1}).limit(1).single();h&&h.code!=="PGRST116"&&console.error("Error al cargar bono para paciente",l.nombre_completo,":",h);const{data:q}=await _.from("bonos").select("monto_total").eq("paciente_id",l.id).eq("pagado",!0),D=q?.reduce((M,N)=>M+(parseFloat(N.monto_total)||0),0)||0;return{...l,terapeuta_nombre:l.terapeuta?.nombre_completo||null,terapeuta_id:l.terapeuta?.id||null,bono_activo:!!u,bono_tipo:u?.tipo_bono||null,bono_estado:u?.estado||null,total_sesiones:u?.sesiones_totales||0,sesiones_restantes:u?.sesiones_restantes||0,cltv:D}}));i.value=s}catch(o){console.error("Error al cargar pacientes:",o)}finally{v.value=!1}},L=m(()=>{const o=new Map;return i.value.forEach(t=>{t.terapeuta_id&&t.terapeuta_nombre&&o.set(t.terapeuta_id,{id:t.terapeuta_id,nombre:t.terapeuta_nombre})}),Array.from(o.values())}),f=m(()=>{let o=[...i.value];if(x.value){const t=x.value.toLowerCase();o=o.filter(s=>s.nombre_completo?.toLowerCase().includes(t)||s.email?.toLowerCase().includes(t))}return b.value&&(o=o.filter(t=>t.terapeuta_id===b.value)),g.value==="activo"?o=o.filter(t=>t.bono_activo):g.value==="sin_bono"&&(o=o.filter(t=>!t.bono_activo)),o}),P=m(()=>i.value.filter(o=>o.bono_activo).length),C=m(()=>i.value.reduce((o,t)=>o+(t.cltv||0),0)),j=m(()=>i.value.length===0?0:C.value/i.value.length),y=o=>o.toLocaleString("es-ES",{style:"currency",currency:"EUR",minimumFractionDigits:2,maximumFractionDigits:2}),A=o=>o?o.split(" ").map(t=>t[0]).join("").toUpperCase().substring(0,2):"??",F=o=>({semanal:"Semanal",quincenal:"Quincenal",mensual:"Mensual",otro:"Otro"})[o]||o;return G(()=>{B()}),(o,t)=>(n(),r("div",null,[t[15]||(t[15]=e("div",{class:"mb-8"},[e("h2",{class:"text-3xl font-bold text-gray-900 mb-2"},"GestiÃ³n de Pacientes"),e("p",{class:"text-gray-600"},"Vista completa de todos los pacientes del sistema")],-1)),v.value?(n(),r("div",O,[...t[3]||(t[3]=[e("div",{class:"text-center"},[e("div",{class:"w-16 h-16 border-4 border-gray-200 border-t-indigo-500 rounded-full animate-spin mx-auto mb-4"}),e("p",{class:"text-gray-600 text-sm"},"Cargando pacientes...")],-1)])])):(n(),r(w,{key:1},[e("div",Q,[e("div",J,[e("div",W,[t[4]||(t[4]=e("span",{class:"text-sm font-medium text-blue-700"},"Total Pacientes",-1)),d(c(E),{class:"w-5 h-5 text-blue-600"})]),e("p",X,a(i.value.length),1)]),e("div",Y,[e("div",Z,[t[5]||(t[5]=e("span",{class:"text-sm font-medium text-green-700"},"Con Bono Activo",-1)),d(c(V),{class:"w-5 h-5 text-green-600"})]),e("p",ee,a(P.value),1)]),e("div",te,[e("div",oe,[t[6]||(t[6]=e("span",{class:"text-sm font-medium text-purple-700"},"CLTV Total",-1)),d(c(H),{class:"w-5 h-5 text-purple-600"})]),e("p",se,a(y(C.value)),1)]),e("div",ae,[e("div",re,[t[7]||(t[7]=e("span",{class:"text-sm font-medium text-orange-700"},"CLTV Promedio",-1)),d(c(K),{class:"w-5 h-5 text-orange-600"})]),e("p",ne,a(y(j.value)),1)])]),e("div",ie,[e("div",le,[e("div",null,[t[8]||(t[8]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Buscar paciente",-1)),k(e("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>x.value=s),type:"text",placeholder:"Nombre o email...",class:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"},null,512),[[I,x.value]])]),e("div",null,[t[10]||(t[10]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Filtrar por terapeuta",-1)),k(e("select",{"onUpdate:modelValue":t[1]||(t[1]=s=>b.value=s),class:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"},[t[9]||(t[9]=e("option",{value:""},"Todos los terapeutas",-1)),(n(!0),r(w,null,S(L.value,s=>(n(),r("option",{key:s.id,value:s.id},a(s.nombre),9,de))),128))],512),[[T,b.value]])]),e("div",null,[t[12]||(t[12]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Estado del bono",-1)),k(e("select",{"onUpdate:modelValue":t[2]||(t[2]=s=>g.value=s),class:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"},[...t[11]||(t[11]=[e("option",{value:""},"Todos",-1),e("option",{value:"activo"},"Con bono activo",-1),e("option",{value:"sin_bono"},"Sin bono activo",-1)])],512),[[T,g.value]])])])]),e("div",ce,[e("div",ue,[e("table",pe,[t[13]||(t[13]=e("thead",{class:"bg-gray-50"},[e("tr",null,[e("th",{scope:"col",class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Paciente "),e("th",{scope:"col",class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Terapeuta "),e("th",{scope:"col",class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Bono Activo "),e("th",{scope:"col",class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Sesiones "),e("th",{scope:"col",class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," CLTV "),e("th",{scope:"col",class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Estado ")])],-1)),e("tbody",me,[(n(!0),r(w,null,S(f.value,s=>(n(),r("tr",{key:s.id,class:"hover:bg-gray-50 transition-colors"},[e("td",xe,[e("div",be,[e("div",ge,[e("span",_e,a(A(s.nombre_completo)),1)]),e("div",ve,[e("div",fe,a(s.nombre_completo),1),e("div",ye,a(s.email),1)])])]),e("td",he,[e("div",we,a(s.terapeuta_nombre||"Sin asignar"),1)]),e("td",ke,[s.bono_activo?(n(),r("div",Ce,[e("div",Te,[d(c(V),{class:"w-4 h-4 text-green-600 mr-2"}),e("span",Se,a(F(s.bono_tipo)),1)]),e("div",Ee,a(s.bono_estado),1)])):(n(),r("div",Ve,"Sin bono activo"))]),e("td",Be,[s.bono_activo?(n(),r("div",Le,[e("span",Pe,a(s.sesiones_restantes),1),e("span",je," / "+a(s.total_sesiones),1)])):(n(),r("div",Ae,"-"))]),e("td",Fe,[e("div",qe,a(y(s.cltv||0)),1)]),e("td",De,[e("span",{class:z(["px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full",s.activo?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"])},a(s.activo?"Activo":"Inactivo"),3)])]))),128))])])]),f.value.length===0?(n(),r("div",Me,[d(c(E),{class:"w-16 h-16 text-gray-300 mx-auto mb-4"}),t[14]||(t[14]=e("p",{class:"text-gray-500 text-sm"},"No se encontraron pacientes",-1))])):R("",!0)]),e("div",Ne," Mostrando "+a(f.value.length)+" de "+a(i.value.length)+" pacientes ",1)],64))]))}});export{He as default};
