import{u as A}from"./Cy0_MzJF.js";import{J as N,a9 as d,C as D,q as z,aa as g,D as R,n as x}from"#entry";let c=!1;const k=()=>{const l=A(),n=N(),p=d("supabase-session",()=>null),t=d("user-profile",()=>null),f=async()=>{{const{data:e}=await l.auth.getSession();p.value=e.session,e.session?.user&&await m()}},S=()=>{{let e=0,a="",o="";l.auth.onAuthStateChange(async(r,s)=>{const u=Date.now(),i=s?.user?.id||"";if(!(r===a&&i===o&&u-e<100)){if(e=u,a=r,o=i,["SIGNED_IN","SIGNED_OUT","TOKEN_REFRESHED"].includes(r)&&console.log("ðŸ” [Auth State Change]",r,{hasSession:!!s,userId:s?.user?.id,email:s?.user?.email}),p.value=s,r==="SIGNED_OUT"){console.warn("âš ï¸ [Auth] SesiÃ³n cerrada, limpiando perfil y estado"),t.value=null,c=!1;{await R();const _=d("user-profile"),P=d("supabase-session");_.value=null,P.value=null}return}["SIGNED_IN","TOKEN_REFRESHED"].includes(r)&&s?.user&&!t.value&&!c?(console.log("âœ… [Auth] Usuario autenticado sin perfil, cargando..."),await m()):s?.user&&t.value&&r==="SIGNED_IN"&&console.log("âœ… [Auth] Usuario autenticado, perfil ya cargado:",t.value.email)}})}},m=async()=>{if(t.value)return console.log("[useSupabase] Perfil ya cargado, retornando cache:",t.value.email),t.value;if(c){console.log("[useSupabase] Esperando carga en progreso...");let e=0;for(;c&&e<100;)await new Promise(a=>setTimeout(a,100)),e++;if(t.value)return console.log("[useSupabase] Perfil cargado durante espera:",t.value.email),t.value}c=!0,console.log("[useSupabase] Iniciando carga de perfil...");try{let e=0;for(;!n.value&&e<20;)await new Promise(s=>setTimeout(s,50)),e++;const a=n.value?.id||n.value?.sub;if(!a)return console.warn("[useSupabase] No hay usuario autenticado o ID invÃ¡lido despuÃ©s de esperar"),t.value=null,null;console.log("[useSupabase] Cargando perfil para usuario:",a);const{data:o,error:r}=await l.from("profiles").select("*").eq("id",a).single();return r?(console.error("[useSupabase] Error al cargar perfil:",r),t.value=null,null):o?(t.value=o,console.log("[useSupabase] âœ… Perfil cargado correctamente:",o.email,"Rol:",o.rol),o.rol==="psicologa"&&await h(o),o):(console.warn("[useSupabase] No se encontrÃ³ perfil para el usuario:",a),t.value=null,null)}catch(e){return console.error("[useSupabase] Error en loadUserProfile:",e),t.value=null,null}finally{c=!1}},h=async e=>{try{if(console.log("[Sync] Verificando sincronizaciÃ³n con tabla terapeutas..."),!e.email){console.warn("[Sync] No se puede sincronizar: email faltante");return}const a=l,{data:o,error:r}=await a.from("terapeutas").select("*").eq("email",e.email).maybeSingle();if(r&&r.code!=="PGRST116"){console.warn("[Sync] Error al buscar terapeuta:",r);return}const s={id:e.id,nombre_completo:e.nombre||e.email.split("@")[0]||"PsicÃ³loga",email:e.email,telefono:null,especialidad:null,num_colegiada:null,disponibilidad:null,activo:!0,metadata:{sincronizado_desde_profile:!0,ultima_sincronizacion:new Date().toISOString()}};if(o)if(o.nombre_completo!==s.nombre_completo||o.email!==s.email||!o.activo){console.log("[Sync] Actualizando registro existente en tabla terapeutas...");const{error:i}=await a.from("terapeutas").update({nombre_completo:s.nombre_completo,email:s.email,activo:!0,metadata:s.metadata}).eq("id",e.id);i?console.warn("[Sync] No se pudo actualizar el terapeuta:",i):console.log("[Sync] âœ… Terapeuta actualizado correctamente")}else console.log("[Sync] âœ… Terapeuta ya estÃ¡ sincronizado correctamente");else{console.log("[Sync] Creando nuevo registro en tabla terapeutas...");const{error:u}=await a.from("terapeutas").insert(s);if(u)if(u.code==="23505"){console.log("[Sync] El terapeuta ya existe por ID, actualizando...");const{error:i}=await a.from("terapeutas").update({nombre_completo:s.nombre_completo,email:s.email,activo:!0,metadata:s.metadata}).eq("id",e.id);i?console.warn("[Sync] No se pudo actualizar el terapeuta:",i):console.log("[Sync] âœ… Terapeuta actualizado correctamente")}else console.warn("[Sync] No se pudo insertar el terapeuta:",u);else console.log("[Sync] âœ… Terapeuta creado correctamente en la tabla terapeutas")}}catch(a){console.warn("[Sync] Error al sincronizar terapeuta:",a)}},b=async()=>n.value?.id||n.value?.sub?t.value?t.value.rol:(await m())?.rol||null:(console.warn("[useSupabase] getUserRole: No hay usuario autenticado"),null),v=async(e,a)=>{console.log("ðŸ§¹ [Auth] Limpiando estado antes del login..."),t.value=null,p.value=null,c=!1;{const s=d("user-profile"),u=d("supabase-session");s.value=null,u.value=null}const{data:o,error:r}=await l.auth.signInWithPassword({email:e,password:a});if(!r&&o.session){console.log("âœ… [Auth] Login exitoso, estableciendo nueva sesiÃ³n"),p.value=o.session;{const s=d("supabase-session");s.value=o.session}}return{data:o,error:r}},w=async(e,a,o)=>{const{data:r,error:s}=await l.auth.signUp({email:e,password:a,options:{data:o}});return{data:r,error:s}},y=async()=>{console.log("ðŸšª [Auth] Iniciando cierre de sesiÃ³n...");const{error:e}=await l.auth.signOut();if(e)console.error("âŒ [Auth] Error al cerrar sesiÃ³n:",e);else{console.log("âœ… [Auth] SesiÃ³n cerrada en Supabase, limpiando estado local..."),p.value=null,t.value=null,c=!1;try{localStorage.clear(),sessionStorage.clear(),["sb-access-token","sb-refresh-token","supabase-auth-token"].forEach(o=>{document.cookie=`${o}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; domain=${window.location.hostname}`,document.cookie=`${o}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`}),console.log("ðŸ§¹ [Auth] Estado local completamente limpiado")}catch(a){console.warn("[Auth] Error limpiando storage:",a)}console.log("ðŸ”„ [Auth] Redirigiendo a login..."),await x("/login",{replace:!0,external:!1})}return{error:e}},E=async e=>{const{data:a,error:o}=await l.auth.resetPasswordForEmail(e,{redirectTo:`${window.location.origin}/reset-password`});return{data:a,error:o}},I=async e=>{const{data:a,error:o}=await l.auth.updateUser({password:e});return{data:a,error:o}},T=async(e=20)=>{let a=0;for(;!n.value&&a<e;)await new Promise(o=>setTimeout(o,100)),a++;return n.value},U=()=>n.value?.id||n.value?.sub||null;return f(),S(),D(t,(e,a)=>{a&&!e?(console.warn("âš ï¸ [useSupabase] PERFIL SE PERDIÃ“ - Intentando recargar..."),n.value&&m()):e&&!a&&console.log("âœ… [useSupabase] Perfil cargado:",e.email,"Rol:",e.rol)}),{supabase:l,user:g(n),session:g(p),userProfile:g(t),signInWithEmail:v,signUpWithEmail:w,signOut:y,resetPassword:E,updatePassword:I,loadUserProfile:m,getUserRole:b,waitForUser:T,getUserId:U,isAuthenticated:z(()=>!!n.value)}};export{k as u};
