import{e as B,c as u,o as l,a as e,t as w,h as A,A as D,p as z,B as H,r as j,D as N,x as R,k as K,v as O,E as P,j as Y,O as q,f as J,g as G,I as Q,l as f,F as U,y as T,i as W,J as V}from"#entry";import{_ as I}from"./_plugin-vue_export-helper-DlAUqK2U.js";const X={class:"text-[#2D3748] font-sans text-sm leading-relaxed whitespace-pre-wrap break-words"},Z={class:"text-[10px] text-[#2D3748]/50 font-sans"},ee={key:0,class:"inline-block w-2 h-2 bg-[#5550F2] rounded-full",title:"Enviado"},te=B({__name:"MensajeCard",props:{texto:{},fecha:{},remitente:{type:Boolean},visto:{type:Boolean,default:!1}},setup(c){const s=m=>{const p=typeof m=="string"?new Date(m):m,h=new Date,n=h.getTime()-p.getTime(),d=Math.floor(n/6e4),x=Math.floor(n/36e5),y=Math.floor(n/864e5);return d<1?"Ahora":d<60?`Hace ${d}m`:x<24?`Hace ${x}h`:y<7?`Hace ${y}d`:p.toLocaleDateString("es-ES",{day:"2-digit",month:"short",year:p.getFullYear()!==h.getFullYear()?"numeric":void 0})};return(m,p)=>(l(),u("div",{class:D(["p-4 rounded-lg max-w-[80%] transition-all duration-200",c.remitente?"bg-[#E2E8F0]/50 self-end text-right ml-auto":"bg-white border border-[#E2E8F0]/40 self-start shadow-sm"])},[e("p",X,w(c.texto),1),e("div",{class:D(["flex items-center gap-2 mt-2",c.remitente?"justify-end":"justify-start"])},[e("p",Z,w(s(c.fecha)),1),c.remitente&&!c.visto?(l(),u("span",ee)):A("",!0)],2)],2))}}),se=Object.assign(I(te,[["__scopeId","data-v-b70acf2d"]]),{__name:"MensajeCard"}),L=()=>{const c=z(),s=H(),m=j([]),p=j([]),h=j(!1),n=j(null),d=j(null),x=async i=>{if(!s.value)return n.value="Usuario no autenticado",[];h.value=!0,n.value=null;try{const{data:a,error:v}=await c.from("mensajes").select(`
          *,
          remitente:profiles!mensajes_remitente_id_fkey(id, nombre, avatar_url, rol),
          destinatario:profiles!mensajes_destinatario_id_fkey(id, nombre, avatar_url, rol)
        `).or(`and(remitente_id.eq.${s.value.id},destinatario_id.eq.${i}),and(remitente_id.eq.${i},destinatario_id.eq.${s.value.id})`).order("created_at",{ascending:!0});if(v)throw v;return m.value=a||[],a||[]}catch(a){return n.value=a.message||"Error al cargar conversación",console.error("Error en listarConversacion:",a),[]}finally{h.value=!1}},y=async(i,a,v)=>{if(!s.value)return n.value="Usuario no autenticado",null;if(!a.trim())return n.value="El mensaje no puede estar vacío",null;h.value=!0,n.value=null;try{const{data:o,error:t}=await c.from("mensajes").insert({remitente_id:s.value.id,destinatario_id:i,mensaje:a.trim(),sesion_id:v||null,visto:!1}).select(`
          *,
          remitente:profiles!mensajes_remitente_id_fkey(id, nombre, avatar_url, rol),
          destinatario:profiles!mensajes_destinatario_id_fkey(id, nombre, avatar_url, rol)
        `).single();if(t)throw t;return o&&m.value.push(o),o}catch(o){return n.value=o.message||"Error al enviar mensaje",console.error("Error en enviar:",o),null}finally{h.value=!1}},F=async i=>{if(s.value)try{const{error:a}=await c.from("mensajes").update({visto:!0}).eq("destinatario_id",s.value.id).eq("remitente_id",i).eq("visto",!1);if(a)throw a;m.value=m.value.map(v=>v.remitente_id===i&&v.destinatario_id===s.value.id?{...v,visto:!0}:v)}catch(a){console.error("Error al marcar mensajes como vistos:",a)}},_=async()=>{if(!s.value)return n.value="Usuario no autenticado",[];h.value=!0,n.value=null;try{const{data:i,error:a}=await c.rpc("obtener_ultimas_conversaciones",{usuario_id:s.value.id});if(a)throw a;return p.value=i||[],i||[]}catch(i){return console.warn("Usando método alternativo para conversaciones:",i),await b()}finally{h.value=!1}},b=async()=>{if(!s.value)return[];try{const{data:i,error:a}=await c.from("mensajes").select(`
          *,
          remitente:profiles!mensajes_remitente_id_fkey(id, nombre, avatar_url),
          destinatario:profiles!mensajes_destinatario_id_fkey(id, nombre, avatar_url)
        `).or(`remitente_id.eq.${s.value.id},destinatario_id.eq.${s.value.id}`).order("created_at",{ascending:!1});if(a)throw a;const v=new Map;return i?.forEach(o=>{const t=o.remitente_id===s.value.id,E=t?o.destinatario_id:o.remitente_id,k=t?o.destinatario:o.remitente;if(v.has(E)||v.set(E,{otro_usuario_id:E,otro_usuario_nombre:k?.nombre||"Usuario",otro_usuario_avatar:k?.avatar_url,ultimo_mensaje:o.mensaje,ultimo_mensaje_fecha:o.created_at,mensajes_no_vistos:0}),!t&&!o.visto){const r=v.get(E);r.mensajes_no_vistos++}}),p.value=Array.from(v.values()),p.value}catch(i){return n.value=i.message||"Error al cargar conversaciones",console.error("Error en listarConversacionesAlternativo:",i),[]}},g=async()=>{if(!s.value)return 0;try{const{count:i,error:a}=await c.from("mensajes").select("*",{count:"exact",head:!0}).eq("destinatario_id",s.value.id).eq("visto",!1);if(a)throw a;return i||0}catch(i){return console.error("Error al contar mensajes no vistos:",i),0}},M=i=>{!s.value||d.value||(d.value=c.channel(`mensajes:${s.value.id}:${i}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"mensajes",filter:`destinatario_id=eq.${s.value.id}`},async a=>{const{data:v}=await c.from("mensajes").select(`
              *,
              remitente:profiles!mensajes_remitente_id_fkey(id, nombre, avatar_url, rol),
              destinatario:profiles!mensajes_destinatario_id_fkey(id, nombre, avatar_url, rol)
            `).eq("id",a.new.id).single();v&&m.value.push(v)}).subscribe())},C=async()=>{d.value&&(await c.removeChannel(d.value),d.value=null)};return N(()=>{C()}),{mensajes:m,conversaciones:p,loading:h,error:n,listarConversacion:x,enviar:y,marcarVistos:F,listarConversaciones:_,contarNoVistos:g,suscribirseAConversacion:M,desuscribirse:C}},ae={class:"flex items-end gap-3 border-t border-[#E2E8F0]/30 pt-4 bg-[#F2F2F2]"},oe={class:"flex-1 relative"},re=["placeholder","onKeydown","disabled"],ne={key:0,class:"absolute bottom-2 right-2 text-[10px] text-[#2D3748]/40 font-sans"},ie=["disabled"],le={key:0,class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},de={key:1},ue={key:2},ce=B({__name:"MensajeInput",props:{destinatarioId:{},placeholder:{default:"Escribe tu mensaje aquí..."}},emits:["mensajeEnviado"],setup(c,{emit:s}){const m=c,p=s,{enviar:h}=L(),n=j(""),d=j(!1),x=j(null),y=R(()=>{const b=n.value.trim();return b.length>0&&b.length<=2e3&&!d.value}),F=()=>{q(()=>{x.value&&(x.value.style.height="auto",x.value.style.height=`${Math.min(x.value.scrollHeight,120)}px`)})},_=async()=>{if(!y.value)return;d.value=!0;const b=n.value.trim();try{if(!await h(m.destinatarioId,b))throw new Error("No se pudo enviar el mensaje");n.value="",x.value&&(x.value.style.height="auto"),p("mensajeEnviado")}catch(g){console.error("Error al enviar mensaje:",g)}finally{d.value=!1}};return(b,g)=>(l(),u("div",ae,[e("div",oe,[K(e("textarea",{ref_key:"textareaRef",ref:x,"onUpdate:modelValue":g[0]||(g[0]=M=>n.value=M),placeholder:c.placeholder,onKeydown:P(Y(_,["exact","prevent"]),["enter"]),onInput:F,class:D(["w-full border border-[#E2E8F0]/40 rounded-lg p-3 bg-white resize-none text-sm text-[#2D3748] font-sans focus:outline-none focus:ring-2 focus:ring-[#5550F2]/50 focus:border-[#5550F2] transition-all",{"opacity-50 cursor-not-allowed":d.value}]),disabled:d.value,rows:"1",style:{"min-height":"44px","max-height":"120px"}},null,42,re),[[O,n.value]]),n.value.length>0?(l(),u("div",ne,w(n.value.length)+"/2000 ",1)):A("",!0)]),e("button",{onClick:_,disabled:!y.value||d.value,class:D(["bg-[#5550F2] hover:bg-[#C89B8A] text-white px-5 py-3 rounded-lg transition-all duration-200 font-sans text-sm font-medium disabled:opacity-40 disabled:cursor-not-allowed flex items-center gap-2 shadow-sm hover:shadow-md",{"animate-pulse":d.value}])},[d.value?A("",!0):(l(),u("svg",le,[...g[1]||(g[1]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"},null,-1)])])),d.value?(l(),u("span",ue,"Enviando...")):(l(),u("span",de,"Enviar"))],10,ie)]))}}),ve=Object.assign(I(ce,[["__scopeId","data-v-9ee6d4b7"]]),{__name:"MensajeInput"}),me={class:"flex h-[calc(100vh-8rem)] max-w-7xl mx-auto px-4 py-8 gap-6"},_e={class:"px-4 py-5 border-b border-[#EAD5D3]/30 bg-[#F9F7F3]"},fe={class:"text-xs text-[#5D4A44]/60 font-lato mt-1"},he={class:"overflow-y-auto h-[calc(100%-5rem)]"},pe={key:0,class:"p-8 text-center"},xe={key:1,class:"p-8 text-center text-[#5D4A44]/60 font-lato text-sm"},be=["onClick"],ge={class:"flex items-start gap-3"},we={class:"flex-shrink-0"},ye={key:0,class:"w-12 h-12 rounded-full overflow-hidden"},je=["src","alt"],ke={key:1,class:"w-12 h-12 rounded-full bg-[#D8AFA0]/30 flex items-center justify-center"},De={class:"text-[#5D4A44] font-lora text-lg font-medium"},Ee={class:"flex-1 min-w-0"},Ae={class:"flex items-start justify-between gap-2"},Fe={class:"text-xs text-[#5D4A44]/50 font-lato flex-shrink-0"},Me={key:0,class:"inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-[#D8AFA0] rounded-full mt-2"},Ce={class:"flex-1 flex flex-col bg-white rounded-xl shadow-sm border border-[#EAD5D3]/30 overflow-hidden"},$e={key:0,class:"flex-1 flex flex-col items-center justify-center p-8 text-center"},qe={key:1,class:"flex-1 flex flex-col"},Be={class:"px-6 py-4 border-b border-[#EAD5D3]/30 bg-[#F9F7F3] flex items-center gap-4"},Ie={class:"flex items-center gap-3 flex-1"},Se={key:0,class:"w-10 h-10 rounded-full overflow-hidden"},Ue=["src","alt"],Te={key:1,class:"w-10 h-10 rounded-full bg-[#D8AFA0]/30 flex items-center justify-center"},Ve={class:"text-[#5D4A44] font-lora text-sm font-medium"},He={class:"text-base font-lato font-semibold text-[#5D4A44]"},Ne={key:0,class:"flex items-center justify-center h-full"},Le={class:"px-6 py-4 border-t border-[#EAD5D3]/30 bg-white"},ze=B({__name:"mensajes",setup(c){const{conversaciones:s,mensajes:m,loading:p,listarConversaciones:h,listarConversacion:n,marcarVistos:d,suscribirseAConversacion:x,desuscribirse:y}=L();H();const{getUserId:F}=J(),_=j(null),b=j(null);G(async()=>{await h()}),N(()=>{y()});const g=async o=>{_.value=o,await n(o.otro_usuario_id),await d(o.otro_usuario_id),y(),x(o.otro_usuario_id),q(()=>{C()})},M=o=>o.remitente_id===F(),C=()=>{b.value&&(b.value.scrollTop=b.value.scrollHeight)},i=()=>{q(()=>{C()})},a=o=>o.split(" ").map(t=>t[0]).slice(0,2).join("").toUpperCase(),v=o=>{const t=new Date(o),k=new Date().getTime()-t.getTime(),r=Math.floor(k/6e4),$=Math.floor(k/36e5),S=Math.floor(k/864e5);return r<1?"Ahora":r<60?`${r}m`:$<24?`${$}h`:S<7?`${S}d`:t.toLocaleDateString("es-ES",{day:"2-digit",month:"short"})};return Q(m,()=>{m.value.length>0&&h()},{deep:!0}),(o,t)=>{const E=se,k=ve;return l(),u("div",me,[e("aside",{class:D(["w-80 bg-white rounded-xl shadow-sm border border-[#EAD5D3]/30 overflow-hidden flex-shrink-0",{"hidden lg:block":f(_)}])},[e("div",_e,[t[1]||(t[1]=e("h2",{class:"text-lg font-lora font-semibold text-[#5D4A44]"}," Conversaciones ",-1)),e("p",fe,w(f(s).length)+" pacientes ",1)]),e("div",he,[f(p)?(l(),u("div",pe,[...t[2]||(t[2]=[e("div",{class:"inline-block w-8 h-8 border-4 border-[#EAD5D3] border-t-[#D8AFA0] rounded-full animate-spin"},null,-1)])])):f(s).length===0?(l(),u("div",xe,[...t[3]||(t[3]=[e("svg",{class:"w-12 h-12 mx-auto mb-3 text-[#EAD5D3]",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z"})],-1),e("p",null,"No tienes conversaciones activas",-1)])])):A("",!0),(l(!0),u(U,null,T(f(s),r=>(l(),u("button",{key:r.otro_usuario_id,onClick:$=>g(r),class:D(["w-full px-4 py-4 hover:bg-[#F9F7F3] transition-colors border-b border-[#EAD5D3]/20 text-left group",{"bg-[#EAD5D3]/20 hover:bg-[#EAD5D3]/30":f(_)?.otro_usuario_id===r.otro_usuario_id}])},[e("div",ge,[e("div",we,[r.otro_usuario_avatar?(l(),u("div",ye,[e("img",{src:r.otro_usuario_avatar,alt:r.otro_usuario_nombre,class:"w-full h-full object-cover"},null,8,je)])):(l(),u("div",ke,[e("span",De,w(a(r.otro_usuario_nombre)),1)]))]),e("div",Ee,[e("div",Ae,[e("h3",{class:D(["text-sm font-medium text-[#5D4A44] font-lato truncate",{"font-semibold":r.mensajes_no_vistos>0}])},w(r.otro_usuario_nombre),3),e("span",Fe,w(v(r.ultimo_mensaje_fecha)),1)]),e("p",{class:D(["text-xs text-[#5D4A44]/70 font-lato mt-1 truncate",{"font-medium":r.mensajes_no_vistos>0}])},w(r.ultimo_mensaje),3),r.mensajes_no_vistos>0?(l(),u("div",Me,w(r.mensajes_no_vistos),1)):A("",!0)])])],10,be))),128))])],2),e("main",Ce,[f(_)?(l(),u("div",qe,[e("header",Be,[e("button",{onClick:t[0]||(t[0]=r=>_.value=null),class:"lg:hidden p-2 -ml-2 rounded-lg hover:bg-white/50 transition-colors"},[...t[5]||(t[5]=[e("svg",{class:"w-5 h-5 text-[#5D4A44]",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 19l-7-7 7-7"})],-1)])]),e("div",Ie,[f(_).otro_usuario_avatar?(l(),u("div",Se,[e("img",{src:f(_).otro_usuario_avatar,alt:f(_).otro_usuario_nombre,class:"w-full h-full object-cover"},null,8,Ue)])):(l(),u("div",Te,[e("span",Ve,w(a(f(_).otro_usuario_nombre)),1)])),e("div",null,[e("h2",He,w(f(_).otro_usuario_nombre),1),t[6]||(t[6]=e("p",{class:"text-xs text-[#5D4A44]/60 font-lato"}," Paciente ",-1))])])]),e("div",{ref_key:"mensajesContainer",ref:b,class:"flex-1 overflow-y-auto p-6 space-y-3 bg-[#F9F7F3]/30"},[f(p)?(l(),u("div",Ne,[...t[7]||(t[7]=[e("div",{class:"inline-block w-8 h-8 border-4 border-[#EAD5D3] border-t-[#D8AFA0] rounded-full animate-spin"},null,-1)])])):(l(!0),u(U,{key:1},T(f(m),r=>(l(),V(E,{key:r.id,texto:r.mensaje,fecha:r.created_at,remitente:M(r),visto:r.visto},null,8,["texto","fecha","remitente","visto"]))),128))],512),e("div",Le,[f(_)?(l(),V(k,{key:0,"destinatario-id":f(_).otro_usuario_id,placeholder:"Escribe tu respuesta con calma...",onMensajeEnviado:i},null,8,["destinatario-id"])):A("",!0)])])):(l(),u("div",$e,[...t[4]||(t[4]=[W('<div class="w-24 h-24 rounded-full bg-[#EAD5D3]/30 flex items-center justify-center mb-6" data-v-93d7722a><svg class="w-12 h-12 text-[#D8AFA0]" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-93d7722a><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" data-v-93d7722a></path></svg></div><h3 class="text-xl font-lora font-medium text-[#5D4A44] mb-2" data-v-93d7722a> Selecciona una conversación </h3><p class="text-sm text-[#5D4A44]/60 font-lato max-w-md" data-v-93d7722a> Elige un paciente de la lista para ver su conversación y responder sus mensajes. </p>',3)])]))])])}}}),Oe=I(ze,[["__scopeId","data-v-93d7722a"]]);export{Oe as default};
