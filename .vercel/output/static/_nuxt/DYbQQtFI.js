import{c as a,o as n,a as t,e as $,r as p,q as m,f as z,F as w,b as d,k as c,t as r,j as k,v as G,z as T,s as S,g as I,y as R}from"#entry";import{u as H}from"./BbZO5sJf.js";import{r as B}from"./Byc3y-S3.js";import{r as E}from"./DRclOuRO.js";import{r as O}from"./Cii-u9ml.js";function Q(V,x){return n(),a("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M14.25 7.756a4.5 4.5 0 1 0 0 8.488M7.5 10.5h5.25m-5.25 3h5.25M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"})])}const Z={key:0,class:"flex items-center justify-center py-20"},J={class:"grid grid-cols-1 md:grid-cols-4 gap-6 mb-8"},K={class:"bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 border border-blue-200"},W={class:"flex items-center justify-between mb-2"},X={class:"text-3xl font-bold text-blue-900"},Y={class:"bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 border border-green-200"},tt={class:"flex items-center justify-between mb-2"},et={class:"text-3xl font-bold text-green-900"},ot={class:"bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6 border border-purple-200"},st={class:"flex items-center justify-between mb-2"},rt={class:"text-3xl font-bold text-purple-900"},at={class:"bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-6 border border-orange-200"},nt={class:"flex items-center justify-between mb-2"},it={class:"text-3xl font-bold text-orange-900"},lt={class:"bg-white rounded-xl shadow-md border border-gray-200 p-6 mb-6"},dt={class:"grid grid-cols-1 md:grid-cols-3 gap-4"},ct=["value"],ut={class:"bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden"},pt={class:"overflow-x-auto"},mt={class:"min-w-full divide-y divide-gray-200"},xt={class:"bg-white divide-y divide-gray-200"},bt={class:"px-6 py-4 whitespace-nowrap"},gt={class:"flex items-center"},_t={class:"flex-shrink-0 h-10 w-10 bg-gradient-to-br from-blue-400 to-indigo-500 rounded-full flex items-center justify-center"},vt={class:"text-white font-semibold text-sm"},ft={class:"ml-4"},yt={class:"text-sm font-medium text-gray-900"},ht={class:"text-sm text-gray-500"},wt={class:"px-6 py-4 whitespace-nowrap"},kt={class:"text-sm text-gray-900"},Ct={class:"px-6 py-4 whitespace-nowrap"},Tt={key:0},St={class:"flex items-center"},Bt={class:"text-sm font-medium text-gray-900"},Et={class:"text-xs text-gray-500 mt-1"},Vt={key:1,class:"text-sm text-gray-400 italic"},jt={class:"px-6 py-4 whitespace-nowrap"},Mt={key:0,class:"text-sm"},Lt={class:"font-semibold text-gray-900"},Pt={class:"text-gray-500"},qt={key:1,class:"text-sm text-gray-400"},Ft={class:"px-6 py-4 whitespace-nowrap"},At={class:"text-sm font-semibold text-indigo-600"},Dt={class:"px-6 py-4 whitespace-nowrap"},Nt={key:0,class:"text-center py-12"},Ut={class:"mt-6 text-sm text-gray-500 text-right"},Ht=$({__name:"pacientes",setup(V){const x=H(),v=p(!0),i=p([]),b=p(""),g=p(""),_=p(""),j=async()=>{try{v.value=!0;const{data:o,error:e}=await x.from("pacientes").select(`
        id,
        nombre_completo,
        email,
        telefono,
        activo,
        created_at,
        terapeuta:terapeuta_id (
          id,
          nombre_completo
        )
      `).order("created_at",{ascending:!1});if(e)throw e;const s=await Promise.all((o||[]).map(async l=>{const{data:u,error:h}=await x.from("bonos").select("id, tipo_bono, estado, sesiones_totales, sesiones_restantes, monto_total").eq("paciente_id",l.id).in("estado",["activo","pendiente"]).gt("sesiones_restantes",0).order("created_at",{ascending:!1}).limit(1).single();h&&h.code!=="PGRST116"&&console.error("Error al cargar bono para paciente",l.nombre_completo,":",h);const{data:A}=await x.from("bonos").select("monto_total").eq("paciente_id",l.id).eq("pagado",!0),D=A?.reduce((N,U)=>N+(parseFloat(U.monto_total)||0),0)||0;return{...l,terapeuta_nombre:l.terapeuta?.nombre_completo||null,terapeuta_id:l.terapeuta?.id||null,bono_activo:!!u,bono_tipo:u?.tipo_bono||null,bono_estado:u?.estado||null,total_sesiones:u?.sesiones_totales||0,sesiones_restantes:u?.sesiones_restantes||0,cltv:D}}));i.value=s}catch(o){console.error("Error al cargar pacientes:",o)}finally{v.value=!1}},M=m(()=>{const o=new Map;return i.value.forEach(e=>{e.terapeuta_id&&e.terapeuta_nombre&&o.set(e.terapeuta_id,{id:e.terapeuta_id,nombre:e.terapeuta_nombre})}),Array.from(o.values())}),f=m(()=>{let o=[...i.value];if(b.value){const e=b.value.toLowerCase();o=o.filter(s=>s.nombre_completo?.toLowerCase().includes(e)||s.email?.toLowerCase().includes(e))}return g.value&&(o=o.filter(e=>e.terapeuta_id===g.value)),_.value==="activo"?o=o.filter(e=>e.bono_activo):_.value==="sin_bono"&&(o=o.filter(e=>!e.bono_activo)),o}),L=m(()=>i.value.filter(o=>o.bono_activo).length),C=m(()=>i.value.reduce((o,e)=>o+(e.cltv||0),0)),P=m(()=>i.value.length===0?0:C.value/i.value.length),y=o=>o.toLocaleString("es-ES",{style:"currency",currency:"EUR",minimumFractionDigits:2,maximumFractionDigits:2}),q=o=>o?o.split(" ").map(e=>e[0]).join("").toUpperCase().substring(0,2):"??",F=o=>({semanal:"Semanal",quincenal:"Quincenal",mensual:"Mensual",otro:"Otro"})[o]||o;return z(()=>{j()}),(o,e)=>(n(),a("div",null,[e[15]||(e[15]=t("div",{class:"mb-8"},[t("h2",{class:"text-3xl font-bold text-gray-900 mb-2"},"GestiÃ³n de Pacientes"),t("p",{class:"text-gray-600"},"Vista completa de todos los pacientes del sistema")],-1)),v.value?(n(),a("div",Z,[...e[3]||(e[3]=[t("div",{class:"text-center"},[t("div",{class:"w-16 h-16 border-4 border-gray-200 border-t-indigo-500 rounded-full animate-spin mx-auto mb-4"}),t("p",{class:"text-gray-600 text-sm"},"Cargando pacientes...")],-1)])])):(n(),a(w,{key:1},[t("div",J,[t("div",K,[t("div",W,[e[4]||(e[4]=t("span",{class:"text-sm font-medium text-blue-700"},"Total Pacientes",-1)),d(c(B),{class:"w-5 h-5 text-blue-600"})]),t("p",X,r(i.value.length),1)]),t("div",Y,[t("div",tt,[e[5]||(e[5]=t("span",{class:"text-sm font-medium text-green-700"},"Con Bono Activo",-1)),d(c(E),{class:"w-5 h-5 text-green-600"})]),t("p",et,r(L.value),1)]),t("div",ot,[t("div",st,[e[6]||(e[6]=t("span",{class:"text-sm font-medium text-purple-700"},"CLTV Total",-1)),d(c(Q),{class:"w-5 h-5 text-purple-600"})]),t("p",rt,r(y(C.value)),1)]),t("div",at,[t("div",nt,[e[7]||(e[7]=t("span",{class:"text-sm font-medium text-orange-700"},"CLTV Promedio",-1)),d(c(O),{class:"w-5 h-5 text-orange-600"})]),t("p",it,r(y(P.value)),1)])]),t("div",lt,[t("div",dt,[t("div",null,[e[8]||(e[8]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Buscar paciente",-1)),k(t("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>b.value=s),type:"text",placeholder:"Nombre o email...",class:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"},null,512),[[G,b.value]])]),t("div",null,[e[10]||(e[10]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Filtrar por terapeuta",-1)),k(t("select",{"onUpdate:modelValue":e[1]||(e[1]=s=>g.value=s),class:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"},[e[9]||(e[9]=t("option",{value:""},"Todos los terapeutas",-1)),(n(!0),a(w,null,S(M.value,s=>(n(),a("option",{key:s.id,value:s.id},r(s.nombre),9,ct))),128))],512),[[T,g.value]])]),t("div",null,[e[12]||(e[12]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Estado del bono",-1)),k(t("select",{"onUpdate:modelValue":e[2]||(e[2]=s=>_.value=s),class:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"},[...e[11]||(e[11]=[t("option",{value:""},"Todos",-1),t("option",{value:"activo"},"Con bono activo",-1),t("option",{value:"sin_bono"},"Sin bono activo",-1)])],512),[[T,_.value]])])])]),t("div",ut,[t("div",pt,[t("table",mt,[e[13]||(e[13]=t("thead",{class:"bg-gray-50"},[t("tr",null,[t("th",{scope:"col",class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Paciente "),t("th",{scope:"col",class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Terapeuta "),t("th",{scope:"col",class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Bono Activo "),t("th",{scope:"col",class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Sesiones "),t("th",{scope:"col",class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," CLTV "),t("th",{scope:"col",class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Estado ")])],-1)),t("tbody",xt,[(n(!0),a(w,null,S(f.value,s=>(n(),a("tr",{key:s.id,class:"hover:bg-gray-50 transition-colors"},[t("td",bt,[t("div",gt,[t("div",_t,[t("span",vt,r(q(s.nombre_completo)),1)]),t("div",ft,[t("div",yt,r(s.nombre_completo),1),t("div",ht,r(s.email),1)])])]),t("td",wt,[t("div",kt,r(s.terapeuta_nombre||"Sin asignar"),1)]),t("td",Ct,[s.bono_activo?(n(),a("div",Tt,[t("div",St,[d(c(E),{class:"w-4 h-4 text-green-600 mr-2"}),t("span",Bt,r(F(s.bono_tipo)),1)]),t("div",Et,r(s.bono_estado),1)])):(n(),a("div",Vt,"Sin bono activo"))]),t("td",jt,[s.bono_activo?(n(),a("div",Mt,[t("span",Lt,r(s.sesiones_restantes),1),t("span",Pt," / "+r(s.total_sesiones),1)])):(n(),a("div",qt,"-"))]),t("td",Ft,[t("div",At,r(y(s.cltv||0)),1)]),t("td",Dt,[t("span",{class:R(["px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full",s.activo?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"])},r(s.activo?"Activo":"Inactivo"),3)])]))),128))])])]),f.value.length===0?(n(),a("div",Nt,[d(c(B),{class:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e[14]||(e[14]=t("p",{class:"text-gray-500 text-sm"},"No se encontraron pacientes",-1))])):I("",!0)]),t("div",Ut," Mostrando "+r(f.value.length)+" de "+r(i.value.length)+" pacientes ",1)],64))]))}});export{Ht as default};
