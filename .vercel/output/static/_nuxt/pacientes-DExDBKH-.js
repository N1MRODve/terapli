import{c as s,o,a as e,r as V,z as S,b as w,j as $,l as te,k as t,w as Me,t as l,M as Be,A as Ae,n as F,E as kt,F as Q,i as J,q as Ye,B as Ct,I as ye,m as K,d as R,v as re,Y as Fe,K as Oe,e as He,g as Et,J as de,T as et,ah as Yt,p as De,C as ea,af as lt,L as ta,s as aa,y as it}from"#entry";import{r as Dt}from"./PencilIcon-QJyqa3i7.js";import{r as Ue}from"./TicketIcon-DRclOuRO.js";import{r as oa}from"./TrashIcon-c8JhvyFk.js";import{r as je}from"./ExclamationTriangleIcon-BreoAuwB.js";import{r as sa}from"./ClockIcon-CQZt9cKZ.js";import{r as ra}from"./CalendarIcon-mZ3toP8Y.js";import{r as Te}from"./ExclamationCircleIcon-Dyh9f5zH.js";import{r as na}from"./BellAlertIcon-D9Txc_Yy.js";import{r as St,a as ct,b as dt,c as la}from"./EyeIcon-BlkDSF6y.js";import{_ as ia}from"./ModalNuevaCita-zx-2eD6_.js";import{u as Pt}from"./useBonos-BSiCGD07.js";import{u as Ft}from"./useCitas-CnBtv5jB.js";import{u as Ge}from"./useToast-Cq0GyJHs.js";import{_ as ze}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as Pe}from"./CheckCircleIcon-Bi0YyG7H.js";import{r as ut}from"./XCircleIcon-DIGsvT-h.js";import{r as Re}from"./XMarkIcon-DWNj0d99.js";import{r as Le}from"./DocumentTextIcon-Dp_75vtG.js";import{r as We}from"./CalendarDaysIcon-C0vq0F4x.js";import{r as da}from"./PhoneIcon-B4J2dtua.js";import{L as ca,D as ua}from"./index-CYlovTC9.js";import{Chart as pa,CategoryScale as ma,LinearScale as ba,PointElement as ga,LineElement as va,ArcElement as fa,Title as xa,Tooltip as ha,Legend as ya,Filler as _a}from"./chart-BdQHVWbB.js";import{r as yt}from"./ChartBarIcon-Cii-u9ml.js";import{r as _t}from"./PlusIcon-UqRq4KLf.js";import{r as wt}from"./UserGroupIcon-Byc3y-S3.js";import{r as $t}from"./ClipboardDocumentListIcon-CSBwmCjC.js";import{r as wa}from"./MagnifyingGlassIcon-B5My0XuL.js";import{r as $a}from"./FunnelIcon-CO-pjLeZ.js";import{r as ka}from"./ChevronDownIcon-BwiNUDLV.js";import{r as Ca}from"./CurrencyDollarIcon-Dge-tWFD.js";import{r as Ea}from"./ChevronRightIcon-Ck2OajRo.js";import"./UserIcon-G1mM6o1b.js";import"./CheckBadgeIcon-CuVUaEjS.js";function Da(E,B){return o(),s("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75"})])}function Sa(E,B){return o(),s("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M15.75 19.5 8.25 12l7.5-7.5"})])}function Pa(E,B){return o(),s("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M11.35 3.836c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75 2.25 2.25 0 0 0-.1-.664m-5.8 0A2.251 2.251 0 0 1 13.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m8.9-4.414c.376.023.75.05 1.124.08 1.131.094 1.976 1.057 1.976 2.192V16.5A2.25 2.25 0 0 1 18 18.75h-2.25m-7.5-10.5H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V18.75m-7.5-10.5h6.375c.621 0 1.125.504 1.125 1.125v9.375m-8.25-3 1.5 1.5 3-3.75"})])}function Fa(E,B){return o(),s("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m.75 12 3 3m0 0 3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z"})])}function Ma(E,B){return o(),s("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M3.75 9.776c.112-.017.227-.026.344-.026h15.812c.117 0 .232.009.344.026m-16.5 0a2.25 2.25 0 0 0-1.883 2.542l.857 6a2.25 2.25 0 0 0 2.227 1.932H19.05a2.25 2.25 0 0 0 2.227-1.932l.857-6a2.25 2.25 0 0 0-1.883-2.542m-16.5 0V6A2.25 2.25 0 0 1 6 3.75h3.879a1.5 1.5 0 0 1 1.06.44l2.122 2.12a1.5 1.5 0 0 0 1.06.44H18A2.25 2.25 0 0 1 20.25 9v.776"})])}function Aa(E,B){return o(),s("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6A2.25 2.25 0 0 1 3.75 18v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25a2.25 2.25 0 0 1-2.25-2.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-2.25A2.25 2.25 0 0 1 13.5 18v-2.25Z"})])}function ja(E,B){return o(),s("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 0 1-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-7.5A1.125 1.125 0 0 1 12 18.375m9.75-12.75c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125m19.5 0v1.5c0 .621-.504 1.125-1.125 1.125M2.25 5.625v1.5c0 .621.504 1.125 1.125 1.125m0 0h17.25m-17.25 0h7.5c.621 0 1.125.504 1.125 1.125M3.375 8.25c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m17.25-3.75h-7.5c-.621 0-1.125.504-1.125 1.125m8.625-1.125c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125M12 10.875v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 10.875c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125M13.125 12h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125M20.625 12c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5M12 14.625v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 14.625c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125m0 1.5v-1.5m0 0c0-.621.504-1.125 1.125-1.125m0 0h7.5"})])}const Va=["aria-label"],Ba={class:"absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 group-focus-within:opacity-100 transition-all duration-200 z-10",role:"toolbar"},Ia={class:"text-sm text-gray-700 text-center mb-3"},Ta={class:"flex gap-2"},za={class:"flex items-start gap-3 mb-3"},Ra={class:"relative flex-shrink-0"},qa={class:"flex-1 min-w-0 pt-0.5"},Na={class:"font-semibold text-gray-900 text-base leading-tight truncate pr-16"},Oa={class:"flex items-center gap-2 mt-1"},Ua={key:0,class:"text-xs text-gray-400 truncate"},La={class:"flex items-center gap-2"},Ha={class:"flex-1 min-w-0"},Ga={key:1,class:"text-sm font-medium text-amber-700"},Ka={class:"grid grid-cols-2 gap-2 text-xs"},Qa={class:"flex items-center gap-1.5"},Za={class:"flex items-center gap-1.5 text-gray-500 justify-end"},Ja={class:"flex items-center justify-between mb-1.5"},Xa={class:"flex items-center gap-1.5"},Wa={class:"flex items-center gap-1.5"},Ya={class:"relative h-2 bg-gray-200 rounded-full overflow-hidden"},eo={class:"flex justify-between mt-1"},to={key:0,class:"mt-2.5 pt-2.5 border-t border-gray-100"},ao={key:0,class:"flex items-center gap-1.5 px-2 py-1.5 bg-red-50 rounded-md text-xs"},oo={key:1,class:"flex items-center gap-1.5 px-2 py-1.5 bg-amber-50 rounded-md text-xs"},so={class:"text-amber-700 font-medium"},ro={key:2,class:"flex items-center gap-1.5 px-2 py-1.5 bg-red-50 rounded-md text-xs"},no={class:"text-red-700 font-medium"},lo={__name:"PacienteCard",props:{paciente:{type:Object,required:!0}},emits:["editar","eliminar","ver-citas","gestionar-bonos","editar-cita","ver-ficha"],setup(E,{emit:B}){const m=E,O=B,b=V(!1),D=()=>{b.value=!1,O("eliminar",m.paciente)},M=S(()=>{const T=m.paciente.nombre||"Sin nombre";if(T==="Sin nombre")return"Sin nombre";const L=T.trim().split(" ");return L.length>2?`${L[0]} ${L[1]} ${L[L.length-1].charAt(0)}.`:T}),A=S(()=>{const T=m.paciente.nombre||"";if(!T)return"??";const L=T.trim().split(" ");return`${L[0]?.charAt(0)||"?"}${L[1]?.charAt(0)||""}`.toUpperCase()}),H=S(()=>{if(!m.paciente.activo)return"#9CA3AF";if(m.paciente.en_pausa)return"#F59E0B";const T=["#8B5CF6","#EC4899","#06B6D4","#10B981","#6366F1","#F97316"],L=m.paciente.id.charCodeAt(0)%T.length;return T[L]}),d=S(()=>m.paciente.activo?m.paciente.en_pausa?"ring-amber-300":"ring-purple-200":"ring-gray-300"),x=S(()=>m.paciente.activo?m.paciente.en_pausa?"bg-amber-500":"bg-green-500":"bg-gray-400"),y=S(()=>m.paciente.activo?m.paciente.en_pausa?"Pausa":"Activo":"Finalizado"),q=S(()=>m.paciente.activo?m.paciente.en_pausa?"bg-amber-100 text-amber-700":"bg-green-100 text-green-700":"bg-gray-100 text-gray-600"),k=S(()=>{if(!m.paciente.ultima_sesion)return"Sin registro";const T=new Date(m.paciente.ultima_sesion),z=Math.floor((new Date-T)/(1e3*60*60*24));return z===0?"Hoy":z===1?"Ayer":z<7?`Hace ${z} días`:z<30?`Hace ${Math.floor(z/7)} sem`:T.toLocaleDateString("es-ES",{day:"numeric",month:"short"})}),_=S(()=>{if(!m.paciente.ultima_sesion)return"bg-gray-300";const T=u.value;return T<=7?"bg-green-500":T<=14?"bg-blue-500":T<=30?"bg-amber-500":"bg-red-500"}),C=S(()=>{if(!m.paciente.ultima_sesion)return"text-gray-400";const T=u.value;return T<=14?"text-gray-600":T<=30?"text-amber-600":"text-red-600 font-medium"}),n=S(()=>{if(!m.paciente.proxima_sesion)return null;try{let T=m.paciente.proxima_sesion;T.includes("T")||(T+="T00:00:00");const L=new Date(T);return isNaN(L.getTime())?null:L.toLocaleDateString("es-ES",{weekday:"short",day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"})}catch{return null}}),h=S(()=>m.paciente.total_sesiones||0),u=S(()=>{if(!m.paciente.ultima_sesion)return 0;const T=new Date(m.paciente.ultima_sesion);return Math.floor((new Date-T)/(1e3*60*60*24))}),g=S(()=>!m.paciente.activo||m.paciente.en_pausa?!1:u.value>30),i=S(()=>m.paciente.bono_activo||null),p=S(()=>i.value?.tipo?{otro:"Demanda",quincenal:"Quinc.",semanal:"Semanal",mensual:"Mensual"}[i.value.tipo]||i.value.tipo:""),v=S(()=>i.value?.sesiones_totales||0),Z=S(()=>i.value?v.value-i.value.sesiones_restantes:0),ae=S(()=>!i.value||v.value===0?0:Math.round(Z.value/v.value*100)),P=S(()=>{if(!i.value)return"bg-gray-400";const T=i.value.sesiones_restantes;return T===0||T===1?"bg-red-500":T===2?"bg-amber-500":"bg-purple-500"}),a=S(()=>{if(!i.value)return"bg-gray-50";const T=i.value.sesiones_restantes;return T===0||T===1?"bg-red-50 border border-red-100":T===2?"bg-amber-50 border border-amber-100":"bg-purple-50 border border-purple-100"}),j=S(()=>{if(!i.value)return"text-gray-600";const T=i.value.sesiones_restantes;return T===0?"text-red-600":T<=2?"text-amber-600":"text-gray-700"}),oe=S(()=>{if(!i.value)return"text-gray-400";const T=i.value.sesiones_restantes;return T<=1?"text-red-500":T===2?"text-amber-500":"text-purple-500"}),U=S(()=>{if(!i.value?.fecha_fin)return"—";try{return new Date(i.value.fecha_fin).toLocaleDateString("es-ES",{day:"numeric",month:"short"})}catch{return"—"}}),ee=S(()=>{if(!i.value?.fecha_fin)return"—";try{const T=new Date(i.value.fecha_fin),z=Math.floor((T-new Date)/(1e3*60*60*24));return z<0?"Vencido":z===0?"Vence hoy":z===1?"Vence mañana":z<=7?`Vence en ${z}d`:`Hasta ${U.value}`}catch{return"—"}}),se=S(()=>{if(!i.value?.fecha_fin)return"text-gray-400";const T=new Date(i.value.fecha_fin),z=Math.floor((T-new Date)/(1e3*60*60*24));return z<0?"text-red-600 font-medium":z<=7?"text-amber-600 font-medium":"text-gray-500"}),ce=S(()=>i.value?i.value.sesiones_restantes===1:!1),le=S(()=>i.value?i.value.sesiones_restantes===2:!1),ie=S(()=>ce.value||le.value||g.value);return(T,L)=>(o(),s("article",{class:"bg-white rounded-xl border border-gray-100 p-4 hover:shadow-lg hover:border-purple-200 transition-all duration-200 group relative cursor-pointer focus-within:ring-2 focus-within:ring-purple-500 focus-within:ring-offset-2",role:"article","aria-label":`Ficha de ${t(M)}`,tabindex:"0",onClick:L[6]||(L[6]=z=>T.$emit("ver-ficha",E.paciente)),onKeydown:L[7]||(L[7]=kt(z=>T.$emit("ver-ficha",E.paciente),["enter"]))},[e("div",Ba,[e("button",{onClick:L[0]||(L[0]=te(z=>T.$emit("editar",E.paciente),["stop"])),class:"w-8 h-8 p-1.5 bg-white text-gray-600 rounded-lg hover:bg-purple-50 hover:text-purple-600 transition-colors shadow-sm border border-gray-200",title:"Editar paciente"},[w(t(Dt),{class:"w-full h-full"})]),e("button",{onClick:L[1]||(L[1]=te(z=>T.$emit("gestionar-bonos",E.paciente),["stop"])),class:"w-8 h-8 p-1.5 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors shadow-sm",title:"Gestionar bonos"},[w(t(Ue),{class:"w-full h-full"})]),e("button",{onClick:L[2]||(L[2]=te(z=>b.value=!0,["stop"])),class:"w-6 h-6 p-1 bg-gray-50 text-gray-400 rounded hover:bg-red-50 hover:text-red-500 transition-colors ml-1",title:"Eliminar"},[w(t(oa),{class:"w-full h-full"})])]),w(Be,{"enter-active-class":"transition-all duration-150 ease-out","enter-from-class":"opacity-0 scale-95","enter-to-class":"opacity-100 scale-100","leave-active-class":"transition-all duration-100 ease-in","leave-from-class":"opacity-100 scale-100","leave-to-class":"opacity-0 scale-95"},{default:Me(()=>[t(b)?(o(),s("div",{key:0,class:"absolute top-0 left-0 right-0 bottom-0 bg-white/95 backdrop-blur-sm rounded-xl flex flex-col items-center justify-center z-20 p-4",onClick:L[4]||(L[4]=te(()=>{},["stop"]))},[w(t(je),{class:"w-8 h-8 text-red-500 mb-2"}),e("p",Ia,"¿Eliminar a "+l(t(M))+"?",1),e("div",Ta,[e("button",{onClick:L[3]||(L[3]=te(z=>b.value=!1,["stop"])),class:"px-3 py-1.5 text-sm text-gray-600 hover:text-gray-800 transition-colors"}," Cancelar "),e("button",{onClick:te(D,["stop"]),class:"px-3 py-1.5 text-sm bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"}," Eliminar ")])])):$("",!0)]),_:1}),e("div",za,[e("div",Ra,[e("div",{class:F(["w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg ring-2 ring-offset-1",t(d)]),style:Ae({backgroundColor:t(H)})},l(t(A)),7),e("span",{class:F(["absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 rounded-full border-2 border-white",t(x)])},null,2)]),e("div",qa,[e("h3",Na,l(t(M)),1),e("div",Oa,[e("span",{class:F(["inline-flex items-center px-2 py-0.5 text-xs font-medium rounded-full",t(q)])},l(t(y)),3),E.paciente.area_de_acompanamiento?(o(),s("span",Ua,l(E.paciente.area_de_acompanamiento),1)):$("",!0)])])]),e("div",{class:F(["mb-3 p-2.5 rounded-lg",t(n)?"bg-purple-50 border border-purple-100":"bg-amber-50 border border-amber-100"])},[e("div",La,[w(t(sa),{class:F(["w-4 h-4 flex-shrink-0",t(n)?"text-purple-500":"text-amber-500"])},null,8,["class"]),e("div",Ha,[L[8]||(L[8]=e("p",{class:"text-xs text-gray-500 mb-0.5"},"Próxima cita",-1)),t(n)?(o(),s("button",{key:0,onClick:L[5]||(L[5]=te(z=>T.$emit("editar-cita",E.paciente.proxima_cita_id),["stop"])),class:"text-sm font-semibold text-purple-700 hover:text-purple-800 transition-colors truncate block w-full text-left"},l(t(n)),1)):(o(),s("p",Ga,"Sin cita programada"))])])],2),e("div",Ka,[e("div",Qa,[e("div",{class:F(["w-2 h-2 rounded-full flex-shrink-0",t(_)])},null,2),w(t(ra),{class:"w-3.5 h-3.5 text-gray-400"}),e("span",{class:F(t(C))},l(t(k)),3)]),e("div",Za,[e("span",null,l(t(h))+" sesiones",1)]),t(i)?(o(),s("div",{key:0,class:F(["col-span-2 mt-2 p-2 rounded-lg",t(a)])},[e("div",Ja,[e("div",Xa,[w(t(Ue),{class:F(["w-3.5 h-3.5 flex-shrink-0",t(oe)])},null,8,["class"]),e("span",{class:F(["font-medium text-xs",t(j)])},l(t(p)),3)]),e("div",Wa,[e("span",{class:F(["text-xs",t(se)])},l(t(ee)),3)])]),e("div",Ya,[e("div",{class:F(["absolute left-0 top-0 h-full rounded-full transition-all duration-300",t(P)]),style:Ae({width:t(ae)+"%"})},null,6)]),e("div",eo,[e("span",{class:F(["text-[10px]",t(j)])},l(t(Z))+" usadas ",3),e("span",{class:F(["text-[10px] font-semibold",t(j)])},l(t(i).sesiones_restantes)+" restantes ",3)])],2)):$("",!0)]),t(ie)?(o(),s("div",to,[t(ce)?(o(),s("div",ao,[w(t(je),{class:"w-3.5 h-3.5 text-red-500"}),L[9]||(L[9]=e("span",{class:"text-red-700 font-medium"},"Última sesión del bono",-1))])):t(le)?(o(),s("div",oo,[w(t(Te),{class:"w-3.5 h-3.5 text-amber-500"}),e("span",so,l(t(i).sesiones_restantes)+" sesiones restantes",1)])):t(g)?(o(),s("div",ro,[w(t(na),{class:"w-3.5 h-3.5 text-red-500"}),e("span",no,l(t(u))+" días sin sesión",1)])):$("",!0)])):$("",!0)],40,Va))}},io={class:"overflow-x-auto"},co={class:"min-w-full divide-y divide-gray-200"},uo={class:"bg-white divide-y divide-gray-100"},po=["onClick"],mo={class:"px-4 py-3 whitespace-nowrap"},bo={class:"flex items-center gap-3"},go={class:"min-w-0"},vo={class:"text-sm font-medium text-gray-900 truncate max-w-[200px]"},fo={key:0,class:"text-xs text-gray-500 truncate max-w-[200px]"},xo={class:"px-4 py-3 whitespace-nowrap"},ho={class:"px-4 py-3 whitespace-nowrap"},yo={key:0,class:"flex items-center gap-1.5"},_o={class:"text-sm text-gray-900"},wo={key:1,class:"text-sm text-amber-600 font-medium"},$o={class:"px-4 py-3 whitespace-nowrap"},ko={class:"flex items-center gap-1.5"},Co={class:"px-4 py-3 whitespace-nowrap"},Eo={key:0,class:"flex items-center gap-2"},Do={class:"w-16 h-1.5 bg-gray-200 rounded-full overflow-hidden"},So={key:1,class:"text-xs text-gray-400"},Po={class:"px-4 py-3 whitespace-nowrap text-right"},Fo={class:"flex items-center justify-end gap-1"},Mo=["onClick"],Ao=["onClick"],jo=["onClick"],Vo={key:0,class:"py-12 text-center"},Bo={__name:"PacienteTabla",props:{pacientes:{type:Array,required:!0}},emits:["ver-ficha","editar","gestionar-bonos","ver-preview"],setup(E){const B=k=>{if(!k)return"??";const _=k.trim().split(" ");return`${_[0]?.charAt(0)||"?"}${_[1]?.charAt(0)||""}`.toUpperCase()},m=k=>{if(!k.activo)return"#9CA3AF";if(k.en_pausa)return"#F59E0B";const _=["#8B5CF6","#EC4899","#06B6D4","#10B981","#6366F1","#F97316"],C=k.id.charCodeAt(0)%_.length;return _[C]},O=k=>k.activo?k.en_pausa?"Pausa":"Activo":"Finalizado",b=k=>k.activo?k.en_pausa?"bg-amber-100 text-amber-700":"bg-green-100 text-green-700":"bg-gray-100 text-gray-600",D=k=>{if(!k)return null;try{let _=k;_.includes("T")||(_+="T00:00:00");const C=new Date(_);return isNaN(C.getTime())?null:C.toLocaleDateString("es-ES",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"})}catch{return null}},M=k=>{if(!k)return"Sin registro";const _=new Date(k),n=Math.floor((new Date-_)/(1e3*60*60*24));return n===0?"Hoy":n===1?"Ayer":n<7?`Hace ${n}d`:n<30?`Hace ${Math.floor(n/7)}sem`:_.toLocaleDateString("es-ES",{day:"numeric",month:"short"})},A=k=>{if(!k.ultima_sesion)return 999;const _=new Date(k.ultima_sesion);return Math.floor((new Date-_)/864e5)},H=k=>{if(!k.ultima_sesion)return"bg-gray-300";const _=A(k);return _<=7?"bg-green-500":_<=14?"bg-blue-500":_<=30?"bg-amber-500":"bg-red-500"},d=k=>{if(!k.ultima_sesion)return"text-gray-400";const _=A(k);return _<=14?"text-gray-600":_<=30?"text-amber-600":"text-red-600 font-medium"},x=k=>{if(!k||k.sesiones_totales===0)return 0;const _=k.sesiones_totales-k.sesiones_restantes;return Math.round(_/k.sesiones_totales*100)},y=k=>k?k.sesiones_restantes<=1?"bg-red-500":k.sesiones_restantes===2?"bg-amber-500":"bg-purple-500":"bg-gray-400",q=k=>k?k.sesiones_restantes<=1?"text-red-600":k.sesiones_restantes===2?"text-amber-600":"text-gray-700":"text-gray-600";return(k,_)=>(o(),s("div",io,[e("table",co,[_[1]||(_[1]=e("thead",{class:"bg-gray-50"},[e("tr",null,[e("th",{scope:"col",class:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Paciente "),e("th",{scope:"col",class:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Estado "),e("th",{scope:"col",class:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Próxima cita "),e("th",{scope:"col",class:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Última sesión "),e("th",{scope:"col",class:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Bono "),e("th",{scope:"col",class:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"}," Acciones ")])],-1)),e("tbody",uo,[(o(!0),s(Q,null,J(E.pacientes,C=>(o(),s("tr",{key:C.id,class:"hover:bg-gray-50 cursor-pointer transition-colors",onClick:n=>k.$emit("ver-ficha",C)},[e("td",mo,[e("div",bo,[e("div",{class:"w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-bold flex-shrink-0",style:Ae({backgroundColor:m(C)})},l(B(C.nombre)),5),e("div",go,[e("p",vo,l(C.nombre||"Sin nombre"),1),C.area_de_acompanamiento?(o(),s("p",fo,l(C.area_de_acompanamiento),1)):$("",!0)])])]),e("td",xo,[e("span",{class:F(["inline-flex items-center px-2 py-0.5 text-xs font-medium rounded-full",b(C)])},l(O(C)),3)]),e("td",ho,[C.proxima_sesion?(o(),s("div",yo,[_[0]||(_[0]=e("div",{class:"w-2 h-2 rounded-full bg-purple-500"},null,-1)),e("span",_o,l(D(C.proxima_sesion)),1)])):(o(),s("span",wo,"Sin cita"))]),e("td",$o,[e("div",ko,[e("div",{class:F(["w-2 h-2 rounded-full",H(C)])},null,2),e("span",{class:F(["text-sm",d(C)])},l(M(C.ultima_sesion)),3)])]),e("td",Co,[C.bono_activo?(o(),s("div",Eo,[e("div",Do,[e("div",{class:F(["h-full rounded-full",y(C.bono_activo)]),style:Ae({width:x(C.bono_activo)+"%"})},null,6)]),e("span",{class:F(["text-xs font-medium",q(C.bono_activo)])},l(C.bono_activo.sesiones_restantes)+"/"+l(C.bono_activo.sesiones_totales),3)])):(o(),s("span",So,"—"))]),e("td",Po,[e("div",Fo,[e("button",{onClick:te(n=>k.$emit("editar",C),["stop"]),class:"p-1.5 text-gray-400 hover:text-purple-600 hover:bg-purple-50 rounded transition-colors",title:"Editar"},[w(t(Dt),{class:"w-4 h-4"})],8,Mo),e("button",{onClick:te(n=>k.$emit("gestionar-bonos",C),["stop"]),class:"p-1.5 text-gray-400 hover:text-purple-600 hover:bg-purple-50 rounded transition-colors",title:"Bonos"},[w(t(Ue),{class:"w-4 h-4"})],8,Ao),e("button",{onClick:te(n=>k.$emit("ver-preview",C),["stop"]),class:"p-1.5 text-gray-400 hover:text-purple-600 hover:bg-purple-50 rounded transition-colors",title:"Vista rápida"},[w(t(St),{class:"w-4 h-4"})],8,jo)])])],8,po))),128))])]),E.pacientes.length===0?(o(),s("div",Vo,[..._[2]||(_[2]=[e("p",{class:"text-sm text-gray-500"},"No hay pacientes que mostrar",-1)])])):$("",!0)]))}},Io={class:"bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto"},To={class:"sticky top-0 bg-white border-b border-gray-100 px-6 py-4 flex justify-between items-center"},zo={class:"text-xl font-semibold text-gray-900"},Ro={key:0,class:"text-sm text-gray-500 mt-0.5"},qo={key:1,class:"text-sm text-gray-500 mt-0.5"},No={class:"px-6 py-3 bg-gray-50 border-b border-gray-100"},Oo={class:"flex items-center gap-2"},Uo={class:"flex-1 h-0.5 bg-gray-200 mx-2"},Lo={key:0,class:"text-xs text-red-500 mt-1"},Ho={key:0,class:"text-xs text-red-500 mt-1"},Go={key:0,class:"text-xs text-red-500 mt-1"},Ko={key:0,class:"bg-red-50 border border-red-200 rounded-lg p-3"},Qo={class:"text-sm text-red-600"},Zo={class:"flex flex-col gap-2 pt-4 border-t border-gray-100"},Jo=["disabled"],Xo=["disabled"],Wo={key:0,class:"w-4 h-4 border-2 border-gray-400 border-t-transparent rounded-full animate-spin"},Yo={class:"space-y-3"},es={class:"flex items-center justify-between"},ts={class:"flex items-center gap-2 text-sm text-gray-500 cursor-pointer"},as={key:0,class:"grid grid-cols-2 gap-3"},os=["min"],ss=["value"],rs={key:1,class:"flex gap-2 flex-wrap"},ns=["onClick"],ls={class:"space-y-3"},is={class:"grid grid-cols-2 gap-2"},ds=["onClick"],cs={key:0,class:"space-y-3"},us={class:"flex items-start gap-3 p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 transition-colors"},ps={class:"text-xs text-gray-500 mt-0.5"},ms={key:0,class:"bg-violet-50 rounded-lg p-4 space-y-3"},bs={class:"flex items-center justify-between"},gs={class:"flex items-center gap-1"},vs={class:"flex items-center gap-2 text-sm text-violet-600 cursor-pointer"},fs={class:"space-y-2"},xs={key:1,class:"bg-red-50 border border-red-200 rounded-lg p-3"},hs={class:"text-sm text-red-600"},ys={class:"flex gap-3 pt-4 border-t border-gray-100"},_s=["disabled"],ws={key:0,class:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"},$s={class:"bg-white rounded-xl shadow-xl p-6 max-w-sm w-full mx-4"},ks={class:"flex gap-3"},Cs={__name:"ModalNuevoPaciente",props:{mostrar:{type:Boolean,default:!1}},emits:["cerrar","paciente-creado"],setup(E,{emit:B}){const m=E,O=B,{supabase:b,waitForUser:D,getUserId:M}=Ye(),{crearBono:A}=Pt(),{crearCita:H}=Ft();Ct();const d=V(1),x=V(!1),y=V(""),q=V({}),k=V(!1),_=V(!1),C=V(""),n=V({nombre:"",apellido:"",email:"",telefono:"",fecha_primera_sesion:"",hora_primera_sesion:"",tipo_bono:"",crear_bono:!1,bono_monto:0,bono_renovacion_automatica:!1,notas_iniciales:""}),h={otro:60,quincenal:100,semanal:160,mensual:180},u=[{value:"otro",label:"A Demanda",desc:"1 sesión - 60€"},{value:"quincenal",label:"Quincenal",desc:"2 sesiones - 100€"},{value:"semanal",label:"Semanal",desc:"4 sesiones - 160€"},{value:"mensual",label:"Mensual",desc:"4 sesiones - 180€"}],g=S(()=>n.value.nombre.trim()&&n.value.apellido.trim()&&n.value.email.trim()&&a(n.value.email)),i=S(()=>n.value.nombre||n.value.apellido||n.value.email||n.value.telefono),p=S(()=>({otro:1,quincenal:2,semanal:4,mensual:4})[n.value.tipo_bono]||0),v=S(()=>`€${h[n.value.tipo_bono]||0}`),Z=S(()=>new Date().toISOString().split("T")[0]),ae=S(()=>{const z=[];for(let f=8;f<=20;f++)z.push(`${String(f).padStart(2,"0")}:00`),z.push(`${String(f).padStart(2,"0")}:30`);return z}),P=S(()=>{const z=new Date,f=new Date(z);f.setDate(f.getDate()+1);const N=new Date(z),me=(8-N.getDay())%7||7;return N.setDate(N.getDate()+me),[{label:"Mañana 10:00",fecha:f.toISOString().split("T")[0],hora:"10:00"},{label:"Próx. Lunes 09:00",fecha:N.toISOString().split("T")[0],hora:"09:00"}]});ye(()=>n.value.tipo_bono,z=>{z==="otro"?(n.value.crear_bono=!1,n.value.bono_monto=0):n.value.crear_bono&&(n.value.bono_monto=h[z]||0)}),ye(()=>n.value.crear_bono,z=>{z&&n.value.tipo_bono&&(n.value.bono_monto=h[n.value.tipo_bono]||0)}),ye(()=>m.mostrar,z=>{z&&ce()});const a=z=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(z),j=()=>(q.value={},n.value.nombre.trim()||(q.value.nombre="El nombre es obligatorio"),n.value.apellido.trim()||(q.value.apellido="El apellido es obligatorio"),n.value.email.trim()?a(n.value.email)||(q.value.email="Introduce un email válido"):q.value.email="El email es obligatorio",Object.keys(q.value).length===0),oe=()=>{j()&&(d.value=2,y.value="")},U=z=>{n.value.fecha_primera_sesion=z.fecha,n.value.hora_primera_sesion=z.hora,C.value=z.label},ee=()=>{i.value&&!x.value?k.value=!0:se()},se=()=>{k.value=!1,O("cerrar")},ce=()=>{d.value=1,n.value={nombre:"",apellido:"",email:"",telefono:"",fecha_primera_sesion:"",hora_primera_sesion:"",tipo_bono:"",crear_bono:!1,bono_monto:0,bono_renovacion_automatica:!1,notas_iniciales:""},y.value="",q.value={},_.value=!1,C.value=""},le=async()=>{j()&&await T(!1)},ie=async()=>{await T(!0)},T=async z=>{try{x.value=!0,y.value="",await D();const f=M();if(!f)throw new Error("Usuario no autenticado. Por favor, vuelve a iniciar sesión.");const N=`${n.value.nombre.trim()} ${n.value.apellido.trim()}`,{data:me,error:ke}=await b.rpc("crear_paciente_simple",{p_email:n.value.email.trim().toLowerCase(),p_nombre_completo:N,p_telefono:n.value.telefono||null,p_area_acompanamiento:null,p_tipo_bono:z&&n.value.tipo_bono||null,p_terapeuta_id:f,p_metadata:{nombre:n.value.nombre.trim(),apellido:n.value.apellido.trim(),notas_iniciales:z?n.value.notas_iniciales:null,fecha_registro:new Date().toISOString(),estado_registro:"activo"}});if(ke)throw new Error(`Error al crear paciente: ${ke.message}`);if(!me||!me.id)throw new Error("Error desconocido al crear paciente");const Ie=me.id;if(!z){O("paciente-creado",me),O("cerrar"),ce();return}if(n.value.crear_bono&&n.value.tipo_bono&&n.value.tipo_bono!=="otro")try{const Ce=new Date().toISOString().split("T")[0],ge=L(n.value.tipo_bono),Ve=p.value;await A({paciente_id:Ie,terapeuta_id:f,tipo:n.value.tipo_bono,sesiones_totales:Ve,sesiones_restantes:Ve,fecha_inicio:Ce,fecha_fin:ge,estado:"pendiente",monto_total:n.value.bono_monto,precio_por_sesion:n.value.bono_monto/Ve,pagado:!1,renovacion_automatica:n.value.bono_renovacion_automatica,notas:`Bono creado al registrar paciente: ${N}`})}catch(Ce){console.error("Error al crear bono:",Ce)}if(!_.value&&n.value.fecha_primera_sesion&&n.value.hora_primera_sesion)try{const[Ce,ge]=n.value.hora_primera_sesion.split(":").map(Number),Ve=`${String(Ce+1).padStart(2,"0")}:${String(ge).padStart(2,"0")}`;await H({paciente_id:Ie,paciente_nombre:N,terapeuta_id:f,fecha:n.value.fecha_primera_sesion,hora_inicio:n.value.hora_primera_sesion,hora_fin:Ve,modalidad:"online",estado:"pendiente",notas:`Primera sesión: ${N}`,descontar_de_bono:!1})}catch(Ce){console.error("Error al crear cita:",Ce)}n.value.notas_iniciales&&await b.from("notas_terapeuticas").insert({paciente_id:Ie,terapeuta_id:f,contenido:n.value.notas_iniciales,tipo:"evaluacion_inicial"}),O("paciente-creado",me),O("cerrar"),ce()}catch(f){console.error("Error al crear paciente:",f),y.value=f.message||"Error al crear el paciente. Por favor, intenta nuevamente."}finally{x.value=!1}},L=z=>{const f=new Date;switch(z){case"quincenal":f.setDate(f.getDate()+15);break;case"semanal":case"mensual":default:f.setMonth(f.getMonth()+1)}return f.toISOString().split("T")[0]};return(z,f)=>E.mostrar?(o(),s("div",{key:0,class:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",onClick:te(ee,["self"]),onKeydown:kt(ee,["esc"])},[e("div",Io,[e("div",To,[e("div",null,[e("h2",zo,l(d.value===1?"Nuevo Paciente":"Configurar Tratamiento"),1),d.value===1?(o(),s("p",Ro," Datos básicos del paciente ")):(o(),s("p",qo,l(n.value.nombre)+" "+l(n.value.apellido),1))]),e("button",{onClick:ee,class:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors","aria-label":"Cerrar"},[...f[14]||(f[14]=[e("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),e("div",No,[e("div",Oo,[e("div",{class:F(["flex items-center gap-1.5",d.value===1?"text-violet-600":"text-gray-400"])},[e("div",{class:F(["w-6 h-6 rounded-full flex items-center justify-center text-xs font-semibold",d.value===1?"bg-violet-600 text-white":"bg-gray-200 text-gray-500"])},l(d.value>1?"✓":"1"),3),f[15]||(f[15]=e("span",{class:"text-sm font-medium"},"Datos",-1))],2),e("div",Uo,[e("div",{class:"h-full bg-violet-600 transition-all duration-300",style:Ae({width:d.value>1?"100%":"0%"})},null,4)]),e("div",{class:F(["flex items-center gap-1.5",d.value===2?"text-violet-600":"text-gray-400"])},[e("div",{class:F(["w-6 h-6 rounded-full flex items-center justify-center text-xs font-semibold",d.value===2?"bg-violet-600 text-white":"bg-gray-200 text-gray-500"])}," 2 ",2),f[16]||(f[16]=e("span",{class:"text-sm font-medium"},"Tratamiento",-1))],2)])]),d.value===1?(o(),s("form",{key:0,onSubmit:te(oe,["prevent"]),class:"p-6 space-y-4"},[e("div",null,[f[17]||(f[17]=e("label",{for:"nombre",class:"block text-sm font-medium text-gray-700 mb-1"},[R(" Nombre "),e("span",{class:"text-red-500"},"*")],-1)),K(e("input",{id:"nombre","onUpdate:modelValue":f[0]||(f[0]=N=>n.value.nombre=N),type:"text",required:"",autofocus:"",class:F(["w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-violet-500 focus:border-transparent transition-shadow",{"border-red-300 bg-red-50":q.value.nombre}]),placeholder:"Nombre del paciente"},null,2),[[re,n.value.nombre]]),q.value.nombre?(o(),s("p",Lo,l(q.value.nombre),1)):$("",!0)]),e("div",null,[f[18]||(f[18]=e("label",{for:"apellido",class:"block text-sm font-medium text-gray-700 mb-1"},[R(" Apellido "),e("span",{class:"text-red-500"},"*")],-1)),K(e("input",{id:"apellido","onUpdate:modelValue":f[1]||(f[1]=N=>n.value.apellido=N),type:"text",required:"",class:F(["w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-violet-500 focus:border-transparent transition-shadow",{"border-red-300 bg-red-50":q.value.apellido}]),placeholder:"Apellido(s) del paciente"},null,2),[[re,n.value.apellido]]),q.value.apellido?(o(),s("p",Ho,l(q.value.apellido),1)):$("",!0)]),e("div",null,[f[19]||(f[19]=e("label",{for:"email",class:"block text-sm font-medium text-gray-700 mb-1"},[R(" Email "),e("span",{class:"text-red-500"},"*")],-1)),K(e("input",{id:"email","onUpdate:modelValue":f[2]||(f[2]=N=>n.value.email=N),type:"email",required:"",class:F(["w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-violet-500 focus:border-transparent transition-shadow",{"border-red-300 bg-red-50":q.value.email}]),placeholder:"correo@ejemplo.com"},null,2),[[re,n.value.email]]),q.value.email?(o(),s("p",Go,l(q.value.email),1)):$("",!0)]),e("div",null,[f[20]||(f[20]=e("label",{for:"telefono",class:"block text-sm font-medium text-gray-700 mb-1"}," Teléfono ",-1)),K(e("input",{id:"telefono","onUpdate:modelValue":f[3]||(f[3]=N=>n.value.telefono=N),type:"tel",class:"w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-violet-500 focus:border-transparent transition-shadow",placeholder:"+34 600 000 000"},null,512),[[re,n.value.telefono]])]),y.value?(o(),s("div",Ko,[e("p",Qo,l(y.value),1)])):$("",!0),e("div",Zo,[e("button",{type:"submit",disabled:!g.value,class:"w-full px-4 py-3 bg-violet-600 hover:bg-violet-700 text-white font-semibold rounded-xl transition-colors disabled:opacity-50 disabled:cursor-not-allowed"}," Crear y configurar tratamiento ",8,Jo),e("button",{type:"button",onClick:le,disabled:!g.value||x.value,class:"w-full px-4 py-2.5 text-gray-600 hover:text-gray-800 hover:bg-gray-100 font-medium rounded-xl transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"},[x.value?(o(),s("span",Wo)):$("",!0),R(" "+l(x.value?"Creando...":"Crear paciente sin configurar"),1)],8,Xo),e("button",{type:"button",onClick:ee,class:"w-full px-4 py-2 text-gray-500 hover:text-gray-700 text-sm transition-colors"}," Cancelar ")])],32)):(o(),s("form",{key:1,onSubmit:te(ie,["prevent"]),class:"p-6 space-y-5"},[e("div",Yo,[e("div",es,[f[22]||(f[22]=e("h3",{class:"text-sm font-semibold text-gray-700"},"Primera Sesión",-1)),e("label",ts,[K(e("input",{"onUpdate:modelValue":f[4]||(f[4]=N=>_.value=N),type:"checkbox",class:"w-4 h-4 text-violet-600 border-gray-300 rounded focus:ring-violet-500"},null,512),[[Fe,_.value]]),f[21]||(f[21]=R(" No agendar ahora ",-1))])]),_.value?$("",!0):(o(),s("div",as,[e("div",null,[f[23]||(f[23]=e("label",{for:"fecha_sesion",class:"block text-xs font-medium text-gray-600 mb-1"},"Fecha",-1)),K(e("input",{id:"fecha_sesion","onUpdate:modelValue":f[5]||(f[5]=N=>n.value.fecha_primera_sesion=N),type:"date",min:Z.value,class:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-violet-500 focus:border-transparent text-sm"},null,8,os),[[re,n.value.fecha_primera_sesion]])]),e("div",null,[f[25]||(f[25]=e("label",{for:"hora_sesion",class:"block text-xs font-medium text-gray-600 mb-1"},"Hora",-1)),K(e("select",{id:"hora_sesion","onUpdate:modelValue":f[6]||(f[6]=N=>n.value.hora_primera_sesion=N),class:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-violet-500 focus:border-transparent text-sm"},[f[24]||(f[24]=e("option",{value:""},"Seleccionar",-1)),(o(!0),s(Q,null,J(ae.value,N=>(o(),s("option",{key:N,value:N},l(N),9,ss))),128))],512),[[Oe,n.value.hora_primera_sesion]])])])),_.value?$("",!0):(o(),s("div",rs,[(o(!0),s(Q,null,J(P.value,N=>(o(),s("button",{key:N.label,type:"button",onClick:me=>U(N),class:F(["text-xs px-3 py-1.5 rounded-lg border transition-all",C.value===N.label?"bg-violet-600 text-white border-violet-600":"bg-white text-gray-600 border-gray-200 hover:border-violet-300"])},l(N.label),11,ns))),128))]))]),e("div",ls,[f[26]||(f[26]=e("div",{class:"flex items-center justify-between"},[e("h3",{class:"text-sm font-semibold text-gray-700"},"Tipo de Bono"),e("span",{class:"text-xs text-gray-400"},"Opcional")],-1)),e("div",is,[(o(),s(Q,null,J(u,N=>e("button",{key:N.value,type:"button",onClick:me=>n.value.tipo_bono=n.value.tipo_bono===N.value?"":N.value,class:F(["p-3 rounded-lg border text-left transition-all",n.value.tipo_bono===N.value?"border-violet-500 bg-violet-50 ring-2 ring-violet-500/20":"border-gray-200 hover:border-gray-300"])},[e("span",{class:F(["text-sm font-medium",n.value.tipo_bono===N.value?"text-violet-700":"text-gray-700"])},l(N.label),3),e("p",{class:F(["text-xs mt-0.5",n.value.tipo_bono===N.value?"text-violet-600":"text-gray-500"])},l(N.desc),3)],10,ds)),64))])]),n.value.tipo_bono&&n.value.tipo_bono!=="otro"?(o(),s("div",cs,[e("label",us,[K(e("input",{"onUpdate:modelValue":f[7]||(f[7]=N=>n.value.crear_bono=N),type:"checkbox",class:"mt-0.5 w-4 h-4 text-violet-600 border-gray-300 rounded focus:ring-violet-500"},null,512),[[Fe,n.value.crear_bono]]),e("div",null,[f[27]||(f[27]=e("span",{class:"text-sm font-medium text-gray-700"},"Crear bono prepagado",-1)),e("p",ps,l(p.value)+" sesiones por "+l(v.value),1)])]),n.value.crear_bono?(o(),s("div",ms,[e("div",bs,[f[29]||(f[29]=e("span",{class:"text-sm text-violet-700"},"Monto total",-1)),e("div",gs,[f[28]||(f[28]=e("span",{class:"text-violet-400"},"€",-1)),K(e("input",{"onUpdate:modelValue":f[8]||(f[8]=N=>n.value.bono_monto=N),type:"number",min:"0",step:"5",class:"w-20 px-2 py-1 border border-violet-200 rounded text-right text-sm font-medium text-violet-700 focus:ring-2 focus:ring-violet-500"},null,512),[[re,n.value.bono_monto,void 0,{number:!0}]])])]),e("label",vs,[K(e("input",{"onUpdate:modelValue":f[9]||(f[9]=N=>n.value.bono_renovacion_automatica=N),type:"checkbox",class:"w-4 h-4 text-violet-600 border-violet-300 rounded focus:ring-violet-500"},null,512),[[Fe,n.value.bono_renovacion_automatica]]),f[30]||(f[30]=R(" Renovación automática ",-1))])])):$("",!0)])):$("",!0),e("div",fs,[f[31]||(f[31]=e("label",{for:"notas",class:"block text-sm font-medium text-gray-700"},[R(" Observaciones "),e("span",{class:"text-gray-400 font-normal"},"(opcional)")],-1)),K(e("textarea",{id:"notas","onUpdate:modelValue":f[10]||(f[10]=N=>n.value.notas_iniciales=N),rows:"2",class:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-violet-500 focus:border-transparent text-sm resize-none",placeholder:"Motivo de consulta, derivación, contexto inicial..."},null,512),[[re,n.value.notas_iniciales]]),f[32]||(f[32]=e("p",{class:"text-xs text-gray-400"},"Solo visible para ti, no se envía al paciente.",-1))]),y.value?(o(),s("div",xs,[e("p",hs,l(y.value),1)])):$("",!0),e("div",ys,[e("button",{type:"button",onClick:f[11]||(f[11]=N=>d.value=1),class:"px-4 py-2.5 border border-gray-300 text-gray-700 font-medium rounded-xl hover:bg-gray-50 transition-colors"}," Atrás "),e("button",{type:"submit",disabled:x.value,class:"flex-1 px-4 py-2.5 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-xl transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"},[x.value?(o(),s("span",ws)):$("",!0),R(" "+l(x.value?"Creando...":"Crear Paciente"),1)],8,_s)])],32))]),k.value?(o(),s("div",{key:0,class:"fixed inset-0 bg-black/30 flex items-center justify-center z-60",onClick:f[13]||(f[13]=te(N=>k.value=!1,["self"]))},[e("div",$s,[f[33]||(f[33]=e("h3",{class:"text-lg font-semibold text-gray-900 mb-2"},"Tienes cambios sin guardar",-1)),f[34]||(f[34]=e("p",{class:"text-sm text-gray-600 mb-4"},"Si cierras ahora, perderás los datos ingresados.",-1)),e("div",ks,[e("button",{onClick:f[12]||(f[12]=N=>k.value=!1),class:"flex-1 px-4 py-2 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors"}," Continuar editando "),e("button",{onClick:se,class:"flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors"}," Descartar ")])])])):$("",!0)],32)):$("",!0)}},Es={class:"bg-[#F2F2F2] rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"},Ds={class:"space-y-4"},Ss={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},Ps={class:"space-y-4 pt-4 border-t border-[#5550F2]/30"},Fs={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},Ms={class:"relative"},As={class:"md:col-span-2 space-y-3"},js={class:"flex items-center gap-2 cursor-pointer"},Vs={key:0,class:"bg-amber-50 border border-amber-200 rounded-lg p-4 space-y-3"},Bs={class:"bg-white/80 rounded-lg p-3 border border-amber-100"},Is={class:"flex items-center justify-between mb-2"},Ts={class:"w-full bg-gray-200 rounded-full h-2"},zs=["disabled"],Rs={class:"space-y-4 pt-4 border-t border-[#5550F2]/30"},qs={key:0,class:"border-2 border-blue-400/40 rounded-lg p-4 space-y-4 bg-blue-50/30"},Ns={class:"flex items-center justify-between"},Os={class:"flex items-center gap-2"},Us={class:"font-medium text-[#2D3748]"},Ls={class:"text-xs text-[#2D3748]/60"},Hs={class:"grid grid-cols-2 gap-4"},Gs={class:"px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg text-[#2D3748] font-medium"},Ks=["max"],Qs={key:0,class:"text-amber-600 ml-1"},Zs={key:1,class:"bg-gray-50 border border-gray-200 rounded-lg p-4 text-center"},Js={key:2,class:"flex items-center justify-center py-4"},Xs={class:"flex items-center justify-between pt-2"},Ws={class:"flex items-center gap-2 cursor-pointer"},Ys={key:3,class:"border-2 border-purple-400/40 rounded-lg p-4 space-y-4 bg-purple-50/30"},er={class:"bg-purple-100 border border-purple-300 rounded-lg p-3 flex items-start gap-2"},tr={class:"text-sm text-purple-800"},ar={class:"font-medium"},or={class:"text-xs text-purple-700 mt-1"},sr={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},rr={class:"relative"},nr=["required"],lr={class:"px-4 py-2 bg-purple-100 border-2 border-purple-300 rounded-lg text-purple-900 font-bold"},ir={class:"md:col-span-2"},dr={class:"flex items-center gap-2 cursor-pointer"},cr={key:0,class:"bg-white border border-purple-300 rounded-lg p-4"},ur={class:"text-sm text-cafe/80 space-y-1"},pr={key:0,class:"text-purple-700"},mr={key:0,class:"bg-red-50 border border-red-200 rounded-lg p-4"},br={class:"text-sm text-red-600"},gr={class:"flex justify-end gap-3 pt-4 border-t border-[#5550F2]/30"},vr=["disabled"],fr=["disabled"],xr={key:0,class:"inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"},hr={__name:"ModalEditarPaciente",props:{mostrar:{type:Boolean,default:!1},paciente:{type:Object,default:null}},emits:["cerrar","paciente-actualizado"],setup(E,{emit:B}){const m=E,O=B,{supabase:b,userProfile:D}=Ye(),{crearBono:M}=Pt(),{success:A,error:H}=Ge(),d=V({nombre:"",apellido:"",email:"",telefono:"",fecha_nacimiento:"",tipo_bono:"",precio_sesion:null,activo:!0,en_pausa:!1,crear_bono:!1,bono_monto:null,bono_renovacion_automatica:!1,bono_sesiones_usadas:0}),x=V(null),y=V(!1),q=V(!1),k=S(()=>{if(!d.value.en_pausa)return 45;const a=(m.paciente?.metadata||{}).fecha_pausa;if(!a)return 45;const j=new Date(a),U=Math.floor((new Date().getTime()-j.getTime())/(1e3*60*60*24));return Math.max(0,45-U)}),_=async()=>{if(!m.paciente?.email){H("El paciente no tiene email registrado");return}q.value=!0;try{await new Promise(P=>setTimeout(P,1500)),A(`Recordatorio enviado a ${m.paciente.email}`)}catch(P){console.error("Error al enviar recordatorio:",P),H("No se pudo enviar el recordatorio")}finally{q.value=!1}},C=S(()=>x.value?Math.max(0,x.value.sesiones_totales-(d.value.bono_sesiones_usadas||0)):0),n=S(()=>{const P=d.value.tipo_bono;return P?{a_demanda:1,quincenal:2,semanal:4}[P]||0:"Selecciona tipo"}),h=S(()=>{const P=d.value.tipo_bono;return{a_demanda:"A Demanda",quincenal:"Quincenal",semanal:"Semanal"}[P]||""}),u=S(()=>{const P=n.value,a=d.value.bono_monto;return P==="Selecciona tipo"||!a||P<=0?"0.00":(a/P).toFixed(2)}),g=V(!1),i=V("");ye(()=>m.mostrar,P=>{P&&m.paciente&&p()});const p=async()=>{const P=m.paciente,a=P.metadata||{},oe=(P.nombre_completo||P.nombre||"").split(" "),U=oe[0]||a.nombre||"",ee=oe.slice(1).join(" ")||a.apellido||a.apellido_paterno||"";d.value={nombre:U,apellido:ee,email:P.email||"",telefono:P.telefono||"",fecha_nacimiento:a.fecha_nacimiento||"",tipo_bono:P.tipo_bono||"",precio_sesion:P.precio_sesion||null,activo:P.activo??!0,en_pausa:P.en_pausa||a.en_pausa||!1,crear_bono:!1,bono_monto:null,bono_renovacion_automatica:!1,bono_sesiones_usadas:0},i.value="",await v()},v=async()=>{if(m.paciente?.id){y.value=!0,x.value=null;try{const{data:P,error:a}=await b.from("bonos").select("*").eq("paciente_id",m.paciente.id).in("estado",["activo","pendiente"]).order("created_at",{ascending:!1}).limit(1).single();P&&!a&&(x.value=P,d.value.bono_sesiones_usadas=P.sesiones_usadas||0)}catch{console.log("No se encontró bono activo para el paciente")}finally{y.value=!1}}},Z=()=>{g.value||O("cerrar")},ae=async()=>{try{g.value=!0,i.value="",console.log("Actualizando paciente:",m.paciente.id);const P=`${d.value.nombre.trim()} ${d.value.apellido.trim()}`,a=m.paciente.metadata||{},j=a.en_pausa||!1;let oe=a.fecha_pausa||null;d.value.en_pausa&&!j?oe=new Date().toISOString():d.value.en_pausa||(oe=null);const{data:U,error:ee}=await b.from("pacientes").update({email:d.value.email,nombre_completo:P,telefono:d.value.telefono,tipo_bono:d.value.tipo_bono,precio_sesion:d.value.precio_sesion,activo:d.value.activo,en_pausa:d.value.en_pausa,metadata:{...a,nombre:d.value.nombre,apellido:d.value.apellido,fecha_nacimiento:d.value.fecha_nacimiento,en_pausa:d.value.en_pausa,fecha_pausa:oe,fecha_actualizacion:new Date().toISOString()}}).eq("id",m.paciente.id).select().single();if(ee)throw console.error("Error al actualizar paciente:",ee),ee;if(console.log("Paciente actualizado:",U),x.value&&d.value.bono_sesiones_usadas!==x.value.sesiones_usadas){console.log("Actualizando sesiones del bono...");const se=d.value.bono_sesiones_usadas||0,ce=x.value.sesiones_totales-se,le=ce<=0?"agotado":x.value.estado,{error:ie}=await b.from("bonos").update({sesiones_usadas:se,sesiones_restantes:ce,estado:le}).eq("id",x.value.id);if(ie)throw console.error("Error al actualizar bono:",ie),H("Error al actualizar las sesiones del bono"),new Error("Error al actualizar las sesiones del bono");console.log("Bono actualizado:",{sesiones_usadas:se,sesiones_restantes:ce}),A("Sesiones del bono actualizadas")}if(d.value.crear_bono&&d.value.tipo_bono&&d.value.bono_monto){console.log("[BONO] Iniciando creación de bono para paciente:",m.paciente.id);const se=D.value?.id||m.paciente?.psicologa_id;if(!se)throw console.error("[BONO] ERROR: No se pudo obtener el ID del terapeuta"),new Error("No se pudo identificar al terapeuta para crear el bono");console.log("[BONO] Terapeuta ID:",se);const ce=new Date,le=new Date,ie=d.value.tipo_bono;ie==="a_demanda"?le.setMonth(le.getMonth()+1):ie==="quincenal"?le.setDate(le.getDate()+15):ie==="semanal"&&le.setMonth(le.getMonth()+1);const T=n.value,L={paciente_id:m.paciente.id,terapeuta_id:se,tipo:ie,frecuencia:ie,sesiones_totales:T,sesiones_restantes:T,sesiones_usadas:0,monto_total:d.value.bono_monto,fecha_inicio:ce.toISOString().split("T")[0],fecha_fin:le.toISOString().split("T")[0],estado:"activo",pagado:!1,renovacion_automatica:d.value.bono_renovacion_automatica};console.log("[BONO] Datos del bono a crear:",L);try{const z=await M(L);console.log("[BONO] Bono creado exitosamente:",z),A("Bono creado correctamente")}catch(z){console.error("[BONO] Error al crear bono:",z),H("Error al crear el bono: "+(z.message||"Error desconocido"))}}A("Paciente actualizado correctamente"),O("paciente-actualizado",U),O("cerrar")}catch(P){console.error("Error al actualizar paciente:",P),i.value=P.message||"Error al actualizar el paciente. Por favor, intenta nuevamente."}finally{g.value=!1}};return(P,a)=>E.mostrar?(o(),s("div",{key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",onClick:te(Z,["self"])},[e("div",Es,[e("div",{class:"sticky top-0 bg-[#F2F2F2] border-b border-[#5550F2]/30 px-6 py-4 flex justify-between items-center"},[a[14]||(a[14]=e("h2",{class:"text-2xl font-serif text-[#2D3748] font-semibold"}," Editar Paciente ",-1)),e("button",{onClick:Z,class:"text-[#2D3748] hover:text-[#5550F2] transition-colors","aria-label":"Cerrar modal"},[...a[13]||(a[13]=[e("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),e("form",{onSubmit:te(ae,["prevent"]),class:"px-6 py-6 space-y-6"},[e("div",Ds,[a[20]||(a[20]=e("h3",{class:"text-lg font-serif text-[#2D3748] font-semibold"}," Información Personal ",-1)),e("div",Ss,[e("div",null,[a[15]||(a[15]=e("label",{for:"nombre",class:"block text-sm font-medium text-[#2D3748] mb-1"},[R(" Nombre "),e("span",{class:"text-red-500"},"*")],-1)),K(e("input",{id:"nombre","onUpdate:modelValue":a[0]||(a[0]=j=>d.value.nombre=j),type:"text",required:"",class:"w-full px-4 py-2 border border-[#5550F2]/30 rounded-lg focus:ring-2 focus:ring-[#5550F2] focus:border-transparent bg-white",placeholder:"Nombre del paciente"},null,512),[[re,d.value.nombre]])]),e("div",null,[a[16]||(a[16]=e("label",{for:"apellido",class:"block text-sm font-medium text-[#2D3748] mb-1"},[R(" Apellido "),e("span",{class:"text-red-500"},"*")],-1)),K(e("input",{id:"apellido","onUpdate:modelValue":a[1]||(a[1]=j=>d.value.apellido=j),type:"text",required:"",class:"w-full px-4 py-2 border border-[#5550F2]/30 rounded-lg focus:ring-2 focus:ring-[#5550F2] focus:border-transparent bg-white",placeholder:"Apellido(s) del paciente"},null,512),[[re,d.value.apellido]])]),e("div",null,[a[17]||(a[17]=e("label",{for:"email",class:"block text-sm font-medium text-[#2D3748] mb-1"},[R(" Email "),e("span",{class:"text-red-500"},"*")],-1)),K(e("input",{id:"email","onUpdate:modelValue":a[2]||(a[2]=j=>d.value.email=j),type:"email",required:"",class:"w-full px-4 py-2 border border-[#5550F2]/30 rounded-lg focus:ring-2 focus:ring-[#5550F2] focus:border-transparent bg-white",placeholder:"correo@ejemplo.com"},null,512),[[re,d.value.email]])]),e("div",null,[a[18]||(a[18]=e("label",{for:"telefono",class:"block text-sm font-medium text-[#2D3748] mb-1"}," Teléfono ",-1)),K(e("input",{id:"telefono","onUpdate:modelValue":a[3]||(a[3]=j=>d.value.telefono=j),type:"tel",class:"w-full px-4 py-2 border border-[#5550F2]/30 rounded-lg focus:ring-2 focus:ring-[#5550F2] focus:border-transparent bg-white",placeholder:"+52 123 456 7890"},null,512),[[re,d.value.telefono]])]),e("div",null,[a[19]||(a[19]=e("label",{for:"fecha_nacimiento",class:"block text-sm font-medium text-[#2D3748] mb-1"}," Fecha de Nacimiento ",-1)),K(e("input",{id:"fecha_nacimiento","onUpdate:modelValue":a[4]||(a[4]=j=>d.value.fecha_nacimiento=j),type:"date",class:"w-full px-4 py-2 border border-[#5550F2]/30 rounded-lg focus:ring-2 focus:ring-[#5550F2] focus:border-transparent bg-white"},null,512),[[re,d.value.fecha_nacimiento]])])])]),e("div",Ps,[a[36]||(a[36]=e("h3",{class:"text-lg font-serif text-[#2D3748] font-semibold"}," Información Terapéutica ",-1)),e("div",Fs,[e("div",null,[a[22]||(a[22]=e("label",{for:"tipo_bono",class:"block text-sm font-medium text-[#2D3748] mb-1"},[R(" Tipo de Bono "),e("span",{class:"text-red-500"},"*")],-1)),K(e("select",{id:"tipo_bono","onUpdate:modelValue":a[5]||(a[5]=j=>d.value.tipo_bono=j),required:"",class:"w-full px-4 py-2 border border-[#5550F2]/30 rounded-lg focus:ring-2 focus:ring-[#5550F2] focus:border-transparent bg-white"},[...a[21]||(a[21]=[e("option",{value:""},"Selecciona tipo de bono",-1),e("option",{value:"a_demanda"},"A Demanda (1 sesión)",-1),e("option",{value:"quincenal"},"Quincenal (2 sesiones/mes)",-1),e("option",{value:"semanal"},"Semanal (4 sesiones/mes)",-1)])],512),[[Oe,d.value.tipo_bono]])]),e("div",null,[a[24]||(a[24]=e("label",{for:"precio_sesion",class:"block text-sm font-medium text-[#2D3748] mb-1"}," Precio por Sesión (€) ",-1)),e("div",Ms,[a[23]||(a[23]=e("span",{class:"absolute left-3 top-1/2 -translate-y-1/2 text-[#2D3748]/60"},"€",-1)),K(e("input",{id:"precio_sesion","onUpdate:modelValue":a[6]||(a[6]=j=>d.value.precio_sesion=j),type:"number",min:"0",step:"0.01",placeholder:"Usar precio del terapeuta",class:"w-full pl-8 pr-4 py-2 border border-[#5550F2]/30 rounded-lg focus:ring-2 focus:ring-[#5550F2] focus:border-transparent bg-white"},null,512),[[re,d.value.precio_sesion,void 0,{number:!0}]])]),a[25]||(a[25]=e("p",{class:"text-xs text-[#2D3748]/60 mt-1"}," 💡 Precio personalizado para este paciente. Si está vacío, se usa el precio según frecuencia del terapeuta. ",-1))]),e("div",null,[a[27]||(a[27]=e("label",{for:"activo",class:"block text-sm font-medium text-[#2D3748] mb-1"}," Estado ",-1)),K(e("select",{id:"activo","onUpdate:modelValue":a[7]||(a[7]=j=>d.value.activo=j),class:"w-full px-4 py-2 border border-[#5550F2]/30 rounded-lg focus:ring-2 focus:ring-[#5550F2] focus:border-transparent bg-white"},[...a[26]||(a[26]=[e("option",{value:!0},"Activo",-1),e("option",{value:!1},"Inactivo",-1)])],512),[[Oe,d.value.activo]])]),e("div",As,[e("label",js,[K(e("input",{"onUpdate:modelValue":a[8]||(a[8]=j=>d.value.en_pausa=j),type:"checkbox",class:"w-4 h-4 text-amber-500 border-gray-300 rounded focus:ring-amber-500"},null,512),[[Fe,d.value.en_pausa]]),a[28]||(a[28]=e("span",{class:"text-sm font-medium text-[#2D3748]"}," Proceso en pausa temporal ",-1))]),d.value.en_pausa?(o(),s("div",Vs,[a[34]||(a[34]=e("div",{class:"flex items-start gap-3"},[e("span",{class:"text-2xl"},"⏸️"),e("div",null,[e("p",{class:"font-medium text-amber-800"},"Cuenta en pausa temporal"),e("p",{class:"text-sm text-amber-700 mt-1"},[R(" El proceso terapeutico esta pausado. El paciente mantendra su espacio reservado durante "),e("strong",null,"45 dias"),R(". ")])])],-1)),e("div",Bs,[e("div",Is,[a[29]||(a[29]=e("span",{class:"text-sm font-medium text-gray-700"},"Dias restantes:",-1)),e("span",{class:F(["text-lg font-bold",k.value<=7?"text-red-600":"text-amber-600"])},l(k.value)+" dias ",3)]),e("div",Ts,[e("div",{class:F(["h-2 rounded-full transition-all",k.value<=7?"bg-red-500":"bg-amber-500"]),style:Ae({width:`${Math.max(0,k.value/45*100)}%`})},null,6)])]),a[35]||(a[35]=e("div",{class:"text-xs text-amber-800 space-y-2 bg-amber-100/50 rounded p-3"},[e("p",{class:"font-medium flex items-center gap-1"},[e("span",null,"⚠️"),R(" Importante: ")]),e("ul",{class:"list-disc list-inside space-y-1 text-amber-700"},[e("li",null,[R("Pasados los 45 dias, el perfil se "),e("strong",null,"desactivara automaticamente")]),e("li",null,"Se liberara su espacio en la agenda de Psicologa Karem"),e("li",null,[R("Los datos se eliminaran conforme al "),e("strong",null,"reglamento de proteccion de datos"),R(" para garantizar su privacidad")]),e("li",null,"Al reactivar, los precios de las sesiones podrian haberse modificado")])],-1)),e("button",{type:"button",onClick:_,disabled:q.value,class:"w-full py-2 px-4 bg-amber-600 text-white text-sm font-medium rounded-lg hover:bg-amber-700 disabled:opacity-50 transition-colors flex items-center justify-center gap-2"},[q.value?(o(),s(Q,{key:0},[a[30]||(a[30]=e("span",{class:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"},null,-1)),a[31]||(a[31]=R(" Enviando... ",-1))],64)):(o(),s(Q,{key:1},[a[32]||(a[32]=e("span",null,"📧",-1)),a[33]||(a[33]=R(" Enviar recordatorio al paciente ",-1))],64))],8,zs)])):$("",!0)])])]),e("div",Rs,[a[61]||(a[61]=e("h3",{class:"text-lg font-serif text-[#2D3748] font-semibold"}," Gestión de Bonos ",-1)),x.value?(o(),s("div",qs,[e("div",Ns,[e("div",Os,[a[38]||(a[38]=e("span",{class:"text-xl"},"🎫",-1)),e("div",null,[e("p",Us,"Bono "+l(x.value.tipo||"Activo"),1),e("p",Ls,[a[37]||(a[37]=R(" Estado: ",-1)),e("span",{class:F([x.value.estado==="activo"?"text-green-600":"text-amber-600","font-medium capitalize"])},l(x.value.estado),3)])])]),e("span",{class:F(["px-2 py-1 text-xs font-medium rounded-full",x.value.estado==="activo"?"bg-green-100 text-green-700":"bg-amber-100 text-amber-700"])},l(x.value.sesiones_restantes)+"/"+l(x.value.sesiones_totales)+" restantes ",3)]),e("div",Hs,[e("div",null,[a[39]||(a[39]=e("label",{class:"block text-sm font-medium text-[#2D3748] mb-1"}," Sesiones Totales ",-1)),e("div",Gs,l(x.value.sesiones_totales),1)]),e("div",null,[a[40]||(a[40]=e("label",{for:"sesiones_usadas_bono",class:"block text-sm font-medium text-[#2D3748] mb-1"}," Sesiones Consumidas ",-1)),K(e("input",{id:"sesiones_usadas_bono","onUpdate:modelValue":a[9]||(a[9]=j=>d.value.bono_sesiones_usadas=j),type:"number",min:"0",max:x.value.sesiones_totales,class:"w-full px-4 py-2 border border-blue-400/50 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white"},null,8,Ks),[[re,d.value.bono_sesiones_usadas,void 0,{number:!0}]])])]),e("div",{class:F(["flex items-center gap-2 p-3 rounded-lg",C.value<=0?"bg-red-50 border border-red-200":"bg-blue-50 border border-blue-200"])},[e("span",{class:F(C.value<=0?"text-red-600":"text-blue-600")},l(C.value<=0?"⚠️":"ℹ️"),3),e("p",{class:F(["text-sm",C.value<=0?"text-red-800":"text-blue-800"])},[e("strong",null,l(C.value),1),R(" de "+l(x.value.sesiones_totales)+" sesiones disponibles ",1),d.value.bono_sesiones_usadas!==x.value.sesiones_usadas?(o(),s("span",Qs," (modificado) ")):$("",!0)],2)],2),a[41]||(a[41]=e("p",{class:"text-xs text-[#2D3748]/60"}," 💡 Ajusta las sesiones consumidas para sincronizar con datos de otra plataforma o corregir errores. ",-1))])):y.value?$("",!0):(o(),s("div",Zs,[...a[42]||(a[42]=[e("p",{class:"text-sm text-[#2D3748]/70"}," Este paciente no tiene un bono activo. ",-1)])])),y.value?(o(),s("div",Js,[...a[43]||(a[43]=[e("div",{class:"w-5 h-5 border-2 border-blue-200 border-t-blue-600 rounded-full animate-spin mr-2"},null,-1),e("span",{class:"text-sm text-[#2D3748]/60"},"Cargando bono...",-1)])])):$("",!0),e("div",Xs,[e("label",Ws,[K(e("input",{"onUpdate:modelValue":a[10]||(a[10]=j=>d.value.crear_bono=j),type:"checkbox",class:"w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500"},null,512),[[Fe,d.value.crear_bono]]),a[44]||(a[44]=e("span",{class:"text-sm font-medium text-[#2D3748]"}," 🎫 Crear nuevo bono para este paciente ",-1))])]),d.value.crear_bono?(o(),s("div",Ys,[e("div",er,[a[46]||(a[46]=e("svg",{class:"w-5 h-5 text-purple-600 flex-shrink-0 mt-0.5",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{"fill-rule":"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z","clip-rule":"evenodd"})],-1)),e("div",tr,[e("p",ar,[a[45]||(a[45]=R("El bono usará el tipo seleccionado arriba: ",-1)),e("strong",null,l(h.value||"Selecciona un tipo primero"),1)]),e("p",or," Sesiones incluidas: "+l(n.value==="Selecciona tipo"?"N/A":n.value),1)])]),e("div",sr,[e("div",null,[a[48]||(a[48]=e("label",{for:"bono_monto",class:"block text-sm font-medium text-[#2D3748] mb-1"},[R(" Monto Total "),e("span",{class:"text-red-500"},"*")],-1)),e("div",rr,[a[47]||(a[47]=e("span",{class:"absolute left-3 top-2.5 text-[#2D3748] font-medium"},"€",-1)),K(e("input",{id:"bono_monto","onUpdate:modelValue":a[11]||(a[11]=j=>d.value.bono_monto=j),type:"number",min:"0",step:"0.01",required:d.value.crear_bono,class:"w-full pl-8 pr-4 py-2 border border-[#5550F2]/30 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white",placeholder:"0.00"},null,8,nr),[[re,d.value.bono_monto,void 0,{number:!0}]])])]),e("div",null,[a[49]||(a[49]=e("label",{class:"block text-sm font-medium text-[#2D3748] mb-1"}," Precio por Sesión ",-1)),e("div",lr," €"+l(u.value),1)]),e("div",ir,[e("label",dr,[K(e("input",{"onUpdate:modelValue":a[12]||(a[12]=j=>d.value.bono_renovacion_automatica=j),type:"checkbox",class:"w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500"},null,512),[[Fe,d.value.bono_renovacion_automatica]]),a[50]||(a[50]=e("span",{class:"text-sm font-medium text-[#2D3748]"}," 🔄 Renovación automática al vencer ",-1))]),a[51]||(a[51]=e("p",{class:"text-xs text-cafe/60 mt-1 ml-6"}," El sistema creará un nuevo bono idéntico cuando este expire ",-1))])]),n.value&&d.value.bono_monto?(o(),s("div",cr,[a[60]||(a[60]=e("p",{class:"text-sm font-medium text-[#2D3748] mb-2"},"📋 Resumen del Bono:",-1)),e("div",ur,[e("p",null,[a[52]||(a[52]=R("• ",-1)),a[53]||(a[53]=e("strong",null,"Tipo:",-1)),R(" "+l(h.value),1)]),e("p",null,[a[54]||(a[54]=R("• ",-1)),a[55]||(a[55]=e("strong",null,"Sesiones:",-1)),R(" "+l(n.value),1)]),e("p",null,[a[56]||(a[56]=R("• ",-1)),a[57]||(a[57]=e("strong",null,"Total:",-1)),R(" €"+l(d.value.bono_monto.toFixed(2)),1)]),e("p",null,[a[58]||(a[58]=R("• ",-1)),a[59]||(a[59]=e("strong",null,"Por sesión:",-1)),R(" €"+l(u.value),1)]),d.value.bono_renovacion_automatica?(o(),s("p",pr,"• ✅ Con renovación automática")):$("",!0)])])):$("",!0)])):$("",!0)]),i.value?(o(),s("div",mr,[e("p",br,l(i.value),1)])):$("",!0),e("div",gr,[e("button",{type:"button",onClick:Z,disabled:g.value,class:"px-6 py-2 border border-[#5550F2] text-[#2D3748] rounded-lg hover:bg-[#5550F2]/10 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"}," Cancelar ",8,vr),e("button",{type:"submit",disabled:g.value,class:"px-6 py-2 bg-[#5550F2] text-white rounded-lg hover:bg-[#C69F91] transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"},[g.value?(o(),s("span",xr)):$("",!0),R(" "+l(g.value?"Actualizando...":"Guardar Cambios"),1)],8,fr)])],32)])])):$("",!0)}},yr=ze(hr,[["__scopeId","data-v-b27bd45f"]]),_r={class:"bg-[#F2F2F2] rounded-lg shadow-xl max-w-md w-full"},wr={class:"px-6 py-6 space-y-4"},$r={class:"text-[#2D3748]"},kr={class:"font-semibold"},Cr={class:"bg-blue-50 border border-blue-200 rounded-lg p-4"},Er=["disabled"],Dr={key:0,class:"bg-red-50 border border-red-200 rounded-lg p-3"},Sr={class:"text-sm text-red-600"},Pr={class:"px-6 py-4 border-t border-[#5550F2]/30 flex justify-end gap-3"},Fr=["disabled"],Mr=["disabled"],Ar={key:0,class:"inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"},jr={__name:"ModalEliminarPaciente",props:{mostrar:{type:Boolean,default:!1},paciente:{type:Object,default:null}},emits:["cerrar","paciente-eliminado","paciente-desactivado"],setup(E,{emit:B}){const m=E,O=B,{supabase:b}=Ye(),D=V(!1),M=V(""),A=S(()=>m.paciente?m.paciente.nombre_completo||m.paciente.nombre||m.paciente.email||"este paciente":""),H=()=>{D.value||(M.value="",O("cerrar"))},d=async()=>{try{D.value=!0,M.value="",console.log("Desactivando paciente:",m.paciente.id);const{error:y}=await b.from("pacientes").update({activo:!1,metadata:{...m.paciente.metadata,fecha_desactivacion:new Date().toISOString()}}).eq("id",m.paciente.id);if(y)throw y;console.log("Paciente desactivado exitosamente"),O("paciente-desactivado",m.paciente.id),O("cerrar")}catch(y){console.error("Error al desactivar paciente:",y),M.value=y.message||"Error al desactivar el paciente."}finally{D.value=!1}},x=async()=>{try{D.value=!0,M.value="",console.log("Eliminando paciente:",m.paciente.id),await b.from("metricas_bienestar").delete().eq("paciente_id",m.paciente.id),await b.from("notas_terapeuticas").delete().eq("paciente_id",m.paciente.id),await b.from("recursos_compartidos").delete().eq("paciente_id",m.paciente.id),await b.from("mensajes").delete().or(`remitente_id.eq.${m.paciente.id},destinatario_id.eq.${m.paciente.id}`),await b.from("bonos").delete().eq("paciente_id",m.paciente.id),await b.from("sesiones").delete().eq("paciente_id",m.paciente.id);const{error:y}=await b.from("pacientes").delete().eq("id",m.paciente.id);if(y)throw y;console.log("Paciente eliminado exitosamente"),O("paciente-eliminado",m.paciente.id),O("cerrar")}catch(y){console.error("Error al eliminar paciente:",y),M.value=y.message||"Error al eliminar el paciente. Por favor, intenta nuevamente."}finally{D.value=!1}};return(y,q)=>E.mostrar?(o(),s("div",{key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",onClick:te(H,["self"])},[e("div",_r,[q[5]||(q[5]=e("div",{class:"px-6 py-4 border-b border-[#5550F2]/30"},[e("div",{class:"flex items-center gap-3"},[e("span",{class:"text-3xl"},"⚠️"),e("h2",{class:"text-2xl font-serif text-[#2D3748] font-semibold"}," Eliminar Paciente ")])],-1)),e("div",wr,[e("p",$r,[q[0]||(q[0]=R(" ¿Estás seguro de que deseas eliminar a ",-1)),e("strong",kr,l(A.value),1),q[1]||(q[1]=R("? ",-1))]),q[4]||(q[4]=e("div",{class:"bg-red-50 border border-red-200 rounded-lg p-4 space-y-2"},[e("p",{class:"text-sm text-red-800 font-medium"}," Esta acción no se puede deshacer y eliminará: "),e("ul",{class:"text-sm text-red-700 space-y-1 ml-4 list-disc"},[e("li",null,"Todos los datos personales del paciente"),e("li",null,"El historial de sesiones"),e("li",null,"Las notas terapéuticas"),e("li",null,"Las métricas de bienestar"),e("li",null,"Los bonos asociados")])],-1)),e("div",Cr,[q[2]||(q[2]=e("p",{class:"text-sm text-blue-800 font-medium mb-2"}," 💡 Recomendación: ",-1)),q[3]||(q[3]=e("p",{class:"text-sm text-blue-700 mb-3"},[R(" En lugar de eliminar, considera "),e("strong",null,"desactivar"),R(" al paciente. Esto preservará el historial para consultas futuras. ")],-1)),e("button",{type:"button",onClick:d,disabled:D.value,class:"w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm"}," Desactivar en lugar de eliminar ",8,Er)]),M.value?(o(),s("div",Dr,[e("p",Sr,l(M.value),1)])):$("",!0)]),e("div",Pr,[e("button",{type:"button",onClick:H,disabled:D.value,class:"px-6 py-2 border border-[#5550F2] text-[#2D3748] rounded-lg hover:bg-[#5550F2]/10 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"}," Cancelar ",8,Fr),e("button",{type:"button",onClick:x,disabled:D.value,class:"px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"},[D.value?(o(),s("span",Ar)):$("",!0),R(" "+l(D.value?"Eliminando...":"Eliminar Definitivamente"),1)],8,Mr)])])])):$("",!0)}},Vr=ze(jr,[["__scopeId","data-v-941153fc"]]),Br={class:"bg-white dark:bg-gray-900 rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden"},Ir={class:"px-6 py-4 border-b border-gray-200 dark:border-gray-800 flex items-center justify-between bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20"},Tr={key:0,class:"text-sm text-gray-600 dark:text-gray-400 mt-1"},zr={key:0,class:"p-12 flex flex-col items-center justify-center"},Rr={class:"space-y-6"},qr={class:"space-y-2"},Nr={class:"flex gap-2 flex-wrap"},Or=["onClick"],Ur={class:"text-xs text-gray-500 dark:text-gray-400 capitalize"},Lr={class:"grid grid-cols-1 md:grid-cols-3 gap-4"},Hr={class:"md:col-span-2"},Gr={class:"space-y-3"},Kr={class:"grid grid-cols-4 sm:grid-cols-6 gap-2 max-h-48 overflow-y-auto p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700"},Qr=["onClick"],Zr={class:"text-xs"},Jr={class:"mt-2"},Xr={key:0,class:"p-4 bg-yellow-50 dark:bg-yellow-900/20 border-2 border-yellow-300 dark:border-yellow-700 rounded-lg"},Wr={class:"grid grid-cols-3 gap-3"},Yr=["onClick"],en={class:"text-2xl mb-1"},tn={class:"text-sm font-medium text-gray-900 dark:text-white"},an={class:"grid grid-cols-2 md:grid-cols-4 gap-3"},on=["onClick"],sn={class:"text-xl mb-1"},rn={class:"text-xs font-medium text-gray-900 dark:text-white"},nn={class:"px-6 py-4 border-t border-gray-200 dark:border-gray-800 flex gap-3 bg-gray-50 dark:bg-gray-800"},ln=["disabled"],dn={key:0},cn={key:1},un=He({__name:"ModalEditarCita",props:{isOpen:{type:Boolean},citaId:{}},emits:["close","actualizado"],setup(E,{emit:B}){const m=E,O=B,b=Et(),{actualizarCita:D,getCitasPorDia:M}=Ft(),A=V(null),H=V(!1),d=V(!1),x=V(!1),y=V({fecha_cita:"",hora_inicio:"",hora_fin:"",duracion:60,modalidad:"presencial",estado:"pendiente",observaciones:""}),q=S(()=>y.value.fecha_cita?new Date(y.value.fecha_cita+"T00:00:00").toLocaleDateString("es-ES",{weekday:"long",day:"numeric",month:"long",year:"numeric"}):""),k=S(()=>{const i=new Date,p=[],v=j=>j.toISOString().split("T")[0];p.push({label:"Hoy",fecha:v(i)});const Z=new Date(i);Z.setDate(Z.getDate()+1),p.push({label:"Mañana",fecha:v(Z)});const ae=["Lun","Mar","Mié","Jue","Vie"];let P=new Date(i),a=0;for(;a<5;){P.setDate(P.getDate()+1);const j=P.getDay();j>=1&&j<=5&&(p.push({label:`${ae[j-1]} ${P.getDate()}`,fecha:v(P)}),a++)}return p}),_=["08:00","08:30","09:00","09:30","10:00","10:30","11:00","11:30","12:00","12:30","13:00","13:30","14:00","14:30","15:00","15:30","16:00","16:30","17:00","17:30","18:00","18:30","19:00","19:30","20:00","20:30","21:00","21:30","22:00"],C=async()=>{if(console.log("🔍 [ModalEditarCita] Cargando cita con ID:",m.citaId),!m.citaId){console.warn("⚠️ [ModalEditarCita] No hay citaId proporcionado");return}try{H.value=!0;const{data:i,error:p}=await b.from("citas").select(`
        *,
        paciente:pacientes!citas_paciente_id_fkey (
          id,
          nombre_completo,
          email,
          telefono
        )
      `).eq("id",m.citaId).single();if(p)throw console.error("❌ [ModalEditarCita] Error en query:",p),p;console.log("✅ [ModalEditarCita] Cita cargada:",i),i&&(A.value=i,y.value={fecha_cita:i.fecha_cita,hora_inicio:i.hora_inicio?.substring(0,5)||"",hora_fin:i.hora_fin?.substring(0,5)||"",duracion:i.duracion||60,modalidad:i.modalidad||"presencial",estado:i.estado||"pendiente",observaciones:i.observaciones||""},console.log("📝 [ModalEditarCita] Formulario llenado:",y.value))}catch(i){console.error("💥 [ModalEditarCita] Error al cargar cita:",i)}finally{H.value=!1}},n=async()=>{if(!y.value.fecha_cita||!y.value.hora_inicio||!y.value.hora_fin){x.value=!1;return}try{const p=(await M(y.value.fecha_cita)).filter(ae=>ae.estado!=="cancelada"&&ae.id!==m.citaId),v=y.value.hora_inicio,Z=y.value.hora_fin;x.value=p.some(ae=>{const P=ae.hora_inicio?.substring(0,5),a=ae.hora_fin?.substring(0,5),j=h(v),oe=h(Z),U=h(P),ee=h(a);return j>=U&&j<ee||oe>U&&oe<=ee||j<=U&&oe>=ee})}catch(i){console.error("Error al verificar conflicto:",i),x.value=!1}},h=i=>{if(!i||!i.includes(":"))return 0;const[p,v]=i.split(":").map(Number);return(p||0)*60+(v||0)};ye(()=>y.value.hora_inicio,i=>{if(i&&y.value.duracion){const[p,v]=i.split(":").map(Number),Z=(p||0)*60+(v||0)+y.value.duracion,ae=Math.floor(Z/60),P=Z%60;y.value.hora_fin=`${String(ae).padStart(2,"0")}:${String(P).padStart(2,"0")}`}}),ye(()=>y.value.duracion,i=>{if(y.value.hora_inicio&&i){const[p,v]=y.value.hora_inicio.split(":").map(Number),Z=(p||0)*60+(v||0)+i,ae=Math.floor(Z/60),P=Z%60;y.value.hora_fin=`${String(ae).padStart(2,"0")}:${String(P).padStart(2,"0")}`}}),ye([()=>y.value.fecha_cita,()=>y.value.hora_inicio,()=>y.value.hora_fin],()=>{n()});const u=async()=>{if(m.citaId&&(await n(),!x.value))try{d.value=!0,(await D(m.citaId,{fecha_cita:y.value.fecha_cita,hora_inicio:y.value.hora_inicio,hora_fin:y.value.hora_fin,modalidad:y.value.modalidad,estado:y.value.estado,observaciones:y.value.observaciones})).success&&(O("actualizado"),O("close"))}catch(i){console.error("Error al actualizar cita:",i)}finally{d.value=!1}},g=()=>{O("close")};return ye(()=>m.isOpen,i=>{console.log("👁️ [ModalEditarCita] Modal abierto:",i,"citaId:",m.citaId),i&&m.citaId&&C()}),ye(()=>m.citaId,i=>{console.log("🔄 [ModalEditarCita] citaId cambió a:",i),m.isOpen&&i&&C()}),(i,p)=>(o(),de(et,{to:"body"},[E.isOpen?(o(),s("div",{key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",onClick:te(g,["self"])},[e("div",Br,[e("div",Ir,[e("div",null,[p[5]||(p[5]=e("h2",{class:"text-2xl font-bold text-gray-900 dark:text-white"},"✏️ Editar Cita",-1)),A.value?(o(),s("p",Tr,l(A.value.paciente?.nombre_completo||A.value.paciente_nombre),1)):$("",!0)]),e("button",{onClick:g,class:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors","aria-label":"Cerrar"},[...p[6]||(p[6]=[e("svg",{class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),H.value?(o(),s("div",zr,[...p[7]||(p[7]=[e("div",{class:"w-12 h-12 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin mb-4"},null,-1),e("p",{class:"text-gray-600 dark:text-gray-400"},"Cargando...",-1)])])):A.value?(o(),s("form",{key:1,onSubmit:te(u,["prevent"]),class:"px-6 py-4 overflow-y-auto max-h-[calc(90vh-200px)]"},[e("div",Rr,[e("div",null,[p[8]||(p[8]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"}," 📅 Fecha ",-1)),e("div",qr,[K(e("input",{"onUpdate:modelValue":p[0]||(p[0]=v=>y.value.fecha_cita=v),type:"date",required:"",class:"w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-purple-500 dark:bg-gray-800 dark:text-white cursor-pointer"},null,512),[[re,y.value.fecha_cita]]),e("div",Nr,[(o(!0),s(Q,null,J(k.value,(v,Z)=>(o(),s("button",{key:Z,type:"button",onClick:ae=>v.fecha&&(y.value.fecha_cita=v.fecha),class:F(["text-xs px-3 py-1.5 rounded-lg border transition-all",y.value.fecha_cita===v.fecha?"bg-purple-600 text-white border-purple-600 font-semibold":"bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:border-purple-500 hover:bg-purple-50 dark:hover:bg-purple-900/20"])},l(v.label),11,Or))),128))]),e("p",Ur,l(q.value),1)])]),e("div",Lr,[e("div",Hr,[p[10]||(p[10]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"}," 🕐 Hora Inicio ",-1)),e("div",Gr,[e("div",Kr,[(o(),s(Q,null,J(_,v=>e("button",{key:v,type:"button",onClick:Z=>y.value.hora_inicio=v,class:F(["px-3 py-2 text-sm font-medium rounded-lg transition-all border-2",y.value.hora_inicio===v?"bg-purple-600 text-white border-purple-600 shadow-md transform scale-105":"bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border-gray-200 dark:border-gray-600 hover:border-purple-500 hover:bg-purple-50 dark:hover:bg-purple-900/20 hover:shadow"])},l(v),11,Qr)),64))]),e("details",Zr,[p[9]||(p[9]=e("summary",{class:"cursor-pointer text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 select-none flex items-center gap-1"},[e("span",null,"⌨️"),e("span",null,"Ingresar hora manualmente")],-1)),e("div",Jr,[K(e("input",{"onUpdate:modelValue":p[1]||(p[1]=v=>y.value.hora_inicio=v),type:"time",required:"",step:"1800",class:"w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-purple-500 dark:bg-gray-800 dark:text-white"},null,512),[[re,y.value.hora_inicio]])])])])]),e("div",null,[p[12]||(p[12]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"}," ⏱️ Duración (min) ",-1)),K(e("select",{"onUpdate:modelValue":p[2]||(p[2]=v=>y.value.duracion=v),class:"w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-purple-500 dark:bg-gray-800 dark:text-white"},[...p[11]||(p[11]=[e("option",{value:30},"30 min",-1),e("option",{value:45},"45 min",-1),e("option",{value:60},"60 min",-1),e("option",{value:90},"90 min",-1)])],512),[[Oe,y.value.duracion]])]),e("div",null,[p[13]||(p[13]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"}," 🕑 Hora Fin ",-1)),K(e("input",{"onUpdate:modelValue":p[3]||(p[3]=v=>y.value.hora_fin=v),type:"time",required:"",readonly:"",step:"1800",class:"w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800 dark:text-white"},null,512),[[re,y.value.hora_fin]])])]),x.value?(o(),s("div",Xr,[...p[14]||(p[14]=[e("div",{class:"flex items-start gap-3"},[e("span",{class:"text-2xl"},"⚠️"),e("div",null,[e("div",{class:"font-semibold text-yellow-800 dark:text-yellow-300 mb-1"}," Conflicto de Horario "),e("div",{class:"text-sm text-yellow-700 dark:text-yellow-400"}," Ya existe otra cita en este horario. Por favor, selecciona otro horario. ")])],-1)])])):$("",!0),e("div",null,[p[15]||(p[15]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"}," 💻 Modalidad ",-1)),e("div",Wr,[(o(),s(Q,null,J([{valor:"presencial",icono:"🏥",nombre:"Presencial"},{valor:"online",icono:"💻",nombre:"Online"},{valor:"telefonica",icono:"📞",nombre:"Teléfono"}],v=>e("button",{key:v.valor,type:"button",onClick:Z=>y.value.modalidad=v.valor,class:F(["p-3 border-2 rounded-lg transition-all",y.value.modalidad===v.valor?"border-purple-600 bg-purple-50 dark:bg-purple-900/20":"border-gray-300 dark:border-gray-700 hover:border-purple-400"])},[e("div",en,l(v.icono),1),e("div",tn,l(v.nombre),1)],10,Yr)),64))])]),e("div",null,[p[16]||(p[16]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"}," 📊 Estado ",-1)),e("div",an,[(o(),s(Q,null,J([{valor:"pendiente",icono:"⏳",nombre:"Pendiente"},{valor:"confirmada",icono:"✅",nombre:"Confirmada"},{valor:"realizada",icono:"✓",nombre:"Realizada"},{valor:"cancelada",icono:"❌",nombre:"Cancelada"}],v=>e("button",{key:v.valor,type:"button",onClick:Z=>y.value.estado=v.valor,class:F(["p-2 border-2 rounded-lg transition-all",y.value.estado===v.valor?"border-purple-600 bg-purple-50 dark:bg-purple-900/20":"border-gray-300 dark:border-gray-700 hover:border-purple-400"])},[e("div",sn,l(v.icono),1),e("div",rn,l(v.nombre),1)],10,on)),64))])]),e("div",null,[p[17]||(p[17]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"}," 📝 Observaciones ",-1)),K(e("textarea",{"onUpdate:modelValue":p[4]||(p[4]=v=>y.value.observaciones=v),rows:"3",placeholder:"Notas adicionales sobre la cita...",class:"w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-purple-500 dark:bg-gray-800 dark:text-white"},null,512),[[re,y.value.observaciones]])])])],32)):$("",!0),e("div",nn,[e("button",{onClick:g,type:"button",class:"flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors font-medium"}," Cancelar "),e("button",{onClick:u,disabled:d.value||x.value,class:F(["flex-1 px-4 py-2 rounded-lg font-medium transition-colors",d.value||x.value?"bg-gray-400 dark:bg-gray-600 text-gray-200 cursor-not-allowed":"bg-purple-600 hover:bg-purple-700 text-white"])},[d.value?(o(),s("span",dn,"Guardando...")):(o(),s("span",cn,"💾 Guardar Cambios"))],10,ln)])])])):$("",!0)]))}}),pn=Object.assign(ze(un,[["__scopeId","data-v-e8361a38"]]),{__name:"ModalEditarCita"}),mn={class:"fixed bottom-4 right-4 z-50 flex flex-col gap-3 max-w-sm w-full pointer-events-none",role:"region","aria-live":"polite","aria-label":"Notificaciones"},bn={class:"flex-shrink-0"},gn={class:"text-sm font-medium flex-1"},vn=["onClick","aria-label"],fn={__name:"ToastContainer",setup(E){const{toasts:B,removeToast:m}=Ge(),O=b=>{const D={success:"border-green-200 bg-green-50 text-green-800",error:"border-red-200 bg-red-50 text-red-800",warning:"border-amber-200 bg-amber-50 text-amber-800",info:"border-blue-200 bg-blue-50 text-blue-800"};return D[b]||D.info};return(b,D)=>(o(),s("div",mn,[w(Yt,{name:"toast"},{default:Me(()=>[(o(!0),s(Q,null,J(t(B),M=>(o(),s("div",{key:M.id,class:F(["pointer-events-auto bg-white rounded-lg shadow-lg border p-4 flex items-start gap-3 transition-all duration-300",O(M.type)]),role:"alert"},[e("div",bn,[M.type==="success"?(o(),de(t(Pe),{key:0,class:"w-5 h-5","aria-hidden":"true"})):M.type==="error"?(o(),de(t(Te),{key:1,class:"w-5 h-5","aria-hidden":"true"})):M.type==="warning"?(o(),de(t(je),{key:2,class:"w-5 h-5","aria-hidden":"true"})):(o(),de(t(ut),{key:3,class:"w-5 h-5","aria-hidden":"true"}))]),e("p",gn,l(M.message),1),e("button",{onClick:A=>t(m)(M.id),class:"min-h-[44px] min-w-[44px] p-2 -mr-2 -mt-2 hover:bg-gray-100 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-gray-300","aria-label":`Cerrar notificación: ${M.message}`},[w(t(Re),{class:"w-4 h-4","aria-hidden":"true"})],8,vn)],2))),128))]),_:1})]))}},xn=ze(fn,[["__scopeId","data-v-4b6dd325"]]),hn={class:"mb-4"},yn={key:0},_n={class:"inline-block"},wn={class:"min-h-[44px] px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-600/90 transition-all font-medium shadow-sm hover:shadow-md cursor-pointer inline-flex items-center gap-2"},$n=["accept","aria-label"],kn={class:"text-xs text-gray-400 mt-4"},Cn={class:"text-xs text-gray-400"},En={key:1,class:"flex items-center justify-center gap-4"},Dn={class:"text-left flex-1"},Sn={class:"text-sm font-semibold text-cafe"},Pn={class:"text-xs text-gray-500"},Fn={key:2,class:"mt-4 p-3 bg-red-100 border border-red-300 rounded-lg"},Mn={class:"text-sm text-red-800 font-medium"},An=He({__name:"FileDropzone",props:{accept:{default:".csv,.xlsx,.xls"},maxSize:{default:10*1024*1024},supportedFormats:{default:"CSV, XLSX"},ariaLabel:{default:"Seleccionar archivo para subir"}},emits:["file-selected","file-removed","error"],setup(E,{expose:B,emit:m}){const O=E,b=m,D=V(null),M=V(!1),A=V(""),H=S(()=>!!A.value),d=S(()=>Math.round(O.maxSize/(1024*1024))),x=h=>{if(A.value="",h.size>O.maxSize)return A.value=`El archivo es demasiado grande. Máximo permitido: ${d.value}MB`,b("error",A.value),!1;const u=h.name.split(".").pop()?.toLowerCase(),g=O.accept.split(",").map(i=>i.trim().replace(".",""));return!u||!g.includes(u)?(A.value=`Formato de archivo no válido. Solo se permiten: ${O.supportedFormats}`,b("error",A.value),!1):!0},y=h=>{const u=h.target,g=u.files?.[0];g&&x(g)&&(D.value=g,b("file-selected",g)),u.value=""},q=h=>{M.value=!0},k=h=>{M.value=!1},_=h=>{M.value=!1;const u=h.dataTransfer?.files[0];u&&x(u)&&(D.value=u,b("file-selected",u))},C=()=>{D.value=null,A.value="",b("file-removed")},n=h=>{if(h===0)return"0 Bytes";const u=1024,g=["Bytes","KB","MB","GB"],i=Math.floor(Math.log(h)/Math.log(u));return Math.round(h/Math.pow(u,i)*100)/100+" "+g[i]};return B({removeFile:C}),(h,u)=>(o(),s("div",{onDragover:te(q,["prevent"]),onDragleave:k,onDrop:te(_,["prevent"]),class:F(["relative border-2 border-dashed rounded-xl p-8 transition-all duration-200 text-center",[t(M)?"border-purple-600 bg-purple-50":"border-gray-300 bg-gray-50",t(H)?"border-red-400 bg-red-50":"",t(D)?"border-green-400 bg-green-50":""]])},[e("div",hn,[t(D)?(o(),de(t(Le),{key:1,class:"w-12 h-12 mx-auto text-green-600","aria-hidden":"true"})):(o(),de(t(ct),{key:0,class:F(["w-12 h-12 mx-auto",t(M)?"text-purple-600":"text-gray-400"]),"aria-hidden":"true"},null,8,["class"]))]),t(D)?(o(),s("div",En,[e("div",Dn,[e("p",Sn,l(t(D).name),1),e("p",Pn,l(n(t(D).size)),1)]),e("button",{onClick:C,class:"min-h-[44px] min-w-[44px] p-2 text-red-600 hover:bg-red-100 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-red-300","aria-label":"Eliminar archivo"},[w(t(Re),{class:"w-6 h-6","aria-hidden":"true"})])])):(o(),s("div",yn,[u[1]||(u[1]=e("p",{class:"text-lg font-medium text-cafe mb-2"}," Arrastra tu archivo aquí ",-1)),u[2]||(u[2]=e("p",{class:"text-sm text-gray-500 mb-4"}," o haz clic para seleccionar ",-1)),e("label",_n,[e("span",wn,[w(t(Ma),{class:"w-5 h-5","aria-hidden":"true"}),u[0]||(u[0]=e("span",null,"Seleccionar archivo",-1))]),e("input",{type:"file",accept:E.accept,onChange:y,class:"hidden","aria-label":E.ariaLabel},null,40,$n)]),e("p",kn,l(E.supportedFormats),1),e("p",Cn," Tamaño máximo: "+l(t(d))+"MB ",1)])),t(A)?(o(),s("div",Fn,[e("p",Mn,l(t(A)),1)])):$("",!0)],34))}}),jn=Object.assign(An,{__name:"SharedFileDropzone"}),Vn={class:"space-y-6"},Bn={class:"bg-blue-50 border border-blue-200 rounded-lg p-4"},In={class:"flex gap-3"},Tn={class:"overflow-x-auto border border-gray-200 rounded-lg"},zn={class:"w-full text-sm"},Rn={class:"divide-y divide-gray-200"},qn={class:"px-4 py-3"},Nn={class:"font-medium text-gray-900"},On={class:"px-4 py-3"},Un={class:"flex flex-wrap gap-1 max-w-xs"},Ln=["title"],Hn={class:"px-4 py-3"},Gn=["value","onChange"],Kn={label:"Campos obligatorios"},Qn=["value","disabled"],Zn={label:"Contacto"},Jn=["value","disabled"],Xn={label:"Tratamiento"},Wn=["value","disabled"],Yn={label:"Otros campos"},el=["value","disabled"],tl={class:"px-4 py-3 text-center"},al={key:0,class:"inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium"},ol={key:1,class:"inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-medium"},sl={key:2,class:"inline-flex items-center gap-1 px-2 py-1 bg-gray-100 text-gray-500 rounded-full text-xs"},rl={key:0,class:"bg-red-50 border border-red-200 rounded-lg p-4"},nl={class:"flex gap-3"},ll={class:"list-disc list-inside text-red-800 space-y-1 text-sm"},il={key:1,class:"bg-amber-50 border border-amber-200 rounded-lg p-4"},dl={class:"flex gap-3"},cl={class:"list-disc list-inside text-amber-800 space-y-1 text-sm"},ul={key:2,class:"space-y-3"},pl={class:"font-semibold text-gray-900 flex items-center gap-2"},ml={class:"overflow-x-auto border border-gray-200 rounded-lg"},bl={class:"w-full text-sm"},gl={class:"bg-purple-50"},vl={class:"divide-y divide-gray-100"},fl={class:"text-xs text-gray-500"},xl=He({__name:"ColumnMappingTable",props:{detectedColumns:{},mappings:{},validation:{}},emits:["update:mapping"],setup(E,{emit:B}){const m=E,O=B,b=[{field:"nombre_completo",label:"Nombre Completo"},{field:"email",label:"Email"},{field:"telefono",label:"Teléfono"}],D=[{field:"documento_identidad",label:"Documento de Identidad"},{field:"fecha_nacimiento",label:"Fecha de Nacimiento"},{field:"direccion",label:"Dirección"},{field:"contacto_emergencia",label:"Contacto de Emergencia"}],M=[{field:"area_de_acompanamiento",label:"Área de Acompañamiento"},{field:"frecuencia",label:"Frecuencia de Sesiones"},{field:"activo",label:"Estado (Activo/Inactivo)"},{field:"derivacion",label:"Derivación"},{field:"medicacion",label:"Medicación"},{field:"orientacion_diagnostica",label:"Orientación Diagnóstica"},{field:"inicio_tratamiento",label:"Inicio del Tratamiento"}],A=[{field:"precio_sesion",label:"Precio por Sesión"},{field:"comision",label:"Comisión"},{field:"notas",label:"Notas / Observaciones"}],H=[...b,...D,...M,...A],d=n=>m.mappings.find(u=>u.sourceColumn===n)?.targetField||"",x=(n,h)=>m.mappings.some(u=>u.targetField===n&&u.sourceColumn!==h),y=n=>b.some(h=>h.field===n),q=n=>H.find(h=>h.field===n)?.label||n,k=(n,h)=>{O("update:mapping",n,h)},_=S(()=>m.mappings.filter(n=>n.targetField).map(n=>n.targetField)),C=S(()=>{if(!m.detectedColumns.length||!_.value.length)return[];const n=Math.min(m.detectedColumns[0]?.sampleValues?.length||0,3),h=[];for(let u=0;u<n;u++){const g={};for(const i of m.mappings)if(i.targetField){const p=m.detectedColumns.find(v=>v.name===i.sourceColumn);g[i.targetField]=p?.sampleValues?.[u]||""}Object.keys(g).length>0&&h.push(g)}return h});return(n,h)=>(o(),s("div",Vn,[e("div",Bn,[e("div",In,[w(t(ut),{class:"w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"}),h[0]||(h[0]=e("div",null,[e("p",{class:"font-semibold text-blue-900 mb-1"}," Relaciona las columnas de tu archivo con los campos de Teraplí "),e("p",{class:"text-sm text-blue-800"}," Hemos detectado automáticamente algunos campos. Revisa y ajusta según necesites. ")],-1))])]),e("div",Tn,[e("table",zn,[h[4]||(h[4]=e("thead",{class:"bg-gray-50"},[e("tr",null,[e("th",{class:"px-4 py-3 text-left font-semibold text-gray-700"}," Columna en tu archivo "),e("th",{class:"px-4 py-3 text-left font-semibold text-gray-700"}," Valores de ejemplo "),e("th",{class:"px-4 py-3 text-left font-semibold text-gray-700"}," Campo Teraplí "),e("th",{class:"px-4 py-3 text-center font-semibold text-gray-700 w-24"}," Estado ")])],-1)),e("tbody",Rn,[(o(!0),s(Q,null,J(E.detectedColumns,u=>(o(),s("tr",{key:u.name,class:"hover:bg-gray-50"},[e("td",qn,[e("span",Nn,l(u.name),1)]),e("td",On,[e("div",Un,[(o(!0),s(Q,null,J(u.sampleValues.slice(0,3),(g,i)=>(o(),s("span",{key:i,class:"inline-block px-2 py-0.5 bg-gray-100 text-gray-600 rounded text-xs truncate max-w-[120px]",title:g},l(g||"(vacío)"),9,Ln))),128))])]),e("td",Hn,[e("select",{value:d(u.name),onChange:g=>k(u.name,g.target.value),class:F(["w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500",{"border-green-400 bg-green-50":d(u.name)&&y(d(u.name)),"border-blue-300 bg-blue-50":d(u.name)&&!y(d(u.name))}])},[h[1]||(h[1]=e("option",{value:""},"-- No importar --",-1)),e("optgroup",Kn,[(o(),s(Q,null,J(b,g=>e("option",{key:g.field,value:g.field,disabled:x(g.field,u.name)},l(g.label)+" "+l(x(g.field,u.name)?"(ya usado)":"*"),9,Qn)),64))]),e("optgroup",Zn,[(o(),s(Q,null,J(D,g=>e("option",{key:g.field,value:g.field,disabled:x(g.field,u.name)},l(g.label)+" "+l(x(g.field,u.name)?"(ya usado)":""),9,Jn)),64))]),e("optgroup",Xn,[(o(),s(Q,null,J(M,g=>e("option",{key:g.field,value:g.field,disabled:x(g.field,u.name)},l(g.label)+" "+l(x(g.field,u.name)?"(ya usado)":""),9,Wn)),64))]),e("optgroup",Yn,[(o(),s(Q,null,J(A,g=>e("option",{key:g.field,value:g.field,disabled:x(g.field,u.name)},l(g.label)+" "+l(x(g.field,u.name)?"(ya usado)":""),9,el)),64))])],42,Gn)]),e("td",tl,[d(u.name)&&y(d(u.name))?(o(),s("span",al,[w(t(Pe),{class:"w-3.5 h-3.5"}),h[2]||(h[2]=R(" Obligatorio ",-1))])):d(u.name)?(o(),s("span",ol,[w(t(Pe),{class:"w-3.5 h-3.5"}),h[3]||(h[3]=R(" Opcional ",-1))])):(o(),s("span",sl," No importar "))])]))),128))])])]),E.validation?.errors?.length?(o(),s("div",rl,[e("div",nl,[w(t(je),{class:"w-5 h-5 text-red-600 flex-shrink-0 mt-0.5"}),e("div",null,[h[5]||(h[5]=e("p",{class:"font-semibold text-red-900 mb-2"}," Errores que impiden la importación: ",-1)),e("ul",ll,[(o(!0),s(Q,null,J(E.validation.errors,(u,g)=>(o(),s("li",{key:g},l(u),1))),128))])])])])):$("",!0),E.validation?.warnings?.length&&!E.validation?.errors?.length?(o(),s("div",il,[e("div",dl,[w(t(Te),{class:"w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5"}),e("div",null,[h[6]||(h[6]=e("p",{class:"font-semibold text-amber-900 mb-2"}," Advertencias (puedes continuar): ",-1)),e("ul",cl,[(o(!0),s(Q,null,J(E.validation.warnings,(u,g)=>(o(),s("li",{key:g},l(u),1))),128))])])])])):$("",!0),t(C).length>0?(o(),s("div",ul,[e("h4",pl,[w(t(St),{class:"w-5 h-5 text-purple-600"}),h[7]||(h[7]=R(" Vista previa con el mapeo aplicado ",-1))]),e("div",ml,[e("table",bl,[e("thead",gl,[e("tr",null,[(o(!0),s(Q,null,J(t(_),u=>(o(),s("th",{key:u,class:"px-3 py-2 text-left font-medium text-purple-800 whitespace-nowrap"},l(q(u)),1))),128))])]),e("tbody",vl,[(o(!0),s(Q,null,J(t(C),(u,g)=>(o(),s("tr",{key:g,class:"hover:bg-gray-50"},[(o(!0),s(Q,null,J(t(_),i=>(o(),s("td",{key:i,class:"px-3 py-2 text-gray-700 whitespace-nowrap"},l(u[i]||"—"),1))),128))]))),128))])])]),e("p",fl," Mostrando las primeras "+l(t(C).length)+" fila"+l(t(C).length!==1?"s":"")+" de tu archivo ",1)])):$("",!0)]))}}),hl=Object.assign(xl,{__name:"PatientsColumnMappingTable"});function yl(){const E=V(null),B=V([]),m=V(null),O=V(null),b=V(!1),D=V(!1),M=V(!1),A=V(null),H=async n=>{b.value=!0,A.value=null;try{const h=new FormData;h.append("file",n);const u=await fetch("/api/patients/import/detect-columns",{method:"POST",body:h});if(!u.ok){const i=await u.json();throw new Error(i.statusMessage||"Error al detectar columnas")}const g=await u.json();if(!g.success||!g.config)throw new Error("Respuesta inválida del servidor");return E.value=g.config,B.value=g.config.mappings||[],await x(),!0}catch(h){return A.value=h.message||"Error al detectar columnas",console.error("Error en detectColumns:",h),!1}finally{b.value=!1}},d=(n,h)=>{const u=B.value.findIndex(g=>g.sourceColumn===n);u>=0?B.value[u]={sourceColumn:n,targetField:h}:B.value.push({sourceColumn:n,targetField:h}),x()},x=async()=>{if(!E.value)return A.value="No hay configuración de importación",!1;D.value=!0,A.value=null;try{const n=await fetch("/api/patients/import/validate-mapping",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({configId:E.value.id,mappings:B.value})});if(!n.ok){const u=await n.json();throw new Error(u.statusMessage||"Error al validar mapeo")}const h=await n.json();return m.value=h.validation,h.validation?.isValid||!1}catch(n){return A.value=n.message||"Error al validar mapeo",console.error("Error en validateMapping:",n),!1}finally{D.value=!1}},y=async(n,h)=>{if(!E.value)return A.value="No hay configuración de importación",!1;if(!m.value?.isValid)return A.value="El mapeo no es válido",!1;M.value=!0,A.value=null;try{const u=new FormData;u.append("file",n),u.append("configId",E.value.id),u.append("action",h),u.append("mappings",JSON.stringify(B.value));const g=await fetch("/api/patients/import/execute",{method:"POST",body:u});if(!g.ok){const p=await g.json();throw new Error(p.statusMessage||"Error al importar pacientes")}const i=await g.json();return O.value=i.results,i.success}catch(u){return A.value=u.message||"Error al importar pacientes",console.error("Error en executeImport:",u),!1}finally{M.value=!1}},q=()=>{E.value=null,B.value=[],m.value=null,O.value=null,b.value=!1,D.value=!1,M.value=!1,A.value=null},k=n=>B.value.find(u=>u.sourceColumn===n)?.targetField||"",_=()=>{if(!E.value?.detectedColumns)return[];const n=Math.min(E.value.detectedColumns[0]?.sampleValues?.length||0,3),h=[];for(let u=0;u<n;u++){const g={};for(const i of B.value)if(i.targetField){const p=E.value.detectedColumns.find(v=>v.name===i.sourceColumn);g[i.targetField]=p?.sampleValues?.[u]||""}h.push(g)}return h},C=S(()=>{const n=new Set(B.value.map(g=>g.targetField).filter(g=>g!=="")),h=n.has("nombre_completo"),u=n.has("email")||n.has("telefono");return h&&u});return{config:E,mappings:B,validation:m,importResult:O,detecting:b,validating:D,importing:M,error:A,detectColumns:H,updateMapping:d,validateMapping:x,executeImport:y,reset:q,getMappedField:k,getPreviewData:_,hasRequiredFields:C}}const _l={class:"bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col"},wl={class:"px-6 py-4 border-b border-gray-200 flex items-center justify-between"},$l={class:"text-sm text-gray-500 mt-1"},kl={class:"px-6 py-3 bg-gray-50"},Cl={class:"flex items-center gap-2"},El={class:"flex justify-between mt-2 text-xs text-gray-500"},Dl={class:"flex-1 overflow-y-auto p-6"},Sl={key:0,class:"space-y-6"},Pl={class:"text-center"},Fl={class:"bg-green-50 border border-green-200 rounded-lg p-4 text-sm"},Ml={class:"flex gap-3"},Al={class:"bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm"},jl={class:"flex gap-3"},Vl={class:"flex gap-3 justify-center pt-2"},Bl=["disabled"],Il=["disabled"],Tl={key:1,class:"space-y-6"},zl={class:"text-center mb-6"},Rl={key:0,class:"bg-green-50 border border-green-200 rounded-lg p-4 text-sm"},ql={class:"flex gap-3"},Nl={class:"flex-1"},Ol={class:"text-green-800"},Ul={key:1,class:"bg-purple-50 border border-purple-200 rounded-lg p-6"},Ll={key:2,class:"bg-red-50 border border-red-200 rounded-lg p-4 text-sm"},Hl={class:"flex gap-3"},Gl={class:"text-red-800"},Kl={key:2,class:"space-y-6"},Ql={class:"text-center mb-6"},Zl={key:3,class:"space-y-6"},Jl={class:"text-center mb-6"},Xl={class:"bg-gray-50 border border-gray-200 rounded-lg p-4"},Wl={class:"flex flex-wrap gap-2"},Yl={key:0,class:"bg-amber-50 border border-amber-200 rounded-lg p-4"},ei={class:"flex gap-3"},ti={class:"text-sm text-amber-800 space-y-1"},ai={class:"bg-blue-50 border border-blue-200 rounded-lg p-4"},oi={class:"flex items-start gap-3 cursor-pointer"},si={key:1,class:"space-y-3"},ri={class:"overflow-x-auto border border-gray-200 rounded-lg"},ni={class:"w-full text-sm"},li={class:"bg-gray-50"},ii={class:"divide-y divide-gray-100"},di={key:4,class:"space-y-6"},ci={class:"text-center mb-6"},ui={class:"text-lg font-semibold text-cafe mb-2"},pi={class:"text-sm text-gray-600"},mi={key:0,class:"grid grid-cols-2 md:grid-cols-4 gap-4"},bi={class:"bg-gray-50 rounded-lg p-4 text-center"},gi={class:"text-2xl font-bold text-cafe"},vi={class:"bg-green-50 rounded-lg p-4 text-center"},fi={class:"text-2xl font-bold text-green-700"},xi={class:"bg-blue-50 rounded-lg p-4 text-center"},hi={class:"text-2xl font-bold text-blue-700"},yi={class:"bg-gray-100 rounded-lg p-4 text-center"},_i={class:"text-2xl font-bold text-gray-700"},wi={key:1,class:"bg-green-50 border border-green-200 rounded-lg p-4"},$i={class:"flex gap-3"},ki={key:2,class:"bg-amber-50 border border-amber-200 rounded-lg p-4"},Ci={class:"flex gap-3"},Ei={class:"flex-1"},Di={class:"font-semibold text-amber-900 mb-2"},Si={class:"max-h-40 overflow-y-auto space-y-2"},Pi={class:"font-medium text-amber-900"},Fi={class:"text-amber-700"},Mi={key:0,class:"text-xs text-amber-700 italic"},Ai={key:3,class:"bg-red-50 border border-red-200 rounded-lg p-4"},ji={class:"font-semibold text-red-900 mb-3 flex items-center gap-2"},Vi={class:"max-h-40 overflow-y-auto space-y-2"},Bi={class:"font-semibold"},Ii={class:"px-6 py-4 border-t border-gray-200 flex items-center justify-between bg-gray-50"},Ti=["disabled"],zi={key:1},Ri={class:"flex gap-3"},qi=["disabled"],Ni=["disabled"],Oi={key:0,class:"animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"},Ui=["disabled"],Li=["disabled"],Hi={key:0,class:"animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"},Gi=He({__name:"PatientsImportModal",props:{modelValue:{type:Boolean},existingPatients:{default:()=>[]}},emits:["update:modelValue","import-complete"],setup(E,{emit:B}){const m=B,O=Ge(),b=yl(),D=V(1),M=V(null),A=V(!1),H=V(!0),d=V(!1),x={nombre_completo:"Nombre Completo",email:"Email",telefono:"Teléfono",documento_identidad:"Documento",fecha_nacimiento:"Fecha Nac.",direccion:"Dirección",contacto_emergencia:"Contacto Emergencia",area_de_acompanamiento:"Área",frecuencia:"Frecuencia",activo:"Estado",derivacion:"Derivación",medicacion:"Medicación",orientacion_diagnostica:"Diagnóstico",inicio_tratamiento:"Inicio Trat.",precio_sesion:"Precio",comision:"Comisión",notas:"Notas"},y=P=>P?x[P]||P:"",q=S(()=>M.value!==null||b.config.value!==null||D.value>1),k=()=>{if(b.importing.value){O.warning("No se puede cerrar mientras se está importando");return}q.value&&D.value<5&&!confirm(`¿Estás seguro de que deseas cancelar?

Se perderá todo el progreso de la importación.
Tendrás que empezar de nuevo si cierras ahora.`)||(m("update:modelValue",!1),setTimeout(_,300))},_=()=>{D.value=1,M.value=null,A.value=!1,H.value=!0,d.value=!1,b.reset()},C=async P=>{try{A.value=!0;const a=await fetch(`/api/patients/template?format=${P}`);if(!a.ok)throw new Error("Error al descargar la plantilla");const j=await a.blob(),oe=URL.createObjectURL(j),U=document.createElement("a");U.href=oe,U.download=`plantilla_pacientes.${P}`,document.body.appendChild(U),U.click(),document.body.removeChild(U),URL.revokeObjectURL(oe),O.success(`Plantilla ${P.toUpperCase()} descargada`)}catch(a){O.error(a.message||"Error al descargar la plantilla")}finally{A.value=!1}},n=P=>{M.value=P,b.error.value=null,O.info("Archivo seleccionado correctamente")},h=()=>{M.value=null,b.reset()},u=P=>{O.error(P)},g=(P,a)=>{b.updateMapping(P,a)},i=()=>{D.value<5&&D.value++},p=()=>{D.value>1&&D.value--},v=async()=>{if(!M.value)return;await b.detectColumns(M.value)?(O.success("Columnas detectadas correctamente"),D.value=3):O.error(b.error.value||"Error al detectar columnas")},Z=async()=>{if(!M.value)return;const P=H.value?"update":"skip";if(await b.executeImport(M.value,P)){d.value=(b.importResult.value?.errors?.length||0)===0;const j=(b.importResult.value?.created||0)+(b.importResult.value?.updated||0);O.success(`${j} paciente${j!==1?"s":""} importado${j!==1?"s":""} correctamente`),D.value=5}else O.error(b.error.value||"Error al importar pacientes")},ae=()=>{m("import-complete"),k()};return(P,a)=>{const j=jn,oe=hl;return o(),de(et,{to:"body"},[w(Be,{name:"modal"},{default:Me(()=>[E.modelValue?(o(),s("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",onClick:te(k,["self"]),role:"dialog","aria-modal":"true","aria-labelledby":"import-modal-title"},[e("div",_l,[e("div",wl,[e("div",null,[a[3]||(a[3]=e("h2",{id:"import-modal-title",class:"text-2xl font-serif font-bold text-cafe"}," Importar Pacientes ",-1)),e("p",$l," Paso "+l(t(D))+" de 5 ",1)]),e("button",{onClick:k,class:"min-h-[44px] min-w-[44px] p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-gray-300","aria-label":"Cerrar modal"},[w(t(Re),{class:"w-6 h-6","aria-hidden":"true"})])]),e("div",kl,[e("div",Cl,[(o(),s(Q,null,J(5,U=>e("div",{key:U,class:F(["flex-1 h-2 rounded-full transition-all duration-300",U<=t(D)?"bg-purple-600":"bg-gray-200"])},null,2)),64))]),e("div",El,[e("span",{class:F({"text-purple-600 font-medium":t(D)===1})},"Info",2),e("span",{class:F({"text-purple-600 font-medium":t(D)===2})},"Subir",2),e("span",{class:F({"text-purple-600 font-medium":t(D)===3})},"Mapear",2),e("span",{class:F({"text-purple-600 font-medium":t(D)===4})},"Revisar",2),e("span",{class:F({"text-purple-600 font-medium":t(D)===5})},"Resultado",2)])]),e("div",Dl,[t(D)===1?(o(),s("div",Sl,[e("div",Pl,[w(t(Fa),{class:"w-16 h-16 mx-auto text-purple-600 mb-4","aria-hidden":"true"}),a[4]||(a[4]=e("h3",{class:"text-lg font-semibold text-cafe mb-2"}," Paso 1: Prepara tu archivo ",-1)),a[5]||(a[5]=e("p",{class:"text-sm text-gray-600 mb-2 max-w-md mx-auto"},[R(" Puedes usar "),e("strong",null,"cualquier Excel o CSV"),R(" con tus pacientes. El sistema detectará las columnas automáticamente. ")],-1))]),e("div",Fl,[e("div",Ml,[w(t(Pe),{class:"w-5 h-5 text-green-600 flex-shrink-0 mt-0.5","aria-hidden":"true"}),a[6]||(a[6]=e("div",null,[e("p",{class:"font-semibold text-green-900 mb-2"},"¿Ya tienes un Excel con pacientes?"),e("p",{class:"text-green-800"}," ¡Perfecto! Puedes subirlo directamente. En el siguiente paso podrás relacionar las columnas de tu archivo con los campos de Teraplí. ")],-1))])]),e("div",Al,[e("div",jl,[w(t(ut),{class:"w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5","aria-hidden":"true"}),a[7]||(a[7]=e("div",{class:"space-y-3"},[e("div",null,[e("p",{class:"font-semibold text-blue-900 mb-1"},"Formatos aceptados:"),e("p",{class:"text-blue-800"},"CSV (.csv) y Excel (.xlsx, .xls)"),e("p",{class:"text-xs text-blue-700 mt-1"},"Tamaño máximo: 10MB | Máximo 5,000 filas")]),e("div",null,[e("p",{class:"font-semibold text-blue-900 mb-1"},"Campos mínimos necesarios:"),e("ul",{class:"list-disc list-inside text-blue-800 space-y-1"},[e("li",null,[e("strong",null,"Nombre"),R(" del paciente (obligatorio)")]),e("li",null,[e("strong",null,"Email"),R(" o "),e("strong",null,"Teléfono"),R(" (al menos uno)")])])]),e("div",null,[e("p",{class:"font-semibold text-blue-900 mb-1"},"Campos adicionales soportados:"),e("p",{class:"text-blue-800 text-xs"}," Documento de identidad, Dirección, Fecha de nacimiento, Área de tratamiento, Frecuencia, Derivación, Medicación, Diagnóstico, Notas, Precio, y más... ")])],-1))])]),e("div",Vl,[e("button",{onClick:a[0]||(a[0]=U=>C("csv")),disabled:t(A),class:"min-h-[44px] px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all text-sm disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"},[w(t(Le),{class:"w-4 h-4","aria-hidden":"true"}),a[8]||(a[8]=e("span",null,"Descargar plantilla CSV",-1))],8,Bl),e("button",{onClick:a[1]||(a[1]=U=>C("xlsx")),disabled:t(A),class:"min-h-[44px] px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all text-sm disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"},[w(t(Le),{class:"w-4 h-4","aria-hidden":"true"}),a[9]||(a[9]=e("span",null,"Descargar plantilla Excel",-1))],8,Il)])])):$("",!0),t(D)===2?(o(),s("div",Tl,[e("div",zl,[w(t(ct),{class:"w-16 h-16 mx-auto text-purple-600 mb-4","aria-hidden":"true"}),a[10]||(a[10]=e("h3",{class:"text-lg font-semibold text-cafe mb-2"}," Paso 2: Sube tu archivo ",-1)),a[11]||(a[11]=e("p",{class:"text-sm text-gray-600 mb-1"}," Arrastra tu archivo o haz clic para seleccionarlo ",-1)),a[12]||(a[12]=e("p",{class:"text-xs text-gray-500"}," Detectaremos las columnas automáticamente ",-1))]),w(j,{onFileSelected:n,onFileRemoved:h,onError:u}),t(M)&&!t(b).detecting.value?(o(),s("div",Rl,[e("div",ql,[w(t(Pe),{class:"w-5 h-5 text-green-600 flex-shrink-0 mt-0.5","aria-hidden":"true"}),e("div",Nl,[a[13]||(a[13]=e("p",{class:"font-semibold text-green-900 mb-1"},"Archivo seleccionado correctamente",-1)),e("p",Ol,l(t(M).name),1),a[14]||(a[14]=e("p",{class:"text-xs text-green-700 mt-1"},' Haz clic en "Detectar columnas" para continuar ',-1))])])])):$("",!0),t(b).detecting.value?(o(),s("div",Ul,[...a[15]||(a[15]=[e("div",{class:"flex flex-col items-center justify-center gap-4"},[e("div",{class:"animate-spin w-12 h-12 border-4 border-purple-600 border-t-transparent rounded-full"}),e("div",{class:"text-center"},[e("p",{class:"text-purple-900 font-medium mb-1"},"Analizando archivo..."),e("p",{class:"text-sm text-purple-700"},"Detectando columnas y sugiriendo mapeo")])],-1)])])):$("",!0),t(b).error.value?(o(),s("div",Ll,[e("div",Hl,[w(t(je),{class:"w-5 h-5 text-red-600 flex-shrink-0 mt-0.5","aria-hidden":"true"}),e("div",null,[a[16]||(a[16]=e("p",{class:"font-semibold text-red-900 mb-1"},"Error al procesar archivo",-1)),e("p",Gl,l(t(b).error.value),1)])])])):$("",!0)])):$("",!0),t(D)===3?(o(),s("div",Kl,[e("div",Ql,[w(t(Da),{class:"w-16 h-16 mx-auto text-purple-600 mb-4","aria-hidden":"true"}),a[17]||(a[17]=e("h3",{class:"text-lg font-semibold text-cafe mb-2"}," Paso 3: Mapea las columnas ",-1)),a[18]||(a[18]=e("p",{class:"text-sm text-gray-600"}," Relaciona las columnas de tu archivo con los campos de Teraplí ",-1))]),w(oe,{"detected-columns":t(b).config.value?.detectedColumns||[],mappings:t(b).mappings.value,validation:t(b).validation.value,"onUpdate:mapping":g},null,8,["detected-columns","mappings","validation"])])):$("",!0),t(D)===4?(o(),s("div",Zl,[e("div",Jl,[w(t(Pa),{class:"w-16 h-16 mx-auto text-purple-600 mb-4","aria-hidden":"true"}),a[19]||(a[19]=e("h3",{class:"text-lg font-semibold text-cafe mb-2"}," Paso 4: Confirma la importación ",-1)),a[20]||(a[20]=e("p",{class:"text-sm text-gray-600"}," Revisa el resumen antes de importar ",-1))]),e("div",Xl,[a[21]||(a[21]=e("h4",{class:"font-semibold text-gray-900 mb-3"},"Campos que se importarán:",-1)),e("div",Wl,[(o(!0),s(Q,null,J(t(b).mappings.value.filter(U=>U.targetField),U=>(o(),s("span",{key:U.sourceColumn,class:"inline-flex items-center gap-1 px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm"},[w(t(Pe),{class:"w-4 h-4"}),R(" "+l(y(U.targetField)),1)]))),128))])]),t(b).validation.value?.warnings?.length?(o(),s("div",Yl,[e("div",ei,[w(t(Te),{class:"w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5","aria-hidden":"true"}),e("div",null,[a[22]||(a[22]=e("p",{class:"font-semibold text-amber-900 mb-2"},"Advertencias:",-1)),e("ul",ti,[(o(!0),s(Q,null,J(t(b).validation.value.warnings,(U,ee)=>(o(),s("li",{key:ee}," • "+l(U),1))),128))])])])])):$("",!0),e("div",ai,[e("label",oi,[K(e("input",{type:"checkbox","onUpdate:modelValue":a[2]||(a[2]=U=>De(H)?H.value=U:null),class:"mt-1 w-5 h-5 text-purple-600 border-gray-300 rounded focus:ring-2 focus:ring-purple-300 cursor-pointer"},null,512),[[Fe,t(H)]]),a[23]||(a[23]=e("div",{class:"flex-1"},[e("p",{class:"font-semibold text-blue-900 mb-1"}," Actualizar pacientes existentes "),e("p",{class:"text-sm text-blue-800"}," Si un paciente ya existe (mismo email o teléfono), actualizar sus datos con la información del archivo. "),e("p",{class:"text-xs text-blue-700 mt-1"}," Si no marcas esta opción, los pacientes duplicados se omitirán. ")],-1))])]),t(b).getPreviewData().length>0?(o(),s("div",si,[a[24]||(a[24]=e("h4",{class:"font-semibold text-gray-900"},"Vista previa de datos:",-1)),e("div",ri,[e("table",ni,[e("thead",li,[e("tr",null,[(o(!0),s(Q,null,J(t(b).mappings.value.filter(U=>U.targetField),U=>(o(),s("th",{key:U.targetField,class:"px-3 py-2 text-left font-medium text-gray-700 whitespace-nowrap"},l(y(U.targetField)),1))),128))])]),e("tbody",ii,[(o(!0),s(Q,null,J(t(b).getPreviewData(),(U,ee)=>(o(),s("tr",{key:ee},[(o(!0),s(Q,null,J(t(b).mappings.value.filter(se=>se.targetField),se=>(o(),s("td",{key:se.targetField,class:"px-3 py-2 text-gray-600 whitespace-nowrap"},l(U[se.targetField]||"—"),1))),128))]))),128))])])]),a[25]||(a[25]=e("p",{class:"text-xs text-gray-500"},"Vista previa de las primeras filas",-1))])):$("",!0)])):$("",!0),t(D)===5?(o(),s("div",di,[e("div",ci,[t(d)?(o(),de(t(Pe),{key:0,class:"w-16 h-16 mx-auto text-green-600 mb-4","aria-hidden":"true"})):(o(),de(t(Te),{key:1,class:"w-16 h-16 mx-auto text-amber-600 mb-4","aria-hidden":"true"})),e("h3",ui,l(t(d)?"Importación completada con éxito":"Importación completada con advertencias"),1),e("p",pi,l(t(d)?"Los pacientes se han importado correctamente":"La importación se completó pero algunos pacientes tienen perfil incompleto"),1)]),t(b).importResult.value?(o(),s("div",mi,[e("div",bi,[e("p",gi,l(t(b).importResult.value.total),1),a[26]||(a[26]=e("p",{class:"text-xs text-gray-600"},"Total",-1))]),e("div",vi,[e("p",fi,l(t(b).importResult.value.created),1),a[27]||(a[27]=e("p",{class:"text-xs text-gray-600"},"Creados",-1))]),e("div",xi,[e("p",hi,l(t(b).importResult.value.updated),1),a[28]||(a[28]=e("p",{class:"text-xs text-gray-600"},"Actualizados",-1))]),e("div",yi,[e("p",_i,l(t(b).importResult.value.skipped),1),a[29]||(a[29]=e("p",{class:"text-xs text-gray-600"},"Omitidos",-1))])])):$("",!0),t(d)?(o(),s("div",wi,[e("div",$i,[w(t(Pe),{class:"w-6 h-6 text-green-600 flex-shrink-0 mt-0.5","aria-hidden":"true"}),a[30]||(a[30]=e("div",{class:"flex-1"},[e("p",{class:"font-semibold text-green-900 mb-2"},"¡Importación exitosa!"),e("p",{class:"text-sm text-green-800"}," Los pacientes se han añadido a tu lista y ya puedes gestionar sus citas y tratamientos. ")],-1))])])):$("",!0),t(b).importResult.value?.incompleteProfiles?.length?(o(),s("div",ki,[e("div",Ci,[w(t(Te),{class:"w-6 h-6 text-amber-600 flex-shrink-0 mt-0.5","aria-hidden":"true"}),e("div",Ei,[e("p",Di,l(t(b).importResult.value.incompleteProfiles.length)+" paciente"+l(t(b).importResult.value.incompleteProfiles.length!==1?"s":"")+" con perfil incompleto ",1),a[31]||(a[31]=e("p",{class:"text-sm text-amber-800 mb-3"}," Los siguientes pacientes fueron importados pero les faltan datos importantes: ",-1)),e("div",Si,[(o(!0),s(Q,null,J(t(b).importResult.value.incompleteProfiles.slice(0,5),U=>(o(),s("div",{key:U.rowNumber,class:"bg-white border border-amber-200 rounded p-2 text-sm"},[e("span",Pi,l(U.nombre_completo),1),e("span",Fi," — Faltan: "+l(U.missingFields.join(", ")),1)]))),128)),t(b).importResult.value.incompleteProfiles.length>5?(o(),s("p",Mi," ... y "+l(t(b).importResult.value.incompleteProfiles.length-5)+" más ",1)):$("",!0)]),a[32]||(a[32]=e("p",{class:"text-xs text-amber-700 mt-3"}," 💡 Puedes completar esta información editando cada paciente desde la lista. ",-1))])])])):$("",!0),t(b).importResult.value?.errors?.length?(o(),s("div",Ai,[e("h4",ji,[w(t(je),{class:"w-5 h-5","aria-hidden":"true"}),R(" Errores durante la importación ("+l(t(b).importResult.value.errors.length)+") ",1)]),e("div",Vi,[(o(!0),s(Q,null,J(t(b).importResult.value.errors.slice(0,10),(U,ee)=>(o(),s("div",{key:ee,class:"bg-white border border-red-200 rounded p-2 text-sm text-red-800"},[e("span",Bi,"Fila "+l(U.row)+":",1),R(" "+l(U.error),1)]))),128))])])):$("",!0)])):$("",!0)]),e("div",Ii,[t(D)>1&&t(D)<5?(o(),s("button",{key:0,onClick:p,disabled:t(b).importing.value||t(b).detecting.value,class:"min-h-[44px] px-6 py-2.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-all font-medium disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-gray-300"}," Atrás ",8,Ti)):(o(),s("div",zi)),e("div",Ri,[t(D)<5?(o(),s("button",{key:0,onClick:k,disabled:t(b).importing.value,class:"min-h-[44px] px-6 py-2.5 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all font-medium disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-gray-300"}," Cancelar ",8,qi)):$("",!0),t(D)===1?(o(),s("button",{key:1,onClick:i,class:"min-h-[44px] px-6 py-2.5 bg-purple-600 text-white rounded-lg hover:bg-purple-600/90 transition-all font-medium shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-purple-300"}," Continuar ")):$("",!0),t(D)===2?(o(),s("button",{key:2,onClick:v,disabled:!t(M)||t(b).detecting.value,class:"min-h-[44px] px-6 py-2.5 bg-purple-600 text-white rounded-lg hover:bg-purple-600/90 transition-all font-medium shadow-sm hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-purple-300 flex items-center gap-2"},[t(b).detecting.value?(o(),s("div",Oi)):$("",!0),e("span",null,l(t(b).detecting.value?"Analizando...":"Detectar columnas"),1)],8,Ni)):$("",!0),t(D)===3?(o(),s("button",{key:3,onClick:i,disabled:!t(b).validation.value?.isValid,class:"min-h-[44px] px-6 py-2.5 bg-purple-600 text-white rounded-lg hover:bg-purple-600/90 transition-all font-medium shadow-sm hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-purple-300"}," Continuar ",8,Ui)):$("",!0),t(D)===4?(o(),s("button",{key:4,onClick:Z,disabled:t(b).importing.value,class:"min-h-[44px] px-6 py-2.5 bg-purple-600 text-white rounded-lg hover:bg-purple-600/90 transition-all font-medium shadow-sm hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-purple-300 flex items-center gap-2"},[t(b).importing.value?(o(),s("div",Hi)):$("",!0),e("span",null,l(t(b).importing.value?"Importando...":"Importar pacientes"),1)],8,Li)):$("",!0),t(D)===5?(o(),s("button",{key:5,onClick:ae,class:"min-h-[44px] px-6 py-2.5 bg-purple-600 text-white rounded-lg hover:bg-purple-600/90 transition-all font-medium shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-purple-300"}," Finalizar ")):$("",!0)])])])])):$("",!0)]),_:1})])}}}),Ki=Object.assign(ze(Gi,[["__scopeId","data-v-97261e0d"]]),{__name:"PatientsImportModal"}),Qi={class:"bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col"},Zi={class:"px-6 py-4 border-b border-gray-200 flex items-center justify-between"},Ji={class:"flex-1 overflow-y-auto p-6 space-y-6"},Xi={class:"flex gap-3"},Wi={class:"space-y-2"},Yi={class:"flex-1"},ed={class:"text-xs text-gray-600"},td={class:"flex-1"},ad={class:"text-xs text-gray-600"},od={class:"flex-1"},sd={class:"text-xs text-gray-600"},rd={class:"grid grid-cols-2 gap-2"},nd=["value"],ld={class:"text-sm text-cafe"},id={class:"px-6 py-4 border-t border-gray-200 flex items-center justify-between bg-gray-50"},dd=["disabled"],cd=["disabled"],ud={key:1},pd={key:2},md=He({__name:"PatientsExportModal",props:{modelValue:{type:Boolean},totalPatients:{},filteredCount:{},selectedCount:{default:0},hasFilters:{type:Boolean,default:!1},currentFilters:{default:()=>({})},selectedIds:{default:()=>[]}},emits:["update:modelValue"],setup(E,{emit:B}){const m=E,O=B,b=Ge(),D=V("csv"),M=V("all"),A=V(["nombre_completo","email","telefono","area_de_acompanamiento","frecuencia","activo"]),H=V(!1),d=[{value:"nombre_completo",label:"Nombre Completo"},{value:"email",label:"Email"},{value:"telefono",label:"Teléfono"},{value:"area_de_acompanamiento",label:"Área"},{value:"frecuencia",label:"Frecuencia"},{value:"activo",label:"Estado"},{value:"ultima_sesion",label:"Última Sesión"},{value:"proxima_sesion",label:"Próxima Sesión"},{value:"total_sesiones",label:"Total Sesiones"},{value:"created_at",label:"Fecha de Registro"}],x=()=>{H.value||O("update:modelValue",!1)},y=()=>{A.value.length===d.length?A.value=[]:A.value=d.map(k=>k.value)},q=async()=>{if(A.value.length===0){b.warning("Selecciona al menos un campo para exportar");return}try{H.value=!0;const k=new URLSearchParams({format:D.value,scope:M.value,fields:A.value.join(",")});M.value==="filtered"&&m.currentFilters&&k.append("filters",JSON.stringify(m.currentFilters)),M.value==="selected"&&m.selectedIds.length>0&&k.append("selectedIds",m.selectedIds.join(","));const _=await fetch(`/api/patients/export?${k.toString()}`);if(!_.ok){const u=await _.json();throw new Error(u.statusMessage||"Error al exportar pacientes")}const C=await _.blob(),n=URL.createObjectURL(C),h=document.createElement("a");h.href=n,h.download=`pacientes_${new Date().toISOString().split("T")[0]}.${D.value}`,document.body.appendChild(h),h.click(),document.body.removeChild(h),URL.revokeObjectURL(n),b.success("Pacientes exportados correctamente"),x()}catch(k){b.error(k.message||"Error al exportar pacientes")}finally{H.value=!1}};return ea(()=>{m.selectedCount>0?M.value="selected":m.hasFilters?M.value="filtered":M.value="all"}),(k,_)=>(o(),de(et,{to:"body"},[w(Be,{name:"modal"},{default:Me(()=>[E.modelValue?(o(),s("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",onClick:te(x,["self"]),role:"dialog","aria-modal":"true","aria-labelledby":"export-modal-title"},[e("div",Qi,[e("div",Zi,[_[6]||(_[6]=e("div",null,[e("h2",{id:"export-modal-title",class:"text-2xl font-serif font-bold text-cafe"}," Exportar Pacientes "),e("p",{class:"text-sm text-gray-500 mt-1"}," Selecciona las opciones de exportación ")],-1)),e("button",{onClick:x,class:"min-h-[44px] min-w-[44px] p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-gray-300","aria-label":"Cerrar modal"},[w(t(Re),{class:"w-6 h-6","aria-hidden":"true"})])]),e("div",Ji,[e("div",null,[_[9]||(_[9]=e("label",{class:"block text-sm font-semibold text-cafe mb-3"}," Formato de archivo ",-1)),e("div",Xi,[e("button",{onClick:_[0]||(_[0]=C=>D.value="csv"),class:F(["min-h-[44px] flex-1 px-4 py-3 rounded-lg border-2 transition-all font-medium flex items-center justify-center gap-2",t(D)==="csv"?"border-purple-600 bg-purple-50 text-purple-600":"border-gray-200 bg-white text-gray-600 hover:border-gray-300"])},[w(t(Le),{class:"w-5 h-5","aria-hidden":"true"}),_[7]||(_[7]=e("span",null,"CSV",-1))],2),e("button",{onClick:_[1]||(_[1]=C=>D.value="xlsx"),class:F(["min-h-[44px] flex-1 px-4 py-3 rounded-lg border-2 transition-all font-medium flex items-center justify-center gap-2",t(D)==="xlsx"?"border-purple-600 bg-purple-50 text-purple-600":"border-gray-200 bg-white text-gray-600 hover:border-gray-300"])},[w(t(Le),{class:"w-5 h-5","aria-hidden":"true"}),_[8]||(_[8]=e("span",null,"XLSX",-1))],2)])]),e("div",null,[_[13]||(_[13]=e("label",{class:"block text-sm font-semibold text-cafe mb-3"}," ¿Qué pacientes exportar? ",-1)),e("div",Wi,[e("label",{class:F(["flex items-center gap-3 p-3 border-2 rounded-lg cursor-pointer transition-all",t(M)==="all"?"border-purple-600 bg-purple-50":"border-gray-200 bg-white hover:border-gray-300"])},[K(e("input",{type:"radio","onUpdate:modelValue":_[2]||(_[2]=C=>De(M)?M.value=C:null),value:"all",class:"w-4 h-4 text-purple-600 border-gray-300 focus:ring-2 focus:ring-purple-300"},null,512),[[lt,t(M)]]),e("div",Yi,[_[10]||(_[10]=e("p",{class:"font-medium text-cafe"},"Todos los pacientes",-1)),e("p",ed,"Exportar todos los pacientes ("+l(E.totalPatients)+")",1)])],2),E.hasFilters?(o(),s("label",{key:0,class:F(["flex items-center gap-3 p-3 border-2 rounded-lg cursor-pointer transition-all",t(M)==="filtered"?"border-purple-600 bg-purple-50":"border-gray-200 bg-white hover:border-gray-300"])},[K(e("input",{type:"radio","onUpdate:modelValue":_[3]||(_[3]=C=>De(M)?M.value=C:null),value:"filtered",class:"w-4 h-4 text-purple-600 border-gray-300 focus:ring-2 focus:ring-purple-300"},null,512),[[lt,t(M)]]),e("div",td,[_[11]||(_[11]=e("p",{class:"font-medium text-cafe"},"Pacientes filtrados",-1)),e("p",ad,"Exportar solo los pacientes que cumplen los filtros actuales ("+l(E.filteredCount)+")",1)])],2)):$("",!0),E.selectedCount>0?(o(),s("label",{key:1,class:F(["flex items-center gap-3 p-3 border-2 rounded-lg cursor-pointer transition-all",t(M)==="selected"?"border-purple-600 bg-purple-50":"border-gray-200 bg-white hover:border-gray-300"])},[K(e("input",{type:"radio","onUpdate:modelValue":_[4]||(_[4]=C=>De(M)?M.value=C:null),value:"selected",class:"w-4 h-4 text-purple-600 border-gray-300 focus:ring-2 focus:ring-purple-300"},null,512),[[lt,t(M)]]),e("div",od,[_[12]||(_[12]=e("p",{class:"font-medium text-cafe"},"Pacientes seleccionados",-1)),e("p",sd,"Exportar solo los pacientes seleccionados ("+l(E.selectedCount)+")",1)])],2)):$("",!0)])]),e("div",null,[_[14]||(_[14]=e("label",{class:"block text-sm font-semibold text-cafe mb-3"}," Campos a exportar ",-1)),e("div",rd,[(o(),s(Q,null,J(d,C=>e("label",{key:C.value,class:"flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors"},[K(e("input",{type:"checkbox","onUpdate:modelValue":_[5]||(_[5]=n=>De(A)?A.value=n:null),value:C.value,class:"w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-2 focus:ring-purple-300"},null,8,nd),[[Fe,t(A)]]),e("span",ld,l(C.label),1)])),64))]),e("button",{onClick:y,class:"mt-2 text-xs text-purple-600 hover:text-purple-700 font-medium"},l(t(A).length===d.length?"Deseleccionar todos":"Seleccionar todos"),1)])]),e("div",id,[e("button",{onClick:x,disabled:t(H),class:"min-h-[44px] px-6 py-2.5 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all font-medium disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-gray-300"}," Cancelar ",8,dd),e("button",{onClick:q,disabled:t(H)||t(A).length===0,class:"min-h-[44px] px-6 py-2.5 bg-purple-600 text-white rounded-lg hover:bg-purple-600/90 transition-all font-medium shadow-sm hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-purple-300 flex items-center gap-2"},[t(H)?$("",!0):(o(),de(t(dt),{key:0,class:"w-5 h-5","aria-hidden":"true"})),t(H)?(o(),s("span",ud,"Exportando...")):(o(),s("span",pd,"Exportar"))],8,cd)])])])):$("",!0)]),_:1})]))}}),bd=Object.assign(ze(md,[["__scopeId","data-v-797ad56f"]]),{__name:"PatientsExportModal"}),gd={class:"relative min-h-screen flex items-center justify-center p-4"},vd={class:"relative px-6 pt-6 pb-4 bg-gradient-to-br from-purple-500 to-purple-600"},fd={class:"flex items-center gap-4"},xd={class:"flex-1 min-w-0"},hd={class:"text-xl font-semibold text-white truncate"},yd={class:"flex items-center gap-2 mt-1"},_d={key:0,class:"text-sm text-white/70"},wd={class:"px-6 py-4 space-y-4"},$d={class:"flex items-center gap-2 mb-1"},kd={key:0,class:"text-sm font-semibold text-purple-700"},Cd={key:1,class:"text-sm font-medium text-amber-700"},Ed={class:"grid grid-cols-2 gap-3"},Dd={class:"p-3 bg-gray-50 rounded-lg"},Sd={class:"flex items-center gap-1.5"},Pd={class:"text-sm font-medium text-gray-900"},Fd={class:"p-3 bg-gray-50 rounded-lg"},Md={class:"text-sm font-medium text-gray-900"},Ad={class:"flex items-center justify-between mb-2"},jd={class:"flex items-center gap-1.5"},Vd={class:"relative h-2 bg-gray-200 rounded-full overflow-hidden mb-1"},Bd={class:"flex justify-between"},Id={class:"text-xs text-gray-500"},Td={class:"flex flex-col gap-2"},zd={key:0,class:"flex items-center gap-2 text-sm text-gray-600"},Rd={class:"truncate"},qd={key:1,class:"flex items-center gap-2 text-sm text-gray-600"},Nd={class:"px-6 py-4 bg-gray-50 border-t border-gray-100 flex items-center gap-2"},Od={__name:"ModalPreviewPaciente",props:{mostrar:{type:Boolean,default:!1},paciente:{type:Object,default:null}},emits:["cerrar","ver-ficha","editar","gestionar-bonos"],setup(E){const B=E,m=S(()=>{if(!B.paciente?.nombre)return"??";const i=B.paciente.nombre.trim().split(" ");return`${i[0]?.charAt(0)||"?"}${i[1]?.charAt(0)||""}`.toUpperCase()}),O=S(()=>{if(!B.paciente||!B.paciente.activo)return"#9CA3AF";if(B.paciente.en_pausa)return"#F59E0B";const i=["#8B5CF6","#EC4899","#06B6D4","#10B981","#6366F1","#F97316"],p=B.paciente.id.charCodeAt(0)%i.length;return i[p]}),b=S(()=>B.paciente?.activo?B.paciente.en_pausa?"Pausa":"Activo":"Finalizado"),D=S(()=>B.paciente?.activo?B.paciente.en_pausa?"bg-amber-400/20 text-amber-100":"bg-green-400/20 text-green-100":"bg-white/20 text-white"),M=i=>{if(!i)return null;try{let p=i;p.includes("T")||(p+="T00:00:00");const v=new Date(p);return isNaN(v.getTime())?null:v.toLocaleDateString("es-ES",{weekday:"long",day:"numeric",month:"long",hour:"2-digit",minute:"2-digit"})}catch{return null}},A=S(()=>{if(!B.paciente?.ultima_sesion)return 999;const i=new Date(B.paciente.ultima_sesion);return Math.floor((new Date-i)/(1e3*60*60*24))}),H=S(()=>{if(!B.paciente?.ultima_sesion)return"Sin registro";const i=new Date(B.paciente.ultima_sesion),p=A.value;return p===0?"Hoy":p===1?"Ayer":p<7?`Hace ${p} días`:p<30?`Hace ${Math.floor(p/7)} semanas`:i.toLocaleDateString("es-ES",{day:"numeric",month:"long"})}),d=S(()=>B.paciente?.ultima_sesion?A.value<=7?"bg-green-500":A.value<=14?"bg-blue-500":A.value<=30?"bg-amber-500":"bg-red-500":"bg-gray-300"),x=S(()=>B.paciente?.bono_activo),y=S(()=>x.value?.tipo?{otro:"A demanda",quincenal:"Quincenal",semanal:"Semanal",mensual:"Mensual"}[x.value.tipo]||x.value.tipo:""),q=S(()=>x.value?x.value.sesiones_totales-x.value.sesiones_restantes:0),k=S(()=>!x.value||x.value.sesiones_totales===0?0:Math.round(q.value/x.value.sesiones_totales*100)),_=S(()=>x.value?x.value.sesiones_restantes<=1?"bg-red-500":x.value.sesiones_restantes===2?"bg-amber-500":"bg-purple-500":"bg-gray-400"),C=S(()=>x.value?x.value.sesiones_restantes<=1?"bg-red-50 border border-red-100":x.value.sesiones_restantes===2?"bg-amber-50 border border-amber-100":"bg-purple-50 border border-purple-100":"bg-gray-50"),n=S(()=>x.value?x.value.sesiones_restantes<=1?"text-red-500":x.value.sesiones_restantes===2?"text-amber-500":"text-purple-500":"text-gray-400"),h=S(()=>x.value?x.value.sesiones_restantes<=1?"text-red-700":x.value.sesiones_restantes===2?"text-amber-700":"text-purple-700":"text-gray-600"),u=S(()=>{if(!x.value?.fecha_fin)return"—";try{const i=new Date(x.value.fecha_fin),v=Math.floor((i-new Date)/(1e3*60*60*24));return v<0?"Vencido":v===0?"Vence hoy":v===1?"Vence mañana":v<=7?`Vence en ${v}d`:i.toLocaleDateString("es-ES",{day:"numeric",month:"short"})}catch{return"—"}}),g=S(()=>{if(!x.value?.fecha_fin)return"text-gray-400";const i=new Date(x.value.fecha_fin),v=Math.floor((i-new Date)/(1e3*60*60*24));return v<0?"text-red-600 font-medium":v<=7?"text-amber-600 font-medium":"text-gray-500"});return(i,p)=>(o(),de(et,{to:"body"},[w(Be,{"enter-active-class":"transition-all duration-200 ease-out","enter-from-class":"opacity-0","enter-to-class":"opacity-100","leave-active-class":"transition-all duration-150 ease-in","leave-from-class":"opacity-100","leave-to-class":"opacity-0"},{default:Me(()=>[E.mostrar&&E.paciente?(o(),s("div",{key:0,class:"fixed inset-0 z-50 overflow-y-auto",onClick:p[6]||(p[6]=te(v=>i.$emit("cerrar"),["self"]))},[e("div",{class:"fixed inset-0 bg-black/30 backdrop-blur-sm",onClick:p[0]||(p[0]=v=>i.$emit("cerrar"))}),e("div",gd,[w(Be,{"enter-active-class":"transition-all duration-200 ease-out","enter-from-class":"opacity-0 scale-95 translate-y-4","enter-to-class":"opacity-100 scale-100 translate-y-0","leave-active-class":"transition-all duration-150 ease-in","leave-from-class":"opacity-100 scale-100 translate-y-0","leave-to-class":"opacity-0 scale-95 translate-y-4"},{default:Me(()=>[E.mostrar?(o(),s("div",{key:0,class:"relative bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden",onClick:p[5]||(p[5]=te(()=>{},["stop"]))},[e("div",vd,[e("button",{onClick:p[1]||(p[1]=v=>i.$emit("cerrar")),class:"absolute top-4 right-4 p-1.5 text-white/80 hover:text-white hover:bg-white/10 rounded-lg transition-colors"},[w(t(Re),{class:"w-5 h-5"})]),e("div",fd,[e("div",{class:"w-16 h-16 rounded-full flex items-center justify-center text-white text-xl font-bold ring-4 ring-white/20",style:Ae({backgroundColor:t(O)})},l(t(m)),5),e("div",xd,[e("h2",hd,l(E.paciente.nombre||"Sin nombre"),1),e("div",yd,[e("span",{class:F(["inline-flex items-center px-2 py-0.5 text-xs font-medium rounded-full",t(D)])},l(t(b)),3),E.paciente.area_de_acompanamiento?(o(),s("span",_d,l(E.paciente.area_de_acompanamiento),1)):$("",!0)])])])]),e("div",wd,[e("div",{class:F(["p-3 rounded-lg",E.paciente.proxima_sesion?"bg-purple-50":"bg-amber-50"])},[e("div",$d,[w(t(We),{class:F(["w-4 h-4",E.paciente.proxima_sesion?"text-purple-500":"text-amber-500"])},null,8,["class"]),p[7]||(p[7]=e("span",{class:"text-xs font-medium text-gray-500"},"Próxima cita",-1))]),E.paciente.proxima_sesion?(o(),s("p",kd,l(M(E.paciente.proxima_sesion)),1)):(o(),s("p",Cd,"Sin cita programada"))],2),e("div",Ed,[e("div",Dd,[p[8]||(p[8]=e("p",{class:"text-xs text-gray-500 mb-0.5"},"Última sesión",-1)),e("div",Sd,[e("div",{class:F(["w-2 h-2 rounded-full",t(d)])},null,2),e("span",Pd,l(t(H)),1)])]),e("div",Fd,[p[9]||(p[9]=e("p",{class:"text-xs text-gray-500 mb-0.5"},"Total sesiones",-1)),e("p",Md,l(E.paciente.total_sesiones||0),1)])]),E.paciente.bono_activo?(o(),s("div",{key:0,class:F(["p-3 rounded-lg",t(C)])},[e("div",Ad,[e("div",jd,[w(t(Ue),{class:F(["w-4 h-4",t(n)])},null,8,["class"]),e("span",{class:F(["text-sm font-medium",t(h)])},l(t(y)),3)]),e("span",{class:F(["text-xs",t(g)])},l(t(u)),3)]),e("div",Vd,[e("div",{class:F(["absolute left-0 top-0 h-full rounded-full transition-all",t(_)]),style:Ae({width:t(k)+"%"})},null,6)]),e("div",Bd,[e("span",Id,l(t(q))+" usadas",1),e("span",{class:F(["text-xs font-semibold",t(h)])},l(E.paciente.bono_activo.sesiones_restantes)+" restantes ",3)])],2)):$("",!0),e("div",Td,[E.paciente.email?(o(),s("div",zd,[w(t(la),{class:"w-4 h-4 text-gray-400"}),e("span",Rd,l(E.paciente.email),1)])):$("",!0),E.paciente.telefono?(o(),s("div",qd,[w(t(da),{class:"w-4 h-4 text-gray-400"}),e("span",null,l(E.paciente.telefono),1)])):$("",!0)])]),e("div",Nd,[e("button",{onClick:p[2]||(p[2]=v=>i.$emit("ver-ficha",E.paciente)),class:"flex-1 px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 transition-colors"}," Ver ficha completa "),e("button",{onClick:p[3]||(p[3]=v=>i.$emit("editar",E.paciente)),class:"px-4 py-2 text-gray-600 text-sm font-medium hover:bg-gray-100 rounded-lg transition-colors"}," Editar "),e("button",{onClick:p[4]||(p[4]=v=>i.$emit("gestionar-bonos",E.paciente)),class:"px-4 py-2 text-gray-600 text-sm font-medium hover:bg-gray-100 rounded-lg transition-colors"}," Bonos ")])])):$("",!0)]),_:1})])])):$("",!0)]),_:1})]))}},Ud={class:"mb-6"},Ld={class:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-5"},Hd={class:"text-2xl font-semibold text-gray-900"},Gd={class:"text-gray-400 font-normal"},Kd={class:"flex items-center gap-2"},Qd={key:0,class:"bg-white border border-gray-100 rounded-xl p-4 mb-4 overflow-hidden"},Zd={class:"flex items-center justify-between mb-4"},Jd={class:"text-lg font-semibold text-gray-900 flex items-center gap-2"},Xd={class:"flex items-center bg-gray-100 rounded-lg p-1"},Wd=["onClick"],Yd={class:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-6"},ec={class:"bg-gradient-to-br from-purple-50 to-violet-50 rounded-xl p-4 border border-purple-100"},tc={class:"flex items-center gap-2 mb-2"},ac={class:"w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center"},oc={class:"text-2xl font-bold text-purple-900"},sc={class:"text-xs text-purple-600 mt-1"},rc={class:"bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-4 border border-green-100"},nc={class:"flex items-center gap-2 mb-2"},lc={class:"w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center"},ic={class:"text-2xl font-bold text-green-900"},dc={class:"text-xs text-green-600 mt-1"},cc={class:"bg-gradient-to-br from-red-50 to-rose-50 rounded-xl p-4 border border-red-100"},uc={class:"flex items-center gap-2 mb-2"},pc={class:"w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center"},mc={class:"text-2xl font-bold text-red-900"},bc={class:"text-xs text-red-600 mt-1"},gc={class:"bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-4 border border-blue-100"},vc={class:"text-2xl font-bold text-blue-900"},fc={class:"bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl p-4 border border-amber-100"},xc={class:"flex items-center gap-2 mb-2"},hc={class:"w-8 h-8 bg-amber-100 rounded-lg flex items-center justify-center"},yc={class:"text-2xl font-bold text-amber-900"},_c={class:"grid grid-cols-1 lg:grid-cols-2 gap-6"},wc={class:"bg-gray-50 rounded-xl p-4"},$c={class:"h-48"},kc={class:"bg-gray-50 rounded-xl p-4"},Cc={class:"h-48"},Ec={class:"mt-6 bg-gradient-to-r from-rose-50 to-red-50 rounded-xl p-4 border border-red-100"},Dc={class:"flex items-start gap-3"},Sc={class:"w-10 h-10 bg-red-100 rounded-xl flex items-center justify-center flex-shrink-0"},Pc={class:"flex-1"},Fc={class:"text-xs text-gray-600 mb-2"},Mc={class:"flex flex-wrap gap-2"},Ac={class:"px-2 py-1 bg-white rounded text-xs font-medium text-red-700"},jc={class:"px-2 py-1 bg-white rounded text-xs font-medium text-amber-700"},Vc={class:"space-y-4"},Bc={class:"relative"},Ic={class:"flex items-center justify-between border-b border-gray-100"},Tc={class:"flex gap-1 -mb-px",role:"tablist"},zc=["onClick","aria-selected"],Rc={key:0,class:"absolute bottom-0 left-0 right-0 h-0.5 bg-purple-600 rounded-full"},qc={key:0,class:"w-5 h-5 flex items-center justify-center text-xs font-semibold bg-purple-600 text-white rounded-full"},Nc={key:0,class:"bg-gray-50 rounded-lg p-4"},Oc={class:"flex flex-wrap items-center gap-3"},Uc=["value"],Lc={class:"flex items-center justify-between mb-4"},Hc={class:"text-sm text-gray-500"},Gc={key:0},Kc={key:1},Qc={key:2,class:"ml-2 text-gray-400"},Zc={class:"flex items-center gap-1 bg-gray-100 rounded-lg p-1"},Jc={key:0,class:"flex flex-col items-center justify-center py-20",role:"status"},Xc={key:1,class:"flex flex-col items-center justify-center py-20 text-center"},Wc={class:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4"},Yc={class:"text-lg font-medium text-gray-900 mb-1"},eu={class:"text-sm text-gray-500 mb-4 max-w-sm"},tu={key:2,class:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-4",role:"list"},au=["onClick","aria-label"],ou={key:3,class:"bg-white rounded-xl border border-gray-200 overflow-hidden"},su={key:4,class:"mt-6 flex items-center justify-center gap-2",role:"navigation","aria-label":"Paginación"},ru=["disabled"],nu={class:"flex items-center gap-1"},lu={key:1,class:"px-2 text-gray-400"},iu=["onClick"],du={key:2,class:"px-2 text-gray-400"},cu=["disabled"],Hu={__name:"pacientes",setup(E){pa.register(ma,ba,ga,va,fa,xa,ha,ya,_a),ta();const B=Et(),{getUserId:m,waitForUser:O}=Ye();Ct();const b=Ge(),D=V(!1),M=V(!1),A=V(!1),H=V(!1),d=V(!1),x=V(!1),y=V(!1),q=V(null),k=V(null),_=V(null),C=V([]),n=V(!0),h=V(""),u=V(""),g=V("todos"),i=V(""),p=V(!1),v=V({sinProximaCita:!1,sinSesionRegistrada:!1,requiereAtencion:!1,citasEstaSemana:!1,bonosPorVencer:!1,pagoPendiente:!1}),Z=V("cards"),ae=V(!1),P=V<"semana"|"mes"|!0,a=[{valor:"semana",label:"Semana"},{valor:"mes",label:"Mes"},{valor:"trimestre",label:"Trimestre"}],j=V(1),oe=V(24),U=V(!1),ee=V(null);let se=null;const ce=c=>{clearTimeout(se),se=setTimeout(()=>{h.value=c.target.value},300)},le=[{valor:"todos",label:"Todos"},{valor:"activo",label:"Activos"},{valor:"pausa",label:"En pausa"},{valor:"finalizado",label:"Finalizados"}],ie=S(()=>({activos:C.value.filter(c=>c.activo&&!c.en_pausa).length,enPausa:C.value.filter(c=>c.activo&&c.en_pausa).length,finalizados:C.value.filter(c=>!c.activo).length})),T=S(()=>le.map(c=>{let r=0;return c.valor==="todos"?r=C.value.length:c.valor==="activo"?r=ie.value.activos:c.valor==="pausa"?r=ie.value.enPausa:c.valor==="finalizado"&&(r=ie.value.finalizados),{...c,count:r}})),L=S(()=>T.value.find(r=>r.valor===g.value)?.count||0),z=S(()=>{const c=new Set(C.value.map(r=>r.area_de_acompanamiento).filter(Boolean));return Array.from(c).sort()}),f=S(()=>i.value!==""||v.value.sinProximaCita||v.value.sinSesionRegistrada||v.value.requiereAtencion||v.value.citasEstaSemana||v.value.bonosPorVencer||v.value.pagoPendiente),N=S(()=>{let c=0;return i.value&&c++,v.value.sinProximaCita&&c++,v.value.sinSesionRegistrada&&c++,v.value.requiereAtencion&&c++,v.value.citasEstaSemana&&c++,v.value.bonosPorVencer&&c++,v.value.pagoPendiente&&c++,c}),me=S(()=>f.value||h.value||g.value!=="todos"),ke=c=>{v.value[c]=!v.value[c]},Ie=()=>{i.value="",v.value={sinProximaCita:!1,sinSesionRegistrada:!1,requiereAtencion:!1,citasEstaSemana:!1,bonosPorVencer:!1,pagoPendiente:!1}},Ce=()=>{Ie(),g.value="todos",h.value="",u.value=""},ge=async()=>{n.value=!0;try{const c=m();if(!c){n.value=!1;return}const{data:r,error:X}=await B.from("pacientes").select(`
        id,
        created_at,
        activo,
        email,
        nombre_completo,
        telefono,
        area_de_acompanamiento,
        frecuencia,
        metadata
      `).eq("terapeuta_id",c).order("created_at",{ascending:!1});if(X)throw X;const G=await Promise.all(r.map(async Y=>{const{data:ve}=await B.from("citas").select("fecha_cita").eq("paciente_id",Y.id).eq("estado","realizada").order("fecha_cita",{ascending:!1}).limit(1).maybeSingle(),{data:pe}=await B.from("citas").select("id, fecha_cita, hora_inicio").eq("paciente_id",Y.id).in("estado",["pendiente","confirmada"]).gte("fecha_cita",new Date().toISOString().split("T")[0]).order("fecha_cita",{ascending:!0}).order("hora_inicio",{ascending:!0}).limit(1).maybeSingle(),{count:fe}=await B.from("citas").select("*",{count:"exact",head:!0}).eq("paciente_id",Y.id).eq("estado","realizada");let ne=null;try{const{data:Se}=await B.from("bonos").select("id, tipo, estado, sesiones_totales, sesiones_restantes, fecha_fin, created_at").eq("paciente_id",Y.id).in("estado",["activo","pendiente"]).order("created_at",{ascending:!1}).limit(1).maybeSingle();ne=Se}catch(Se){console.warn("[Bonos] Error:",Se)}let we=0,xe=0;ne&&(xe=ne.sesiones_totales,we=xe-ne.sesiones_restantes);const be=new Date;be.setDate(be.getDate()-7);const{data:$e}=await B.from("metricas_bienestar").select("estado_animo, nivel_energia, nivel_estres").eq("paciente_id",Y.id).gte("fecha",be.toISOString());let I=3,Ee=!1,Je=50;if($e&&$e.length>0){const Se=$e.reduce((Ne,nt)=>Ne+nt.estado_animo,0)/$e.length;I=Se,Je=Math.round(Se/10*100);const Xe=$e.slice(-3);Xe.length>=3&&(Ee=Xe.every(Ne=>Ne.estado_animo<=4))}const rt=Y.nombre_completo||Y.metadata?.nombre_completo||Y.email;return{id:Y.id,nombre:rt,email:Y.email,telefono:Y.telefono,activo:Y.activo,en_pausa:Y.metadata?.en_pausa||!1,area_de_acompanamiento:Y.area_de_acompanamiento,frecuencia:Y.frecuencia,ultima_sesion:ve?.fecha_cita||null,proxima_sesion:pe?`${pe.fecha_cita}T${pe.hora_inicio}`:null,proxima_cita_id:pe?.id||null,total_sesiones:fe||0,estado_emocional_promedio:I,evolucion_porcentaje:Je,requiere_atencion:Ee,created_at:Y.created_at,bono_activo:ne?{tipo:ne.tipo,estado:ne.estado,fecha_fin:ne.fecha_fin,sesiones_completadas:we,sesiones_totales:xe,sesiones_restantes:ne.sesiones_restantes}:null}}));C.value=G}catch(c){console.error("Error al cargar pacientes:",c),b.error("Error al cargar los pacientes")}finally{n.value=!1}},Ve=c=>{if(!c)return!1;const r=new Date(c),X=new Date,G=new Date(X);G.setDate(X.getDate()-X.getDay()),G.setHours(0,0,0,0);const Y=new Date(G);return Y.setDate(G.getDate()+7),r>=G&&r<Y},pt=c=>{if(!c.bono_activo)return!1;const r=c.bono_activo;if(r.sesiones_restantes<=2)return!0;if(r.fecha_fin){const X=new Date(r.fecha_fin);if(Math.floor((X-new Date)/(1e3*60*60*24))<=7)return!0}return!1},tt=S(()=>{let c=C.value;if(h.value){const r=h.value.toLowerCase();c=c.filter(X=>{const G=(X.nombre||"").toLowerCase(),Y=(X.email||"").toLowerCase(),ve=(X.telefono||"").toLowerCase(),pe=(X.proxima_sesion||"").toLowerCase();return G.includes(r)||Y.includes(r)||ve.includes(r)||pe.includes(r)})}return g.value!=="todos"&&(c=c.filter(r=>g.value==="activo"?r.activo&&!r.en_pausa:g.value==="pausa"?r.activo&&r.en_pausa:g.value==="finalizado"?!r.activo:!0)),i.value&&(c=c.filter(r=>r.area_de_acompanamiento===i.value)),v.value.sinProximaCita&&(c=c.filter(r=>!r.proxima_sesion)),v.value.sinSesionRegistrada&&(c=c.filter(r=>!r.ultima_sesion)),v.value.requiereAtencion&&(c=c.filter(r=>r.requiere_atencion)),v.value.citasEstaSemana&&(c=c.filter(r=>Ve(r.proxima_sesion))),v.value.bonosPorVencer&&(c=c.filter(r=>pt(r))),v.value.pagoPendiente&&(c=c.filter(r=>r.bono_activo?r.bono_activo.estado==="pendiente":!1)),c}),_e=S(()=>Math.ceil(tt.value.length/oe.value)),Ke=S(()=>{const c=(j.value-1)*oe.value,r=c+oe.value;return tt.value.slice(c,r)});ye([h,g,i,v],()=>{j.value=1},{deep:!0});const qe=c=>{c>=1&&c<=_e.value&&(j.value=c,window.scrollTo({top:0,behavior:"smooth"}))},Qe=S(()=>C.value.length),mt=S(()=>tt.value.length),Mt=S(()=>{const c=[],r=Math.max(1,j.value-2),X=Math.min(_e.value,j.value+2);for(let G=r;G<=X;G++)c.push(G);return c}),at=c=>{const r=typeof c=="object"?c.id:c;if(console.log("[Pacientes] Navegando a ficha de paciente:",r),!r){console.error("[Pacientes] ERROR: ID de paciente no válido:",c);return}it(`/terapeuta/pacientes/${r}`)},bt=()=>{D.value=!0},At=()=>{D.value=!1},ot=c=>{k.value=c,M.value=!0},jt=()=>{M.value=!1,k.value=null},Vt=c=>{k.value=c,A.value=!0},Bt=()=>{A.value=!1,k.value=null},It=async()=>{await ge(),b.success("Paciente creado")},Tt=async()=>{await ge(),b.success("Paciente actualizado")},zt=async c=>{C.value=C.value.filter(r=>r.id!==c),b.success("Paciente eliminado")},Rt=async()=>{await ge(),b.success("Paciente desactivado")},qt=c=>{_.value=c,H.value=!0},gt=()=>{H.value=!1,_.value=null},Nt=async()=>{await ge(),gt(),b.success("Cita asignada")},Ot=c=>{console.log("[Pacientes] Navegando a agenda del paciente:",c.id),it(`/agenda?paciente=${c.id}`)},st=c=>{if(!c?.id){console.error("[Pacientes] ERROR: ID de paciente no válido para gestionar bonos:",c);return}console.log("[Pacientes] Navegando a bonos del paciente:",c.id),it(`/terapeuta/pacientes/${c.id}/bonos`)},Ut=c=>{ee.value=c,U.value=!0},Ze=()=>{U.value=!1,ee.value=null},Lt=()=>{x.value=!0},Ht=()=>{y.value=!0},Gt=async()=>{await ge(),b.success("Importación completada")},Kt=S(()=>{const c={};return g.value!=="todos"&&(c.estado=g.value),i.value&&(c.area=i.value),c}),Qt=c=>{q.value=c,d.value=!0},vt=()=>{d.value=!1,q.value=null},Zt=async()=>{await ge(),vt(),b.success("Cita actualizada")},ft=c=>{const r=new Date,X=new Date(r),G=new Date(r);return c==="semana"?G.setDate(r.getDate()-7):c==="mes"?G.setMonth(r.getMonth()-1):G.setMonth(r.getMonth()-3),{inicio:G,fin:X}},ue=S(()=>{const{inicio:c,fin:r}=ft(P.value),X=new Date(c);P.value==="semana"?X.setDate(X.getDate()-7):P.value==="mes"?X.setMonth(X.getMonth()-1):X.setMonth(X.getMonth()-3);const G=C.value,Y=G.length,ve=G.filter(W=>W.activo&&!W.en_pausa).length,pe=G.filter(W=>!W.activo).length,fe=G.filter(W=>W.activo&&W.en_pausa).length,ne=G.filter(W=>{const he=new Date(W.created_at);return he>=c&&he<=r}).length,we=G.filter(W=>{const he=new Date(W.created_at);return he>=X&&he<c}).length,xe=we>0?Math.round((ne-we)/we*100):ne>0?100:0,be=new Date;be.setDate(be.getDate()-30);const $e=G.filter(W=>{if(W.activo)return!1;if(W.ultima_sesion){const he=new Date(W.ultima_sesion);return he>=c&&he<=r}return!1}).length,I=ve+$e,Ee=I>0?Math.round($e/I*100):0,Je=100-Ee,rt=G.reduce((W,he)=>W+(he.total_sesiones||0),0),Se=ve>0?(rt/ve).toFixed(1):"0",Xe=G.filter(W=>{if(!W.activo||W.en_pausa)return!1;const he=!W.proxima_sesion,Wt=!W.ultima_sesion||new Date(W.ultima_sesion)<be;return he&&Wt}).length,Ne=G.filter(W=>W.activo&&!W.en_pausa&&!W.proxima_sesion).length,nt=G.filter(W=>pt(W)).length;return{total:Y,activos:ve,finalizados:pe,enPausa:fe,nuevos:ne,tendenciaNuevos:xe,churn:Ee,retencion:Je,promedioSesiones:Se,pacientesEnRiesgo:Xe,sinCitaProxima:Ne,bonosPorVencer:nt}}),xt=S(()=>{const{inicio:c}=ft(P.value),r=[],X=[],G=[],Y=P.value==="semana"?7:P.value==="mes"?4:12,ve=P.value==="semana"?1:(P.value==="mes",7);for(let pe=0;pe<Y;pe++){const fe=new Date(c);fe.setDate(fe.getDate()+pe*ve),P.value==="semana"?r.push(fe.toLocaleDateString("es-ES",{weekday:"short"})):r.push(fe.toLocaleDateString("es-ES",{day:"2-digit",month:"short"}));const ne=C.value.filter(xe=>{const be=new Date(xe.created_at);return be<=fe&&be>=c}).length,we=C.value.filter(xe=>new Date(xe.created_at)<=fe&&xe.activo).length;X.push(ne),G.push(we)}return{labels:r,datasets:[{label:"Nuevos",data:X,borderColor:"#10B981",backgroundColor:"rgba(16, 185, 129, 0.1)",fill:!0,tension:.4},{label:"Activos",data:G,borderColor:"#8B5CF6",backgroundColor:"rgba(139, 92, 246, 0.1)",fill:!0,tension:.4}]}}),Jt={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom",labels:{boxWidth:12,padding:15}}},scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}},ht=S(()=>{const{activos:c,enPausa:r,finalizados:X}=ue.value;return{labels:["Activos","En Pausa","Finalizados"],datasets:[{data:[c,r,X],backgroundColor:["#8B5CF6","#F59E0B","#6B7280"],borderWidth:0}]}}),Xt={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom",labels:{boxWidth:12,padding:15}}},cutout:"60%"};return aa(async()=>{try{await O(),m()?await ge():n.value=!1}catch(c){console.error("Error en onMounted:",c),n.value=!1}}),ye(()=>m(),c=>{c&&C.value.length===0&&ge()}),(c,r)=>{const X=lo,G=Bo,Y=ia,ve=Cs,pe=yr,fe=Vr,ne=pn,we=xn,xe=Ki,be=bd,$e=Od;return o(),s("div",null,[e("header",Ud,[e("div",Ld,[e("div",null,[e("h1",Hd,[r[22]||(r[22]=R(" Pacientes ",-1)),e("span",Gd,"("+l(t(L))+")",1)])]),e("div",Kd,[e("button",{onClick:r[0]||(r[0]=I=>ae.value=!t(ae)),class:F(["min-h-[40px] px-3 py-2 text-sm font-medium rounded-lg transition-all flex items-center gap-2 border",t(ae)?"bg-indigo-600 text-white border-indigo-600 shadow-md":"bg-white text-indigo-700 border-indigo-200 hover:bg-indigo-50"]),title:"Ver resumen y estadísticas"},[w(t(yt),{class:"w-4 h-4"}),r[23]||(r[23]=e("span",{class:"hidden sm:inline"},"Resumen",-1))],2),e("button",{onClick:Lt,class:"min-h-[40px] px-3 py-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors flex items-center gap-1.5 text-sm font-medium","aria-label":"Importar pacientes"},[w(t(ct),{class:"w-4 h-4","aria-hidden":"true"}),r[24]||(r[24]=e("span",{class:"hidden sm:inline"},"Importar",-1))]),e("button",{onClick:Ht,class:"min-h-[40px] px-3 py-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors flex items-center gap-1.5 text-sm font-medium","aria-label":"Exportar pacientes"},[w(t(dt),{class:"w-4 h-4","aria-hidden":"true"}),r[25]||(r[25]=e("span",{class:"hidden sm:inline"},"Exportar",-1))]),e("button",{onClick:bt,class:"min-h-[40px] px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-2 text-sm font-medium shadow-sm","aria-label":"Añadir nuevo paciente"},[w(t(_t),{class:"w-4 h-4","aria-hidden":"true"}),r[26]||(r[26]=e("span",null,"Nuevo",-1))])])]),w(Be,{"enter-active-class":"transition-all duration-300 ease-out","enter-from-class":"opacity-0 max-h-0","enter-to-class":"opacity-100 max-h-[800px]","leave-active-class":"transition-all duration-200 ease-in","leave-from-class":"opacity-100 max-h-[800px]","leave-to-class":"opacity-0 max-h-0"},{default:Me(()=>[t(ae)?(o(),s("div",Qd,[e("div",Zd,[e("h3",Jd,[w(t(yt),{class:"w-5 h-5 text-indigo-500"}),r[27]||(r[27]=R(" Estadísticas de Pacientes ",-1))]),e("div",Xd,[(o(),s(Q,null,J(a,I=>e("button",{key:I.valor,onClick:Ee=>P=I.valor,class:F(["px-3 py-1.5 text-sm font-medium rounded-md transition-all",P===I.valor?"bg-white text-gray-900 shadow-sm":"text-gray-600 hover:text-gray-900"])},l(I.label),11,Wd)),64))])]),e("div",Yd,[e("div",ec,[e("div",tc,[e("div",ac,[w(t(wt),{class:"w-4 h-4 text-purple-600"})]),r[28]||(r[28]=e("span",{class:"text-xs font-medium text-purple-600 uppercase"},"Total",-1))]),e("p",oc,l(t(ue).total),1),e("p",sc,l(t(ue).activos)+" activos",1)]),e("div",rc,[e("div",nc,[e("div",lc,[w(t(_t),{class:"w-4 h-4 text-green-600"})]),r[29]||(r[29]=e("span",{class:"text-xs font-medium text-green-600 uppercase"},"Nuevos",-1))]),e("p",ic,l(t(ue).nuevos),1),e("p",dc,[e("span",{class:F(t(ue).tendenciaNuevos>=0?"text-green-600":"text-red-600")},l(t(ue).tendenciaNuevos>=0?"+":"")+l(t(ue).tendenciaNuevos)+"% ",3),r[30]||(r[30]=R(" vs período ant. ",-1))])]),e("div",cc,[e("div",uc,[e("div",pc,[w(t(dt),{class:"w-4 h-4 text-red-600 rotate-90"})]),r[31]||(r[31]=e("span",{class:"text-xs font-medium text-red-600 uppercase"},"Churn",-1))]),e("p",mc,l(t(ue).churn)+"%",1),e("p",bc,l(t(ue).finalizados)+" finalizados",1)]),e("div",gc,[r[32]||(r[32]=e("div",{class:"flex items-center gap-2 mb-2"},[e("div",{class:"w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center"},[e("svg",{class:"w-4 h-4 text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"})])]),e("span",{class:"text-xs font-medium text-blue-600 uppercase"},"Retención")],-1)),e("p",vc,l(t(ue).retencion)+"%",1),r[33]||(r[33]=e("p",{class:"text-xs text-blue-600 mt-1"},"Pacientes que continúan",-1))]),e("div",fc,[e("div",xc,[e("div",hc,[w(t($t),{class:"w-4 h-4 text-amber-600"})]),r[34]||(r[34]=e("span",{class:"text-xs font-medium text-amber-600 uppercase"},"Prom. Sesiones",-1))]),e("p",yc,l(t(ue).promedioSesiones),1),r[35]||(r[35]=e("p",{class:"text-xs text-amber-600 mt-1"},"Por paciente",-1))])]),e("div",_c,[e("div",wc,[r[36]||(r[36]=e("h4",{class:"text-sm font-semibold text-gray-700 mb-3"},"Evolución de Pacientes",-1)),e("div",$c,[t(xt)?(o(),de(t(ca),{key:0,data:t(xt),options:Jt},null,8,["data"])):$("",!0)])]),e("div",kc,[r[37]||(r[37]=e("h4",{class:"text-sm font-semibold text-gray-700 mb-3"},"Distribución por Estado",-1)),e("div",Cc,[t(ht)?(o(),de(t(ua),{key:0,data:t(ht),options:Xt},null,8,["data"])):$("",!0)])])]),e("div",Ec,[e("div",Dc,[e("div",Sc,[w(t(je),{class:"w-5 h-5 text-red-600"})]),e("div",Pc,[r[38]||(r[38]=e("h4",{class:"text-sm font-semibold text-gray-800 mb-1"},"Análisis de Churn",-1)),e("p",Fc,l(t(ue).pacientesEnRiesgo)+" pacientes no han tenido sesión en los últimos 30 días y podrían estar en riesgo de abandono. ",1),e("div",Mc,[e("span",Ac,l(t(ue).sinCitaProxima)+" sin cita programada ",1),e("span",jc,l(t(ue).bonosPorVencer)+" con bono por vencer ",1)])])])])])):$("",!0)]),_:1}),e("div",Vc,[e("div",Bc,[K(e("input",{"onUpdate:modelValue":r[1]||(r[1]=I=>De(u)?u.value=I:null),onInput:ce,type:"text",placeholder:"Buscar por nombre, email o teléfono...",class:"w-full h-11 px-4 pl-10 bg-white border border-gray-200 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all text-sm placeholder-gray-400","aria-label":"Buscar pacientes"},null,544),[[re,t(u)]]),w(t(wa),{class:"w-4 h-4 absolute left-3.5 top-1/2 -translate-y-1/2 text-gray-400","aria-hidden":"true"}),t(h)?(o(),s("button",{key:0,onClick:r[2]||(r[2]=I=>{h.value="",u.value=""}),class:"absolute right-3 top-1/2 -translate-y-1/2 p-1 text-gray-400 hover:text-gray-600 rounded","aria-label":"Limpiar búsqueda"},[w(t(Re),{class:"w-4 h-4"})])):$("",!0)]),e("div",Ic,[e("nav",Tc,[(o(!0),s(Q,null,J(t(T),I=>(o(),s("button",{key:I.valor,onClick:Ee=>g.value=I.valor,class:F(["px-4 py-2.5 text-sm font-medium transition-colors relative",t(g)===I.valor?"text-purple-600":"text-gray-500 hover:text-gray-700"]),"aria-selected":t(g)===I.valor,role:"tab"},[e("span",null,l(I.label),1),e("span",{class:F(["ml-1.5 text-xs",t(g)===I.valor?"text-purple-500":"text-gray-400"])},l(I.count),3),t(g)===I.valor?(o(),s("span",Rc)):$("",!0)],10,zc))),128))]),e("button",{onClick:r[3]||(r[3]=I=>p.value=!t(p)),class:F(["flex items-center gap-1.5 px-3 py-2 text-sm font-medium rounded-lg transition-colors",t(f)?"text-purple-600 bg-purple-50":"text-gray-500 hover:text-gray-700 hover:bg-gray-50"])},[w(t($a),{class:"w-4 h-4"}),r[39]||(r[39]=e("span",{class:"hidden sm:inline"},"Filtros",-1)),t(N)>0?(o(),s("span",qc,l(t(N)),1)):$("",!0),w(t(ka),{class:F(["w-4 h-4 transition-transform",{"rotate-180":t(p)}])},null,8,["class"])],2)]),w(Be,{"enter-active-class":"transition-all duration-200 ease-out","enter-from-class":"opacity-0 -translate-y-2","enter-to-class":"opacity-100 translate-y-0","leave-active-class":"transition-all duration-150 ease-in","leave-from-class":"opacity-100 translate-y-0","leave-to-class":"opacity-0 -translate-y-2"},{default:Me(()=>[t(p)?(o(),s("div",Nc,[e("div",Oc,[K(e("select",{"onUpdate:modelValue":r[4]||(r[4]=I=>De(i)?i.value=I:null),class:"h-9 px-3 bg-white border border-gray-200 rounded-lg text-sm text-gray-700 focus:border-purple-500 focus:ring-1 focus:ring-purple-500/20","aria-label":"Filtrar por área"},[r[40]||(r[40]=e("option",{value:""},"Todas las áreas",-1)),(o(!0),s(Q,null,J(t(z),I=>(o(),s("option",{key:I,value:I},l(I),9,Uc))),128))],512),[[Oe,t(i)]]),e("button",{onClick:r[5]||(r[5]=I=>ke("sinProximaCita")),class:F(["h-9 px-3 rounded-lg text-sm font-medium transition-all flex items-center gap-1.5",t(v).sinProximaCita?"bg-orange-100 text-orange-700 border border-orange-200":"bg-white text-gray-600 border border-gray-200 hover:border-gray-300"])},[w(t(We),{class:"w-4 h-4"}),r[41]||(r[41]=R(" Sin próxima cita ",-1))],2),e("button",{onClick:r[6]||(r[6]=I=>ke("sinSesionRegistrada")),class:F(["h-9 px-3 rounded-lg text-sm font-medium transition-all flex items-center gap-1.5",t(v).sinSesionRegistrada?"bg-amber-100 text-amber-700 border border-amber-200":"bg-white text-gray-600 border border-gray-200 hover:border-gray-300"])},[w(t($t),{class:"w-4 h-4"}),r[42]||(r[42]=R(" Sin sesión ",-1))],2),e("button",{onClick:r[7]||(r[7]=I=>ke("requiereAtencion")),class:F(["h-9 px-3 rounded-lg text-sm font-medium transition-all flex items-center gap-1.5",t(v).requiereAtencion?"bg-red-100 text-red-700 border border-red-200":"bg-white text-gray-600 border border-gray-200 hover:border-gray-300"])},[w(t(je),{class:"w-4 h-4"}),r[43]||(r[43]=R(" Requiere atención ",-1))],2),e("button",{onClick:r[8]||(r[8]=I=>ke("citasEstaSemana")),class:F(["h-9 px-3 rounded-lg text-sm font-medium transition-all flex items-center gap-1.5",t(v).citasEstaSemana?"bg-purple-100 text-purple-700 border border-purple-200":"bg-white text-gray-600 border border-gray-200 hover:border-gray-300"])},[w(t(We),{class:"w-4 h-4"}),r[44]||(r[44]=R(" Citas esta semana ",-1))],2),e("button",{onClick:r[9]||(r[9]=I=>ke("bonosPorVencer")),class:F(["h-9 px-3 rounded-lg text-sm font-medium transition-all flex items-center gap-1.5",t(v).bonosPorVencer?"bg-amber-100 text-amber-700 border border-amber-200":"bg-white text-gray-600 border border-gray-200 hover:border-gray-300"])},[w(t(Ue),{class:"w-4 h-4"}),r[45]||(r[45]=R(" Bonos por vencer ",-1))],2),e("button",{onClick:r[10]||(r[10]=I=>ke("pagoPendiente")),class:F(["h-9 px-3 rounded-lg text-sm font-medium transition-all flex items-center gap-1.5",t(v).pagoPendiente?"bg-green-100 text-green-700 border border-green-200":"bg-white text-gray-600 border border-gray-200 hover:border-gray-300"])},[w(t(Ca),{class:"w-4 h-4"}),r[46]||(r[46]=R(" Pago pendiente ",-1))],2),t(f)?(o(),s("button",{key:0,onClick:Ie,class:"h-9 px-3 text-sm text-gray-500 hover:text-gray-700 transition-colors"}," Limpiar ")):$("",!0)])])):$("",!0)]),_:1})])]),e("div",Lc,[e("p",Hc,[t(mt)===t(Qe)?(o(),s("span",Gc,l(t(Qe))+" pacientes",1)):(o(),s("span",Kc,l(t(mt))+" de "+l(t(Qe))+" pacientes",1)),t(_e)>1?(o(),s("span",Qc," (página "+l(t(j))+" de "+l(t(_e))+") ",1)):$("",!0)]),e("div",Zc,[e("button",{onClick:r[11]||(r[11]=I=>Z.value="cards"),class:F(["p-1.5 rounded transition-colors",t(Z)==="cards"?"bg-white shadow-sm text-purple-600":"text-gray-500 hover:text-gray-700"]),title:"Vista de tarjetas"},[w(t(Aa),{class:"w-4 h-4"})],2),e("button",{onClick:r[12]||(r[12]=I=>Z.value="tabla"),class:F(["p-1.5 rounded transition-colors",t(Z)==="tabla"?"bg-white shadow-sm text-purple-600":"text-gray-500 hover:text-gray-700"]),title:"Vista de tabla"},[w(t(ja),{class:"w-4 h-4"})],2)])]),e("section",null,[t(n)?(o(),s("div",Jc,[...r[47]||(r[47]=[e("div",{class:"w-8 h-8 border-2 border-purple-600 border-t-transparent rounded-full animate-spin mb-4"},null,-1),e("p",{class:"text-sm text-gray-500"},"Cargando pacientes...",-1)])])):t(Ke).length===0?(o(),s("div",Xc,[e("div",Wc,[w(t(wt),{class:"w-8 h-8 text-gray-400"})]),e("h3",Yc,l(t(me)?"Sin resultados":"Sin pacientes"),1),e("p",eu,l(t(me)?"Prueba ajustando los filtros de búsqueda":"Comienza añadiendo tu primer paciente"),1),t(me)?(o(),s("button",{key:1,onClick:Ce,class:"px-4 py-2 text-gray-600 text-sm font-medium hover:text-gray-900 transition-colors"}," Limpiar filtros ")):(o(),s("button",{key:0,onClick:bt,class:"px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 transition-colors"}," Añadir paciente "))])):t(Z)==="cards"?(o(),s("div",tu,[(o(!0),s(Q,null,J(t(Ke),I=>(o(),s("div",{key:I.id,class:"relative group",role:"listitem"},[w(X,{paciente:I,onVerFicha:at,onEditar:ot,onEliminar:Vt,onVerCitas:Ot,onGestionarBonos:st,onEditarCita:Qt},null,8,["paciente"]),I.activo&&!I.en_pausa?(o(),s("button",{key:0,onClick:te(Ee=>qt(I),["stop"]),class:"absolute bottom-4 right-4 min-h-[44px] min-w-[44px] h-11 px-4 bg-purple-600 text-white text-sm font-medium rounded-lg shadow-md hover:bg-purple-700 active:bg-purple-800 transition-all flex items-center justify-center gap-2 opacity-0 group-hover:opacity-100 pointer-events-none group-hover:pointer-events-auto z-10","aria-label":`Asignar cita a ${I.nombre}`},[w(t(We),{class:"w-5 h-5"}),r[48]||(r[48]=e("span",{class:"hidden sm:inline"},"Cita",-1))],8,au)):$("",!0)]))),128))])):t(Z)==="tabla"?(o(),s("div",ou,[w(G,{pacientes:t(Ke),onVerFicha:at,onEditar:ot,onGestionarBonos:st,onVerPreview:Ut},null,8,["pacientes"])])):$("",!0),t(_e)>1?(o(),s("nav",su,[e("button",{onClick:r[13]||(r[13]=I=>qe(t(j)-1)),disabled:t(j)===1,class:"min-h-[44px] min-w-[44px] p-2 rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center","aria-label":"Página anterior"},[w(t(Sa),{class:"w-5 h-5"})],8,ru),e("div",nu,[t(j)>3?(o(),s("button",{key:0,onClick:r[14]||(r[14]=I=>qe(1)),class:"min-h-[44px] min-w-[44px] px-3 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50 transition-colors"}," 1 ")):$("",!0),t(j)>4?(o(),s("span",lu,"...")):$("",!0),(o(!0),s(Q,null,J(t(Mt),I=>(o(),s("button",{key:I,onClick:Ee=>qe(I),class:F(["min-h-[44px] min-w-[44px] px-3 py-2 rounded-lg text-sm font-medium transition-colors",I===t(j)?"bg-purple-600 text-white":"text-gray-600 hover:bg-gray-50"])},l(I),11,iu))),128)),t(j)<t(_e)-3?(o(),s("span",du,"...")):$("",!0),t(j)<t(_e)-2?(o(),s("button",{key:3,onClick:r[15]||(r[15]=I=>qe(t(_e))),class:"min-h-[44px] min-w-[44px] px-3 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50 transition-colors"},l(t(_e)),1)):$("",!0)]),e("button",{onClick:r[16]||(r[16]=I=>qe(t(j)+1)),disabled:t(j)===t(_e),class:"min-h-[44px] min-w-[44px] p-2 rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center","aria-label":"Página siguiente"},[w(t(Ea),{class:"w-5 h-5"})],8,cu)])):$("",!0)]),w(Y,{mostrar:t(H),"paciente-preseleccionado":t(_),onCerrar:gt,onCitaCreada:Nt},null,8,["mostrar","paciente-preseleccionado"]),w(ve,{mostrar:t(D),onCerrar:At,onPacienteCreado:It},null,8,["mostrar"]),w(pe,{mostrar:t(M),paciente:t(k),onCerrar:jt,onPacienteActualizado:Tt},null,8,["mostrar","paciente"]),w(fe,{mostrar:t(A),paciente:t(k),onCerrar:Bt,onPacienteEliminado:zt,onPacienteDesactivado:Rt},null,8,["mostrar","paciente"]),w(ne,{isOpen:t(d),citaId:t(q),onClose:vt,onActualizado:Zt},null,8,["isOpen","citaId"]),w(we),w(xe,{modelValue:t(x),"onUpdate:modelValue":r[17]||(r[17]=I=>De(x)?x.value=I:null),"existing-patients":t(C),onImportComplete:Gt},null,8,["modelValue","existing-patients"]),w(be,{modelValue:t(y),"onUpdate:modelValue":r[18]||(r[18]=I=>De(y)?y.value=I:null),"total-patients":t(Qe),"filtered-count":t(Ke).length,"has-filters":t(f)||t(g)!=="todos"||t(h)!=="","current-filters":t(Kt)},null,8,["modelValue","total-patients","filtered-count","has-filters","current-filters"]),w($e,{mostrar:t(U),paciente:t(ee),onCerrar:Ze,onVerFicha:r[19]||(r[19]=I=>{Ze(),at(I)}),onEditar:r[20]||(r[20]=I=>{Ze(),ot(I)}),onGestionarBonos:r[21]||(r[21]=I=>{Ze(),st(I)})},null,8,["mostrar","paciente"])])}}};export{Hu as default};
