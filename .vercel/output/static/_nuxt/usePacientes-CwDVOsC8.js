import{p as O,B as T,r as v,I as q,x as S}from"#entry";class z{enabled=!0;minLevel="debug";sessionId;buffer=[];maxBufferSize=100;constructor(){this.sessionId=this.generateSessionId(),this.minLevel="warn"}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}shouldLog(e){if(!this.enabled)return!1;const t=["debug","info","warn","error"],a=t.indexOf(this.minLevel);return t.indexOf(e)>=a}formatMessage(e){const t=new Date(e.timestamp).toLocaleTimeString("es-ES"),a=`[AGENDA ${e.event.toUpperCase()}]`;return`${t} ${a} ${e.message}`}log(e,t,a,o){if(!this.shouldLog(e))return;const r={timestamp:new Date().toISOString(),level:e,event:t,message:a,data:o,sessionId:this.sessionId};this.buffer.push(r),this.buffer.length>this.maxBufferSize&&this.buffer.shift();const d=this.formatMessage(r);switch(e){case"debug":console.log(`üîç ${d}`,o||"");break;case"info":console.info(`‚ÑπÔ∏è ${d}`,o||"");break;case"warn":console.warn(`‚ö†Ô∏è ${d}`,o||"");break;case"error":console.error(`‚ùå ${d}`,o||""),r.stack&&console.error("Stack trace:",r.stack);break}}debug(e,t,a){this.log("debug",e,t,a)}info(e,t,a){this.log("info",e,t,a)}warn(e,t,a){this.log("warn",e,t,a)}error(e,t,a){const o=a instanceof Error?{name:a.name,message:a.message,stack:a.stack}:a,r={timestamp:new Date().toISOString(),level:"error",event:e,message:t,data:o,sessionId:this.sessionId,stack:a instanceof Error?a.stack:void 0};this.buffer.push(r),this.buffer.length>this.maxBufferSize&&this.buffer.shift(),console.error(`‚ùå ${this.formatMessage(r)}`,o||""),r.stack&&console.error("Stack trace:",r.stack)}loadRange(e,t,a){this.info("load_range",`Cargadas ${a} citas`,{from:e,to:t,count:a})}create(e,t,a){this.info("create",`Cita creada: ${e}`,{appointmentId:e,date:t,time:a})}update(e,t){this.info("update",`Cita actualizada: ${e}`,{appointmentId:e,changes:t})}move(e,t,a){this.info("move",`Cita movida: ${e}`,{appointmentId:e,from:t,to:a})}statusChange(e,t,a){this.info("status_change",`Estado cambiado: ${t} ‚Üí ${a}`,{appointmentId:e,from:t,to:a})}conflict(e,t,a,o){this.warn("conflict","Conflicto de horario detectado",{appointmentId:e,conflictWith:t,date:a,time:o})}apiError(e,t){this.error("api_error",`Error en API: ${e}`,t instanceof Error?t:{message:t})}realtimeEvent(e,t){this.debug("realtime_event",`Evento en tiempo real: ${e}`,t)}optimisticUpdate(e,t){this.debug("optimistic_update",`Actualizaci√≥n optimista: ${t}`,{appointmentId:e,action:t})}rollback(e,t){this.warn("rollback",`Rollback de cambio: ${t}`,{appointmentId:e,reason:t})}dragStart(e,t){this.debug("drag_start",`Inicio de drag: ${e}`,{appointmentId:e,from:t})}dragEnd(e,t,a){a?this.debug("drag_end","Drag completado exitosamente",{appointmentId:e,to:t}):this.warn("drag_end","Drag cancelado o fallido",{appointmentId:e,to:t})}clickCreate(e,t){this.debug("click_create","Click para crear cita",{date:e,time:t})}filterChange(e){this.debug("filter_change","Filtros actualizados",{filters:e})}getBuffer(){return[...this.buffer]}clearBuffer(){this.buffer=[]}downloadLogs(){const e=this.buffer.map(r=>JSON.stringify(r)).join(`
`),t=new Blob([e],{type:"application/json"}),a=URL.createObjectURL(t),o=document.createElement("a");o.href=a,o.download=`agenda-logs-${this.sessionId}.json`,o.click(),URL.revokeObjectURL(a)}setEnabled(e){this.enabled=e}setMinLevel(e){this.minLevel=e}getSessionId(){return this.sessionId}}const m=new z;function j(){const u=O(),e=T(),t=v([]),a=v(!1),o=v(null),r=v(""),d=v(null),p=v(new Map),x=300*1e3;async function w(s){try{a.value=!0,o.value=null;const i=s.trim().toLowerCase(),n=p.value.get(i);if(n){t.value=n,m.debug("search",`Resultados desde cache: ${n.length}`);return}if(m.debug("search",`Buscando pacientes: "${i}"`),!e.value?.id)throw new Error("Usuario no autenticado");let h=null;const{data:g}=await u.from("terapeutas").select("id").eq("id",e.value.id).maybeSingle();if(g?.id)h=g.id;else{const{data:l}=await u.from("terapeutas").select("id").eq("email",e.value.email).maybeSingle();l?.id&&(h=l.id)}if(!h)throw new Error("No se pudo obtener el perfil del terapeuta");let c=u.from("pacientes").select(`
          id,
          nombre_completo,
          email,
          telefono,
          fecha_nacimiento,
          bonos(
            id,
            sesiones_restantes,
            fecha_fin,
            estado
          )
        `).eq("terapeuta_id",h);i.length>0&&(c=c.or(`nombre_completo.ilike.%${i}%,email.ilike.%${i}%,telefono.ilike.%${i}%`));const{data:$,error:_}=await c.order("nombre_completo",{ascending:!0}).limit(50);if(_)throw _;const b=($||[]).map(l=>{const E=(l.bonos||[]).filter(f=>f.estado==="activo"&&f.sesiones_restantes>0),M=E.reduce((f,U)=>f+(U.sesiones_restantes||0),0),L=E.filter(f=>f.fecha_fin).map(f=>new Date(f.fecha_fin).getTime()).sort()[0]||null;return{id:l.id,nombre_completo:l.nombre_completo,email:l.email,telefono:l.telefono,fecha_nacimiento:l.fecha_nacimiento,bonos_activos:E.length,sesiones_restantes_total:M,proximo_vencimiento:L?new Date(L).toISOString():null}});t.value=b,p.value.set(i,b),setTimeout(()=>{p.value.delete(i)},x),m.info("search",`Pacientes encontrados: ${b.length}`)}catch(i){const n=i.message||"Error al buscar pacientes";o.value=n,m.error("api_error",n,i),t.value=[]}finally{a.value=!1}}function k(s,i=300){if(d.value&&clearTimeout(d.value),s.trim().length===0){w(s);return}d.value=setTimeout(()=>{w(s)},i)}async function C(s){try{if(a.value=!0,o.value=null,m.debug("create","Creando paciente r√°pido",s),!e.value?.id)throw new Error("Usuario no autenticado");if(!s.nombre_completo||s.nombre_completo.trim().length<2)return{success:!1,error:"El nombre debe tener al menos 2 caracteres"};if(!s.email||!s.email.includes("@"))return{success:!1,error:"Email inv√°lido"};let i=null;const{data:n}=await u.from("terapeutas").select("id").eq("id",e.value.id).maybeSingle();if(n?.id)i=n.id;else{const{data:b}=await u.from("terapeutas").select("id").eq("email",e.value.email).maybeSingle();b?.id&&(i=b.id)}if(!i)throw new Error("No se pudo obtener el perfil del terapeuta");const{data:h,error:g}=await u.from("pacientes").select("id, nombre_completo").eq("terapeuta_id",i).eq("email",s.email.trim().toLowerCase()).maybeSingle();if(g&&g.code!=="PGRST116")throw g;if(h)return{success:!1,error:`Ya existe un paciente con el email ${s.email}: ${h.nombre_completo}`};const{data:c,error:$}=await u.from("pacientes").insert({terapeuta_id:i,nombre_completo:s.nombre_completo.trim(),email:s.email.trim().toLowerCase(),telefono:s.telefono?.trim()||null,fecha_nacimiento:s.fecha_nacimiento||null,observaciones:s.observaciones?.trim()||null}).select().single();if($)throw $;const _={id:c.id,nombre_completo:c.nombre_completo,email:c.email,telefono:c.telefono,fecha_nacimiento:c.fecha_nacimiento,bonos_activos:0,sesiones_restantes_total:0,proximo_vencimiento:null};return t.value.unshift(_),p.value.clear(),m.info("create",`Paciente creado: ${c.id}`),{success:!0,data:_}}catch(i){const n=i.message||"Error al crear paciente";return o.value=n,m.error("api_error",n,i),{success:!1,error:n}}finally{a.value=!1}}async function I(){await w("")}function y(){r.value="",t.value=[],o.value=null}function P(){p.value.clear(),m.debug("cache","Cache invalidado")}q(r,s=>{k(s)});const B=S(()=>t.value.length>0),D=S(()=>a.value),R=S(()=>o.value!==null);return{pacientes:t,loading:D,error:R,searchQuery:r,hasPacientes:B,searchPacientes:w,debouncedSearch:k,createPaciente:C,loadAllPacientes:I,clearSearch:y,invalidateCache:P,clearError:()=>{o.value=null}}}export{m as a,j as u};
