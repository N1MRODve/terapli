import{u as a}from"./useSupabaseClient-DykwVqLQ.mjs";import{e}from"./server.mjs";import{u as i}from"./useSupabase-DljD0dj8.mjs";import{ref as o,computed as r}from"vue";const useNotificaciones=()=>{const t=a(),n=e(),{getUserId:s}=i(),l=o([]),c=o(!1),u=o(null),d=o(null),v=o(0),f=r(()=>l.value.filter(a=>!a.leido)),m=r(()=>f.value.filter(a=>{var e,i;return"bono"===a.tipo&&("alta"===(null==(e=a.metadata)?void 0:e.urgencia)||0===(null==(i=a.metadata)?void 0:i.sesiones_restantes))})),g=r(()=>m.value.length>0),marcarVista=async a=>{if(n.value)try{const{data:e,error:i}=await t.rpc("marcar_notificacion_leida",{p_notificacion_id:a});if(i)throw i;l.value=l.value.map(e=>e.id===a?{...e,leido:!0,leido_at:(new Date).toISOString()}:e),v.value=Math.max(0,v.value-1)}catch(a){console.error("Error al marcar notificaci칩n como le칤da:",a)}},marcarTodasVistas=async()=>{if(n.value)try{const{data:a,error:e}=await t.rpc("marcar_todas_notificaciones_leidas");if(e)throw e;return l.value=l.value.map(a=>({...a,leido:!0,leido_at:a.leido_at||(new Date).toISOString()})),v.value=0,{success:!0,marcadas:(null==a?void 0:a.marcadas)||0}}catch(a){return console.error("Error al marcar todas las notificaciones como le칤das:",a),{success:!1,error:a.message}}},contarNoVistas=async()=>{if(!n.value)return 0;try{const{data:a,error:e}=await t.rpc("contar_notificaciones_no_leidas");if(e)throw e;return v.value=a||0,a||0}catch(a){return console.error("Error al contar notificaciones no le칤das:",a),0}};return{notificaciones:l,totalNoVistas:v,loading:c,error:u,noLeidas:f,urgentes:m,tieneUrgentes:g,listar:async(a=20)=>{var e;const i=s();if(!i)return console.warn("Usuario no autenticado o ID no disponible"),u.value="Usuario no autenticado",[];c.value=!0,u.value=null;try{const{data:e,error:o}=await t.from("notificaciones").select("*").eq("usuario_id",i).order("created_at",{ascending:!1}).limit(a);if(o){if("PGRST116"===o.code||o.message.includes("does not exist"))return console.warn("丘멆잺 Tabla notificaciones no existe a칰n. Retornando vac칤o."),l.value=[],v.value=0,[];throw o}return l.value=e||[],v.value=(e||[]).filter(a=>!a.visto&&!a.leido).length,e||[]}catch(a){return(null==(e=a.message)?void 0:e.includes("does not exist"))||(u.value=a.message||"Error al cargar notificaciones",console.error("Error en listar notificaciones:",a)),[]}finally{c.value=!1}},crear:async(a,e,i,o="mensaje",r)=>{if(!n.value)return u.value="Usuario no autenticado",null;c.value=!0,u.value=null;try{const{data:n,error:s}=await t.from("notificaciones").insert({usuario_id:a,titulo:e,mensaje:i,tipo:o,referencia_id:r||null,visto:!1}).select().single();if(s)throw s;return n}catch(a){return u.value=a.message||"Error al crear notificaci칩n",console.error("Error en crear notificaci칩n:",a),null}finally{c.value=!1}},marcarVista:marcarVista,marcarComoLeida:marcarVista,marcarTodasVistas:marcarTodasVistas,marcarTodasComoLeidas:marcarTodasVistas,contarNoVistas:contarNoVistas,obtenerContador:contarNoVistas,eliminar:async a=>{if(n.value)try{const{error:e}=await t.from("notificaciones").delete().eq("id",a).eq("usuario_id",n.value.id);if(e)throw e;const i=l.value.find(e=>e.id===a);!i||i.leido||i.visto||(v.value=Math.max(0,v.value-1)),l.value=l.value.filter(e=>e.id!==a)}catch(a){console.error("Error al eliminar notificaci칩n:",a)}},eliminarVistas:async()=>{if(n.value)try{const{error:a}=await t.from("notificaciones").delete().eq("usuario_id",n.value.id).eq("leido",!0);if(a)throw a;l.value=l.value.filter(a=>!a.leido)}catch(a){console.error("Error al eliminar notificaciones vistas:",a)}},suscribirse:()=>{n.value&&!d.value&&(d.value=t.channel(`notificaciones:${n.value.id}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"notificaciones",filter:`usuario_id=eq.${n.value.id}`},a=>{var e;const i=a.new;l.value.unshift(i),v.value++,"Notification"in void 0&&"granted"===Notification.permission&&new Notification(i.titulo,{body:i.mensaje,icon:"/icon-notification.png",badge:"bono"===i.tipo&&"alta"===(null==(e=i.metadata)?void 0:e.urgencia)?"游댮":"游댒"})}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"notificaciones",filter:`usuario_id=eq.${n.value.id}`},a=>{const e=a.new,i=l.value.findIndex(a=>a.id===e.id);-1!==i&&(l.value[i]=e)}).subscribe())},desuscribirse:async()=>{d.value&&(await t.removeChannel(d.value),d.value=null)},solicitarPermisosNotificaciones:async()=>{"Notification"in void 0&&"default"===Notification.permission&&await Notification.requestPermission()}}};export{useNotificaciones as u};
//# sourceMappingURL=useNotificaciones-CrhSSwYp.mjs.map
