import{e,v as t}from"./server.mjs";import{u as a}from"./useSupabaseClient-DykwVqLQ.mjs";const o=new class{enabled=!0;minLevel="debug";sessionId;buffer=[];maxBufferSize=100;constructor(){this.sessionId=this.generateSessionId(),this.minLevel="warn"}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}shouldLog(e){if(!this.enabled)return!1;const t=["debug","info","warn","error"],a=t.indexOf(this.minLevel);return t.indexOf(e)>=a}formatMessage(e){return`${new Date(e.timestamp).toLocaleTimeString("es-ES")} ${`[AGENDA ${e.event.toUpperCase()}]`} ${e.message}`}log(e,t,a,o){if(!this.shouldLog(e))return;const n={timestamp:(new Date).toISOString(),level:e,event:t,message:a,data:o,sessionId:this.sessionId};this.buffer.push(n),this.buffer.length>this.maxBufferSize&&this.buffer.shift();const i=this.formatMessage(n);switch(e){case"debug":console.log(`üîç ${i}`,o||"");break;case"info":console.info(`‚ÑπÔ∏è ${i}`,o||"");break;case"warn":console.warn(`‚ö†Ô∏è ${i}`,o||"");break;case"error":console.error(`‚ùå ${i}`,o||""),n.stack&&console.error("Stack trace:",n.stack)}}debug(e,t,a){this.log("debug",e,t,a)}info(e,t,a){this.log("info",e,t,a)}warn(e,t,a){this.log("warn",e,t,a)}error(e,t,a){const o=a instanceof Error?{name:a.name,message:a.message,stack:a.stack}:a,n={timestamp:(new Date).toISOString(),level:"error",event:e,message:t,data:o,sessionId:this.sessionId,stack:a instanceof Error?a.stack:void 0};this.buffer.push(n),this.buffer.length>this.maxBufferSize&&this.buffer.shift(),console.error(`‚ùå ${this.formatMessage(n)}`,o||""),n.stack&&console.error("Stack trace:",n.stack)}loadRange(e,t,a){this.info("load_range",`Cargadas ${a} citas`,{from:e,to:t,count:a})}create(e,t,a){this.info("create",`Cita creada: ${e}`,{appointmentId:e,date:t,time:a})}update(e,t){this.info("update",`Cita actualizada: ${e}`,{appointmentId:e,changes:t})}move(e,t,a){this.info("move",`Cita movida: ${e}`,{appointmentId:e,from:t,to:a})}statusChange(e,t,a){this.info("status_change",`Estado cambiado: ${t} ‚Üí ${a}`,{appointmentId:e,from:t,to:a})}conflict(e,t,a,o){this.warn("conflict","Conflicto de horario detectado",{appointmentId:e,conflictWith:t,date:a,time:o})}apiError(e,t){this.error("api_error",`Error en API: ${e}`,t instanceof Error?t:{message:t})}realtimeEvent(e,t){this.debug("realtime_event",`Evento en tiempo real: ${e}`,t)}optimisticUpdate(e,t){this.debug("optimistic_update",`Actualizaci√≥n optimista: ${t}`,{appointmentId:e,action:t})}rollback(e,t){this.warn("rollback",`Rollback de cambio: ${t}`,{appointmentId:e,reason:t})}dragStart(e,t){this.debug("drag_start",`Inicio de drag: ${e}`,{appointmentId:e,from:t})}dragEnd(e,t,a){a?this.debug("drag_end","Drag completado exitosamente",{appointmentId:e,to:t}):this.warn("drag_end","Drag cancelado o fallido",{appointmentId:e,to:t})}clickCreate(e,t){this.debug("click_create","Click para crear cita",{date:e,time:t})}filterChange(e){this.debug("filter_change","Filtros actualizados",{filters:e})}getBuffer(){return[...this.buffer]}clearBuffer(){this.buffer=[]}downloadLogs(){const e=this.buffer.map(e=>JSON.stringify(e)).join("\n"),t=new Blob([e],{type:"application/json"}),a=URL.createObjectURL(t),o=(void 0).createElement("a");o.href=a,o.download=`agenda-logs-${this.sessionId}.json`,o.click(),URL.revokeObjectURL(a)}setEnabled(e){this.enabled=e}setMinLevel(e){this.minLevel=e}getSessionId(){return this.sessionId}};function usePacientes(){const n=a(),i=e(),r=t.ref([]),s=t.ref(!1),c=t.ref(null),l=t.ref(""),d=t.ref(null),u=t.ref(new Map);async function searchPacientes(e){try{s.value=!0,c.value=null;const t=e.trim().toLowerCase(),a=u.value.get(t);if(a)return r.value=a,void o.debug("search",`Resultados desde cache: ${a.length}`);if(o.debug("search",`Buscando pacientes: "${t}"`),!i.value?.id)throw new Error("Usuario no autenticado");let l=null;const{data:d}=await n.from("terapeutas").select("id").eq("id",i.value.id).maybeSingle();if(d?.id)l=d.id;else{const{data:e}=await n.from("terapeutas").select("id").eq("email",i.value.email).maybeSingle();e?.id&&(l=e.id)}if(!l)throw new Error("No se pudo obtener el perfil del terapeuta");let m=n.from("pacientes").select("\n          id,\n          nombre_completo,\n          email,\n          telefono,\n          fecha_nacimiento,\n          bonos(\n            id,\n            sesiones_restantes,\n            fecha_fin,\n            estado\n          )\n        ").eq("terapeuta_id",l);t.length>0&&(m=m.or(`nombre_completo.ilike.%${t}%,email.ilike.%${t}%,telefono.ilike.%${t}%`));const{data:f,error:h}=await m.order("nombre_completo",{ascending:!0}).limit(50);if(h)throw h;const p=(f||[]).map(e=>{const t=(e.bonos||[]).filter(e=>"activo"===e.estado&&e.sesiones_restantes>0),a=t.reduce((e,t)=>e+(t.sesiones_restantes||0),0),o=t.filter(e=>e.fecha_fin).map(e=>new Date(e.fecha_fin).getTime()).sort()[0]||null;return{id:e.id,nombre_completo:e.nombre_completo,email:e.email,telefono:e.telefono,fecha_nacimiento:e.fecha_nacimiento,bonos_activos:t.length,sesiones_restantes_total:a,proximo_vencimiento:o?new Date(o).toISOString():null}});r.value=p,u.value.set(t,p),setTimeout(()=>{u.value.delete(t)},3e5),o.info("search",`Pacientes encontrados: ${p.length}`)}catch(e){const t=e.message||"Error al buscar pacientes";c.value=t,o.error("api_error",t,e),r.value=[]}finally{s.value=!1}}function debouncedSearch(e,t=300){d.value&&clearTimeout(d.value),0!==e.trim().length?d.value=setTimeout(()=>{searchPacientes(e)},t):searchPacientes(e)}t.watch(l,e=>{debouncedSearch(e)});const m=t.computed(()=>r.value.length>0),f=t.computed(()=>s.value),h=t.computed(()=>null!==c.value);return{pacientes:r,loading:f,error:h,searchQuery:l,hasPacientes:m,searchPacientes:searchPacientes,debouncedSearch:debouncedSearch,createPaciente:async function(e){try{if(s.value=!0,c.value=null,o.debug("create","Creando paciente r√°pido",e),!i.value?.id)throw new Error("Usuario no autenticado");if(!e.nombre_completo||e.nombre_completo.trim().length<2)return{success:!1,error:"El nombre debe tener al menos 2 caracteres"};if(!e.email||!e.email.includes("@"))return{success:!1,error:"Email inv√°lido"};let t=null;const{data:a}=await n.from("terapeutas").select("id").eq("id",i.value.id).maybeSingle();if(a?.id)t=a.id;else{const{data:e}=await n.from("terapeutas").select("id").eq("email",i.value.email).maybeSingle();e?.id&&(t=e.id)}if(!t)throw new Error("No se pudo obtener el perfil del terapeuta");const{data:l,error:d}=await n.from("pacientes").select("id, nombre_completo").eq("terapeuta_id",t).eq("email",e.email.trim().toLowerCase()).maybeSingle();if(d&&"PGRST116"!==d.code)throw d;if(l)return{success:!1,error:`Ya existe un paciente con el email ${e.email}: ${l.nombre_completo}`};const{data:m,error:f}=await n.from("pacientes").insert({terapeuta_id:t,nombre_completo:e.nombre_completo.trim(),email:e.email.trim().toLowerCase(),telefono:e.telefono?.trim()||null,fecha_nacimiento:e.fecha_nacimiento||null,observaciones:e.observaciones?.trim()||null}).select().single();if(f)throw f;const h={id:m.id,nombre_completo:m.nombre_completo,email:m.email,telefono:m.telefono,fecha_nacimiento:m.fecha_nacimiento,bonos_activos:0,sesiones_restantes_total:0,proximo_vencimiento:null};return r.value.unshift(h),u.value.clear(),o.info("create",`Paciente creado: ${m.id}`),{success:!0,data:h}}catch(e){const t=e.message||"Error al crear paciente";return c.value=t,o.error("api_error",t,e),{success:!1,error:t}}finally{s.value=!1}},loadAllPacientes:async function(){await searchPacientes("")},clearSearch:function(){l.value="",r.value=[],c.value=null},invalidateCache:function(){u.value.clear(),o.debug("cache","Cache invalidado")},clearError:()=>{c.value=null}}}export{o as a,usePacientes as u};
//# sourceMappingURL=usePacientes-C1psUwyL.mjs.map
