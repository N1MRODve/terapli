import{u as e}from"./useSupabaseClient-DykwVqLQ.mjs";import{e as a,f as o}from"./server.mjs";import{computed as r,readonly as l}from"vue";let s=!1;const useSupabase=()=>{const n=e(),t=a(),i=o("supabase-session",()=>null),u=o("user-profile",()=>null),loadUserProfile=async()=>{var e,a;if(u.value)return u.value;if(s){let e=0;for(;s&&e<50;)await new Promise(e=>setTimeout(e,100)),e++;if(u.value)return u.value}s=!0;try{let o=0;for(;!t.value&&o<10;)await new Promise(e=>setTimeout(e,100)),o++;const r=(null==(e=t.value)?void 0:e.id)||(null==(a=t.value)?void 0:a.sub);if(!r)return console.warn("[useSupabase] No hay usuario autenticado o ID invÃ¡lido despuÃ©s de esperar"),console.warn("[useSupabase] user.value:",t.value),u.value=null,null;console.log("[useSupabase] Cargando perfil para usuario:",r);const{data:l,error:s}=await n.from("profiles").select("*").eq("id",r).single();return s?(console.error("[useSupabase] Error al cargar perfil:",s),console.error("[useSupabase] Error code:",s.code),console.error("[useSupabase] Error message:",s.message),console.error("[useSupabase] Error details:",s.details),console.error("[useSupabase] User ID:",r),u.value=null,null):l?(u.value=l,console.log("[useSupabase] âœ… Perfil cargado correctamente:",l.email,"Rol:",l.rol),"psicologa"===l.rol&&await syncTerapeutaProfile(l),l):(console.warn("[useSupabase] No se encontrÃ³ perfil para el usuario:",r),console.warn("[useSupabase] El usuario existe en auth pero no tiene perfil en la tabla profiles"),u.value=null,null)}catch(e){return console.error("[useSupabase] Error en loadUserProfile:",e),u.value=null,null}finally{s=!1}},syncTerapeutaProfile=async e=>{try{if(console.log("[Sync] Verificando sincronizaciÃ³n con tabla terapeutas..."),!e.email)return void console.warn("[Sync] No se puede sincronizar: email faltante");const a=n,{data:o,error:r}=await a.from("terapeutas").select("*").eq("email",e.email).maybeSingle();if(r&&"PGRST116"!==r.code)return void console.warn("[Sync] Error al buscar terapeuta:",r);const l={id:e.id,nombre_completo:e.nombre||e.email.split("@")[0]||"PsicÃ³loga",email:e.email,telefono:null,especialidad:null,num_colegiada:null,disponibilidad:null,activo:!0,metadata:{sincronizado_desde_profile:!0,ultima_sincronizacion:(new Date).toISOString()}};if(o){if(o.nombre_completo!==l.nombre_completo||o.email!==l.email||!o.activo){console.log("[Sync] Actualizando registro existente en tabla terapeutas...");const{error:o}=await a.from("terapeutas").update({nombre_completo:l.nombre_completo,email:l.email,activo:!0,metadata:l.metadata}).eq("id",e.id);o?console.warn("[Sync] No se pudo actualizar el terapeuta:",o):console.log("[Sync] âœ… Terapeuta actualizado correctamente")}else console.log("[Sync] âœ… Terapeuta ya estÃ¡ sincronizado correctamente")}else{console.log("[Sync] Creando nuevo registro en tabla terapeutas...");const{error:o}=await a.from("terapeutas").insert(l);if(o)if("23505"===o.code){console.log("[Sync] El terapeuta ya existe por ID, actualizando...");const{error:o}=await a.from("terapeutas").update({nombre_completo:l.nombre_completo,email:l.email,activo:!0,metadata:l.metadata}).eq("id",e.id);o?console.warn("[Sync] No se pudo actualizar el terapeuta:",o):console.log("[Sync] âœ… Terapeuta actualizado correctamente")}else console.warn("[Sync] No se pudo insertar el terapeuta:",o);else console.log("[Sync] âœ… Terapeuta creado correctamente en la tabla terapeutas")}}catch(e){console.warn("[Sync] Error al sincronizar terapeuta:",e)}};return{supabase:n,user:l(t),session:l(i),userProfile:l(u),signInWithEmail:async(e,a)=>{console.log("ðŸ§¹ [Auth] Limpiando estado antes del login..."),u.value=null,i.value=null,s=!1;const{data:o,error:r}=await n.auth.signInWithPassword({email:e,password:a});return!r&&o.session&&(console.log("âœ… [Auth] Login exitoso, estableciendo nueva sesiÃ³n"),i.value=o.session),{data:o,error:r}},signUpWithEmail:async(e,a,o)=>{const{data:r,error:l}=await n.auth.signUp({email:e,password:a,options:{data:o}});return{data:r,error:l}},signOut:async()=>{console.log("ðŸšª [Auth] Iniciando cierre de sesiÃ³n...");const{error:e}=await n.auth.signOut();return e?console.error("âŒ [Auth] Error al cerrar sesiÃ³n:",e):(console.log("âœ… [Auth] SesiÃ³n cerrada en Supabase, limpiando estado local..."),i.value=null,u.value=null,s=!1,console.log("ðŸ§¹ [Auth] Estado completamente limpiado")),{error:e}},resetPassword:async e=>{const{data:a,error:o}=await n.auth.resetPasswordForEmail(e,{redirectTo:`${(void 0).location.origin}/reset-password`});return{data:a,error:o}},updatePassword:async e=>{const{data:a,error:o}=await n.auth.updateUser({password:e});return{data:a,error:o}},loadUserProfile:loadUserProfile,getUserRole:async()=>{var e,a;if(!((null==(e=t.value)?void 0:e.id)||(null==(a=t.value)?void 0:a.sub)))return console.warn("[useSupabase] getUserRole: No hay usuario autenticado"),null;if(u.value)return u.value.rol;const o=await loadUserProfile();return(null==o?void 0:o.rol)||null},waitForUser:async(e=20)=>{let a=0;for(;!t.value&&a<e;)await new Promise(e=>setTimeout(e,100)),a++;return t.value},getUserId:()=>{var e,a;return(null==(e=t.value)?void 0:e.id)||(null==(a=t.value)?void 0:a.sub)||null},isAuthenticated:r(()=>!!t.value)}};export{useSupabase as u};
//# sourceMappingURL=useSupabase-DljD0dj8.mjs.map
