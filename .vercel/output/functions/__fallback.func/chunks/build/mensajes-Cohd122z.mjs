import{v as e,e as a,s as t}from"./server.mjs";import{_ as r}from"./_plugin-vue_export-helper-1tPrXgE0.mjs";import{u as s}from"./useSupabaseClient-DykwVqLQ.mjs";import{u as o}from"./useSupabase-DfFg84CY.mjs";import"../routes/renderer.mjs";import"../nitro/nitro.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"../_/shared.cjs.prod.mjs";import"../virtual/_commonjsHelpers.mjs";import"node:stream";import"../_/index2.mjs";import"@supabase/supabase-js";import"@vercel/analytics/nuxt";const n=e.defineComponent({__name:"MensajeCard",__ssrInlineRender:!0,props:{texto:{},fecha:{},remitente:{type:Boolean},visto:{type:Boolean,default:!1}},setup:a=>(r,s,o,n)=>{s(`<div${t.ssrRenderAttrs(e.mergeProps({class:["p-4 rounded-lg max-w-[80%] transition-all duration-200",a.remitente?"bg-[#E2E8F0]/50 self-end text-right ml-auto":"bg-white border border-[#E2E8F0]/40 self-start shadow-sm"]},n))} data-v-b70acf2d><p class="text-[#2D3748] font-sans text-sm leading-relaxed whitespace-pre-wrap break-words" data-v-b70acf2d>${t.ssrInterpolate(a.texto)}</p><div class="${t.ssrRenderClass([a.remitente?"justify-end":"justify-start","flex items-center gap-2 mt-2"])}" data-v-b70acf2d><p class="text-[10px] text-[#2D3748]/50 font-sans" data-v-b70acf2d>${t.ssrInterpolate((e=>{const a="string"==typeof e?new Date(e):e,t=new Date,r=t.getTime()-a.getTime(),s=Math.floor(r/6e4),o=Math.floor(r/36e5),n=Math.floor(r/864e5);return s<1?"Ahora":s<60?`Hace ${s}m`:o<24?`Hace ${o}h`:n<7?`Hace ${n}d`:a.toLocaleDateString("es-ES",{day:"2-digit",month:"short",year:a.getFullYear()!==t.getFullYear()?"numeric":void 0})})(a.fecha))}</p>`),a.remitente&&!a.visto?s('<span class="inline-block w-2 h-2 bg-[#5550F2] rounded-full" title="Enviado" data-v-b70acf2d></span>'):s("\x3c!----\x3e"),s("</div></div>")}}),i=n.setup;n.setup=(a,t)=>{const r=e.useSSRContext();return(r.modules||(r.modules=new Set)).add("components/MensajeCard.vue"),i?i(a,t):void 0};const d=Object.assign(r(n,[["__scopeId","data-v-b70acf2d"]]),{__name:"MensajeCard"}),useMensajes=()=>{const t=s(),r=a(),o=e.ref([]),n=e.ref([]),i=e.ref(!1),d=e.ref(null),l=e.ref(null),listarConversacionesAlternativo=async()=>{if(!r.value)return[];try{const{data:e,error:a}=await t.from("mensajes").select("\n          *,\n          remitente:profiles!mensajes_remitente_id_fkey(id, nombre, avatar_url),\n          destinatario:profiles!mensajes_destinatario_id_fkey(id, nombre, avatar_url)\n        ").or(`remitente_id.eq.${r.value.id},destinatario_id.eq.${r.value.id}`).order("created_at",{ascending:!1});if(a)throw a;const s=new Map;return e?.forEach(e=>{const a=e.remitente_id===r.value.id,t=a?e.destinatario_id:e.remitente_id,o=a?e.destinatario:e.remitente;if(s.has(t)||s.set(t,{otro_usuario_id:t,otro_usuario_nombre:o?.nombre||"Usuario",otro_usuario_avatar:o?.avatar_url,ultimo_mensaje:e.mensaje,ultimo_mensaje_fecha:e.created_at,mensajes_no_vistos:0}),!a&&!e.visto){s.get(t).mensajes_no_vistos++}}),n.value=Array.from(s.values()),n.value}catch(e){return d.value=e.message||"Error al cargar conversaciones",console.error("Error en listarConversacionesAlternativo:",e),[]}};return{mensajes:o,conversaciones:n,loading:i,error:d,listarConversacion:async e=>{if(!r.value)return d.value="Usuario no autenticado",[];i.value=!0,d.value=null;try{const{data:a,error:s}=await t.from("mensajes").select("\n          *,\n          remitente:profiles!mensajes_remitente_id_fkey(id, nombre, avatar_url, rol),\n          destinatario:profiles!mensajes_destinatario_id_fkey(id, nombre, avatar_url, rol)\n        ").or(`and(remitente_id.eq.${r.value.id},destinatario_id.eq.${e}),and(remitente_id.eq.${e},destinatario_id.eq.${r.value.id})`).order("created_at",{ascending:!0});if(s)throw s;return o.value=a||[],a||[]}catch(e){return d.value=e.message||"Error al cargar conversación",console.error("Error en listarConversacion:",e),[]}finally{i.value=!1}},enviar:async(e,a,s)=>{if(!r.value)return d.value="Usuario no autenticado",null;if(!a.trim())return d.value="El mensaje no puede estar vacío",null;i.value=!0,d.value=null;try{const{data:n,error:i}=await t.from("mensajes").insert({remitente_id:r.value.id,destinatario_id:e,mensaje:a.trim(),sesion_id:s||null,visto:!1}).select("\n          *,\n          remitente:profiles!mensajes_remitente_id_fkey(id, nombre, avatar_url, rol),\n          destinatario:profiles!mensajes_destinatario_id_fkey(id, nombre, avatar_url, rol)\n        ").single();if(i)throw i;return n&&o.value.push(n),n}catch(e){return d.value=e.message||"Error al enviar mensaje",console.error("Error en enviar:",e),null}finally{i.value=!1}},marcarVistos:async e=>{if(r.value)try{const{error:a}=await t.from("mensajes").update({visto:!0}).eq("destinatario_id",r.value.id).eq("remitente_id",e).eq("visto",!1);if(a)throw a;o.value=o.value.map(a=>a.remitente_id===e&&a.destinatario_id===r.value.id?{...a,visto:!0}:a)}catch(e){console.error("Error al marcar mensajes como vistos:",e)}},listarConversaciones:async()=>{if(!r.value)return d.value="Usuario no autenticado",[];i.value=!0,d.value=null;try{const{data:e,error:a}=await t.rpc("obtener_ultimas_conversaciones",{usuario_id:r.value.id});if(a)throw a;return n.value=e||[],e||[]}catch(e){return console.warn("Usando método alternativo para conversaciones:",e),await listarConversacionesAlternativo()}finally{i.value=!1}},contarNoVistos:async()=>{if(!r.value)return 0;try{const{count:e,error:a}=await t.from("mensajes").select("*",{count:"exact",head:!0}).eq("destinatario_id",r.value.id).eq("visto",!1);if(a)throw a;return e||0}catch(e){return console.error("Error al contar mensajes no vistos:",e),0}},suscribirseAConversacion:e=>{r.value&&!l.value&&(l.value=t.channel(`mensajes:${r.value.id}:${e}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"mensajes",filter:`destinatario_id=eq.${r.value.id}`},async e=>{const{data:a}=await t.from("mensajes").select("\n              *,\n              remitente:profiles!mensajes_remitente_id_fkey(id, nombre, avatar_url, rol),\n              destinatario:profiles!mensajes_destinatario_id_fkey(id, nombre, avatar_url, rol)\n            ").eq("id",e.new.id).single();a&&o.value.push(a)}).subscribe())},desuscribirse:async()=>{l.value&&(await t.removeChannel(l.value),l.value=null)}}},l=e.defineComponent({__name:"MensajeInput",__ssrInlineRender:!0,props:{destinatarioId:{},placeholder:{default:"Escribe tu mensaje aquí..."}},emits:["mensajeEnviado"],setup(a,{emit:r}){useMensajes();const s=e.ref(""),o=e.ref(!1);e.ref(null);const n=e.computed(()=>{const e=s.value.trim();return e.length>0&&e.length<=2e3&&!o.value});return(r,i,d,l)=>{i(`<div${t.ssrRenderAttrs(e.mergeProps({class:"flex items-end gap-3 border-t border-[#E2E8F0]/30 pt-4 bg-[#F2F2F2]"},l))} data-v-9ee6d4b7><div class="flex-1 relative" data-v-9ee6d4b7><textarea${t.ssrRenderAttr("placeholder",a.placeholder)} class="${t.ssrRenderClass([{"opacity-50 cursor-not-allowed":o.value},"w-full border border-[#E2E8F0]/40 rounded-lg p-3 bg-white resize-none text-sm text-[#2D3748] font-sans focus:outline-none focus:ring-2 focus:ring-[#5550F2]/50 focus:border-[#5550F2] transition-all"])}"${t.ssrIncludeBooleanAttr(o.value)?" disabled":""} rows="1" style="${t.ssrRenderStyle({"min-height":"44px","max-height":"120px"})}" data-v-9ee6d4b7>${t.ssrInterpolate(s.value)}</textarea>`),s.value.length>0?i(`<div class="absolute bottom-2 right-2 text-[10px] text-[#2D3748]/40 font-sans" data-v-9ee6d4b7>${t.ssrInterpolate(s.value.length)}/2000 </div>`):i("\x3c!----\x3e"),i(`</div><button${t.ssrIncludeBooleanAttr(!n.value||o.value)?" disabled":""} class="${t.ssrRenderClass([{"animate-pulse":o.value},"bg-[#5550F2] hover:bg-[#C89B8A] text-white px-5 py-3 rounded-lg transition-all duration-200 font-sans text-sm font-medium disabled:opacity-40 disabled:cursor-not-allowed flex items-center gap-2 shadow-sm hover:shadow-md"])}" data-v-9ee6d4b7>`),o.value?i("\x3c!----\x3e"):i('<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-9ee6d4b7><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" data-v-9ee6d4b7></path></svg>'),o.value?i("<span data-v-9ee6d4b7>Enviando...</span>"):i("<span data-v-9ee6d4b7>Enviar</span>"),i("</button></div>")}}}),u=l.setup;l.setup=(a,t)=>{const r=e.useSSRContext();return(r.modules||(r.modules=new Set)).add("components/MensajeInput.vue"),u?u(a,t):void 0};const v=Object.assign(r(l,[["__scopeId","data-v-9ee6d4b7"]]),{__name:"MensajeInput"}),c=e.defineComponent({__name:"mensajes",__ssrInlineRender:!0,setup(r){const{conversaciones:s,mensajes:n,loading:i,listarConversaciones:l}=useMensajes();a();const{getUserId:u}=o(),c=e.ref(null),m=e.ref(null),esMensajeMio=e=>e.remitente_id===u(),handleMensajeEnviado=()=>{e.nextTick(()=>{m.value&&(m.value.scrollTop=m.value.scrollHeight)})},obtenerIniciales=e=>e.split(" ").map(e=>e[0]).slice(0,2).join("").toUpperCase();return e.watch(n,()=>{n.value.length>0&&l()},{deep:!0}),(a,r,o,l)=>{const u=d,m=v;r(`<div${t.ssrRenderAttrs(e.mergeProps({class:"flex h-[calc(100vh-8rem)] max-w-7xl mx-auto px-4 py-8 gap-6"},l))} data-v-93d7722a><aside class="${t.ssrRenderClass([{"hidden lg:block":e.unref(c)},"w-80 bg-white rounded-xl shadow-sm border border-[#EAD5D3]/30 overflow-hidden flex-shrink-0"])}" data-v-93d7722a><div class="px-4 py-5 border-b border-[#EAD5D3]/30 bg-[#F9F7F3]" data-v-93d7722a><h2 class="text-lg font-lora font-semibold text-[#5D4A44]" data-v-93d7722a> Conversaciones </h2><p class="text-xs text-[#5D4A44]/60 font-lato mt-1" data-v-93d7722a>${t.ssrInterpolate(e.unref(s).length)} pacientes </p></div><div class="overflow-y-auto h-[calc(100%-5rem)]" data-v-93d7722a>`),e.unref(i)?r('<div class="p-8 text-center" data-v-93d7722a><div class="inline-block w-8 h-8 border-4 border-[#EAD5D3] border-t-[#D8AFA0] rounded-full animate-spin" data-v-93d7722a></div></div>'):0===e.unref(s).length?r('<div class="p-8 text-center text-[#5D4A44]/60 font-lato text-sm" data-v-93d7722a><svg class="w-12 h-12 mx-auto mb-3 text-[#EAD5D3]" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-93d7722a><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" data-v-93d7722a></path></svg><p data-v-93d7722a>No tienes conversaciones activas</p></div>'):r("\x3c!----\x3e"),r("\x3c!--[--\x3e"),t.ssrRenderList(e.unref(s),a=>{r(`<button class="${t.ssrRenderClass([{"bg-[#EAD5D3]/20 hover:bg-[#EAD5D3]/30":e.unref(c)?.otro_usuario_id===a.otro_usuario_id},"w-full px-4 py-4 hover:bg-[#F9F7F3] transition-colors border-b border-[#EAD5D3]/20 text-left group"])}" data-v-93d7722a><div class="flex items-start gap-3" data-v-93d7722a><div class="flex-shrink-0" data-v-93d7722a>`),a.otro_usuario_avatar?r(`<div class="w-12 h-12 rounded-full overflow-hidden" data-v-93d7722a><img${t.ssrRenderAttr("src",a.otro_usuario_avatar)}${t.ssrRenderAttr("alt",a.otro_usuario_nombre)} class="w-full h-full object-cover" data-v-93d7722a></div>`):r(`<div class="w-12 h-12 rounded-full bg-[#D8AFA0]/30 flex items-center justify-center" data-v-93d7722a><span class="text-[#5D4A44] font-lora text-lg font-medium" data-v-93d7722a>${t.ssrInterpolate(obtenerIniciales(a.otro_usuario_nombre))}</span></div>`),r(`</div><div class="flex-1 min-w-0" data-v-93d7722a><div class="flex items-start justify-between gap-2" data-v-93d7722a><h3 class="${t.ssrRenderClass([{"font-semibold":a.mensajes_no_vistos>0},"text-sm font-medium text-[#5D4A44] font-lato truncate"])}" data-v-93d7722a>${t.ssrInterpolate(a.otro_usuario_nombre)}</h3><span class="text-xs text-[#5D4A44]/50 font-lato flex-shrink-0" data-v-93d7722a>${t.ssrInterpolate((e=>{const a=new Date(e),t=(new Date).getTime()-a.getTime(),r=Math.floor(t/6e4),s=Math.floor(t/36e5),o=Math.floor(t/864e5);return r<1?"Ahora":r<60?`${r}m`:s<24?`${s}h`:o<7?`${o}d`:a.toLocaleDateString("es-ES",{day:"2-digit",month:"short"})})(a.ultimo_mensaje_fecha))}</span></div><p class="${t.ssrRenderClass([{"font-medium":a.mensajes_no_vistos>0},"text-xs text-[#5D4A44]/70 font-lato mt-1 truncate"])}" data-v-93d7722a>${t.ssrInterpolate(a.ultimo_mensaje)}</p>`),a.mensajes_no_vistos>0?r(`<div class="inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-[#D8AFA0] rounded-full mt-2" data-v-93d7722a>${t.ssrInterpolate(a.mensajes_no_vistos)}</div>`):r("\x3c!----\x3e"),r("</div></div></button>")}),r('\x3c!--]--\x3e</div></aside><main class="flex-1 flex flex-col bg-white rounded-xl shadow-sm border border-[#EAD5D3]/30 overflow-hidden" data-v-93d7722a>'),e.unref(c)?(r('<div class="flex-1 flex flex-col" data-v-93d7722a><header class="px-6 py-4 border-b border-[#EAD5D3]/30 bg-[#F9F7F3] flex items-center gap-4" data-v-93d7722a><button class="lg:hidden p-2 -ml-2 rounded-lg hover:bg-white/50 transition-colors" data-v-93d7722a><svg class="w-5 h-5 text-[#5D4A44]" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-93d7722a><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" data-v-93d7722a></path></svg></button><div class="flex items-center gap-3 flex-1" data-v-93d7722a>'),e.unref(c).otro_usuario_avatar?r(`<div class="w-10 h-10 rounded-full overflow-hidden" data-v-93d7722a><img${t.ssrRenderAttr("src",e.unref(c).otro_usuario_avatar)}${t.ssrRenderAttr("alt",e.unref(c).otro_usuario_nombre)} class="w-full h-full object-cover" data-v-93d7722a></div>`):r(`<div class="w-10 h-10 rounded-full bg-[#D8AFA0]/30 flex items-center justify-center" data-v-93d7722a><span class="text-[#5D4A44] font-lora text-sm font-medium" data-v-93d7722a>${t.ssrInterpolate(obtenerIniciales(e.unref(c).otro_usuario_nombre))}</span></div>`),r(`<div data-v-93d7722a><h2 class="text-base font-lato font-semibold text-[#5D4A44]" data-v-93d7722a>${t.ssrInterpolate(e.unref(c).otro_usuario_nombre)}</h2><p class="text-xs text-[#5D4A44]/60 font-lato" data-v-93d7722a> Paciente </p></div></div></header><div class="flex-1 overflow-y-auto p-6 space-y-3 bg-[#F9F7F3]/30" data-v-93d7722a>`),e.unref(i)?r('<div class="flex items-center justify-center h-full" data-v-93d7722a><div class="inline-block w-8 h-8 border-4 border-[#EAD5D3] border-t-[#D8AFA0] rounded-full animate-spin" data-v-93d7722a></div></div>'):(r("\x3c!--[--\x3e"),t.ssrRenderList(e.unref(n),e=>{r(t.ssrRenderComponent(u,{key:e.id,texto:e.mensaje,fecha:e.created_at,remitente:esMensajeMio(e),visto:e.visto},null,o))}),r("\x3c!--]--\x3e")),r('</div><div class="px-6 py-4 border-t border-[#EAD5D3]/30 bg-white" data-v-93d7722a>'),e.unref(c)?r(t.ssrRenderComponent(m,{"destinatario-id":e.unref(c).otro_usuario_id,placeholder:"Escribe tu respuesta con calma...",onMensajeEnviado:handleMensajeEnviado},null,o)):r("\x3c!----\x3e"),r("</div></div>")):r('<div class="flex-1 flex flex-col items-center justify-center p-8 text-center" data-v-93d7722a><div class="w-24 h-24 rounded-full bg-[#EAD5D3]/30 flex items-center justify-center mb-6" data-v-93d7722a><svg class="w-12 h-12 text-[#D8AFA0]" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-93d7722a><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" data-v-93d7722a></path></svg></div><h3 class="text-xl font-lora font-medium text-[#5D4A44] mb-2" data-v-93d7722a> Selecciona una conversación </h3><p class="text-sm text-[#5D4A44]/60 font-lato max-w-md" data-v-93d7722a> Elige un paciente de la lista para ver su conversación y responder sus mensajes. </p></div>'),r("</main></div>")}}}),m=c.setup;c.setup=(a,t)=>{const r=e.useSSRContext();return(r.modules||(r.modules=new Set)).add("pages/terapeuta/mensajes.vue"),m?m(a,t):void 0};const f=r(c,[["__scopeId","data-v-93d7722a"]]);export{f as default};
//# sourceMappingURL=mensajes-Cohd122z.mjs.map
