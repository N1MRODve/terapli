import{v as e,a as t,e as a,s}from"./server.mjs";import{M as o}from"./ModalDetallesCita-DUTiJ_cw.mjs";import{u as r}from"./useSupabaseClient-DykwVqLQ.mjs";import{r as n}from"./PlusIcon-CHLzv-V9.mjs";import{r as i}from"./MagnifyingGlassIcon-GsbNDyPZ.mjs";import{r as l}from"./ExclamationTriangleIcon-DQdM2y0F.mjs";import{r as d}from"./CalendarDaysIcon-f8DhK37e.mjs";import{r as c}from"./ChevronRightIcon-4xxNHuWW.mjs";import{r as p}from"./CheckCircleIcon-CT9fzVFs.mjs";import{r as m}from"./ChevronDownIcon-CvdhRGll.mjs";import"../routes/renderer.mjs";import"../nitro/nitro.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"../_/shared.cjs.prod.mjs";import"../virtual/_commonjsHelpers.mjs";import"node:stream";import"../_/index2.mjs";import"@supabase/supabase-js";import"@vercel/analytics/nuxt";import"./useSupabase-DfFg84CY.mjs";import"./PaymentMethodSelector-B6WAV7CR.mjs";import"./XMarkIcon-DCLwyE-W.mjs";import"./PencilIcon-BKWXEWgS.mjs";import"./PhoneIcon-acGzPaDV.mjs";import"./ClockIcon-BxdFtPqx.mjs";import"./TicketIcon-zZdrc71S.mjs";import"./_plugin-vue_export-helper-1tPrXgE0.mjs";const u=e.defineComponent({__name:"index",__ssrInlineRender:!0,setup(u){t();const f=r(),g=a(),x=e.ref(!0),v=e.ref(null),b=e.ref([]),y=e.ref([]),h=e.ref(!1),_=e.ref(!1),w=e.ref(null),C=e.ref({busqueda:"",estado:"",periodo:"todos"}),I=[{valor:"hoy",label:"Hoy"},{valor:"semana",label:"Semana"},{valor:"mes",label:"Mes"},{valor:"todos",label:"Todos"}],D=e.computed(()=>""!==C.value.busqueda||""!==C.value.estado||"todos"!==C.value.periodo),$=e.computed(()=>{let e=[...b.value];if(C.value.busqueda){const t=C.value.busqueda.toLowerCase();e=e.filter(e=>e.paciente?.nombre_completo?.toLowerCase().includes(t))}C.value.estado&&(e=e.filter(e=>e.estado===C.value.estado));const t=new Date,a=new Date(t.getFullYear(),t.getMonth(),t.getDate());if("hoy"===C.value.periodo)e=e.filter(e=>new Date(e.fecha_cita).toDateString()===a.toDateString());else if("semana"===C.value.periodo){const t=new Date(a);t.setDate(a.getDate()-a.getDay()+1);const s=new Date(t);s.setDate(t.getDate()+6),e=e.filter(e=>{const a=new Date(e.fecha_cita);return a>=t&&a<=s})}else if("mes"===C.value.periodo){const a=new Date(t.getFullYear(),t.getMonth(),1),s=new Date(t.getFullYear(),t.getMonth()+1,0);e=e.filter(e=>{const t=new Date(e.fecha_cita);return t>=a&&t<=s})}return e.sort((e,t)=>{const a=new Date(e.fecha_cita+"T"+e.hora_inicio);return new Date(t.fecha_cita+"T"+t.hora_inicio).getTime()-a.getTime()}),e}),j=e.computed(()=>{const e={pendientes:0,confirmadas:0,completadas:0,canceladas:0,montoPendiente:0,montoConfirmado:0,montoCompletado:0,montoCancelado:0};return $.value.forEach(t=>{const a=t.monto_terapeuta||.7*(t.precio_estimado||50);switch(t.estado){case"pendiente":e.pendientes++,t.esta_pagado||t.bono?.pagado?e.montoConfirmado+=a:e.montoPendiente+=a;break;case"confirmada":e.confirmadas++,t.esta_pagado||t.bono?.pagado?e.montoConfirmado+=a:e.montoPendiente+=a;break;case"realizada":case"completada":e.completadas++,t.esta_pagado||t.bono?.pagado?e.montoConfirmado+=a:e.montoCompletado+=a;break;case"cancelada":e.canceladas++,e.montoCancelado+=a}}),e}),R=e.computed(()=>j.value.montoCompletado+j.value.montoPendiente),P=e.computed(()=>y.value.map(e=>{const t=(e.sesiones_totales||0)-(e.sesiones_restantes||0),a=.7*e.monto_total;return{bono_id:e.id,paciente_nombre:e.paciente_nombre,bono_sesiones_totales:e.sesiones_totales,bono_monto_total:e.monto_total,bono_fecha_pago:e.fecha_pago,tipo_bono:e.tipo_bono||"Estándar",sesiones_usadas:t,monto_total_terapeuta:a}}).sort((e,t)=>{const a=new Date(e.bono_fecha_pago||0);return new Date(t.bono_fecha_pago||0).getTime()-a.getTime()})),S=e.computed(()=>P.value.reduce((e,t)=>e+(t.monto_total_terapeuta||0),0)),cargarSesiones=async()=>{try{x.value=!0,v.value=null;let e=0;for(;!g.value&&e<50;)await new Promise(e=>setTimeout(e,100)),e++;if(!g.value)throw new Error("Usuario no autenticado");const{data:t,error:a}=await f.from("terapeutas").select("id").eq("email",g.value.email).single();if(a)throw a;if(!t)throw new Error("No se encontró el terapeuta");const{data:s,error:o}=await f.from("vista_agenda_terapeutas").select("*").eq("terapeuta_id",t.id).order("fecha_cita",{ascending:!1});if(o)throw o;b.value=(s||[]).map(e=>({id:e.cita_id,fecha_cita:e.fecha_cita,hora_inicio:e.hora_inicio,hora_fin:e.hora_fin,duracion_minutos:e.duracion_minutos,modalidad:e.modalidad,estado:e.estado,observaciones:e.observaciones,notas_terapeuta:e.notas_terapeuta,precio_estimado:e.cita_metadata?.precio_sesion||50,esta_pagado:"bono"===e.cita_metadata?.metodo_pago||"activo"===e.bono_estado,paciente:{id:e.paciente_id,nombre_completo:e.paciente_nombre,email:e.paciente_email},bono:e.bono_id?{id:e.bono_id,sesiones_totales:e.bono_sesiones_totales,sesiones_restantes:e.bono_sesiones_restantes,pagado:"activo"===e.bono_estado||"pagado"===e.bono_estado}:null}))}catch(e){v.value=e.message||"Error desconocido"}finally{x.value=!1}},cerrarModalDetalles=()=>{_.value=!1,w.value=null},formatearPrecio=e=>e?.toFixed(2)||"0.00",obtenerIniciales=e=>e?.split(" ").map(e=>e[0]).join("").toUpperCase().substring(0,2)||"??",obtenerColorPuntoEstado=e=>({pendiente:"bg-gray-400",confirmada:"bg-green-500",realizada:"bg-green-600",completada:"bg-green-600",cancelada:"bg-red-500"}[e]||"bg-gray-400");return(t,a,r,u)=>{a(`<div${s.ssrRenderAttrs(u)}><header class="mb-6"><div class="flex items-center justify-between mb-4"><h1 class="text-2xl font-semibold text-gray-900"> Sesiones <span class="text-gray-400 font-normal">(${s.ssrInterpolate(e.unref($).length)})</span></h1><button class="h-10 px-4 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-2 shadow-sm">`),a(s.ssrRenderComponent(e.unref(n),{class:"w-4 h-4"},null,r)),a(` Nueva Sesión </button></div><div class="bg-white border border-gray-100 rounded-lg p-4 mb-4"><div class="flex flex-wrap items-center gap-x-6 gap-y-2 text-sm"><div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-gray-400"></span><span class="text-gray-600">Pendientes:</span><span class="font-semibold text-gray-900">${s.ssrInterpolate(e.unref(j).pendientes)}</span><span class="text-gray-400">(${s.ssrInterpolate(formatearPrecio(e.unref(j).montoPendiente))}€)</span></div><span class="hidden sm:block text-gray-200">|</span><div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-500"></span><span class="text-gray-600">Confirmadas:</span><span class="font-semibold text-gray-900">${s.ssrInterpolate(e.unref(j).confirmadas)}</span><span class="text-gray-400">(${s.ssrInterpolate(formatearPrecio(e.unref(j).montoConfirmado))}€)</span></div><span class="hidden sm:block text-gray-200">|</span><div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-600"></span><span class="text-gray-600">Realizadas:</span><span class="font-semibold text-gray-900">${s.ssrInterpolate(e.unref(j).completadas)}</span><span class="text-gray-400">(${s.ssrInterpolate(formatearPrecio(e.unref(j).montoCompletado))}€)</span></div><span class="hidden sm:block text-gray-200">|</span><div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-red-500"></span><span class="text-gray-600">Canceladas:</span><span class="font-semibold text-gray-900">${s.ssrInterpolate(e.unref(j).canceladas)}</span></div><div class="ml-auto flex items-center gap-2 pl-4 border-l border-gray-200"><span class="text-gray-600">Por cobrar:</span><span class="font-bold text-green-600 text-base">${s.ssrInterpolate(formatearPrecio(e.unref(R)))}€</span></div></div></div><div class="space-y-3"><div class="flex flex-wrap items-center gap-3"><div class="relative flex-1 min-w-[200px] max-w-md"><input${s.ssrRenderAttr("value",e.unref(C).busqueda)} type="text" placeholder="Buscar sesión..." class="w-full h-10 px-4 pl-9 bg-white border border-gray-200 rounded-lg text-sm focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all">`),a(s.ssrRenderComponent(e.unref(i),{class:"w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"},null,r)),a('</div><div class="flex items-center bg-gray-100 rounded-lg p-1">\x3c!--[--\x3e'),s.ssrRenderList(I,t=>{a(`<button class="${s.ssrRenderClass([e.unref(C).periodo===t.valor?"bg-white text-gray-900 shadow-sm":"text-gray-600 hover:text-gray-900","px-3 py-1.5 text-sm font-medium rounded-md transition-all"])}">${s.ssrInterpolate(t.label)}</button>`)}),a(`\x3c!--]--\x3e</div><select class="h-10 px-3 bg-white border border-gray-200 rounded-lg text-sm text-gray-700 focus:border-purple-500 focus:ring-1 focus:ring-purple-500/20"><option value=""${s.ssrIncludeBooleanAttr(Array.isArray(e.unref(C).estado)?s.ssrLooseContain(e.unref(C).estado,""):s.ssrLooseEqual(e.unref(C).estado,""))?" selected":""}>Todos los estados</option><option value="pendiente"${s.ssrIncludeBooleanAttr(Array.isArray(e.unref(C).estado)?s.ssrLooseContain(e.unref(C).estado,"pendiente"):s.ssrLooseEqual(e.unref(C).estado,"pendiente"))?" selected":""}>Pendientes</option><option value="confirmada"${s.ssrIncludeBooleanAttr(Array.isArray(e.unref(C).estado)?s.ssrLooseContain(e.unref(C).estado,"confirmada"):s.ssrLooseEqual(e.unref(C).estado,"confirmada"))?" selected":""}>Confirmadas</option><option value="realizada"${s.ssrIncludeBooleanAttr(Array.isArray(e.unref(C).estado)?s.ssrLooseContain(e.unref(C).estado,"realizada"):s.ssrLooseEqual(e.unref(C).estado,"realizada"))?" selected":""}>Realizadas</option><option value="cancelada"${s.ssrIncludeBooleanAttr(Array.isArray(e.unref(C).estado)?s.ssrLooseContain(e.unref(C).estado,"cancelada"):s.ssrLooseEqual(e.unref(C).estado,"cancelada"))?" selected":""}>Canceladas</option></select>`),e.unref(D)?a('<button class="h-10 px-3 text-sm text-gray-500 hover:text-gray-700 transition-colors"> Limpiar </button>'):a("\x3c!----\x3e"),a("</div></div></header>"),e.unref(x)?a('<div class="flex items-center justify-center py-20"><div class="w-8 h-8 border-2 border-purple-600 border-t-transparent rounded-full animate-spin"></div></div>'):e.unref(v)?(a('<div class="bg-red-50 border border-red-100 rounded-lg p-4 flex items-start gap-3">'),a(s.ssrRenderComponent(e.unref(l),{class:"w-5 h-5 text-red-500 flex-shrink-0 mt-0.5"},null,r)),a(`<div><p class="font-medium text-red-800">Error al cargar sesiones</p><p class="text-sm text-red-600">${s.ssrInterpolate(e.unref(v))}</p></div></div>`)):(a("<div>"),0===e.unref($).length?(a('<div class="flex flex-col items-center justify-center py-20 text-center"><div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">'),a(s.ssrRenderComponent(e.unref(d),{class:"w-8 h-8 text-gray-400"},null,r)),a(`</div><h3 class="text-lg font-medium text-gray-900 mb-1">${s.ssrInterpolate(e.unref(D)?"Sin resultados":"Sin sesiones")}</h3><p class="text-sm text-gray-500 mb-4 max-w-sm">${s.ssrInterpolate(e.unref(D)?"Prueba ajustando los filtros de búsqueda":"Programa tu primera sesión desde la agenda")}</p>`),e.unref(D)?a('<button class="px-4 py-2 text-gray-600 text-sm font-medium hover:text-gray-900 transition-colors"> Limpiar filtros </button>'):a('<button class="px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 transition-colors"> Ir a la agenda </button>'),a("</div>")):(a('<div class="bg-white border border-gray-100 rounded-lg overflow-hidden"><div class="overflow-x-auto"><table class="w-full"><thead><tr class="border-b border-gray-100 bg-gray-50/50"><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Paciente</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bono</th><th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th><th class="px-4 py-3 w-10"></th></tr></thead><tbody class="divide-y divide-gray-50">\x3c!--[--\x3e'),s.ssrRenderList(e.unref($),t=>{var o,n;a(`<tr class="hover:bg-gray-50/50 transition-colors cursor-pointer"><td class="px-4 py-3"><div class="text-sm font-medium text-gray-900">${s.ssrInterpolate((e=>{if(!e)return"-";const t=new Date(e+"T00:00:00"),a=new Date,s=new Date(a);return s.setDate(a.getDate()-1),t.toDateString()===a.toDateString()?"Hoy":t.toDateString()===s.toDateString()?"Ayer":t.toLocaleDateString("es-ES",{day:"numeric",month:"short"})})(t.fecha_cita))}</div><div class="text-xs text-gray-500">${s.ssrInterpolate((n=t.hora_inicio,n?.substring(0,5)||"-"))}</div></td><td class="px-4 py-3"><div class="flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-xs font-semibold flex-shrink-0">${s.ssrInterpolate(obtenerIniciales(t.paciente?.nombre_completo||"NN"))}</div><div class="min-w-0"><div class="text-sm font-medium text-gray-900 truncate">${s.ssrInterpolate(t.paciente?.nombre_completo||"Sin nombre")}</div></div></div></td><td class="px-4 py-3"><span class="text-sm text-gray-600">${s.ssrInterpolate("online"===t.modalidad?"Online":"Presencial")}</span></td><td class="px-4 py-3"><span class="${s.ssrRenderClass([(o=t.estado,{pendiente:"text-gray-600",confirmada:"text-green-600",realizada:"text-green-700",completada:"text-green-700",cancelada:"text-red-600"}[o]||"text-gray-600"),"inline-flex items-center gap-1.5 text-sm"])}"><span class="${s.ssrRenderClass([obtenerColorPuntoEstado(t.estado),"w-1.5 h-1.5 rounded-full"])}"></span> ${s.ssrInterpolate((e=>({pendiente:"Pendiente",confirmada:"Confirmada",realizada:"Realizada",completada:"Realizada",cancelada:"Cancelada"}[e]||e))(t.estado))}</span></td><td class="px-4 py-3">`),t.bono?(a(`<div class="text-sm"><span class="text-gray-700">${s.ssrInterpolate(t.bono.sesiones_restantes)}/${s.ssrInterpolate(t.bono.sesiones_totales)}</span>`),t.bono.pagado?a('<span class="ml-1.5 text-xs text-green-600 font-medium">Pagado</span>'):a('<span class="ml-1.5 text-xs text-amber-600 font-medium">Pend.</span>'),a("</div>")):a('<span class="text-sm text-gray-400">—</span>'),a(`</td><td class="px-4 py-3 text-right"><div class="text-sm font-medium text-gray-900">${s.ssrInterpolate(formatearPrecio(t.precio_estimado||50))}€ </div><div class="text-xs text-gray-500">${s.ssrInterpolate(formatearPrecio(.7*(t.precio_estimado||50)))}€ tu parte </div></td><td class="px-4 py-3 text-right">`),a(s.ssrRenderComponent(e.unref(c),{class:"w-4 h-4 text-gray-400"},null,r)),a("</td></tr>")}),a("\x3c!--]--\x3e</tbody></table></div></div>")),e.unref(P).length>0?(a('<div class="mt-6"><button class="w-full flex items-center justify-between px-4 py-3 bg-green-50 border border-green-100 rounded-lg text-left hover:bg-green-100/50 transition-colors"><div class="flex items-center gap-3"><div class="w-8 h-8 bg-green-600 rounded-lg flex items-center justify-center">'),a(s.ssrRenderComponent(e.unref(p),{class:"w-4 h-4 text-white"},null,r)),a(`</div><div><span class="font-medium text-green-800">Pagos confirmados</span><span class="text-sm text-green-600 ml-2">${s.ssrInterpolate(e.unref(P).length)} bonos · ${s.ssrInterpolate(formatearPrecio(e.unref(S)))}€</span></div></div>`),a(s.ssrRenderComponent(e.unref(m),{class:["w-5 h-5 text-green-600 transition-transform",{"rotate-180":e.unref(h)}]},null,r)),a(`</button><div class="mt-2 bg-white border border-gray-100 rounded-lg overflow-hidden" style="${s.ssrRenderStyle(e.unref(h)?null:{display:"none"})}"><div class="divide-y divide-gray-50">\x3c!--[--\x3e`),s.ssrRenderList(e.unref(P),e=>{var t;a(`<div class="px-4 py-3 flex items-center gap-4 hover:bg-gray-50/50"><div class="w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-xs font-semibold">${s.ssrInterpolate(obtenerIniciales(e.paciente_nombre||"NN"))}</div><div class="flex-1 min-w-0"><div class="text-sm font-medium text-gray-900 truncate">${s.ssrInterpolate(e.paciente_nombre)}</div><div class="text-xs text-gray-500">${s.ssrInterpolate(e.tipo_bono||"Bono")} · ${s.ssrInterpolate(e.sesiones_usadas)}/${s.ssrInterpolate(e.bono_sesiones_totales)} sesiones</div></div><div class="text-right"><div class="text-sm font-semibold text-green-600">${s.ssrInterpolate(formatearPrecio(e.monto_total_terapeuta))}€</div><div class="text-xs text-gray-500">${s.ssrInterpolate((t=e.bono_fecha_pago,t?new Date(t).toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit",year:"numeric"}):"-"))}</div></div></div>`)}),a("\x3c!--]--\x3e</div></div></div>")):a("\x3c!----\x3e"),a("</div>")),a(s.ssrRenderComponent(o,{"is-open":e.unref(_),"cita-id":e.unref(w),onClose:cerrarModalDetalles,onActualizado:cargarSesiones,onEliminado:cargarSesiones},null,r)),a("</div>")}}}),f=u.setup;u.setup=(t,a)=>{const s=e.useSSRContext();return(s.modules||(s.modules=new Set)).add("pages/terapeuta/sesiones/index.vue"),f?f(t,a):void 0};export{u as default};
//# sourceMappingURL=index-DFBSmGQJ.mjs.map
