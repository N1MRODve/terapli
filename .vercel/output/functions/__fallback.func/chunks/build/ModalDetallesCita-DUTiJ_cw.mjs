import{v as e,a,s as t}from"./server.mjs";import{u as o}from"./useSupabaseClient-DykwVqLQ.mjs";import{u as r}from"./useSupabase-DfFg84CY.mjs";import{_ as s}from"./PaymentMethodSelector-B6WAV7CR.mjs";import{r as n}from"./XMarkIcon-DCLwyE-W.mjs";import{r as d}from"./CheckCircleIcon-CT9fzVFs.mjs";import{r as l}from"./PencilIcon-BKWXEWgS.mjs";import{r as i}from"./PhoneIcon-acGzPaDV.mjs";import{r as c}from"./CalendarDaysIcon-f8DhK37e.mjs";import{r as u}from"./ClockIcon-BxdFtPqx.mjs";import{r as p}from"./TicketIcon-zZdrc71S.mjs";import{r as v}from"./ChevronDownIcon-CvdhRGll.mjs";import{r as m}from"./ExclamationTriangleIcon-DQdM2y0F.mjs";import{r as g}from"./PlusIcon-CHLzv-V9.mjs";import{_ as f}from"./_plugin-vue_export-helper-1tPrXgE0.mjs";function render$3(a,t){return e.openBlock(),e.createElementBlock("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e.createElementVNode("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M13.5 6H5.25A2.25 2.25 0 0 0 3 8.25v10.5A2.25 2.25 0 0 0 5.25 21h10.5A2.25 2.25 0 0 0 18 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25"})])}function render$2(a,t){return e.openBlock(),e.createElementBlock("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e.createElementVNode("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m4.5 15.75 7.5-7.5 7.5 7.5"})])}function render$1(a,t){return e.openBlock(),e.createElementBlock("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e.createElementVNode("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"}),e.createElementVNode("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z"})])}function render(a,t){return e.openBlock(),e.createElementBlock("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e.createElementVNode("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m15.75 10.5 4.72-4.72a.75.75 0 0 1 1.28.53v11.38a.75.75 0 0 1-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25h-9A2.25 2.25 0 0 0 2.25 7.5v9a2.25 2.25 0 0 0 2.25 2.25Z"})])}function usePayments(){const a=o(),{userProfile:t}=r(),s=e.ref([]),n=e.ref(!1),d=e.ref(null),l=e.computed(()=>{const e=(new Date).toISOString().split("T")[0],a=s.value.filter(e=>"pagado"===e.estado_pago),t=s.value.filter(e=>"pendiente"===e.estado_pago||!e.estado_pago),o={efectivo:{total:0,cantidad:0},transferencia:{total:0,cantidad:0},bizum:{total:0,cantidad:0},tarjeta:{total:0,cantidad:0},stripe:{total:0,cantidad:0}};return a.forEach(e=>{e.metodo_pago&&o[e.metodo_pago]&&(o[e.metodo_pago].total+=e.precio_sesion||0,o[e.metodo_pago].cantidad+=1)}),{fecha:e,total:a.reduce((e,a)=>e+(a.precio_sesion||0),0),cantidadPagos:a.length,porMetodo:o,pagos:a,pendientes:t}});async function getPaymentsOfDay(e){const o=t.value?.terapeuta_id||t.value?.id;if(!o)return console.warn("[usePayments] No hay terapeuta_id disponible"),[];const r=e||(new Date).toISOString().split("T")[0];n.value=!0,d.value=null;try{const{data:e,error:t}=await a.from("citas").select("\n          id,\n          fecha_cita,\n          hora_inicio,\n          hora_fin,\n          precio_sesion,\n          estado_pago,\n          metodo_pago,\n          fecha_pago,\n          bono_id,\n          estado,\n          paciente:pacientes(id, nombre_completo)\n        ").eq("terapeuta_id",o).eq("fecha_cita",r).in("estado",["confirmada","realizada"]).order("hora_inicio",{ascending:!0});if(t)throw new Error(t.message);const n=(e||[]).map(e=>({id:e.id,paciente_id:e.paciente?.id||"",paciente_nombre:e.paciente?.nombre_completo||"Sin nombre",fecha_cita:e.fecha_cita,hora_inicio:e.hora_inicio,hora_fin:e.hora_fin,precio_sesion:e.precio_sesion,estado_pago:e.estado_pago,metodo_pago:e.metodo_pago,fecha_pago:e.fecha_pago,bono_id:e.bono_id,estado:e.estado}));return s.value=n,n}catch(e){return d.value=e.message,console.error("[usePayments] Error obteniendo pagos:",e),[]}finally{n.value=!1}}async function refreshPaymentsForToday(){await getPaymentsOfDay()}return{pagosDia:s,loading:n,error:d,resumenDia:l,getPaymentsOfDay:getPaymentsOfDay,createPayment:async function(e,t,o,r){n.value=!0,d.value=null;try{const{data:s,error:n}=await a.rpc("fn_registrar_pago_sesion",{p_cita_id:e,p_metodo_pago:t,p_monto:o||null,p_notas:r||null});if(!n)return await refreshPaymentsForToday(),{success:!0,data:s};console.warn("[usePayments] RPC fall√≥, usando fallback:",n.message);const d={estado_pago:"pagado",metodo_pago:t,fecha_pago:(new Date).toISOString(),updated_at:(new Date).toISOString()};void 0!==o&&(d.precio_sesion=o),r&&(d.notas_pago=r);const{error:l}=await a.from("citas").update(d).eq("id",e);if(l)throw new Error(l.message);return await refreshPaymentsForToday(),{success:!0}}catch(e){return d.value=e.message,console.error("[usePayments] Error registrando pago:",e),{success:!1,error:e.message}}finally{n.value=!1}},updatePaymentMethod:async function(e,t){n.value=!0,d.value=null;try{const{error:o}=await a.from("citas").update({metodo_pago:t,updated_at:(new Date).toISOString()}).eq("id",e);if(o)throw new Error(o.message);return await refreshPaymentsForToday(),{success:!0}}catch(e){return d.value=e.message,console.error("[usePayments] Error actualizando m√©todo:",e),{success:!1,error:e.message}}finally{n.value=!1}},undoPayment:async function(e){n.value=!0,d.value=null;try{const{error:t}=await a.from("citas").update({estado_pago:"pendiente",metodo_pago:null,fecha_pago:null,notas_pago:null,updated_at:(new Date).toISOString()}).eq("id",e);if(t)throw new Error(t.message);return await refreshPaymentsForToday(),{success:!0}}catch(e){return d.value=e.message,console.error("[usePayments] Error deshaciendo pago:",e),{success:!1,error:e.message}}finally{n.value=!1}},refreshPaymentsForToday:refreshPaymentsForToday,getPaymentSummary:function(e){const a={efectivo:{total:0,cantidad:0},transferencia:{total:0,cantidad:0},bizum:{total:0,cantidad:0},tarjeta:{total:0,cantidad:0},stripe:{total:0,cantidad:0}},t=e.filter(e=>"pagado"===e.estado_pago);return t.forEach(e=>{e.metodo_pago&&a[e.metodo_pago]&&(a[e.metodo_pago].total+=e.precio_sesion||0,a[e.metodo_pago].cantidad+=1)}),{total:t.reduce((e,a)=>e+(a.precio_sesion||0),0),porMetodo:a}},formatPaymentMethod:function(e){return e?{efectivo:"üíµ Efectivo",transferencia:"üè¶ Transferencia",bizum:"üì± Bizum",tarjeta:"üí≥ Tarjeta",stripe:"‚ö° Stripe"}[e]:"No especificado"},formatPaymentDate:function(e){if(!e)return"";const a=new Date(e),t=new Date,o=new Date(t);o.setDate(o.getDate()-1);const r=a.toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit"}),s=a.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"});return a.toDateString()===t.toDateString()?`Hoy a las ${s}`:a.toDateString()===o.toDateString()?`Ayer a las ${s}`:`${r} a las ${s}`}}}const b=e.defineComponent({__name:"PaymentStatusBadge",__ssrInlineRender:!0,props:{estadoPago:{},metodoPago:{default:null},fechaPago:{default:null},cantidad:{default:null},showActions:{type:Boolean,default:!0},compact:{type:Boolean,default:!1}},emits:["registrar","cambiar","deshacer"],setup(a,{emit:o}){const r=a,{formatPaymentMethod:s,formatPaymentDate:n}=usePayments(),d=e.computed(()=>{switch(r.estadoPago){case"pagado":return{label:"Pagado",icon:"‚úì",bgColor:"bg-green-50",textColor:"text-green-700",borderColor:"border-green-200",iconBg:"bg-green-500"};case"bonificado":return{label:"Bonificado",icon:"üéÅ",bgColor:"bg-blue-50",textColor:"text-blue-700",borderColor:"border-blue-200",iconBg:"bg-blue-500"};case"cancelado":return{label:"Cancelado",icon:"‚úï",bgColor:"bg-gray-50",textColor:"text-gray-500",borderColor:"border-gray-200",iconBg:"bg-gray-400"};default:return{label:"Pendiente",icon:"‚è≥",bgColor:"bg-amber-50",textColor:"text-amber-700",borderColor:"border-amber-200",iconBg:"bg-amber-500"}}}),l=e.computed(()=>"pagado"===r.estadoPago),i=e.computed(()=>!r.estadoPago||"pendiente"===r.estadoPago),c=e.computed(()=>"bonificado"===r.estadoPago),u=e.computed(()=>r.metodoPago?s(r.metodoPago):null),p=e.computed(()=>r.fechaPago?n(r.fechaPago):null),v=e.computed(()=>null===r.cantidad||void 0===r.cantidad?null:`${r.cantidad.toFixed(2)}‚Ç¨`);return(o,r,s,n)=>{r(`<div${t.ssrRenderAttrs(e.mergeProps({class:["rounded-lg border transition-colors",e.unref(d).bgColor,e.unref(d).borderColor,a.compact?"p-2":"p-3"]},n))}><div class="flex items-start justify-between gap-3"><div class="flex items-center gap-2"><span class="${t.ssrRenderClass(["flex items-center justify-center rounded-full text-white",e.unref(d).iconBg,a.compact?"w-5 h-5 text-xs":"w-6 h-6 text-sm"])}" aria-hidden="true">${t.ssrInterpolate(e.unref(d).icon)}</span><div><span class="${t.ssrRenderClass(["font-medium",e.unref(d).textColor,a.compact?"text-sm":"text-base"])}">${t.ssrInterpolate(e.unref(d).label)}</span>`),e.unref(l)&&!a.compact?(r('<p class="text-xs text-gray-500 mt-0.5">'),e.unref(u)?r(`<span>${t.ssrInterpolate(e.unref(u))}</span>`):r("\x3c!----\x3e"),e.unref(p)?r(`<span class="ml-1">¬∑ ${t.ssrInterpolate(e.unref(p))}</span>`):r("\x3c!----\x3e"),r("</p>")):r("\x3c!----\x3e"),e.unref(c)&&!a.compact?r('<p class="text-xs text-blue-600 mt-0.5"> Sesi√≥n cubierta por bono </p>'):r("\x3c!----\x3e"),r("</div></div>"),e.unref(v)&&!a.compact?r(`<div class="text-right"><span class="${t.ssrRenderClass(["font-semibold",e.unref(d).textColor])}">${t.ssrInterpolate(e.unref(v))}</span></div>`):r("\x3c!----\x3e"),r("</div>"),a.showActions&&!a.compact?(r(`<div class="${t.ssrRenderClass([e.unref(d).borderColor,"mt-3 pt-3 border-t flex flex-wrap gap-2"])}">`),e.unref(i)?r('<button type="button" class="flex-1 inline-flex items-center justify-center gap-1.5 px-3 py-2 text-sm font-medium text-white bg-teal-600 rounded-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-colors"><span aria-hidden="true">üí≥</span> Registrar pago </button>'):r("\x3c!----\x3e"),e.unref(l)?r('\x3c!--[--\x3e<button type="button" class="inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-colors"><span aria-hidden="true">üîÑ</span> Cambiar m√©todo </button><button type="button" class="inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-red-600 bg-white border border-red-200 rounded-lg hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors"><span aria-hidden="true">‚Ü©Ô∏è</span> Deshacer </button>\x3c!--]--\x3e'):r("\x3c!----\x3e"),e.unref(c)?r('<p class="text-xs text-blue-600 italic"> Esta sesi√≥n est√° vinculada a un bono activo </p>'):r("\x3c!----\x3e"),r("</div>")):r("\x3c!----\x3e"),r("</div>")}}}),x=b.setup;b.setup=(a,t)=>{const o=e.useSSRContext();return(o.modules||(o.modules=new Set)).add("components/Payment/PaymentStatusBadge.vue"),x?x(a,t):void 0};const y=Object.assign(b,{__name:"PaymentStatusBadge"}),h=e.defineComponent({__name:"PaymentQuickModal",__ssrInlineRender:!0,props:{citaId:{},pacienteNombre:{},cantidad:{},tipoTransaccion:{default:"sesion_unica"},bonoInfo:{default:null},horaInicio:{default:""},metodoPagoActual:{default:null},modoEdicion:{type:Boolean,default:!1}},emits:["confirm","cancel"],setup(a,{emit:o}){const r=a;usePayments();const n=e.ref(r.metodoPagoActual),d=e.ref(!1),l=e.computed(()=>{if(r.bonoInfo){return`Sesi√≥n ${r.bonoInfo.numeroSesion||r.bonoInfo.sesionesTotales-r.bonoInfo.sesionesRestantes+1}/${r.bonoInfo.sesionesTotales} "${r.bonoInfo.nombre}"`}return"Sesi√≥n individual"}),i=e.computed(()=>r.modoEdicion?"Cambiar m√©todo de pago":"Registrar pago"),c=e.computed(()=>`${r.cantidad.toFixed(2)}‚Ç¨`);function handleSelectMethod(e){n.value=e}return(o,r,u,p)=>{const v=s;t.ssrRenderTeleport(r,o=>{o(`<div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50" role="dialog" aria-modal="true"${t.ssrRenderAttr("aria-labelledby","payment-modal-title")}><div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden"><div class="px-5 py-4 bg-gray-50 border-b border-gray-200"><h2 id="payment-modal-title" class="text-lg font-semibold text-gray-900">${t.ssrInterpolate(e.unref(i))}</h2></div><div class="p-5 space-y-5"><div class="text-center pb-4 border-b border-gray-100"><p class="text-3xl font-bold text-gray-900">${t.ssrInterpolate(e.unref(c))}</p><p class="mt-1 text-base text-gray-700">${t.ssrInterpolate(a.pacienteNombre)}</p><p class="text-sm text-gray-500">${t.ssrInterpolate(e.unref(l))} `),a.horaInicio?o(`<span class="ml-1">¬∑ ${t.ssrInterpolate(a.horaInicio)}</span>`):o("\x3c!----\x3e"),o('</p></div><div><label class="block text-sm font-medium text-gray-700 mb-3"> M√©todo de pago </label>'),o(t.ssrRenderComponent(v,{"selected-method":e.unref(n),disabled:e.unref(d),size:"md",onSelect:handleSelectMethod},null,u)),o(`</div></div><div class="px-5 py-4 bg-gray-50 border-t border-gray-200 flex gap-3"><button type="button" class="flex-1 px-4 py-2.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors"${t.ssrIncludeBooleanAttr(e.unref(d))?" disabled":""}> Cancelar </button><button type="button" class="flex-1 px-4 py-2.5 text-sm font-medium text-white bg-teal-600 rounded-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"${t.ssrIncludeBooleanAttr(!e.unref(n)||e.unref(d))?" disabled":""}>`),e.unref(d)?o('<span class="inline-flex items-center gap-2"><svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Procesando... </span>'):o(`<span>${t.ssrInterpolate(a.modoEdicion?"Actualizar":"Confirmar pago")}</span>`),o("</button></div></div></div>")},"body",!1,u)}}}),_=h.setup;h.setup=(a,t)=>{const o=e.useSSRContext();return(o.modules||(o.modules=new Set)).add("components/Payment/PaymentQuickModal.vue"),_?_(a,t):void 0};const w=Object.assign(h,{__name:"PaymentQuickModal"}),C=e.defineComponent({__name:"ModalDetallesCita",__ssrInlineRender:!0,props:{citaId:{}},emits:["close","cita-actualizada","cita-eliminada","actualizado","eliminado"],setup(r,{emit:s}){const f=r,b=s,x=e.ref(!1),h=e.ref(!1),_=e.ref(!1),C=e.ref(!1),I=e.ref(!0),$=e.ref(!1),S=e.ref(!1),P=e.ref(!1),D=e.ref(!1),R=e.ref(!1),k=e.ref(!1),A=e.ref(!1),B=e.ref(null),j=e.ref(null),E=e.ref(null),z=e.ref(null);a(),usePayments();const M=e.ref({fecha_cita:"",hora_inicio:"",hora_fin:"",modalidad:"",observaciones:"",estado:""}),T=o();e.watch(I,e=>{localStorage.setItem("modal-seccion-bono",String(e))}),e.watch($,e=>{localStorage.setItem("modal-seccion-observaciones",String(e))});e.watch(()=>f.citaId,e=>{e?(async()=>{if(f.citaId)try{P.value=!0;const{data:e,error:a}=await T.from("citas").select("\n        *,\n        paciente:pacientes(\n          id,\n          nombre_completo,\n          email,\n          telefono,\n          frecuencia\n        )\n      ").eq("id",f.citaId).single();if(a)throw a;if(B.value=e,j.value=e.paciente,e.bono_id){const{data:a,error:t}=await T.from("bonos").select("*").eq("id",e.bono_id).single();if(!t){E.value=a;const{data:t}=await T.from("citas").select("id, fecha_cita, hora_inicio").eq("bono_id",e.bono_id).eq("sesion_descontada",!0).order("fecha_cita",{ascending:!0}).order("hora_inicio",{ascending:!0});if(t){const e=t.findIndex(e=>e.id===f.citaId);-1!==e&&(E.value.numero_sesion=e+1)}}}else E.value=null;if(!e.bono_id&&e.paciente?.id){const{data:a}=await T.from("bonos").select("*").eq("paciente_id",e.paciente.id).in("estado",["activo","pendiente"]).gt("sesiones_restantes",0).order("created_at",{ascending:!1}).limit(1).maybeSingle();z.value=a}else z.value=null;M.value={fecha_cita:e.fecha_cita,hora_inicio:e.hora_inicio?.substring(0,5)||"",hora_fin:e.hora_fin?.substring(0,5)||"",modalidad:e.modalidad,observaciones:e.observaciones||"",estado:e.estado},_.value=!1,C.value=!1}catch(e){console.error("Error al cargar cita:",e)}finally{P.value=!1}})():(B.value=null,j.value=null,E.value=null,z.value=null)},{immediate:!0});const q=e.computed(()=>{if(!B.value?.fecha_cita)return"";const e=new Date(B.value.fecha_cita+"T00:00:00"),a=new Date,t=new Date(a);return t.setDate(t.getDate()+1),e.toDateString()===a.toDateString()?"Hoy":e.toDateString()===t.toDateString()?"Ma√±ana":e.toLocaleDateString("es-ES",{weekday:"short",day:"numeric",month:"short"})}),V=e.computed(()=>{if(!B.value)return"";return`${B.value.hora_inicio?.substring(0,5)||""} - ${B.value.hora_fin?.substring(0,5)||""}`}),L=e.computed(()=>{if(!B.value?.hora_inicio||!B.value?.hora_fin)return 60;const[e,a]=B.value.hora_inicio.split(":").map(Number),[t,o]=B.value.hora_fin.split(":").map(Number);return 60*t+o-(60*e+a)}),N=e.computed(()=>({presencial:"Presencial",virtual:"Online",telefonica:"Telef√≥nica"}[B.value?.modalidad]||B.value?.modalidad||"-")),O=e.computed(()=>B.value?.estado||"pendiente"),F=e.computed(()=>({pendiente:"bg-amber-100 text-amber-700",confirmada:"bg-emerald-100 text-emerald-700",realizada:"bg-blue-100 text-blue-700",cancelada:"bg-gray-100 text-gray-500"}[O.value]||"bg-gray-100 text-gray-600")),Q=e.computed(()=>({pendiente:"Pendiente",confirmada:"Confirmada",realizada:"Realizada",cancelada:"Cancelada"}[O.value]||O.value)),G=e.computed(()=>B.value?.estado_pago||"pendiente"),H=e.computed(()=>"pendiente"===B.value?.estado),W=e.computed(()=>{if(!B.value)return!1;const e=B.value.estado,a=B.value.estado_pago;return!("confirmada"!==e&&"realizada"!==e||"pendiente"!==a&&a)}),Z=e.computed(()=>{if(!B.value)return!1;const e=B.value.estado;return"confirmada"===e||"pendiente"===e}),X=e.computed(()=>!!E.value&&(!B.value?.sesion_descontada&&(!(E.value.sesiones_restantes<=0)&&("realizada"===B.value?.estado||"confirmada"===B.value?.estado)))),K=e.computed(()=>!E.value&&(!!z.value&&z.value.sesiones_restantes>0)),U=e.computed(()=>E.value||z.value),Y=e.computed(()=>U.value?U.value.sesiones_totales-U.value.sesiones_restantes:0),J=e.computed(()=>U.value?Y.value/U.value.sesiones_totales*100:0),ee=e.computed(()=>{if(!U.value?.fecha_fin)return null;return new Date(U.value.fecha_fin).toLocaleDateString("es-ES",{day:"numeric",month:"short"})}),ae=e.computed(()=>{if(!U.value?.fecha_fin)return!1;const e=new Date(U.value.fecha_fin),a=new Date,t=Math.floor((e.getTime()-a.getTime())/864e5);return t<=7&&t>=0}),te=e.computed(()=>{if(!U.value?.fecha_fin)return!1;return new Date(U.value.fecha_fin)<new Date}),oe=e.computed(()=>{if(!U.value?.tipo)return"Bono";return{semanal:"Semanal",quincenal:"Quincenal",mensual:"Mensual",otro:"Personalizado"}[U.value.tipo]||U.value.tipo}),re=e.computed(()=>U.value&&U.value.monto_total&&U.value.sesiones_totales?U.value.monto_total/U.value.sesiones_totales:U.value?.metadata?.precio_por_sesion?U.value.metadata.precio_por_sesion:B.value?.precio_sesion||50),se=e.computed(()=>{if(!j.value?.nombre_completo)return"?";const e=j.value.nombre_completo.split(" ");return e.length>=2?(e[0][0]+e[1][0]).toUpperCase():e[0].substring(0,2).toUpperCase()}),ne=e.computed(()=>E.value?{id:E.value.id,nombre:E.value.tipo||"Bono",sesionesRestantes:E.value.sesiones_restantes,sesionesTotales:E.value.sesiones_totales,numeroSesion:E.value.numero_sesion}:null),abrirModalPago=()=>{C.value=!1,_.value=!0},abrirCambiarMetodo=()=>{C.value=!0,_.value=!0},handlePagoConfirmado=e=>{B.value&&(B.value.estado_pago="pagado",B.value.metodo_pago=e,B.value.fecha_pago=(new Date).toISOString()),_.value=!1,C.value=!1,b("cita-actualizada"),b("actualizado")},cancelarModalPago=()=>{_.value=!1,C.value=!1};return e.watch(()=>M.value.hora_inicio,e=>{if(S.value&&e){const[a,t]=e.split(":").map(Number),o=60*a+t+60,r=Math.floor(o/60),s=o%60;M.value.hora_fin=`${String(r).padStart(2,"0")}:${String(s).padStart(2,"0")}`}}),(a,o,s,f)=>{const b=y,z=w;t.ssrRenderTeleport(o,a=>{r.citaId?(a(`<div class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 p-4" role="dialog" aria-modal="true" aria-labelledby="modal-title" data-v-77666de4><div class="bg-white rounded-xl shadow-xl w-full max-w-[600px] max-h-[90vh] overflow-hidden flex flex-col" data-v-77666de4><div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between bg-white" data-v-77666de4><div class="flex items-center gap-3" data-v-77666de4><div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-sm font-semibold text-gray-600" data-v-77666de4>${t.ssrInterpolate(se.value)}</div><div data-v-77666de4><h2 id="modal-title" class="text-base font-semibold text-gray-900" data-v-77666de4> Sesi√≥n - ${t.ssrInterpolate(j.value?.nombre_completo||"Cargando...")}</h2><span class="${t.ssrRenderClass(["text-xs font-medium px-2 py-0.5 rounded-full",F.value])}" data-v-77666de4>${t.ssrInterpolate(Q.value)}</span></div></div><button class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors" aria-label="Cerrar modal" data-v-77666de4>`),a(t.ssrRenderComponent(e.unref(n),{class:"w-5 h-5"},null,s)),a("</button></div>"),P.value?a('<div class="flex-1 flex items-center justify-center p-12" data-v-77666de4><div class="w-8 h-8 border-2 border-gray-200 border-t-gray-600 rounded-full animate-spin" data-v-77666de4></div></div>'):B.value?(a('<div class="flex-1 overflow-y-auto" data-v-77666de4>'),S.value?a(`<form class="p-5 space-y-4" data-v-77666de4><div data-v-77666de4><label class="block text-sm font-medium text-gray-700 mb-1" data-v-77666de4>Fecha</label><input${t.ssrRenderAttr("value",M.value.fecha_cita)} type="date" required class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-gray-400 focus:border-gray-400" data-v-77666de4></div><div class="grid grid-cols-2 gap-3" data-v-77666de4><div data-v-77666de4><label class="block text-sm font-medium text-gray-700 mb-1" data-v-77666de4>Inicio</label><input${t.ssrRenderAttr("value",M.value.hora_inicio)} type="time" required class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-gray-400 focus:border-gray-400" data-v-77666de4></div><div data-v-77666de4><label class="block text-sm font-medium text-gray-700 mb-1" data-v-77666de4>Fin</label><input${t.ssrRenderAttr("value",M.value.hora_fin)} type="time" required class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-gray-400 focus:border-gray-400" data-v-77666de4></div></div><div class="grid grid-cols-2 gap-3" data-v-77666de4><div data-v-77666de4><label class="block text-sm font-medium text-gray-700 mb-1" data-v-77666de4>Modalidad</label><select required class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-gray-400 focus:border-gray-400" data-v-77666de4><option value="presencial" data-v-77666de4${t.ssrIncludeBooleanAttr(Array.isArray(M.value.modalidad)?t.ssrLooseContain(M.value.modalidad,"presencial"):t.ssrLooseEqual(M.value.modalidad,"presencial"))?" selected":""}>Presencial</option><option value="virtual" data-v-77666de4${t.ssrIncludeBooleanAttr(Array.isArray(M.value.modalidad)?t.ssrLooseContain(M.value.modalidad,"virtual"):t.ssrLooseEqual(M.value.modalidad,"virtual"))?" selected":""}>Virtual</option><option value="telefonica" data-v-77666de4${t.ssrIncludeBooleanAttr(Array.isArray(M.value.modalidad)?t.ssrLooseContain(M.value.modalidad,"telefonica"):t.ssrLooseEqual(M.value.modalidad,"telefonica"))?" selected":""}>Telef√≥nica</option></select></div><div data-v-77666de4><label class="block text-sm font-medium text-gray-700 mb-1" data-v-77666de4>Estado</label><select required class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-gray-400 focus:border-gray-400" data-v-77666de4><option value="pendiente" data-v-77666de4${t.ssrIncludeBooleanAttr(Array.isArray(M.value.estado)?t.ssrLooseContain(M.value.estado,"pendiente"):t.ssrLooseEqual(M.value.estado,"pendiente"))?" selected":""}>Pendiente</option><option value="confirmada" data-v-77666de4${t.ssrIncludeBooleanAttr(Array.isArray(M.value.estado)?t.ssrLooseContain(M.value.estado,"confirmada"):t.ssrLooseEqual(M.value.estado,"confirmada"))?" selected":""}>Confirmada</option><option value="realizada" data-v-77666de4${t.ssrIncludeBooleanAttr(Array.isArray(M.value.estado)?t.ssrLooseContain(M.value.estado,"realizada"):t.ssrLooseEqual(M.value.estado,"realizada"))?" selected":""}>Realizada</option><option value="cancelada" data-v-77666de4${t.ssrIncludeBooleanAttr(Array.isArray(M.value.estado)?t.ssrLooseContain(M.value.estado,"cancelada"):t.ssrLooseEqual(M.value.estado,"cancelada"))?" selected":""}>Cancelada</option></select></div></div><div data-v-77666de4><label class="block text-sm font-medium text-gray-700 mb-1" data-v-77666de4>Observaciones</label><textarea rows="3" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-gray-400 focus:border-gray-400 resize-none" placeholder="Notas adicionales..." data-v-77666de4>${t.ssrInterpolate(M.value.observaciones)}</textarea></div><div class="flex gap-3 pt-2" data-v-77666de4><button type="button" class="flex-1 py-2.5 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200 transition-colors" data-v-77666de4> Cancelar </button><button type="submit"${t.ssrIncludeBooleanAttr(P.value)?" disabled":""} class="flex-1 py-2.5 bg-gray-900 text-white font-medium rounded-lg hover:bg-gray-800 transition-colors disabled:opacity-50" data-v-77666de4>${t.ssrInterpolate(P.value?"Guardando...":"Guardar")}</button></div></form>`):(a('\x3c!--[--\x3e<div class="px-5 py-3 border-b border-gray-100 flex items-center gap-2 flex-wrap" data-v-77666de4>'),Z.value?(a(`<button${t.ssrIncludeBooleanAttr(h.value)?" disabled":""} class="flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-blue-700 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors disabled:opacity-50" data-v-77666de4>`),a(t.ssrRenderComponent(e.unref(d),{class:"w-4 h-4"},null,s)),a(` ${t.ssrInterpolate(h.value?"Marcando...":"Marcar realizada")}</button>`)):a("\x3c!----\x3e"),a('<button class="flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors" data-v-77666de4>'),a(t.ssrRenderComponent(e.unref(l),{class:"w-4 h-4"},null,s)),a(" Editar </button>"),j.value?.telefono?(a('<button class="flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors" data-v-77666de4>'),a(t.ssrRenderComponent(e.unref(i),{class:"w-4 h-4"},null,s)),a(" Llamar </button>")):a("\x3c!----\x3e"),a('</div><div class="px-5 py-4 border-b border-gray-100" data-v-77666de4><div class="flex items-center justify-between text-sm" data-v-77666de4><div class="flex items-center gap-4" data-v-77666de4><div class="flex items-center gap-1.5 text-gray-600" data-v-77666de4>'),a(t.ssrRenderComponent(e.unref(c),{class:"w-4 h-4 text-gray-400"},null,s)),a(`<span data-v-77666de4>${t.ssrInterpolate(q.value)}</span></div><div class="flex items-center gap-1.5 text-gray-600" data-v-77666de4>`),a(t.ssrRenderComponent(e.unref(u),{class:"w-4 h-4 text-gray-400"},null,s)),a(`<span data-v-77666de4>${t.ssrInterpolate(V.value)}</span></div><div class="flex items-center gap-1.5 text-gray-600" data-v-77666de4>`),t.ssrRenderVNode(a,e.createVNode(e.resolveDynamicComponent("virtual"===B.value.modalidad?e.unref(render):e.unref(render$1)),{class:"w-4 h-4 text-gray-400"},null),s),a(`<span data-v-77666de4>${t.ssrInterpolate(N.value)}</span></div></div><span class="text-gray-500" data-v-77666de4>${t.ssrInterpolate(L.value)} min</span></div></div><div class="mx-5 my-4" data-v-77666de4>`),a(t.ssrRenderComponent(b,{"estado-pago":G.value,"metodo-pago":B.value.metodo_pago,"fecha-pago":B.value.fecha_pago,cantidad:re.value,"show-actions":W.value||"pagado"===G.value,onRegistrar:abrirModalPago,onCambiar:abrirCambiarMetodo,onDeshacer:e=>D.value=!0},null,s)),"pendiente"!==G.value||W.value||"pendiente"!==B.value.estado?a("\x3c!----\x3e"):a('<p class="mt-2 text-xs text-amber-600 text-center" data-v-77666de4> Confirma la cita primero para poder registrar el pago </p>'),D.value?a(`<div class="mt-3 p-3 bg-red-50 border border-red-200 rounded-lg" data-v-77666de4><p class="text-sm text-red-800 mb-3" data-v-77666de4> ¬øEst√°s seguro de deshacer este pago? </p><div class="flex gap-2" data-v-77666de4><button type="button" class="flex-1 px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50"${t.ssrIncludeBooleanAttr(R.value)?" disabled":""} data-v-77666de4> Cancelar </button><button type="button" class="flex-1 px-3 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 disabled:opacity-50"${t.ssrIncludeBooleanAttr(R.value)?" disabled":""} data-v-77666de4>${t.ssrInterpolate(R.value?"Deshaciendo...":"S√≠, deshacer")}</button></div></div>`):a("\x3c!----\x3e"),a("</div>"),_.value?a(t.ssrRenderComponent(z,{"cita-id":B.value.id,"paciente-nombre":j.value?.nombre_completo||"Paciente",cantidad:re.value,"tipo-transaccion":E.value?"sesion_bono":"sesion_unica","bono-info":ne.value,"hora-inicio":B.value.hora_inicio?.substring(0,5),"metodo-pago-actual":B.value.metodo_pago,"modo-edicion":C.value,onConfirm:handlePagoConfirmado,onCancel:cancelarModalPago},null,s)):a("\x3c!----\x3e"),a(`<div class="mx-5 mb-3" data-v-77666de4><button class="${t.ssrRenderClass([U.value?"bg-purple-50 hover:bg-purple-100":"bg-gray-50 hover:bg-gray-100","w-full flex items-center justify-between px-4 py-3 rounded-lg transition-colors"])}" data-v-77666de4><div class="flex items-center gap-2" data-v-77666de4>`),a(t.ssrRenderComponent(e.unref(p),{class:["w-4 h-4",U.value?"text-purple-500":"text-gray-400"]},null,s)),a(`<span class="${t.ssrRenderClass([U.value?"text-purple-700":"text-gray-700","text-sm font-medium"])}" data-v-77666de4>${t.ssrInterpolate(U.value?"Bono del paciente":"Sin bono asignado")}</span>`),U.value?a(`<span class="${t.ssrRenderClass([E.value?"bg-purple-100 text-purple-600":"bg-gray-100 text-gray-500","text-xs px-1.5 py-0.5 rounded"])}" data-v-77666de4>${t.ssrInterpolate(E.value?"Asignado":"Disponible")}</span>`):a("\x3c!----\x3e"),a('</div><div class="flex items-center gap-2" data-v-77666de4>'),U.value?a(`<span class="text-xs text-gray-500" data-v-77666de4>${t.ssrInterpolate(Y.value)}/${t.ssrInterpolate(U.value.sesiones_totales)}</span>`):a("\x3c!----\x3e"),t.ssrRenderVNode(a,e.createVNode(e.resolveDynamicComponent(I.value?e.unref(render$2):e.unref(v)),{class:"w-4 h-4 text-gray-400"},null),s),a("</div></button>"),I.value?(a('<div class="mt-2 overflow-hidden" data-v-77666de4>'),U.value?(a(`<div class="p-4 bg-white border border-gray-100 rounded-lg space-y-3" data-v-77666de4><div class="flex items-center justify-between" data-v-77666de4><div data-v-77666de4><span class="text-sm font-medium text-gray-900" data-v-77666de4>${t.ssrInterpolate(oe.value)}</span>`),U.value.pagado?a('<span class="ml-2 text-xs text-green-600 font-medium" data-v-77666de4>Pagado</span>'):a('<span class="ml-2 text-xs text-amber-600 font-medium" data-v-77666de4>Pago pendiente</span>'),a("</div>"),ee.value?a(`<div class="${t.ssrRenderClass([te.value?"text-red-600":ae.value?"text-amber-600":"text-gray-500","text-xs"])}" data-v-77666de4>${t.ssrInterpolate(te.value?"Vencido":`Vence ${ee.value}`)}</div>`):a("\x3c!----\x3e"),a(`</div><div data-v-77666de4><div class="flex items-center justify-between text-xs text-gray-500 mb-1" data-v-77666de4><span data-v-77666de4>Sesiones usadas</span><span class="font-medium" data-v-77666de4>${t.ssrInterpolate(Y.value)} de ${t.ssrInterpolate(U.value.sesiones_totales)}</span></div><div class="h-2 bg-gray-200 rounded-full overflow-hidden" data-v-77666de4><div class="${t.ssrRenderClass([U.value.sesiones_restantes<=1?"bg-amber-500":"bg-purple-500","h-full transition-all duration-300 rounded-full"])}" style="${t.ssrRenderStyle({width:`${J.value}%`})}" data-v-77666de4></div></div></div>`),1===U.value.sesiones_restantes?(a('<div class="flex items-center gap-2 p-2 bg-amber-50 border border-amber-100 rounded-lg" data-v-77666de4>'),a(t.ssrRenderComponent(e.unref(m),{class:"w-4 h-4 text-amber-500 flex-shrink-0"},null,s)),a('<span class="text-xs text-amber-700" data-v-77666de4>√öltima sesi√≥n disponible</span></div>')):a("\x3c!----\x3e"),te.value?(a('<div class="flex items-center gap-2 p-2 bg-red-50 border border-red-100 rounded-lg" data-v-77666de4>'),a(t.ssrRenderComponent(e.unref(m),{class:"w-4 h-4 text-red-500 flex-shrink-0"},null,s)),a('<span class="text-xs text-red-700" data-v-77666de4>Este bono ha vencido</span></div>')):a("\x3c!----\x3e"),E.value?(a(`<div class="${t.ssrRenderClass([B.value.sesion_descontada?"bg-green-50":"bg-gray-50","flex items-center gap-2 p-2 rounded-lg"])}" data-v-77666de4>`),B.value.sesion_descontada?a(t.ssrRenderComponent(e.unref(d),{class:"w-4 h-4 text-green-500"},null,s)):a(t.ssrRenderComponent(e.unref(u),{class:"w-4 h-4 text-gray-400"},null,s)),a(`<span class="${t.ssrRenderClass([B.value.sesion_descontada?"text-green-700":"text-gray-600","text-xs"])}" data-v-77666de4>${t.ssrInterpolate(B.value.sesion_descontada?"Sesi√≥n consumida de este bono":"Sesi√≥n pendiente de consumir")}</span></div>`)):a("\x3c!----\x3e"),a('<div class="flex items-center gap-2 pt-2 border-t border-gray-100" data-v-77666de4>'),K.value?(a(`<button${t.ssrIncludeBooleanAttr(A.value)?" disabled":""} class="flex-1 flex items-center justify-center gap-1.5 px-3 py-2 text-sm font-medium text-purple-700 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors disabled:opacity-50" data-v-77666de4>`),a(t.ssrRenderComponent(e.unref(g),{class:"w-4 h-4"},null,s)),a(` ${t.ssrInterpolate(A.value?"Asignando...":"Asignar a esta cita")}</button>`)):a("\x3c!----\x3e"),X.value?(a(`<button${t.ssrIncludeBooleanAttr(k.value)?" disabled":""} class="flex-1 flex items-center justify-center gap-1.5 px-3 py-2 text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors disabled:opacity-50" data-v-77666de4>`),a(t.ssrRenderComponent(e.unref(d),{class:"w-4 h-4"},null,s)),a(` ${t.ssrInterpolate(k.value?"Consumiendo...":"Consumir sesi√≥n")}</button>`)):a("\x3c!----\x3e"),a('<button class="flex items-center gap-1.5 px-3 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors" data-v-77666de4>'),a(t.ssrRenderComponent(e.unref(render$3),{class:"w-4 h-4"},null,s)),a('<span class="hidden sm:inline" data-v-77666de4>Ver detalles</span></button></div></div>')):(a('<div class="p-4 bg-gray-50 border border-gray-100 rounded-lg text-center" data-v-77666de4><p class="text-sm text-gray-500 mb-3" data-v-77666de4>Este paciente no tiene bono activo</p><button class="inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium text-purple-600 hover:text-purple-700 hover:bg-purple-50 rounded-lg transition-colors" data-v-77666de4>'),a(t.ssrRenderComponent(e.unref(g),{class:"w-4 h-4"},null,s)),a(" Crear bono </button></div>")),a("</div>")):a("\x3c!----\x3e"),a("</div>"),B.value.observaciones?(a('<div class="mx-5 mb-4" data-v-77666de4><button class="w-full flex items-center justify-between px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors" data-v-77666de4><span class="text-sm font-medium text-gray-700" data-v-77666de4>Observaciones</span>'),t.ssrRenderVNode(a,e.createVNode(e.resolveDynamicComponent($.value?e.unref(render$2):e.unref(v)),{class:"w-4 h-4 text-gray-400"},null),s),a("</button>"),$.value?a(`<div class="mt-2 px-4 py-3 bg-gray-50 rounded-lg overflow-hidden" data-v-77666de4><p class="text-sm text-gray-700 whitespace-pre-wrap" data-v-77666de4>${t.ssrInterpolate(B.value.observaciones)}</p></div>`):a("\x3c!----\x3e"),a("</div>")):a("\x3c!----\x3e"),a(`<div class="px-5 py-3 border-t border-gray-100 flex items-center justify-between text-xs text-gray-400" data-v-77666de4><span data-v-77666de4>ID: ${t.ssrInterpolate(B.value.id.substring(0,8))}...</span><div class="flex items-center gap-3" data-v-77666de4><button class="hover:text-gray-600 transition-colors" data-v-77666de4>Ver historial</button><span data-v-77666de4>|</span><button class="hover:text-red-500 transition-colors" data-v-77666de4>Cancelar cita</button></div></div>`),H.value?(a(`<div class="px-5 pb-4" data-v-77666de4><button${t.ssrIncludeBooleanAttr(x.value)?" disabled":""} class="w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-medium rounded-lg transition-colors disabled:opacity-50 flex items-center justify-center gap-2" data-v-77666de4>`),x.value?a('<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24" data-v-77666de4><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" data-v-77666de4></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" data-v-77666de4></path></svg>'):a(t.ssrRenderComponent(e.unref(d),{class:"w-5 h-5"},null,s)),a(` ${t.ssrInterpolate(x.value?"Confirmando...":"Confirmar cita")}</button></div>`)):a("\x3c!----\x3e"),a("\x3c!--]--\x3e")),a("</div>")):(a('<div class="flex-1 flex items-center justify-center p-12 text-center" data-v-77666de4><div data-v-77666de4><div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3" data-v-77666de4>'),a(t.ssrRenderComponent(e.unref(n),{class:"w-6 h-6 text-gray-400"},null,s)),a(`</div><p class="text-gray-600 font-medium" data-v-77666de4>No se encontraron datos</p><p class="text-gray-400 text-sm mt-1" data-v-77666de4>ID: ${t.ssrInterpolate(r.citaId?.substring(0,8))}...</p></div></div>`)),a("</div></div>")):a("\x3c!----\x3e")},"body",!1,s)}}}),I=C.setup;C.setup=(a,t)=>{const o=e.useSSRContext();return(o.modules||(o.modules=new Set)).add("components/ModalDetallesCita.vue"),I?I(a,t):void 0};const $=Object.assign(f(C,[["__scopeId","data-v-77666de4"]]),{__name:"ModalDetallesCita"});export{$ as M,usePayments as u};
//# sourceMappingURL=ModalDetallesCita-DUTiJ_cw.mjs.map
