import{u as e}from"./useSupabaseClient-DykwVqLQ.mjs";import{e as a,f as o,v as r}from"./server.mjs";let s=!1;const useSupabase=()=>{const l=e(),t=a(),n=o("supabase-session",()=>null),i=o("user-profile",()=>null),loadUserProfile=async()=>{if(i.value)return i.value;if(s){let e=0;for(;s&&e<50;)await new Promise(e=>setTimeout(e,100)),e++;if(i.value)return i.value}s=!0;try{let e=0;for(;!t.value&&e<10;)await new Promise(e=>setTimeout(e,100)),e++;const a=t.value?.id||t.value?.sub;if(!a)return console.warn("[useSupabase] No hay usuario autenticado o ID invÃ¡lido despuÃ©s de esperar"),console.warn("[useSupabase] user.value:",t.value),i.value=null,null;console.log("[useSupabase] Cargando perfil para usuario:",a);const{data:o,error:r}=await l.from("profiles").select("*").eq("id",a).single();return r?(console.error("[useSupabase] Error al cargar perfil:",r),console.error("[useSupabase] Error code:",r.code),console.error("[useSupabase] Error message:",r.message),console.error("[useSupabase] Error details:",r.details),console.error("[useSupabase] User ID:",a),i.value=null,null):o?(i.value=o,console.log("[useSupabase] âœ… Perfil cargado correctamente:",o.email,"Rol:",o.rol),"psicologa"===o.rol&&await syncTerapeutaProfile(o),o):(console.warn("[useSupabase] No se encontrÃ³ perfil para el usuario:",a),console.warn("[useSupabase] El usuario existe en auth pero no tiene perfil en la tabla profiles"),i.value=null,null)}catch(e){return console.error("[useSupabase] Error en loadUserProfile:",e),i.value=null,null}finally{s=!1}},syncTerapeutaProfile=async e=>{try{if(console.log("[Sync] Verificando sincronizaciÃ³n con tabla terapeutas..."),!e.email)return void console.warn("[Sync] No se puede sincronizar: email faltante");const a=l,{data:o,error:r}=await a.from("terapeutas").select("*").eq("email",e.email).maybeSingle();if(r&&"PGRST116"!==r.code)return void console.warn("[Sync] Error al buscar terapeuta:",r);const s={id:e.id,nombre_completo:e.nombre||e.email.split("@")[0]||"PsicÃ³loga",email:e.email,telefono:null,especialidad:null,num_colegiada:null,disponibilidad:null,activo:!0,metadata:{sincronizado_desde_profile:!0,ultima_sincronizacion:(new Date).toISOString()}};if(o){if(o.nombre_completo!==s.nombre_completo||o.email!==s.email||!o.activo){console.log("[Sync] Actualizando registro existente en tabla terapeutas...");const{error:o}=await a.from("terapeutas").update({nombre_completo:s.nombre_completo,email:s.email,activo:!0,metadata:s.metadata}).eq("id",e.id);o?console.warn("[Sync] No se pudo actualizar el terapeuta:",o):console.log("[Sync] âœ… Terapeuta actualizado correctamente")}else console.log("[Sync] âœ… Terapeuta ya estÃ¡ sincronizado correctamente")}else{console.log("[Sync] Creando nuevo registro en tabla terapeutas...");const{error:o}=await a.from("terapeutas").insert(s);if(o)if("23505"===o.code){console.log("[Sync] El terapeuta ya existe por ID, actualizando...");const{error:o}=await a.from("terapeutas").update({nombre_completo:s.nombre_completo,email:s.email,activo:!0,metadata:s.metadata}).eq("id",e.id);o?console.warn("[Sync] No se pudo actualizar el terapeuta:",o):console.log("[Sync] âœ… Terapeuta actualizado correctamente")}else console.warn("[Sync] No se pudo insertar el terapeuta:",o);else console.log("[Sync] âœ… Terapeuta creado correctamente en la tabla terapeutas")}}catch(e){console.warn("[Sync] Error al sincronizar terapeuta:",e)}};return{supabase:l,user:r.readonly(t),session:r.readonly(n),userProfile:r.readonly(i),signInWithEmail:async(e,a)=>{console.log("ðŸ§¹ [Auth] Limpiando estado antes del login..."),i.value=null,n.value=null,s=!1;const{data:o,error:r}=await l.auth.signInWithPassword({email:e,password:a});return!r&&o.session&&(console.log("âœ… [Auth] Login exitoso, estableciendo nueva sesiÃ³n"),n.value=o.session),{data:o,error:r}},signUpWithEmail:async(e,a,o)=>{const{data:r,error:s}=await l.auth.signUp({email:e,password:a,options:{data:o}});return{data:r,error:s}},signOut:async()=>{console.log("ðŸšª [Auth] Iniciando cierre de sesiÃ³n...");const{error:e}=await l.auth.signOut();return e?console.error("âŒ [Auth] Error al cerrar sesiÃ³n:",e):(console.log("âœ… [Auth] SesiÃ³n cerrada en Supabase, limpiando estado local..."),n.value=null,i.value=null,s=!1,console.log("ðŸ§¹ [Auth] Estado completamente limpiado")),{error:e}},resetPassword:async e=>{const{data:a,error:o}=await l.auth.resetPasswordForEmail(e,{redirectTo:`${(void 0).location.origin}/reset-password`});return{data:a,error:o}},updatePassword:async e=>{const{data:a,error:o}=await l.auth.updateUser({password:e});return{data:a,error:o}},loadUserProfile:loadUserProfile,getUserRole:async()=>{if(!(t.value?.id||t.value?.sub))return console.warn("[useSupabase] getUserRole: No hay usuario autenticado"),null;if(i.value)return i.value.rol;const e=await loadUserProfile();return e?.rol||null},waitForUser:async(e=20)=>{let a=0;for(;!t.value&&a<e;)await new Promise(e=>setTimeout(e,100)),a++;return t.value},getUserId:()=>t.value?.id||t.value?.sub||null,isAuthenticated:r.computed(()=>!!t.value)}};export{useSupabase as u};
//# sourceMappingURL=useSupabase-CA5R4uuJ.mjs.map
