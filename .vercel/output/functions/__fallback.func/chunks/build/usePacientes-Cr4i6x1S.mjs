import{v as e}from"./server.mjs";const a=new class{enabled=!0;minLevel="debug";sessionId;buffer=[];maxBufferSize=100;constructor(){this.sessionId=this.generateSessionId(),this.minLevel="warn"}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}shouldLog(e){if(!this.enabled)return!1;const a=["debug","info","warn","error"],t=a.indexOf(this.minLevel);return a.indexOf(e)>=t}formatMessage(e){return`${new Date(e.timestamp).toLocaleTimeString("es-ES")} ${`[AGENDA ${e.event.toUpperCase()}]`} ${e.message}`}log(e,a,t,r){if(!this.shouldLog(e))return;const n={timestamp:(new Date).toISOString(),level:e,event:a,message:t,data:r,sessionId:this.sessionId};this.buffer.push(n),this.buffer.length>this.maxBufferSize&&this.buffer.shift();const o=this.formatMessage(n);switch(e){case"debug":console.log(`üîç ${o}`,r||"");break;case"info":console.info(`‚ÑπÔ∏è ${o}`,r||"");break;case"warn":console.warn(`‚ö†Ô∏è ${o}`,r||"");break;case"error":console.error(`‚ùå ${o}`,r||""),n.stack&&console.error("Stack trace:",n.stack)}}debug(e,a,t){this.log("debug",e,a,t)}info(e,a,t){this.log("info",e,a,t)}warn(e,a,t){this.log("warn",e,a,t)}error(e,a,t){const r=t instanceof Error?{name:t.name,message:t.message,stack:t.stack}:t,n={timestamp:(new Date).toISOString(),level:"error",event:e,message:a,data:r,sessionId:this.sessionId,stack:t instanceof Error?t.stack:void 0};this.buffer.push(n),this.buffer.length>this.maxBufferSize&&this.buffer.shift(),console.error(`‚ùå ${this.formatMessage(n)}`,r||""),n.stack&&console.error("Stack trace:",n.stack)}loadRange(e,a,t){this.info("load_range",`Cargadas ${t} citas`,{from:e,to:a,count:t})}create(e,a,t){this.info("create",`Cita creada: ${e}`,{appointmentId:e,date:a,time:t})}update(e,a){this.info("update",`Cita actualizada: ${e}`,{appointmentId:e,changes:a})}move(e,a,t){this.info("move",`Cita movida: ${e}`,{appointmentId:e,from:a,to:t})}statusChange(e,a,t){this.info("status_change",`Estado cambiado: ${a} ‚Üí ${t}`,{appointmentId:e,from:a,to:t})}conflict(e,a,t,r){this.warn("conflict","Conflicto de horario detectado",{appointmentId:e,conflictWith:a,date:t,time:r})}apiError(e,a){this.error("api_error",`Error en API: ${e}`,a instanceof Error?a:{message:a})}realtimeEvent(e,a){this.debug("realtime_event",`Evento en tiempo real: ${e}`,a)}optimisticUpdate(e,a){this.debug("optimistic_update",`Actualizaci√≥n optimista: ${a}`,{appointmentId:e,action:a})}rollback(e,a){this.warn("rollback",`Rollback de cambio: ${a}`,{appointmentId:e,reason:a})}dragStart(e,a){this.debug("drag_start",`Inicio de drag: ${e}`,{appointmentId:e,from:a})}dragEnd(e,a,t){t?this.debug("drag_end","Drag completado exitosamente",{appointmentId:e,to:a}):this.warn("drag_end","Drag cancelado o fallido",{appointmentId:e,to:a})}clickCreate(e,a){this.debug("click_create","Click para crear cita",{date:e,time:a})}filterChange(e){this.debug("filter_change","Filtros actualizados",{filters:e})}getBuffer(){return[...this.buffer]}clearBuffer(){this.buffer=[]}downloadLogs(){const e=this.buffer.map(e=>JSON.stringify(e)).join("\n"),a=new Blob([e],{type:"application/json"}),t=URL.createObjectURL(a),r=(void 0).createElement("a");r.href=t,r.download=`agenda-logs-${this.sessionId}.json`,r.click(),URL.revokeObjectURL(t)}setEnabled(e){this.enabled=e}setMinLevel(e){this.minLevel=e}getSessionId(){return this.sessionId}};function usePacientes(){const t=e.ref([]),r=e.ref(!1),n=e.ref(null),o=e.ref(""),s=e.ref(null),i=e.ref(new Map);async function searchPacientes(e){try{r.value=!0,n.value=null;const o=e.trim().toLowerCase(),s=i.value.get(o);if(s)return t.value=s,a.debug("search",`Resultados desde cache: ${s.length}`),void(r.value=!1);a.debug("search",`Buscando pacientes via API: "${o}"`);const c=await $fetch("/api/patients/search",{method:"GET",query:{q:o}});if(!c.success)throw new Error("Error al buscar pacientes");const l=c.data;t.value=l,i.value.set(o,l),setTimeout(()=>{i.value.delete(o)},3e5),a.info("search",`Pacientes encontrados: ${l.length}`)}catch(e){const r=e.data?.message||e.message||"Error al buscar pacientes";n.value=r,a.error("api_error",r,e),t.value=[]}finally{r.value=!1}}function debouncedSearch(e,a=300){s.value&&clearTimeout(s.value),0!==e.trim().length?s.value=setTimeout(()=>{searchPacientes(e)},a):searchPacientes(e)}e.watch(o,e=>{debouncedSearch(e)});const c=e.computed(()=>t.value.length>0),l=e.computed(()=>r.value),u=e.computed(()=>null!==n.value);return{pacientes:t,loading:l,error:u,searchQuery:o,hasPacientes:c,searchPacientes:searchPacientes,debouncedSearch:debouncedSearch,createPaciente:async function(e){try{if(r.value=!0,n.value=null,a.debug("create","Creando paciente r√°pido via API",e),!e.nombre_completo||e.nombre_completo.trim().length<2)return{success:!1,error:"El nombre debe tener al menos 2 caracteres"};if(!e.email||!e.email.includes("@"))return{success:!1,error:"Email inv√°lido"};const o=await $fetch("/api/patients/create",{method:"POST",body:{nombre_completo:e.nombre_completo.trim(),email:e.email.trim().toLowerCase(),telefono:e.telefono?.trim()||null,fecha_nacimiento:e.fecha_nacimiento||null,observaciones:e.observaciones?.trim()||null}});if(!o.success)throw new Error(o.message||"Error al crear paciente");const s={id:o.data.id,nombre_completo:o.data.nombre_completo,email:o.data.email,telefono:o.data.telefono,fecha_nacimiento:o.data.fecha_nacimiento,bonos_activos:0,sesiones_restantes_total:0,proximo_vencimiento:null,bono_activo:null,bonos:[]};return t.value.unshift(s),i.value.clear(),a.info("create",`Paciente creado: ${s.id}`),{success:!0,data:s}}catch(e){const t=e.data?.message||e.message||"Error al crear paciente";return n.value=t,a.error("api_error",t,e),{success:!1,error:t}}finally{r.value=!1}},loadAllPacientes:async function(){await searchPacientes("")},clearSearch:function(){o.value="",t.value=[],n.value=null},invalidateCache:function(){i.value.clear(),a.debug("cache","Cache invalidado")},clearError:()=>{n.value=null}}}export{a,usePacientes as u};
//# sourceMappingURL=usePacientes-Cr4i6x1S.mjs.map
