import{v as e,e as t,s as a}from"./server.mjs";import{_ as r}from"./_plugin-vue_export-helper-1tPrXgE0.mjs";import{u as s}from"./useSupabaseClient-DykwVqLQ.mjs";import{u as o}from"./useSupabase-CA5R4uuJ.mjs";import"entities/lib/decode.js";import"../routes/renderer.mjs";import"../nitro/nitro.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"../_/shared.cjs.prod.mjs";import"estree-walker";import"source-map-js";import"node:stream";import"devalue";import"@supabase/ssr";import"@vercel/analytics/nuxt";const n=e.defineComponent({__name:"MensajeCard",__ssrInlineRender:!0,props:{texto:{},fecha:{},remitente:{type:Boolean},visto:{type:Boolean,default:!1}},setup:t=>(r,s,o,n)=>{s(`<div${a.ssrRenderAttrs(e.mergeProps({class:["p-4 rounded-lg max-w-[80%] transition-all duration-200",t.remitente?"bg-[#EAD5D3]/50 self-end text-right ml-auto":"bg-white border border-[#EAD5D3]/40 self-start shadow-sm"]},n))} data-v-0713e701><p class="text-[#5D4A44] font-[&#39;Lato&#39;] text-sm leading-relaxed whitespace-pre-wrap break-words" data-v-0713e701>${a.ssrInterpolate(t.texto)}</p><div class="${a.ssrRenderClass([t.remitente?"justify-end":"justify-start","flex items-center gap-2 mt-2"])}" data-v-0713e701><p class="text-[10px] text-[#5D4A44]/50 font-[&#39;Lato&#39;]" data-v-0713e701>${a.ssrInterpolate((e=>{const t="string"==typeof e?new Date(e):e,a=new Date,r=a.getTime()-t.getTime(),s=Math.floor(r/6e4),o=Math.floor(r/36e5),n=Math.floor(r/864e5);return s<1?"Ahora":s<60?`Hace ${s}m`:o<24?`Hace ${o}h`:n<7?`Hace ${n}d`:t.toLocaleDateString("es-ES",{day:"2-digit",month:"short",year:t.getFullYear()!==a.getFullYear()?"numeric":void 0})})(t.fecha))}</p>`),t.remitente&&!t.visto?s('<span class="inline-block w-2 h-2 bg-[#D8AFA0] rounded-full" title="Enviado" data-v-0713e701></span>'):s("\x3c!----\x3e"),s("</div></div>")}}),i=n.setup;n.setup=(t,a)=>{const r=e.useSSRContext();return(r.modules||(r.modules=new Set)).add("components/MensajeCard.vue"),i?i(t,a):void 0};const l=Object.assign(r(n,[["__scopeId","data-v-0713e701"]]),{__name:"MensajeCard"}),d=e.defineComponent({__name:"MensajeInput",__ssrInlineRender:!0,props:{destinatarioId:{},placeholder:{default:"Escribe tu mensaje aquí..."}},emits:["mensajeEnviado"],setup(t,{emit:r}){const{enviarMensaje:s}=useMensajeria(),o=e.ref(""),n=e.ref(!1);e.ref(null);const i=e.computed(()=>{const e=o.value.trim();return e.length>0&&e.length<=2e3&&!n.value});return(r,s,l,d)=>{s(`<div${a.ssrRenderAttrs(e.mergeProps({class:"flex items-end gap-3 border-t border-[#EAD5D3]/30 pt-4 bg-[#F9F7F3]"},d))} data-v-624391a0><div class="flex-1 relative" data-v-624391a0><textarea${a.ssrRenderAttr("placeholder",t.placeholder)} class="${a.ssrRenderClass([{"opacity-50 cursor-not-allowed":n.value},"w-full border border-[#EAD5D3]/40 rounded-lg p-3 bg-white resize-none text-sm text-[#5D4A44] font-['Lato'] focus:outline-none focus:ring-2 focus:ring-[#D8AFA0]/50 focus:border-[#D8AFA0] transition-all"])}"${a.ssrIncludeBooleanAttr(n.value)?" disabled":""} rows="1" style="${a.ssrRenderStyle({"min-height":"44px","max-height":"120px"})}" data-v-624391a0>${a.ssrInterpolate(o.value)}</textarea>`),o.value.length>0?s(`<div class="absolute bottom-2 right-2 text-[10px] text-[#5D4A44]/40 font-[&#39;Lato&#39;]" data-v-624391a0>${a.ssrInterpolate(o.value.length)}/2000 </div>`):s("\x3c!----\x3e"),s(`</div><button${a.ssrIncludeBooleanAttr(!i.value||n.value)?" disabled":""} class="${a.ssrRenderClass([{"animate-pulse":n.value},"bg-[#D8AFA0] hover:bg-[#C89B8A] text-white px-5 py-3 rounded-lg transition-all duration-200 font-['Lato'] text-sm font-medium disabled:opacity-40 disabled:cursor-not-allowed flex items-center gap-2 shadow-sm hover:shadow-md"])}" data-v-624391a0>`),n.value?s("\x3c!----\x3e"):s('<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-624391a0><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" data-v-624391a0></path></svg>'),n.value?s("<span data-v-624391a0>Enviando...</span>"):s("<span data-v-624391a0>Enviar</span>"),s("</button></div>")}}}),u=d.setup;d.setup=(t,a)=>{const r=e.useSSRContext();return(r.modules||(r.modules=new Set)).add("components/MensajeInput.vue"),u?u(t,a):void 0};const v=Object.assign(r(d,[["__scopeId","data-v-624391a0"]]),{__name:"MensajeInput"}),c=e.defineComponent({__name:"mensajes",__ssrInlineRender:!0,setup(r){const{conversaciones:n,mensajes:i,loadingConversaciones:d,loadingMensajes:u,listarConversaciones:c}=(()=>{const a=s(),r=t(),o=e.ref([]),n=e.ref([]),i=e.ref(!1),l=e.ref(null),d=e.ref(null),listarConversacionesAlternativo=async()=>{if(!r.value)return[];try{const{data:e,error:t}=await a.from("mensajes").select("\n          *,\n          remitente:profiles!mensajes_remitente_id_fkey(id, nombre, avatar_url),\n          destinatario:profiles!mensajes_destinatario_id_fkey(id, nombre, avatar_url)\n        ").or(`remitente_id.eq.${r.value.id},destinatario_id.eq.${r.value.id}`).order("created_at",{ascending:!1});if(t)throw t;const s=new Map;return e?.forEach(e=>{const t=e.remitente_id===r.value.id,a=t?e.destinatario_id:e.remitente_id,o=t?e.destinatario:e.remitente;s.has(a)||s.set(a,{otro_usuario_id:a,otro_usuario_nombre:o?.nombre||"Usuario",otro_usuario_avatar:o?.avatar_url,ultimo_mensaje:e.mensaje,ultimo_mensaje_fecha:e.created_at,mensajes_no_vistos:0}),t||e.visto||s.get(a).mensajes_no_vistos++}),n.value=Array.from(s.values()),n.value}catch(e){return l.value=e.message||"Error al cargar conversaciones",console.error("Error en listarConversacionesAlternativo:",e),[]}};return{mensajes:o,conversaciones:n,loading:i,error:l,listarConversacion:async e=>{if(!r.value)return l.value="Usuario no autenticado",[];i.value=!0,l.value=null;try{const{data:t,error:s}=await a.from("mensajes").select("\n          *,\n          remitente:profiles!mensajes_remitente_id_fkey(id, nombre, avatar_url, rol),\n          destinatario:profiles!mensajes_destinatario_id_fkey(id, nombre, avatar_url, rol)\n        ").or(`and(remitente_id.eq.${r.value.id},destinatario_id.eq.${e}),and(remitente_id.eq.${e},destinatario_id.eq.${r.value.id})`).order("created_at",{ascending:!0});if(s)throw s;return o.value=t||[],t||[]}catch(e){return l.value=e.message||"Error al cargar conversación",console.error("Error en listarConversacion:",e),[]}finally{i.value=!1}},enviar:async(e,t,s)=>{if(!r.value)return l.value="Usuario no autenticado",null;if(!t.trim())return l.value="El mensaje no puede estar vacío",null;i.value=!0,l.value=null;try{const{data:n,error:i}=await a.from("mensajes").insert({remitente_id:r.value.id,destinatario_id:e,mensaje:t.trim(),sesion_id:s||null,visto:!1}).select("\n          *,\n          remitente:profiles!mensajes_remitente_id_fkey(id, nombre, avatar_url, rol),\n          destinatario:profiles!mensajes_destinatario_id_fkey(id, nombre, avatar_url, rol)\n        ").single();if(i)throw i;return n&&o.value.push(n),n}catch(e){return l.value=e.message||"Error al enviar mensaje",console.error("Error en enviar:",e),null}finally{i.value=!1}},marcarVistos:async e=>{if(r.value)try{const{error:t}=await a.from("mensajes").update({visto:!0}).eq("destinatario_id",r.value.id).eq("remitente_id",e).eq("visto",!1);if(t)throw t;o.value=o.value.map(t=>t.remitente_id===e&&t.destinatario_id===r.value.id?{...t,visto:!0}:t)}catch(e){console.error("Error al marcar mensajes como vistos:",e)}},listarConversaciones:async()=>{if(!r.value)return l.value="Usuario no autenticado",[];i.value=!0,l.value=null;try{const{data:e,error:t}=await a.rpc("obtener_ultimas_conversaciones",{usuario_id:r.value.id});if(t)throw t;return n.value=e||[],e||[]}catch(e){return console.warn("Usando método alternativo para conversaciones:",e),await listarConversacionesAlternativo()}finally{i.value=!1}},contarNoVistos:async()=>{if(!r.value)return 0;try{const{count:e,error:t}=await a.from("mensajes").select("*",{count:"exact",head:!0}).eq("destinatario_id",r.value.id).eq("visto",!1);if(t)throw t;return e||0}catch(e){return console.error("Error al contar mensajes no vistos:",e),0}},suscribirseAConversacion:e=>{r.value&&!d.value&&(d.value=a.channel(`mensajes:${r.value.id}:${e}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"mensajes",filter:`destinatario_id=eq.${r.value.id}`},async e=>{const{data:t}=await a.from("mensajes").select("\n              *,\n              remitente:profiles!mensajes_remitente_id_fkey(id, nombre, avatar_url, rol),\n              destinatario:profiles!mensajes_destinatario_id_fkey(id, nombre, avatar_url, rol)\n            ").eq("id",e.new.id).single();t&&o.value.push(t)}).subscribe())},desuscribirse:async()=>{d.value&&(await a.removeChannel(d.value),d.value=null)}}})();t();const{getUserId:m}=o(),f=e.ref(null),p=e.ref(null),esMensajeMio=e=>e.remitente_id===m(),handleMensajeEnviado=()=>{e.nextTick(()=>{p.value&&(p.value.scrollTop=p.value.scrollHeight)})},obtenerIniciales=e=>e.split(" ").map(e=>e[0]).slice(0,2).join("").toUpperCase();return e.watch(i,()=>{i.value.length>0&&c()},{deep:!0}),(t,r,s,o)=>{const c=l,m=v;r(`<div${a.ssrRenderAttrs(e.mergeProps({class:"flex h-[calc(100vh-8rem)] max-w-7xl mx-auto px-4 py-8 gap-6"},o))} data-v-130b4f21><aside class="${a.ssrRenderClass([{"hidden lg:block":e.unref(f)},"w-80 bg-white rounded-xl shadow-sm border border-[#EAD5D3]/30 overflow-hidden flex-shrink-0"])}" data-v-130b4f21><div class="px-4 py-5 border-b border-[#EAD5D3]/30 bg-[#F9F7F3]" data-v-130b4f21><h2 class="text-lg font-lora font-semibold text-[#5D4A44]" data-v-130b4f21> Conversaciones </h2><p class="text-xs text-[#5D4A44]/60 font-lato mt-1" data-v-130b4f21>${a.ssrInterpolate(e.unref(n).length)} pacientes </p></div><div class="overflow-y-auto h-[calc(100%-5rem)]" data-v-130b4f21>`),e.unref(d)?r('<div class="p-8 text-center" data-v-130b4f21><div class="inline-block w-8 h-8 border-4 border-[#EAD5D3] border-t-[#D8AFA0] rounded-full animate-spin" data-v-130b4f21></div></div>'):0===e.unref(n).length?r('<div class="p-8 text-center text-[#5D4A44]/60 font-lato text-sm" data-v-130b4f21><svg class="w-12 h-12 mx-auto mb-3 text-[#EAD5D3]" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-130b4f21><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" data-v-130b4f21></path></svg><p data-v-130b4f21>No tienes conversaciones activas</p></div>'):r("\x3c!----\x3e"),r("\x3c!--[--\x3e"),a.ssrRenderList(e.unref(n),t=>{r(`<button class="${a.ssrRenderClass([{"bg-[#EAD5D3]/20 hover:bg-[#EAD5D3]/30":e.unref(f)?.otro_usuario_id===t.otro_usuario_id},"w-full px-4 py-4 hover:bg-[#F9F7F3] transition-colors border-b border-[#EAD5D3]/20 text-left group"])}" data-v-130b4f21><div class="flex items-start gap-3" data-v-130b4f21><div class="flex-shrink-0" data-v-130b4f21>`),t.otro_usuario_avatar?r(`<div class="w-12 h-12 rounded-full overflow-hidden" data-v-130b4f21><img${a.ssrRenderAttr("src",t.otro_usuario_avatar)}${a.ssrRenderAttr("alt",t.otro_usuario_nombre)} class="w-full h-full object-cover" data-v-130b4f21></div>`):r(`<div class="w-12 h-12 rounded-full bg-[#D8AFA0]/30 flex items-center justify-center" data-v-130b4f21><span class="text-[#5D4A44] font-lora text-lg font-medium" data-v-130b4f21>${a.ssrInterpolate(obtenerIniciales(t.otro_usuario_nombre))}</span></div>`),r(`</div><div class="flex-1 min-w-0" data-v-130b4f21><div class="flex items-start justify-between gap-2" data-v-130b4f21><h3 class="${a.ssrRenderClass([{"font-semibold":t.mensajes_no_vistos>0},"text-sm font-medium text-[#5D4A44] font-lato truncate"])}" data-v-130b4f21>${a.ssrInterpolate(t.otro_usuario_nombre)}</h3><span class="text-xs text-[#5D4A44]/50 font-lato flex-shrink-0" data-v-130b4f21>${a.ssrInterpolate((e=>{const t=new Date(e),a=(new Date).getTime()-t.getTime(),r=Math.floor(a/6e4),s=Math.floor(a/36e5),o=Math.floor(a/864e5);return r<1?"Ahora":r<60?`${r}m`:s<24?`${s}h`:o<7?`${o}d`:t.toLocaleDateString("es-ES",{day:"2-digit",month:"short"})})(t.ultimo_mensaje_fecha))}</span></div><p class="${a.ssrRenderClass([{"font-medium":t.mensajes_no_vistos>0},"text-xs text-[#5D4A44]/70 font-lato mt-1 truncate"])}" data-v-130b4f21>${a.ssrInterpolate(t.ultimo_mensaje)}</p>`),t.mensajes_no_vistos>0?r(`<div class="inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-[#D8AFA0] rounded-full mt-2" data-v-130b4f21>${a.ssrInterpolate(t.mensajes_no_vistos)}</div>`):r("\x3c!----\x3e"),r("</div></div></button>")}),r('\x3c!--]--\x3e</div></aside><main class="flex-1 flex flex-col bg-white rounded-xl shadow-sm border border-[#EAD5D3]/30 overflow-hidden" data-v-130b4f21>'),e.unref(f)?(r('<div class="flex-1 flex flex-col" data-v-130b4f21><header class="px-6 py-4 border-b border-[#EAD5D3]/30 bg-[#F9F7F3] flex items-center gap-4" data-v-130b4f21><button class="lg:hidden p-2 -ml-2 rounded-lg hover:bg-white/50 transition-colors" data-v-130b4f21><svg class="w-5 h-5 text-[#5D4A44]" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-130b4f21><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" data-v-130b4f21></path></svg></button><div class="flex items-center gap-3 flex-1" data-v-130b4f21>'),e.unref(f).otro_usuario_avatar?r(`<div class="w-10 h-10 rounded-full overflow-hidden" data-v-130b4f21><img${a.ssrRenderAttr("src",e.unref(f).otro_usuario_avatar)}${a.ssrRenderAttr("alt",e.unref(f).otro_usuario_nombre)} class="w-full h-full object-cover" data-v-130b4f21></div>`):r(`<div class="w-10 h-10 rounded-full bg-[#D8AFA0]/30 flex items-center justify-center" data-v-130b4f21><span class="text-[#5D4A44] font-lora text-sm font-medium" data-v-130b4f21>${a.ssrInterpolate(obtenerIniciales(e.unref(f).otro_usuario_nombre))}</span></div>`),r(`<div data-v-130b4f21><h2 class="text-base font-lato font-semibold text-[#5D4A44]" data-v-130b4f21>${a.ssrInterpolate(e.unref(f).otro_usuario_nombre)}</h2><p class="text-xs text-[#5D4A44]/60 font-lato" data-v-130b4f21> Paciente </p></div></div></header><div class="flex-1 overflow-y-auto p-6 space-y-3 bg-[#F9F7F3]/30" data-v-130b4f21>`),e.unref(u)?r('<div class="flex items-center justify-center h-full" data-v-130b4f21><div class="inline-block w-8 h-8 border-4 border-[#EAD5D3] border-t-[#D8AFA0] rounded-full animate-spin" data-v-130b4f21></div></div>'):(r("\x3c!--[--\x3e"),a.ssrRenderList(e.unref(i),e=>{r(a.ssrRenderComponent(c,{key:e.id,texto:e.mensaje,fecha:e.created_at,remitente:esMensajeMio(e),visto:e.visto},null,s))}),r("\x3c!--]--\x3e")),r('</div><div class="px-6 py-4 border-t border-[#EAD5D3]/30 bg-white" data-v-130b4f21>'),e.unref(f)?r(a.ssrRenderComponent(m,{"destinatario-id":e.unref(f).otro_usuario_id,placeholder:"Escribe tu respuesta con calma...",onMensajeEnviado:handleMensajeEnviado},null,s)):r("\x3c!----\x3e"),r("</div></div>")):r('<div class="flex-1 flex flex-col items-center justify-center p-8 text-center" data-v-130b4f21><div class="w-24 h-24 rounded-full bg-[#EAD5D3]/30 flex items-center justify-center mb-6" data-v-130b4f21><svg class="w-12 h-12 text-[#D8AFA0]" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-130b4f21><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" data-v-130b4f21></path></svg></div><h3 class="text-xl font-lora font-medium text-[#5D4A44] mb-2" data-v-130b4f21> Selecciona una conversación </h3><p class="text-sm text-[#5D4A44]/60 font-lato max-w-md" data-v-130b4f21> Elige un paciente de la lista para ver su conversación y responder sus mensajes. </p></div>'),r("</main></div>")}}}),m=c.setup;c.setup=(t,a)=>{const r=e.useSSRContext();return(r.modules||(r.modules=new Set)).add("pages/terapeuta/mensajes.vue"),m?m(t,a):void 0};const f=r(c,[["__scopeId","data-v-130b4f21"]]);export{f as default};
//# sourceMappingURL=mensajes-B-iK4_dv.mjs.map
