import{defineComponent as e,ref as a,watch as t,mergeProps as r,unref as s,nextTick as o,computed as n,useSSRContext as i}from"vue";import{ssrRenderAttrs as l,ssrRenderClass as d,ssrInterpolate as u,ssrRenderList as v,ssrRenderAttr as c,ssrRenderComponent as m,ssrRenderStyle as f,ssrIncludeBooleanAttr as p}from"vue/server-renderer";import{_ as b}from"./_plugin-vue_export-helper-1tPrXgE0.mjs";import{u as h}from"./useSupabaseClient-DykwVqLQ.mjs";import{e as _}from"./server.mjs";import{u as x}from"./useSupabase-DljD0dj8.mjs";import"../nitro/nitro.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"../routes/renderer.mjs";import"unhead/server";import"devalue";import"unhead/plugins";import"unhead/utils";import"vue-router";import"@supabase/ssr";import"@vercel/analytics/nuxt";const g=e({__name:"MensajeCard",__ssrInlineRender:!0,props:{texto:{},fecha:{},remitente:{type:Boolean},visto:{type:Boolean,default:!1}},setup:e=>(a,t,s,o)=>{t(`<div${l(r({class:["p-4 rounded-lg max-w-[80%] transition-all duration-200",e.remitente?"bg-[#EAD5D3]/50 self-end text-right ml-auto":"bg-white border border-[#EAD5D3]/40 self-start shadow-sm"]},o))} data-v-0713e701><p class="text-[#5D4A44] font-[&#39;Lato&#39;] text-sm leading-relaxed whitespace-pre-wrap break-words" data-v-0713e701>${u(e.texto)}</p><div class="${d([e.remitente?"justify-end":"justify-start","flex items-center gap-2 mt-2"])}" data-v-0713e701><p class="text-[10px] text-[#5D4A44]/50 font-[&#39;Lato&#39;]" data-v-0713e701>${u((e=>{const a="string"==typeof e?new Date(e):e,t=new Date,r=t.getTime()-a.getTime(),s=Math.floor(r/6e4),o=Math.floor(r/36e5),n=Math.floor(r/864e5);return s<1?"Ahora":s<60?`Hace ${s}m`:o<24?`Hace ${o}h`:n<7?`Hace ${n}d`:a.toLocaleDateString("es-ES",{day:"2-digit",month:"short",year:a.getFullYear()!==t.getFullYear()?"numeric":void 0})})(e.fecha))}</p>`),e.remitente&&!e.visto?t('<span class="inline-block w-2 h-2 bg-[#D8AFA0] rounded-full" title="Enviado" data-v-0713e701></span>'):t("\x3c!----\x3e"),t("</div></div>")}}),w=g.setup;g.setup=(e,a)=>{const t=i();return(t.modules||(t.modules=new Set)).add("components/MensajeCard.vue"),w?w(e,a):void 0};const j=Object.assign(b(g,[["__scopeId","data-v-0713e701"]]),{__name:"MensajeCard"}),D=e({__name:"MensajeInput",__ssrInlineRender:!0,props:{destinatarioId:{},placeholder:{default:"Escribe tu mensaje aquí..."}},emits:["mensajeEnviado"],setup(e,{emit:t}){const{enviarMensaje:s}=useMensajeria(),o=a(""),i=a(!1);a(null);const v=n(()=>{const e=o.value.trim();return e.length>0&&e.length<=2e3&&!i.value});return(a,t,s,n)=>{t(`<div${l(r({class:"flex items-end gap-3 border-t border-[#EAD5D3]/30 pt-4 bg-[#F9F7F3]"},n))} data-v-624391a0><div class="flex-1 relative" data-v-624391a0><textarea${c("placeholder",e.placeholder)} class="${d([{"opacity-50 cursor-not-allowed":i.value},"w-full border border-[#EAD5D3]/40 rounded-lg p-3 bg-white resize-none text-sm text-[#5D4A44] font-['Lato'] focus:outline-none focus:ring-2 focus:ring-[#D8AFA0]/50 focus:border-[#D8AFA0] transition-all"])}"${p(i.value)?" disabled":""} rows="1" style="${f({"min-height":"44px","max-height":"120px"})}" data-v-624391a0>${u(o.value)}</textarea>`),o.value.length>0?t(`<div class="absolute bottom-2 right-2 text-[10px] text-[#5D4A44]/40 font-[&#39;Lato&#39;]" data-v-624391a0>${u(o.value.length)}/2000 </div>`):t("\x3c!----\x3e"),t(`</div><button${p(!v.value||i.value)?" disabled":""} class="${d([{"animate-pulse":i.value},"bg-[#D8AFA0] hover:bg-[#C89B8A] text-white px-5 py-3 rounded-lg transition-all duration-200 font-['Lato'] text-sm font-medium disabled:opacity-40 disabled:cursor-not-allowed flex items-center gap-2 shadow-sm hover:shadow-md"])}" data-v-624391a0>`),i.value?t("\x3c!----\x3e"):t('<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-624391a0><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" data-v-624391a0></path></svg>'),i.value?t("<span data-v-624391a0>Enviando...</span>"):t("<span data-v-624391a0>Enviar</span>"),t("</button></div>")}}}),A=D.setup;D.setup=(e,a)=>{const t=i();return(t.modules||(t.modules=new Set)).add("components/MensajeInput.vue"),A?A(e,a):void 0};const y=Object.assign(b(D,[["__scopeId","data-v-624391a0"]]),{__name:"MensajeInput"}),$=e({__name:"mensajes",__ssrInlineRender:!0,setup(e){const{conversaciones:n,mensajes:i,loadingConversaciones:f,loadingMensajes:p,listarConversaciones:b}=(()=>{const e=h(),t=_(),r=a([]),s=a([]),o=a(!1),n=a(null),i=a(null),listarConversacionesAlternativo=async()=>{if(!t.value)return[];try{const{data:a,error:r}=await e.from("mensajes").select("\n          *,\n          remitente:profiles!mensajes_remitente_id_fkey(id, nombre, avatar_url),\n          destinatario:profiles!mensajes_destinatario_id_fkey(id, nombre, avatar_url)\n        ").or(`remitente_id.eq.${t.value.id},destinatario_id.eq.${t.value.id}`).order("created_at",{ascending:!1});if(r)throw r;const o=new Map;return null==a||a.forEach(e=>{const a=e.remitente_id===t.value.id,r=a?e.destinatario_id:e.remitente_id,s=a?e.destinatario:e.remitente;o.has(r)||o.set(r,{otro_usuario_id:r,otro_usuario_nombre:(null==s?void 0:s.nombre)||"Usuario",otro_usuario_avatar:null==s?void 0:s.avatar_url,ultimo_mensaje:e.mensaje,ultimo_mensaje_fecha:e.created_at,mensajes_no_vistos:0}),a||e.visto||o.get(r).mensajes_no_vistos++}),s.value=Array.from(o.values()),s.value}catch(e){return n.value=e.message||"Error al cargar conversaciones",console.error("Error en listarConversacionesAlternativo:",e),[]}};return{mensajes:r,conversaciones:s,loading:o,error:n,listarConversacion:async a=>{if(!t.value)return n.value="Usuario no autenticado",[];o.value=!0,n.value=null;try{const{data:s,error:o}=await e.from("mensajes").select("\n          *,\n          remitente:profiles!mensajes_remitente_id_fkey(id, nombre, avatar_url, rol),\n          destinatario:profiles!mensajes_destinatario_id_fkey(id, nombre, avatar_url, rol)\n        ").or(`and(remitente_id.eq.${t.value.id},destinatario_id.eq.${a}),and(remitente_id.eq.${a},destinatario_id.eq.${t.value.id})`).order("created_at",{ascending:!0});if(o)throw o;return r.value=s||[],s||[]}catch(e){return n.value=e.message||"Error al cargar conversación",console.error("Error en listarConversacion:",e),[]}finally{o.value=!1}},enviar:async(a,s,i)=>{if(!t.value)return n.value="Usuario no autenticado",null;if(!s.trim())return n.value="El mensaje no puede estar vacío",null;o.value=!0,n.value=null;try{const{data:o,error:n}=await e.from("mensajes").insert({remitente_id:t.value.id,destinatario_id:a,mensaje:s.trim(),sesion_id:i||null,visto:!1}).select("\n          *,\n          remitente:profiles!mensajes_remitente_id_fkey(id, nombre, avatar_url, rol),\n          destinatario:profiles!mensajes_destinatario_id_fkey(id, nombre, avatar_url, rol)\n        ").single();if(n)throw n;return o&&r.value.push(o),o}catch(e){return n.value=e.message||"Error al enviar mensaje",console.error("Error en enviar:",e),null}finally{o.value=!1}},marcarVistos:async a=>{if(t.value)try{const{error:s}=await e.from("mensajes").update({visto:!0}).eq("destinatario_id",t.value.id).eq("remitente_id",a).eq("visto",!1);if(s)throw s;r.value=r.value.map(e=>e.remitente_id===a&&e.destinatario_id===t.value.id?{...e,visto:!0}:e)}catch(e){console.error("Error al marcar mensajes como vistos:",e)}},listarConversaciones:async()=>{if(!t.value)return n.value="Usuario no autenticado",[];o.value=!0,n.value=null;try{const{data:a,error:r}=await e.rpc("obtener_ultimas_conversaciones",{usuario_id:t.value.id});if(r)throw r;return s.value=a||[],a||[]}catch(e){return console.warn("Usando método alternativo para conversaciones:",e),await listarConversacionesAlternativo()}finally{o.value=!1}},contarNoVistos:async()=>{if(!t.value)return 0;try{const{count:a,error:r}=await e.from("mensajes").select("*",{count:"exact",head:!0}).eq("destinatario_id",t.value.id).eq("visto",!1);if(r)throw r;return a||0}catch(e){return console.error("Error al contar mensajes no vistos:",e),0}},suscribirseAConversacion:a=>{t.value&&!i.value&&(i.value=e.channel(`mensajes:${t.value.id}:${a}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"mensajes",filter:`destinatario_id=eq.${t.value.id}`},async a=>{const{data:t}=await e.from("mensajes").select("\n              *,\n              remitente:profiles!mensajes_remitente_id_fkey(id, nombre, avatar_url, rol),\n              destinatario:profiles!mensajes_destinatario_id_fkey(id, nombre, avatar_url, rol)\n            ").eq("id",a.new.id).single();t&&r.value.push(t)}).subscribe())},desuscribirse:async()=>{i.value&&(await e.removeChannel(i.value),i.value=null)}}})();_();const{getUserId:g}=x(),w=a(null),D=a(null),esMensajeMio=e=>e.remitente_id===g(),handleMensajeEnviado=()=>{o(()=>{D.value&&(D.value.scrollTop=D.value.scrollHeight)})},obtenerIniciales=e=>e.split(" ").map(e=>e[0]).slice(0,2).join("").toUpperCase();return t(i,()=>{i.value.length>0&&b()},{deep:!0}),(e,a,t,o)=>{const b=j,h=y;a(`<div${l(r({class:"flex h-[calc(100vh-8rem)] max-w-7xl mx-auto px-4 py-8 gap-6"},o))} data-v-130b4f21><aside class="${d([{"hidden lg:block":s(w)},"w-80 bg-white rounded-xl shadow-sm border border-[#EAD5D3]/30 overflow-hidden flex-shrink-0"])}" data-v-130b4f21><div class="px-4 py-5 border-b border-[#EAD5D3]/30 bg-[#F9F7F3]" data-v-130b4f21><h2 class="text-lg font-lora font-semibold text-[#5D4A44]" data-v-130b4f21> Conversaciones </h2><p class="text-xs text-[#5D4A44]/60 font-lato mt-1" data-v-130b4f21>${u(s(n).length)} pacientes </p></div><div class="overflow-y-auto h-[calc(100%-5rem)]" data-v-130b4f21>`),s(f)?a('<div class="p-8 text-center" data-v-130b4f21><div class="inline-block w-8 h-8 border-4 border-[#EAD5D3] border-t-[#D8AFA0] rounded-full animate-spin" data-v-130b4f21></div></div>'):0===s(n).length?a('<div class="p-8 text-center text-[#5D4A44]/60 font-lato text-sm" data-v-130b4f21><svg class="w-12 h-12 mx-auto mb-3 text-[#EAD5D3]" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-130b4f21><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" data-v-130b4f21></path></svg><p data-v-130b4f21>No tienes conversaciones activas</p></div>'):a("\x3c!----\x3e"),a("\x3c!--[--\x3e"),v(s(n),e=>{var t;a(`<button class="${d([{"bg-[#EAD5D3]/20 hover:bg-[#EAD5D3]/30":(null==(t=s(w))?void 0:t.otro_usuario_id)===e.otro_usuario_id},"w-full px-4 py-4 hover:bg-[#F9F7F3] transition-colors border-b border-[#EAD5D3]/20 text-left group"])}" data-v-130b4f21><div class="flex items-start gap-3" data-v-130b4f21><div class="flex-shrink-0" data-v-130b4f21>`),e.otro_usuario_avatar?a(`<div class="w-12 h-12 rounded-full overflow-hidden" data-v-130b4f21><img${c("src",e.otro_usuario_avatar)}${c("alt",e.otro_usuario_nombre)} class="w-full h-full object-cover" data-v-130b4f21></div>`):a(`<div class="w-12 h-12 rounded-full bg-[#D8AFA0]/30 flex items-center justify-center" data-v-130b4f21><span class="text-[#5D4A44] font-lora text-lg font-medium" data-v-130b4f21>${u(obtenerIniciales(e.otro_usuario_nombre))}</span></div>`),a(`</div><div class="flex-1 min-w-0" data-v-130b4f21><div class="flex items-start justify-between gap-2" data-v-130b4f21><h3 class="${d([{"font-semibold":e.mensajes_no_vistos>0},"text-sm font-medium text-[#5D4A44] font-lato truncate"])}" data-v-130b4f21>${u(e.otro_usuario_nombre)}</h3><span class="text-xs text-[#5D4A44]/50 font-lato flex-shrink-0" data-v-130b4f21>${u((e=>{const a=new Date(e),t=(new Date).getTime()-a.getTime(),r=Math.floor(t/6e4),s=Math.floor(t/36e5),o=Math.floor(t/864e5);return r<1?"Ahora":r<60?`${r}m`:s<24?`${s}h`:o<7?`${o}d`:a.toLocaleDateString("es-ES",{day:"2-digit",month:"short"})})(e.ultimo_mensaje_fecha))}</span></div><p class="${d([{"font-medium":e.mensajes_no_vistos>0},"text-xs text-[#5D4A44]/70 font-lato mt-1 truncate"])}" data-v-130b4f21>${u(e.ultimo_mensaje)}</p>`),e.mensajes_no_vistos>0?a(`<div class="inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-[#D8AFA0] rounded-full mt-2" data-v-130b4f21>${u(e.mensajes_no_vistos)}</div>`):a("\x3c!----\x3e"),a("</div></div></button>")}),a('\x3c!--]--\x3e</div></aside><main class="flex-1 flex flex-col bg-white rounded-xl shadow-sm border border-[#EAD5D3]/30 overflow-hidden" data-v-130b4f21>'),s(w)?(a('<div class="flex-1 flex flex-col" data-v-130b4f21><header class="px-6 py-4 border-b border-[#EAD5D3]/30 bg-[#F9F7F3] flex items-center gap-4" data-v-130b4f21><button class="lg:hidden p-2 -ml-2 rounded-lg hover:bg-white/50 transition-colors" data-v-130b4f21><svg class="w-5 h-5 text-[#5D4A44]" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-130b4f21><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" data-v-130b4f21></path></svg></button><div class="flex items-center gap-3 flex-1" data-v-130b4f21>'),s(w).otro_usuario_avatar?a(`<div class="w-10 h-10 rounded-full overflow-hidden" data-v-130b4f21><img${c("src",s(w).otro_usuario_avatar)}${c("alt",s(w).otro_usuario_nombre)} class="w-full h-full object-cover" data-v-130b4f21></div>`):a(`<div class="w-10 h-10 rounded-full bg-[#D8AFA0]/30 flex items-center justify-center" data-v-130b4f21><span class="text-[#5D4A44] font-lora text-sm font-medium" data-v-130b4f21>${u(obtenerIniciales(s(w).otro_usuario_nombre))}</span></div>`),a(`<div data-v-130b4f21><h2 class="text-base font-lato font-semibold text-[#5D4A44]" data-v-130b4f21>${u(s(w).otro_usuario_nombre)}</h2><p class="text-xs text-[#5D4A44]/60 font-lato" data-v-130b4f21> Paciente </p></div></div></header><div class="flex-1 overflow-y-auto p-6 space-y-3 bg-[#F9F7F3]/30" data-v-130b4f21>`),s(p)?a('<div class="flex items-center justify-center h-full" data-v-130b4f21><div class="inline-block w-8 h-8 border-4 border-[#EAD5D3] border-t-[#D8AFA0] rounded-full animate-spin" data-v-130b4f21></div></div>'):(a("\x3c!--[--\x3e"),v(s(i),e=>{a(m(b,{key:e.id,texto:e.mensaje,fecha:e.created_at,remitente:esMensajeMio(e),visto:e.visto},null,t))}),a("\x3c!--]--\x3e")),a('</div><div class="px-6 py-4 border-t border-[#EAD5D3]/30 bg-white" data-v-130b4f21>'),s(w)?a(m(h,{"destinatario-id":s(w).otro_usuario_id,placeholder:"Escribe tu respuesta con calma...",onMensajeEnviado:handleMensajeEnviado},null,t)):a("\x3c!----\x3e"),a("</div></div>")):a('<div class="flex-1 flex flex-col items-center justify-center p-8 text-center" data-v-130b4f21><div class="w-24 h-24 rounded-full bg-[#EAD5D3]/30 flex items-center justify-center mb-6" data-v-130b4f21><svg class="w-12 h-12 text-[#D8AFA0]" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-130b4f21><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" data-v-130b4f21></path></svg></div><h3 class="text-xl font-lora font-medium text-[#5D4A44] mb-2" data-v-130b4f21> Selecciona una conversación </h3><p class="text-sm text-[#5D4A44]/60 font-lato max-w-md" data-v-130b4f21> Elige un paciente de la lista para ver su conversación y responder sus mensajes. </p></div>'),a("</main></div>")}}}),E=$.setup;$.setup=(e,a)=>{const t=i();return(t.modules||(t.modules=new Set)).add("pages/terapeuta/mensajes.vue"),E?E(e,a):void 0};const k=b($,[["__scopeId","data-v-130b4f21"]]);export{k as default};
//# sourceMappingURL=mensajes-D4Gefxrh.mjs.map
