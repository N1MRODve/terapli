import{u as o}from"./useSupabaseClient-DykwVqLQ.mjs";import{u as r}from"./useSupabase-DfFg84CY.mjs";import{v as e,n as a}from"./server.mjs";const useRoles=()=>{const{userProfile:o,getUserRole:n}=r(),s=e.computed(()=>"psicologa"===o.value?.rol),t=e.computed(()=>"paciente"===o.value?.rol),c=e.computed(()=>"coordinadora"===o.value?.rol),getDashboardPath=r=>{const e=r||o.value?.rol,a={admin:"/admin/dashboard",psicologa:"/terapeuta/dashboard",coordinadora:"/coordinadora/dashboard",paciente:"/paciente/dashboard"};return e&&e in a?a[e]:"/login"};return{userProfile:e.readonly(o),isPsicologa:s,isPaciente:t,isCoordinadora:c,hasRole:r=>o.value?.rol===r,hasAnyRole:r=>r.some(r=>o.value?.rol===r),getUserRole:n,getRoleName:o=>o?{admin:"Administrador",psicologa:"Psicóloga",paciente:"Paciente",coordinadora:"Coordinadora"}[o]:"Desconocido",getDashboardPath:getDashboardPath,goToDashboard:async()=>{const o=getDashboardPath();await a(o)}}},useBonos=()=>{const a=o(),{userProfile:n}=r(),{isCoordinadora:s}=useRoles(),getBonosPorPaciente=async o=>{try{const{data:r,error:e}=await a.from("bonos").select("*").eq("paciente_id",o).order("created_at",{ascending:!1});return e?(console.warn("[Bonos] Error en consulta getBonosPorPaciente:",e.message),[]):r||[]}catch(o){return console.warn("[Bonos] Error inesperado en getBonosPorPaciente:",o),[]}},t=e.computed(()=>s.value||"psicologa"===n.value?.rol),c=e.computed(()=>s.value);return{getBonosPorPaciente:getBonosPorPaciente,getBonoConPagos:async o=>{try{const{data:r,error:e}=await a.from("bonos").select("*").eq("id",o).single();if(e)return console.warn("[Bonos] Error al obtener bono:",e.message),null;const{data:n,error:s}=await a.from("pagos_bonos").select("*").eq("bono_id",o).order("fecha_pago",{ascending:!1});return s&&console.warn("[Bonos] Error al obtener pagos:",s.message),{bono:r,pagos:n||[]}}catch(o){return console.warn("[Bonos] Error inesperado en getBonoConPagos:",o),null}},getBonosActivos:async o=>{try{const{data:r,error:e}=await a.from("bonos").select("*").eq("paciente_id",o).eq("estado","activo").order("created_at",{ascending:!1});return e?(console.warn("[Bonos] Error en getBonosActivos:",e.message),[]):r||[]}catch(o){return console.warn("[Bonos] Error inesperado en getBonosActivos:",o),[]}},getPagosPorBono:async o=>{try{const{data:r,error:e}=await a.from("pagos_bonos").select("*").eq("bono_id",o).order("fecha_pago",{ascending:!1});return e?(console.warn("[Bonos] Error al obtener pagos:",e.message),[]):r||[]}catch(o){return console.warn("[Bonos] Error inesperado al obtener pagos:",o),[]}},getRenovaciones:async o=>{try{const{data:r,error:e}=await a.from("renovaciones_bonos").select("*").or(`bono_original_id.eq.${o},nuevo_bono_id.eq.${o}`).order("fecha_renovacion",{ascending:!1});return e?(console.warn("[Bonos] Error al obtener renovaciones:",e.message),[]):r||[]}catch(o){return console.warn("[Bonos] Error inesperado al obtener renovaciones:",o),[]}},calcularMetricas:async o=>{try{const r=await getBonosPorPaciente(o),e=r.filter(o=>"activo"===o.estado).length,a=r.filter(o=>"completado"===o.estado).length,n=r.filter(o=>"vencido"===o.estado).length,s=r.filter(o=>"pendiente"===o.estado).length,t=new Date,c=r.filter(o=>{if("activo"!==o.estado||!o.fecha_fin)return!1;const r=new Date(o.fecha_fin),e=Math.ceil((r.getTime()-t.getTime())/864e5);return e>=0&&e<=7}).length,i=r.filter(o=>"activo"===o.estado&&null!==o.sesiones_restantes&&o.sesiones_restantes<=2).length;return{total:r.length,activos:e,completados:a,vencidos:n,pendientes:s,proximosAVencer:c,pocasSesiones:i}}catch(o){return console.warn("[Bonos] Error al calcular métricas:",o),{total:0,activos:0,completados:0,vencidos:0,pendientes:0,proximosAVencer:0,pocasSesiones:0}}},crearBono:async o=>{try{const{data:r,error:e}=await a.from("bonos").insert(o).select().single();if(e)throw console.error("[Bonos] Error al crear bono:",e.message),new Error(`Error al crear bono: ${e.message}`);return r}catch(o){throw console.error("[Bonos] Error inesperado al crear bono:",o),new Error(o.message||"Error al crear el bono")}},actualizarBono:async(o,r)=>{try{const{data:e,error:n}=await a.from("bonos").update({...r,updated_at:(new Date).toISOString()}).eq("id",o).select().single();if(n)throw console.error("[Bonos] Error al actualizar bono:",n.message),new Error(`Error al actualizar bono: ${n.message}`);return e}catch(o){throw console.error("[Bonos] Error inesperado al actualizar bono:",o),new Error(o.message||"Error al actualizar el bono")}},registrarPago:async(o,r,e,s=!1)=>{try{const t={bono_id:o,monto:r,metodo_pago:e,confirmado:s,fecha_pago:(new Date).toISOString().split("T")[0],...s&&{confirmado_por:n.value?.id,fecha_confirmacion:(new Date).toISOString()}},{data:c,error:i}=await a.from("pagos_bonos").insert(t).select().single();if(i)throw console.error("[Bonos] Error al registrar pago:",i.message),new Error(`Error al registrar pago: ${i.message}`);return c}catch(o){throw console.error("[Bonos] Error inesperado al registrar pago:",o),new Error(o.message||"Error al registrar el pago")}},confirmarPago:async o=>{try{const{data:r,error:e}=await a.rpc("fn_confirmar_pago_bono",{p_pago_id:o});if(e)throw console.error("[Bonos] Error al confirmar pago:",e.message),new Error(`Error al confirmar pago: ${e.message}`);const n=r;if(!n.success)throw new Error(n.mensaje||"Error al confirmar el pago");return n}catch(o){throw console.error("[Bonos] Error inesperado al confirmar pago:",o),new Error(o.message||"Error al confirmar el pago")}},renovarBono:async(o,r,e,s)=>{try{const t=n.value?.id;if(!t)throw new Error("Usuario no autenticado");const{data:c,error:i}=await a.rpc("fn_renovar_bono_manual",{p_bono_id:o,p_usuario_id:t,p_motivo:r||null,p_modificar_sesiones:e||null,p_modificar_monto:s||null});if(i)throw console.error("[Bonos] Error al renovar bono:",i.message),new Error(`Error al renovar bono: ${i.message}`);const l=c;if(!l.success)throw new Error(l.mensaje||"Error al renovar el bono");return l}catch(o){throw console.error("[Bonos] Error inesperado al renovar bono:",o),new Error(o.message||"Error al renovar el bono")}},calcularPorcentajeUso:o=>{if(!o.sesiones_totales||0===o.sesiones_totales)return 0;const r=o.sesiones_totales-(o.sesiones_restantes||0);return Math.round(r/o.sesiones_totales*100)},getEstadoColor:o=>({pendiente:"bg-yellow-100 text-yellow-700 border-yellow-300",activo:"bg-green-100 text-green-700 border-green-300",completado:"bg-gray-100 text-gray-600 border-gray-300",vencido:"bg-red-100 text-red-600 border-red-300",cancelado:"bg-gray-200 text-gray-500 border-gray-400 line-through"}[o]||"bg-gray-100 text-gray-600"),getEstadoTexto:o=>({pendiente:"Pendiente de activación",activo:"Activo",completado:"Completado",vencido:"Vencido",cancelado:"Cancelado"}[o]||o),puedeGestionarBonos:t,puedeConfirmarPagos:c}};export{useRoles as a,useBonos as u};
//# sourceMappingURL=useBonos-B2-LOzOF.mjs.map
