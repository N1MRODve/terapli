import{u as e}from"./useSupabaseClient-DykwVqLQ.mjs";import{f as a,g as o,v as r,n as l}from"./server.mjs";let n=!1;const useSupabase=()=>{const t=e(),s=a(),i=o("supabase-session",()=>null),u=o("user-profile",()=>null),loadUserProfile=async()=>{if(u.value)return console.log("[useSupabase] Perfil ya cargado, retornando cache:",u.value.email),u.value;if(n){console.log("[useSupabase] Esperando carga en progreso...");let e=0;for(;n&&e<100;)await new Promise(e=>setTimeout(e,100)),e++;if(u.value){const e=u.value;return console.log("[useSupabase] Perfil cargado durante espera:",e.email),e}}n=!0,console.log("[useSupabase] Iniciando carga de perfil...");try{let e=0;for(;!s.value&&e<20;)await new Promise(e=>setTimeout(e,50)),e++;const a=s.value?.id||s.value?.sub;if(!a)return console.warn("[useSupabase] No hay usuario autenticado o ID invÃ¡lido despuÃ©s de esperar"),u.value=null,null;console.log("[useSupabase] Cargando perfil para usuario:",a);const{data:o,error:r}=await t.from("profiles").select("*").eq("id",a).single();return r?(console.error("[useSupabase] Error al cargar perfil:",r),u.value=null,null):o?(u.value=o,console.log("[useSupabase] âœ… Perfil cargado correctamente:",o.email,"Rol:",o.rol),"psicologa"===o.rol&&await syncTerapeutaProfile(o),o):(console.warn("[useSupabase] No se encontrÃ³ perfil para el usuario:",a),u.value=null,null)}catch(e){return console.error("[useSupabase] Error en loadUserProfile:",e),u.value=null,null}finally{n=!1}},syncTerapeutaProfile=async e=>{try{if(console.log("[Sync] Verificando sincronizaciÃ³n con tabla terapeutas..."),!e.email)return void console.warn("[Sync] No se puede sincronizar: email faltante");const a=t,{data:o,error:r}=await a.from("terapeutas").select("*").eq("email",e.email).maybeSingle();if(r&&"PGRST116"!==r.code)return void console.warn("[Sync] Error al buscar terapeuta:",r);const l={id:e.id,nombre_completo:e.nombre||e.email.split("@")[0]||"PsicÃ³loga",email:e.email,telefono:null,especialidad:null,num_colegiada:null,disponibilidad:null,activo:!0,metadata:{sincronizado_desde_profile:!0,ultima_sincronizacion:(new Date).toISOString()}};if(o){if(o.nombre_completo!==l.nombre_completo||o.email!==l.email||!o.activo){console.log("[Sync] Actualizando registro existente en tabla terapeutas...");const{error:o}=await a.from("terapeutas").update({nombre_completo:l.nombre_completo,email:l.email,activo:!0,metadata:l.metadata}).eq("id",e.id);o?console.warn("[Sync] No se pudo actualizar el terapeuta:",o):console.log("[Sync] âœ… Terapeuta actualizado correctamente")}else console.log("[Sync] âœ… Terapeuta ya estÃ¡ sincronizado correctamente")}else{console.log("[Sync] Creando nuevo registro en tabla terapeutas...");const{error:o}=await a.from("terapeutas").insert(l);if(o)if("23505"===o.code){console.log("[Sync] El terapeuta ya existe por ID, actualizando...");const{error:o}=await a.from("terapeutas").update({nombre_completo:l.nombre_completo,email:l.email,activo:!0,metadata:l.metadata}).eq("id",e.id);o?console.warn("[Sync] No se pudo actualizar el terapeuta:",o):console.log("[Sync] âœ… Terapeuta actualizado correctamente")}else console.warn("[Sync] No se pudo insertar el terapeuta:",o);else console.log("[Sync] âœ… Terapeuta creado correctamente en la tabla terapeutas")}}catch(e){console.warn("[Sync] Error al sincronizar terapeuta:",e)}};return{supabase:t,user:r.readonly(s),session:r.readonly(i),userProfile:r.readonly(u),signInWithEmail:async(e,a)=>{console.log("ðŸ§¹ [Auth] Limpiando estado antes del login..."),u.value=null,i.value=null,n=!1;const{data:o,error:r}=await t.auth.signInWithPassword({email:e,password:a});return!r&&o.session&&(console.log("âœ… [Auth] Login exitoso, estableciendo nueva sesiÃ³n"),i.value=o.session),{data:o,error:r}},signUpWithEmail:async(e,a,o)=>{const{data:r,error:l}=await t.auth.signUp({email:e,password:a,options:{data:o}});return{data:r,error:l}},signOut:async()=>{console.log("ðŸšª [Auth] Iniciando cierre de sesiÃ³n...");const{error:e}=await t.auth.signOut();return e?console.error("âŒ [Auth] Error al cerrar sesiÃ³n:",e):(console.log("âœ… [Auth] SesiÃ³n cerrada en Supabase, limpiando estado local..."),i.value=null,u.value=null,n=!1,console.log("ðŸ”„ [Auth] Redirigiendo a login..."),await l("/login",{replace:!0,external:!1})),{error:e}},resetPassword:async e=>{const{data:a,error:o}=await t.auth.resetPasswordForEmail(e,{redirectTo:`${(void 0).location.origin}/reset-password`});return{data:a,error:o}},updatePassword:async e=>{const{data:a,error:o}=await t.auth.updateUser({password:e});return{data:a,error:o}},loadUserProfile:loadUserProfile,getUserRole:async()=>{if(!(s.value?.id||s.value?.sub))return console.warn("[useSupabase] getUserRole: No hay usuario autenticado"),null;if(u.value)return u.value.rol;const e=await loadUserProfile();return e?.rol||null},waitForUser:async(e=20)=>{let a=0;for(;!s.value&&a<e;)await new Promise(e=>setTimeout(e,100)),a++;return s.value},getUserId:()=>s.value?.id||s.value?.sub||null,isAuthenticated:r.computed(()=>!!s.value)}};export{useSupabase as u};
//# sourceMappingURL=useSupabase-COsu_foS.mjs.map
