import{u as a}from"./useSupabaseClient-DykwVqLQ.mjs";import{e,v as i}from"./server.mjs";import{u as o}from"./useSupabase-CA5R4uuJ.mjs";const useNotificaciones=()=>{const r=a(),t=e(),{getUserId:n}=o(),s=i.ref([]),c=i.ref(!1),l=i.ref(null),u=i.ref(null),d=i.ref(0),f=i.computed(()=>s.value.filter(a=>!a.leido)),v=i.computed(()=>f.value.filter(a=>"bono"===a.tipo&&("alta"===a.metadata?.urgencia||0===a.metadata?.sesiones_restantes))),m=i.computed(()=>v.value.length>0),marcarVista=async a=>{if(t.value)try{const{data:e,error:i}=await r.rpc("marcar_notificacion_leida",{p_notificacion_id:a});if(i)throw i;s.value=s.value.map(e=>e.id===a?{...e,leido:!0,leido_at:(new Date).toISOString()}:e),d.value=Math.max(0,d.value-1)}catch(a){console.error("Error al marcar notificaci칩n como le칤da:",a)}},marcarTodasVistas=async()=>{if(t.value)try{const{data:a,error:e}=await r.rpc("marcar_todas_notificaciones_leidas");if(e)throw e;return s.value=s.value.map(a=>({...a,leido:!0,leido_at:a.leido_at||(new Date).toISOString()})),d.value=0,{success:!0,marcadas:a?.marcadas||0}}catch(a){return console.error("Error al marcar todas las notificaciones como le칤das:",a),{success:!1,error:a.message}}},contarNoVistas=async()=>{if(!t.value)return 0;try{const{data:a,error:e}=await r.rpc("contar_notificaciones_no_leidas");if(e)throw e;return d.value=a||0,a||0}catch(a){return console.error("Error al contar notificaciones no le칤das:",a),0}};return{notificaciones:s,totalNoVistas:d,loading:c,error:l,noLeidas:f,urgentes:v,tieneUrgentes:m,listar:async(a=20)=>{const e=n();if(!e)return console.warn("Usuario no autenticado o ID no disponible"),l.value="Usuario no autenticado",[];c.value=!0,l.value=null;try{const{data:i,error:o}=await r.from("notificaciones").select("*").eq("usuario_id",e).order("created_at",{ascending:!1}).limit(a);if(o){if("PGRST116"===o.code||o.message.includes("does not exist"))return console.warn("丘멆잺 Tabla notificaciones no existe a칰n. Retornando vac칤o."),s.value=[],d.value=0,[];throw o}return s.value=i||[],d.value=(i||[]).filter(a=>!a.visto&&!a.leido).length,i||[]}catch(a){return a.message?.includes("does not exist")||(l.value=a.message||"Error al cargar notificaciones",console.error("Error en listar notificaciones:",a)),[]}finally{c.value=!1}},crear:async(a,e,i,o="mensaje",n)=>{if(!t.value)return l.value="Usuario no autenticado",null;c.value=!0,l.value=null;try{const{data:t,error:s}=await r.from("notificaciones").insert({usuario_id:a,titulo:e,mensaje:i,tipo:o,referencia_id:n||null,visto:!1}).select().single();if(s)throw s;return t}catch(a){return l.value=a.message||"Error al crear notificaci칩n",console.error("Error en crear notificaci칩n:",a),null}finally{c.value=!1}},marcarVista:marcarVista,marcarComoLeida:marcarVista,marcarTodasVistas:marcarTodasVistas,marcarTodasComoLeidas:marcarTodasVistas,contarNoVistas:contarNoVistas,obtenerContador:contarNoVistas,eliminar:async a=>{if(t.value)try{const{error:e}=await r.from("notificaciones").delete().eq("id",a).eq("usuario_id",t.value.id);if(e)throw e;const i=s.value.find(e=>e.id===a);!i||i.leido||i.visto||(d.value=Math.max(0,d.value-1)),s.value=s.value.filter(e=>e.id!==a)}catch(a){console.error("Error al eliminar notificaci칩n:",a)}},eliminarVistas:async()=>{if(t.value)try{const{error:a}=await r.from("notificaciones").delete().eq("usuario_id",t.value.id).eq("leido",!0);if(a)throw a;s.value=s.value.filter(a=>!a.leido)}catch(a){console.error("Error al eliminar notificaciones vistas:",a)}},suscribirse:()=>{t.value&&!u.value&&(u.value=r.channel(`notificaciones:${t.value.id}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"notificaciones",filter:`usuario_id=eq.${t.value.id}`},a=>{const e=a.new;s.value.unshift(e),d.value++,"Notification"in void 0&&"granted"===Notification.permission&&new Notification(e.titulo,{body:e.mensaje,icon:"/icon-notification.png",badge:"bono"===e.tipo&&"alta"===e.metadata?.urgencia?"游댮":"游댒"})}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"notificaciones",filter:`usuario_id=eq.${t.value.id}`},a=>{const e=a.new,i=s.value.findIndex(a=>a.id===e.id);-1!==i&&(s.value[i]=e)}).subscribe())},desuscribirse:async()=>{u.value&&(await r.removeChannel(u.value),u.value=null)},solicitarPermisosNotificaciones:async()=>{"Notification"in void 0&&"default"===Notification.permission&&await Notification.requestPermission()}}};export{useNotificaciones as u};
//# sourceMappingURL=useNotificaciones-Bmi2DWpA.mjs.map
