import{u as e,d as r,g as o,c as s,r as t}from"../../../nitro/nitro.mjs";import{createClient as a}from"@supabase/supabase-js";import{f as i,s as n}from"../../../_/serverSupabaseClient.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"../../../_/index.mjs";import"../../../virtual/_commonjsHelpers.mjs";import"../../../_/index2.mjs";const l=r(async r=>{var l,d,c;if(console.log("[Server] Iniciando crear-terapeuta handler"),"POST"!==o(r))throw console.error("[Server Error] Método no permitido:",o(r)),s({statusCode:405,statusMessage:"Method Not Allowed"});try{let o;console.log("[Server] Leyendo body de la petición...");try{o=await t(r)}catch(e){throw console.error("[Server Error] Error al leer body:",e),s({statusCode:400,statusMessage:"Invalid request body"})}console.log("[Server] Body recibido, validando campos...");const{nombreCompleto:u,email:m,password:g,telefono:v}=o||{};if(!o||"object"!=typeof o)throw console.error("[Server Error] Body inválido:",typeof o),s({statusCode:400,statusMessage:"Request body must be a valid JSON object"});if(!u||"string"!=typeof u||u.trim().length<2)throw console.error("[Server Error] Nombre completo inválido:",u),s({statusCode:400,statusMessage:"nombreCompleto debe ser un string válido con al menos 2 caracteres"});if(!m||"string"!=typeof m||!m.includes("@"))throw console.error("[Server Error] Email inválido:",m),s({statusCode:400,statusMessage:"email debe ser una dirección válida"});if(!g||"string"!=typeof g||g.length<6)throw console.error("[Server Error] Password inválido:",g?"[HIDDEN]":"undefined"),s({statusCode:400,statusMessage:"password debe tener al menos 6 caracteres"});if(console.log("[Server] ✅ Campos validados, creando terapeuta:",m),console.log("[Server] Verificando variables de entorno..."),!process.env.SUPABASE_SERVICE_ROLE_KEY)throw console.error("[Server Error] SUPABASE_SERVICE_ROLE_KEY no configurada"),s({statusCode:500,statusMessage:"Server configuration error: Missing service role key"});if(!process.env.SUPABASE_URL)throw console.error("[Server Error] SUPABASE_URL no configurada"),s({statusCode:500,statusMessage:"Server configuration error: Missing Supabase URL"});let f,p;console.log("[Server] Inicializando cliente Supabase admin...");try{f=(r=>{const o=e(r),s=o.supabase.secretKey,t=o.supabase.serviceKey,n=o.public.supabase.url,l=s||t;if(!l)throw new Error("Missing server key. Set either `SUPABASE_SECRET_KEY` (recommended) or `SUPABASE_SERVICE_KEY` (deprecated) in your environment variables.");return r.context._supabaseServiceRole||(r.context._supabaseServiceRole=a(n,l,{auth:{detectSessionInUrl:!1,persistSession:!1,autoRefreshToken:!1},global:{fetch:i}})),r.context._supabaseServiceRole})(r)}catch(e){throw console.error("[Server Error] Error al inicializar cliente admin:",e),s({statusCode:500,statusMessage:"Failed to initialize admin client"})}console.log("[Server] Obteniendo cliente de usuario autenticado...");try{p=await n(r)}catch(e){throw console.error("[Server Error] Error al obtener cliente de usuario:",e),s({statusCode:500,statusMessage:"Failed to initialize user client"})}console.log("[Server] Verificando autenticación del usuario...");const{data:S,error:E}=await p.auth.getUser();if(E)throw console.error("[Server Error] Error al obtener usuario:",E),s({statusCode:401,statusMessage:"Authentication failed"});const h=null==S?void 0:S.user;if(!h||!h.id)throw console.error("[Server Error] Usuario no encontrado o sin ID"),s({statusCode:401,statusMessage:"User not authenticated"});console.log("[Server] Verificando rol de admin para usuario:",h.id);const{data:w,error:b}=await p.from("profiles").select("rol").eq("id",h.id).single();if(b)throw console.error("[Server Error] Error al obtener perfil:",b),s({statusCode:500,statusMessage:"Failed to verify user permissions"});if(!w||"admin"!==w.rol)throw console.error("[Server Error] Acceso denegado, rol:",null==w?void 0:w.rol),s({statusCode:403,statusMessage:"Access denied. Admin role required"});console.log("[Server] ✅ Usuario admin verificado:",h.email),console.log("[Server] Creando usuario en Auth...");const{data:C,error:y}=await f.auth.admin.createUser({email:m.trim().toLowerCase(),password:g.trim(),email_confirm:!0,user_metadata:{nombre:u.trim(),telefono:v?String(v).trim():"",rol:"psicologa"}});if(y){if(console.error("[Server Error] Error al crear usuario en Auth:",y),null==(l=y.message)?void 0:l.includes("already registered"))throw s({statusCode:409,statusMessage:`Email ${m} ya está registrado`});if(null==(d=y.message)?void 0:d.includes("Password should be"))throw s({statusCode:400,statusMessage:"Password no cumple con los requisitos mínimos"});throw s({statusCode:500,statusMessage:`Error al crear usuario: ${y.message}`})}if(!(null==(c=null==C?void 0:C.user)?void 0:c.id))throw console.error("[Server Error] Usuario creado pero sin datos válidos"),s({statusCode:500,statusMessage:"User creation failed: Invalid response data"});let M;console.log("[Server] ✅ Usuario Auth creado:",C.user.id),console.log("[Server] Esperando a triggers de BD...");let _=0;const A=5,P=1e3;for(;_<A;)try{await new Promise(e=>setTimeout(e,P)),console.log(`[Server] Verificando profile (intento ${_+1}/${A})...`);const{data:e,error:r}=await f.from("profiles").select("*").eq("id",C.user.id).single();if(r){if("PGRST116"===r.code){console.log("[Server] Profile no encontrado aún, reintentando..."),_++;continue}throw console.error("[Server Error] Error al verificar profile:",r),s({statusCode:500,statusMessage:`Profile verification failed: ${r.message}`})}M=e;break}catch(e){if(console.error(`[Server Error] Error en intento ${_+1}:`,e),_>=A-1)throw e;_++}if(!M)throw console.error("[Server Error] Profile no se creó después de múltiples intentos"),s({statusCode:500,statusMessage:"Profile creation timeout: Database triggers may not be working"});let U;for(console.log("[Server] ✅ Profile verificado:",M.email),console.log("[Server] Verificando registro de terapeuta..."),_=0;_<A;)try{const{data:e,error:r}=await f.from("terapeutas").select("*").eq("email",m.trim().toLowerCase()).single();if(r&&"PGRST116"===r.code){console.log("[Server] Trigger no creó terapeuta, creando manualmente...");const{data:e,error:r}=await f.from("terapeutas").insert({nombre_completo:u.trim(),email:m.trim().toLowerCase(),telefono:v?String(v).trim():null,activo:!0,metadata:{auth_user_id:C.user.id,created_by_admin:!0,created_at:(new Date).toISOString()}}).select().single();if(r){if("23505"===r.code){console.log("[Server] Terapeuta ya existe, reintentando obtención..."),_++;continue}throw console.error("[Server Error] Error al crear terapeuta:",r),s({statusCode:500,statusMessage:`Failed to create therapist record: ${r.message}`})}U=e;break}if(r)throw console.error("[Server Error] Error al verificar terapeuta:",r),s({statusCode:500,statusMessage:`Therapist verification failed: ${r.message}`});U=e;break}catch(e){if(console.error(`[Server Error] Error en verificación de terapeuta (intento ${_+1}):`,e),_>=A-1)throw e;_++,await new Promise(e=>setTimeout(e,P))}if(!U)throw console.error("[Server Error] No se pudo crear/verificar registro de terapeuta"),s({statusCode:500,statusMessage:"Therapist record creation failed after multiple attempts"});console.log("[Server] ✅ Terapeuta creada/verificada:",U.email),console.log("[Server] ✅ Proceso completado exitosamente");const R={success:!0,message:"Terapeuta creada exitosamente",data:{authUserId:C.user.id,terapeutaId:U.id,email:m.trim().toLowerCase(),nombreCompleto:u.trim(),telefono:v?String(v).trim():null}};return console.log("[Server] Enviando respuesta exitosa"),R}catch(e){if(console.error("[Server Error] Error en crear-terapeuta:",e),e.statusCode&&e.statusMessage)throw e;if(e.code||e.message)throw console.error("[Server Error] Error de Supabase:",{code:e.code,message:e.message,details:e.details}),s({statusCode:500,statusMessage:`Database error: ${e.message||"Unknown error"}`});throw console.error("[Server Error] Error no identificado:",e),s({statusCode:500,statusMessage:"Internal server error occurred"})}finally{console.log("[Server] Finalizando handler crear-terapeuta")}});export{l as default};
//# sourceMappingURL=crear-terapeuta.post.mjs.map
