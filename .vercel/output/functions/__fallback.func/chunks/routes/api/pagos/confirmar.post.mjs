import{d as o,g as e,c as r,r as a}from"../../../nitro/nitro.mjs";import{s}from"../../../_/serverSupabaseClient.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"../../../_/index.mjs";import"@supabase/supabase-js";import"../../../virtual/_commonjsHelpers.mjs";import"../../../_/index2.mjs";const t=o(async o=>{if(console.log("[Server] Iniciando confirmar-pago handler"),"POST"!==e(o))throw console.error("[Server Error] Método no permitido:",e(o)),r({statusCode:405,statusMessage:"Method Not Allowed"});try{let e;console.log("[Server] Leyendo body de la petición...");try{e=await a(o)}catch(o){throw console.error("[Server Error] Error al leer body:",o),r({statusCode:400,statusMessage:"Invalid request body"})}console.log("[Server] Body recibido, validando campos...");const{bonoId:t,metodoPago:n}=e||{};if(!e||"object"!=typeof e)throw console.error("[Server Error] Body inválido:",typeof e),r({statusCode:400,statusMessage:"Request body must be a valid JSON object"});if(!t||"string"!=typeof t&&"number"!=typeof t)throw console.error("[Server Error] bonoId inválido:",t),r({statusCode:400,statusMessage:"bonoId es requerido y debe ser válido"});const i=n&&"string"==typeof n?n.trim():"no_especificado";if(console.log("[Server] ✅ Campos validados, confirmando pago para bono:",t),console.log("[Server] Verificando variables de entorno..."),!process.env.SUPABASE_URL)throw console.error("[Server Error] SUPABASE_URL no configurada"),r({statusCode:500,statusMessage:"Server configuration error: Missing Supabase URL"});let d;console.log("[Server] Inicializando cliente Supabase...");try{d=await s(o)}catch(o){throw console.error("[Server Error] Error al inicializar cliente:",o),r({statusCode:500,statusMessage:"Failed to initialize Supabase client"})}console.log("[Server] Verificando autenticación del usuario...");const{data:l,error:c}=await d.auth.getUser();if(c)throw console.error("[Server Error] Error al obtener usuario:",c),r({statusCode:401,statusMessage:"Authentication failed"});const u=null==l?void 0:l.user;if(!u||!u.id)throw console.error("[Server Error] Usuario no encontrado o sin ID"),r({statusCode:401,statusMessage:"User not authenticated"});console.log("[Server] Verificando rol de coordinadora para usuario:",u.id);const{data:g,error:p}=await d.from("profiles").select("rol").eq("id",u.id).single();if(p)throw console.error("[Server Error] Error al obtener perfil:",p),r({statusCode:500,statusMessage:"Failed to verify user permissions"});if(!g||"coordinadora"!==g.rol)throw console.error("[Server Error] Acceso denegado, rol:",null==g?void 0:g.rol),r({statusCode:403,statusMessage:"Access denied. Coordinadora role required"});console.log("[Server] ✅ Usuario coordinadora verificado:",u.email),console.log("[Server] Verificando estado del bono...");const{data:f,error:m}=await d.from("bonos").select("id, paciente_id, estado_pago, monto_total, estado").eq("id",t).single();if(m){if("PGRST116"===m.code)throw console.error("[Server Error] Bono no encontrado:",t),r({statusCode:404,statusMessage:"Bono no encontrado"});throw console.error("[Server Error] Error al obtener bono:",m),r({statusCode:500,statusMessage:"Failed to fetch bono data"})}if(!f||"pendiente"!==f.estado_pago)throw console.error("[Server Error] Bono no válido para confirmación:",{existe:!!f,estado_pago:null==f?void 0:f.estado_pago}),r({statusCode:400,statusMessage:"Bono no está en estado pendiente de pago"});console.log("[Server] ✅ Bono válido para confirmación"),console.log("[Server] Actualizando estado del pago...");const v=(new Date).toISOString(),{data:S,error:b}=await d.from("bonos").update({estado_pago:"pagado",fecha_pago:v,metodo_pago:i,confirmado_por:u.id,updated_at:v}).eq("id",t).eq("estado_pago","pendiente").select().single();if(b){if(console.error("[Server Error] Error al actualizar bono:",b),"PGRST116"===b.code)throw r({statusCode:409,statusMessage:"El bono ya fue confirmado por otro usuario"});throw r({statusCode:500,statusMessage:`Failed to update bono: ${b.message}`})}if(!S)throw console.error("[Server Error] Bono no actualizado - posible race condition"),r({statusCode:409,statusMessage:"El bono ya fue confirmado por otro usuario"});console.log("[Server] ✅ Pago confirmado exitosamente");const h={success:!0,message:"Pago confirmado exitosamente",data:{bonoId:S.id,fechaPago:v,metodoPago:i,montoTotal:S.monto_total,confirmadoPor:u.id}};return console.log("[Server] Enviando respuesta exitosa"),h}catch(o){if(console.error("[Server Error] Error en confirmar-pago:",o),o.statusCode&&o.statusMessage)throw o;if(o.code||o.message)throw console.error("[Server Error] Error de Supabase:",{code:o.code,message:o.message,details:o.details}),r({statusCode:500,statusMessage:`Database error: ${o.message||"Unknown error"}`});throw console.error("[Server Error] Error no identificado:",o),r({statusCode:500,statusMessage:"Internal server error occurred"})}finally{console.log("[Server] Finalizando handler confirmar-pago")}});export{t as default};
//# sourceMappingURL=confirmar.post.mjs.map
