import{d as e,j as s,c as t,u as a,b as o,s as r,e as i}from"../../../../nitro/nitro.mjs";import{m as n}from"../../../../_/index.mjs";import d from"papaparse";import{x as c}from"../../../../_/xlsx.mjs";import{a as m}from"../../../../_/column-mapper.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/supabase-js";import"../../../../virtual/_commonjsHelpers.mjs";import"../../../../_/index2.mjs";import"/Users/dieterlorenzo/terapli/node_modules/xlsx/dist/cpexcel.js";import"fs";import"stream";const p=e(async e=>{var p;try{const u=await s(e);if(!u||0===u.length)throw t({statusCode:400,statusMessage:"No se encontró ningún archivo"});const l=u.find(e=>"file"===e.name);if(!l)throw t({statusCode:400,statusMessage:"No se encontró el archivo en el formulario"});const f=l.filename||"",g=null==(p=f.split(".").pop())?void 0:p.toLowerCase();if(!["csv","xlsx","xls"].includes(g||""))throw t({statusCode:400,statusMessage:"Formato de archivo no válido. Solo se permiten CSV y XLSX"});let h=[],_=[];if("csv"===g){const e=l.data.toString("utf-8"),s=d.parse(e,{header:!0,skipEmptyLines:!0,preview:5});h=s.meta.fields||[],_=s.data}else{const e=c.read(l.data,{type:"buffer"}),s=e.SheetNames[0];if(!s)throw t({statusCode:400,statusMessage:"El archivo Excel no tiene hojas"});const a=e.Sheets[s];if(!a)throw t({statusCode:400,statusMessage:"No se pudo leer la hoja del archivo Excel"});const o=c.utils.sheet_to_json(a,{header:1,defval:""});if(0===o.length)throw t({statusCode:400,statusMessage:"El archivo está vacío"});h=o[0];const r=o.slice(1,6);_=r.map(e=>{const s={};return h.forEach((t,a)=>{s[t]=e[a]||""}),s})}if(0===h.length)throw t({statusCode:400,statusMessage:"No se detectaron columnas en el archivo"});const v=h.map(e=>{const s=_.map(s=>String(s[e]||"").trim()).filter(e=>""!==e).slice(0,5);return{name:e,sampleValues:s,suggestedMapping:void 0}}),C=m(h);v.forEach(e=>{const s=C.find(s=>s.sourceColumn===e.name);s&&""!==s.targetField&&(e.suggestedMapping=s.targetField)});const S=a(),w=S.supabaseUrl||process.env.NUXT_PUBLIC_SUPABASE_URL||process.env.SUPABASE_URL,x=S.supabaseKey||process.env.NUXT_PUBLIC_SUPABASE_ANON_KEY||process.env.SUPABASE_KEY;if(!w||!x)throw t({statusCode:500,statusMessage:"Error de configuración: faltan las credenciales de Supabase"});const E=await n.createServerClient(w,x,{cookies:{get:s=>i(e,s),set:(s,t,a)=>r(e,s,t,a),remove:(s,t)=>o(e,s,t)}}),{data:{user:U},error:M}=await E.auth.getUser();if(M||!U)throw t({statusCode:401,statusMessage:"No autenticado"});const N=new Date,j=new Date(N.getTime()+36e5),A={id:crypto.randomUUID(),userId:U.id,fileName:f,detectedColumns:v,mappings:C,created_at:N.toISOString(),expires_at:j.toISOString()},{error:I}=await E.from("import_configs").insert({id:A.id,user_id:A.userId,file_name:A.fileName,detected_columns:A.detectedColumns,mappings:A.mappings,created_at:A.created_at,expires_at:A.expires_at});if(I)throw console.error("Error al guardar configuración de importación:",I),t({statusCode:500,statusMessage:"Error al guardar la configuración de importación"});return{success:!0,config:{id:A.id,userId:A.userId,fileName:A.fileName,detectedColumns:A.detectedColumns,mappings:A.mappings,createdAt:N,expiresAt:j}}}catch(e){throw console.error("Error en detect-columns:",e),t({statusCode:e.statusCode||500,statusMessage:e.statusMessage||e.message||"Error al detectar columnas"})}});export{p as default};
//# sourceMappingURL=detect-columns.post.mjs.map
