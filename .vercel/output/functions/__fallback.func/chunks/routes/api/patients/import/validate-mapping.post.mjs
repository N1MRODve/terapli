import{d as e,r as a,c as s,u as o,b as t,s as r,e as i}from"../../../../nitro/nitro.mjs";import{m as n}from"../../../../_/index.mjs";import{g as p,b as m,h as c}from"../../../../_/column-mapper.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"../../../../_/index2.mjs";import"../../../../virtual/_commonjsHelpers.mjs";import"iceberg-js";const d=e(async e=>{try{const d=await a(e),{configId:l,mappings:u}=d;if(!l||!u)throw s({statusCode:400,statusMessage:"Faltan parámetros: configId y mappings son requeridos"});const g=o(),f=g.supabaseUrl||process.env.NUXT_PUBLIC_SUPABASE_URL||process.env.SUPABASE_URL,h=g.supabaseKey||process.env.NUXT_PUBLIC_SUPABASE_ANON_KEY||process.env.SUPABASE_KEY;if(!f||!h)throw s({statusCode:500,statusMessage:"Error de configuración: faltan las credenciales de Supabase"});const _=await n.createServerClient(f,h,{cookies:{get:a=>i(e,a),set:(a,s,o)=>r(e,a,s,o),remove:(a,s)=>t(e,a,s)}}),{data:{user:w},error:E}=await _.auth.getUser();if(E||!w)throw s({statusCode:401,statusMessage:"No autenticado"});const{data:S,error:U}=await _.from("import_configs").select("*").eq("id",l).eq("user_id",w.id).single();if(U||!S)throw s({statusCode:404,statusMessage:"Configuración de importación no encontrada o expirada"});const b=new Set(u.map(e=>e.targetField).filter(e=>""!==e)),v=[],C=[],A=b.has("nombre_completo"),N=b.has("email"),q=b.has("telefono");A||v.push('Debes mapear al menos una columna al campo "Nombre Completo"'),N||q||v.push('Debes mapear al menos uno de los siguientes campos: "Email" o "Teléfono"'),N||C.push('No se mapeó el campo "Email". Los pacientes importados quedarán con perfil incompleto y se mostrará una alerta.'),q||C.push('No se mapeó el campo "Teléfono". Los pacientes importados quedarán con perfil incompleto.'),b.has("documento_identidad")||C.push('No se mapeó el campo "Documento de Identidad". Los pacientes quedarán con perfil incompleto.'),b.has("area_de_acompanamiento")||C.push('No se mapeó el campo "Área de Acompañamiento". Este campo ayuda a categorizar a los pacientes.');const j=p(u),y=m(u),L={isValid:0===v.length,errors:v,warnings:C,requiredFieldsMapped:c(u),missingRequiredFields:j,missingProfileFields:y},{error:M}=await _.from("import_configs").update({mappings:u,updated_at:(new Date).toISOString()}).eq("id",l);return M&&console.error("Error al actualizar configuración:",M),{success:!0,validation:L}}catch(e){throw console.error("Error en validate-mapping:",e),s({statusCode:e.statusCode||500,statusMessage:e.statusMessage||e.message||"Error al validar mapeo"})}});export{d as default};
//# sourceMappingURL=validate-mapping.post.mjs.map
