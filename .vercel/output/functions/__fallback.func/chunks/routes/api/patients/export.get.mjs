import{d as e,h as t,c as s,u as a,b as o,s as r,e as i,i as n}from"../../../nitro/nitro.mjs";import{m as c}from"../../../_/index.mjs";import p from"papaparse";import{x as l}from"../../../_/xlsx.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"../../../_/index2.mjs";import"../../../virtual/_commonjsHelpers.mjs";import"iceberg-js";import"/Users/dieterlorenzo/terapli/node_modules/xlsx/dist/cpexcel.js";import"fs";import"stream";const d=e(async e=>{try{const d=t(e),m=d.format||"csv",u=d.scope||"all",f=d.fields?d.fields.split(","):["nombre_completo","email","telefono","area_de_acompanamiento","frecuencia","activo"];if(!["csv","xlsx"].includes(m))throw s({statusCode:400,statusMessage:"Formato no válido. Use csv o xlsx"});const h=a(),_=h.supabaseUrl||h.public.supabaseUrl,g=h.supabaseKey||h.public.supabaseKey;if(!_||!g)throw s({statusCode:500,statusMessage:"Configuración de Supabase no disponible"});const x=await c.createServerClient(_,g,{cookies:{get:t=>i(e,t),set:(t,s,a)=>r(e,t,s,a),remove:(t,s)=>o(e,t,s)}}),{data:{user:b},error:v}=await x.auth.getUser();if(v||!b)throw s({statusCode:401,statusMessage:"No autenticado"});const{data:w,error:C}=await x.from("profiles").select("rol").eq("id",b.id).single();if(C||!w)throw s({statusCode:403,statusMessage:"No se pudo obtener el perfil del usuario"});const M="psicologa"===w.rol,j="admin"===w.rol;if(!M&&!j)throw s({statusCode:403,statusMessage:"No tienes permisos para exportar pacientes"});let y=x.from("pacientes").select("*");if(M&&(y=y.eq("terapeuta_id",b.id)),"filtered"===u){const e=d.filters?JSON.parse(d.filters):{};e.estado&&("activo"===e.estado?y=y.eq("activo",!0):"finalizado"===e.estado&&(y=y.eq("activo",!1))),e.area&&(y=y.eq("area_de_acompanamiento",e.area))}if("selected"===u){const e=d.selectedIds?d.selectedIds.split(","):[];if(0===e.length)throw s({statusCode:400,statusMessage:"No se seleccionaron pacientes para exportar"});y=y.in("id",e)}const{data:S,error:E}=await y;if(E)throw s({statusCode:500,statusMessage:"Error al obtener pacientes"});if(!S||0===S.length)throw s({statusCode:404,statusMessage:"No se encontraron pacientes para exportar"});const N=S.map(e=>{var t;const s={};if(f.includes("nombre_completo")&&(s["Nombre Completo"]=e.nombre_completo||""),f.includes("email")&&(s.Email=e.email||""),f.includes("telefono")&&(s["Teléfono"]=e.telefono||""),f.includes("area_de_acompanamiento")&&(s["Área de Acompañamiento"]=e.area_de_acompanamiento||""),f.includes("frecuencia")&&(s.Frecuencia=e.frecuencia||""),f.includes("activo")){const a=(null==(t=e.metadata)?void 0:t.en_pausa)||!1;s.Estado=e.activo?a?"En pausa":"Activo":"Finalizado"}return f.includes("created_at")&&(s["Fecha de Registro"]=e.created_at?new Date(e.created_at).toLocaleDateString("es-ES"):""),s});if("csv"===m){const t=p.unparse(N,{quotes:!0,delimiter:",",header:!0});return n(e,{"Content-Type":"text/csv; charset=utf-8","Content-Disposition":`attachment; filename="pacientes_${(new Date).toISOString().split("T")[0]}.csv"`}),t}{const t=l.utils.book_new(),s=l.utils.json_to_sheet(N),a=Object.keys(N[0]||{}).map(e=>({wch:Math.max(e.length,...N.map(t=>String(t[e]||"").length))+2}));s["!cols"]=a,l.utils.book_append_sheet(t,s,"Pacientes");const o=l.write(t,{bookType:"xlsx",type:"buffer"});return n(e,{"Content-Type":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","Content-Disposition":`attachment; filename="pacientes_${(new Date).toISOString().split("T")[0]}.xlsx"`}),o}}catch(e){throw console.error("Error in export:",e),s({statusCode:e.statusCode||500,statusMessage:e.statusMessage||e.message||"Error al exportar pacientes"})}});export{d as default};
//# sourceMappingURL=export.get.mjs.map
