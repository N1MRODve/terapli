import{d as e,u as t,c as s,b as a,s as o,e as i,h as n}from"../../../nitro/nitro.mjs";import{m as r}from"../../../_/index.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/supabase-js";import"../../../virtual/_commonjsHelpers.mjs";import"../../../_/index2.mjs";const c=e(async e=>{try{const c=t(),l=c.supabaseUrl||c.public.supabaseUrl,d=c.supabaseKey||c.public.supabaseKey;if(!l||!d)throw s({statusCode:500,statusMessage:"ConfiguraciÃ³n de Supabase no disponible"});const f=await r.createServerClient(l,d,{cookies:{get:t=>i(e,t),set:(t,s,a)=>o(e,t,s,a),remove:(t,s)=>a(e,t,s)}}),{data:{user:_},error:m}=await f.auth.getUser();if(m||!_)throw s({statusCode:401,statusMessage:"No autenticado"});const{data:p,error:u}=await f.from("profiles").select("rol").eq("id",_.id).single();if(u||!p)throw s({statusCode:403,statusMessage:"No se pudo obtener el perfil del usuario"});let h=null;if("psicologa"===p.rol)h=_.id;else{if("admin"!==p.rol&&"coordinadora"!==p.rol)throw s({statusCode:403,statusMessage:"No tienes permisos para buscar pacientes"});h=n(e).terapeuta_id||null}const g=(n(e).q||"").trim().toLowerCase();let b=f.from("pacientes").select("\n        id,\n        nombre_completo,\n        email,\n        telefono,\n        fecha_nacimiento,\n        activo,\n        bonos(\n          id,\n          tipo,\n          sesiones_totales,\n          sesiones_restantes,\n          fecha_inicio,\n          fecha_fin,\n          estado\n        ),\n        citas(\n          fecha_cita,\n          estado\n        )\n      ");h&&(b=b.eq("terapeuta_id",h)),g.length>0&&(b=b.or(`nombre_completo.ilike.%${g}%,email.ilike.%${g}%,telefono.ilike.%${g}%`));const{data:w,error:v}=await b.eq("activo",!0).order("nombre_completo",{ascending:!0}).limit(30);if(v)throw console.error("[PATIENTS/SEARCH] Error al buscar pacientes:",v),s({statusCode:500,statusMessage:"Error al buscar pacientes"});const T=new Date,C=(w||[]).map(e=>{var t,s;const a=(e.bonos||[]).filter(e=>{const t="activo"===e.estado||"pendiente"===e.estado,s=e.sesiones_restantes>0;return t&&s}),o=a.reduce((e,t)=>e+(t.sesiones_restantes||0),0),i=a.filter(e=>e.fecha_fin).map(e=>new Date(e.fecha_fin).getTime()).sort()[0]||null,n=a.length>0?a.sort((e,t)=>e.fecha_fin?t.fecha_fin?new Date(e.fecha_fin).getTime()-new Date(t.fecha_fin).getTime():-1:1)[0]:null,r=e.citas||[],c=r.filter(e=>new Date(e.fecha_cita)<=T&&"cancelada"!==e.estado).sort((e,t)=>new Date(t.fecha_cita).getTime()-new Date(e.fecha_cita).getTime()),l=r.filter(e=>new Date(e.fecha_cita)>T&&"cancelada"!==e.estado).sort((e,t)=>new Date(e.fecha_cita).getTime()-new Date(t.fecha_cita).getTime()),d=(null==(t=c[0])?void 0:t.fecha_cita)||null,f=(null==(s=l[0])?void 0:s.fecha_cita)||null,_=r.filter(e=>"cancelada"!==e.estado).length;let m=0;if(d){const e=Math.floor((T.getTime()-new Date(d).getTime())/864e5);e<=7?m+=100:e<=30?m+=50:e<=90&&(m+=20)}return o>0&&(m+=80),_>=10?m+=30:_>=5&&(m+=15),{id:e.id,nombre_completo:e.nombre_completo,email:e.email,telefono:e.telefono,fecha_nacimiento:e.fecha_nacimiento,bonos_activos:a.length,sesiones_restantes_total:o,proximo_vencimiento:i?new Date(i).toISOString():null,ultima_cita:d,proxima_cita:f,total_citas:_,prioridad_score:m,bono_activo:n?{id:n.id,tipo:n.tipo,sesiones_totales:n.sesiones_totales,sesiones_restantes:n.sesiones_restantes,sesiones_usadas:n.sesiones_totales-n.sesiones_restantes,fecha_inicio:n.fecha_inicio,fecha_fin:n.fecha_fin}:null,bonos:a.map(e=>({id:e.id,tipo:e.tipo,sesiones_totales:e.sesiones_totales,sesiones_restantes:e.sesiones_restantes,sesiones_usadas:e.sesiones_totales-e.sesiones_restantes,fecha_fin:e.fecha_fin}))}}),D=C.sort((e,t)=>t.prioridad_score-e.prioridad_score).slice(0,10);return{success:!0,data:D,count:D.length,total:C.length}}catch(e){if(console.error("[PATIENTS/SEARCH] Error:",e),e.statusCode)throw e;throw s({statusCode:500,statusMessage:e.message||"Error al buscar pacientes"})}});export{c as default};
//# sourceMappingURL=search.get.mjs.map
