import{d as e,j as t,c as o,u as s,b as r,s as a,e as i}from"../../../nitro/nitro.mjs";import{m as n}from"../../../_/index.mjs";import l from"papaparse";import{x as p}from"../../../_/xlsx.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"../../../_/index2.mjs";import"../../../virtual/_commonjsHelpers.mjs";import"iceberg-js";import"/Users/dieterlorenzo/terapli/node_modules/xlsx/dist/cpexcel.js";import"fs";import"stream";const d=e(async e=>{var d,m,c,u,f;try{const h=await t(e);if(!h||0===h.length)throw o({statusCode:400,statusMessage:"No se encontró ningún archivo"});const g=h.find(e=>"file"===e.name);if(!g)throw o({statusCode:400,statusMessage:"No se encontró el archivo en el formulario"});const v=h.find(e=>"action"===e.name),w=v?v.data.toString():"update",b=null==(d=(g.filename||"").split(".").pop())?void 0:d.toLowerCase();if(!["csv","xlsx","xls"].includes(b||""))throw o({statusCode:400,statusMessage:"Formato de archivo no válido. Solo se permiten CSV y XLSX"});let C=[];if("csv"===b){const e=g.data.toString("utf-8");C=l.parse(e,{header:!0,skipEmptyLines:!0}).data}else{const e=p.read(g.data,{type:"buffer"}),t=e.SheetNames[0],o=e.Sheets[t];C=p.utils.sheet_to_json(o)}if(0===C.length)throw o({statusCode:400,statusMessage:"El archivo está vacío"});if(C.length>5e3)throw o({statusCode:400,statusMessage:"El archivo contiene demasiadas filas. Máximo permitido: 5000"});const _=s(),x=_.supabaseUrl||_.public.supabaseUrl,M=_.supabaseKey||_.public.supabaseKey;if(!x||!M)throw o({statusCode:500,statusMessage:"Configuración de Supabase no disponible"});const k=await n.createServerClient(x,M,{cookies:{get:t=>i(e,t),set:(t,o,s)=>a(e,t,o,s),remove:(t,o)=>r(e,t,o)}}),{data:{user:j},error:E}=await k.auth.getUser();if(E||!j)throw o({statusCode:401,statusMessage:"No autenticado"});const{data:S,error:y}=await k.from("profiles").select("rol").eq("id",j.id).single();if(y||!S)throw o({statusCode:403,statusMessage:"No se pudo obtener el perfil del usuario"});const L="psicologa"===S.rol,N="admin"===S.rol;if(!L&&!N)throw o({statusCode:403,statusMessage:"No tienes permisos para importar pacientes"});let U=k.from("pacientes").select("id, email, telefono");L&&(U=U.eq("terapeuta_id",j.id));const{data:q,error:z}=await U;if(z)throw o({statusCode:500,statusMessage:"Error al obtener pacientes existentes"});const K={created:0,updated:0,skipped:0,errors:[]};for(let e=0;e<C.length;e++){const t=C[e],o=e+2;try{if(!t.nombre_completo||""===t.nombre_completo.trim()){K.errors.push({row:o,error:"El nombre completo es obligatorio"}),K.skipped++;continue}if(!(t.email&&""!==t.email.trim()||t.telefono&&""!==t.telefono.trim())){K.errors.push({row:o,error:"Debe proporcionar al menos email o teléfono"}),K.skipped++;continue}let e=null;t.email&&""!==t.email.trim()&&(e=null==q?void 0:q.find(e=>e.email&&e.email.toLowerCase()===t.email.toLowerCase())),!e&&t.telefono&&""!==t.telefono.trim()&&(e=null==q?void 0:q.find(e=>e.telefono&&e.telefono===t.telefono));const s=void 0===t.activo||""===t.activo||["true","sí","si","1","activo"].includes(String(t.activo).toLowerCase()),r={nombre_completo:t.nombre_completo.trim(),email:(null==(m=t.email)?void 0:m.trim())||null,telefono:(null==(c=t.telefono)?void 0:c.trim())||null,area_de_acompanamiento:(null==(u=t.area_de_acompanamiento)?void 0:u.trim())||null,frecuencia:(null==(f=t.frecuencia)?void 0:f.trim())||null,activo:s,metadata:t.notas?{notas:t.notas}:null};if(L&&(r.terapeuta_id=j.id),e)if("update"===w){const{error:t}=await k.from("pacientes").update(r).eq("id",e.id);t?(K.errors.push({row:o,error:`Error al actualizar: ${t.message}`}),K.skipped++):K.updated++}else K.skipped++;else{const{error:e}=await k.from("pacientes").insert(r);e?(K.errors.push({row:o,error:`Error al crear: ${e.message}`}),K.skipped++):K.created++}}catch(e){K.errors.push({row:o,error:e.message||"Error desconocido"}),K.skipped++}}return{success:!0,results:{total:C.length,created:K.created,updated:K.updated,skipped:K.skipped,errors:K.errors}}}catch(e){throw console.error("Error in import:",e),o({statusCode:e.statusCode||500,statusMessage:e.statusMessage||e.message||"Error al importar pacientes"})}});export{d as default};
//# sourceMappingURL=import.post.mjs.map
