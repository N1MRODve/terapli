import{d as e,u as t,c as a,b as s,s as o,e as r,r as i}from"../../../nitro/nitro.mjs";import{m as n}from"../../../_/index.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"../../../_/index2.mjs";import"../../../virtual/_commonjsHelpers.mjs";import"iceberg-js";const l=e(async e=>{try{const l=t(),c=l.supabaseUrl||l.public.supabaseUrl,m=l.supabaseKey||l.public.supabaseKey;if(!c||!m)throw a({statusCode:500,statusMessage:"Configuración de Supabase no disponible"});const d=await n.createServerClient(c,m,{cookies:{get:t=>r(e,t),set:(t,a,s)=>o(e,t,a,s),remove:(t,a)=>s(e,t,a)}}),{data:{user:u},error:p}=await d.auth.getUser();if(p||!u)throw a({statusCode:401,statusMessage:"No autenticado"});const{data:f,error:g}=await d.from("profiles").select("rol").eq("id",u.id).single();if(g||!f)throw a({statusCode:403,statusMessage:"No se pudo obtener el perfil del usuario"});let b=null;if("psicologa"===f.rol)b=u.id;else{if("admin"!==f.rol&&"coordinadora"!==f.rol)throw a({statusCode:403,statusMessage:"No tienes permisos para crear pacientes"});if(b=(await i(e)).terapeuta_id||null,!b)throw a({statusCode:400,statusMessage:"Se requiere terapeuta_id para admin/coordinadora"})}const w=await i(e),{nombre_completo:h,email:C,telefono:E,fecha_nacimiento:T,observaciones:_}=w;if(!h||h.trim().length<2)throw a({statusCode:400,statusMessage:"El nombre debe tener al menos 2 caracteres"});if(!C||!C.includes("@"))throw a({statusCode:400,statusMessage:"Email inválido"});const{data:v,error:M}=await d.from("pacientes").select("id, nombre_completo").eq("terapeuta_id",b).eq("email",C.trim().toLowerCase()).maybeSingle();if(M&&"PGRST116"!==M.code)throw console.error("[PATIENTS/CREATE] Error verificando email:",M),a({statusCode:500,statusMessage:"Error al verificar email"});if(v)throw a({statusCode:409,statusMessage:`Ya existe un paciente con el email ${C}: ${v.nombre_completo}`});const{data:S,error:A}=await d.from("pacientes").insert({terapeuta_id:b,nombre_completo:h.trim(),email:C.trim().toLowerCase(),telefono:(null==E?void 0:E.trim())||null,fecha_nacimiento:T||null,observaciones:(null==_?void 0:_.trim())||null}).select().single();if(A)throw console.error("[PATIENTS/CREATE] Error al insertar paciente:",A),a({statusCode:500,statusMessage:A.message||"Error al crear paciente"});return console.info(`[PATIENTS/CREATE] Paciente creado: ${S.id}`),{success:!0,message:"Paciente creado exitosamente",data:S}}catch(e){if(console.error("[PATIENTS/CREATE] Error:",e),e.statusCode)throw e;throw a({statusCode:500,statusMessage:e.message||"Error al crear paciente"})}});export{l as default};
//# sourceMappingURL=create.post.mjs.map
