{"version":3,"file":"execute.post.mjs","sources":["../../../../../../../../../server/api/patients/import/execute.post.ts"],"sourcesContent":null,"names":["execute_post","defineEventHandler","async","event","form","readMultipartFormData","length","createError","statusCode","statusMessage","fileData","find","item","name","configIdField","actionField","configId","data","toString","action","runtimeConfig","useRuntimeConfig","supabaseUrl","process","env","NUXT_PUBLIC_SUPABASE_URL","SUPABASE_URL","supabaseKey","NUXT_PUBLIC_SUPABASE_ANON_KEY","SUPABASE_KEY","supabaseClient","createServerClient","cookies","get","getCookie","set","value","options","setCookie","remove","deleteCookie","user","error","userError","auth","getUser","profile","profileError","from","select","eq","id","single","includes","rol","console","log","config","configError","mappingsField","mappings","Date","expires_at","JSON","parse","e","extension","_a","filename","file_name","split","pop","toLowerCase","rows","csvContent","Papa","header","skipEmptyLines","workbook","XLSX.read","type","firstSheetName","SheetNames","worksheet","Sheets","XLSX.utils","sheet_to_json","defval","mappedRows","map","row","index","mapped","mapping","targetField","sourceColumn","String","trim","rowNumber","originalRow","mappedRow","existingPatients","existingError","existingByEmail","Map","existingByPhone","forEach","p","email","telefono","normalizePhone","results","total","created","updated","skipped","errors","incompleteProfiles","toCreate","toUpdate","nombre","_b","nombre_completo","_c","_d","push","isValidEmail","isValidPhone","existingPatient","matchedBy","patientData","buildPatientData","missingFields","getMissingProfileFields","isProfileComplete","perfil_completo","campos_faltantes","batchSize","i","batch","slice","insert","_","idx","ip","patientId","updateError","update","delete","success","message","test","phone","replace","missing","documento_identidad","userId","userRole","activoValue","activoRaw","activo","_e","area_de_acompanamiento","_f","frecuencia","_g","_h","direccion","_i","contacto_emergencia","_j","derivacion","_k","medicacion","_l","orientacion_diagnostica","_m","fecha_nacimiento","fechaNac","parseDate","inicio_tratamiento","inicioTrat","precio_sesion","precio","parseFloat","isNaN","descuento","_n","notas","metadata","terapeuta_id","str","formatDate","d","getTime","toISOString","substring","ddmmyyyy","match","day","parseInt","month","year","result","yyyymmdd"],"mappings":"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"}