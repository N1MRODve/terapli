import{d as e,j as o,c as t,u as r,b as i,s as a,e as s}from"../../../../nitro/nitro.mjs";import{m as n}from"../../../../_/index.mjs";import l from"papaparse";import{x as c}from"../../../../_/xlsx.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"../../../../_/index2.mjs";import"../../../../virtual/_commonjsHelpers.mjs";import"iceberg-js";import"/Users/dieterlorenzo/terapli/node_modules/xlsx/dist/cpexcel.js";import"fs";import"stream";const d=e(async e=>{var d,u,m,p;try{const f=await o(e);if(!f||0===f.length)throw t({statusCode:400,statusMessage:"No se encontraron datos en el formulario"});const g=f.find(e=>"file"===e.name),h=f.find(e=>"configId"===e.name),v=f.find(e=>"action"===e.name);if(!g)throw t({statusCode:400,statusMessage:"No se encontró el archivo"});if(!h)throw t({statusCode:400,statusMessage:"No se encontró el ID de configuración"});const _=h.data.toString("utf-8"),w=(null==v?void 0:v.data.toString("utf-8"))||"skip";if(g.data.length>10485760)throw t({statusCode:400,statusMessage:"El archivo excede el tamaño máximo de 10MB"});const E=r(),b=E.supabaseUrl||process.env.NUXT_PUBLIC_SUPABASE_URL||process.env.SUPABASE_URL,x=E.supabaseKey||process.env.NUXT_PUBLIC_SUPABASE_ANON_KEY||process.env.SUPABASE_KEY;if(!b||!x)throw t({statusCode:500,statusMessage:"Error de configuración: faltan las credenciales de Supabase"});const C=await n.createServerClient(b,x,{cookies:{get:o=>s(e,o),set:(o,t,r)=>a(e,o,t,r),remove:(o,t)=>i(e,o,t)}}),{data:{user:M},error:N}=await C.auth.getUser();if(N||!M)throw t({statusCode:401,statusMessage:"No autenticado"});const{data:S,error:P}=await C.from("profiles").select("rol").eq("id",M.id).single();if(P||!S)throw t({statusCode:403,statusMessage:"No se pudo verificar el rol del usuario"});if(!["psicologa","admin","coordinadora"].includes(S.rol))throw t({statusCode:403,statusMessage:"No tienes permisos para importar pacientes"});console.log("[Import Execute] Buscando config:",_,"para usuario:",M.id);const{data:I,error:D}=await C.from("import_configs").select("*").eq("id",_).eq("user_id",M.id).single();D&&console.error("[Import Execute] Error al buscar config:",D);const j=f.find(e=>"mappings"===e.name);let U=[];if(I){if(new Date(I.expires_at)<new Date)throw t({statusCode:410,statusMessage:"La configuración de importación ha expirado. Por favor, vuelve a subir el archivo."});U=I.mappings,console.log("[Import Execute] Mappings desde BD:",U.length,"campos")}else if(j)try{U=JSON.parse(j.data.toString("utf-8")),console.log("[Import Execute] Mappings desde FormData:",U.length,"campos")}catch(e){console.error("[Import Execute] Error parseando mappings del FormData:",e)}if(!U||0===U.length)throw t({statusCode:404,statusMessage:"Configuración de importación no encontrada o expirada. Por favor, vuelve a subir el archivo."});const L=null==(d=(g.filename||(null==I?void 0:I.file_name)||"import.xlsx").split(".").pop())?void 0:d.toLowerCase();let A=[];if("csv"===L){const e=g.data.toString("utf-8");A=l.parse(e,{header:!0,skipEmptyLines:!0}).data}else{const e=c.read(g.data,{type:"buffer"}),o=e.SheetNames[0];if(!o)throw t({statusCode:400,statusMessage:"El archivo Excel no tiene hojas"});const r=e.Sheets[o];if(!r)throw t({statusCode:400,statusMessage:"No se pudo leer la hoja del archivo Excel"});A=c.utils.sheet_to_json(r,{defval:""})}if(A.length>5e3)throw t({statusCode:400,statusMessage:"El archivo excede el límite de 5000 filas"});const B=A.map((e,o)=>{const t={};for(const o of U)if(o.targetField){const r=e[o.sourceColumn];t[o.targetField]=void 0!==r?String(r).trim():""}return{rowNumber:o+2,originalRow:e,mappedRow:t}}),{data:F,error:y}=await C.from("pacientes").select("id, email, telefono, nombre_completo");y&&console.error("Error al obtener pacientes existentes:",y);const z=new Map,$=new Map;(F||[]).forEach(e=>{e.email&&z.set(e.email.toLowerCase(),e),e.telefono&&$.set(normalizePhone(e.telefono),e)});const k={total:B.length,created:0,updated:0,skipped:0,errors:[],incompleteProfiles:[]},q=[],R=[];for(const{rowNumber:e,mappedRow:o}of B){const t=null==(u=o.nombre_completo)?void 0:u.trim(),r=null==(m=o.email)?void 0:m.trim(),i=null==(p=o.telefono)?void 0:p.trim();if(!t){k.errors.push({row:e,error:"El nombre completo es obligatorio"});continue}if(!r&&!i){k.errors.push({row:e,error:"Debe proporcionar al menos email o teléfono"});continue}if(r&&!isValidEmail(r)){k.errors.push({row:e,error:`Email inválido: ${r}`});continue}if(i&&!isValidPhone(i)){k.errors.push({row:e,error:`Teléfono inválido: ${i}`});continue}let a=null,s=null;r&&(a=z.get(r.toLowerCase()),a&&(s="email")),!a&&i&&(a=$.get(normalizePhone(i)),a&&(s="phone"));const n=buildPatientData(o,M.id,S.rol),l=getMissingProfileFields(n),c=0===l.length;n.perfil_completo=c,n.campos_faltantes=l.length>0?l:null,a?"update"===w?R.push({id:a.id,data:n}):k.skipped++:(q.push(n),c||k.incompleteProfiles.push({rowNumber:e,nombre_completo:t,missingFields:l}))}if(q.length>0){const e=100;for(let o=0;o<q.length;o+=e){const t=q.slice(o,o+e),{data:r,error:i}=await C.from("pacientes").insert(t).select("id, nombre_completo");if(i)console.error("Error al insertar pacientes:",i),t.forEach((e,t)=>{k.errors.push({row:o+t+2,error:"Error al guardar en base de datos"})});else if(r&&r.length>0){k.created+=r.length;for(const e of r){const o=k.incompleteProfiles.find(o=>o.nombre_completo===e.nombre_completo&&!o.patientId);o&&(o.patientId=e.id)}}}}for(const{id:e,data:o}of R){const{error:t}=await C.from("pacientes").update(o).eq("id",e);t?(console.error("Error al actualizar paciente:",t),k.errors.push({row:0,error:"Error al actualizar paciente existente"})):k.updated++}return await C.from("import_configs").delete().eq("id",_),{success:0===k.errors.length,results:k}}catch(e){throw console.error("Error en execute:",e),t({statusCode:e.statusCode||500,statusMessage:e.statusMessage||e.message||"Error al ejecutar importación"})}});function isValidEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}function isValidPhone(e){return/^[+]?[\d\s\-()]{9,}$/.test(e)}function normalizePhone(e){return e.replace(/[\s\-()]/g,"")}function getMissingProfileFields(e){var o,t,r;const i=[];return(null==(o=e.email)?void 0:o.trim())||i.push("email"),(null==(t=e.telefono)?void 0:t.trim())||i.push("telefono"),(null==(r=e.documento_identidad)?void 0:r.trim())||i.push("documento_identidad"),i}function buildPatientData(e,o,t){var r,i,a,s,n,l,c,d,u,m,p,f,g,h;let v=!0;const _=null==(r=e.activo)?void 0:r.toString().toLowerCase().trim();if(_){v=!["false","no","0","inactivo","finalizado"].includes(_)}const w={nombre_completo:(null==(i=e.nombre_completo)?void 0:i.trim())||null,email:(null==(s=null==(a=e.email)?void 0:a.trim())?void 0:s.toLowerCase())||null,telefono:(null==(n=e.telefono)?void 0:n.trim())||null,area_de_acompanamiento:(null==(l=e.area_de_acompanamiento)?void 0:l.trim())||null,frecuencia:(null==(c=e.frecuencia)?void 0:c.trim())||null,activo:v,documento_identidad:(null==(d=e.documento_identidad)?void 0:d.trim())||null,direccion:(null==(u=e.direccion)?void 0:u.trim())||null,contacto_emergencia:(null==(m=e.contacto_emergencia)?void 0:m.trim())||null,derivacion:(null==(p=e.derivacion)?void 0:p.trim())||null,medicacion:(null==(f=e.medicacion)?void 0:f.trim())||null,orientacion_diagnostica:(null==(g=e.orientacion_diagnostica)?void 0:g.trim())||null};if(e.fecha_nacimiento){const o=parseDate(e.fecha_nacimiento);o&&(w.fecha_nacimiento=o)}if(e.inicio_tratamiento){const o=parseDate(e.inicio_tratamiento);o&&(w.inicio_tratamiento=o)}if(e.precio_sesion){const o=parseFloat(e.precio_sesion);isNaN(o)||(w.precio_sesion=o)}if(e.descuento){const o=parseFloat(e.descuento);isNaN(o)||(w.descuento=o)}return(null==(h=e.notas)?void 0:h.trim())&&(w.metadata={notas:e.notas.trim()}),"psicologa"===t&&(w.terapeuta_id=o),w}function parseDate(e){if(!e)return null;const o=String(e).trim();if(!o)return null;const formatDate=e=>{if(isNaN(e.getTime()))return null;return e.toISOString().substring(0,10)},t=o.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);if(t&&t[1]&&t[2]&&t[3]){const e=parseInt(t[1],10),o=parseInt(t[2],10),r=parseInt(t[3],10),i=formatDate(new Date(r,o-1,e));if(i)return i}const r=o.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);if(r&&r[1]&&r[2]&&r[3]){const e=parseInt(r[1],10),o=parseInt(r[2],10),t=parseInt(r[3],10),i=formatDate(new Date(e,o-1,t));if(i)return i}return formatDate(new Date(o))}export{d as default};
//# sourceMappingURL=execute.post.mjs.map
