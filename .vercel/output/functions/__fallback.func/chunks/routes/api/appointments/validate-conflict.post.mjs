import{d as a,u as e,c as o,b as t,s,e as r,r as i}from"../../../nitro/nitro.mjs";import{m as d}from"../../../_/index.mjs";import{v as n,a as c,f as l}from"../../../_/appointment-validation.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/supabase-js";import"../../../virtual/_commonjsHelpers.mjs";import"../../../_/index2.mjs";const p=a(async a=>{try{const p=e(),u=p.supabaseUrl||p.public.supabaseUrl,f=p.supabaseKey||p.public.supabaseKey;if(!u||!f)throw o({statusCode:500,statusMessage:"Configuración de Supabase no disponible"});const m=await d.createServerClient(u,f,{cookies:{get:e=>r(a,e),set:(e,o,t)=>s(a,e,o,t),remove:(e,o)=>t(a,e,o)}}),{data:{user:h},error:_}=await m.auth.getUser();if(_||!h)throw o({statusCode:401,statusMessage:"No autenticado"});const{data:g,error:v}=await m.from("profiles").select("rol").eq("id",h.id).single();if(v||!g)throw o({statusCode:403,statusMessage:"No se pudo obtener el perfil del usuario"});const C="psicologa"===g.rol,b="admin"===g.rol,w="coordinadora"===g.rol;if(!C&&!b&&!w)throw o({statusCode:403,statusMessage:`El rol "${g.rol}" no tiene permisos para validar citas. Roles permitidos: psicologa, coordinadora, admin.`});const M=await i(a),{id:j,fecha_cita:q,hora_inicio:y,hora_fin:x,estado:E,previous_estado:N}=M;let S=M.terapeuta_id;if(!S&&C&&(S=h.id),!q||!y||!x)throw o({statusCode:400,statusMessage:"Faltan campos obligatorios: fecha_cita, hora_inicio, hora_fin"});if(!S)throw o({statusCode:400,statusMessage:"Se requiere terapeuta_id para admin/coordinadora"});if(C&&S!==h.id)throw o({statusCode:403,statusMessage:"Como terapeuta, solo puedes validar tus propias citas"});if(E&&N){const a=n(N,E);if(!a.valid)return{valid:!1,error:a.error,errorCode:a.errorCode,details:a.details}}let U=m.from("citas").select("id, fecha_cita, hora_inicio, hora_fin, terapeuta_id, estado").eq("terapeuta_id",S).eq("fecha_cita",q).neq("estado","cancelada");j&&(U=U.neq("id",j));const{data:K,error:k}=await U;if(k)throw console.error("Error al obtener citas existentes:",k),o({statusCode:500,statusMessage:"Error al verificar conflictos"});const F=c({id:j,fecha_cita:q,hora_inicio:y,hora_fin:x,terapeuta_id:S,estado:E||"pendiente"},K||[]);return F.valid?{valid:!0,message:"Validación exitosa. No hay conflictos de horario."}:{valid:!1,error:l(F),errorCode:F.errorCode,details:F.details}}catch(a){if(console.error("Error in validate-conflict:",a),a.statusCode)throw a;throw o({statusCode:500,statusMessage:a.message||"Error al validar conflictos de citas"})}});export{p as default};
//# sourceMappingURL=validate-conflict.post.mjs.map
