import{d as a,a as t,c as e,u as o,b as s,s as i,e as r,r as n}from"../../../../nitro/nitro.mjs";import{m as d}from"../../../../_/index.mjs";import{v as c,a as l,f as u}from"../../../../_/appointment-validation.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/supabase-js";import"../../../../virtual/_commonjsHelpers.mjs";import"../../../../_/index2.mjs";const p=a(async a=>{const p=Date.now();try{const m=t(a,"id");if(!m)throw e({statusCode:400,statusMessage:"ID de cita no proporcionado"});const f=o(),h=f.supabaseUrl||f.public.supabaseUrl,_=f.supabaseKey||f.public.supabaseKey;if(!h||!_)throw e({statusCode:500,statusMessage:"Configuración de Supabase no disponible"});const g=await d.createServerClient(h,_,{cookies:{get:t=>r(a,t),set:(t,e,o)=>i(a,t,e,o),remove:(t,e)=>s(a,t,e)}}),{data:{user:w},error:C}=await g.auth.getUser();if(C||!w)throw e({statusCode:401,statusMessage:"No autenticado"});const{data:b,error:v}=await g.from("profiles").select("rol").eq("id",w.id).single();if(v||!b)throw e({statusCode:403,statusMessage:"No se pudo obtener el perfil del usuario"});const M="psicologa"===b.rol,E="admin"===b.rol,D="coordinadora"===b.rol;if(!M&&!E&&!D)throw e({statusCode:403,statusMessage:`El rol "${b.rol}" no tiene permisos para actualizar citas. Roles permitidos: psicologa, coordinadora, admin.`});const{data:j,error:z}=await g.from("citas").select("*").eq("id",m).single();if(z||!j)throw e({statusCode:404,statusMessage:"Cita no encontrada"});if(M&&j.terapeuta_id!==w.id)throw e({statusCode:403,statusMessage:"Como terapeuta, solo puedes actualizar tus propias citas"});const U=await n(a),{fecha_cita:q,hora_inicio:y,hora_fin:$,estado:x,modalidad:A,ubicacion:P,enlace_videollamada:T,observaciones:S,notas_terapeuta:I}=U;if(x&&x!==j.estado){const a=c(j.estado,x);if(!a.valid)throw e({statusCode:422,statusMessage:a.error,data:{errorCode:a.errorCode,details:a.details}})}if(q||y||$){const a=q||j.fecha_cita,t=y||j.hora_inicio,o=$||j.hora_fin,{data:s,error:i}=await g.from("citas").select("id, fecha_cita, hora_inicio, hora_fin, terapeuta_id, estado").eq("terapeuta_id",j.terapeuta_id).eq("fecha_cita",a).neq("id",m).neq("estado","cancelada");if(i)throw console.error("[UPDATE] Error al obtener citas existentes:",i),e({statusCode:500,statusMessage:"Error al verificar conflictos"});const r={id:m,fecha_cita:a,hora_inicio:t,hora_fin:o,terapeuta_id:j.terapeuta_id,estado:x||j.estado},n=l(r,s||[]);if(!n.valid)throw console.warn("[UPDATE] Validación fallida:",n),e({statusCode:422,statusMessage:u(n),data:{errorCode:n.errorCode,details:n.details}})}const k={updated_at:(new Date).toISOString()};q&&(k.fecha_cita=q),y&&(k.hora_inicio=5===y.length?`${y}:00`:y),$&&(k.hora_fin=5===$.length?`${$}:00`:$),x&&(k.estado=x),A&&(k.modalidad=A),void 0!==P&&(k.ubicacion=P),void 0!==T&&(k.enlace_videollamada=T),void 0!==S&&(k.observaciones=S),void 0!==I&&(k.notas_terapeuta=I);const{data:K,error:N}=await g.from("citas").update(k).eq("id",m).select("\n        *,\n        pacientes!inner (\n          id,\n          nombre_completo,\n          email,\n          telefono\n        ),\n        terapeutas!inner (\n          id,\n          nombre_completo\n        ),\n        bonos (\n          id,\n          sesiones_restantes,\n          sesiones_totales,\n          estado\n        )\n      ").single();if(N){if(console.error("[UPDATE] Error al actualizar cita:",N),N.message.includes("disponibilidad"))throw e({statusCode:422,statusMessage:"Conflicto de horario con otra cita"});throw e({statusCode:500,statusMessage:N.message||"Error al actualizar la cita"})}const O=Date.now()-p,H=Object.keys(k).filter(a=>"updated_at"!==a);return console.info(`[UPDATE] Cita actualizada: ${m} (${O}ms)`,{citaId:m,changes:H,duration:O}),{success:!0,message:"Cita actualizada exitosamente",data:K}}catch(a){const t=Date.now()-p;if(console.error(`[UPDATE] Error actualizando cita (${t}ms):`,a),a.statusCode)throw a;throw e({statusCode:500,statusMessage:a.message||"Error al actualizar la cita"})}});export{p as default};
//# sourceMappingURL=update.patch.mjs.map
