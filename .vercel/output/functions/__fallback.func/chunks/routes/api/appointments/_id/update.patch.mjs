import{d as a,a as e,c as o,u as t,b as s,s as i,e as r,r as n}from"../../../../nitro/nitro.mjs";import{m as d}from"../../../../_/index.mjs";import{v as c,a as l,f as u}from"../../../../_/appointment-validation.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"../../../../_/index2.mjs";import"../../../../virtual/_commonjsHelpers.mjs";import"iceberg-js";const p=a(async a=>{const p=Date.now();try{const m=e(a,"id");if(!m)throw o({statusCode:400,statusMessage:"ID de cita no proporcionado"});const f=t(),_=f.supabaseUrl||f.public.supabaseUrl,h=f.supabaseKey||f.public.supabaseKey;if(!_||!h)throw o({statusCode:500,statusMessage:"Configuración de Supabase no disponible"});const g=await d.createServerClient(_,h,{cookies:{get:e=>r(a,e),set:(e,o,t)=>i(a,e,o,t),remove:(e,o)=>s(a,e,o)}}),{data:{user:b},error:w}=await g.auth.getUser();if(w||!b)throw o({statusCode:401,statusMessage:"No autenticado"});const{data:C,error:v}=await g.from("profiles").select("rol").eq("id",b.id).single();if(v||!C)throw o({statusCode:403,statusMessage:"No se pudo obtener el perfil del usuario"});const E="psicologa"===C.rol,D="admin"===C.rol,M="coordinadora"===C.rol;if(!E&&!D&&!M)throw o({statusCode:403,statusMessage:`El rol "${C.rol}" no tiene permisos para actualizar citas. Roles permitidos: psicologa, coordinadora, admin.`});const{data:U,error:q}=await g.from("citas").select("*").eq("id",m).single();if(q||!U)throw o({statusCode:404,statusMessage:"Cita no encontrada"});if(E&&U.terapeuta_id!==b.id)throw o({statusCode:403,statusMessage:"Como terapeuta, solo puedes actualizar tus propias citas"});const z=await n(a),{fecha_cita:$,hora_inicio:j,hora_fin:A,estado:P,modalidad:S,ubicacion:T,enlace_videollamada:y,observaciones:x,notas_terapeuta:I}=z;if(P&&P!==U.estado){const a=c(U.estado,P);if(!a.valid)throw o({statusCode:422,statusMessage:a.error,data:{errorCode:a.errorCode,details:a.details}})}if($||j||A){const a=$||U.fecha_cita,e=j||U.hora_inicio,t=A||U.hora_fin,{data:s,error:i}=await g.from("citas").select("id, fecha_cita, hora_inicio, hora_fin, terapeuta_id, estado").eq("terapeuta_id",U.terapeuta_id).eq("fecha_cita",a).neq("id",m).neq("estado","cancelada");if(i)throw console.error("[UPDATE] Error al obtener citas existentes:",i),o({statusCode:500,statusMessage:"Error al verificar conflictos"});const r={id:m,fecha_cita:a,hora_inicio:e,hora_fin:t,terapeuta_id:U.terapeuta_id,estado:P||U.estado},n=l(r,s||[]);if(!n.valid)throw console.warn("[UPDATE] Validación fallida:",n),o({statusCode:422,statusMessage:u(n),data:{errorCode:n.errorCode,details:n.details}})}const O={updated_at:(new Date).toISOString()};$&&(O.fecha_cita=$),j&&(O.hora_inicio=5===j.length?`${j}:00`:j),A&&(O.hora_fin=5===A.length?`${A}:00`:A),P&&(O.estado=P),S&&(O.modalidad=S),void 0!==T&&(O.ubicacion=T),void 0!==y&&(O.enlace_videollamada=y),void 0!==x&&(O.observaciones=x),void 0!==I&&(O.notas_terapeuta=I);const k=U.estado,K=P||k;if(U.bono_id&&!U.sesion_descontada&&"pendiente"===k&&("confirmada"===K||"realizada"===K)){const{data:a,error:e}=await g.from("bonos").select("id, sesiones_restantes, estado").eq("id",U.bono_id).single();if(!e&&a&&a.sesiones_restantes>0){const e=a.sesiones_restantes-1,o=e<=0?"completado":"activo",{error:t}=await g.from("bonos").update({sesiones_restantes:e,estado:o,updated_at:(new Date).toISOString()}).eq("id",U.bono_id);t?console.error("[UPDATE] Error al descontar sesion del bono:",t):(O.sesion_descontada=!0,console.info(`[UPDATE] Sesion descontada del bono ${U.bono_id}: ${a.sesiones_restantes} -> ${e}`))}}const{data:N,error:H}=await g.from("citas").update(O).eq("id",m).select("\n        *,\n        pacientes!inner (\n          id,\n          nombre_completo,\n          email,\n          telefono\n        ),\n        terapeutas!inner (\n          id,\n          nombre_completo\n        ),\n        bonos (\n          id,\n          sesiones_restantes,\n          sesiones_totales,\n          estado\n        )\n      ").single();if(H){if(console.error("[UPDATE] Error al actualizar cita:",H),H.message.includes("disponibilidad"))throw o({statusCode:422,statusMessage:"Conflicto de horario con otra cita"});throw o({statusCode:500,statusMessage:H.message||"Error al actualizar la cita"})}const R=Date.now()-p,V=Object.keys(O).filter(a=>"updated_at"!==a);return console.info(`[UPDATE] Cita actualizada: ${m} (${R}ms)`,{citaId:m,changes:V,duration:R}),{success:!0,message:"Cita actualizada exitosamente",data:N}}catch(a){const e=Date.now()-p;if(console.error(`[UPDATE] Error actualizando cita (${e}ms):`,a),a.statusCode)throw a;throw o({statusCode:500,statusMessage:a.message||"Error al actualizar la cita"})}});export{p as default};
//# sourceMappingURL=update.patch.mjs.map
