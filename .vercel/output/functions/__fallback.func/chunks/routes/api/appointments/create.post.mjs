import{d as a,u as e,c as o,b as t,s,e as i,r}from"../../../nitro/nitro.mjs";import{m as n}from"../../../_/index.mjs";import{a as d,f as c}from"../../../_/appointment-validation.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/supabase-js";import"../../../virtual/_commonjsHelpers.mjs";import"../../../_/index2.mjs";const l=a(async a=>{const l=Date.now();try{const u=e(),p=u.supabaseUrl||u.public.supabaseUrl,m=u.supabaseKey||u.public.supabaseKey;if(!p||!m)throw o({statusCode:500,statusMessage:"Configuración de Supabase no disponible"});const f=await n.createServerClient(p,m,{cookies:{get:e=>i(a,e),set:(e,o,t)=>s(a,e,o,t),remove:(e,o)=>t(a,e,o)}}),{data:{user:_},error:h}=await f.auth.getUser();if(h||!_)throw o({statusCode:401,statusMessage:"No autenticado"});const{data:b,error:g}=await f.from("profiles").select("rol").eq("id",_.id).single();if(g||!b)throw o({statusCode:403,statusMessage:"No se pudo obtener el perfil del usuario"});const C="psicologa"===b.rol,w="admin"===b.rol,E="coordinadora"===b.rol;if(!C&&!w&&!E)throw o({statusCode:403,statusMessage:`El rol "${b.rol}" no tiene permisos para crear citas. Roles permitidos: psicologa, coordinadora, admin.`});const v=await r(a),{paciente_id:M,fecha_cita:j,hora_inicio:x,hora_fin:y,modalidad:R,estado:$,ubicacion:A,enlace_videollamada:T,observaciones:q,bono_id:D,descontar_de_bono:U}=v,K=C?_.id:v.terapeuta_id;if(!K)throw o({statusCode:400,statusMessage:"El terapeuta_id es obligatorio"});if(!(M&&j&&x&&y))throw o({statusCode:400,statusMessage:"Faltan campos obligatorios: paciente_id, fecha_cita, hora_inicio, hora_fin"});const{data:N,error:S}=await f.from("citas").select("id, fecha_cita, hora_inicio, hora_fin, terapeuta_id, estado").eq("terapeuta_id",K).eq("fecha_cita",j).neq("estado","cancelada");if(S)throw console.error("[CREATE] Error al obtener citas existentes:",S),o({statusCode:500,statusMessage:"Error al verificar conflictos"});const k=d({fecha_cita:j,hora_inicio:x,hora_fin:y,terapeuta_id:K,estado:$||"pendiente"},N||[]);if(!k.valid)throw console.warn("[CREATE] Validación fallida:",k),o({statusCode:422,statusMessage:c(k),data:{errorCode:k.errorCode,details:k.details}});const F={paciente_id:M,terapeuta_id:K,fecha_cita:j,hora_inicio:5===x.length?`${x}:00`:x,hora_fin:5===y.length?`${y}:00`:y,modalidad:R||"online",estado:$||"pendiente",ubicacion:A||null,enlace_videollamada:T||null,observaciones:q||null,bono_id:D||null,descontar_de_bono:U||!1,sesion_descontada:!1,recordatorio_enviado:!1},{data:H,error:I}=await f.from("citas").insert(F).select("\n        *,\n        pacientes!inner (\n          id,\n          nombre_completo,\n          email,\n          telefono\n        ),\n        terapeutas!inner (\n          id,\n          nombre_completo\n        ),\n        bonos (\n          id,\n          sesiones_restantes,\n          sesiones_totales,\n          estado\n        )\n      ").single();if(I){if(console.error("[CREATE] Error al insertar cita:",I),I.message.includes("disponibilidad"))throw o({statusCode:422,statusMessage:"El terapeuta ya tiene una cita en ese horario"});if("23503"===I.code)throw o({statusCode:400,statusMessage:"Paciente o terapeuta no encontrado"});throw o({statusCode:500,statusMessage:I.message||"Error al crear la cita"})}const P=Date.now()-l;return console.info(`[CREATE] Cita creada exitosamente: ${H.id} (${P}ms)`,{citaId:H.id,fecha:j,hora:x,terapeuta:K,duration:P}),{success:!0,message:"Cita creada exitosamente",data:H}}catch(a){const e=Date.now()-l;if(console.error(`[CREATE] Error creando cita (${e}ms):`,a),a.statusCode)throw a;throw o({statusCode:500,statusMessage:a.message||"Error al crear la cita"})}});export{l as default};
//# sourceMappingURL=create.post.mjs.map
