import{d as e,u as a,c as t,b as o,s,e as i,r}from"../../../nitro/nitro.mjs";import{m as n}from"../../../_/index.mjs";import{a as d,f as c}from"../../../_/appointment-validation.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/supabase-js";import"../../../virtual/_commonjsHelpers.mjs";import"../../../_/index2.mjs";const l=e(async e=>{var l;const u=Date.now();try{const p=a(),m=p.supabaseUrl||p.public.supabaseUrl,f=p.supabaseKey||p.public.supabaseKey;if(!m||!f)throw t({statusCode:500,statusMessage:"Configuración de Supabase no disponible"});const _=await n.createServerClient(m,f,{cookies:{get:a=>i(e,a),set:(a,t,o)=>s(e,a,t,o),remove:(a,t)=>o(e,a,t)}}),{data:{user:h},error:g}=await _.auth.getUser();if(g||!h)throw t({statusCode:401,statusMessage:"No autenticado"});const{data:b,error:w}=await _.from("profiles").select("rol").eq("id",h.id).single();if(w||!b)throw t({statusCode:403,statusMessage:"No se pudo obtener el perfil del usuario"});const C="psicologa"===b.rol,E="admin"===b.rol,v="coordinadora"===b.rol;if(!C&&!E&&!v)throw t({statusCode:403,statusMessage:`El rol "${b.rol}" no tiene permisos para crear citas. Roles permitidos: psicologa, coordinadora, admin.`});const M=await r(e),{paciente_id:q,fecha_cita:$,hora_inicio:T,hora_fin:j,modalidad:x,estado:y,ubicacion:D,enlace_videollamada:R,observaciones:S,bono_id:A,descontar_de_bono:F}=M,I=C?h.id:M.terapeuta_id;if(!I)throw t({statusCode:400,statusMessage:"El terapeuta_id es obligatorio"});if(!(q&&$&&T&&j))throw t({statusCode:400,statusMessage:"Faltan campos obligatorios: paciente_id, fecha_cita, hora_inicio, hora_fin"});const{data:U,error:Y}=await _.from("citas").select("id, fecha_cita, hora_inicio, hora_fin, terapeuta_id, estado").eq("terapeuta_id",I).eq("fecha_cita",$).neq("estado","cancelada");if(Y)throw console.error("[CREATE] Error al obtener citas existentes:",Y),t({statusCode:500,statusMessage:"Error al verificar conflictos"});const z=d({fecha_cita:$,hora_inicio:T,hora_fin:j,terapeuta_id:I,estado:y||"pendiente"},U||[]);if(!z.valid)throw console.warn("[CREATE] Validación fallida:",z),t({statusCode:422,statusMessage:c(z),data:{errorCode:z.errorCode,details:z.details}});if(A){const{data:e,error:a}=await _.from("bonos").select("id, tipo, sesiones_restantes, sesiones_totales, estado").eq("id",A).single();if(!a&&e){const a=(null==(l=e.tipo)?void 0:l.toLowerCase())||"";let o=0;if(a.includes("semanal")?o=4:a.includes("quincenal")&&(o=2),o>0){const e=new Date($+"T00:00:00"),s=new Date(e.getFullYear(),e.getMonth(),1),i=new Date(e.getFullYear(),e.getMonth()+1,0),r=s.toISOString().split("T")[0],n=i.toISOString().split("T")[0],{data:d,error:c}=await _.from("citas").select("id").eq("bono_id",A).gte("fecha_cita",r).lte("fecha_cita",n).in("estado",["confirmada","realizada","pendiente"]).neq("estado","cancelada"),l=(null==d?void 0:d.length)||0;if(l>=o){const e=a.includes("semanal")?"semanal":"quincenal";throw t({statusCode:422,statusMessage:`Limite de sesiones alcanzado: el bono ${e} permite maximo ${o} sesiones por mes. Ya hay ${l} sesiones programadas en este mes.`})}}}}const K={paciente_id:q,terapeuta_id:I,fecha_cita:$,hora_inicio:5===T.length?`${T}:00`:T,hora_fin:5===j.length?`${j}:00`:j,modalidad:x||"online",estado:y||"pendiente",ubicacion:D||null,enlace_videollamada:R||null,observaciones:S||null,bono_id:A||null,descontar_de_bono:F||!1,sesion_descontada:!1,recordatorio_enviado:!1},{data:L,error:N}=await _.from("citas").insert(K).select("\n        *,\n        pacientes!inner (\n          id,\n          nombre_completo,\n          email,\n          telefono\n        ),\n        terapeutas!inner (\n          id,\n          nombre_completo\n        ),\n        bonos (\n          id,\n          sesiones_restantes,\n          sesiones_totales,\n          estado\n        )\n      ").single();if(N){if(console.error("[CREATE] Error al insertar cita:",N),N.message.includes("disponibilidad"))throw t({statusCode:422,statusMessage:"El terapeuta ya tiene una cita en ese horario"});if("23503"===N.code)throw t({statusCode:400,statusMessage:"Paciente o terapeuta no encontrado"});throw t({statusCode:500,statusMessage:N.message||"Error al crear la cita"})}const O=Date.now()-u;return console.info(`[CREATE] Cita creada exitosamente: ${L.id} (${O}ms)`,{citaId:L.id,fecha:$,hora:T,terapeuta:I,duration:O}),{success:!0,message:"Cita creada exitosamente",data:L}}catch(e){const a=Date.now()-u;if(console.error(`[CREATE] Error creando cita (${a}ms):`,e),e.statusCode)throw e;throw t({statusCode:500,statusMessage:e.message||"Error al crear la cita"})}});export{l as default};
//# sourceMappingURL=create.post.mjs.map
